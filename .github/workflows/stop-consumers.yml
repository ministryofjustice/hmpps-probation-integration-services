name: Stop/start message consumers
# Disable or re-enable all message consumers, useful for when we need to temporarily switch off services while Delius is offline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment
        default: prod
        required: true
        type: choice
        options:
          - test
          - preprod
          - prod
      action:
        description: Stop or start?
        default: stop
        required: true
        type: choice
        options:
          - start
          - stop

jobs:
  stop:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3

      - uses: ./.github/actions/cloud-platform-auth
        with:
          api: ${{ secrets.KUBE_ENV_API }}
          cert: ${{ secrets.KUBE_CERT }}
          cluster: ${{ secrets.KUBE_CLUSTER }}
          namespace: ${{ secrets.KUBE_NAMESPACE }}
          token: ${{ secrets.KUBE_TOKEN }}

      - name: Patch deployments
        env:
          enabled: ${{ inputs.action == 'start' && 'true' || 'false' }}
        run: |
          deployments=$(kubectl get deployments -o jsonpath='{.items[*].metadata.name}')
          for deployment in $deployments; do
            kubectl patch deployment "$deployment" --patch "{\"spec\": {\"template\": {\"spec\": {\"containers\": [{
              \"name\": \"$deployment\",
              \"env\": [{ \"name\": \"MESSAGING_CONSUMER_ENABLED\", \"value\": \"$enabled\" }]
            }]}}}}"
          done
