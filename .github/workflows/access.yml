name: Database access
# Configure credentials and audit user in the Delius database

on:
  workflow_dispatch:
    inputs:
      projects:
        description: Project
        type: choice
        required: true
        options:
          - All
          - accredited-programmes-and-delius
          - accredited-programmes-and-oasys
          - appointment-reminders-and-delius
          - approved-premises-and-delius
          - approved-premises-and-oasys
          - arns-and-delius
          - assess-for-early-release-and-delius
          - assessment-summary-and-delius
          - breach-notice-and-delius
          - cas2-and-delius
          - cas3-and-delius
          - common-platform-and-delius
          - core-person-record-and-delius
          - court-case-and-delius
          - create-and-vary-a-licence-and-delius
          - custody-key-dates-and-delius
          - domain-events-and-delius
          - dps-and-delius
          - effective-proposal-framework-and-delius
          - esupervision-and-delius
          - external-api-and-delius
          - find-and-refer-and-delius
          - hdc-licences-and-delius
          - hmpps-auth-and-delius
          - hmpps-common-platform-event-receiver
          - ims-and-delius
          - jitbit-and-delius
          - justice-email-and-delius
          - make-recall-decisions-and-delius
          - manage-offences-and-delius
          - manage-pom-cases-and-delius
          - manage-supervision-and-delius
          - oasys-and-delius
          - offender-events-and-delius
          - opd-and-delius
          - pathfinder-and-delius
          - person-search-index-from-delius
          - pre-sentence-reports-to-delius
          - prison-case-notes-to-probation
          - prison-custody-status-to-delius
          - prison-education-and-delius
          - prison-identifier-and-delius
          - prisoner-profile-and-delius
          - probation-search-and-delius
          - refer-and-monitor-and-delius
          - resettlement-passport-and-delius
          - risk-assessment-scores-to-delius
          - sentence-plan-and-delius
          - sentence-plan-and-oasys
          - soc-and-delius
          - subject-access-requests-and-delius
          - suicide-risk-form-and-delius
          - tier-to-delius
          - unpaid-work-and-delius
          - workforce-allocations-to-delius
          # ^ add new projects here
          # GitHub Actions doesn't support dynamic choices, we must add each project here to enable manual deployments
          # See https://github.com/community/community/discussions/11795
  push:
    branches:
      - main
    paths:
      - 'projects/**/deploy/database/access.yml'

permissions:
  contents: read
  id-token: write
  issues: write

env:
  modernisation-platform-environments: '["test"]'

jobs:
  get-projects:
    uses: ./.github/workflows/get-projects.yml
    with:
      projects: ${{ inputs.projects || 'Changed' }}
      change-filters: |
        projects:
          - 'projects/**/deploy/database/access.yml'

  setup-access:
    runs-on: ubuntu-latest
    needs: get-projects
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        environment: ["test", "preprod", "prod"]
        project: ${{ fromJSON(needs.get-projects.outputs.projects) }}
    environment: ${{ matrix.environment }}
    steps:
      - uses: actions/checkout@v5

      - name: Check if DB access is required
        id: check_file
        uses: andstor/file-existence-action@076e0072799f4942c8bc574a82233e1e4d13e9d6 # v2
        with:
          files: projects/${{ matrix.project }}/deploy/database/access.yml

      - name: Disable audit user creation in preprod # user_ table records are automatically copied from prod to preprod within 1 hour of creation
        if: matrix.environment == 'preprod' && steps.check_file.outputs.files_exists == 'true'
        run: yq -i '.database.audit.create_user = false' projects/${{ matrix.project }}/deploy/database/access.yml

      - name: Authenticate to MOJ Cloud Platform
        if: steps.check_file.outputs.files_exists == 'true'
        uses: ./.github/actions/cloud-platform-auth
        with:
          api: ${{ secrets.KUBE_ENV_API }}
          cert: ${{ secrets.KUBE_CERT }}
          cluster: ${{ secrets.KUBE_CLUSTER }}
          namespace: ${{ secrets.KUBE_NAMESPACE }}
          token: ${{ secrets.KUBE_TOKEN }}

      - name: Create initial credentials
        if: steps.check_file.outputs.files_exists == 'true'
        run: |
          if ! kubectl get secret "$PROJECT-database" > /dev/null; then
            kubectl create secret generic "$PROJECT-database" \
              --from-literal "DB_USERNAME=${PROJECT//-/_}" \
              --from-literal "DB_PASSWORD=$(</dev/urandom tr -cd A-Za-z0-9 | head -c 16; echo)"
          fi
        env:
          PROJECT: ${{ matrix.project }}

      - name: Configure database access (Delius AWS)
        if: steps.check_file.outputs.files_exists == 'true' && !contains(fromJSON(env.modernisation-platform-environments), matrix.environment)
        uses: ./.github/actions/database-access-old
        with:
          project: ${{ matrix.project }}
          environment: ${{ matrix.environment }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Configure database access (MOJ Modernisation Platform)
        if: steps.check_file.outputs.files_exists == 'true' && contains(fromJSON(env.modernisation-platform-environments), matrix.environment)
        uses: ./.github/actions/database-access-new
        with:
          project: ${{ matrix.project }}
          environment: ${{ matrix.environment }}
          aws-account-id: ${{ secrets.MODERNISATION_PLATFORM_AWS_ACCOUNT_ID }}

  create-issue:
    runs-on: ubuntu-latest
    needs: get-projects
    strategy:
      matrix:
        project: ${{ fromJSON(needs.get-projects.outputs.projects) }}
    steps:
      - uses: actions/checkout@v5
      - name: Create issue for manual approval step
        run: |
          gh issue create \
            --title 'Complete database access setup for ${{ matrix.project }}' \
            --body '
          The ${{ matrix.project }} [database/access.yml](https://github.com/ministryofjustice/hmpps-probation-integration-services/blob/main/projects/${{ matrix.project }}/deploy/database/access.yml) file was recently changed. For these changes to take effect in production, the [Database Access](https://github.com/ministryofjustice/hmpps-probation-integration-services/actions/workflows/access.yml) workflow must be manually approved.
          - [ ] Approve workflow: https://github.com/ministryofjustice/hmpps-probation-integration-services/actions/runs/${{ github.run_id }}' \
            --label bootstrap
        env:
          GITHUB_TOKEN: ${{ github.token }}
