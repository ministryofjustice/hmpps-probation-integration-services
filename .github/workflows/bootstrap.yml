name: Bootstrap
# Perform initial project setup to enable development of a new service

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number (e.g. PI-123)
        required: true
        type: string
      project_name:
        description: Project name
        required: true
        type: string
      project_template:
        description: Project template
        required: true
        type: choice
        default: message-listener-with-api-client
        options:
          - api-client-and-server
          - api-server
          - message-listener
          - message-listener-with-api-client
          - message-listener-with-api-client-and-server
          - 'No template - I want to create the project from scratch'
      create_database_credentials:
        description: Will the service access the Delius database?
        default: true
        required: true
        type: boolean
      create_sentry_project:
        description: Will the service use Sentry for capturing exceptions?
        default: true
        required: true
        type: boolean
      create_oauth_client:
        description: Will the service consume another HTTP API that requires HMPPS Auth client credentials?
        default: true
        required: true
        type: boolean
      create_ingress:
        description: Will the service provide a HTTP API?
        default: false
        required: true
        type: boolean

jobs:
  auth-setup:
    runs-on: ubuntu-latest
    if: ${{ inputs.create_oauth_client }}
    steps:
      - uses: actions/checkout@v3
      - name: Create issue for manual steps
        run: |
          gh issue create \
            --title "${{ inputs.issue_number }} Request HMPPS Auth client for ${{ inputs.project_name }}" \
            --body '
          - [ ] Clone Jira ticket: [HAAR-928](https://dsdmoj.atlassian.net/browse/HAAR-928)
          - [ ] Raise in Slack: [#hmpps-auth-audit-registers](https://mojdt.slack.com/archives/C02S71KUBED)' \
            --label bootstrap
        env:
          GITHUB_TOKEN: ${{ github.token }}

  db-secrets-setup:
    runs-on: ubuntu-latest
    if: ${{ inputs.create_database_credentials }}
    steps:
      - uses: actions/checkout@v3

      # convert project name to environment variable (e.g. 'hello-world' -> 'HELLO_WORLD')
      - id: project_name
        run: |
          echo "with_underscores=$(echo '${{ inputs.project_name }}' | sed 's/-/_/g')" >> $GITHUB_OUTPUT
          echo "with_underscores_uppercase=$(echo '${{ inputs.project_name }}' | sed 's/-/_/g' | tr '[:lower:]' '[:upper:]')" >> $GITHUB_OUTPUT

      - name: Set database username
        run: gh secret set "$NAME" --body "$VALUE" --app actions
        env:
          NAME: ${{ steps.project_name.outputs.with_underscores_uppercase }}_DB_USERNAME
          VALUE: ${{ steps.project_name.outputs.with_underscores }}
          GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}

      - uses: ./.github/actions/random-secret
        with:
          environment: test
          name: ${{ steps.project_name.outputs.with_underscores_uppercase }}_DB_PASSWORD
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - uses: ./.github/actions/random-secret
        with:
          environment: preprod
          name: ${{ steps.project_name.outputs.with_underscores_uppercase }}_DB_PASSWORD
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - uses: ./.github/actions/random-secret
        with:
          environment: prod
          name: ${{ steps.project_name.outputs.with_underscores_uppercase }}_DB_PASSWORD
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

  project-setup:
    if: ${{ inputs.project_template != 'No template - I want to create the project from scratch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Render project template
        uses: ./.github/actions/render-project-template
        with:
          project_name: ${{ inputs.project_name }}
          project_template: ${{ inputs.project_template }}

      - name: Create pull request
        id: pr
        uses: peter-evans/create-pull-request@v4
        with:
          add-paths: |
            settings.gradle.kts
            .idea/runConfigurations/*
            .github/workflows/deploy.yml
            .github/workflows/end-to-end-tests.yml
            projects/${{ inputs.project_name }}/*
          commit-message: ${{ inputs.issue_number }} Create initial project for ${{ inputs.project_name }}
          title: ${{ inputs.issue_number }} Create initial project for ${{ inputs.project_name }}
          body: Automated changes by [hmpps-probation-integration-services](https://github.com/ministryofjustice/hmpps-probation-integration-services/actions/workflows/bootstrap.yml)
          base: main
          branch: bootstrap/${{ inputs.project_name }}
          author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Create issue for manual steps
        run: |
          gh issue create \
            --title "${{ inputs.issue_number }} Complete project setup for ${{ inputs.project_name }}" \
            --body "- [ ] Merge pull request: ${{ steps.pr.outputs.pull-request-url }}" \
            --label bootstrap
        env:
          GITHUB_TOKEN: ${{ github.token }}

  delius-aws-setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/checkout@v3
        with:
          path: hmpps-delius-core-terraform
          repository: ministryofjustice/hmpps-delius-core-terraform

      - name: Render Terraform service template
        if: ${{ ! inputs.create_ingress }}
        run: sed 's/$SERVICE_NAME/${{ inputs.project_name }}/g' templates/service.tf > 'hmpps-delius-core-terraform/application/probation-integration-services/${{ inputs.project_name }}.tf'

      - name: Render Terraform service with load-balancer template
        if: ${{ inputs.create_ingress }}
        run: sed 's/$SERVICE_NAME/${{ inputs.project_name }}/g' templates/service-with-load-balancer.tf > 'hmpps-delius-core-terraform/application/probation-integration-services/${{ inputs.project_name }}.tf'

      - name: Create pull request
        id: pr
        uses: peter-evans/create-pull-request@v4
        with:
          path: hmpps-delius-core-terraform
          commit-message: ${{ inputs.issue_number }} Create ECS service for ${{ inputs.project_name }}
          title: ${{ inputs.issue_number }} Create ECS service for ${{ inputs.project_name }}
          body: Automated changes by [hmpps-probation-integration-services](https://github.com/ministryofjustice/hmpps-probation-integration-services/actions/workflows/bootstrap.yml)
          branch: probation-integration/create-${{ inputs.project_name }}
          token: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Create issue for manual steps
        run: |
          gh issue create \
            --title "${{ inputs.issue_number }} Complete infrastructure setup for ${{ inputs.project_name }}" \
            --body "- [ ] Merge pull request: ${{ steps.pr.outputs.pull-request-url }}" \
            --label bootstrap
        env:
          GITHUB_TOKEN: ${{ github.token }}

  sentry-setup:
    runs-on: ubuntu-latest
    if: ${{ inputs.create_sentry_project }}
    steps:
      - uses: actions/checkout@v3

      # convert project name to environment variable (e.g. 'hello-world' -> 'HELLO_WORLD')
      - id: project_name
        run: echo "with_underscores=$(echo '${{ inputs.project_name }}' | tr '[:lower:]' '[:upper:]' | sed 's/-/_/g')" >> $GITHUB_OUTPUT

      - name: Create project
        id: project
        run: |
          response=$(curl https://sentry.io/api/0/teams/ministryofjustice/probation-integration/projects/ --fail \
            -H 'Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -d '{"name":"${{ inputs.project_name }}"}')
          echo "slug=$(echo $response | jq -r '.slug')" >> $GITHUB_OUTPUT

      - name: Set platform to Kotlin
        run: |
          curl -X PUT https://sentry.io/api/0/projects/ministryofjustice/${{ steps.project.outputs.slug }}/ --fail \
            -H 'Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -d '{"platform":"kotlin"}'

      - name: Get client key (DSN)
        id: client_key
        run: |
          response=$(curl https://sentry.io/api/0/projects/ministryofjustice/${{ steps.project.outputs.slug }}/keys/ --fail \
                  -H 'Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}')
          id=$(echo $response | jq -r '.[0].id')
          dsn=$(echo $response | jq -r '.[0].dsn.public')
          echo "::add-mask::$dsn"
          echo "dsn=$dsn" >> $GITHUB_OUTPUT
          echo "id=$id" >> $GITHUB_OUTPUT

      - name: Store DSN as GitHub secret
        run: gh secret set "$NAME" --body "$VALUE" --app actions
        env:
          NAME: ${{ steps.project_name.outputs.with_underscores }}_SENTRY_DSN
          VALUE: ${{ steps.client_key.outputs.dsn }}
          GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}

      - name: Create issue for manual steps
        # see https://github.com/getsentry/sentry/issues/18904
        # see https://github.com/getsentry/sentry/issues/36968
        run: |
          gh issue create \
            --title "${{ inputs.issue_number }} Complete Sentry setup for ${{ inputs.project_name }}" \
            --body '
          - [ ] Configure rate limiting to 10/minute: https://sentry.io/settings/ministryofjustice/projects/${{ steps.project.outputs.slug }}/keys/${{ steps.client_key.outputs.id }}
          - [ ] Create a Slack alert: https://sentry.io/organizations/ministryofjustice/alerts/new/issue/?createFromDuplicate=true&duplicateRuleId=11530702&project=prison-case-notes-to-probation
          
          > :memo: Note: the above link will duplicate an alert from `prison-case-notes-to-probation`.  Make sure to update the Project to `${{ inputs.project_name }}` in the drop-down.' \
            --label bootstrap
        env:
          GITHUB_TOKEN: ${{ github.token }}
