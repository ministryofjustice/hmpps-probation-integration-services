name: Build

on:
  push:
    branches-ignore:
      - main
  workflow_call:
    inputs:
      push:
        type: boolean
        default: false
    outputs:
      version:
        value: ${{ jobs.build-gradle.outputs.version }}
      changes:
        value: ${{ jobs.analyse.outputs.changes }}
  workflow_dispatch:
    inputs:
      push:
        description: Push images
        type: boolean
        default: false

env:
  push: ${{ !(github.event_name == 'push' && github.ref_name != 'main') && inputs.push }}

jobs:
  build-gradle:
    name: Gradle build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - approved-premises-and-oasys
          - approved-premises-and-delius
          - pre-sentence-reports-to-delius
          - prison-case-notes-to-probation
          - prison-custody-status-to-delius
          - risk-assessment-scores-to-delius
          - tier-to-delius
          - workforce-allocations-to-delius
          - offender-events-and-delius
          - custody-key-dates-and-delius
          - make-recall-decisions-and-delius
          - unpaid-work-and-delius
          - manage-pom-cases-and-delius
          - refer-and-monitor-and-delius
          - create-and-vary-a-licence-and-delius
          - court-case-and-delius
          - effective-proposal-framework-and-delius
          - sentence-plan-and-delius
          - pathfinder-and-delius
          - soc-and-delius
          - sentence-plan-and-oasys
          # ^ add new projects here
          # GitHub Actions doesn't support dynamic choices, we must add each project here to enable manual deployments
          # See https://github.com/community/community/discussions/11795
    outputs:
      version: ${{ steps.version.outputs.version }}
      changes: ${{ steps.check-changes.outputs.changes }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: ${{ !env.push }}

      - name: Set version
        id: version
        run: |
          version=$(date '+%Y-%m-%d').${{ github.run_number }}.$(echo ${{ github.sha }} | cut -c1-7)
          echo "ORG_GRADLE_PROJECT_version=$version" >> $GITHUB_ENV
          echo "version=$version" | tee -a $GITHUB_OUTPUT

      - name: Build and test
        run: ./gradlew ${{ matrix.project }}:check
        env:
          SPRING_PROFILES_ACTIVE: oracle

      - name: Push images
        if: env.push == 'true'
        run: ./gradlew ${{ matrix.project }}:jib
        env:
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_PASSWORD: ${{ github.token }}

      - name: Check changes
        id: check-changes
        run: echo "changes=$((ls changed || true) | jq --raw-input . | jq --slurp --compact-output .)" | tee -a $GITHUB_OUTPUT

      - name: Output changes
        uses: cloudposse/github-action-matrix-outputs-write@47bfd07b833c59443a15353094aa2802a7613501 # v0.4.1
        with:
          matrix-step-name: output-changes
          matrix-key: ${{ matrix.project }}
          outputs: ${{ steps.check-changes.outputs.changes }}

      - uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            **/build/jacoco
            **/build/reports/jacoco/**/*.xml
            **/build/test-results

  build-docker:
    name: Docker build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project:
          - person-search-index-from-delius
    steps:
      - uses: actions/checkout@v3

      - name: Set version
        id: version
        run: |
          version=$(date '+%Y-%m-%d').${{ github.run_number }}.$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=$version" | tee -a $GITHUB_OUTPUT

      - name: Build Docker images
        uses: ./.github/actions/docker-build
        id: build
        with:
          project: ${{ matrix.project }}
          push: ${{ env.push }}
          version: ${{ steps.version.outputs.version }}

      - name: Output changes
        uses: cloudposse/github-action-matrix-outputs-write@47bfd07b833c59443a15353094aa2802a7613501 # v0.4.1
        with:
          matrix-step-name: output-changes
          matrix-key: ${{ matrix.project }}
          outputs: ${{ steps.build.outputs.changes }}

  analyse:
    name: Analyse
    runs-on: ubuntu-latest
    needs:
      - build-gradle
      - build-docker
    outputs:
      changes: ${{ steps.check-changes.outputs.changes }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v3
        with:
          name: test-results

      - name: Publish test reports
        uses: mikepenz/action-junit-report@4fa23552acda20a6a1d44f16224a90efbeb6c5f1 # v3.7.5
        if: always() && github.actor != 'dependabot[bot]'
        with:
          check_name: |-
            Unit test results
            Integration test results
          report_paths: |-
            **/build/test-results/test/TEST-*.xml
            **/build/test-results/integrationTest/TEST-*.xml

      - uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Sonar analysis
        if: github.actor != 'dependabot[bot]'
        continue-on-error: true # don't fail the build when sonarcloud.io is down
        uses: gradle/gradle-build-action@v2
        with:
          arguments: sonar
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - uses: cloudposse/github-action-matrix-outputs-read@ea1c28d66c34b8400391ed74d510f66abc392d5e # v0.1.1
        id: read-changes
        with:
          matrix-step-name: output-changes

      - name: Check changes
        id: check-changes
        run: echo "changes=$(echo $changes | jq '. | values[] | [.]' | jq --slurp --compact-output 'add')" | tee -a $GITHUB_OUTPUT
        env:
          changes: ${{ steps.read-changes.outputs.result }}