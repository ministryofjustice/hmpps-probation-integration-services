name: Deploy

on:
  workflow_dispatch:
    inputs:
      projects:
        description: Project
        type: choice
        required: true
        options:
          - '["approved-premises-and-oasys"]'
          - '["approved-premises-with-delius"]'
          - '["person-search-index-from-delius"]'
          - '["pre-sentence-reports-to-delius"]'
          - '["prison-case-notes-to-probation"]'
          - '["prison-custody-status-to-delius"]'
          - '["risk-assessment-scores-to-delius"]'
          - '["tier-to-delius"]'
          - '["workforce-allocations-to-delius"]'
          # ^ add new projects here
          # GitHub Actions doesn't support dynamic choices, we must add each project here to enable manual deployments
          # See https://github.com/community/community/discussions/11795
      environment:
        description: Environment
        type: choice
        required: true
        options:
          - dev
          - preprod
          - prod
      version:
        description: Image version
        type: string
        required: true
        default: latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(inputs.projects) }}
    environment:
      name: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3
          
      - name: Authenticate to the cluster
        env:
          KUBE_CLUSTER: ${{ secrets.KUBE_CLUSTER_DEV }}
          VERSION: ${{ inputs.version }}
        run: |
          echo "${{ secrets.KUBE_CERT_DEV }}" > ca.crt
          kubectl config set-cluster ${{ secrets.KUBE_CLUSTER_DEV }} --certificate-authority=./ca.crt --server=https://DF366E49809688A3B16EEC29707D8C09.gr7.eu-west-2.eks.amazonaws.com
          kubectl config set-credentials cd-serviceaccount --token=${{ secrets.KUBE_TOKEN_DEV }}
          kubectl config set-context ${{ secrets.KUBE_CLUSTER_DEV }} --cluster=${{ secrets.KUBE_CLUSTER_DEV }} --user=cd-serviceaccount --namespace=${{ secrets.KUBE_NAMESPACE_DEV }}
          kubectl config use-context ${{ secrets.KUBE_CLUSTER_DEV }}
          kubectl get pods
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install helm
          sed -i "s/^version:.*$/version: ${VERSION}/" projects/${{ matrix.project }}/helm-deploy/${{ matrix.project }}/Chart.yaml
          helm dependency update projects/${{ matrix.project }}/helm-deploy/${{ matrix.project }}
          helm package projects/${{ matrix.project }}/helm-deploy/${{ matrix.project }}
          pwd
          helm upgrade --install ${{ matrix.project }} ${{ matrix.project }}-$VERSION.tgz --namespace=${{ secrets.KUBE_NAMESPACE_DEV }} --values projects/${{ matrix.project }}/helm-deploy/values-dev.yaml