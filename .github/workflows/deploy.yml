name: Deploy

on:
  workflow_call:
    inputs:
      projects:
        description: A JSON array of projects to deploy
        type: string
        required: true
      environment:
        description: The name of the environment to deploy to
        type: string
        required: true
      version:
        description: The image version to deploy
        type: string
        required: true

  workflow_dispatch:
    inputs:
      projects:
        description: Project
        type: choice
        required: true
        options:
          - '["approved-premises-and-oasys"]'
          - '["approved-premises-with-delius"]'
          - '["person-search-index-from-delius"]'
          - '["pre-sentence-reports-to-delius"]'
          - '["prison-case-notes-to-probation"]'
          - '["prison-custody-status-to-delius"]'
          - '["risk-assessment-scores-to-delius"]'
          - '["tier-to-delius"]'
          - '["workforce-allocations-to-delius"]'
          # ^ add new projects here
          # GitHub Actions doesn't support dynamic choices, we must add each project here to enable manual deployments
          # See https://github.com/community/community/discussions/11795
      environment:
        description: Environment
        type: choice
        required: true
        options:
          - test
          - preprod
          - prod
      version:
        description: Image version
        type: string
        required: true
        default: latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(inputs.projects) }}
    environment:
      name: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3

      - name: Map GitHub environment to values file
        id: values
        shell: bash
        run: |
          if [ '${{ inputs.environment }}' == 'test' ];    then echo '::set-output name=filename::values-dev.yml'; fi
          if [ '${{ inputs.environment }}' == 'preprod' ]; then echo '::set-output name=filename::values-preprod.yml'; fi
          if [ '${{ inputs.environment }}' == 'prod' ];    then echo '::set-output name=filename::values-prod.yml'; fi

      - name: Get enabled flag from values file
        id: enabled
        shell: bash
        run: echo "enabled=$(cat ${{ steps.values.outputs.filename }} | yq '.enabled' | sed 's/^null$/true/')" >> $GITHUB_OUTPUT
        working-directory: projects/${{ matrix.project }}/deploy

      - name: Check Chart.yaml file exists
        id: check_files
        uses: andstor/file-existence-action@v2
        with:
          files: projects/${{ matrix.project }}/deploy/Chart.yaml

      - name: Deploy to Cloud Platform
        if: ${{ steps.check_files.outputs.files_exists == 'true' && steps.enabled.outputs.enabled == 'true' }}
        uses: ./.github/actions/cloud-platform-deploy
        with:
          project: ${{ matrix.project }}
          environment: ${{ inputs.environment }}
          version: ${{ inputs.version }}
          values-file: ${{ steps.values.outputs.filename }}
          api: ${{ secrets.KUBE_ENV_API }}
          cert: ${{ secrets.KUBE_CERT }}
          cluster: ${{ secrets.KUBE_CLUSTER }}
          namespace: ${{ secrets.KUBE_NAMESPACE }}
          token: ${{ secrets.KUBE_TOKEN }}
          json-secrets: ${{ toJson(secrets) }}

      - name: Deploy to Delius AWS
        if: ${{ steps.check_files.outputs.files_exists == 'false' && steps.enabled.outputs.enabled == 'true' }}
        uses: ./.github/actions/delius-deploy
        with:
          project: ${{ matrix.project }}
          environment: ${{ inputs.environment }}
          version: ${{ inputs.version }}
          values-file: ${{ steps.values.outputs.filename }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-role-arn: ${{ secrets.AWS_ROLE_ARN }}
          json-secrets: ${{ toJson(secrets) }}

      - name: Create Sentry release
        if: steps.enabled.outputs.enabled == 'true'
        uses: getsentry/action-release@v1
        env:
          SENTRY_ORG: ministryofjustice
          SENTRY_PROJECT: ${{ matrix.project }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        with:
          environment: ${{ inputs.environment }}
