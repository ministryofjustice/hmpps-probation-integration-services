name: Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch: # Can be triggered manually from a branch

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.build.outputs.version }}
      changed-projects: ${{ steps.build.outputs.changed-projects }}
    steps:
      - uses: actions/checkout@v3
      - name: Build and test
        id: build
        uses: ./.github/actions/build-and-test
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Push images
        uses: gradle/gradle-build-action@v2
        env:
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        with:
          arguments: jib dockerTagsPush

  deploy-to-test:
    name: Deploy to test
    uses: ./.github/workflows/deploy.yml
    needs: build
    with:
      environment: test
      version: ${{ needs.build.outputs.version }}
      projects: ${{ needs.build.outputs.changed-projects }}
    secrets: inherit

  deploy-to-preprod:
    name: Deploy to preprod
    uses: ./.github/workflows/deploy.yml
    needs: build
    with:
      environment: preprod
      version: ${{ needs.build.outputs.version }}
      projects: ${{ needs.build.outputs.changed-projects }}
    secrets: inherit

  end-to-end-tests:
    name: Run end-to-end tests
    runs-on: moj-cloud-platform
    timeout-minutes: 60
    needs:
      - build
      - deploy-to-test
      - deploy-to-preprod
    steps:
      - uses: actions/checkout@v3
        with:
          repository: ministryofjustice/hmpps-probation-integration-e2e-tests
      - name: Check tests are present
        run: |
          for project in $(echo '${{ needs.build.outputs.changed-projects }}' | jq -r '.[]'); do
            if [ ! -d "tests/$project" ]; then echo "No tests found for $project" >&2; exit 1; fi
          done
      - uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install
      - name: Run Playwright tests
        run: npx playwright test --reporter=html,junit,line $(echo '${{ needs.build.outputs.changed-projects }}' | jq -r 'join(" ")')
        env:
          ENV: test
          DELIUS_URL: https://ndelius.test.probation.service.justice.gov.uk
          WORKFORCE_URL: https://workforce-management-dev.hmpps.service.justice.gov.uk
          DPS_URL: https://digital-dev.prison.service.justice.gov.uk
          AUTH_URL: https://sign-in-dev.hmpps.service.justice.gov.uk
          PRISON_API: https://api-dev.prison.service.justice.gov.uk/
          REFERANDMONITOR_URL: https://hmpps-interventions-ui-dev.apps.live-1.cloud-platform.service.justice.gov.uk
          DELIUS_USERNAME: ${{ secrets.E2E_DELIUS_USERNAME }}
          DELIUS_PASSWORD: ${{ secrets.E2E_DELIUS_PASSWORD }}
          DPS_USERNAME: ${{ secrets.E2E_DPS_USERNAME }}
          DPS_PASSWORD: ${{ secrets.E2E_DPS_PASSWORD }}
          CRED_USERNAME: ${{ secrets.E2E_CLIENT_ID }}
          CRED_PASSWORD: ${{ secrets.E2E_CLIENT_SECRET }}
          REFERANDMONITOR_SUPPLIER_USERNAME: ${{ secrets.E2E_REFERANDMONITOR_SUPPLIER_USERNAME }}
          REFERANDMONITOR_SUPPLIER_PASSWORD: ${{ secrets.E2E_REFERANDMONITOR_SUPPLIER_PASSWORD }}
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: junit.xml
      - name: Publish JUnit report
        uses: mikepenz/action-junit-report@v3
        if: always()
        with:
          check_name: End-to-end test results
          report_paths: junit.xml
      - name: Publish HTML report
        uses: JamesIves/github-pages-deploy-action@v4
        if: always()
        with:
          folder: playwright-report
          target-folder: playwright-report/test/${{ github.ref_name }}/${{ github.sha }}/${{ github.run_attempt }}
      - name: Add HTML report URL to the job summary
        if: always()
        run: echo '[ðŸŽ­ Playwright HTML Report](https://ministryofjustice.github.io/hmpps-probation-integration-services/playwright-report/test/${{ github.ref_name }}/${{ github.sha }}/${{ github.run_attempt }})' >> $GITHUB_STEP_SUMMARY

  deploy-to-prod:
    name: Deploy to production
    uses: ./.github/workflows/deploy.yml
    if: github.ref == 'refs/heads/main'
    needs:
      - build
      - end-to-end-tests
    with:
      environment: prod
      version: ${{ needs.build.outputs.version }}
      projects: ${{ needs.build.outputs.changed-projects }}
    secrets: inherit
