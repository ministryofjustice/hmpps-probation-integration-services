name: Set up new project

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: Project name
        required: false
        type: string

jobs:
  terraform-setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/checkout@v3
        with:
          path: hmpps-delius-core-terraform
          repository: https://github.com/ministryofjustice/hmpps-delius-core-terraform

      - name: Render Terraform template
        run: sed 's/$SERVICE_NAME/${{ inputs.project_name }}/' templates/service.tf > 'hmpps-delius-core-terraform/application/probation-integration-services/${{ inputs.project_name }}.tf'

      - name: Create pull request
        id: pr
        uses: peter-evans/create-pull-request@v4
        with:
          path: hmpps-delius-core-terraform
          commit-message: Create ECS service for ${{ inputs.project_name }}
          title: Create ECS service for ${{ inputs.project_name }}
          body: Automated changes by [hmpps-probation-integration-services](https://github.com/ministryofjustice/hmpps-probation-integration-services/actions/workflows/new-project.yml)
          branch: probation-integration/create-${{ inputs.project_name }}

      - name: Output pull request url
        run: 'echo Pull request created: ${{ steps.pr.outputs.pull-request-url }}'

  sentry-setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
#      - create sentry project + assign to probation-integration team  --- needs project:write

      - run: echo To set up rate limiting, go to https://sentry.io/settings/ministryofjustice/projects/prison-case-notes-to-probation/keys/07cf2d8dee244661ab8ac7fce7d1c9bc/
        # TODO replace project name and key id in the above url

      - run: echo To set up an alert, go to https://sentry.io/organizations/ministryofjustice/alerts/new/issue/?createFromDuplicate=true&duplicateRuleId=11530702&project=prison-case-notes-to-probation&referrer=alert_stream