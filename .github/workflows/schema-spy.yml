name: SchemaSpy report

on:
  schedule:
    - cron: "0 7 * * WED" # Every Wednesday at 07:00 UTC

  workflow_dispatch:

jobs:
  schema-spy:
    name: Schema Spy report generation
    runs-on: moj-cloud-platform
    timeout-minutes: 240
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 8
      - name: Run SchemaSpy
        env:
          DB: ${{ secrets.SCHEMA_SPY_DB }}
          HOST: ${{ secrets.SCHEMA_SPY_HOST }}
          PORT: ${{ secrets.SCHEMA_SPY_PORT }}
          SCHEMA: ${{ secrets.SCHEMA_SPY_SCHEMA }}
          USERNAME: ${{ secrets.SCHEMA_SPY_USERNAME }}
          PASSWORD: ${{ secrets.SCHEMA_SPY_PASSWORD }}
        run: |
          java -Xss2048k -Xmx2G -Xms2G -jar ./tools/schema-spy/schemaspy-6.1.0.jar -t orathin-service \
                    -dp ./tools/schema-spy/ojdbc8.jar \
                    -db "${DB}" \
                    -host "${HOST}" \
                    -port "${PORT}" \
                    -s "${SCHEMA}" \
                    -u "${USERNAME}" \
                    -p "${PASSWORD}" \
                    -cat "${SCHEMA}" \
                    -I "^(^Z.*$|^.*[0-9]$|^SPG.*$|^R_SPG.*$|^PRF_.*$|^PERF_.*$|^MIS_.*$|^.*_MV$|^.*\\$.*$|^.*TRAINING.*$|^PDT_THREAD$|^CHANGE_CAPTURE$)$" \
                    -vizjs \
                    -o ./schema-spy-report

      - name: Publish HTML report
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: schema-spy-report
          target-folder: schema-spy-report

      - name: Add HTML report URL to the job summary
        run: echo '[Schema Spy HTML Report](https://ministryofjustice.github.io/hmpps-probation-integration-services/schema-spy-report)' >> $GITHUB_STEP_SUMMARY
