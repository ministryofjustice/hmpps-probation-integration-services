name: Cloud Platform Auth
description: Authenticate with MOJ Cloud Platform

inputs:
  api:
    description: The KUBE_ENV_API
    required: true
  cert:
    description: The KUBE_CERT
    required: true
  cluster:
    description: The KUBE_CLUSTER
    required: true
  namespace:
    description: The KUBE_NAMESPACE
    required: true
  token:
    description: The KUBE_TOKEN
    required: true

runs:
  using: composite
  steps:
    - name: Authenticate
      shell: bash
      run: |
        mkdir -p /home/runner/.kube/moj-cloud-platform
        echo "${cert}" > /home/runner/.kube/moj-cloud-platform/ca.crt
        kubectl config set-cluster ${cluster} --certificate-authority=/home/runner/.kube/moj-cloud-platform/ca.crt --server=${api}
        kubectl config set-credentials cd-serviceaccount --token=${token}
        kubectl config set-context ${cluster} --cluster=${cluster} --user=cd-serviceaccount --namespace=${namespace}
        kubectl config use-context ${cluster}
      env:
        cert: ${{ inputs.cert }}
        cluster: ${{ inputs.cluster }}
        api: ${{ inputs.api }}
        namespace: ${{ inputs.namespace }}
        token: ${{ inputs.token }}