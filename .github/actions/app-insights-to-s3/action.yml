name: Report to S3
description: Publish results of an Azure Monitor Application Insights query to S3

inputs:
  query:
    description: Kusto query to run against Application Insights
    required: true
  role-arn:
    description: AWS Role ARN
    required: true
  bucket-name:
    description: S3 Bucket Name
    required: true
  bucket-prefix:
    description: S3 Bucket Object Prefix
    required: true
  app-insights-key:
    description: Application Insights API key
    required: true
  app-insights-guid:
    description: Application Insights GUID
    required: true

runs:
  using: "composite"
  steps:
    - name: Authenticate with AWS
      uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7
      with:
        aws-region: eu-west-2
        role-to-assume: ${{ inputs.role-arn }}
        role-session-name: probation-integration-s3-export-${{ github.run_number }}
        role-duration-seconds: 1200

    - name: Export Application Insights query result to S3
      id: search
      shell: bash # language=bash
      run: |
        curl -fsSL -H "x-api-key: $key" --data-urlencode "query=$query" --get "$url" \
          | jq -rc '.tables[0] | (.columns | map(.name)) as $cols | .rows[] | with_entries(.key |= $cols[.])' \
          | aws s3 cp - "s3://$bucket_name/$bucket_prefix" --acl bucket-owner-full-control --sse AES256
      env:
        url: https://api.applicationinsights.io/v1/apps/${{ inputs.app-insights-guid }}/query
        key: ${{ inputs.app-insights-key }}
        query: ${{ inputs.query }}
        bucket_name: ${{ inputs.bucket-name }}
        bucket_prefix: ${{ inputs.bucket-prefix }}
