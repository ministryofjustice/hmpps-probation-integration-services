name: Setup Gradle
description: Setup Java and Gradle actions

inputs:
  cache-role:
    description: Role to assume to access S3 cache bucket
    required: true
  cache-encryption-key:
    description: Gradle cache encryption key. Required for configuration caching. See https://github.com/gradle/actions/blob/main/docs/setup-gradle.md#saving-configuration-cache-data
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-java@v5
      with:
        java-version: 21
        distribution: temurin

    - name: Assume role for access to cache bucket
      uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708
      if: inputs.cache-role != ''
      with:
        aws-region: eu-west-2
        role-to-assume: ${{ inputs.cache-role }}
        role-skip-session-tagging: true
        role-duration-seconds: 1200

    - name: Save credentials to AWS profile
      if: inputs.cache-role != ''
      shell: bash # language=bash
      run: |
        export AWS_PROFILE=cache-profile
        aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID" --profile "$PROFILE_NAME"
        aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY" --profile "$PROFILE_NAME"
        aws configure set aws_session_token "$AWS_SESSION_TOKEN" --profile "$PROFILE_NAME"
        aws configure set region "eu-west-2" --profile "$PROFILE_NAME"
        echo "AWS_PROFILE=$AWS_PROFILE" >> $GITHUB_ENV

    - name: Set cache encryption key as environment variable
      shell: bash
      run: echo "GRADLE_ENCRYPTION_KEY=$key" >> $GITHUB_ENV
      env:
        key: ${{ inputs.cache-encryption-key }}

    - uses: gradle/actions/setup-gradle@v5
      with:
        add-job-summary: 'on-failure'
        cache-encryption-key: ${{ env.GRADLE_ENCRYPTION_KEY }}
        gradle-home-cache-excludes: |
          caches/build-cache-1

    - name: Manually cache buildSrc output # workaround for https://github.com/gradle/actions/issues/21
      uses: actions/cache@v5
      with:
        path: buildSrc/build
        key: gradle-buildSrc-${{ hashFiles('buildSrc/src/**', 'buildSrc/build.gradle.kts') }}
