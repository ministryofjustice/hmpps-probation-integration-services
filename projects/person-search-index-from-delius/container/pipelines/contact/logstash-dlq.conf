input {
    dead_letter_queue {
        id => "read-full-load-dlq"
        path => "/usr/share/logstash/data/dead_letter_queue"
        pipeline_id => "contact-full-load"
    }
    dead_letter_queue {
        id => "read-incremental-dlq"
        path => "/usr/share/logstash/data/dead_letter_queue"
        pipeline_id => "contact-incremental"
    }
}

filter {
    mutate {
        id => "synthesize-sqs-message"
        add_field => {
            "Message" => "{\"contactId\": %{contactId}}"
            "error_reason" => "%{[@metadata][dead_letter_queue][reason]}"
            "plugin_id" => "%{[@metadata][dead_letter_queue][plugin_id]}"
            "plugin_type" => "%{[@metadata][dead_letter_queue][plugin_type]}"
            "entry_time" => "%{[@metadata][dead_letter_queue][entry_time]}"
       }
    }
}

output {
    sqs {
        id => "send-to-sqs-dlq"
        queue => "${CONTACT_SQS_DLQ_NAME}"
        access_key_id => "${CONTACT_SQS_DLQ_ACCESS_KEY_ID}"
        secret_access_key => "${CONTACT_SQS_DLQ_SECRET_ACCESS_KEY}"
        endpoint => "${SQS_ENDPOINT:https://sqs.eu-west-2.amazonaws.com}"
        region => "eu-west-2"
    }
}
