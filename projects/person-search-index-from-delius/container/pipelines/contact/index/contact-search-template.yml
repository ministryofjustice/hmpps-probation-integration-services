index_patterns:
  - contact-search-*

template:
  settings:
    index:
      number_of_shards: 18 # ~= Total size of data / 50GB
      number_of_replicas: 1
    index.mapping.ignore_malformed: true
    analysis:
      analyzer:
        probation_text_analyzer:
          tokenizer: custom-whitespace  # Split words on whitespace while preserving space-separated dates, numbers and postcodes
          filter:
            - asciifolding              # Convert non-ascii characters to ascii (e.g. "Êxâmple.text" => "Example.text")
            - lowercase                 # Convert all characters to lowercase
            - capture_numbers           # Capture consecutive numbers (e.g. "DATE=01-02-03" => ["01-02-03", "DATE=01-02-03"])
            - replace_dialcodes         # Replace dial codes with 0 (e.g. "+44123..." => "0123...")
            - dates_iso8601             # Convert a range of date formats to yyyy-MM-dd
            - dates_month_day_year      #   e.g. "feb 1st 1999" => "01.feb.1999
            - dates_jan                 #   e.g. "1st January 19" => "01.01.19"
            - dates_feb                 #   e.g. "01.feb.99" => "01.02.99"
            - dates_mar                 #   ...
            - dates_apr
            - dates_may
            - dates_jun
            - dates_jul
            - dates_aug
            - dates_sep
            - dates_oct
            - dates_nov
            - dates_dec
            - dates_year_month_day      #   e.g. "1999.02.01" => "01.02.1999"
            - dates_long_year           #   e.g. "01 02 1999" => "01.02.1999"
            - dates_short_year_19       #   e.g. "01 02 99"   => "01.02.1999"
            - dates_short_year_20       #   e.g. "01 02 03"   => "01.02.2003"
            - dates_short_day           #   e.g. "1 02 1999"  => "01.02.1999"
            - dates_short_month         #   e.g. "01 2 1999"  => "01.02.1999"
            - dates_reformat            #   e.g. "01.02.1999" => "1999-02-01"
            - catenate_non_dates        # Combine any numeric fields that haven't been matched as dates (e.g. phone numbers "(0123) 456-789" => "0123456780")
            - override_stemmer          # Exclude words from stemming (e.g. officer and office should be treated separately)
            - stemmer                   # Perform word stemming (e.g. "example" => "exampl" , "testing" => "test")
            - multiword_synonyms        # Combine multi-word synonyms into a single token (e.g. ["unpaid", "work"] => ["unpaid", "work", "unpaid_work"])
            - probation_synonyms        # Apply probation synonyms (e.g. "upw" => ["upw", "unpaid_work"])
            - delimit_words             # Split tokens on punctuation (e.g. "example.text" => ["example.text", "exampletext", "example", "text"])
            - flatten_graph             # Flatten the token graph, so it can be used for indexing
            - override_stemmer          # Perform additional word stemming after synonyms have been applied
            - stemmer                   # ...
            - trim                      # Trim any whitespace from the start/end of tokens
            - remove_single_chars       # Remove any tokens that are a single character
            - unique_tokens             # Remove any duplicate tokens in the same positions
      tokenizer:
        custom-whitespace:
          type: pattern
          pattern: |
            ( \b\d{1,2}(?:st|nd|rd|th)?[\ \-\./]         # capture space-separated dates (e.g. "1st february 1999", "1 feb 99")
                (?:jan(?:uary)?|feb(?:ruary)?
                  |mar(?:ch)?|apr(?:il)?|may
                  |june?|july?|aug(?:ust)?
                  |sept?(?:ember)?|oct(?:ober)?
                  |(?:nov|dec)(?:ember)?)
                [\ \-\./](?:19|20)?\d{2}\b
            | \b(?:jan(?:uary)?|feb(?:ruary)?            # capture space-separated dates, with month first (e.g. "feb 1st 99", "feb 01 1999")
                  |mar(?:ch)?|apr(?:il)?|may
                  |june?|july?|aug(?:ust)?
                  |sept?(?:ember)?|oct(?:ober)?
                  |(?:nov|dec)(?:ember)?)
                [\ \-\./]\d{1,2}(?:st|nd|rd|th)?
                [\ \-\./](?:19|20)?\d{2}\b
            | \(?\+?\d+[\ \-\./\(\)][\d\ \-\./\(\)]+\d+  # capture space-separated numbers (e.g. "phone 0123 456 78" => ["phone", "0123 456 78"])
            | [a-z]{1,2}\d[a-z\d]?\ \d[a-z]{2}           # capture space-separated postcodes (e.g. "M20 0AA is the postcode" => ["M20 0AA", "is", "the", "postcode"])
            | \S+                                        # tokenize everything else on whitespace
            )
          flags: CASE_INSENSITIVE|COMMENTS
          group: 1
      filter:
        multiword_synonyms:
          type: synonym
          synonyms:
            - unpaid work => unpaid_work
            - community payback => community_payback
            - community manager => community_manager
            - community offender manager => community_offender_manager
            - offender manager => offender_manager
            - failed to attend => failed_to_attend
            # TODO add mappings for all space-separated terms
        probation_synonyms:
          type: synonym
          synonyms:
            - 1, one
            - 2, two
            - 3, three
            - 4, four
            - 5, five
            - 6, six
            - 7, seven
            - 8, eight
            - 9, nine
            - 10, ten
            - 11, eleven
            - 12, twelve
            - 13, thirteen
            - 14, fourteen
            - 15, fifteen
            - 16, sixteen
            - 17, seventeen
            - 18, eighteen
            - 19, nineteen
            - 20, twenty
            - 30, thirty
            - 40, forty
            - 50, fifty
            - 60, sixty
            - 70, seventy
            - 80, eighty
            - 90, ninety
            - 1 am, 1am, 0100, 01.00, 1.00
            - 2 am, 2am, 0200, 02.00, 2.00
            - 3 am, 3am, 0300, 03.00, 3.00
            - 4 am, 4am, 0400, 04.00, 4.00
            - 5 am, 5am, 0500, 05.00, 5.00
            - 6 am, 6am, 0600, 06.00, 6.00
            - 7 am, 7am, 0700, 07.00, 7.00
            - 8 am, 8am, 0800, 08.00, 8.00
            - 9 am, 9am, 0900, 09.00, 9.00
            - 10 am, 10am, 1000, 10.00
            - 11 am, 11am, 1100, 11.00
            - 12 pm, 12pm, 1200, 12.00, midday, mid-day, noon
            - 1 pm, 1pm, 1300, 13.00
            - 2 pm, 2pm, 1400, 14.00
            - 3 pm, 3pm, 1500, 15.00
            - 4 pm, 4pm, 1600, 16.00
            - 5 pm, 5pm, 1700, 17.00
            - 6 pm, 6pm, 1800, 18.00
            - 7 pm, 7pm, 1900, 19.00
            - 8 pm, 8pm, 2000, 20.00
            - 9 pm, 9pm, 2100, 21.00
            - 10 pm, 10pm, 2200, 22.00
            - 11 pm, 11pm, 2300, 23.00
            - 12 am, 12am, 0000, 00.00, midnight, mid-night
            - abs, absence, failed to attend, fta # TODO replace space-separated terms with underscores e.g. "failed to attend" -> "failed_to_attend"
            - abuse, domestic violence, da, dv
            - acceptable, acceptable absence, aa
            - accom, accommodation, housing, cas, cas1, cas2, cas3, home, location, addr, address
            - aco, assistant chief officer
            - acr, auto conditional release date, crd, conditional release date, ard, automatic release date
            - adj, adjourned
            - admission, admitted
            - after care, aftercare, after-care
            - afternoon, pm
            - alc, alcohol, booze, drinking, drunk, drunkenness
            - am, morning
            - annual, yearly, 12 monthly, 12monthly, per annum
            - anti social, antisocial, anti-social, asbo
            - antidepressants, anti-depressants, anti depressants
            - ap, accredited programme, acc prog, approved premises
            - appointment, office visit, visit, attendance, appt
            - assault, abh, actual bodily harm, gbh, grievous bodily harm
            - atr, alcohol treatment requirement
            - att, attend, attended, attendance
            - bbr, building better relationships
            - bcs, basic custody screening, bcst, basic custody screening tool
            - birth, maternity
            - bop, bring on potential
            - ca, case admin, case administrator, court admin, court administrator
            - calm, controlling anger and learning to manage it
            - care, care needs, social services, care experienced, care home, a home
            - cas1, ap, approved premises, approved premise
            - cas2, bass, bail accommodation, bail accommodation support service
            - cas3, transitional housing, temporary accommodation, short-term accommodation, short term accommodation
            - cc, crown court
            - ccr, pre-release custody date
            - ccs, recall date
            - cdvp, community domestic violence programme
            - cert, certificate, certification, award, qualification
            - child, children, kid, kids
            - chronology, timeline, time line
            - cja, criminal justice act, cja2003
            - client, offender, pop, person on probation, probationer
            - co, community order, probation order, cro, community rehabilitation order, cpo, community punishment order, cpro, community punishment and rehabilitation order
            - comm, communication, communications
            - commissioned services, commissioned rehabilitative services, rehabilitative services, crs
            - community service, community payback, unpaid work, upw, cp
            - comp, comply, complied
            - conviction, sentence, event, order, co, supervision
            - cosa, circles of support
            - court, magistrates court, mags court, mags crt, mags, mc, crown court, crown crt, cc, crn court, crn crt
            - covaid, control of violence for angry impulsive drinkers
            - cpo, community punishment order
            - cppt, com, mgr, manager, offender manager, practitioner, probation practitioner, pp, community practitioner, cpp, po, pso, pquip, om, supervisor, officer, probation officer
            - csogp, community sex offender group programme
            - custody, prison, remand, establishment, irc, immigration removal centre, sh, secure hospital
            - da, dad, father
            - daso, domestic abuse safety officer, wso, womens safety officer, wsw, womens safety worker, vlo, victims liaison officer, liaison
            - dcr, discretionary release date
            - departure, move on, move-on, leave
            - deported, deportation, early removal
            - did, drink impaired drivers
            - died, passed away
            - dip, drug intervention programme
            - disq, disqualified
            - dob, date of birth, birthday, birth date, birthdate
            - docs, documents, letters, reports
            - drg, drug, drugs, substance misuse, substance abuse, glue
            - drr, drug rehabilitation requirement
            - dss, dhss, social security
            - dv, da, domestic abuse, domestic violence, a domestic
            - dwp, department for work and pensions
            - ecl, end of custody licence
            - ecsl, end of custody supervision licence, early release
            - em, electronic monitoring, curfew, tag
            - erd, earliest release date
            - ete, education, training, employment, education training employment, education training and employment, training
            - ex-asp, ex-armed services personnel, veteran, army, navy, air force, airforce, raf, marines
            - excl, exclusion
            - exp, expected release date
            - exposure, flashing
            - failed to attend, fta, failed to report, absent, absence, ua, unacceptable absence,
            - failed to comply, ftc, unacceptable behaviour
            - fostercare, foster care, foster-care
            - ftr, fixed term recall, fixed-term recall, fixed-term-recall, recall
            - gf, girlfriend, girl friend
            - gp, doctor, doctors, general practitioner, consultant, psycologist
            - grandad, grand dad, grandfather
            - grandchild, grand child, grandkid, grand kid, grand children, grandchildren, grandkids
            - grandma, grand ma, grandmother, grand mother, gran, granny, nan, nana
            - h/o, handover, hand over, hand-over
            - harm, rosh, rosha, risk of serious harm, risk of harm
            - hate crime, hate-crime, racially motivated, homophobic, faith related, transophobic, racist, racism
            - hdc, home detention curfew
            - hde, hdc expected date
            - ho, home office, home-office
            - homeless, homelessness, duty to refer, duty-to-refer, nfa
            - hours, hrs
            - i-sotp, internet sex offender treatment programme
            - iaps, im, interventions manager, interim accredited programmes system, interim accredited programmes service
            - iicsa, independent inquiry into child sexual abuse
            - intensive supervision, iom, restorative justice, problem solving court
            - intervention, structured intervention, accredited programme, crs, si, tsi, ap, programme, nsi, non statutory intervention, non specified intervention
            - intro, introduction
            - iom, integrated offender management
            - isp, initial sentence plan, fsp, final sentence plan, sentence plan
            - ispp, ipp, indeterminate sentence for public protection
            - key worker, keyworker, key-worker
            - lau, local admin unit, cluster, ldu, local delivery unit, pdu, probation delivery unit
            - led, licence expiry date
            - liap, low intensity alcohol programmes
            - lic, lc, licence condition, licence
            - lp, lpt, london, london probation, london probation trust, london probation area
            - management, supervision
            - medication, medicine, prescription, naloxone, meds
            - mh, mental health
            - min, minutes
            - mom, mum, mother
            - msg, message, text, email, sms
            - national insurance number, nin, nino, ni number, national insurance
            - national standards, nsi
            - nd, national delius, delius, ndelius
            - new me, bnm, lmn, nmc, nms
            - nomis number, noms number, nom no, noms id, nomis id
            - nomis, p-nomis
            - npd, npl, non parole date, non-parole department
            - offence, offences, crime, crimes
            - omu, offender management unit
            - ooh, out of hours
            - parom1, parom 1, parole report
            - partner, husband, wife, boyfiend, girlfriend
            - ped, parole eligibility date
            - pension, retirement, retirement benefit
            - phe, public health england, health service, phw, public health wales
            - pic, picture, photo, photograph
            - pip, personal independence payment
            - placement, project, schedule
            - police constable, constable, pc, police officer
            - pom, prison offender manager
            - pom1, pom handover expected start date
            - pom2, ro responsibility handover from pom to om expected date
            - ppo, prolific priority offender
            - precons, previous convictions, pre-cons
            - probation, probation service, ps, nps, crc, community rehabilitation company, trust, provider
            - prq, parole request date
            - prq, parole request date
            - psr, pre-sentence report, presentence report, sfr, short format report, short-format report, oral report
            - pss, pssr, post sentence supervision, post-sentence supervision,  post sentence supervision requirement, post-sentence supervision requirement
            - rar, rehabilitation activity requirement
            - referal, referral
            - register, registration, globe, alert
            - rehab, rehabilitation
            - rotl, temporary release, temporary licence, release on temporary licence
            - rotld, rotl end date
            - rpt, rep, rept, report
            - rrl, re-release date, release date
            - rrr, release review date
            - rsr, risk of serious recidivism
            - safe guarding, safeguarding, safe-guarding, protection, vulnerable, vulnerability
            - sar, subject access request
            - sara, spousal assault risk assessment
            - sarn, structured assessment of risk and need
            - sc4, section 44 extended date
            - scp, self change programme, self-change programme
            - sdp, short duration programme
            - sed, sentence expiry date
            - self-harm, selfharm, self harm, suicide, self-inflicted death, self inflicted death
            - sex, sexual
            - sfo, serious further offence, serious further offences, further offence, further offences
            - sha, strategic health authority, health authority, health board
            - shpo, sexual harm prevention order, sopo, sexual offending prevention order, shpo, sro, sexual risk order
            - sotp, sex offender treatment programme
            - spo, senior, senior probation officer
            - std, standard
            - tact, terrorism act
            - tc, t/c, resettlement, throughcare, ttg, through the gate, through-the-gate
            - td01, parole board review date
            - term, termination, end date, actual end date
            - tfr, transfer
            - time table, timetable, time-table
            - trf, tariff date
            - tsp, thinking skills programme
            - tssed, top-up supervision expiry date, top-up supervision end date, pssed, post sentence supervision expiry date, post-sentence supervision expiry date, post-sentence supervision end date, post sentence supervision end date
            - ual, unlawfully at large, escaped, at large, wwb, warrant without bail
            - uc, universal credit, benefits
            - upw, unpaid work, community payback
            - vlu, victims liasion unit
            - wfh, work from home
            - wso, womens safety officer
            - youth, youth offending service, yots, youth offending team, yot, borstal, yoi, young offender institution
            - yrs, years
        delimit_words:
          type: word_delimiter_graph
          preserve_original: true
          generate_number_parts: false
        remove_single_chars:
          type: length
          min: 2
        override_stemmer:
          type: stemmer_override
          rules:
            - officer => officer
            - officers => officer
            - office => office
            - offices => office
            - nps => nps
            - one => one
            - nomis => nomis
            - delius => delius
            - ndelius => ndelius
            - nationaldelius => nationaldelius
        capture_numbers:
          type: pattern_capture
          preserve_original: true
          patterns:
            - (\d{4}-\d{2}-\d{2})t00:00:00(?:\.000)?z? # iso8601 dates (e.g. "2001-02-03T00:00:00.000Z" => "2001-02-03")
            - (\d+[\d\W]+\d+)                          # any delimited numbers (e.g. "0123-456 789")
        replace_dialcodes:
          type: pattern_replace
          preserve_original: true
          pattern: ^(?:00|\+)?44\W*0?(.*)$
          replacement: 0$1
        dates_iso8601:
          type: pattern_replace
          pattern: ^(\d{4})-(\d{2})-(\d{2})t\d{2}:00:00(?:\.000)?z?$
          replacement: $3.$2.$1
        dates_month_day_year:
          type: pattern_replace
          pattern: ^(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sept?(?:ember)?|oct(?:ober)?|(?:nov|dec)(?:ember)?)[\s\-\./](\d{1,2})(?:st|nd|rd|th)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $2.$1.$3
        dates_jan:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]jan(?:uary)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.01.$2
        dates_feb:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]feb(?:ruary)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.02.$2
        dates_mar:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]mar(?:ch)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.03.$2
        dates_apr:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]apr(?:il)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.04.$2
        dates_may:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]may[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.05.$2
        dates_jun:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]june?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.06.$2
        dates_jul:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]july?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.07.$2
        dates_aug:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]aug(?:ust)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.08.$2
        dates_sep:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]sept?(?:ember)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.09.$2
        dates_oct:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]oct(?:ober)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.10.$2
        dates_nov:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]nov(?:ember)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.11.$2
        dates_dec:
          type: pattern_replace
          pattern: ^(\d{1,2})(?:st|nd|rd|th)?[\s\-\./]dec(?:ember)?[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.12.$2
        dates_year_month_day:
          type: pattern_replace
          pattern: ^((?:19|20)\d{2})[\s\-\./]?(0?[1-9]|1[0-2])[\s\-\./]?(\d{2})$
          replacement: $3.$2.$1
        dates_long_year:
          type: pattern_replace
          pattern: ^(\d{1,2})[\s\-\./](0?[1-9]|1[0-2])[\s\-\./]((?:19|20)\d{2})$
          replacement: $1.$2.$3
        dates_short_year_19:
          type: pattern_replace
          pattern: ^(\d{1,2})[\s\-\./](0?[1-9]|1[0-2])[\s\-\./]([8-9]\d)$
          replacement: $1.$2.19$3
        dates_short_year_20:
          type: pattern_replace
          pattern: ^(\d{1,2})[\s\-\./](0?[1-9]|1[0-2])[\s\-\./]([0-7]\d)$
          replacement: $1.$2.20$3
        dates_short_day:
          type: pattern_replace
          pattern: ^(\d{1})[\s\-\./](0?[1-9]|1[0-2])[\s\-\./]((?:19|20)?\d{2})$
          replacement: 0$1.$2.$3
        dates_short_month:
          type: pattern_replace
          pattern: ^(\d{2})[\s\-\./](\d{1})[\s\-\./]((?:19|20)?\d{2})$
          replacement: $1.0$2.$3
        dates_reformat:
          type: pattern_replace
          pattern: ^(\d{2})\.(0[1-9]|1[0-2])\.((?:19|20)\d{2})$
          replacement: $3-$2-$1
        catenate_non_dates:
          type: condition
          filter: [ remove_non_digits ]
          script:
            source: '!(token.getTerm().toString() ==~ /^(?:19|20)\d{2}-(0[1-9]|1[0-2])-\d{2}$/) && token.getTerm().toString() ==~ /^[\d\W]+$/'
        remove_non_digits:
          type: pattern_replace
          pattern: \D
        unique_tokens:
          type: unique
          only_on_same_position: true

  mappings:
    properties:
      crn:
        type: keyword
      offenderId:
        type: integer
      contactId:
        type: integer
      date:
        type: text
        analyzer: probation_text_analyzer
        copy_to: notes
        fields:
          date:
            type: date
            format: date_optional_time||yyyy-MM-dd||dd-MM-yyyy
      startTime:
        type: date
        format: hour_minute_second
      endTime:
        type: date
        format: hour_minute_second
      notes:
        type: text
        analyzer: probation_text_analyzer
        boost: 5
      description:
        type: text
        analyzer: probation_text_analyzer
        boost: 4
      outcome:
        type: text
        store: true
        boost: 2
        fields:
          keyword:
            type: keyword
      type:
        type: text
        store: true
        fields:
          keyword:
            type: keyword
      typeCode:
        type: keyword
        copy_to: type
      typeDescription:
        type: keyword
        copy_to: type
      typeShortDescription:
        type: keyword
        copy_to: type
      outcomeCode:
        type: keyword
        copy_to: outcome
      outcomeDescription:
        type: keyword
        copy_to: outcome
      attended:
        type: keyword
        copy_to: outcome
      complied:
        type: keyword
        copy_to: outcome
      lastUpdatedDateTime:
        type: date
      rowVersion:
        type: double
        index: false