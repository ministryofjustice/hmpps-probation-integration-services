apiVersion: batch/v1
kind: CronJob
metadata:
  name: contact-index-alias-management
spec:
  schedule: {{ .Values.management.contact_schedule }}
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          containers:
            - name: contact-search
              image: ghcr.io/ministryofjustice/hmpps-probation-integration-services/person-search-index-from-delius-management:{{ .Values.version }}
              args:
                - /scripts/index-alias-management.sh
              env:
                - name: INDEX_PREFIX
                  value: contact-search
                - name: TIMEOUT
                  value: 86400 # 1 day
                - name: SEARCH_INDEX_HOST
                  value: {{ .Values.management.host }}
                - name: APPLICATIONINSIGHTS_CONNECTION_STRING
                  valueFrom:
                    secretKeyRef:
                      name: common
                      key: APPLICATIONINSIGHTS_CONNECTION_STRING
                      optional: false
          restartPolicy: Never
