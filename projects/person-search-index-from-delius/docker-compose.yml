version: "2.4"

services:
  logstash:
    build:
      context: container
    environment:
      JDBC_CONNECTION_STRING: jdbc:oracle:thin:@//oracledb:1521/XEPDB1
      JDBC_USER: delius_app_schema
      JDBC_PASSWORD: NDelius1
      PRIMARY_INDEX_NAME: person-search-primary
      STANDBY_INDEX_NAME: person-search-standby
      SEARCH_INDEX_HOST: "http://elasticsearch:9200"
      SEARCH_INDEX_USERNAME: elastic
      SEARCH_INDEX_PASSWORD: elastic
      INDEX_SCHEDULE: "* * * * *"
    ports:
      - "9600:9600"
    depends_on:
      oracledb:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - shared

  oracledb:
    image: 895523100917.dkr.ecr.eu-west-2.amazonaws.com/hmpps/delius-test-db
    healthcheck:
      test: lsnrctl status | grep -q 'Service "xepdb1" has 1 instance(s).'
    ports:
      - "1521:1521"
    networks:
      - shared

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.10.2
    healthcheck:
      test: curl -f localhost:9200
    environment:
      discovery.type: single-node
      ELASTIC_PASSWORD: elastic
    ports:
      - "9200:9200"
    networks:
      - shared

networks:
  shared:
