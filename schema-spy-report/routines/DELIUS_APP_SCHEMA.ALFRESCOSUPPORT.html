<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>TSTNDA.DELIUS_APP_SCHEMA</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
        <!-- Bootstrap 3.3.5 -->
        <link rel="stylesheet" href="../bower/admin-lte/bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="../bower/font-awesome/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="../bower/ionicons/css/ionicons.min.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="../bower/datatables.net-bs/css/dataTables.bootstrap.min.css">
        <link rel="stylesheet" href="../bower/datatables.net-buttons-bs/css/buttons.bootstrap.min.css">
        <!-- Code Mirror -->
        <link rel="stylesheet" href="../bower/codemirror/codemirror.css">
        <!-- Fonts -->
        <link href='../fonts/indieflower/indie-flower.css' rel='stylesheet' type='text/css'>
        <link href='../fonts/source-sans-pro/source-sans-pro.css' rel='stylesheet' type='text/css'>

        <!-- Theme style -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/AdminLTE.min.css">
        <!-- Salvattore -->
        <link rel="stylesheet" href="../bower/salvattore/salvattore.css">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
           folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/skins/_all-skins.min.css">
        <!-- SchemaSpy -->
        <link rel="stylesheet" href="../schemaSpy.css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="../bower/html5shiv/html5shiv.min.js"></script>
        <script src="../bower/respond/respond.min.js"></script>
        <![endif]-->
    </head>
    <!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->
    <body class="hold-transition skin-blue layout-top-nav">
        <div class="wrapper">
            <header class="main-header">
                <nav class="navbar navbar-static-top">
                    <div class="container">
                        <div class="navbar-header">
                            <a href="../index.html" class="navbar-brand"><b>TSTNDA</b></a><span class="navbar-brand" style="padding-left: 0">.DELIUS_APP_SCHEMA</span>
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"><i class="fa fa-bars"></i></button>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                            <ul class="nav navbar-nav">
                                <li><a href="../index.html">Tables <span class="sr-only">(current)</span></a></li>
                                <li><a href="../columns.html" title="All of the columns in the schema">Columns</a></li>
                                <li><a href="../constraints.html" title="Useful for diagnosing error messages that just give constraint name or number">Constraints</a></li>
                                <li><a href="../relationships.html" title="Diagram of table relationships">Relationships</a></li>
                                <li><a href="../orphans.html" title="View of tables with neither parents nor children">Orphan&nbsp;Tables</a></li>
                                <li><a href="../anomalies.html" title="Things that might not be quite right">Anomalies</a></li>
                                <li><a href="../routines.html" title="Procedures and functions">Routines</a></li>
                            </ul>
                        </div>
                        <!-- /.navbar-collapse -->
                        <!-- Navbar Right Menu -->
                    </div>
                    <!-- /.container-fluid -->
                </nav>
            </header>
            <!-- Main content -->
            <!-- Full Width Column -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>DELIUS_APP_SCHEMA.ALFRESCOSUPPORT</h1><br />
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                            <h3 id="Columns" class="box-title">Parameters</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <table id="standard_table" class="table table-bordered table-striped dataTable" role="grid">
                                <thead align='left'>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Mode</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-code-o"></i>
                            <h3 id="RoutineDefinition" class="box-title">Definition</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <textarea id="sql-script-codemirror" name="sql-script-codemirror" rows="" style="display: none;">PACKAGE BODY AlfrescoSupport&#10;AS&#10;--&#10;--&#10;-- Package variables - used in information and error messaging&#10;--&#10;    g_package_version CONSTANT VARCHAR2(30) :&#61; GC_VERSION;&#10;    g_component_code  CONSTANT VARCHAR2(3)  :&#61; &#39;ALF&#39;;&#10;    g_package_name    CONSTANT VARCHAR2(30) :&#61; &#39;AlfrescoSupport&#39;;&#10;    g_default_user    CONSTANT VARCHAR2(30) :&#61; &#39;DELIUS_SYSTEM_USER&#39;;&#10;    g_instance_id     INTEGER :&#61; 0;&#10;    --&#10;    g_procedure_name  VARCHAR2(30)  :&#61; &#39;initial_value&#39;;&#10;    g_label           VARCHAR2(6)   :&#61; &#39;000000&#39;;&#10;    g_pdm             NUMBER;&#10;    g_unit_test       BOOLEAN       :&#61; FALSE;&#10;    --&#10;    -- message type&#10;    mt_information    CONSTANT NUMBER :&#61; 1;&#10;    mt_warning        CONSTANT NUMBER :&#61; 2;&#10;    mt_error          CONSTANT NUMBER :&#61; 3;&#10;    mt_fatal_error    CONSTANT NUMBER :&#61; 4;&#10;    --&#10;    invalid_location_format EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(invalid_location_format, -20104);&#10;    --&#10;    document_deleted EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(document_deleted, -20105);&#10;    --&#10;    document_migrated EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(document_migrated, -20106);&#10;    --&#10;    parent_deleted EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(parent_deleted, -20107);&#10;    --&#10;    parent_removed EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(parent_removed, -20108);&#10;    --&#10;    filename_error EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(filename_error, -20109);&#10;    --&#10;    g_pending_offenders_TAB   t_tab_ORGANISATIONS :&#61; t_tab_ORGANISATIONS();&#10;    --&#10;    TYPE table_of_strings_TYP IS TABLE OF VARCHAR2(32767);&#10;    --&#10;    TYPE meta_data_rec_TYP IS RECORD (&#10;                      crn                   OFFENDER.crn%TYPE,&#10;                      last_updated_user_id  USER_.user_id%TYPE,&#10;                      probation_area_id     PROBATION_AREA.probation_area_id%TYPE,&#10;                      author                VARCHAR2(80),&#10;                      entityType            DOCUMENT.table_name%TYPE,&#10;                      entityId              DOCUMENT.primary_key_id%TYPE,&#10;                      docType               VARCHAR2(200),&#10;                      fileName              DOCUMENT.document_name%TYPE,&#10;                      filedata              BLOB, --DOCUMENT.document%TYPE,&#10;                      alfrescoID            DOCUMENT.alfresco_document_id%TYPE,&#10;                      sourceTableKey        DOCUMENT.document_id%TYPE,&#10;                      locked                VARCHAR2(5),&#10;                      reserved              VARCHAR2(5),&#10;                      deleted               VARCHAR2(5),&#10;                      parent_soft_deleted   VARCHAR2(5));&#10;--&#10;--&#10;--&#10;FUNCTION get_version RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN g_package_name || &#39;[version &#61;&gt; &#39; || g_package_version || &#39;]&#39;;&#10;END get_version;&#10;--***************************************************&#10;-- PKG_DEBUG wrappers                               *&#10;--***************************************************&#10;PROCEDURE procDebug(p_msg CLOB, p_print_flag VARCHAR2 DEFAULT &#39;N&#39;) IS&#10;BEGIN&#10;    PKG_Debug.procDebug(p_msg, p_print_flag);&#10;END procDebug;&#10;&#10;FUNCTION funcgetDebugMode RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Debug.funcgetDebugMode;&#10;END funcgetDebugMode;&#10;--&#10;PROCEDURE message(p_msg VARCHAR2, p_trace_level INTEGER DEFAULT 0) IS&#10;BEGIN&#10;    procDebug(&#39;[&#39; || g_label || &#39;] &#39; || p_msg, p_print_flag &#61;&gt; &#39;Y&#39;);&#10;END message;&#10;--***************************************************&#10;-- PKG_COMMON wrappers                              *&#10;--***************************************************&#10;PROCEDURE raise_error(&#10;    p_error_code     PLS_INTEGER DEFAULT NULL,&#10;    p_error_message VARCHAR2 DEFAULT NULL)&#10;IS&#10;    --&#10;    l_error_code    PLS_INTEGER :&#61; NVL(p_error_code, SQLCODE);&#10;    l_error_message VARCHAR2(4000) :&#61; SUBSTR(NVL(p_error_message, SQLERRM), 1, 4000);&#10;    --&#10;BEGIN&#10;    g_procedure_name :&#61; &#39;raise_error&#39;;&#10;    IF l_error_code BETWEEN -20999 AND -20000 THEN&#10;        RAISE_APPLICATION_ERROR (l_error_code, l_error_message);&#10;    ELSIF l_error_code &gt; 0 AND l_error_code NOT IN (1,100) THEN&#10;        RAISE_APPLICATION_ERROR (-20000, l_error_code||&#39; - &#39;||l_error_message);&#10;    ELSIF l_error_code IN (100, -1403) THEN&#10;        RAISE_APPLICATION_ERROR (-20000, l_error_code||&#39; - &#39;||l_error_message);&#10;    ELSIF l_error_code &lt;&gt; 0 THEN&#10;        RAISE_APPLICATION_ERROR(-20000, &#39;INTERNAL ERROR: An unexpected error in PL/SQL&#39;);&#10;    END IF;&#10;END raise_error;&#10;--&#10;--&#10;FUNCTION is_str_empty(p_str VARCHAR2, p_ignore_spaces_and_zeroes VARCHAR2 DEFAULT &#39;N&#39;) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.is_str_empty( p_str, p_ignore_spaces_and_zeroes );&#10;END is_str_empty;&#10;--&#10;FUNCTION empty2null(p_str VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.empty2null(p_str);&#10;END empty2null;&#10;&#10;FUNCTION nvlstr(p_str1 VARCHAR2, p_str2 VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.nvl2(empty2null(p_str1), empty2null(p_str2));&#10;END nvlstr;&#10;--&#10;--&#10;--***************************************************&#10;-- Helpers                                          *&#10;--***************************************************&#10;--&#10;-- Used to populate mtt_message_log with information type message&#10;PROCEDURE info (p_message VARCHAR2)&#10;IS&#10;BEGIN&#10;    SPGConfig.insert_message_log( message_type_id_in  &#61;&gt; mt_information,&#10;                                  component_code_in   &#61;&gt; g_component_code,&#10;                                  package_name_in     &#61;&gt; g_package_name,&#10;                                  procedure_name_in   &#61;&gt; g_procedure_name,&#10;                                  label_in            &#61;&gt; g_label,&#10;                                  message_text_in     &#61;&gt; p_message);&#10;END info;&#10;--&#10;-- Will populate mtt_message_log with warning message - will populate mtt_error_log if result of exception&#10;PROCEDURE warn (p_message VARCHAR2)&#10;IS&#10;BEGIN&#10;    SPGConfig.record_error( message_type_id_in    &#61;&gt; mt_warning,&#10;                            component_code_in     &#61;&gt; g_component_code,&#10;                            package_name_in       &#61;&gt; g_package_name,&#10;                            procedure_name_in     &#61;&gt; g_procedure_name,&#10;                            label_in              &#61;&gt; g_label,&#10;                            message_text_in       &#61;&gt; p_message);&#10;END warn;&#10;--&#10;-- Will populate mtt_message_log with error message and populate mtt_error_log with exception - used for log and continue&#10;PROCEDURE error (p_message VARCHAR2)&#10;IS&#10;BEGIN&#10;  SPGConfig.record_error( message_type_id_in    &#61;&gt; mt_error,&#10;                          component_code_in     &#61;&gt; g_component_code,&#10;                          package_name_in       &#61;&gt; g_package_name,&#10;                          procedure_name_in     &#61;&gt; g_procedure_name,&#10;                          label_in              &#61;&gt; g_label,&#10;                          message_text_in       &#61;&gt; p_message);&#10;END error;&#10;--&#10;-- Will populate mtt_message_log, mtt_error_log with error message and raise exception - used for log and halt&#10;PROCEDURE fatal (p_message VARCHAR2)&#10;IS&#10;BEGIN&#10;  SPGConfig.record_error( message_type_id_in    &#61;&gt; mt_fatal_error,&#10;                          component_code_in     &#61;&gt; g_component_code,&#10;                          package_name_in       &#61;&gt; g_package_name,&#10;                          procedure_name_in     &#61;&gt; g_procedure_name,&#10;                          label_in              &#61;&gt; g_label,&#10;                          message_text_in       &#61;&gt; p_message,&#10;                          raise_error_in        &#61;&gt; TRUE);&#10;END fatal;&#10;--&#10;--&#10;--***************************************************&#10;-- Package initialisation block                              *&#10;--***************************************************&#10;PROCEDURE do_init_vars&#10;IS&#10;    --&#10;    l_alf_wallet SPG_CONTROL.value_string%TYPE :&#61; SPGConfig.get_alfresco_wallet;&#10;    --&#10;BEGIN&#10;    --PKG_DynSQL.init_tab_info(p_reset_flag &#61;&gt; &#39;Y&#39;);&#10;    IF l_alf_wallet IS NOT NULL THEN&#10;        UTL_HTTP.set_wallet(path&#61;&gt;l_alf_wallet);&#10;    ELSE&#10;        --raise_application_error(-20001, &#39;LC_alfresco_wallet IS NULL!&#39;);&#10;        NULL;&#10;    END IF;&#10;    --&#10;END do_init_vars;&#10;--&#10;--&#10;--***************************************************&#10;-- Main procedures and functions                    *&#10;--***************************************************&#10;--&#10;--&#10;FUNCTION get_alf_url(p_action VARCHAR2) RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_url VARCHAR2(4096);&#10;    --&#10;BEGIN&#10;    --&#10;    l_url :&#61; SPGCONFIG.get_alfresco_url;&#10;    --&#10;    IF UPPER(p_action) IN (&#10;         -- NOMIS-SPG&#10;         GC_ALF_CREATE,&#10;         GC_ALF_FETCH,&#10;         GC_ALF_FETCH_RESERVE,&#10;         GC_ALF_RESERVE,&#10;         --GC_ALF_URI_RESERVE,&#10;         GC_ALF_DELETE,&#10;         GC_ALF_DISCARD,&#10;         GC_ALF_UNDELETE,&#10;         GC_ALF_HARD_DELETE,&#10;         GC_ALF_UPLOAD_RELEASE,&#10;         GC_ALF_LOCK,&#10;         GC_ALF_UNLOCK,&#10;         GC_ALF_DELETE_ALL_HARD,&#10;         GC_ALF_MOVE_SINGLE,&#10;         GC_ALF_DETAILS,&#10;         GC_ALF_PUBLISH,&#10;         GC_ALF_SEARCH,&#10;         GC_ALF_TEXT_SEARCH )&#10;    THEN&#10;        l_url :&#61; REPLACE(l_url, &#39;admin-spg&#39;, &#39;noms-spg&#39;);&#10;    ELSIF UPPER(p_action) IN (&#10;         -- ADMIN-SPG&#10;         GC_ALF_MERGE,&#10;         GC_ALF_ASSIGN_OFFENDER,&#10;         GC_ALF_UPDATE_METADATA )&#10;    THEN&#10;        l_url :&#61; REPLACE(l_url, &#39;noms-spg&#39;, &#39;admin-spg&#39;);&#10;    END IF;&#10;    --&#10;    RETURN l_url;&#10;    --&#10;END get_alf_url;&#10;--&#10;FUNCTION get_alfresco_permissions(&#10;    offenderid_in   IN NUMBER,&#10;    noAccessFlag_in IN VARCHAR2 DEFAULT &#39;N&#39;)&#10;RETURN alfresco_tab_typ PIPELINED&#10;IS&#10;    --&#10;    l_L1            NUMBER;&#10;    l_L2            NUMBER;&#10;    l_L3            NUMBER;&#10;    l_ret           NUMBER;&#10;    l_crn           OFFENDER.crn%TYPE;&#10;    l_organisations T_TAB_ORGANISATIONS;&#10;    l_offender_id   OFFENDER.offender_id%TYPE;&#10;    l_rec           alfresco_row_TYP;&#10;    --&#10;BEGIN&#10;    --&#10;    SELECT crn, CAST(organisations AS t_tab_organisations)&#10;    INTO l_crn, l_organisations&#10;    FROM offender&#10;    WHERE offender_id &#61; offenderid_in;&#10;    --&#10;    FOR each_po IN (&#10;        SELECT code, T_TAB_ORGANISATIONS(TO_CHAR(probation_area_id)) AS organisations&#10;        FROM probation_area&#10;        WHERE end_date IS NULL&#10;          AND selectable &#61; &#39;Y&#39;&#10;          AND code NOT IN (&#39;XXX&#39;,&#39;ALL&#39;)&#10;          AND code NOT LIKE &#39;N__&#39;&#10;          AND code BETWEEN &#39;C01&#39; AND &#39;C21&#39; )&#10;    LOOP&#10;        l_l1 :&#61; 0;&#10;        l_l2 :&#61; 0;&#10;        l_l3 :&#61; 0;&#10;        --&#10;        IF noAccessFlag_in &#61; &#39;N&#39; AND PKG_COMMON.funcMultiSetIntersectIsEmpty(each_po.organisations, l_organisations) &#61; 0 THEN&#10;            PKG_SEARCH.do_set_rbac_levels(&#10;                p_offender_id &#61;&gt; offenderid_in,&#10;                p_L1          &#61;&gt; l_L1,&#10;                p_L2          &#61;&gt; l_L2,&#10;                p_L3          &#61;&gt; l_L3,&#10;                p_username    &#61;&gt; each_po.code || &#39;_ALFRESCO&#39; );&#10;            --&#10;            info (l_crn || &#39; - &#39; || l_L1 || &#39; - &#39; || l_L2 || &#39; - &#39; || l_L3 || &#39; - &#39; || each_po.code);&#10;            --&#10;        END IF;&#10;        --&#10;        CASE&#10;            WHEN l_l1 &#61; 1 OR l_l3 &#61; 1 THEN l_ret :&#61; 2;&#10;            WHEN l_l2 &#61; 1 THEN l_ret :&#61; 1;&#10;            ELSE l_ret :&#61; 0;&#10;        END CASE;&#10;        --&#10;        --info (&#39;Alfresco Value &#61;&gt; &#39; || l_ret);&#10;        --&#10;        l_rec.crn             :&#61; l_crn;&#10;        l_rec.area_code       :&#61; each_po.code;&#10;        l_rec.level1_value    :&#61; l_L1;&#10;        l_rec.level2_value    :&#61; l_L2;&#10;        l_rec.level3_value    :&#61; l_L3;&#10;        l_rec.alfresco_value  :&#61; l_ret;&#10;        --&#10;        PIPE ROW(l_rec);&#10;        --&#10;    END LOOP;&#10;    --&#10;    RETURN;&#10;END get_alfresco_permissions;&#10;--&#10;--&#10;PROCEDURE addMessage2Queue(offenderid_in IN NUMBER)&#10;IS&#10;    --&#10;    l_bi_id                 NUMBER;&#10;    l_bi_code               BUSINESS_INTERACTION.business_interaction_code%TYPE;&#10;    l_unique_id             SPG_NOTIFICATION.unique_id%TYPE;&#10;    l_offender_id           NUMBER;&#10;    l_receiver_identity_id  NUMBER;&#10;    l_sender_identity_id    NUMBER;&#10;    --&#10;BEGIN&#10;    l_bi_code :&#61; &#39;SPGALF01&#39;;&#10;    l_offender_id :&#61; offenderid_in;&#10;    l_unique_id :&#61; offenderid_in;&#10;    --&#10;    SELECT /*+ RESULT_CACHE */ probation_area_id INTO l_receiver_identity_id&#10;    FROM probation_area&#10;    WHERE code &#61; &#39;ALF&#39;;&#10;    --&#10;    SELECT /*+ RESULT_CACHE */ probation_area_id INTO l_sender_identity_id&#10;    FROM probation_area&#10;    WHERE code &#61; &#39;N00&#39;;&#10;    --&#10;    l_bi_id :&#61; PKG_LOOKUPS.funcgetbusinessinteractionid(p_business_interaction_code &#61;&gt; l_bi_code);&#10;    --&#10;    INSERT INTO spg_notification(&#10;      spg_notification_id,&#10;      business_interaction_id,&#10;      offender_id,&#10;      unique_id,&#10;      date_created,&#10;      sender_identity_id,&#10;      receiver_identity_id,&#10;      processed_flag,&#10;      error_flag,&#10;      export_to_file_flag,&#10;      message_direction,&#10;      row_version&#10;    ) VALUES (&#10;      spg_notification_id_seq.NEXTVAL,&#10;      l_bi_id,&#10;      l_offender_id,&#10;      l_unique_id,&#10;      SYSDATE,&#10;      l_sender_identity_id,&#10;      l_receiver_identity_id,&#10;      0,&#10;      0,&#10;      0,&#10;      &#39;O&#39;,&#10;      0 );&#10;    --&#10;END addMessage2Queue;&#10;--&#10;PROCEDURE addOffender2Queue(offenderid_in IN NUMBER) IS&#10;BEGIN&#10;    --&#10;    IF offenderid_in &gt; 0 THEN&#10;        SELECT g_pending_offenders_TAB MULTISET UNION DISTINCT t_tab_ORGANISATIONS(TO_CHAR(offenderid_in))&#10;        INTO g_pending_offenders_TAB&#10;        FROM dual;&#10;    END IF;&#10;    --&#10;END addOffender2Queue;&#10;--&#10;PROCEDURE addOffenders2Queue(offenderid_TAB_in IN t_tab_ORGANISATIONS) IS&#10;BEGIN&#10;    --&#10;    IF offenderid_TAB_in.COUNT &gt; 0 THEN&#10;        SELECT g_pending_offenders_TAB MULTISET UNION DISTINCT offenderid_TAB_in&#10;        INTO g_pending_offenders_TAB&#10;        FROM dual;&#10;    END IF;&#10;    --&#10;END addOffenders2Queue;&#10;--&#10;PROCEDURE removeOffenderFromQueue(offenderid_in IN NUMBER) IS&#10;BEGIN&#10;    --&#10;    IF offenderid_in &gt; 0 THEN&#10;        SELECT g_pending_offenders_TAB MULTISET EXCEPT DISTINCT t_tab_ORGANISATIONS(TO_CHAR(offenderid_in))&#10;        INTO g_pending_offenders_TAB&#10;        FROM dual;&#10;    END IF;&#10;    --&#10;END removeOffenderFromQueue;&#10;--&#10;PROCEDURE removeOffendersFromQueue(offenderid_TAB_in IN t_tab_ORGANISATIONS) IS&#10;BEGIN&#10;    --&#10;    IF offenderid_TAB_in.COUNT &gt; 0 THEN&#10;        SELECT g_pending_offenders_TAB MULTISET EXCEPT DISTINCT offenderid_TAB_in&#10;        INTO g_pending_offenders_TAB&#10;        FROM dual;&#10;    END IF;&#10;    --&#10;END removeOffendersFromQueue;&#10;--&#10;FUNCTION getOffendersQueue RETURN t_tab_ORGANISATIONS IS&#10;BEGIN&#10;    RETURN NVL( g_pending_offenders_TAB, t_tab_ORGANISATIONS() );&#10;END getOffendersQueue;&#10;--&#10;PROCEDURE processQueue&#10;IS&#10;    --&#10;    l_unique_offenders_TAB  t_tab_ORGANISATIONS :&#61; t_tab_ORGANISATIONS();&#10;    --&#10;    CURSOR cs IS&#10;      WITH T AS (&#10;        SELECT DISTINCT column_value AS offender_id&#10;        FROM TABLE( g_pending_offenders_TAB) )&#10;      SELECT O.offender_id&#10;      FROM offender O INNER JOIN T ON T.offender_id &#61; O.offender_id;&#10;    --&#10;BEGIN&#10;    --&#10;    IF NVL(g_pending_offenders_TAB.COUNT, 0) &#61; 0 THEN&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    OPEN cs;&#10;    FETCH cs BULK COLLECT INTO l_unique_offenders_TAB;&#10;    CLOSE cs;&#10;    --&#10;    IF l_unique_offenders_TAB IS NULL THEN&#10;        l_unique_offenders_TAB :&#61; t_tab_organisations();&#10;    END IF;&#10;    --&#10;    IF NVL(l_unique_offenders_TAB.COUNT, 0) &#61; 0 THEN&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    IF PKG_Debug.funcgetDebugMode &lt;&gt; &#39;0&#39; AND l_unique_offenders_TAB.COUNT &gt; 0 THEN&#10;        procDebug(SUBSTR(&#39;ALFRESCOSUPPORT.processQueue&#39; ||&#10;            &#39;(off_LST&#61;&#39; || PKG_LstUtl.get_array_2_list(l_unique_offenders_TAB, p_iterator_function&#61;&gt;&#39;PKG_Lookups.funcgetTabRecord(p_table&#61;&gt;&#39;&#39;OFFENDER&#39;&#39;, p_ref_col&#61;&gt;&#39;&#39;offender_id&#39;&#39;, p_ref_val&#61;&gt;:p_offender_id, p_data_fld&#61;&gt;&#39;&#39;&#39;&#39;&#39;&#39;[&#39;&#39;&#39;&#39; || offender_id || &#39;&#39;&#39;&#39;] &#39;&#39;&#39;&#39; || crn&#39;&#39;)&#39;) || &#39;)&#39; || CHR(10) ||&#10;            &#39;(plsql_call_stack&#61;&#39; || DBMS_UTILITY.format_call_stack || &#39;)&#39;,&#10;            1, 30000) );&#10;    END IF;&#10;    --&#10;    FOR l_i IN 1..l_unique_offenders_TAB.COUNT LOOP&#10;        --&#10;        addMessage2Queue(offenderid_in &#61;&gt; l_unique_offenders_TAB(l_i));&#10;        --&#10;        IF SPGConfig.SPGDocsMigrateActive THEN&#10;            --&#10;            BEGIN&#10;                DOCMIGRATIONSUPPORT.add_offender_2_dynamic_q(offender_id_in &#61;&gt; l_unique_offenders_TAB(l_i));&#10;            EXCEPTION WHEN OTHERS THEN&#10;                warn(&#39;[&#39; || l_unique_offenders_TAB(l_i) || &#39;] Error adding to doc migration queue - &#39; || SQLERRM);&#10;            END;&#10;            --&#10;        END IF;&#10;        --&#10;    END LOOP;&#10;    --&#10;    l_unique_offenders_TAB.DELETE;&#10;    g_pending_offenders_TAB.DELETE;&#10;    --&#10;END processQueue;&#10;--&#10;PROCEDURE submitDocResetWIPBatch(p_force_flag VARCHAR2 DEFAULT &#39;N&#39;)&#10;IS&#10;    --&#10;    l_bi_id                NUMBER :&#61; PKG_Lookups.funcGetBusinessInteractionID(&#39;WPBI108&#39;);&#10;    l_sender_identity_id   NUMBER;&#10;    l_receiver_identity_id NUMBER;&#10;    --&#10;    l_batch_interval  NUMBER :&#61; ABS(PKG_Lookups.funcgetNDParameterValue(&#39;DOCUMENT_WIP_BATCH_INTERVAL&#39;, 1));&#10;    l_last_date_run   DATE;&#10;    --&#10;    PROCEDURE do_init IS&#10;    BEGIN&#10;        SELECT /*+ RESULT_CACHE */ probation_area_id INTO l_receiver_identity_id&#10;        FROM probation_area&#10;        WHERE code &#61; &#39;ALF&#39;;&#10;        --&#10;        SELECT /*+ RESULT_CACHE */ probation_area_id INTO l_sender_identity_id&#10;        FROM probation_area&#10;        WHERE code &#61; &#39;N00&#39;;&#10;        --&#10;        SELECT MAX(date_created/*processed_datetime*/) INTO l_last_date_run&#10;        FROM spg_notification&#10;        WHERE 1&#61;1&#10;          AND message_direction &#61; &#39;O&#39;&#10;          AND processed_flag IN ( 1, 4 )&#10;          --AND error_flag &#61; 0&#10;          AND business_interaction_id &#61; l_bi_id&#10;          --AND sender_identity_id &#61; l_sender_identity_id&#10;          --AND receiver_identity_id &#61; l_receiver_identity_id&#10;        ;&#10;        --&#10;        IF l_last_date_run IS NULL THEN&#10;            l_last_date_run :&#61; SYSDATE - l_batch_interval;&#10;        END IF;&#10;        --&#10;    END do_init;&#10;    --&#10;BEGIN&#10;    --&#10;    do_init;&#10;    --&#10;    IF ( p_force_flag &#61; &#39;Y&#39; ) OR&#10;       ( SYSDATE - l_last_date_run &gt;&#61; l_batch_interval )&#10;    THEN&#10;        INSERT INTO spg_notification(&#10;          spg_notification_id,&#10;          business_interaction_id,&#10;          offender_id,&#10;          unique_id,&#10;          date_created,&#10;          sender_identity_id,&#10;          receiver_identity_id&#10;        ) VALUES (&#10;          spg_notification_id_seq.NEXTVAL,&#10;          l_bi_id,&#10;          NULL /*offender_id*/,&#10;          -1 /*unique_id*/,&#10;          SYSDATE,&#10;          l_sender_identity_id,&#10;          l_receiver_identity_id );&#10;    END IF;&#10;    --&#10;END submitDocResetWIPBatch;&#10;--&#10;PROCEDURE createDocResetWIPBatch(p_document_id NUMBER DEFAULT NULL)&#10;IS&#10;    --&#10;    l_user_id              NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;DELIUS_SYSTEM_USER&#39;));&#10;    --&#10;    l_bi_id                NUMBER :&#61; PKG_Lookups.funcGetBusinessInteractionID(&#39;WPBI108&#39;);&#10;    l_sender_identity_id   NUMBER;&#10;    l_receiver_identity_id NUMBER;&#10;    --&#10;    l_expiry_days NUMBER :&#61; ABS(PKG_Lookups.funcgetNDParameterValue(&#39;DOCUMENT_WIP_EXPIRY_DAYS&#39;, 7));&#10;    l_batch_size  NUMBER :&#61; ABS(PKG_Lookups.funcgetNDParameterValue(&#39;DOCUMENT_WIP_BATCH_SIZE&#39;, 10000));&#10;    --&#10;    CURSOR cs IS&#10;      WITH T AS (&#10;        SELECT *&#10;        FROM document D&#10;        WHERE 1&#61;1&#10;          AND ( p_document_id IS NULL OR D.document_id &#61; p_document_id )&#10;          AND work_in_progress &#61; &#39;Y&#39;&#10;          AND work_in_progress_datetime &lt;&#61; SYSDATE - l_expiry_days&#10;          AND NOT EXISTS(&#10;              SELECT 1&#10;              FROM spg_notification&#10;              WHERE 1&#61;1 --spg_notification_id &lt;&gt; p_exclude_spg_not_id&#10;                AND message_direction &#61; &#39;O&#39;&#10;                AND processed_flag IN( 0, 4 )&#10;                AND error_flag &#61; 0&#10;                AND business_interaction_id &#61; l_bi_id&#10;                AND unique_id &#61; D.document_id )&#10;        ORDER BY work_in_progress_datetime DESC, document_id )&#10;      --&#10;      SELECT *&#10;      FROM T;&#10;    --&#10;    TYPE l_tab_TYP IS TABLE OF cs%ROWTYPE;&#10;    l_tab l_tab_TYP;&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    l_lock_name   VARCHAR2(30) :&#61; &#39;ND_DOC_WIP_CLEAR_LOCK&#39;;&#10;    l_lock_handle VARCHAR2(128);&#10;    l_dummy       PLS_INTEGER;&#10;    --&#10;    l_rows_created NUMBER;&#10;    --&#10;    PROCEDURE do_allocate_soft_lock IS&#10;    BEGIN&#10;        DBMS_LOCK.allocate_unique(l_lock_name, l_lock_handle);&#10;        l_dummy :&#61; DBMS_LOCK.request(l_lock_handle, DBMS_LOCK.x_mode, DBMS_LOCK.maxwait, FALSE);&#10;    END do_allocate_soft_lock;&#10;    --&#10;    PROCEDURE do_release_soft_lock IS&#10;    BEGIN&#10;        l_dummy :&#61; DBMS_LOCK.release(l_lock_handle);&#10;    END do_release_soft_lock;&#10;    --&#10;    PROCEDURE do_init IS&#10;    BEGIN&#10;        SELECT /*+ RESULT_CACHE */ probation_area_id INTO l_receiver_identity_id&#10;        FROM probation_area&#10;        WHERE code &#61; &#39;ALF&#39;;&#10;        --&#10;        SELECT /*+ RESULT_CACHE */ probation_area_id INTO l_sender_identity_id&#10;        FROM probation_area&#10;        WHERE code &#61; &#39;N00&#39;;&#10;    END do_init;&#10;    --&#10;BEGIN&#10;    --&#10;    do_allocate_soft_lock;&#10;    --&#10;    do_init;&#10;    --&#10;    OPEN cs;&#10;    FETCH cs BULK COLLECT INTO l_tab LIMIT l_batch_size;&#10;    CLOSE cs;&#10;    --&#10;    FOR l_idx IN 1..l_tab.COUNT LOOP&#10;        --&#10;        l_rec :&#61; l_tab(l_idx);&#10;        --&#10;        INSERT INTO spg_notification(&#10;          spg_notification_id,&#10;          business_interaction_id,&#10;          offender_id,&#10;          unique_id,&#10;          date_created,&#10;          sender_identity_id,&#10;          receiver_identity_id&#10;        ) VALUES (&#10;          spg_notification_id_seq.NEXTVAL,&#10;          l_bi_id,&#10;          l_rec.offender_id,&#10;          l_rec.document_id,&#10;          SYSDATE,&#10;          l_sender_identity_id,&#10;          l_receiver_identity_id );&#10;        --&#10;    END LOOP;&#10;    --&#10;    do_release_soft_lock;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    do_release_soft_lock;&#10;    RAISE;&#10;    --&#10;END createDocResetWIPBatch;&#10;--&#10;PROCEDURE resetDocWIP(&#10;    p_document_id         NUMBER,&#10;    x_api_return          IN OUT VARCHAR2,&#10;    x_api_response_string IN OUT VARCHAR2,&#10;    x_api_return_string   IN OUT VARCHAR2 )&#10;IS&#10;    --&#10;    l_alf_doc_id DOCUMENT.alfresco_document_id%TYPE;&#10;    --&#10;    PROCEDURE do_init IS&#10;    BEGIN&#10;        SELECT alfresco_document_id INTO l_alf_doc_id&#10;        FROM document&#10;        WHERE document_id &#61; p_document_id&#10;          AND work_in_progress &#61; &#39;Y&#39;;&#10;    END do_init;&#10;    --&#10;    PROCEDURE do_reset_wip_flag IS&#10;    BEGIN&#10;        UPDATE document SET&#10;          work_in_progress &#61; &#39;N&#39;,&#10;          published        &#61; NULL --&#39;N&#39;&#10;        WHERE document_id &#61; p_document_id&#10;          AND work_in_progress &#61; &#39;Y&#39;;&#10;    END do_reset_wip_flag;&#10;    --&#10;BEGIN&#10;    --&#10;    do_init;&#10;    --&#10;    IF l_alf_doc_id IS NULL THEN&#10;        do_reset_wip_flag;&#10;    ELSE&#10;        --&#10;        x_api_return :&#61;&#10;            ALFRESCOSUPPORT.processDocument(&#10;                docId_in           &#61;&gt; l_alf_doc_id,&#10;                operation_in       &#61;&gt; &#39;publish&#39;,&#10;                responsestring_out &#61;&gt; x_api_response_string,&#10;                returnString_out   &#61;&gt; x_api_return_string );&#10;        --&#10;        IF x_api_return IN ( &#39;200&#39;, &#39;205&#39; ) THEN&#10;            do_reset_wip_flag;&#10;        ELSIF UPPER(x_api_response_string) LIKE UPPER(&#39;%ORA-%HTTP%error 205%Not Reserved%&#39;) THEN&#10;            x_api_return :&#61; &#39;205&#39;;&#10;            do_reset_wip_flag;&#10;        ELSIF x_api_response_string LIKE &#39;%ORA-29268: HTTP client error 404%&#39; THEN&#10;            -- Not Found&#10;            x_api_return :&#61; &#39;404&#39;;&#10;            do_reset_wip_flag;&#10;        ELSIF x_api_response_string LIKE &#39;%ORA-29269: HTTP server error 503%&#39; THEN&#10;            x_api_return :&#61; &#39;503&#39;;&#10;    --    ELSIF x_api_response_string &#61; &#39;Client Error: ORA-29268: HTTP client error 400 - Bad Request&#39; THEN&#10;    --        x_api_return :&#61; &#39;400&#39;;&#10;            --do_reset_wip_flag;&#10;        END IF;&#10;        --&#10;    END IF;&#10;    --&#10;EXCEPTION WHEN NO_DATA_FOUND THEN&#10;    --&#10;    x_api_return          :&#61; &#39;XYZ&#39;;&#10;    x_api_response_string :&#61; &#39;Failed to locate DOCUMENT record&#39;;&#10;    x_api_return_string   :&#61; &#39;DOCUMENT_ID&#61;&#39; || p_document_id || &#39;, WORK_IN_PROGRESS&#61;Y&#39;;&#10;    --&#10;END resetDocWIP;&#10;--&#10;PROCEDURE sendOffenderPermissionMsg(&#10;    p_offender_id         NUMBER,&#10;    x_api_return          IN OUT VARCHAR2,&#10;    x_api_response_string IN OUT VARCHAR2,&#10;    x_api_return_string   IN OUT VARCHAR2 )&#10;IS&#10;    --&#10;    l_crn OFFENDER.crn%TYPE;&#10;    --&#10;    PROCEDURE do_init IS&#10;    BEGIN&#10;        SELECT crn INTO l_crn&#10;        FROM offender&#10;        WHERE offender_id &#61; p_offender_id;&#10;    END do_init;&#10;    --&#10;BEGIN&#10;    --&#10;    do_init;&#10;    --&#10;    x_api_return :&#61;&#10;        ALFRESCOSUPPORT.assignOffender(&#10;            offenderid_in      &#61;&gt; p_offender_id,&#10;            responsestring_out &#61;&gt; x_api_response_string,&#10;            returnString_out   &#61;&gt; x_api_return_string );&#10;    --&#10;    IF x_api_return &#61; &#39;200&#39; THEN&#10;        NULL;&#10;    ELSIF x_api_response_string LIKE &#39;%HTTP client error 404 - Not Found%&#39; THEN&#10;        x_api_return :&#61; &#39;404&#39;;&#10;    ELSIF x_api_response_string LIKE &#39;%ORA-29269: HTTP server error 503%&#39; THEN&#10;        x_api_return :&#61; &#39;503&#39;;&#10;    END IF;&#10;    --&#10;EXCEPTION WHEN NO_DATA_FOUND THEN&#10;    --&#10;    x_api_return          :&#61; &#39;XYZ&#39;;&#10;    x_api_response_string :&#61; &#39;Failed to locate OFFENDER record&#39;;&#10;    x_api_return_string   :&#61; &#39;OFFENDER_ID&#61;&#39; || p_offender_id;&#10;    --&#10;END sendOffenderPermissionMsg;&#10;&#10;--&#10;--&#10;--&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#10;-- ALFRESCO API Support&#10;--&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#61;&#10;--&#10;FUNCTION clob_to_blob(p_clob IN CLOB)&#10;RETURN BLOB&#10;IS&#10;    --&#10;    l_blob         BLOB;&#10;    l_offset       NUMBER DEFAULT 1;&#10;    l_amount       NUMBER DEFAULT 4096;&#10;    l_offset_write NUMBER DEFAULT 1;&#10;    l_amount_write NUMBER;&#10;    l_buffer       VARCHAR2(4096 CHAR);&#10;    --&#10;BEGIN&#10;    --&#10;    DBMS_LOB.createtemporary(l_blob, TRUE);&#10;    --&#10;    BEGIN&#10;        LOOP&#10;            DBMS_LOB.READ(&#10;                lob_loc &#61;&gt; p_clob,&#10;                amount  &#61;&gt; l_amount,&#10;                offset  &#61;&gt; l_offset,&#10;                buffer  &#61;&gt; l_buffer);&#10;            --&#10;            l_amount_write :&#61; UTL_RAW.length(r &#61;&gt; UTL_RAW.cast_to_raw(c &#61;&gt; l_buffer));&#10;            --&#10;            DBMS_LOB.write(&#10;                lob_loc &#61;&gt; l_blob,&#10;                amount  &#61;&gt; l_amount_write,&#10;                offset  &#61;&gt; l_offset_write,&#10;                buffer  &#61;&gt; UTL_RAW.cast_to_raw(l_buffer) );&#10;            --&#10;            l_offset_write :&#61; l_offset_write + l_amount_write;&#10;            l_offset :&#61; l_offset + l_amount;&#10;            l_amount :&#61; 4096;&#10;        END LOOP;&#10;    EXCEPTION WHEN no_data_found THEN&#10;        NULL;&#10;    END;&#10;    --&#10;    RETURN l_blob;&#10;    --&#10;END clob_to_blob;&#10;--&#10;--&#10;PROCEDURE addPostString(&#10;    x_tab IN OUT table_of_strings_TYP,&#10;    p_str IN     VARCHAR2,&#10;    x_len IN OUT PLS_INTEGER )&#10;IS&#10;BEGIN&#10;    x_tab.EXTEND;&#10;    x_tab(x_tab.LAST) :&#61; TRIM(p_str);&#10;    -- Add 2 because of the carriage return and linefeed at the end of the line&#10;    x_len :&#61; x_len + NVL(LENGTH(TRIM(p_str)),0) + 2;&#10;END addPostString;&#10;--&#10;--&#10;PROCEDURE createPostParameters(&#10;    p_api_params_TAB IN apiParameters,&#10;    p_boundary       IN VARCHAR2,&#10;    p_document_name  IN VARCHAR2,&#10;    p_mime_type      IN VARCHAR2 DEFAULT &#39;application/msword&#39;,&#10;    x_table          OUT table_of_strings_TYP,&#10;    x_length         OUT PLS_INTEGER )&#10;IS&#10;    --&#10;    l_key VARCHAR2(64);&#10;    --&#10;BEGIN&#10;    --&#10;    x_length :&#61; 0;&#10;    l_key :&#61; p_api_params_TAB.FIRST;&#10;    x_table :&#61; table_of_strings_TYP();&#10;    --&#10;    WHILE l_key IS NOT NULL LOOP&#10;        addPostString(x_table, &#39;--&#39; || p_boundary, x_length);&#10;        IF l_key &#61; &#39;filedata&#39; THEN&#10;            addPostString(x_table, &#39;Content-Type: &#39; || p_mime_type || &#39;; name&#61;&#39; || p_document_name, x_length);&#10;            addPostString(x_table, &#39;Content-Transfer-Encoding: binary&#39;, x_length);&#10;            addPostString(x_table, &#39;Content-Disposition: form-data; name&#61;&quot;filedata&quot;; filename&#61;&quot;&#39; || p_document_name || &#39;&quot;&#39;, x_length);&#10;        ELSE&#10;            addPostString(x_table, &#39;Content-Type: text/plain; charset&#61;UTF-8&#39;, x_length);&#10;            addPostString(x_table, &#39;Content-Transfer-Encoding: 7bit&#39;, x_length);&#10;            addPostString(x_table, &#39;Content-Disposition: form-data; name&#61;&quot;&#39; || l_key || &#39;&quot;&#39;, x_length);&#10;        END IF;&#10;        --&#10;        addPostString(x_table, NULL, x_length);&#10;        addPostString(x_table, p_api_params_TAB(l_key), x_length);&#10;        --&#10;        l_key :&#61; p_api_params_TAB.NEXT(l_key);&#10;        --&#10;    END LOOP;&#10;    --&#10;    addPostString(x_table, &#39;--&#39; || p_boundary || &#39;--&#39;, x_length);&#10;    --&#10;    FOR l_i IN 1..x_table.LAST LOOP&#10;        info(NVL(x_table(l_i), &#39;NULL&#39;));&#10;    END LOOP;&#10;    --&#10;END createPostParameters;&#10;--&#10;--&#10;PROCEDURE writeBlobToHttp(x_req IN OUT UTL_HTTP.req, p_blob IN BLOB)&#10;IS&#10;    --&#10;    l_i PLS_INTEGER;&#10;    --&#10;BEGIN&#10;    l_i :&#61; 1;&#10;    WHILE l_i &lt;&#61; LENGTH(p_blob) LOOP&#10;        UTL_HTTP.write_raw(x_req, DBMS_LOB.substr(p_blob, 32767, l_i));&#10;        l_i :&#61; l_i + 32767;&#10;    END LOOP;&#10;END writeBlobToHttp;&#10;--&#10;--&#10;FUNCTION constructRequest(&#10;    p_url    VARCHAR2,&#10;    p_method VARCHAR2,&#10;    p_user   VARCHAR2 DEFAULT NULL )&#10;RETURN UTL_HTTP.req IS&#10;    --&#10;    l_req  UTL_HTTP.req;&#10;    l_user VARCHAR2(100);&#10;    --&#10;BEGIN&#10;    --&#10;    l_user :&#61; NVL(p_user, SPGConfig.get_alfresco_user);&#10;    --&#10;    info(&#39;p_url &#61;&gt; &#39;    || p_url);&#10;    info(&#39;p_method &#61;&gt; &#39; || p_method);&#10;    info(&#39;p_user &#61;&gt; &#39;   || l_user);&#10;    --&#10;    UTL_HTTP.set_response_error_check(ENABLE &#61;&gt; TRUE);&#10;    UTL_HTTP.set_detailed_excp_support(ENABLE &#61;&gt; TRUE);&#10;    --&#10;    l_req :&#61; UTL_HTTP.begin_request(p_url, p_method, UTL_HTTP.http_version_1_1);&#10;    --&#10;    UTL_HTTP.set_header(l_req, &#39;User_Agent&#39;, &#39;Mozilla/4.0&#39;);&#10;    UTL_HTTP.set_header(l_req, &#39;X-DocRepository-Real-Remote-User&#39;, &#39;nDelius&#39;);&#10;    UTL_HTTP.set_header(l_req, &#39;X-DocRepository-Remote-User&#39;, l_user);&#10;    --&#10;    RETURN l_req;&#10;    --&#10;END constructRequest;&#10;--&#10;FUNCTION Perform_Request(&#10;    x_req             IN OUT UTL_HTTP.req,&#10;    x_response_string OUT    VARCHAR2,&#10;    x_return_string   OUT    CLOB )&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_resp          UTL_HTTP.resp;&#10;    l_buf           VARCHAR2(32767) :&#61; NULL;&#10;    l_buffer_size   NUMBER(10) :&#61; 512;&#10;    l_raw_data      RAW(512);&#10;    l_clob_response CLOB;&#10;    l_ret           VARCHAR2(10);&#10;    l_name          VARCHAR2(4000);&#10;    l_value         VARCHAR2(1023);&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    UTL_HTTP.set_transfer_timeout(300);&#10;    --&#10;    UTL_HTTP.set_response_error_check(enable &#61;&gt; FALSE);&#10;    g_label :&#61; &#39;019005&#39;;&#10;    l_resp :&#61; UTL_HTTP.get_response(x_req);&#10;    -- process the response from the HTTP call&#10;    g_label :&#61; &#39;019010&#39;;&#10;    l_ret :&#61; l_resp.status_code;&#10;    info(&#39;Status code: &#39; || l_resp.status_code);&#10;    info(&#39;Reason phrase: &#39; || l_resp.reason_phrase);&#10;    --&#10;    g_label :&#61; &#39;019015&#39;;&#10;    l_buf :&#61; l_buf || &#39;Status Code [&#39; || l_resp.status_code || &#39;]  Status Phrase [&#39; ||  l_resp.reason_phrase || &#39;]&#39; || CHR(10);&#10;    FOR l_i IN 1..UTL_HTTP.get_header_count(r&#61;&gt;l_resp)&#10;    LOOP&#10;        g_label :&#61; &#39;019020&#39;;&#10;        UTL_HTTP.get_header(r&#61;&gt;l_resp, n&#61;&gt;l_i, name&#61;&gt;l_name, value&#61;&gt;l_value);&#10;        l_buf :&#61; l_buf || l_name || &#39;: &#39; || l_value || CHR(10);&#10;    END LOOP;&#10;    g_label :&#61; &#39;019025&#39;;&#10;    x_response_string :&#61; l_buf;&#10;    --&#10;    g_label :&#61; &#39;019030&#39;;&#10;    BEGIN&#10;        LOOP&#10;            g_label :&#61; &#39;019035&#39;;&#10;            UTL_HTTP.read_raw(l_resp, l_raw_data, l_buffer_size);&#10;            l_clob_response :&#61; l_clob_response || UTL_RAW.cast_to_varchar2(l_raw_data);&#10;        END LOOP;&#10;    EXCEPTION WHEN UTL_HTTP.end_of_body THEN&#10;        NULL;&#10;    END;&#10;    --&#10;    x_return_string :&#61; l_clob_response;&#10;    g_label :&#61; &#39;019040&#39;;&#10;    clean_up;&#10;    --&#10;    RETURN l_ret;&#10;EXCEPTION&#10;    WHEN UTL_HTTP.request_failed THEN&#10;        x_response_string :&#61; &#39;Request Failed: &#39; || UTL_HTTP.get_detailed_sqlerrm;&#10;        error(x_response_string);&#10;        clean_up;&#10;        RETURN l_ret;&#10;    WHEN UTL_HTTP.http_server_error THEN&#10;        x_response_string :&#61; &#39;Server Error: &#39; || UTL_HTTP.get_detailed_sqlerrm;&#10;        error(x_response_string);&#10;        clean_up;&#10;        RETURN l_ret;&#10;    WHEN UTL_HTTP.http_client_error THEN&#10;        x_response_string:&#61; &#39;Client Error: &#39; || UTL_HTTP.get_detailed_sqlerrm;&#10;        error(x_response_string);&#10;        clean_up;&#10;        RETURN l_ret;&#10;    WHEN OTHERS THEN&#10;        x_return_string :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;        error(&#39;fetchDocument Error: &#39; || x_return_string);&#10;        clean_up;&#10;        --&#10;        RETURN &#39;500&#39;;&#10;END Perform_Request;&#10;--&#10;--&#10;FUNCTION createGetParameters(p_api_params_TAB IN apiParameters) RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_concatenated_params VARCHAR2(32767);&#10;    l_param_string        VARCHAR2(32767);&#10;    l_key                 VARCHAR2(64);&#10;    --&#10;BEGIN&#10;    --&#10;    l_key :&#61; p_api_params_TAB.FIRST;&#10;    --&#10;    WHILE l_key IS NOT NULL LOOP&#10;        --&#10;        IF l_concatenated_params IS NOT NULL THEN&#10;             l_concatenated_params :&#61; l_concatenated_params;&#10;        END IF;&#10;        --&#10;        l_param_string :&#61; /*l_key ||*/ p_api_params_TAB(l_key);&#10;        l_concatenated_params :&#61; l_concatenated_params || UTL_URL.escape(l_param_string);&#10;        --&#10;        l_key :&#61; p_api_params_TAB.NEXT(l_key);&#10;        --&#10;    END LOOP;&#10;    --&#10;    RETURN l_concatenated_params;&#10;END createGetParameters;&#10;--&#10;--&#10;FUNCTION fetchDocument(&#10;    docId_in           IN VARCHAR2,&#10;    responseString_out OUT VARCHAR2,&#10;    document_out       OUT BLOB,&#10;    reserveFlag_in     IN VARCHAR2 DEFAULT &#39;N&#39; )&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_api_params_TAB apiParameters;&#10;    --&#10;    l_url  VARCHAR2(32767);&#10;    l_req  UTL_HTTP.req;&#10;    l_resp UTL_HTTP.resp;&#10;    l_ret  VARCHAR2(200);&#10;    l_buf  CLOB; --VARCHAR2(32767) :&#61; NULL;&#10;    --&#10;    l_name      VARCHAR2(256);&#10;    l_value     VARCHAR2(1024);&#10;    l_temp_blob BLOB;&#10;    l_raw_buf   RAW(32767);&#10;    l_method    VARCHAR2(10);&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;             UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    g_label :&#61; &#39;600000&#39;;&#10;    -- set up resource url and parameters&#10;    IF reserveFlag_in &#61; &#39;Y&#39; THEN&#10;        l_api_params_TAB(&#39;1resource&#39;) :&#61; &#39;/fetchandreserve/&#39;;&#10;        l_method :&#61; &#39;POST&#39;;&#10;    ELSE&#10;        l_api_params_TAB(&#39;1resource&#39;) :&#61; &#39;/fetch/&#39;;&#10;        l_method :&#61; &#39;GET&#39;;&#10;    END IF;&#10;    --&#10;    l_api_params_TAB(&#39;docId&#39;) :&#61; docId_in;&#10;    l_url :&#61; SPGCONFIG.get_alfresco_url || createGetParameters(l_api_params_TAB);&#10;    l_req :&#61; constructRequest(l_url, l_method);&#10;    -- process response&#10;    l_resp :&#61; UTL_HTTP.get_response(l_req);&#10;    -- process the response from the HTTP call&#10;    g_label :&#61; &#39;019010&#39;;&#10;    l_ret :&#61; l_resp.status_code;&#10;    info(&#39;Status code: &#39; || l_resp.status_code);&#10;    info(&#39;Reason phrase: &#39; || l_resp.reason_phrase);&#10;    --&#10;    g_label :&#61; &#39;019015&#39;;&#10;    FOR l_i IN 1..UTL_HTTP.get_header_count(r&#61;&gt;l_resp) LOOP&#10;        g_label :&#61; &#39;019020&#39;;&#10;        UTL_HTTP.get_header(r&#61;&gt;l_resp, n&#61;&gt;l_i, name&#61;&gt;l_name, value&#61;&gt;l_value);&#10;        l_buf :&#61; l_buf || l_name || &#39;: &#39; || l_value || CHR(10);&#10;    END LOOP;&#10;    g_label :&#61; &#39;019025&#39;;&#10;    responseString_out :&#61; DBMS_LOB.SUBSTR(l_buf, 32767);&#10;    --&#10;    g_label :&#61; &#39;019030&#39;;&#10;    IF l_ret &#61; &#39;200&#39; THEN&#10;        -- process blob&#10;        DBMS_LOB.createtemporary(l_temp_blob, TRUE);&#10;        --&#10;        BEGIN&#10;            LOOP&#10;                g_label :&#61; &#39;019035&#39;;&#10;                UTL_HTTP.read_raw(l_resp, l_raw_buf);&#10;                DBMS_LOB.append(l_temp_blob, l_raw_buf);&#10;            END LOOP;&#10;        EXCEPTION WHEN UTL_HTTP.end_of_body THEN&#10;            NULL;&#10;        END;&#10;        --&#10;        document_out :&#61; l_temp_blob;&#10;        --&#10;        DBMS_LOB.freetemporary(l_temp_blob);&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;019040&#39;;&#10;    clean_up;&#10;    --&#10;    RETURN l_ret;&#10;    --&#10;EXCEPTION&#10;    WHEN UTL_HTTP.request_failed THEN&#10;        responseString_out :&#61; &#39;Request Failed: &#39; || UTL_HTTP.get_detailed_sqlerrm;&#10;        error(responseString_out);&#10;        clean_up;&#10;        RETURN l_ret;&#10;    WHEN UTL_HTTP.http_server_error THEN&#10;        responseString_out :&#61; &#39;Server Error: &#39; || UTL_HTTP.get_detailed_sqlerrm;&#10;        error(responseString_out);&#10;        clean_up;&#10;        RETURN l_ret;&#10;    WHEN UTL_HTTP.http_client_error THEN&#10;        responseString_out :&#61; &#39;Client Error: &#39; || UTL_HTTP.get_detailed_sqlerrm;&#10;        error(responseString_out);&#10;        clean_up;&#10;        RETURN l_ret;&#10;    WHEN OTHERS THEN&#10;        responseString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;        error(&#39;fetchDocument Error: &#39; || responseString_out);&#10;        clean_up;&#10;        --&#10;        RETURN &#39;500&#39;;&#10;END fetchDocument;&#10;--&#10;--&#10;FUNCTION assignOffender(&#10;    offenderid_in       IN NUMBER,&#10;    responsestring_out  OUT VARCHAR2,&#10;    returnString_out    OUT VARCHAR2,&#10;    noAccessFlag_in     IN VARCHAR2 DEFAULT &#39;N&#39;)&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_api_params_TAB apiParameters;&#10;    --&#10;    l_url     VARCHAR2(32767);&#10;    l_req     UTL_HTTP.req;&#10;    l_resp    UTL_HTTP.resp;&#10;    l_ret     VARCHAR2(200);&#10;    l_process VARCHAR2(200);&#10;    l_method  VARCHAR2(200);&#10;    l_crn     OFFENDER.crn%TYPE;&#10;    l_areas   VARCHAR2(500);&#10;    --&#10;    --l_json            JSON_OBJECT_T :&#61; JSON_OBJECT_T(); --json;&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    g_label :&#61; &#39;750000&#39;;&#10;    --&#10;    g_label :&#61; &#39;750005&#39;;&#10;    SELECT crn INTO l_crn&#10;    FROM offender&#10;    WHERE offender_id &#61; offenderid_in;&#10;    --&#10;    g_label :&#61; &#39;750010&#39;;&#10;    SELECT &#39;{&quot;PROVIDERS&quot; : [&#39; || LISTAGG(&#39;{&quot;&#39; || area_code || &#39;&quot;:&quot;&#39; || alfresco_value || &#39;&quot;}&#39;, &#39;,&#39;) WITHIN GROUP (ORDER BY 1) || &#39;]}&#39;&#10;    INTO l_areas&#10;    FROM&#10;      TABLE( ALFRESCOSUPPORT.get_alfresco_permissions(&#10;                 offenderid_in   &#61;&gt; offenderid_in,&#10;                 noAccessFlag_in &#61;&gt; noAccessFlag_in ) );&#10;    --&#10;    -- set up resource url and parameters&#10;    g_label :&#61; &#39;750020&#39;;&#10;    l_api_params_TAB(&#39;1resource&#39;) :&#61; &#39;/assignoffender/&#39;;&#10;    g_label :&#61; &#39;750030&#39;;&#10;    l_api_params_TAB(&#39;crn&#39;) :&#61; l_crn;&#10;    g_label :&#61; &#39;750040&#39;;&#10;    l_url :&#61; get_alf_url(GC_ALF_ASSIGN_OFFENDER) || createGetParameters(l_api_params_TAB);&#10;    info(&#39;url &#61;&gt; &#39; || l_url);&#10;    g_label :&#61; &#39;750050&#39;;&#10;    l_req :&#61; constructRequest(l_url, &#39;POST&#39;);&#10;    -- process response&#10;    g_label :&#61; &#39;750060&#39;;&#10;    UTL_HTTP.set_header(l_req, &#39;Content-Type&#39;, &#39;application/json; charset&#61;UTF8&#39;);&#10;    UTL_HTTP.set_header(l_req, &#39;Transfer-Encoding&#39;, &#39;chunked&#39;);&#10;    UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;    UTL_HTTP.write_raw(l_req, UTL_RAW.cast_to_raw(l_areas));&#10;    UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;    --&#10;    -- process response&#10;    g_label :&#61; &#39;750070&#39;;&#10;    l_ret :&#61; Perform_Request(l_req, responseString_out, returnString_out);&#10;    --&#10;    g_label :&#61; &#39;750080&#39;;&#10;    clean_up;&#10;    --&#10;    info(&#39;responsestring_out &#61;&gt; &#39; || responsestring_out);&#10;    RETURN l_ret;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    returnString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;    responseString_out :&#61; PKG_LstUtl.concat(responseString_out, l_url, &#39;DocumentID&#61;&#39; || &#39;offenderID&#61;&#39; || offenderid_in, p_delim&#61;&gt;CHR(10));&#10;    error(&#39;assignOffender Error: &#39; || PKG_LstUtl.concat(returnString_out, responseString_out, p_delim&#61;&gt;CHR(10)));&#10;    clean_up;&#10;    --&#10;    RETURN &#39;500&#39;;&#10;END assignOffender;&#10;--&#10;--&#10;FUNCTION processDocument(&#10;    docId_in           IN VARCHAR2,&#10;    operation_in       IN VARCHAR2,&#10;    responseString_out IN OUT VARCHAR2,&#10;    returnString_out   IN OUT VARCHAR2)&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_api_params_TAB apiParameters;&#10;    --&#10;    l_url     VARCHAR2(32767);&#10;    l_req     UTL_HTTP.req;&#10;    l_resp    UTL_HTTP.resp;&#10;    l_ret     VARCHAR2(200);&#10;    l_process VARCHAR2(200);&#10;    l_method  VARCHAR2(200);&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    g_label :&#61; &#39;600000&#39;;&#10;    -- set up resource l_url and parameters&#10;    l_process :&#61;  CASE LOWER(operation_in)&#10;                      WHEN &#39;lock&#39;    THEN &#39;/lock/&#39;&#10;                      WHEN &#39;release&#39; THEN &#39;/release/&#39;&#10;                      WHEN &#39;publish&#39; THEN &#39;/publish/&#39;&#10;                      WHEN &#39;delete&#39;  THEN &#39;/delete/&#39;&#10;                      WHEN &#39;declare&#39; THEN &#39;/declareasrecord/&#39;&#10;                  END;&#10;    --&#10;    l_method :&#61; CASE LOWER(operation_in)&#10;                    WHEN &#39;delete&#39;  THEN &#39;DELETE&#39;&#10;                    WHEN &#39;declare&#39; THEN &#39;POST&#39;&#10;                    ELSE                &#39;PUT&#39;&#10;                END;&#10;    l_api_params_TAB(&#39;1resource&#39;) :&#61; l_process;&#10;    l_api_params_TAB(&#39;docId&#39;) :&#61; docId_in;&#10;    l_url :&#61; SPGCONFIG.get_alfresco_url || createGetParameters(l_api_params_TAB);&#10;    l_req :&#61; constructRequest(l_url, l_method);&#10;    -- process response&#10;    g_label :&#61; &#39;700170&#39;;&#10;    l_ret :&#61; Perform_Request(l_req, responseString_out, returnString_out);&#10;    --&#10;    IF NVL(l_ret, &#39;XYZ&#39;) NOT IN (&#39;200&#39;) THEN&#10;        responseString_out :&#61; PKG_LstUtl.concat(responseString_out, &#39;URL&#61;&#39; || l_url, &#39;docID&#61;&#39; || docId_in, p_delim&#61;&gt;CHR(10));&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700180&#39;;&#10;    clean_up;&#10;    RETURN l_ret;&#10;EXCEPTION WHEN OTHERS THEN&#10;    returnString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;    responseString_out :&#61; PKG_LstUtl.concat(responseString_out, l_url, &#39;DocumentID&#61;&#39; || &#39;docID&#61;&#39; || docId_in, p_delim&#61;&gt;CHR(10));&#10;    error(&#39;processDocument Error: &#39; || PKG_LstUtl.concat(returnString_out, responseString_out, p_delim&#61;&gt;CHR(10)));&#10;    clean_up;&#10;    --&#10;    RETURN &#39;500&#39;;&#10;END processDocument;&#10;--&#10;--&#10;FUNCTION searchAlfresco(&#10;    offenderID_in      IN NUMBER,&#10;    responseString_out OUT VARCHAR2,&#10;    returnString_out   OUT CLOB,&#10;    crn_in             IN VARCHAR2 DEFAULT NULL )&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_api_params_TAB apiParameters;&#10;    --&#10;    l_url     VARCHAR2(32767);&#10;    l_req     UTL_HTTP.req;&#10;    l_resp    UTL_HTTP.resp;&#10;    l_ret     VARCHAR2(200);&#10;    l_process VARCHAR2(200);&#10;    l_method  VARCHAR2(200);&#10;    l_crn     OFFENDER.crn%TYPE;&#10;    --&#10;    l_return_string CLOB;&#10;    --&#10;    l_temp_blob BLOB;&#10;    l_raw_buf   RAW(32767);&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    --&#10;    g_label :&#61; &#39;600005&#39;;&#10;    --&#10;    IF crn_in IS NOT NULL THEN&#10;        l_crn :&#61; crn_in;&#10;    ELSE&#10;        SELECT crn INTO l_crn&#10;        FROM offender&#10;        WHERE offender_id &#61; offenderID_in;&#10;    END IF;&#10;    --&#10;    l_url :&#61; get_alf_url(GC_ALF_SEARCH) || &#39;/search/&#39; || l_crn;&#10;    --DBMS_OUTPUT.put_line(&#39;ALF URL&#61;&#39; || l_url);&#10;    --&#10;    l_req :&#61; constructRequest(l_url, l_method);&#10;    -- process response&#10;    g_label :&#61; &#39;700170&#39;;&#10;    l_ret :&#61; Perform_Request(l_req, responseString_out, returnString_out);&#10;    --&#10;    g_label :&#61; &#39;700180&#39;;&#10;    clean_up;&#10;    RETURN l_ret;&#10;EXCEPTION WHEN OTHERS THEN&#10;        returnString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;        error(&#39;searchAlfresco Error: &#39; || returnString_out);&#10;        clean_up;&#10;        --&#10;        RETURN &#39;500&#39;;&#10;END searchAlfresco;&#10;--&#10;--&#10;FUNCTION row_soft_deleted(&#10;    p_table_name  DOCUMENT.table_name%TYPE,&#10;    p_primary_key DOCUMENT.primary_key_id%TYPE)&#10;RETURN VARCHAR2 /* RESULT_CACHE*/&#10;IS&#10;    --&#10;    l_ret                 VARCHAR2(1);&#10;    l_SQL                 VARCHAR2(1000);&#10;    l_primary_key_column  VARCHAR2(30);&#10;    l_soft_deleted        NUMBER;&#10;    l_table_name          VARCHAR2(30);&#10;    --&#10;BEGIN&#10;    --&#10;    -- &#39;ADDRESSASSESSMENT&#39;,&#10;    -- &#39;ASSESSMENT&#39;,&#10;    -- &#39;APPROVED_PREMISES_REFERRAL&#39;,&#10;    -- &#39;CASE_ALLOCATION&#39;,&#10;    -- &#39;CONTACT&#39;,&#10;    -- &#39;COURT_REPORT&#39;,&#10;    -- &#39;EVENT&#39;,&#10;    -- &#39;INSTITUTIONAL_REPORT&#39;,&#10;    -- &#39;NSI&#39;,&#10;    -- &#39;OFFENDER&#39;,&#10;    -- &#39;PERSONALCONTACT&#39;,&#10;    -- &#39;PERSONAL_CIRCUMSTANCE&#39;,&#10;    -- &#39;REFERRAL&#39;,&#10;    -- &#39;UPW_APPOINTMENT&#39;&#10;    l_table_name :&#61; LOWER(p_table_name);&#10;    IF l_table_name &#61; &#39;personalcontact&#39; THEN&#10;        l_table_name :&#61; &#39;personal_contact&#39;;&#10;    ELSIF l_table_name &#61; &#39;addressassessment&#39; THEN&#10;        l_table_name :&#61; &#39;address_assessment&#39;;&#10;    END IF;&#10;    --&#10;    l_primary_key_column :&#61; PKG_Lookups.funcGetTabPkFields(p_table_name&#61;&gt; l_table_name);&#10;    --&#10;    l_SQL :&#61;&#10;       &#39;SELECT&#10;          &#39; || CASE WHEN l_table_name &#61; &#39;case_allocation&#39; THEN &#39;0 &#39; ELSE &#39;soft_deleted &#39; END || &#39;&#10;        FROM &#39; || l_table_name || &#39;&#10;        WHERE &#39; || l_primary_key_column || &#39; &#61; :primary_key&#39;;&#10;    --&#10;    BEGIN&#10;        EXECUTE IMMEDIATE l_SQL INTO l_soft_deleted USING p_primary_key;&#10;    EXCEPTION&#10;        WHEN NO_DATA_FOUND THEN&#10;            l_soft_deleted :&#61; 2;&#10;        WHEN OTHERS THEN&#10;            raise_application_error(-20001, &#39;ERROR in ALFRESCOSUPPORT.row_soft_deleted(&#39; || l_table_name || &#39;, &#39; || p_primary_key || &#39;): &#39; || SQLERRM);&#10;    END;&#10;    --&#10;    l_ret :&#61;  CASE&#10;                  WHEN l_soft_deleted &#61; 1 THEN &#39;Y&#39;&#10;                  WHEN l_soft_deleted &#61; 2 THEN &#39;D&#39;&#10;                  ELSE &#39;N&#39;&#10;              END;&#10;    --&#10;    RETURN l_ret;&#10;END row_soft_deleted;&#10;--&#10;--&#10;FUNCTION getDocumentMetaData(&#10;    p_entity_type VARCHAR2,&#10;    p_entity_id   NUMBER)&#10;RETURN meta_data_rec_TYP&#10;IS&#10;    --&#10;    l_meta_data_rec       meta_data_rec_TYP;&#10;    l_SQL                 VARCHAR2(4000);&#10;    l_corrected_file_name DOCUMENT.document_name%TYPE;&#10;    --&#10;BEGIN&#10;    --&#10;    IF p_entity_type &#61; &#39;DOCUMENT&#39; THEN&#10;      l_SQL :&#61;&#10;         &#39;SELECT&#10;            o.crn,&#10;            d.last_updated_user_id,&#10;            DOCMIGRATIONSUPPORT.getProbationArea(d.last_updated_user_id) AS probation_area_id,&#10;            PKG_LOOKUPS.getUserName(d.last_updated_user_id)              AS author,&#10;            CASE d.table_name&#10;                WHEN &#39;&#39;ADDRESS_ASSESSMENT&#39;&#39; THEN &#39;&#39;ADDRESSASSESSMENT&#39;&#39;&#10;                WHEN &#39;&#39;APPROVED_PREMISES_REFERRAL&#39;&#39; THEN &#39;&#39;APREFERRAL&#39;&#39;&#10;                WHEN &#39;&#39;COURT_REPORT&#39;&#39; THEN &#39;&#39;COURTREPORT&#39;&#39;&#10;                WHEN &#39;&#39;INSTITUTIONAL_REPORT&#39;&#39; THEN &#39;&#39;INSTITUTIONALREPORT&#39;&#39;&#10;                WHEN &#39;&#39;PERSONAL_CIRCUMSTANCE&#39;&#39; THEN &#39;&#39;PERSONALCIRCUMSTANCE&#39;&#39;&#10;                WHEN &#39;&#39;PERSONAL_CONTACT&#39;&#39; THEN &#39;&#39;PERSONALCONTACT&#39;&#39;&#10;                WHEN &#39;&#39;NSI&#39;&#39; THEN &#39;&#39;PROCESSCONTACT&#39;&#39;&#10;                ELSE d.table_name&#10;            END                                                          AS entityType,&#10;            d.primary_key_id                                             AS entityId,&#10;            &#39;&#39;DOCUMENT&#39;&#39;                                                 AS docType,&#10;            d.document_name                                              AS fileName,&#10;            document filedata,&#10;            d.alfresco_document_id,&#10;            d.document_id                                                AS sourceTableKey,&#10;            CASE d.status&#10;                WHEN &#39;&#39;Y&#39;&#39; THEN &#39;&#39;Y&#39;&#39;&#10;                ELSE &#39;&#39;N&#39;&#39;&#10;            END                                                          AS locked,&#10;            CASE d.work_in_progress&#10;                WHEN &#39;&#39;Y&#39;&#39; THEN &#39;&#39;Y&#39;&#39;&#10;                ELSE &#39;&#39;N&#39;&#39;&#10;            END                                                          AS reserved,&#10;            CASE d.soft_deleted&#10;                WHEN 0 THEN &#39;&#39;N&#39;&#39;&#10;                ELSE &#39;&#39;Y&#39;&#39;&#10;            END                                                          AS deleted,&#10;            ALFRESCOSUPPORT.row_soft_deleted(table_name, primary_key_id) AS row_soft_deleted&#10;          FROM&#10;            document d&#10;              INNER JOIN offender o ON d.offender_id &#61; o.offender_id&#10;          WHERE d.document_id &#61; :p_entity_id&#39;;&#10;        --&#10;    ELSIF p_entity_type &#61; &#39;OFFENDER&#39; THEN&#10;        l_SQL :&#61;&#10;           &#39;SELECT&#10;              crn,&#10;              last_updated_user_id,&#10;              DOCMIGRATIONSUPPORT.getProbationArea(last_updated_user_id)  AS probation_area_id,&#10;              PKG_LOOKUPS.getusername(last_updated_user_id)               AS author,&#10;              &#39;&#39;OFFENDER&#39;&#39;                                                AS entityType,&#10;              offender_id                                                 AS entityID,&#10;              &#39;&#39;PREVIOUS_CONVICTION&#39;&#39;                                     AS docType,&#10;              prev_conviction_document_name                               AS filename,&#10;              previous_conviction_document                                AS filedata,&#10;              prev_con_alfresco_document_id                               AS alfresco_document_id,&#10;              offender_id                                                 AS sourceTableKey,&#10;              &#39;&#39;N&#39;&#39;                                                       AS locked,&#10;              &#39;&#39;N&#39;&#39;                                                       AS reserved,&#10;              &#39;&#39;N&#39;&#39;                                                       AS deleted,&#10;              ALFRESCOSUPPORT.row_soft_deleted(&#39;&#39;OFFENDER&#39;&#39;, offender_id) AS row_soft_deleted&#10;            FROM offender&#10;            WHERE offender.offender_id &#61; :p_entity_id&#39;;&#10;    ELSE&#10;        l_SQL :&#61;&#10;           &#39;SELECT&#10;              offender.crn,&#10;              event.last_updated_user_id,&#10;              DOCMIGRATIONSUPPORT.getProbationArea(event.last_updated_user_id) AS probation_area_id,&#10;              PKG_LOOKUPS.getusername(event.last_updated_user_id)              AS author,&#10;              &#39;&#39;EVENT&#39;&#39;                                                        AS entityType,&#10;              event.event_id                                                   AS entityID,&#10;              &#39;&#39;CPS_PACK&#39;&#39;                                                     AS docType,&#10;              cps_document_name                                                AS filename,&#10;              cps_document                                                     AS filedata,&#10;              event.cps_alfresco_document_id                                   AS alfresco_document_id,&#10;              event_id                                                         AS sourceTableKey,&#10;              &#39;&#39;N&#39;&#39;                                                            AS locked,&#10;              &#39;&#39;N&#39;&#39;                                                            AS reserved,&#10;              &#39;&#39;N&#39;&#39;                                                            AS deleted,&#10;              ALFRESCOSUPPORT.row_soft_deleted(&#39;&#39;EVENT&#39;&#39;, event_id)            AS row_soft_deleted&#10;            FROM&#10;              event&#10;                INNER JOIN offender ON event.offender_id &#61; offender.offender_id&#10;            WHERE event.event_id &#61; :p_entity_id&#39;;&#10;        --&#10;    END IF;&#10;    --&#10;    EXECUTE IMMEDIATE l_SQL INTO l_meta_data_rec USING p_entity_id;&#10;    --&#10;    l_corrected_file_name :&#61; TRIM(&#10;                                  REGEXP_REPLACE(  REGEXP_REPLACE(  REGEXP_REPLACE(  REGEXP_REPLACE( l_meta_data_rec.filename, &#39;^(nul|prn|con|lpt[0-9]|com[0-9])&#39;, NULL),&#10;                                                                                  &#39;[|*?\&lt;&gt;$&quot;/%]&#39;,&#10;                                                                                  NULL&#10;                                                                                ),&#10;                                                                  &#39;[:]&#39;,&#10;                                                                  &#39;-&#39;&#10;                                                                ),&#10;                                                  &#39;^\.&#39;,&#10;                                                  NULL&#10;                                                )&#10;                                );&#10;    --&#10;    IF l_corrected_file_name !&#61; l_meta_data_rec.filename THEN&#10;       info(&#39;Document Name Corrected [Old: &#39; || l_meta_data_rec.filename || &#39;][New: &#39; || l_corrected_file_name || &#39;]&#39;);&#10;       l_meta_data_rec.filename :&#61; l_corrected_file_name;&#10;    END IF;&#10;    --&#10;    RETURN l_meta_data_rec;&#10;    --&#10;END getDocumentMetaData;&#10;--&#10;--&#10;PROCEDURE setDocumentMetadata(p_meta_data_rec IN meta_data_rec_TYP)&#10;IS&#10;    --&#10;    l_SQL   CLOB;&#10;    --&#10;BEGIN&#10;    IF p_meta_data_rec.docType &#61; &#39;DOCUMENT&#39; THEN&#10;        l_SQL :&#61; &#39;UPDATE document SET&#10;                    alfresco_document_id        &#61; :1,&#10;                    last_updated_user_id        &#61; :2,&#10;                    last_upd_author_provider_id &#61; :3,&#10;                    created_provider_id         &#61; :4,&#10;                    created_by_user_id          &#61; :5,&#10;                    created_datetime            &#61; :6,&#10;                    document_name               &#61; :7&#10;                  WHERE document_id &#61; :8&#39;;&#10;    ELSIF p_meta_data_rec.docType &#61; &#39;PREVIOUS_CONVICTION&#39; THEN&#10;        l_SQL :&#61; &#39;UPDATE offender SET&#10;                     prev_con_alfresco_document_id   &#61; :1,&#10;                      prev_con_last_updated_user_id  &#61; :2,&#10;                      prev_con_last_upd_auth_prov_id &#61; :3,&#10;                      prev_con_created_provider_id   &#61; :4,&#10;                      prev_con_created_by_user_id    &#61; :5,&#10;                      prev_con_created_datetime      &#61; :6,&#10;                      prev_conviction_document_name  &#61; :7&#10;                  WHERE offender_id &#61; :8&#39;;&#10;    ELSE&#10;        l_SQL :&#61; &#39;UPDATE event SET&#10;                    cps_alfresco_document_id      &#61; :1,&#10;                    cps_last_updated_user_id      &#61; :2,&#10;                    cps_last_updated_auth_prov_id &#61; :3,&#10;                    cps_created_provider_id       &#61; :4,&#10;                    cps_created_by_user_id        &#61; :5,&#10;                    cps_created_datetime          &#61; :6,&#10;                    cps_document_name             &#61; :7&#10;                  WHERE event_id &#61; :8&#39;;&#10;    END IF;&#10;    --&#10;    info(l_SQL);&#10;    info (&#39;:1 &#61;&gt; &#39; || p_meta_data_rec.alfrescoID);&#10;    info (&#39;:2 &#61;&gt; &#39; || p_meta_data_rec.last_updated_user_id);&#10;    info (&#39;:3 &#61;&gt; &#39; || p_meta_data_rec.probation_area_id);&#10;    info (&#39;:4 &#61;&gt; &#39; || p_meta_data_rec.probation_area_id);&#10;    info (&#39;:5 &#61;&gt; &#39; || p_meta_data_rec.last_updated_user_id);&#10;    info (&#39;:6 &#61;&gt; &#39; || SYSDATE);&#10;    info (&#39;:7 &#61;&gt; &#39; || p_meta_data_rec.filename);&#10;    info (&#39;:8 &#61;&gt; &#39; || p_meta_data_rec.sourceTableKey);&#10;    --&#10;    EXECUTE IMMEDIATE l_SQL&#10;    USING&#10;      p_meta_data_rec.alfrescoID,&#10;      p_meta_data_rec.last_updated_user_id,&#10;      p_meta_data_rec.probation_area_id,&#10;      p_meta_data_rec.probation_area_id,&#10;      p_meta_data_rec.last_updated_user_id,&#10;      SYSDATE,&#10;      p_meta_data_rec.filename,&#10;      p_meta_data_rec.sourceTableKey;&#10;    --&#10;    info(SQL%ROWCOUNT || &#39; rows updated&#39;);&#10;    --&#10;END setDocumentMetadata;&#10;--&#10;--&#10;FUNCTION uploadNew(&#10;    entityType_in       IN VARCHAR2 DEFAULT &#39;DOCUMENT&#39;,&#10;    entityId_in         IN NUMBER,&#10;    responseString_out  OUT VARCHAR2,&#10;    returnString_out    OUT VARCHAR2,&#10;    lockDocument_in     IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    checkoutDocument_in IN VARCHAR2 DEFAULT &#39;N&#39;)&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    PRAGMA AUTONOMOUS_TRANSACTION;&#10;    --&#10;    l_api_params_TAB apiParameters;&#10;    --&#10;    l_url  VARCHAR2(32767);&#10;    l_req  UTL_HTTP.req;&#10;    l_resp UTL_HTTP.resp;&#10;    l_ret  VARCHAR2(200);&#10;    --&#10;    l_return_string   CLOB;&#10;    l_response_string CLOB;&#10;    l_json            JSON_OBJECT_T :&#61; JSON_OBJECT_T(); --json;&#10;    --&#10;    LC_BOUNDARY        CONSTANT VARCHAR2(36) :&#61; &#39;AaB03x&#39;;&#10;    LC_DOC_PLACEHOLDER CONSTANT VARCHAR2(25) :&#61; &#39;DOCUMENT_GOES_HERE&#39;;&#10;    --&#10;    l_temp_blob      BLOB;&#10;    l_params_TAB     table_of_strings_TYP;&#10;    l_content_length PLS_INTEGER;&#10;    --&#10;    l_crn            OFFENDER.crn%TYPE;&#10;    l_author         VARCHAR2(500);&#10;    l_entity_type    DOCUMENT.table_name%TYPE;&#10;    l_entity_id      DOCUMENT.primary_key_id%TYPE;&#10;    l_doc_type       VARCHAR2(500);&#10;    l_file_name      DOCUMENT.document_name%TYPE;&#10;    l_file_ext       VARCHAR2(500);&#10;    l_mime_type      VARCHAR2(500);&#10;    l_file_data      BLOB; --DOCUMENT.document%TYPE;&#10;    l_meta_data_rec  meta_data_rec_TYP;&#10;    --&#10;    l_lock_ret       VARCHAR2(200);&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    --&#10;    IF entityType_in NOT IN (&#39;DOCUMENT&#39;, &#39;EVENT&#39;, &#39;OFFENDER&#39;)  THEN&#10;        RETURN NULL;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700000&#39;;&#10;    l_meta_data_rec :&#61; getDocumentMetaData(entityType_in, entityId_in);&#10;    --&#10;    g_label :&#61; &#39;700001&#39;;&#10;    IF l_meta_data_rec.alfrescoID IS NOT NULL THEN&#10;        RAISE document_migrated;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700002&#39;;&#10;    IF l_meta_data_rec.deleted &#61; &#39;Y&#39; THEN&#10;        RAISE document_deleted;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700003&#39;;&#10;    IF l_meta_data_rec.parent_soft_deleted &#61; &#39;Y&#39; THEN&#10;        RAISE parent_deleted;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700004&#39;;&#10;    IF l_meta_data_rec.parent_soft_deleted &#61; &#39;D&#39; THEN&#10;        RAISE parent_removed;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700005&#39;;&#10;    IF l_meta_data_rec.filename IS NULL THEN&#10;        RAISE filename_error;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700010&#39;;&#10;    l_api_params_TAB(&#39;filedata&#39;) :&#61; LC_DOC_PLACEHOLDER;&#10;    g_label :&#61; &#39;700020&#39;;&#10;    l_api_params_TAB(&#39;CRN&#39;) :&#61; l_meta_data_rec.crn;&#10;    g_label :&#61; &#39;700030&#39;;&#10;    l_api_params_TAB(&#39;author&#39;) :&#61; l_meta_data_rec.author;&#10;    g_label :&#61; &#39;700040&#39;;&#10;    l_api_params_TAB(&#39;entityType&#39;) :&#61; l_meta_data_rec.entityType;&#10;    g_label :&#61; &#39;700050&#39;;&#10;    l_api_params_TAB(&#39;entityId&#39;) :&#61; l_meta_data_rec.entityId;&#10;    g_label :&#61; &#39;700060&#39;;&#10;    l_api_params_TAB(&#39;docType&#39;) :&#61; l_meta_data_rec.docType;&#10;    --&#10;    g_label :&#61; &#39;700063&#39;;&#10;    l_file_name :&#61; l_meta_data_rec.filename;&#10;    g_label :&#61; &#39;700065&#39;;&#10;    l_file_data :&#61; l_meta_data_rec.filedata;&#10;    g_label :&#61; &#39;700067&#39;;&#10;    l_file_ext :&#61; UPPER(SUBSTR(l_file_name,   NULLIF( INSTR(l_file_name,&#39;.&#39;, -1) +1, 1) ));&#10;    IF l_file_ext IS NULL THEN&#10;        l_file_name :&#61; l_file_name || &#39;.DOC&#39;;&#10;        l_mime_type :&#61; &#39;application/msword&#39;;&#10;    ELSIF l_file_ext &#61; &#39;PDF&#39; THEN&#10;        l_mime_type :&#61; &#39;application/pdf&#39;;&#10;    ELSIF l_file_ext &#61; &#39;TXT&#39; THEN&#10;        l_mime_type :&#61; &#39;text/plain&#39;;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700070&#39;;&#10;    createPostParameters(l_api_params_TAB, LC_BOUNDARY, l_file_name, l_mime_type, l_params_TAB, l_content_length);&#10;    info(&#39;l_content_length &#61;&gt; &#39; || NVL(l_content_length,0));&#10;    g_label :&#61; &#39;700080&#39;;&#10;    l_content_length :&#61; l_content_length + LENGTH(l_file_data) - LENGTH(LC_DOC_PLACEHOLDER);&#10;    info(&#39;l_content_length &#61;&gt; &#39; || NVL(l_content_length,0));&#10;    --&#10;    g_label :&#61; &#39;700090&#39;;&#10;    l_url :&#61; SPGCONFIG.get_alfresco_url || &#39;/uploadnew&#39;;&#10;    g_label :&#61; &#39;700100&#39;;&#10;    l_req :&#61; constructRequest(l_url, &#39;POST&#39;);&#10;    g_label :&#61; &#39;700110&#39;;&#10;    UTL_HTTP.set_header(l_req, &#39;Content-Type&#39;, &#39;multipart/form-data; boundary&#61;&quot;&#39; || LC_BOUNDARY || &#39;&quot;&#39;);&#10;    g_label :&#61; &#39;700120&#39;;&#10;    UTL_HTTP.set_header(l_req, &#39;Transfer-Encoding&#39;, &#39;chunked&#39;);&#10;    --UTL_HTTP.set_header(l_req, &#39;Content-Length&#39;, TO_CHAR(l_content_length));&#10;    --&#10;    g_label :&#61; &#39;700130&#39;;&#10;    FOR l_i IN 1..l_params_TAB.LAST LOOP&#10;        g_label :&#61; &#39;700140&#39;;&#10;        IF l_params_TAB(l_i) &#61; LC_DOC_PLACEHOLDER THEN&#10;            writeBlobToHttp(l_req, l_file_data);&#10;            g_label :&#61; &#39;700000&#39;;&#10;            UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;        ELSIF l_params_TAB(l_i) IS NULL THEN&#10;            g_label :&#61; &#39;700150&#39;;&#10;            UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;        ELSE&#10;            g_label :&#61; &#39;700160&#39;;&#10;            UTL_HTTP.write_raw(l_req, UTL_RAW.cast_to_raw(l_params_TAB(l_i)));&#10;            UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;        END IF;&#10;    END LOOP;&#10;    --&#10;    -- process response&#10;    UTL_HTTP.set_transfer_timeout(300);&#10;    --&#10;    g_label :&#61; &#39;700170&#39;;&#10;    l_ret :&#61; Perform_Request(l_req, responseString_out, returnString_out);&#10;    --&#10;    IF l_ret &#61; &#39;200&#39; THEN&#10;        l_json :&#61; JSON_OBJECT_T/*json*/(returnString_out);&#10;        l_meta_data_rec.alfrescoID :&#61; l_json.get_string(&#39;ID&#39;); --json_ext.get_string(l_json, &#39;ID&#39;);&#10;        l_meta_data_rec.filename :&#61; l_json.get_string(&#39;name&#39;); --json_ext.get_string(l_json, &#39;name&#39;);&#10;        setDocumentMetadata(l_meta_data_rec);&#10;        IF NVL(l_meta_data_rec.locked,lockDocument_in) &#61; &#39;Y&#39; THEN&#10;            l_lock_ret :&#61; processDocument(docId_in &#61;&gt; l_meta_data_rec.alfrescoID , operation_in &#61;&gt; &#39;LOCK&#39;, responseString_out &#61;&gt; l_response_string, returnString_out &#61;&gt; l_return_string);&#10;            info(&#39;Reponse from lock request [&#39; || l_response_string || &#39;]&#39;);&#10;        ELSIF NVL(l_meta_data_rec.reserved,checkoutDocument_in) &#61; &#39;Y&#39; THEN&#10;            l_lock_ret :&#61; fetchDocument(docID_in &#61;&gt; l_meta_data_rec.alfrescoID, responseString_out &#61;&gt; l_response_string, document_out &#61;&gt; l_temp_blob, reserveFlag_in &#61;&gt; &#39;Y&#39;);&#10;            info(&#39;Reponse from lock request [&#39; || l_response_string || &#39;]&#39;);&#10;        END IF;&#10;        --&#10;        COMMIT;&#10;        --&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;700180&#39;;&#10;    clean_up;&#10;    --&#10;    RETURN l_ret;&#10;    --&#10;EXCEPTION&#10;    WHEN document_migrated THEN&#10;        returnString_out :&#61; &#39;Document currently contains AlfrescoID - not valid for migration [&#39; || l_meta_data_rec.alfrescoID || &#39;]&#39;;&#10;        error(&#39;uploadNew Error: &#39; || returnString_out);&#10;        clean_up;&#10;        RETURN &#39;500&#39;;&#10;    WHEN document_deleted THEN&#10;        returnString_out :&#61; &#39;Document currently soft deleted - not valid for migration&#39;;&#10;        error(&#39;uploadNew Error: &#39; || returnString_out);&#10;        clean_up;&#10;        RETURN &#39;500&#39;;&#10;    WHEN parent_deleted THEN&#10;        returnString_out :&#61; &#39;Parent row for document currently soft deleted - not valid for migration&#39;;&#10;        error(&#39;uploadNew Error: &#39; || returnString_out);&#10;        clean_up;&#10;        RETURN &#39;500&#39;;&#10;    WHEN parent_removed THEN&#10;        returnString_out :&#61; &#39;Parent row for document does not exist - not valid for migration&#39;;&#10;        error(&#39;uploadNew Error: &#39; || returnString_out);&#10;        clean_up;&#10;        RETURN &#39;500&#39;;&#10;    WHEN filename_error THEN&#10;        returnString_out :&#61; &#39;Filename is NULL - not valid for migration&#39;;&#10;        error(&#39;uploadNew Error: &#39; || returnString_out);&#10;        clean_up;&#10;        RETURN &#39;500&#39;;&#10;    WHEN OTHERS THEN&#10;        returnString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;        error(&#39;uploadNew Error: &#39; || returnString_out);&#10;        clean_up;&#10;        RETURN &#39;500&#39;;&#10;END uploadNew;&#10;--&#10;FUNCTION uploadAndRelease(&#10;    entityType_in       IN VARCHAR2 DEFAULT &#39;DOCUMENT&#39;,&#10;    entityId_in         IN NUMBER,&#10;    responseString_out  OUT VARCHAR2,&#10;    returnString_out    OUT VARCHAR2,&#10;    lockDocument_in     IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    checkoutDocument_in IN VARCHAR2 DEFAULT &#39;N&#39;)&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    PRAGMA AUTONOMOUS_TRANSACTION;&#10;    --&#10;    l_api_params_TAB apiParameters;&#10;    --&#10;    l_url  VARCHAR2(32767);&#10;    l_req  UTL_HTTP.req;&#10;    l_resp UTL_HTTP.resp;&#10;    l_ret  VARCHAR2(200);&#10;    --&#10;    l_return_string   CLOB;&#10;    l_response_string CLOB;&#10;    l_json            JSON_OBJECT_T :&#61; JSON_OBJECT_T(); --json;&#10;    --&#10;    LC_BOUNDARY         CONSTANT VARCHAR2(36) :&#61; &#39;AaB03x&#39;;&#10;    LC_DOC_PLACEHOLDER  CONSTANT VARCHAR2(25) :&#61; &#39;DOCUMENT_GOES_HERE&#39;;&#10;    --&#10;    l_temp_blob      BLOB;&#10;    l_params_TAB     table_of_strings_TYP;&#10;    l_content_length PLS_INTEGER;&#10;    --&#10;    l_crn           OFFENDER.crn%TYPE;&#10;    l_author        VARCHAR2(500);&#10;    l_entity_type   DOCUMENT.table_name%TYPE;&#10;    l_entity_id     DOCUMENT.primary_key_id%TYPE;&#10;    l_doc_type      VARCHAR2(500);&#10;    l_file_name     DOCUMENT.document_name%TYPE;&#10;    l_file_ext      VARCHAR2(500);&#10;    l_mime_type     VARCHAR2(500);&#10;    l_file_data     BLOB; --DOCUMENT.document%TYPE;&#10;    l_doc_id        VARCHAR2(500);&#10;    l_meta_data_rec meta_data_rec_TYP;&#10;    --&#10;    l_lock_ret    VARCHAR2(200);&#10;    --&#10;    PROCEDURE clean_up  IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    IF entityType_in NOT IN (&#39;DOCUMENT&#39;, &#39;EVENT&#39;, &#39;OFFENDER&#39;)  THEN&#10;        RETURN NULL;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;800000&#39;;&#10;    l_meta_data_rec :&#61; getDocumentMetaData(entityType_in, entityId_in);&#10;    --&#10;    g_label :&#61; &#39;800010&#39;;&#10;    l_api_params_TAB(&#39;filedata&#39;)  :&#61; LC_DOC_PLACEHOLDER;&#10;    g_label :&#61; &#39;800020&#39;;&#10;    l_api_params_TAB(&#39;CRN&#39;)       :&#61; l_meta_data_rec.crn;&#10;    g_label :&#61; &#39;800030&#39;;&#10;    l_api_params_TAB(&#39;author&#39;)    :&#61; l_meta_data_rec.author;&#10;    g_label :&#61; &#39;800040&#39;;&#10;    l_api_params_TAB(&#39;entityType&#39;):&#61; l_meta_data_rec.entityType;&#10;    g_label :&#61; &#39;800050&#39;;&#10;    l_api_params_TAB(&#39;entityId&#39;)  :&#61; l_meta_data_rec.entityId;&#10;    g_label :&#61; &#39;800060&#39;;&#10;    l_api_params_TAB(&#39;docType&#39;)   :&#61; l_meta_data_rec.docType;&#10;    l_doc_id :&#61; l_meta_data_rec.alfrescoID;&#10;    --&#10;    g_label :&#61; &#39;800063&#39;;&#10;    l_file_name :&#61; l_meta_data_rec.filename;&#10;    g_label :&#61; &#39;800065&#39;;&#10;    l_file_data :&#61; l_meta_data_rec.filedata;&#10;    g_label :&#61; &#39;800067&#39;;&#10;    l_file_ext :&#61; UPPER(SUBSTR(l_file_name,   NULLIF( INSTR(l_file_name,&#39;.&#39;, -1) +1, 1) ));&#10;    IF l_file_ext IS NULL THEN&#10;        l_file_name :&#61; l_file_name || &#39;.DOC&#39;;&#10;        l_mime_type :&#61; &#39;application/msword&#39;;&#10;    ELSIF l_file_ext &#61; &#39;PDF&#39; THEN&#10;        l_mime_type :&#61; &#39;application/pdf&#39;;&#10;    ELSIF l_file_ext &#61; &#39;TXT&#39; THEN&#10;        l_mime_type :&#61; &#39;text/plain&#39;;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;800070&#39;;&#10;    createPostParameters(l_api_params_TAB, LC_BOUNDARY, l_file_name, l_mime_type, l_params_TAB, l_content_length);&#10;    info(&#39;l_content_length &#61;&gt; &#39; || NVL(l_content_length,0));&#10;    g_label :&#61; &#39;800080&#39;;&#10;    l_content_length :&#61; l_content_length + LENGTH(l_file_data) - LENGTH(LC_DOC_PLACEHOLDER);&#10;    info(&#39;Content Length &#61;&gt; &#39; || NVL(l_content_length,0));&#10;    --&#10;    g_label :&#61; &#39;800090&#39;;&#10;    -- set up resource url and parameters&#10;    l_url :&#61; SPGCONFIG.get_alfresco_url || &#39;/uploadandrelease/&#39; || l_doc_id;&#10;    info(&#39;url &#61;&gt; &#39; || l_url);&#10;    g_label :&#61; &#39;800100&#39;;&#10;    l_req :&#61; constructRequest(l_url, &#39;POST&#39;);&#10;    g_label :&#61; &#39;700110&#39;;&#10;    UTL_HTTP.set_header(l_req, &#39;Content-Type&#39;, &#39;multipart/form-data; boundary&#61;&quot;&#39; || LC_BOUNDARY || &#39;&quot;&#39;);&#10;    g_label :&#61; &#39;800120&#39;;&#10;    UTL_HTTP.set_header(l_req, &#39;Transfer-Encoding&#39;, &#39;chunked&#39;);&#10;    --UTL_HTTP.set_header(l_req, &#39;Content-Length&#39;, TO_CHAR(l_content_length));&#10;    --&#10;    g_label :&#61; &#39;800130&#39;;&#10;    FOR l_i IN 1..l_params_TAB.LAST LOOP&#10;        g_label :&#61; &#39;800140&#39;;&#10;        IF l_params_TAB(l_i) &#61; LC_DOC_PLACEHOLDER THEN&#10;            writeBlobToHttp(l_req, l_file_data);&#10;            g_label :&#61; &#39;800000&#39;;&#10;            UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;        ELSIF l_params_TAB(l_i) IS NULL THEN&#10;            g_label :&#61; &#39;800150&#39;;&#10;            UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;        ELSE&#10;            g_label :&#61; &#39;800160&#39;;&#10;            UTL_HTTP.write_raw(l_req, UTL_RAW.cast_to_raw(l_params_TAB(l_i)));&#10;            UTL_HTTP.write_text(l_req, UTL_TCP.crlf);&#10;        END IF;&#10;    END LOOP;&#10;    --&#10;    -- process response&#10;    g_label :&#61; &#39;800170&#39;;&#10;    l_ret :&#61; Perform_Request(l_req, responseString_out, returnString_out);&#10;    --&#10;    IF l_ret &#61; &#39;200&#39; THEN&#10;        l_json :&#61; JSON_OBJECT_T/*json*/(returnString_out);&#10;        l_meta_data_rec.alfrescoID :&#61; l_json.get_string(&#39;ID&#39;); --json_ext.get_string(l_json, &#39;ID&#39;);&#10;        l_meta_data_rec.filename :&#61; l_json.get_string(&#39;name&#39;); --json_ext.get_string(l_json, &#39;name&#39;);&#10;        setDocumentMetadata(l_meta_data_rec);&#10;        IF lockDocument_in &#61; &#39;Y&#39; THEN&#10;            l_lock_ret :&#61; processDocument(docId_in &#61;&gt; l_meta_data_rec.alfrescoID , operation_in &#61;&gt; &#39;LOCK&#39;, responseString_out &#61;&gt; l_response_string, returnString_out &#61;&gt; l_return_string);&#10;            info(&#39;Reponse from lock request [&#39; || l_response_string || &#39;]&#39;);&#10;        ELSIF checkoutDocument_in &#61; &#39;Y&#39; THEN&#10;            l_lock_ret :&#61; fetchDocument(docID_in &#61;&gt; l_meta_data_rec.alfrescoID, responseString_out &#61;&gt; l_response_string, document_out &#61;&gt; l_temp_blob, reserveFlag_in &#61;&gt; &#39;Y&#39;);&#10;            info(&#39;Reponse from lock request [&#39; || l_response_string || &#39;]&#39;);&#10;        END IF;&#10;        --&#10;        COMMIT;&#10;        --&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;800180&#39;;&#10;    clean_up;&#10;    --&#10;    RETURN l_ret;&#10;    --&#10;EXCEPTION&#10;    WHEN OTHERS THEN&#10;        returnString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;        error(&#39;uploadandRelease Error: &#39; || returnString_out);&#10;        clean_up;&#10;        --&#10;        RETURN &#39;500&#39;;&#10;END uploadAndRelease;&#10;--&#10;FUNCTION detailsDocument(&#10;    docId_in           IN VARCHAR2,&#10;    responseString_out OUT VARCHAR2,&#10;    returnString_out   OUT CLOB )&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_url     VARCHAR2(32767);&#10;    l_req     UTL_HTTP.req;&#10;    l_resp    UTL_HTTP.resp;&#10;    l_ret     VARCHAR2(200);&#10;    l_method  VARCHAR2(200);&#10;    l_docid   DOCUMENT.alfresco_document_id%TYPE;&#10;    --&#10;    l_return_string CLOB;&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_resp.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_response(r&#61;&gt;l_resp);&#10;        END IF;&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    --&#10;    g_label :&#61; &#39;600005&#39;;&#10;    --&#10;    l_docid :&#61; docId_in;&#10;    --&#10;    l_url :&#61; get_alf_url(GC_ALF_DETAILS) || &#39;/details/&#39; || l_docid;&#10;    --&#10;    l_req :&#61; constructRequest(l_url, l_method);&#10;    -- process response&#10;    g_label :&#61; &#39;700170&#39;;&#10;    l_ret :&#61; Perform_Request(l_req, responseString_out, returnString_out);&#10;    --&#10;    g_label :&#61; &#39;700180&#39;;&#10;    clean_up;&#10;    RETURN l_ret;&#10;EXCEPTION WHEN OTHERS THEN&#10;        returnString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;        error(&#39;detailsDocument Error: &#39; || returnString_out);&#10;        clean_up;&#10;        --&#10;        RETURN &#39;500&#39;;&#10;END detailsDocument;&#10;--&#10;FUNCTION searchSoftDeletedDocument(&#10;    crn_in             IN VARCHAR2,&#10;    responseString_out OUT VARCHAR2,&#10;    returnString_out   OUT CLOB&#10;     )&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_url     VARCHAR2(32767);&#10;    l_req     UTL_HTTP.req;&#10;    l_ret     VARCHAR2(200);&#10;    l_method  VARCHAR2(200) :&#61; &#39;GET&#39;;&#10;    l_crn     OFFENDER.crn%TYPE;&#10;    --&#10;    l_return_string CLOB;&#10;    --&#10;    PROCEDURE clean_up IS&#10;    BEGIN&#10;        IF l_req.private_hndl IS NOT NULL THEN&#10;            UTL_HTTP.end_request(r &#61;&gt; l_req);&#10;        END IF;&#10;    END clean_up;&#10;    --&#10;BEGIN&#10;    --&#10;    g_label :&#61; &#39;600005&#39;;&#10;    --&#10;    IF crn_in IS NOT NULL THEN&#10;        l_crn :&#61; crn_in;&#10;    END IF;&#10;    --&#10;    l_url :&#61; SPGCONFIG.get_alfresco_url || &#39;/search/&#39; || l_crn || &#39;/soft-deleted&#39;;&#10;    --&#10;    g_label :&#61; &#39;700170&#39;;&#10;    --&#10;    l_req :&#61; constructRequest(l_url, l_method);&#10;    --&#10;    l_ret :&#61; Perform_Request(l_req, responseString_out, returnString_out);&#10;    --&#10;    g_label :&#61; &#39;700180&#39;;&#10;    --&#10;    clean_up;&#10;    RETURN l_ret;&#10;EXCEPTION WHEN OTHERS THEN&#10;        returnString_out :&#61; UTL_HTTP.get_detailed_sqlerrm;&#10;        clean_up;&#10;        --&#10;        RETURN &#39;500&#39;;&#10;END searchSoftDeletedDocument;&#10;--&#10;--&#10;-- PLSQL package Initialisation block&#10;--&#10;BEGIN&#10;    --&#10;    PKG_Global.do_init;&#10;    --&#10;    do_init_vars;&#10;    --&#10;END AlfrescoSupport;</textarea>
                        </div>
                    </div>
                </section>
            </div>
            <!-- /.content-wrapper -->
            <footer class="main-footer">
                <div>
                    <div class="pull-right hidden-xs">
                        <a href="https://github.com/schemaspy/schemaspy" title="GitHub for SchemaSpy"><i class="fa fa-github-square fa-2x"></i></a>
                        <a href="http://stackoverflow.com/questions/tagged/schemaspy" title="StackOverflow for SchemaSpy"><i class="fa fa-stack-overflow fa-2x"></i></a>
                    </div>
                    <strong>Generated by <a href="http://schemaspy.org/" class="logo-text"><i class="fa fa-database"></i> SchemaSpy 6.2.4</a></strong>
                </div>
                <!-- /.container -->
            </footer>
        </div>
        <!-- ./wrapper -->

        <!-- jQuery 2.2.3 -->
        <script src="../bower/admin-lte/plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../bower/admin-lte/plugins/jQueryUI/jquery-ui.min.js"></script>
        <!-- Bootstrap 3.3.5 -->
        <script src="../bower/admin-lte/bootstrap/js/bootstrap.min.js"></script>
        <!-- DataTables -->
        <script src="../bower/datatables.net/jquery.dataTables.min.js"></script>
        <script src="../bower/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/dataTables.buttons.min.js"></script>
        <script src="../bower/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.html5.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.print.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.colVis.min.js"></script>
        <!-- SheetJS -->
        <script src="../bower/js-xlsx/xlsx.full.min.js"></script>
        <!-- pdfmake -->
        <script src="../bower/pdfmake/pdfmake.min.js"></script>
        <script src="../bower/pdfmake/vfs_fonts.js"></script>
        <!-- SlimScroll -->
        <script src="../bower/admin-lte/plugins/slimScroll/jquery.slimscroll.min.js"></script>
        <!-- FastClick -->
        <script src="../bower/admin-lte/plugins/fastclick/fastclick.js"></script>
        <!-- Salvattore -->
        <script src="../bower/salvattore/salvattore.min.js"></script>
        <!-- AnchorJS -->
        <script src="../bower/anchor-js/anchor.min.js"></script>
        <!-- CodeMirror -->
        <script src="../bower/codemirror/codemirror.js"></script>
        <script src="../bower/codemirror/sql.js"></script>
        <!-- AdminLTE App -->
        <script src="../bower/admin-lte/dist/js/app.min.js"></script>
        <script src="routine.js"></script>
        <script src="../schemaSpy.js"></script>
    </body>
</html>