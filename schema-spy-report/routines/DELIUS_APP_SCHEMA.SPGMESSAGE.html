<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>TSTNDA.DELIUS_APP_SCHEMA</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
        <!-- Bootstrap 3.3.5 -->
        <link rel="stylesheet" href="../bower/admin-lte/bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="../bower/font-awesome/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="../bower/ionicons/css/ionicons.min.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="../bower/datatables.net-bs/css/dataTables.bootstrap.min.css">
        <link rel="stylesheet" href="../bower/datatables.net-buttons-bs/css/buttons.bootstrap.min.css">
        <!-- Code Mirror -->
        <link rel="stylesheet" href="../bower/codemirror/codemirror.css">
        <!-- Fonts -->
        <link href='../fonts/indieflower/indie-flower.css' rel='stylesheet' type='text/css'>
        <link href='../fonts/source-sans-pro/source-sans-pro.css' rel='stylesheet' type='text/css'>

        <!-- Theme style -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/AdminLTE.min.css">
        <!-- Salvattore -->
        <link rel="stylesheet" href="../bower/salvattore/salvattore.css">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
           folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/skins/_all-skins.min.css">
        <!-- SchemaSpy -->
        <link rel="stylesheet" href="../schemaSpy.css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="../bower/html5shiv/html5shiv.min.js"></script>
        <script src="../bower/respond/respond.min.js"></script>
        <![endif]-->
    </head>
    <!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->
    <body class="hold-transition skin-blue layout-top-nav">
        <div class="wrapper">
            <header class="main-header">
                <nav class="navbar navbar-static-top">
                    <div class="container">
                        <div class="navbar-header">
                            <a href="../index.html" class="navbar-brand"><b>TSTNDA</b></a><span class="navbar-brand" style="padding-left: 0">.DELIUS_APP_SCHEMA</span>
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"><i class="fa fa-bars"></i></button>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                            <ul class="nav navbar-nav">
                                <li><a href="../index.html">Tables <span class="sr-only">(current)</span></a></li>
                                <li><a href="../columns.html" title="All of the columns in the schema">Columns</a></li>
                                <li><a href="../constraints.html" title="Useful for diagnosing error messages that just give constraint name or number">Constraints</a></li>
                                <li><a href="../relationships.html" title="Diagram of table relationships">Relationships</a></li>
                                <li><a href="../orphans.html" title="View of tables with neither parents nor children">Orphan&nbsp;Tables</a></li>
                                <li><a href="../anomalies.html" title="Things that might not be quite right">Anomalies</a></li>
                                <li><a href="../routines.html" title="Procedures and functions">Routines</a></li>
                            </ul>
                        </div>
                        <!-- /.navbar-collapse -->
                        <!-- Navbar Right Menu -->
                    </div>
                    <!-- /.container-fluid -->
                </nav>
            </header>
            <!-- Main content -->
            <!-- Full Width Column -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>DELIUS_APP_SCHEMA.SPGMESSAGE</h1><br />
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                            <h3 id="Columns" class="box-title">Parameters</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <table id="standard_table" class="table table-bordered table-striped dataTable" role="grid">
                                <thead align='left'>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Mode</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-code-o"></i>
                            <h3 id="RoutineDefinition" class="box-title">Definition</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <textarea id="sql-script-codemirror" name="sql-script-codemirror" rows="" style="display: none;">PACKAGE BODY SPGMessage&#10;AS&#10;--&#10;&#10;--&#10;-- Package variables - used in information and error messaging&#10;--&#10;    g_package_version CONSTANT VARCHAR2(30) :&#61; GC_VERSION;&#10;    g_component_code  CONSTANT VARCHAR2(3)  :&#61; &#39;SPG&#39;;&#10;    g_package_name    CONSTANT VARCHAR2(30) :&#61; &#39;SPGMessage&#39;;&#10;    g_instance_id     INTEGER :&#61; 0;&#10;    --&#10;    g_master_component_id CONSTANT PDT_THREAD.component_id%TYPE :&#61; 100;&#10;    --&#10;    g_procedure_name  VARCHAR2(30)  :&#61; &#39;initial_value&#39;;&#10;    g_label           VARCHAR2(6)   :&#61; &#39;000000&#39;;&#10;    g_pdm             NUMBER;&#10;    g_unit_test       BOOLEAN       :&#61; FALSE;&#10;    --&#10;    --&#10;    -- XML Outbound Message context&#10;    --&#10;    G_XML_OFFENDER_ID       NUMBER;&#10;    G_XML_TARGET_PROVIDER   VARCHAR2(10);&#10;    G_XML_UNIQUE_ID         NUMBER;&#10;    G_XML_MSG_ID            NUMBER;&#10;    --&#10;    -- message type&#10;    mt_information    CONSTANT NUMBER :&#61; 1;&#10;    mt_warning        CONSTANT NUMBER :&#61; 2;&#10;    mt_error          CONSTANT NUMBER :&#61; 3;&#10;    mt_fatal_error    CONSTANT NUMBER :&#61; 4;&#10;&#10;    --&#10;    -- SPG MT Data Types and Constants&#10;    --&#10;    -- MT multi-threading wait in seconds&#10;    GC_MT_OXML_MASTER_INTERVAL    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_MASTER_INTERVAL&#39;;&#10;    GC_MT_OXML_MASTER_WAIT        CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_MASTER_WAIT&#39;;&#10;    GC_MT_OXML_WORKER_WAIT        CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_WORKER_WAIT&#39;;&#10;    -- MT multi-threading parallel processing degree (peak / off peak times)&#10;    GC_MT_OXML_PARALLEL_1_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_1_PEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_1_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_1_OFFPEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_2_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_2_PEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_2_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_2_OFFPEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_3_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_3_PEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_3_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_3_OFFPEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_4_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_4_PEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_4_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_4_OFFPEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_5_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_5_PEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_5_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_5_OFFPEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_6_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_6_PEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_6_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_6_OFFPEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_7_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_7_PEAK&#39;;&#10;    GC_MT_OXML_PARALLEL_7_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_7_OFFPEAK&#39;;&#10;    -- MT Specialised Queues&#10;    GC_SPG_MT_DOCUMENTS     CONSTANT INTEGER :&#61; 1;&#10;    GC_SPG_MT_REF_DATA      CONSTANT INTEGER :&#61; 2;&#10;    GC_SPG_MT_CRC_EXPORT    CONSTANT INTEGER :&#61; 3;&#10;    GC_SPG_MT_SEARCH        CONSTANT INTEGER :&#61; 4;&#10;    GC_SPG_MT_COMMON_ALLOC  CONSTANT INTEGER :&#61; 5;&#10;    GC_SPG_MT_COMMON        CONSTANT INTEGER :&#61; 6;&#10;    GC_SPG_MT_DOCUMENTS_WIP CONSTANT INTEGER :&#61; 7;&#10;    --&#10;&#10;FUNCTION get_SPG_MT_DOCUMENTS_WIP RETURN INTEGER IS BEGIN RETURN GC_SPG_MT_DOCUMENTS_WIP; END get_SPG_MT_DOCUMENTS_WIP;&#10;FUNCTION get_SPG_MT_DOCUMENTS     RETURN INTEGER IS BEGIN RETURN GC_SPG_MT_DOCUMENTS;     END get_SPG_MT_DOCUMENTS;&#10;FUNCTION get_SPG_MT_REF_DATA      RETURN INTEGER IS BEGIN RETURN GC_SPG_MT_REF_DATA;      END get_SPG_MT_REF_DATA;&#10;FUNCTION get_SPG_MT_CRC_EXPORT    RETURN INTEGER IS BEGIN RETURN GC_SPG_MT_CRC_EXPORT;    END get_SPG_MT_CRC_EXPORT;&#10;FUNCTION get_SPG_MT_SEARCH        RETURN INTEGER IS BEGIN RETURN GC_SPG_MT_SEARCH;        END get_SPG_MT_SEARCH;&#10;FUNCTION get_SPG_MT_COMMON_ALLOC  RETURN INTEGER IS BEGIN RETURN GC_SPG_MT_COMMON_ALLOC;  END get_SPG_MT_COMMON_ALLOC;&#10;FUNCTION get_SPG_MT_COMMON        RETURN INTEGER IS BEGIN RETURN GC_SPG_MT_COMMON;        END get_SPG_MT_COMMON;&#10;--&#10;--&#10;FUNCTION get_version RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN g_package_name || &#39;[version &#61;&gt; &#39; || g_package_version || &#39;]&#39;;&#10;END get_version;&#10;--***************************************************&#10;-- PKG_DEBUG wrappers                               *&#10;--***************************************************&#10;PROCEDURE procDebug(p_msg CLOB, p_print_flag VARCHAR2 DEFAULT &#39;N&#39;) IS&#10;BEGIN&#10;    PKG_Debug.procDebug(p_msg, p_print_flag);&#10;END procDebug;&#10;&#10;FUNCTION funcgetDebugMode RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Debug.funcgetDebugMode;&#10;END funcgetDebugMode;&#10;--&#10;PROCEDURE message(p_msg VARCHAR2, p_trace_level INTEGER DEFAULT 0) IS&#10;BEGIN&#10;    procDebug(&#39;[&#39; || g_label || &#39;] &#39; || p_msg, p_print_flag &#61;&gt; &#39;Y&#39;);&#10;END message;&#10;&#10;--***************************************************&#10;-- PKG_COMMON wrappers                              *&#10;--***************************************************&#10;FUNCTION is_str_empty(p_str VARCHAR2, p_ignore_spaces_and_zeroes VARCHAR2 DEFAULT &#39;N&#39;) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.is_str_empty( p_str, p_ignore_spaces_and_zeroes );&#10;END is_str_empty;&#10;--&#10;FUNCTION empty2null(p_str VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.empty2null(p_str);&#10;END empty2null;&#10;&#10;FUNCTION nvlstr(p_str1 VARCHAR2, p_str2 VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;   RETURN PKG_Common.NVLSTR(p_str1 &#61;&gt; p_str1, p_str2 &#61;&gt; p_str2);&#10;END nvlstr;&#10;--&#10;--&#10;PROCEDURE raise_error(&#10;    error_code_in    IN PLS_INTEGER DEFAULT NULL,&#10;    error_message_in IN VARCHAR2 DEFAULT NULL)&#10;IS&#10;    l_error_code    PLS_INTEGER :&#61; NVL(error_code_in, SQLCODE);&#10;    l_error_message VARCHAR2(4000) :&#61; SUBSTR(NVLSTR(error_message_in, SQLERRM), 1, 4000);&#10;BEGIN&#10;    g_procedure_name :&#61; &#39;raise_error&#39;;&#10;    IF l_error_code BETWEEN -20999 AND -20000 THEN&#10;        RAISE_APPLICATION_ERROR (l_error_code, l_error_message);&#10;    ELSIF l_error_code &gt; 0 AND l_error_code NOT IN (1,100) THEN&#10;        RAISE_APPLICATION_ERROR (-20000, l_error_code||&#39; - &#39;||l_error_message);&#10;    ELSIF l_error_code IN (100, -1403) THEN&#10;        RAISE_APPLICATION_ERROR (-20000, l_error_code||&#39; - &#39;||l_error_message);&#10;    ELSIF l_error_code &lt;&gt; 0 THEN&#10;        RAISE_APPLICATION_ERROR(-20000, &#39;INTERNAL ERROR: An unexpected error in PL/SQL&#39;);&#10;    END IF;&#10;END raise_error;&#10;--&#10;--&#10;--***************************************************&#10;-- Helpers                                          *&#10;--***************************************************&#10;--&#10;-- Used to populate mtt_message_log with information type message&#10;PROCEDURE info (message_in VARCHAR2)&#10;IS&#10;BEGIN&#10;    IF SPGConfig.SPGInfoActive THEN&#10;        SPGConfig.insert_message_log(&#10;            message_type_id_in  &#61;&gt; mt_information,&#10;            component_code_in   &#61;&gt; g_component_code,&#10;            package_name_in     &#61;&gt; g_package_name,&#10;            procedure_name_in   &#61;&gt; g_procedure_name,&#10;            label_in            &#61;&gt; g_label,&#10;            message_text_in     &#61;&gt; message_in );&#10;    END IF;&#10;END info;&#10;--&#10;-- Will populate mtt_message_log with warning message - will populate mtt_error_log if result of exception&#10;PROCEDURE warn(message_in VARCHAR2) IS&#10;BEGIN&#10;    IF SPGConfig.SPGWarnActive THEN&#10;        SPGConfig.record_error(&#10;            message_type_id_in    &#61;&gt; mt_warning,&#10;            component_code_in     &#61;&gt; g_component_code,&#10;            package_name_in       &#61;&gt; g_package_name,&#10;            procedure_name_in     &#61;&gt; g_procedure_name,&#10;            label_in              &#61;&gt; g_label,&#10;            message_text_in       &#61;&gt; message_in );&#10;    END IF;&#10;END warn;&#10;--&#10;-- Will populate mtt_message_log with error message and populate mtt_error_log with exception - used for log and continue&#10;PROCEDURE error (message_in VARCHAR2)&#10;IS&#10;BEGIN&#10;    SPGConfig.record_error(&#10;        message_type_id_in    &#61;&gt; mt_error,&#10;        component_code_in     &#61;&gt; g_component_code,&#10;        package_name_in       &#61;&gt; g_package_name,&#10;        procedure_name_in     &#61;&gt; g_procedure_name,&#10;        label_in              &#61;&gt; g_label,&#10;        message_text_in       &#61;&gt; message_in);&#10;END error;&#10;--&#10;-- Will populate mtt_message_log, mtt_error_log with error message and raise exception - used for log and halt&#10;PROCEDURE fatal (message_in VARCHAR2)&#10;IS&#10;BEGIN&#10;    SPGConfig.record_error(&#10;        message_type_id_in    &#61;&gt; mt_fatal_error,&#10;        component_code_in     &#61;&gt; g_component_code,&#10;        package_name_in       &#61;&gt; g_package_name,&#10;        procedure_name_in     &#61;&gt; g_procedure_name,&#10;        label_in              &#61;&gt; g_label,&#10;        message_text_in       &#61;&gt; message_in,&#10;        raise_error_in        &#61;&gt; TRUE );&#10;END fatal;&#10;--&#10;PROCEDURE debug_msg(p_msg VARCHAR2) IS&#10;BEGIN&#10;    --DBMS_OUTPUT.put_line(p_msg);&#10;    info(p_msg);&#10;END debug_msg;&#10;&#10;--&#10;--***************************************************&#10;-- Package initialisation block                              *&#10;--***************************************************&#10;PROCEDURE do_init_vars IS&#10;BEGIN&#10;    --PKG_DynSQL.init_tab_info(p_reset_flag &#61;&gt; &#39;Y&#39;);&#10;    NULL;&#10;END do_init_vars;&#10;--&#10;--&#10;--***************************************************&#10;-- Main procedures and functions                    *&#10;--***************************************************&#10;FUNCTION strip_space( characters_in CLOB) RETURN CLOB&#10;IS&#10;BEGIN&#10;  RETURN REGEXP_REPLACE(characters_in, &#39;[[:space:]]+&#39;,&#39; &#39;);&#10;END strip_space;&#10;--&#10;--&#10;--&#10;-- SPG Outbound Message run time context&#10;--&#10;FUNCTION get_xml_offender_id RETURN NUMBER IS&#10;BEGIN&#10;    RETURN G_XML_OFFENDER_ID;&#10;END get_xml_offender_id;&#10;--&#10;FUNCTION get_xml_unique_id RETURN NUMBER IS&#10;BEGIN&#10;    RETURN G_XML_UNIQUE_ID;&#10;END get_xml_unique_id;&#10;--&#10;FUNCTION get_xml_unique_id(p_xml_msg_id NUMBER) RETURN NUMBER IS&#10;BEGIN&#10;    RETURN&#10;        CASE&#10;            WHEN p_xml_msg_id &#61; G_XML_MSG_ID&#10;                THEN G_XML_UNIQUE_ID&#10;            ELSE NULL&#10;        END;&#10;END get_xml_unique_id;&#10;--&#10;FUNCTION get_xml_target_provider RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN G_XML_TARGET_PROVIDER;&#10;END get_xml_target_provider;&#10;--&#10;FUNCTION get_xml_msg_id RETURN NUMBER IS&#10;BEGIN&#10;    RETURN G_XML_MSG_ID;&#10;END get_xml_msg_id;&#10;--&#10;PROCEDURE set_xml_offender_id(p_offender_id NUMBER) IS&#10;BEGIN&#10;    G_XML_OFFENDER_ID :&#61; p_offender_id;&#10;END set_xml_offender_id;&#10;--&#10;PROCEDURE set_xml_unique_id(p_xml_unique_id NUMBER) IS&#10;BEGIN&#10;    G_XML_UNIQUE_ID :&#61; p_xml_unique_id;&#10;END set_xml_unique_id;&#10;--&#10;PROCEDURE set_xml_msg_id(p_xml_msg_id NUMBER) IS&#10;BEGIN&#10;    G_XML_MSG_ID :&#61; p_xml_msg_id;&#10;END set_xml_msg_id;&#10;--&#10;PROCEDURE set_xml_target_provider(p_target_provider VARCHAR2) IS&#10;BEGIN&#10;    G_XML_TARGET_PROVIDER :&#61; p_target_provider;&#10;END set_xml_target_provider;&#10;&#10;FUNCTION get_provider_documents_flag(p_provider VARCHAR2 DEFAULT NULL) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN&#10;        CASE WHEN NVLSTR(NVLSTR(p_provider, G_XML_TARGET_PROVIDER), &#39;ALL&#39;) &lt;&gt; &#39;ALL&#39;&#10;            THEN&#10;                PKG_Lookups.funcgetTabRecord_CACHED(&#10;                    p_table       &#61;&gt; &#39;PROBATION_AREA&#39;,&#10;                    p_ref_col     &#61;&gt; &#39;code&#39;,&#10;                    p_ref_val     &#61;&gt; G_XML_TARGET_PROVIDER,&#10;                    p_data_fld    &#61;&gt; &#39;DECODE( allocate_document_list, 1, &#39;&#39;Y&#39;&#39;, &#39;&#39;N&#39;&#39;)&#39;,&#10;                    p_default_val &#61;&gt; &#39;N&#39; )&#10;            ELSE &#39;N&#39;&#10;        END;&#10;END get_provider_documents_flag;&#10;--&#10;--&#10;PROCEDURE document_to_disk(offender_id_in IN NUMBER, document_id_in IN NUMBER DEFAULT NULL)&#10;IS&#10;    l_job_name  VARCHAR2(30);&#10;BEGIN&#10;    l_job_name :&#61; &#39;SPG_EXPORT_DOC_&#39; || TO_CHAR(offender_id_in);&#10;    --&#10;    DBMS_SCHEDULER.create_job(&#10;        job_name      &#61;&gt; l_job_name,&#10;        program_name  &#61;&gt; &#39;SPG_EXPORT_DOCUMENT_PROG&#39;,&#10;        start_date    &#61;&gt; SYSDATE,&#10;        enabled       &#61;&gt; FALSE,&#10;        comments      &#61;&gt; &#39;SPG_EXPORT_DOCUMENT_JOB&#39;);&#10;    --&#10;    DBMS_SCHEDULER.set_job_argument_value(&#10;        job_name        &#61;&gt; l_job_name,&#10;        argument_name   &#61;&gt; &#39;offender_id_in&#39;,&#10;        argument_value  &#61;&gt; offender_id_in);&#10;    --&#10;    DBMS_SCHEDULER.set_job_argument_value(&#10;        job_name        &#61;&gt; l_job_name,&#10;        argument_name   &#61;&gt; &#39;document_id_in&#39;,&#10;        argument_value  &#61;&gt; document_id_in);&#10;    --&#10;    DBMS_SCHEDULER.enable(l_job_name);&#10;END document_to_disk;&#10;--&#10;--&#10;--&#10;FUNCTION get_root_attributes (&#10;    versionnumber_in  IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    schemadate_in     IN VARCHAR2 DEFAULT GC_SCHEMA_DATE )&#10;RETURN CLOB&#10;IS&#10;    l_xml_root    CLOB;&#10;BEGIN&#10;    l_xml_root :&#61;&#10;              &#39;&#10;              XMLATTRIBUTES(  &#39;&#39;http://www.justice.gsi.gov.uk/SPG/&#39;&#39; AS &quot;xmlns&quot;,&#10;                              &#39;&#39;http://www.w3.org/2001/XMLSchema-instance&#39;&#39; AS &quot;xmlns:xsi&quot;,&#10;                              &#39;&#39;&#39;|| versionnumber_in ||&#39;&#39;&#39; AS &quot;SchemaVersion&quot;,&#10;                              &#39;&#39;&#39;|| schemadate_in ||&#39;&#39;&#39; AS &quot;SchemaDate&quot;,&#10;                              &#39;&#39;http://www.justice.gsi.gov.uk/SPG/ SPG-XML_Message_Root-V&#39; || GC_SCHEMA_VERSION || &#39;.xsd&#39;&#39; AS &quot;xsi:schemaLocation&quot;)&#10;              &#39;;&#10;  --&#10;  RETURN l_xml_root;&#10;END get_root_attributes;&#10;--&#10;--&#10;FUNCTION get_interchange_header (&#10;    senderidentity_in           IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receiveridentity_in         IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    sendercontrolreference_in   IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receivercontrolreference_in IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    dateofpreparation_in        IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in     IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    testindicator_in            IN VARCHAR2 DEFAULT &#39;a&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_ic_hdr         CLOB;&#10;    l_test_indicator VARCHAR2(1);&#10;BEGIN&#10;    --&#10;    IF testindicator_in &#61; &#39;Y&#39; THEN&#10;        l_test_indicator :&#61; &#39;Y&#39;;&#10;    ELSE&#10;        l_test_indicator :&#61; NULL;&#10;    END IF;&#10;    --&#10;    l_ic_hdr :&#61;&#10;              &#39;&#10;                    XMLELEMENT(name &quot;SPGInterchangeHeader&quot;,&#10;                      XMLFOREST(&#10;                              &#39;&#39;&#39;||senderidentity_in||&#39;&#39;&#39; AS &quot;SenderIdentity&quot;,&#10;                              &#39;&#39;&#39;||receiveridentity_in||&#39;&#39;&#39; AS &quot;ReceiverIdentity&quot;,&#10;                              &#39;&#39;&#39;||sendercontrolreference_in||&#39;&#39;&#39; AS &quot;SenderControlReference&quot;, &#39;&#10;                              || CASE WHEN EMPTY2NULL(receivercontrolreference_in) IS NOT NULL&#10;                                              THEN &#39;&#39;&#39;&#39;||receivercontrolreference_in||&#39;&#39;&#39; AS &quot;ReceiverControlReference&quot;, &#39;&#10;                                  END ||&#10;                              &#39;&#39;&#39;&#39;||TO_CHAR(dateofpreparation_in, &#39;YYYY-MM-DD&#39;)||&#39;&#39;&#39; AS &quot;DateOfPreparation&quot;,&#10;                              &#39;&#39;&#39;||TO_CHAR(dateofpreparation_in, &#39;hh24:mi:ss&#39;)||&#39;&#39;&#39; AS &quot;TimeOfPreparation&quot;,&#10;                              &#39;&#39;&#39;||applicationreference_in||&#39;&#39;&#39; AS &quot;ApplicationReference&quot; &#39;&#10;                              || CASE WHEN testindicator_in &#61; &#39;Y&#39; THEN&#10;                                 &#39;,&#39;&#39;&#39;||l_test_indicator||&#39;&#39;&#39; AS &quot;TestIndicator&quot; &#39;&#10;                                 END ||&#10;                              &#39;   ))&#10;              &#39;;&#10;    --&#10;    RETURN l_ic_hdr;&#10;    --&#10;END get_interchange_header;&#10;--&#10;--&#10;FUNCTION get_interchange_trailer (&#10;    senderidentity_in           IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receiveridentity_in         IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    sendercontrolreference_in   IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receivercontrolreference_in IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    controlcount_in             IN INTEGER DEFAULT 1 )&#10;RETURN CLOB&#10;IS&#10;    l_ic_trl    CLOB;&#10;BEGIN&#10;    l_ic_trl :&#61;&#10;              &#39;&#10;                XMLELEMENT(name &quot;SPGInterchangeTrailer&quot;,&#10;                  XMLFOREST(&#10;                          &#39;&#39;&#39;|| sendercontrolreference_in ||&#39;&#39;&#39; AS &quot;SenderControlReference&quot;, &#39;&#10;                          || CASE WHEN EMPTY2NULL(receivercontrolreference_in) IS NOT NULL&#10;                                          THEN &#39;&#39;&#39;&#39;||receivercontrolreference_in||&#39;&#39;&#39; AS &quot;ReceiverControlReference&quot;, &#39;&#10;                              END ||&#10;                          &#39;&#39;&#39;&#39;|| controlcount_in ||&#39;&#39;&#39; AS &quot;ControlCount&quot;,&#10;                          &#39;&#39;&#39;|| senderidentity_in ||&#39;&#39;&#39; AS &quot;SenderIdentity&quot;,&#10;                          &#39;&#39;&#39;|| receiveridentity_in ||&#39;&#39;&#39; AS &quot;ReceiverIdentity&quot;))&#10;              &#39;;&#10;    --&#10;    RETURN l_ic_trl;&#10;    --&#10;END get_interchange_trailer;&#10;--&#10;--&#10;FUNCTION get_message_header (&#10;    messagetype_in              IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in     IN VARCHAR2 DEFAULT &#39;SPG001&#39;,&#10;    messagereferencenumber_in   IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in  IN VARCHAR2 DEFAULT &#39;a&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_m_hdr   CLOB;&#10;BEGIN&#10;    l_m_hdr :&#61;&#10;            &#39;&#10;                  XMLELEMENT(name &quot;SPGMessage&quot;,&#10;&#10;                              XMLELEMENT (name &quot;SPGMessageHeader&quot;,&#10;                              XMLFOREST(&#10;                                      &#39;&#39;&#39;|| messagetype_in ||&#39;&#39;&#39; AS &quot;MessageType&quot;,&#10;                                      &#39;&#39;&#39;|| messageversionnumber_in ||&#39;&#39;&#39; AS &quot;MessageVersionNumber&quot;,&#10;                                      &#39;|| messagereferencenumber_in ||&#39; AS &quot;MessageReferenceNumber&quot;,&#10;                                      &#39;&#39;&#39;|| messagerecordidentifier_in ||&#39;&#39;&#39; AS &quot;MessageRecordIdentifier&quot; ))&#10;            &#39;;&#10;    --&#10;    RETURN l_m_hdr;&#10;    --&#10;END get_message_header;&#10;--&#10;--&#10;FUNCTION get_message_trailer( messagereferencenumber_in   IN NUMBER DEFAULT 99999999999999 ) RETURN CLOB&#10;IS&#10;    l_m_trl   CLOB;&#10;BEGIN&#10;    l_m_trl :&#61;&#10;            &#39;&#10;                  XMLELEMENT (name &quot;SPGMessageTrailer&quot;,&#10;                  XMLFOREST(&#10;                          &#39;|| messagereferencenumber_in || &#39; AS &quot;MessageReferenceNumber&quot;))&#10;            &#39;;&#10;    --&#10;    RETURN l_m_trl;&#10;    --&#10;END get_message_trailer;&#10;--&#10;--&#10;FUNCTION xsd_tag_introduced_since( p_xsd_target VARCHAR2, p_xsd_current VARCHAR2, p_xml_tag VARCHAR2 ) RETURN VARCHAR2&#10;IS&#10;    l_xsd_date_target  VARCHAR2(10);&#10;    l_xsd_date_current VARCHAR2(10);&#10;BEGIN&#10;    l_xsd_date_target :&#61;&#10;        PKG_Lookups.funcgetTabRecord_CACHED(&#10;            p_table       &#61;&gt; &#39;SPG_XSD&#39;,&#10;            p_ref_col     &#61;&gt; &#39;xsd_version&#39;,&#10;            p_ref_val     &#61;&gt; p_xsd_target,&#10;            p_data_fld    &#61;&gt; &#39;TO_CHAR(xsd_date, &#39;&#39;YYYY-MM-DD&#39;&#39;)&#39;,&#10;            p_default_val &#61;&gt; GC_SCHEMA_DATE );&#10;    --&#10;    l_xsd_date_current :&#61;&#10;        PKG_Lookups.funcgetTabRecord_CACHED(&#10;            p_table       &#61;&gt; &#39;SPG_XSD&#39;,&#10;            p_ref_col     &#61;&gt; &#39;xsd_version&#39;,&#10;            p_ref_val     &#61;&gt; p_xsd_current,&#10;            p_data_fld    &#61;&gt; &#39;TO_CHAR(xsd_date, &#39;&#39;YYYY-MM-DD&#39;&#39;)&#39;,&#10;            p_default_val &#61;&gt; GC_SCHEMA_DATE );&#10;    --&#10;    RETURN&#10;        CASE WHEN TO_DATE(l_xsd_date_current, &#39;YYYY-MM-DD&#39;) &gt;&#61; TO_DATE(l_xsd_date_target, &#39;YYYY-MM-DD&#39;)&#10;            THEN p_xml_tag&#10;            ELSE &#39;/* Not available until XSD&#61;[&#39; || p_xsd_target || &#39;]: &#39; || p_xml_tag || &#39;*/&#39;&#10;        END;&#10;END xsd_tag_introduced_since;&#10;--&#10;FUNCTION xsd_tag_valid_until(p_xsd_target VARCHAR2, p_xsd_current VARCHAR2, p_xml_tag VARCHAR2) RETURN VARCHAR2&#10;IS&#10;    l_xsd_date_target  VARCHAR2(10);&#10;    l_xsd_date_current VARCHAR2(10);&#10;BEGIN&#10;    l_xsd_date_target :&#61;&#10;        PKG_Lookups.funcgetTabRecord_CACHED(&#10;            p_table       &#61;&gt; &#39;SPG_XSD&#39;,&#10;            p_ref_col     &#61;&gt; &#39;xsd_version&#39;,&#10;            p_ref_val     &#61;&gt; p_xsd_target,&#10;            p_data_fld    &#61;&gt; &#39;TO_CHAR(xsd_date, &#39;&#39;YYYY-MM-DD&#39;&#39;)&#39;,&#10;            p_default_val &#61;&gt; GC_SCHEMA_DATE );&#10;    --&#10;    l_xsd_date_current :&#61;&#10;        PKG_Lookups.funcgetTabRecord_CACHED(&#10;            p_table       &#61;&gt; &#39;SPG_XSD&#39;,&#10;            p_ref_col     &#61;&gt; &#39;xsd_version&#39;,&#10;            p_ref_val     &#61;&gt; p_xsd_current,&#10;            p_data_fld    &#61;&gt; &#39;TO_CHAR(xsd_date, &#39;&#39;YYYY-MM-DD&#39;&#39;)&#39;,&#10;            p_default_val &#61;&gt; GC_SCHEMA_DATE );&#10;    --&#10;    RETURN&#10;        CASE WHEN TO_DATE(l_xsd_date_current, &#39;YYYY-MM-DD&#39;) &lt;&#61; TO_DATE(l_xsd_date_target, &#39;YYYY-MM-DD&#39;)&#10;            THEN p_xml_tag&#10;            ELSE &#39;/* Not valid since XSD&gt;[&#39; || p_xsd_target || &#39;]: &#39; || p_xml_tag || &#39;*/&#39;&#10;        END;&#10;END xsd_tag_valid_until;&#10;--&#10;--&#10;FUNCTION get_srd_xsql (&#10;    versionnumber_in              IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    uniqueid_in                   IN NUMBER DEFAULT NULL,&#10;    schemadate_in                 IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in             IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receiveridentity_in           IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    sendercontrolreference_in     IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receivercontrolreference_in   IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    dateofpreparation_in          IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in       IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    testindicator_in              IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    controlcount_in               IN INTEGER DEFAULT 1,&#10;    messagetype_in                IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in       IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in     IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in    IN VARCHAR2 DEFAULT &#39;a&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xsql    CLOB;&#10;BEGIN&#10;    l_xsql :&#61;&#10;&#39;&#10;SELECT&#10;    /*XMLROOT(*/&#10;      XMLELEMENT(name &quot;SPGInterchange&quot;,&#10;      &#39; ||&#10;      get_root_attributes (&#10;                            versionnumber_in  &#61;&gt; versionnumber_in,&#10;                            schemadate_in     &#61;&gt; schemadate_in&#10;                          ) || &#39;,&#10;      &#39;||&#10;      get_interchange_header  (&#10;                              senderidentity_in           &#61;&gt; senderidentity_in,&#10;                              receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                              sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                              receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                              dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                              applicationreference_in     &#61;&gt; applicationreference_in,&#10;                              testindicator_in            &#61;&gt; testindicator_in&#10;                              ) || &#39;,&#10;      &#39;||&#10;      get_message_header  (&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                          ) || &#39;,&#10;&#10;                  XMLELEMENT  (name &quot;SimpleReferenceDataList&quot;,&#10;                                            XMLAGG  (&#10;                                                    XMLELEMENT (name &quot;SimpleReferenceDataDomain&quot;,&#10;                                                                  XMLFOREST (&#10;                                                                            rrdm.code_set_name AS &quot;DomainName&quot;,&#10;                                                                            rrdm.description    AS &quot;DomainDescription&quot;,&#10;                                                                            (SELECT XMLAGG(&#10;                                                                                                      XMLELEMENT  ( &quot;DomainItem&quot;,&#10;                                                                                                                    XMLFOREST(&#10;                                                                                                                              r.code_value        AS &quot;Code&quot;,&#10;                                                                                                                              r.code_description  AS &quot;Description&quot;,&#10;                                                                                                                              r.selectable        AS &quot;Selectable&quot;&#10;                                                                                                                              )&#10;                                                                                                                  )&#10;                                                                                          )&#10;                                                                            FROM r_standard_reference_list r&#10;                                                                            WHERE r.reference_data_master_id &#61; rrdm.reference_data_master_id&#10;                                                                            AND (UPPER(r.code_description) NOT LIKE &#39;&#39;Z\_DUMMY%&#39;&#39; ESCAPE &#39;&#39;\&#39;&#39; OR selectable &#61; &#39;&#39;Y&#39;&#39;)&#39;&#10;&#10;                                                                            || CASE WHEN uniqueid_in IS NOT NULL THEN &#39; AND r.standard_reference_list_id &#61; &#39; || uniqueid_in END ||&#10;&#10;                                                                            &#39;&#10;                                                                            ) &quot;DomainItems&quot;&#10;                                                                            )&#10;                                                                )&#10;                                                    )&#10;                              ),&#10;                  &#39; ||&#10;                  get_message_trailer (&#10;                                      messagereferencenumber_in   &#61;&gt; messagereferencenumber_in&#10;                                      ) || &#39;&#10;                ),&#10;                &#39; ||&#10;                get_interchange_trailer (&#10;                                        senderidentity_in           &#61;&gt; senderidentity_in,&#10;                                        receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                                        sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                                        receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                                        controlcount_in             &#61;&gt; controlcount_in&#10;                                        ) || &#39;&#10;                ) AS xml_xsql_srd&#10;           /*, version &#39;&#39;1.0&quot; encoding&#61;&quot;UTF-8&#39;&#39;     )*/&#10;&#10;FROM   r_reference_data_master rrdm&#10;WHERE EXISTS  ( SELECT 1&#10;                FROM r_standard_reference_list rsrl1&#10;                WHERE rrdm.reference_data_master_id &#61; rsrl1.reference_data_master_id&#39;&#10;                || CASE WHEN uniqueid_in IS NOT NULL THEN &#39; AND rsrl1.standard_reference_list_id &#61; &#39; || uniqueid_in END ||&#10;                &#39;&#10;                )&#39;;&#10;    --&#10;    RETURN l_xsql;&#10;    --&#10;END get_srd_xsql;&#10;--&#10;--&#10;FUNCTION get_nsrd_xsql  (&#10;    versionnumber_in            IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    rdtype_in                   IN VARCHAR2 DEFAULT &#39;NONSTANDARD&#39;,&#10;    uniqueid_in                 IN NUMBER DEFAULT NULL,&#10;    schemadate_in               IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in         IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in        IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in     IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in            IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in             IN INTEGER DEFAULT 1,&#10;    messagetype_in              IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in     IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in   IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in  IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xsql    CLOB;&#10;BEGIN&#10;    l_xsql :&#61;&#10;&#39;&#10;SELECT&#10;    /*XMLROOT(*/&#10;      XMLELEMENT(name &quot;SPGInterchange&quot;,&#10;      &#39; ||&#10;      get_root_attributes (&#10;                            versionnumber_in  &#61;&gt; versionnumber_in,&#10;                            schemadate_in     &#61;&gt; schemadate_in&#10;                          ) || &#39;,&#10;      &#39;||&#10;      get_interchange_header  (&#10;                              senderidentity_in           &#61;&gt; senderidentity_in,&#10;                              receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                              sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                              receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                              dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                              applicationreference_in     &#61;&gt; applicationreference_in,&#10;                              testindicator_in            &#61;&gt; testindicator_in&#10;                              ) || &#39;,&#10;      &#39;||&#10;      get_message_header  (&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                          ) || &#39;,&#10;&#10;                          XMLELEMENT(name &quot;ComplexReferenceDataList&quot;,&#10;                                      XMLELEMENT(name &quot;ComplexReferenceDataDetails&quot;,&#10;                                                  XMLAGG (&#10;                                                          XMLELEMENT(name &quot;Domain&quot;,&#10;                                                                      XMLELEMENT(name &quot;DomainName&quot;, spg_nsrd_list.domain),&#10;                                                                      XMLELEMENT(name &quot;DomainDescription&quot;, INITCAP(spg_nsrd_list.domain)),&#10;                                                                      XMLELEMENT(name &quot;ComplexReferenceDataList&quot;,&#10;                                                                      (SELECT XMLAGG (&#10;                                                                              XMLELEMENT(name &quot;ComplexReferenceDataItem&quot;,&#10;                                                                                          XMLFOREST ( rconfig.code AS &quot;Code&quot;,&#10;                                                                                                      rconfig.description AS &quot;Description&quot;,&#10;                                                                                                     rconfig.selectable AS &quot;Selectable&quot;&#10;                                                                                                    ),&#10;                                                                                          CASE WHEN rconfig.config &#61;&#39;&#39;Y&#39;&#39; THEN&#10;                                                                                          XMLELEMENT (name &quot;Configuration&quot;,&#10;                                                                                                        XMLATTRIBUTES(rconfig.msgno AS &quot;xsi:type&quot;),&#10;                                                                                                        XMLFOREST(&#10;&#10;                                                                                                                    rconfig.allowduplicates AS &quot;AllowDuplicates&quot;,&#10;                                                                                                                    rconfig.unitscode AS &quot;UnitsCode&quot;,&#10;                                                                                                                    rconfig.terminationcount AS &quot;TerminationCount&quot;,&#10;                                                                                                                    rconfig.assessmentopentoedit AS &quot;AssessmentOpenToEdit&quot;,&#10;                                                                                                                    rconfig.assessmentoutcomeflag AS &quot;AssessmentOutcomeFlag&quot;,&#10;                                                                                                                    rconfig.durationflag AS &quot;DurationFlag&quot;,&#10;                                                                                                                    rconfig.offendersagreementflag AS &quot;OffendersAgreementFlag&quot;,&#10;                                                                                                                    rconfig.scoreflag AS &quot;ScoreFlag&quot;,&#10;                                                                                                                    rconfig.actionrequired AS &quot;ActionRequired&quot;,&#10;                                                                                                                    rconfig.enforceable AS &quot;Enforceable&quot;,&#10;                                                                                                                    rconfig.outcomeattendance AS &quot;OutcomeAttendance&quot;,&#10;                                                                                                                    rconfig.outcomecompliantacceptable AS &quot;OutcomeCompliantAcceptable&quot;,&#10;                                                                                                                    rconfig.attendancecontact AS &quot;AttendanceContact&quot;,&#10;                                                                                                                    rconfig.contactlocationflag AS &quot;ContactLocationFlag&quot;,&#10;                                                                                                                    rconfig.contactoutcomeflag AS &quot;ContactOutcomeFlag&quot;,&#10;                                                                                                                    rconfig.editable AS &quot;Editable&quot;,&#10;                                                                                                                    rconfig.nationalstandardscontact AS &quot;NationalStandardsContact&quot;,&#10;                                                                                                                    rconfig.offenderevent0 AS &quot;OffenderEvent0&quot;,&#10;                                                                                                                    rconfig.offenderlevelcontact AS &quot;OffenderLevelContact&quot;,&#10;                                                                                                                    rconfig.recordedhourscredited AS &quot;RecordedHoursCredited&quot;,&#10;                                                                                                                    &#39; || xsd_tag_introduced_since(&#39;0-9-11&#39;, MessageVersionNumber_in, &#39;rconfig.RARActivity AS &quot;RARActivity&quot;,&#39;) || &#39;&#10;                                                                                                                    rconfig.delivered AS &quot;Delivered&quot;,&#10;                                                                                                                    rconfig.privatetransfer AS &quot;PrivateTransfer&quot;,&#10;                                                                                                                    rconfig.psr AS &quot;PSR&quot;,&#10;                                                                                                                    rconfig.requested AS &quot;Requested&quot;,&#10;                                                                                                                    rconfig.auto_terminate AS &quot;Auto_Terminate&quot;,&#10;                                                                                                                    rconfig.ftclimit AS &quot;FTCLimit&quot;,&#10;                                                                                                                    rconfig.maximumlength AS &quot;MaximumLength&quot;,&#10;                                                                                                                    rconfig.minimumlength AS &quot;MinimumLength&quot;,&#10;                                                                                                                    rconfig.maximumage AS &quot;MaximumAge&quot;,&#10;                                                                                                                    rconfig.minimumage AS &quot;MinimumAge&quot;,&#10;                                                                                                                    rconfig.proposal AS &quot;Proposal&quot;,&#10;                                                                                                                    rconfig.canbeinjected AS &quot;CanBeInjected&quot;,&#10;                                                                                                                    rconfig.quantitylabel AS &quot;QuantityLabel&quot;,&#10;                                                                                                                    rconfig.contacttype AS &quot;ContactType&quot;,&#10;                                                                                                                    rconfig.outstandingaction AS &quot;OutstandingAction&quot;,&#10;                                                                                                                    rconfig.establishment AS &quot;Establishment&quot;,&#10;                                                                                                                    rconfig.faxnumber AS &quot;FaxNumber&quot;,&#10;                                                                                                                    rconfig.buildingname AS &quot;BuildingName&quot;,&#10;                                                                                                                    rconfig.housenumber AS &quot;HouseNumber&quot;,&#10;                                                                                                                    rconfig.streetname AS &quot;StreetName&quot;,&#10;                                                                                                                    rconfig.district AS &quot;District&quot;,&#10;                                                                                                                    rconfig.towncity AS &quot;TownCity&quot;,&#10;                                                                                                                    rconfig.county AS &quot;County&quot;,&#10;                                                                                                                    rconfig.postcode AS &quot;Postcode&quot;,&#10;                                                                                                                    rconfig.telephonenumber AS &quot;TelephoneNumber&quot;,&#10;                                                                                                                    rconfig.activeduplicates AS &quot;ActiveDuplicates&quot;,&#10;                                                                                                                    rconfig.offenderlevel AS &quot;OffenderLevel&quot;,&#10;                                                                                                                    rconfig.eventlevel AS &quot;EventLevel&quot;,&#10;                                                                                                                    rconfig.allowactiveduplicates AS &quot;AllowActiveDuplicates&quot;,&#10;                                                                                                                    rconfig.allowinactiveduplicates AS &quot;AllowInactiveDuplicates&quot;,&#10;                                                                                                                    rconfig.autostart AS &quot;AutoStart&quot;,&#10;                                                                                                                    &#39; || xsd_tag_introduced_since(&#39;0-9-11&#39;, MessageVersionNumber_in, &#39;rconfig.SubTypeChange AS &quot;SubTypeChange&quot;,&#39;) || &#39;&#10;                                                                                                                    rconfig.recordcategory AS &quot;RecordCategory&quot;,&#10;                                                                                                                    rconfig.recordlevel AS &quot;RecordLevel&quot;,&#10;                                                                                                                    rconfig.registerreviewperiod AS &quot;RegisterReviewPeriod&quot;,&#10;                                                                                                                    rconfig.parentorganisation AS &quot;ParentOrganisation&quot;,&#10;                                                                                                                    rconfig.parentname AS &quot;ParentName&quot;,&#10;                                                                                                                    rconfig.country AS &quot;Country&quot;,&#10;                                                                                                                    rconfig.courttype AS &quot;CourtType&quot;,&#10;                                                                                                                    rconfig.securemailaddress AS &quot;SecureMailAddress&quot;,&#10;                                                                                                                    rconfig.registerlevelrequired AS &quot;RegisterLevelRequired&quot;,&#10;                                                                                                                    rconfig.registercategoryrequired AS &quot;RegisterCategoryRequired&quot;,&#10;                                                                                                                    rconfig.sentencetype AS &quot;SentenceType&quot;,&#10;                                                                                                                    rconfig.pssapplies AS &quot;PSSApplies&quot;,&#10;                                                                                                                    rconfig.immigrationremovalcentre AS &quot;ImmigrationRemovalCentre&quot;,&#10;                                                                                                                    rconfig.ratecardflag AS &quot;RateCardFlag&quot;&#10;                                                                                                                    &#39; || xsd_tag_introduced_since(&#39;0-9-11&#39;, MessageVersionNumber_in, &#39;,rconfig.OGRSOffenceCategory AS &quot;OGRSOffenceCategory&quot;&#39;) || &#39;&#10;&#10;                                                                                                                  )&#10;                                                                                                      ) END&#10;&#10;&#10;                                                                                          )&#10;                                                                            )&#10;                                                                      FROM spg_nsrd rconfig&#10;                                                                      WHERE rconfig.domain &#61; spg_nsrd_list.domain&#39;&#10;&#10;                                                                      || CASE WHEN rdtype_in &lt;&gt; &#39;NONSTANDARD&#39; AND uniqueid_in IS NOT NULL THEN &#39; AND rconfig.uniqueid &#61; &#39; || uniqueid_in END ||&#10;&#10;                                                                      &#39;&#10;                                                                    )&#10;                                                                    )&#10;                                                                    )&#10;                                                          )&#10;                                                )&#10;                                    ),&#10;                  &#39; ||&#10;                  get_message_trailer (&#10;                                      messagereferencenumber_in   &#61;&gt; messagereferencenumber_in&#10;                                      ) || &#39;&#10;                ),&#10;                &#39; ||&#10;                get_interchange_trailer (&#10;                                        senderidentity_in           &#61;&gt; senderidentity_in,&#10;                                        receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                                        sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                                        receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                                        controlcount_in             &#61;&gt; controlcount_in&#10;                                        )|| &#39;&#10;                ) AS xml_xsql_nsrd&#10;              /*  , version &#39;&#39;1.0&quot; encoding&#61;&quot;UTF-8&#39;&#39; ) */&#10;&#10;FROM   spg_nsrd_list&#39;&#10;|| CASE WHEN rdtype_in &lt;&gt; &#39;NONSTANDARD&#39; THEN &#39; WHERE UPPER(spg_nsrd_list.business_interaction_code) &#61; &#39;&#39;&#39; || UPPER(rdtype_in) || &#39;&#39;&#39;&#39; END;&#10;&#10;    --&#10;    RETURN l_xsql;&#10;    --&#10;END get_nsrd_xsql;&#10;--&#10;--&#10;FUNCTION get_rd_xsql (&#10;    rdtype_in                   IN VARCHAR2 DEFAULT &#39;STANDARD&#39;,&#10;    uniqueid_in                 IN NUMBER DEFAULT NULL,&#10;    versionnumber_in            IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    schemadate_in               IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in         IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in        IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in     IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in            IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in             IN INTEGER DEFAULT 1,&#10;    messagetype_in              IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in     IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in   IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in  IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_rd_xsql     CLOB;&#10;BEGIN&#10;    IF rdtype_in &#61; &#39;STANDARD&#39; THEN&#10;        l_rd_xsql :&#61; get_srd_xsql (&#10;                          versionnumber_in            &#61;&gt; versionnumber_in,&#10;                          uniqueid_in                 &#61;&gt; uniqueid_in,&#10;                          schemadate_in               &#61;&gt; schemadate_in,&#10;                          senderidentity_in           &#61;&gt; senderidentity_in,&#10;                          receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                          sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                          receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                          dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                          applicationreference_in     &#61;&gt; applicationreference_in,&#10;                          testindicator_in            &#61;&gt; testindicator_in,&#10;                          controlcount_in             &#61;&gt; controlcount_in,&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                      );&#10;    ELSE&#10;        l_rd_xsql :&#61; get_nsrd_xsql (&#10;                          versionnumber_in            &#61;&gt; versionnumber_in,&#10;                          rdtype_in                   &#61;&gt; rdtype_in,&#10;                          uniqueid_in                 &#61;&gt; uniqueid_in,&#10;                          schemadate_in               &#61;&gt; schemadate_in,&#10;                          senderidentity_in           &#61;&gt; senderidentity_in,&#10;                          receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                          sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                          receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                          dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                          applicationreference_in     &#61;&gt; applicationreference_in,&#10;                          testindicator_in            &#61;&gt; testindicator_in,&#10;                          controlcount_in             &#61;&gt; controlcount_in,&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                      );&#10;    END IF;&#10;    --&#10;    RETURN l_rd_xsql;&#10;    --&#10;END get_rd_xsql;&#10;--&#10;--&#10;FUNCTION get_rd_msg   (&#10;    rdtype_in                   IN VARCHAR2 DEFAULT &#39;STANDARD&#39;,&#10;    uniqueid_in                 IN NUMBER DEFAULT NULL,&#10;    versionnumber_in            IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    schemadate_in               IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in         IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in        IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in     IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in            IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in             IN INTEGER DEFAULT 1,&#10;    messagetype_in              IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in     IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in   IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in  IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xml_msg   XMLTYPE;&#10;    l_xsql      CLOB;&#10;BEGIN&#10;    --&#10;    l_xsql  :&#61; get_rd_xsql (&#10;                          rdtype_in                   &#61;&gt; rdtype_in,&#10;                          uniqueid_in                 &#61;&gt; uniqueid_in,&#10;                          versionnumber_in            &#61;&gt; versionnumber_in,&#10;                          schemadate_in               &#61;&gt; schemadate_in,&#10;                          senderidentity_in           &#61;&gt; senderidentity_in,&#10;                          receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                          sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                          receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                          dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                          applicationreference_in     &#61;&gt; applicationreference_in,&#10;                          testindicator_in            &#61;&gt; testindicator_in,&#10;                          controlcount_in             &#61;&gt; controlcount_in,&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                        );&#10;    --&#10;    EXECUTE IMMEDIATE l_xsql INTO l_xml_msg;&#10;    --&#10;    RETURN PKG_LstUtl.concat_CLOB( &#39;&lt;?xml version&#61;&quot;1.0&quot; encoding&#61;&quot;UTF-8&quot;?&gt;&#39;, l_xml_msg.getCLOBVAL(), p_delim&#61;&gt;CHR(10) );&#10;    --&#10;END get_rd_msg;&#10;--&#10;--&#10;FUNCTION get_linkedlist_xsql (&#10;    groupname_in                  IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    versionnumber_in              IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    uniqueid_in                   IN NUMBER DEFAULT NULL,&#10;    schemadate_in                 IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in             IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receiveridentity_in           IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    sendercontrolreference_in     IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    receivercontrolreference_in   IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    dateofpreparation_in          IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in       IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    testindicator_in              IN VARCHAR2 DEFAULT &#39;a&#39;,&#10;    controlcount_in               IN INTEGER DEFAULT 1,&#10;    messagetype_in                IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in       IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in     IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in    IN VARCHAR2 DEFAULT &#39;a&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xsql    CLOB;&#10;BEGIN&#10;    l_xsql :&#61;&#10;&#39;&#10;SELECT&#10;    /*XMLROOT(*/&#10;      XMLELEMENT(name &quot;SPGInterchange&quot;,&#10;      &#39; ||&#10;      get_root_attributes (&#10;                            versionnumber_in  &#61;&gt; versionnumber_in,&#10;                            schemadate_in     &#61;&gt; schemadate_in&#10;                          ) || &#39;,&#10;      &#39;||&#10;      get_interchange_header  (&#10;                              senderidentity_in           &#61;&gt; senderidentity_in,&#10;                              receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                              sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                              receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                              dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                              applicationreference_in     &#61;&gt; applicationreference_in,&#10;                              testindicator_in            &#61;&gt; testindicator_in&#10;                              ) || &#39;,&#10;      &#39;||&#10;      get_message_header  (&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                          ) || &#39;,&#10;&#10;                          XMLELEMENT( &quot;ReferenceDataLinkedList&quot;,&#10;                                    XMLAGG(&#10;                                    XMLELEMENT( name &quot;LinkedListGroup&quot;,&#10;                                                XMLFOREST(&#10;                                                          slla.groupname AS &quot;LinkedListGroupName&quot;,&#10;                                                          (SELECT XMLAGG(&#10;                                                                  XMLELEMENT( &quot;LinkedListGroupItem&quot;,&#10;                                                                              XMLFOREST (&#10;                                                                                          sll.domainname1 AS &quot;DomainName1&quot;,&#10;                                                                                          sll.code1       AS &quot;Code1&quot;,&#10;                                                                                          sll.code2       AS &quot;Code2&quot;,&#10;                                                                                          sll.domainname2 AS &quot;DomainName2&quot;&#10;                                                                                        )&#10;                                                                            )&#10;                                                                          )&#10;                                                          FROM spg_linked_list sll&#10;                                                          WHERE sll.groupname &#61; slla.groupname&#10;                                                            AND sll.code2 &lt;&gt; &#39;&#39;EMPTY_RECORDS_SET&#39;&#39;&#39; ||&#10;                                              CASE WHEN groupname_in &lt;&gt; &#39;ALL&#39; AND uniqueid_in IS NOT NULL THEN&#10;                                                          &#39; AND sll.unique_id &#61; &#39; || uniqueid_in&#10;                                              END || &#39;&#10;                                                          ) &quot;LinkedListGroupItems&quot;&#10;                                                        )&#10;                                              )&#10;                                          )&#10;                                    ),&#10;                  &#39; ||&#10;                  get_message_trailer (&#10;                                      messagereferencenumber_in   &#61;&gt; messagereferencenumber_in&#10;                                      ) || &#39;&#10;                ),&#10;                &#39; ||&#10;                get_interchange_trailer (&#10;                                        senderidentity_in           &#61;&gt; senderidentity_in,&#10;                                        receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                                        sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                                        receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                                        controlcount_in             &#61;&gt; controlcount_in&#10;                                        ) || &#39;&#10;                ) AS xml_xsql_lnk_lst&#10;           /*, version &#39;&#39;1.0&quot; encoding&#61;&quot;UTF-8&#39;&#39;     )*/&#10;&#10;FROM spg_linked_list_agg slla&#10;WHERE 1&#61;1&#10;  &#39; || CASE WHEN groupname_in &lt;&gt; &#39;ALL&#39; THEN &#39;AND UPPER(slla.bi_code) &#61; &#39;&#39;&#39; || UPPER(groupname_in) || &#39;&#39;&#39;&#39; ELSE &#39;--&#39; END || &#39;&#10;  --DST-1058: LLBI039 and LLBI040 should now be included for all XSD versions&#10;  --&#39; || xsd_tag_valid_until(&#39;0-9-10&#39;, MessageVersionNumber_in, &#39;AND bi_code NOT IN (&#39;&#39;LLBI039&#39;&#39;, &#39;&#39;LLBI040&#39;&#39;) &#39;) || &#39;&#10;  --&#39;;&#10;    --&#10;    RETURN l_xsql;&#10;    --&#10;END get_linkedlist_xsql;&#10;--&#10;--&#10;FUNCTION get_linkedlist_msg   (&#10;    groupname_in                IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    uniqueid_in                 IN NUMBER DEFAULT NULL,&#10;    versionnumber_in            IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    schemadate_in               IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in         IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in        IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in     IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in            IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in             IN INTEGER DEFAULT 1,&#10;    messagetype_in              IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in     IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in   IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in  IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xml_msg   XMLTYPE;&#10;    l_xsql      CLOB;&#10;BEGIN&#10;    --&#10;    l_xsql  :&#61; get_linkedlist_xsql (&#10;                          groupname_in                &#61;&gt; groupname_in,&#10;                          uniqueid_in                 &#61;&gt; uniqueid_in,&#10;                          versionnumber_in            &#61;&gt; versionnumber_in,&#10;                          schemadate_in               &#61;&gt; schemadate_in,&#10;                          senderidentity_in           &#61;&gt; senderidentity_in,&#10;                          receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                          sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                          receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                          dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                          applicationreference_in     &#61;&gt; applicationreference_in,&#10;                          testindicator_in            &#61;&gt; testindicator_in,&#10;                          controlcount_in             &#61;&gt; controlcount_in,&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                        );&#10;    --&#10;    --procDebug(&#39;SPGMessage.get_linkedlist_msg: XSQL&#61;&#39; || CHR(10) || l_xsql);&#10;    --procDebug(&#39;SPGMessage.get_linkedlist_msg: XML&#61;&#39;  || CHR(10) || PKG_LstUtl.concat_CLOB( &#39;&lt;?xml version&#61;&quot;1.0&quot; encoding&#61;&quot;UTF-8&quot;?&gt;&#39;, l_xml_msg.getCLOBVAL(), p_delim&#61;&gt;CHR(10) ));&#10;    --&#10;    EXECUTE IMMEDIATE l_xsql INTO l_xml_msg;&#10;    --&#10;    RETURN PKG_LstUtl.concat_CLOB( &#39;&lt;?xml version&#61;&quot;1.0&quot; encoding&#61;&quot;UTF-8&quot;?&gt;&#39;, l_xml_msg.getCLOBVAL(), p_delim&#61;&gt;CHR(10) );&#10;    --&#10;END get_linkedlist_msg;&#10;--&#10;--&#10;FUNCTION get_del_msg_xsql (&#10;    spgnotificationid_in          IN NUMBER,&#10;    versionnumber_in              IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    schemadate_in                 IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in             IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in     IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in          IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in       IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in              IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in               IN INTEGER DEFAULT 1,&#10;    messagetype_in                IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in       IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in     IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in    IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xsql            CLOB;&#10;    l_message_id      NUMBER;&#10;    x_message_id      NUMBER;&#10;    l_unique_id       SPG_NOTIFICATION.unique_id%TYPE;&#10;    l_delete_elements PKG_SPG_SUPPORT.delete_elements_tab_TYP;&#10;BEGIN&#10;    --&#10;    SELECT BIXM.root_xml_message_id, sn.unique_id INTO l_message_id, l_unique_id&#10;    FROM&#10;      spg_notification sn&#10;        INNER JOIN business_int_xml_map BIXM ON SN.business_interaction_id &#61; BIXM.business_interaction_id AND BIXM.xsd_number &#61; NVL(SPGMESSAGE.GC_SCHEMA_NUMBER, 1)&#10;    WHERE spg_notification_id &#61; spgnotificationid_in;&#10;    --&#10;    -- Translate Custody*Undo message ID into their Event* parent message ID&#10;    x_message_id :&#61; ( CASE WHEN l_message_id IN (2022, 2023, 2024, 1023)&#10;                          THEN 1008&#10;                          ELSE l_message_id&#10;                      END );&#10;    --&#10;    l_delete_elements :&#61; PKG_SPG_SUPPORT.get_delete_elements(xmlmessageid_in &#61;&gt; l_message_id);&#10;    --&#10;    l_xsql :&#61;&#10;&#39;SELECT&#10;    /*XMLROOT(*/&#10;      XMLELEMENT(name &quot;SPGInterchange&quot;,&#10;      &#39; ||&#10;      get_root_attributes (&#10;                            versionnumber_in  &#61;&gt; versionnumber_in,&#10;                            schemadate_in     &#61;&gt; schemadate_in&#10;                          ) || &#39;,&#10;      &#39;||&#10;      get_interchange_header  (&#10;                              senderidentity_in           &#61;&gt; senderidentity_in,&#10;                              receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                              sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                              receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                              dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                              applicationreference_in     &#61;&gt; applicationreference_in,&#10;                              testindicator_in            &#61;&gt; testindicator_in&#10;                              ) || &#39;,&#10;      &#39;||&#10;      get_message_header  (&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                          ) || &#39;,&#10;&#10;                  XMLELEMENT (name &quot;&#39; || l_delete_elements(1).message_name || &#39;&quot;,&#10;                                XMLELEMENT  (name &quot;&#39; || l_delete_elements(1).root_element_name || &#39;&quot;,&#10;                                              XMLELEMENT(name &quot;Offender&quot;,&#10;                                                          XMLELEMENT(name &quot;&#39; || l_delete_elements(1).xml_field_name || &#39;&quot;, offender.crn)&#10;                                                        ),&#10;                                              XMLELEMENT(name &quot;SPGVersion&quot;,&#10;                                                          XMLELEMENT(name &quot;&#39; || l_delete_elements(2).xml_field_name || &#39;&quot;, PKG_SPG_SUPPORT.get_guid_value(&#39; || x_message_id || &#39;,&#39; || l_unique_id || &#39;)),&#10;                                                          XMLELEMENT(name &quot;&#39; || l_delete_elements(3).xml_field_name || &#39;&quot;, PKG_SPG_SUPPORT.get_username_value(&#39; || x_message_id || &#39;,&#39; || l_unique_id || &#39;))&#10;                                                                    ),&#10;                                              XMLELEMENT(name &quot;&#39; || l_delete_elements(1).group_element_name || &#39;&quot;,&#10;                                                          XMLELEMENT(name &quot;&#39; || l_delete_elements(4).xml_field_name || &#39;&quot;, spg_notification.unique_id),&#10;                                                          XMLELEMENT(name &quot;&#39; || l_delete_elements(5).xml_field_name || &#39;&quot;, spg_notification.offender_id)&#10;                                                        )&#10;                                            )&#10;                              ),&#10;&#10;          &#39; ||&#10;      get_message_trailer (&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in&#10;                          ) || &#39;&#10;      ),&#10;      &#39; ||&#10;      get_interchange_trailer (&#10;                              senderidentity_in           &#61;&gt; senderidentity_in,&#10;                              receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                              sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                              receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                              controlcount_in             &#61;&gt; controlcount_in&#10;                              ) || &#39;&#10;        )&#10;   /*, version &#39;&#39;1.0&quot; encoding&#61;&quot;UTF-8&#39;&#39;     )*/&#10;&#10;FROM   spg_notification&#10;INNER JOIN offender&#10;ON spg_notification.offender_id &#61; offender.offender_id&#10;WHERE spg_notification_id &#61; &#39; || spgnotificationid_in;&#10;    --&#10;    RETURN l_xsql;&#10;    --&#10;END get_del_msg_xsql;&#10;--&#10;FUNCTION get_del_msg  (&#10;    spgnotificationid_in          IN NUMBER,&#10;    versionnumber_in              IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    schemadate_in                 IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in             IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in     IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in          IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in       IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in              IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in               IN INTEGER DEFAULT 1,&#10;    messagetype_in                IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in       IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in     IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in    IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xml_msg   XMLTYPE;&#10;    l_xsql      CLOB;&#10;BEGIN&#10;    --&#10;    l_xsql  :&#61; get_del_msg_xsql (&#10;                          spgnotificationid_in        &#61;&gt; spgnotificationid_in,&#10;                          versionnumber_in            &#61;&gt; versionnumber_in,&#10;                          schemadate_in               &#61;&gt; schemadate_in,&#10;                          senderidentity_in           &#61;&gt; senderidentity_in,&#10;                          receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                          sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                          receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                          dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                          applicationreference_in     &#61;&gt; applicationreference_in,&#10;                          testindicator_in            &#61;&gt; testindicator_in,&#10;                          controlcount_in             &#61;&gt; controlcount_in,&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                        );&#10;    --&#10;    EXECUTE IMMEDIATE l_xsql INTO l_xml_msg;&#10;    --&#10;    RETURN PKG_LstUtl.concat_CLOB( &#39;&lt;?xml version&#61;&quot;1.0&quot; encoding&#61;&quot;UTF-8&quot;?&gt;&#39;, l_xml_msg.getCLOBVAL(), p_delim&#61;&gt;CHR(10) );&#10;    --&#10;END get_del_msg;&#10;--&#10;--&#10;FUNCTION get_alfresco_permission_xsql (&#10;    versionnumber_in              IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    offenderid_in                 IN NUMBER DEFAULT NULL,&#10;    schemadate_in                 IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in             IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in     IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in          IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in       IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in              IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in               IN INTEGER DEFAULT 1,&#10;    messagetype_in                IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in       IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in     IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in    IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xsql    CLOB;&#10;BEGIN&#10;    l_xsql :&#61;&#10;&#39;&#10;SELECT&#10;    /*XMLROOT(*/&#10;      XMLELEMENT(name &quot;SPGInterchange&quot;,&#10;      &#39; ||&#10;      get_root_attributes (&#10;                            versionnumber_in  &#61;&gt; versionnumber_in,&#10;                            schemadate_in     &#61;&gt; schemadate_in&#10;                          ) || &#39;,&#10;      &#39;||&#10;      get_interchange_header  (&#10;                              senderidentity_in           &#61;&gt; senderidentity_in,&#10;                              receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                              sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                              receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                              dateofpreparation_in        &#61;&gt; dateofpreparation_in,&#10;                              applicationreference_in     &#61;&gt; applicationreference_in,&#10;                              testindicator_in            &#61;&gt; testindicator_in&#10;                              ) || &#39;,&#10;      &#39;||&#10;      get_message_header  (&#10;                          messagetype_in              &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in     &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in   &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in  &#61;&gt; messagerecordidentifier_in&#10;                          ) || &#39;,&#10;&#10;                          XMLELEMENT  (name &quot;AlfrescoPermissions&quot;,&#10;                                        XMLELEMENT  (name &quot;OffenderPermissions&quot;,&#10;                                                      XMLAGG  (&#10;                                                                XMLELEMENT  (name &quot;Offender&quot;, XMLATTRIBUTES(crn AS &quot;CaseReferenceNumber&quot;),&#10;                                                                              (SELECT  XMLAGG (&#10;                                                                                                XMLELEMENT  (name &quot;Area&quot;, XMLATTRIBUTES(area_code AS &quot;ProviderCode&quot;),&#10;                                                                                                            XMLELEMENT  (name &quot;Permissions&quot;,&#10;                                                                                                                          XMLELEMENT(name &quot;Level1Value&quot;, level1_value),&#10;                                                                                                                          XMLELEMENT(name &quot;Level2Value&quot;, level2_value),&#10;                                                                                                                          XMLELEMENT(name &quot;Level3Value&quot;, level3_value),&#10;                                                                                                                          XMLELEMENT(name &quot;AlfrescoValue&quot;, alfresco_value)&#10;                                                                                                                        )&#10;                                                                                                            )&#10;                                                                                              )&#10;&#10;                                                                              FROM TABLE(ALFRESCOSUPPORT.get_alfresco_permissions(offender.offender_id))&#10;&#10;                                                                              )&#10;                                                                            )&#10;                                                                )&#10;                                                      )&#10;                                      ),&#10;                  &#39; ||&#10;                  get_message_trailer (&#10;                                      messagereferencenumber_in   &#61;&gt; messagereferencenumber_in&#10;                                      ) || &#39;&#10;                ),&#10;                &#39; ||&#10;                get_interchange_trailer (&#10;                                        senderidentity_in           &#61;&gt; senderidentity_in,&#10;                                        receiveridentity_in         &#61;&gt; receiveridentity_in,&#10;                                        sendercontrolreference_in   &#61;&gt; sendercontrolreference_in,&#10;                                        receivercontrolreference_in &#61;&gt; receivercontrolreference_in,&#10;                                        controlcount_in             &#61;&gt; controlcount_in&#10;                                        ) || &#39;&#10;                )&#10;           /*, version &#39;&#39;1.0&quot; encoding&#61;&quot;UTF-8&#39;&#39;     )*/&#10;&#10;FROM offender&#10;WHERE offender.offender_id &#61; :offenderid_in&#39;;&#10;    --&#10;    RETURN l_xsql;&#10;    --&#10;END get_alfresco_permission_xsql;&#10;--&#10;--&#10;FUNCTION get_alfresco_permission_msg   (&#10;    versionnumber_in              IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    offenderid_in                 IN NUMBER DEFAULT NULL,&#10;    schemadate_in                 IN VARCHAR2 DEFAULT GC_SCHEMA_DATE,&#10;    senderidentity_in             IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    receiveridentity_in           IN VARCHAR2 DEFAULT &#39;ALL&#39;,&#10;    sendercontrolreference_in     IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    receivercontrolreference_in   IN VARCHAR2 DEFAULT &#39;999999&#39;,&#10;    dateofpreparation_in          IN DATE DEFAULT SYSDATE,&#10;    applicationreference_in       IN VARCHAR2 DEFAULT &#39;NDELIUS&#39;,&#10;    testindicator_in              IN VARCHAR2 DEFAULT &#39;N&#39;,&#10;    controlcount_in               IN INTEGER DEFAULT 1,&#10;    messagetype_in                IN VARCHAR2 DEFAULT GC_REF_MSG_TYPE,&#10;    messageversionnumber_in       IN VARCHAR2 DEFAULT GC_SCHEMA_VERSION,&#10;    messagereferencenumber_in     IN INTEGER DEFAULT 99999999999999,&#10;    messagerecordidentifier_in    IN VARCHAR2 DEFAULT &#39;1&#39; )&#10;RETURN CLOB&#10;IS&#10;    l_xml_msg   XMLTYPE;&#10;    l_xsql      CLOB;&#10;BEGIN&#10;    --&#10;    l_xsql  :&#61; get_alfresco_permission_xsql (&#10;                          versionnumber_in              &#61;&gt; versionnumber_in,&#10;                          offenderid_in                 &#61;&gt; offenderid_in,&#10;                          schemadate_in                 &#61;&gt; schemadate_in,&#10;                          senderidentity_in             &#61;&gt; senderidentity_in,&#10;                          receiveridentity_in           &#61;&gt; receiveridentity_in,&#10;                          sendercontrolreference_in     &#61;&gt; sendercontrolreference_in,&#10;                          receivercontrolreference_in   &#61;&gt; receivercontrolreference_in,&#10;                          dateofpreparation_in          &#61;&gt; dateofpreparation_in,&#10;                          applicationreference_in       &#61;&gt; applicationreference_in,&#10;                          testindicator_in              &#61;&gt; testindicator_in,&#10;                          controlcount_in               &#61;&gt; controlcount_in,&#10;                          messagetype_in                &#61;&gt; messagetype_in,&#10;                          messageversionnumber_in       &#61;&gt; messageversionnumber_in,&#10;                          messagereferencenumber_in     &#61;&gt; messagereferencenumber_in,&#10;                          messagerecordidentifier_in    &#61;&gt; messagerecordidentifier_in&#10;                        );&#10;    --&#10;    EXECUTE IMMEDIATE l_xsql  INTO l_xml_msg USING offenderid_in;&#10;    --&#10;    RETURN PKG_LstUtl.concat_CLOB( &#39;&lt;?xml version&#61;&quot;1.0&quot; encoding&#61;&quot;UTF-8&quot;?&gt;&#39;, l_xml_msg.getCLOBVAL(), p_delim&#61;&gt;CHR(10) );&#10;    --&#10;END get_alfresco_permission_msg;&#10;--&#10;&#10;--&#10;--&#10;-- SPG Outbound Messages Processing subroutines&#10;--&#10;PROCEDURE broadcast_message(spg_notification_id_in IN NUMBER)&#10;IS&#10;    l_sender_identity_id      PROBATION_AREA.probation_area_id%TYPE;&#10;    l_business_interaction_id BUSINESS_INTERACTION.business_interaction_id%TYPE;&#10;    l_unique_id               SPG_NOTIFICATION.unique_id%TYPE;&#10;    l_offender_id             NUMBER;&#10;BEGIN&#10;    l_sender_identity_id :&#61; SPGCONFIG.get_default_sender_id;&#10;    --&#10;    SELECT business_interaction_id, unique_id, offender_id INTO l_business_interaction_id, l_unique_id, l_offender_id&#10;    FROM spg_notification&#10;    WHERE spg_notification_id &#61; spg_notification_id_in;&#10;    --&#10;    FOR PO IN ( SELECT pa.probation_area_id, pa.code, broadcast_ref_data, broadcast_offender_data&#10;                FROM probation_area pa&#10;                INNER JOIN r_standard_reference_list rs&#10;                ON pa.spg_active_id &#61; rs.standard_reference_list_id&#10;                AND rs.code_value IN (&#39;A&#39;,&#39;T&#39;)&#10;                WHERE pa.selectable &#61; &#39;Y&#39;&#10;                AND pa.private &#61; 1)&#10;    LOOP&#10;        IF  ((PKG_LOOKUPS.isreferencedatabi(p_business_interaction_id &#61;&gt; l_business_interaction_id) &#61; &#39;TRUE&#39; AND PO.broadcast_ref_data &#61; 1)&#10;            OR&#10;            (PKG_LOOKUPS.isreferencedatabi(p_business_interaction_id &#61;&gt; l_business_interaction_id) &#61; &#39;FALSE&#39; AND PO.broadcast_offender_data &#61; 1)) THEN&#10;          INSERT INTO spg_notification (  spg_notification_id,&#10;                                          business_interaction_id,&#10;                                          unique_id,&#10;                                          offender_id,&#10;                                          date_created,&#10;                                          control_reference,&#10;                                          sender_identity_id,&#10;                                          receiver_identity_id,&#10;                                          message_direction)&#10;          VALUES (  spg_notification_id_seq.NEXTVAL,&#10;                    l_business_interaction_id,&#10;                    l_unique_id,&#10;                    l_offender_id,&#10;                    SYSDATE,&#10;                    SPGCONFIG.getNextControlReference(SPGCONFIG.get_default_sender_code),&#10;                    l_sender_identity_id ,&#10;                    PO.probation_area_id,&#10;                    &#39;O&#39; );&#10;        END IF;&#10;    END LOOP;&#10;    --&#10;    UPDATE spg_notification SET&#10;      processed_flag     &#61; 1,&#10;      processed_datetime &#61; SYSDATE,&#10;      message_id         &#61; &#39;BROADCAST&#39;,&#10;      row_version        &#61; row_version + 1&#10;    WHERE spg_notification_id &#61; spg_notification_id_in;&#10;    --&#10;    COMMIT;&#10;    --&#10;END broadcast_message;&#10;--&#10;PROCEDURE retry_msg(&#10;    x_spg_notification_id IN OUT NUMBER,&#10;    p_new_record_flag     VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_force_flag          VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    CURSOR cs IS&#10;      SELECT&#10;        S.business_interaction_id,&#10;        S.offender_id,&#10;        S.unique_id,&#10;        S.sender_identity_id,&#10;        S.receiver_identity_id,&#10;        S.message_direction,&#10;        NVL(PA.code, &#39;N00&#39;) AS sender_identity_code,&#10;        S.receiver_control_reference,&#10;        S.spg_message_context_id&#10;      FROM&#10;        spg_notification S&#10;          LEFT OUTER JOIN probation_area PA ON PA.probation_area_id &#61; S.sender_identity_id&#10;      WHERE spg_notification_id &#61; x_spg_notification_id;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    l_found_flag              BOOLEAN;&#10;    l_spg_notification_id     NUMBER;&#10;    l_control_reference       SPG_NOTIFICATION.control_reference%TYPE;&#10;    --&#10;    PRAGMA AUTONOMOUS_TRANSACTION;&#10;    --&#10;BEGIN&#10;    g_procedure_name :&#61; &#39;retry_msg&#39;;&#10;    g_label :&#61; &#39;260000&#39;;&#10;    --&#10;    IF NVLSTR(p_new_record_flag, &#39;Y&#39;) &#61; &#39;Y&#39; THEN&#10;        --&#10;        OPEN cs;&#10;        FETCH cs INTO l_rec;&#10;        l_found_flag :&#61; cs%FOUND;&#10;        CLOSE cs;&#10;        --&#10;        g_label :&#61; &#39;260010&#39;;&#10;        IF l_found_flag THEN&#10;            --&#10;            g_label :&#61; &#39;260020&#39;;&#10;            --&#10;            l_control_reference :&#61; SPGConfig.getNextControlReference(l_rec.sender_identity_code);&#10;            --&#10;            INSERT INTO spg_notification(&#10;              spg_notification_id,&#10;              business_interaction_id,&#10;              offender_id,&#10;              unique_id,&#10;              date_created,&#10;              sender_identity_id,&#10;              receiver_identity_id,&#10;              message_direction,&#10;              receiver_control_reference,&#10;              spg_message_context_id,&#10;              control_reference&#10;            ) VALUES (&#10;              spg_notification_id_seq.NEXTVAL,&#10;              l_rec.business_interaction_id,&#10;              l_rec.offender_id,&#10;              l_rec.unique_id,&#10;              SYSDATE,&#10;              l_rec.sender_identity_id,&#10;              l_rec.receiver_identity_id,&#10;              l_rec.message_direction,&#10;              l_rec.receiver_control_reference,&#10;              l_rec.spg_message_context_id,&#10;              l_control_reference )&#10;            RETURNING spg_notification_id INTO l_spg_notification_id;&#10;            --&#10;            g_label :&#61; &#39;260030&#39;;&#10;            COMMIT;&#10;            info(&#39;Retrying message &#39; || x_spg_notification_id || &#39; as &#39; || l_spg_notification_id);&#10;            --&#10;            x_spg_notification_id :&#61; l_spg_notification_id;&#10;            --&#10;        ELSE&#10;            g_label :&#61; &#39;260040&#39;;&#10;            warn(&#39;Warning: spg_notification_id [&#39; || x_spg_notification_id || &#39;] does not exist&#39;);&#10;        END IF;&#10;    ELSE&#10;        --&#10;        UPDATE spg_notification SET&#10;          processed_flag     &#61; 2,&#10;          error_flag         &#61; 0,&#10;          --&#10;          processed_datetime &#61; SYSDATE,&#10;          message_id         &#61; ( CASE WHEN message_id &#61; &#39;PENDING&#39; THEN NULL ELSE message_id END ),&#10;          error_message      &#61; PKG_LstUtl.concat_CLOB(error_message, &#39;re-sumbitted at &#39; || TO_CHAR(SYSDATE, &#39;YYYYMMDD HH24:MI:SS&#39;), p_delim &#61;&gt; CHR(10)),&#10;          --&#10;          sender_identity_id &#61; NVL( sender_identity_id,&#10;                                    PKG_Lookups.funcgetTabRecord_CACHED(&#10;                                        p_table    &#61;&gt; &#39;PROBATION_AREA&#39;,&#10;                                        p_ref_col  &#61;&gt; &#39;code&#39;,&#10;                                        p_ref_val  &#61;&gt; &#39;N00&#39;,&#10;                                        p_data_fld &#61;&gt; &#39;probation_area_id&#39; ) ),&#10;          --&#10;          mt_component_id &#61; CASE WHEN SPGConfig.SPGMultiThreadActive_C &#61; &#39;N&#39; THEN NULL ELSE mt_component_id END,&#10;          mt_thread_id    &#61; CASE WHEN SPGConfig.SPGMultiThreadActive_C &#61; &#39;N&#39; THEN NULL ELSE mt_thread_id    END&#10;          --&#10;        WHERE spg_notification_id &#61; x_spg_notification_id&#10;          --AND processed_flag &#61; 1&#10;          AND message_direction &#61; &#39;O&#39;&#10;          AND ( ( error_flag &#61; 1 AND processed_flag &#61; 1 ) OR&#10;                ( p_force_flag &#61; &#39;Y&#39;                    ) OR&#10;                ( SYSDATE - date_created &gt;&#61; 15 * 1/24/60 AND processed_flag &#61; 0 )&#10;              );&#10;        --&#10;        COMMIT;&#10;        --&#10;        UPDATE spg_notification SET&#10;          processed_flag &#61; 0&#10;        WHERE spg_notification_id &#61; x_spg_notification_id&#10;          AND message_direction &#61; &#39;O&#39;&#10;          AND processed_flag &#61; 2;&#10;        --&#10;        IF SQL%ROWCOUNT &#61; 1 THEN&#10;            info(&#39;Re-submit message &#39; || x_spg_notification_id );&#10;        ELSE&#10;            warn(&#39;Warning: spg_notification_id [&#39; || x_spg_notification_id || &#39;] does not exist&#39;);&#10;        END IF;&#10;        --&#10;        COMMIT;&#10;        --&#10;    END IF;&#10;    --&#10;--EXCEPTION WHEN OTHERS THEN&#10;--    SPGCONFIG.record_error_message(spgnotificationid_in, SQLERRM);&#10;--    fatal(SQLERRM);&#10;END retry_msg;&#10;--&#10;PROCEDURE retry_msg(&#10;    p_spgnotification_id_LST VARCHAR2,&#10;    p_force_flag             VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_lst                 VARCHAR2(32000);&#10;    l_elem                VARCHAR2(100);&#10;    l_spg_notification_id NUMBER;&#10;    --&#10;BEGIN&#10;    l_lst :&#61; TRIM(REPLACE(REPLACE(REPLACE(REPLACE(p_spgnotification_id_LST, CHR(9), &#39; &#39;), CHR(10), &#39;&#39;), CHR(13), 0), &#39; &#39;, &#39;&#39;));&#10;    LOOP&#10;        EXIT WHEN EMPTY2NULL(l_lst) IS NULL AND EMPTY2NULL(l_elem) IS NULL;&#10;        --&#10;        l_elem :&#61; TRIM(PKG_LstUtl.list_next_elem(l_lst, &#39;,&#39;));&#10;        --&#10;        IF SPGConfig.SPGInfoActive THEN&#10;            info(&#39;l_elem&#61;&#39; || l_elem );&#10;            info(&#39;l_LST&#61;&#39; || l_lst );&#10;        END IF;&#10;        --&#10;        IF EMPTY2NULL(l_elem) IS NOT NULL THEN&#10;            l_spg_notification_id :&#61; TO_NUMBER(l_elem);&#10;            retry_msg(&#10;                x_spg_notification_id &#61;&gt; l_spg_notification_id,&#10;                p_new_record_flag     &#61;&gt; &#39;N&#39;,&#10;                p_force_flag          &#61;&gt; p_force_flag );&#10;        END IF;&#10;        --&#10;        l_lst :&#61; TRIM(l_lst);&#10;    END LOOP;&#10;    --&#10;END retry_msg;&#10;--&#10;PROCEDURE enqueue_msg (&#10;    spg_notification_id_in  IN NUMBER,&#10;    interaction_datetime_in IN DATE,&#10;    interaction_code_in     IN business_interaction.business_interaction_code%TYPE,&#10;    offender_id_in          IN NUMBER,&#10;    grain_table_key_in      IN SPG_NOTIFICATION.unique_id%TYPE,&#10;    messageid_out           OUT SPG_NOTIFICATION.aq_message_id%TYPE)&#10;IS&#10;    --&#10;    l_user_data           spg_payload_type;&#10;--    l_enqueue_options     DBMS_AQ.enqueue_options_t;&#10;--    l_message_properties  DBMS_AQ.message_properties_t;&#10;    l_message_id          RAW(16);&#10;    --&#10;    l_q_name  CONSTANT VARCHAR2(30) :&#61; &#39;DELIUS_APP_SCHEMA.SPG_OUTBOUND&#39;;  -- No Linger Used&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;enqueue_msg&#39;;&#10;    g_label :&#61; &#39;100000&#39;;&#10;    --&#10;    IF SPGConfig.SPGInfoActive THEN&#10;        info(&#10;            &#39;[notification_id_in &#61;&gt; &#39;       || spg_notification_id_in   || &#39;]&#39; ||&#10;            &#39;[interaction_datetime_in &#61;&gt; &#39;  || interaction_datetime_in  || &#39;]&#39; ||&#10;            &#39;[interaction_code_in &#61;&gt; &#39;      || interaction_code_in      || &#39;]&#39; ||&#10;            &#39;[offender_id_in &#61;&gt; &#39;           || offender_id_in           || &#39;]&#39; ||&#10;            &#39;[grain_table_key_in &#61;&gt; &#39;       || grain_table_key_in       || &#39;]&#39; );&#10;    END IF;&#10;    --&#10;    --info(&#39;establish payload - begin&#39;);&#10;    l_user_data :&#61;&#10;        spg_payload_type(&#10;            spg_notification_id_in,&#10;            interaction_datetime_in,&#10;            interaction_code_in,&#10;            offender_id_in,&#10;            grain_table_key_in );&#10;    --info(&#39;establish payload - end&#39;);&#10;    --&#10;    g_label :&#61; &#39;100010&#39;;&#10;    IF SPGConfig.SPGMultiThreadActive THEN&#10;        -- YF TODO: check if OXML Master job is running or is scheduled to run&#10;        info(&#39;SPGConfig.SPGMultiThreadActive is set to TRUE&#39;);&#10;        /* YF: nDelius version does not require SPG_MESSAGE_EVENT_QUEUE table&#10;        INSERT INTO spg_message_event_queue(&#10;          spg_notification_id, message_payload&#10;        ) VALUES (&#10;          spg_notification_id_in, l_user_data )&#10;        RETURNING queue_uuid INTO l_message_id;&#10;        */&#10;        --&#10;    ELSE&#10;        raise_application_error(-20001, &#39;This Branch was removed in DST-10472&#39;);&#10;        /*  Removed in DST-10472&#10;        info(&#39;add payload to AQ - begin&#39;);&#10;        l_enqueue_options.VISIBILITY :&#61; DBMS_AQ.ON_COMMIT;&#10;        DBMS_AQ.enqueue(&#10;            queue_name          &#61;&gt; l_q_name,&#10;            enqueue_options     &#61;&gt; l_enqueue_options,&#10;            message_properties  &#61;&gt; l_message_properties,&#10;            payload             &#61;&gt; l_user_data,&#10;            msgid               &#61;&gt; l_message_id );&#10;        info(&#39;AQ MessageID &#61;&gt; &#39; || l_message_id );&#10;        info(&#39;add payload to AQ - end&#39;);&#10;        --&#10;        g_label :&#61; &#39;100020&#39;;&#10;        messageid_out :&#61; l_message_id;&#10;       */&#10;    END IF;&#10;    --&#10;    --info(&#39;end&#39;);&#10;    --&#10;END enqueue_msg;&#10;--&#10;--&#10;PROCEDURE check_new_alloc_offender_msg(&#10;    p_business_interaction_code BUSINESS_INTERACTION.business_interaction_code%TYPE,&#10;    p_spg_notification_id       NUMBER,&#10;    p_offender_id               NUMBER,&#10;    p_receiver_identity_id      NUMBER,&#10;    p_db_trigger_mode           VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_cnt PLS_INTEGER;&#10;    --&#10;BEGIN&#10;    IF p_business_interaction_code &#61; &#39;CABI020&#39; AND&#10;       p_offender_id          IS NOT NULL      AND&#10;       p_receiver_identity_id IS NOT NULL&#10;    THEN&#10;        --&#10;        SELECT COUNT(1) INTO l_cnt&#10;        FROM offender_crc_export&#10;        WHERE current_record_flag &#61; &#39;Y&#39;&#10;          AND error_flag &#61; 0&#10;          --AND submitted_datetime IS NOT NULL&#10;          --AND processed_datetime IS NULL&#10;          AND spg_notification_id &#61; p_spg_notification_id&#10;          AND offender_id         &#61; p_offender_id&#10;          AND crc_provider_id     &#61; p_receiver_identity_id;&#10;        --&#10;        IF l_cnt &#61; 0 THEN&#10;            --raise_application_error(-20001, &#39;CABI020 check&#39;);&#10;            PKG_SPG_EXPORT.create_crc_export_batch(&#10;                p_probation_area_id   &#61;&gt; p_receiver_identity_id,&#10;                p_async_flag          &#61;&gt; &#39;N&#39;,&#10;                p_spg_notification_id &#61;&gt; p_spg_notification_id,&#10;                p_offender_id         &#61;&gt; (CASE WHEN p_db_trigger_mode &#61; &#39;Y&#39; THEN p_offender_id END),&#10;                p_db_trigger_mode     &#61;&gt; p_db_trigger_mode );&#10;        END IF;&#10;        --&#10;    END IF;&#10;END check_new_alloc_offender_msg;&#10;&#10;--&#10;-- PROCESS_Q_MSG Overload&#10;PROCEDURE process_q_msg (&#10;    p_spg_notification_id     NUMBER,&#10;    p_interaction_datetime    DATE,&#10;    p_interaction_code        VARCHAR2,&#10;    p_offender_id             NUMBER,&#10;    p_grain_table_key         NUMBER  )&#10;IS&#10;    --&#10;    l_procedure_name VARCHAR2(30) :&#61; g_procedure_name;&#10;    --&#10;    P_PAYLOAD_IN              spg_payload_type :&#61; SPG_PAYLOAD_TYPE(&#10;                                                      p_spg_notification_id,&#10;                                                      p_interaction_datetime,&#10;                                                      p_interaction_code,&#10;                                                      p_offender_id,&#10;                                                      p_grain_table_key );&#10;    --&#10;    xmlString                 CLOB;&#10;    l_message_id              SPG_NOTIFICATION.message_id%TYPE;&#10;    l_error_message           SPG_NOTIFICATION.error_message%TYPE;&#10;    l_control_reference       SPG_NOTIFICATION.control_reference%TYPE;&#10;    l_receiver_ctl_reference  SPG_NOTIFICATION.receiver_control_reference%TYPE;&#10;    l_sender_identity_id      NUMBER;&#10;    l_receiver_identity_id    NUMBER;&#10;    l_sender_identity_code    probation_area.code%TYPE;&#10;    l_receiver_identity_code  probation_area.code%TYPE;&#10;    l_xmlstring               XMLTYPE;&#10;    l_spg_active_code         R_STANDARD_REFERENCE_LIST.code_value%TYPE;&#10;    l_spg_active_description  R_STANDARD_REFERENCE_LIST.code_description%TYPE;&#10;    l_user_name               SPG_CONTROL.value_string%TYPE;&#10;    --&#10;    l_use_xml_flag            BOOLEAN;&#10;    --&#10;    l_api_return              VARCHAR2(10);&#10;    l_api_response_string     CLOB;&#10;    l_api_return_string       CLOB;&#10;    --&#10;    l_bi_id                   NUMBER;&#10;    l_alf_doc_id              DOCUMENT.alfresco_document_id%TYPE;&#10;    --&#10;    l_cnt                     NUMBER;&#10;    l_offender_id             NUMBER;&#10;    --&#10;    l_export_to_file_flag     SMALLINT;&#10;    --&#10;    l_schema_version          SPG_xsd.xsd_version%TYPE;&#10;    l_schema_date             SPG_xsd.xsd_date%TYPE;&#10;    l_schema_number           SPG_xsd.xsd_number%TYPE;&#10;    --&#10;    no_xml_generated      EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(no_xml_generated, -20101);&#10;    --&#10;    not_valid_receiver    EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(not_valid_receiver, -20102);&#10;    --&#10;    invalid_credentials   EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(invalid_credentials, -29532);&#10;    --&#10;    alf_permission_direct_failed  EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(alf_permission_direct_failed, -20103);&#10;    --&#10;    doc_wip_direct_failed  EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(doc_wip_direct_failed, -20104);&#10;    --&#10;    doc_wip_cr_batch_failed EXCEPTION;&#10;    PRAGMA EXCEPTION_INIT(doc_wip_cr_batch_failed, -20105);&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;process_q_msg&#39;;&#10;    g_label :&#61; &#39;200000&#39;;&#10;    --&#10;    IF p_payload_in.interaction_code LIKE &#39;SPGISN%&#39; THEN&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    PKG_SPG_SUPPORT.do_allocate_jms_thread;&#10;    --&#10;    g_label :&#61; &#39;200001&#39;;&#10;    BEGIN&#10;        --&#10;        SELECT&#10;          S.business_interaction_id,&#10;          S.offender_id,&#10;          S.receiver_identity_id,&#10;          S.export_to_file_flag&#10;        INTO&#10;          l_bi_id,&#10;          l_offender_id,&#10;          l_receiver_identity_id,&#10;          l_export_to_file_flag&#10;        FROM&#10;          spg_notification S&#10;            INNER JOIN business_interaction BI ON BI.business_interaction_id &#61; S.business_interaction_id&#10;        WHERE S.spg_notification_id &#61; p_payload_in.spg_notification_id;&#10;        --&#10;    EXCEPTION WHEN NO_DATA_FOUND THEN&#10;        --&#10;        l_bi_id                :&#61; NULL;&#10;        l_offender_id          :&#61; NULL;&#10;        l_receiver_identity_id :&#61; NULL;&#10;        l_export_to_file_flag  :&#61; 0;&#10;        --&#10;    END;&#10;    --&#10;    IF NVL(l_export_to_file_flag, 0) &#61; 0 THEN&#10;        -- #SPG-17110: Create default record in OFFENDER_CRC_EXPORT for new Allocate Offender message&#10;        -- #DST-3205: Moved below to db trigger on SPG_NOTIFICATION&#10;        g_label :&#61; &#39;200002&#39;;&#10;    --    check_new_alloc_offender_msg(&#10;    --    p_business_interaction_code &#61;&gt; p_payload_in.interaction_code,&#10;    --    p_spg_notification_id       &#61;&gt; p_payload_in.spg_notification_id,&#10;    --    p_offender_id               &#61;&gt; l_offender_id,&#10;    --    p_receiver_identity_id      &#61;&gt; l_receiver_identity_id );&#10;        --&#10;        g_label :&#61; &#39;200005&#39;;&#10;        -- Check for any record within OFFENDER_CRC_EXPORT (for same offender/target provider)&#10;        IF p_payload_in.offender_id &gt; 0                AND&#10;           l_offender_id            IS NOT NULL        AND&#10;           l_receiver_identity_id   IS NOT NULL        AND&#10;           ( NOT SPGConfig.SPGSuppressDeferralActive ) AND&#10;           p_payload_in.interaction_code NOT IN (&#10;               &#39;CABI020&#39;,  /*AllocateOffender*/&#10;               &#39;CABI041&#39;,  /*AllocateEvent*/&#10;               &#39;SPOBI004&#39;, /*InsertOffender*/&#10;               &#39;SPGALF01&#39;, /*Alfresco*/&#10;               &#39;WPBI108&#39;,  /*Alfresco WIP Reset*/&#10;               &#39;SPOBI083&#39;, /*NationalOffenderAlert_INS*/&#10;               &#39;SPOBI084&#39;, /*NationalOffenderAlert_UPD*/&#10;               &#39;SPOBI085&#39;, /*NationalOffenderAlert_DEL*/&#10;               &#39;SPGBI905&#39;  /*NatSearchResponse*/ )     AND&#10;           (&#10;             -- DST-3235: ConsolidatedTransferRequest message is queued only if PROBATION_AREA.queue_spg_transfer_request&#61;1&#10;             --&#10;             -- ConsolidatedTransferRequest/Response? queue_spg_transfer_request RESULT Suppress message deferral check? Y/N&#10;             -- ------------------------------------- -------------------------- ------ ------------------------------------&#10;             --  NO                                    0&#61;0                       FALSE   N&#10;             --  NO                                    0&#61;1                       FALSE   N&#10;             --  YES                                   0&#61;0                       TRUE    Y&#10;             --  YES                                   0&#61;1                       FALSE   N&#10;             NOT ( p_payload_in.interaction_code IN (&#10;                       &#39;SPGBI088&#39;, /*ConsolidatedTransferRequest*/&#10;                       &#39;SPGBI089&#39;, /*ConsolidatedTransferRequest*/&#10;                       &#39;SPGBI090&#39;, /*ConsolidatedTransferResponse*/&#10;                       &#39;CABI231&#39;,  /*ConsolidatedTransferRequest*/&#10;                       &#39;CABI233&#39;,  /*ConsolidatedTransferResponse*/&#10;                       &#39;CABI234&#39;,  /*ConsolidatedTransferResponse*/&#10;                       &#39;CABI235&#39;,  /*ConsolidatedTransferRequest*/&#10;                       &#39;CABI236&#39;   /*ConsolidatedTransferRequest*/ )&#10;                   AND&#10;                   &#39;0&#39; &#61; PKG_Lookups.funcgetTabRecord_CACHED(&#10;                             p_table   &#61;&gt; &#39;PROBATION_AREA&#39;,&#10;                             p_ref_col &#61;&gt; &#39;probation_area_ID&#39;,&#10;                             p_ref_val &#61;&gt; TO_CHAR(l_receiver_identity_id),&#10;                             p_data_fld&#61;&gt; &#39;QUEUE_SPG_TRANSFER_REQUEST&#39;, p_default_val &#61;&gt; &#39;1&#39; ) )&#10;           )&#10;        THEN&#10;            -- Check for CRC Export pending record (no 202 response yet)&#10;            g_label :&#61; &#39;200006&#39;;&#10;            SELECT COUNT(1) INTO l_cnt&#10;            FROM offender_crc_export&#10;            WHERE current_record_flag &#61; &#39;Y&#39;&#10;              AND error_flag &#61; 0&#10;              AND submitted_datetime IS NOT NULL&#10;              AND processed_datetime IS NULL&#10;              AND spg_notification_id &lt;&gt; p_payload_in.spg_notification_id&#10;              AND offender_id &#61; l_offender_id&#10;              AND crc_provider_id &#61; l_receiver_identity_id;&#10;            --&#10;            IF l_cnt &gt; 0 THEN&#10;                --&#10;                warn(&#39;SPG Message [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;] &#39; ||&#10;                    &#39;has been deferred due to offender [ID&#61;&#39; || p_payload_in.offender_id || &#39;] is being exported to CRC&#39;);&#10;                --&#10;                UPDATE spg_notification SET&#10;                  processed_flag     &#61; 2,&#10;                  processed_datetime &#61; SYSDATE,&#10;                  message_id         &#61; ( CASE WHEN message_id &#61; &#39;PENDING&#39; THEN NULL ELSE message_id END ),&#10;                  error_message      &#61; PKG_LstUtl.concat_CLOB(error_message, &#39;deferred due to offender is being exported to CRC &#39; || TO_CHAR(SYSDATE, &#39;YYYYMMDD HH24:MI:SS&#39;), p_delim &#61;&gt; CHR(10))&#10;                WHERE spg_notification_id &#61; p_payload_in.spg_notification_id;&#10;                --YF: added here&#10;                PKG_SPG_SUPPORT.do_release_jms_thread;&#10;                --&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            g_label :&#61; &#39;200006&#39;;&#10;            --&#10;            -- #SPG-17423: Deduplicate messages&#10;            SELECT COUNT(1) INTO l_cnt&#10;            FROM offender_crc_export&#10;            WHERE current_record_flag &#61; &#39;Y&#39;&#10;              AND error_flag &#61; 0&#10;              AND submitted_datetime IS NOT NULL&#10;              --AND processed_datetime IS NULL&#10;              AND offender_id &#61; l_offender_id&#10;              AND crc_provider_id &#61; l_receiver_identity_id;&#10;            --&#10;            IF l_cnt &#61; 0 THEN&#10;                --&#10;                warn(&#39;SPG Message [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;] &#39; ||&#10;                    &#39;has been de-duplicated due to AllocateOffender for offender [ID&#61;&#39; || p_payload_in.offender_id || &#39;] has not been sent to CRC yet&#39;);&#10;                --&#10;                UPDATE spg_notification SET&#10;                  processed_flag     &#61; 5,&#10;                  processed_datetime &#61; SYSDATE,&#10;                  message_id         &#61; ( CASE WHEN message_id &#61; &#39;PENDING&#39; THEN NULL ELSE message_id END ),&#10;                  error_message      &#61; PKG_LstUtl.concat_CLOB(error_message, &#39;de-duplicated due to AllocateOffender for offender [ID&#61;&#39; || p_payload_in.offender_id || &#39;] has not been sent to CRC&#39;, p_delim &#61;&gt; CHR(10))&#10;                WHERE spg_notification_id &#61; p_payload_in.spg_notification_id;&#10;                --YF: added here&#10;                PKG_SPG_SUPPORT.do_release_jms_thread;&#10;                --&#10;                g_procedure_name :&#61; l_procedure_name;&#10;                --&#10;                RETURN;&#10;            END IF;&#10;        END IF;&#10;        --&#10;    END IF; -- IF NVL(l_export_to_file_flag, 0) &#61; 0 THEN&#10;    --&#10;    g_label :&#61; &#39;200007&#39;;&#10;    info(&#39;Generate Identifiers - begin [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;    SPGConfig.generateIdentifiers(  p_payload_in                  &#61;&gt; p_payload_in,&#10;                                    control_reference_out         &#61;&gt; l_control_reference,&#10;                                    receiver_ctl_reference_out    &#61;&gt; l_receiver_ctl_reference,&#10;                                    sender_identity_id_out        &#61;&gt; l_sender_identity_id,&#10;                                    receiver_identity_id_out      &#61;&gt; l_receiver_identity_id);&#10;    --&#10;    info(&#39;l_receiver_identity_id [&#39; || l_receiver_identity_id || &#39;][ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;    IF l_receiver_identity_id &#61; SPGCONFIG.get_broadcast_domain_id THEN&#10;        SPGMESSAGE.broadcast_message(spg_notification_id_in &#61;&gt; p_payload_in.spg_notification_id);&#10;        --YF: added here&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        RETURN;&#10;    END IF;&#10;    -- YF: moved to the top of this procedure&#10;    --PKG_SPG_SUPPORT.do_allocate_jms_thread;&#10;    --&#10;    g_label :&#61; &#39;200008&#39;;&#10;    l_sender_identity_code   :&#61; PKG_Lookups.funcgetTabRecord_CACHED(&#10;                                    p_table   &#61;&gt; &#39;PROBATION_AREA&#39;,&#10;                                    p_ref_col &#61;&gt; &#39;probation_area_ID&#39;,&#10;                                    p_ref_val &#61;&gt; TO_CHAR(l_sender_identity_id),&#10;                                    p_data_fld&#61;&gt; &#39;CODE&#39;, p_default_val &#61;&gt; &#39;XXX&#39; );&#10;    l_receiver_identity_code :&#61; PKG_Lookups.funcgetTabRecord_CACHED(&#10;                                    p_table   &#61;&gt; &#39;PROBATION_AREA&#39;,&#10;                                    p_ref_col &#61;&gt; &#39;probation_area_ID&#39;,&#10;                                    p_ref_val &#61;&gt; TO_CHAR(l_receiver_identity_id),&#10;                                    p_data_fld&#61;&gt; &#39;CODE&#39;, p_default_val &#61;&gt; &#39;XXX&#39; );&#10;    --&#10;    IF ( p_payload_in.interaction_code &#61; &#39;SPGALF01&#39; AND SPGConfig.SPGPermissionDirectActive ) OR&#10;       ( p_payload_in.interaction_code &#61; &#39;WPBI108&#39; )&#10;    THEN&#10;        l_use_xml_flag :&#61; FALSE;&#10;    ELSE&#10;        l_use_xml_flag :&#61; TRUE;&#10;    END IF;&#10;    --&#10;    IF l_use_xml_flag THEN&#10;        -- SET G_xsd_NUMBER based on a combination of sender_identity and Ref Data (in the latest XSD) flag&#10;        --&#10;        l_schema_number :&#61; SPGCONFIG.get_xsd_number(p_probation_area_code &#61;&gt; l_receiver_identity_code, p_bi_code &#61;&gt; p_payload_in.interaction_code);&#10;        --&#10;        SELECT xsd_version, xsd_date INTO l_schema_version, l_schema_date&#10;        FROM spg_xsd&#10;        WHERE xsd_number &#61; l_schema_number;&#10;        --&#10;        SPGMESSAGE.GC_SCHEMA_VERSION  :&#61;  l_schema_version;&#10;        SPGMESSAGE.GC_SCHEMA_DATE     :&#61;  TO_CHAR(l_schema_date, &#39;YYYY-MM-DD&#39;);&#10;        SPGMESSAGE.GC_SCHEMA_NUMBER   :&#61;  l_schema_number;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;200009&#39;;&#10;    IF SPGConfig.SPGInfoActive THEN&#10;        info(&#39;[Control Reference &#61;&gt; &#39; || l_control_reference || &#39;][Sender Identity &#61;&gt; &#39; || l_sender_identity_code || &#39;][Receiver Identity &#61;&gt; &#39; || l_receiver_identity_code || &#39;][ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;        info(&#39;Generate Identifiers - end [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;    END IF;&#10;    --&#10;    BEGIN&#10;        SELECT r1.code_value, r1.code_description INTO l_spg_active_code, l_spg_active_description&#10;        FROM&#10;          probation_area p&#10;            INNER JOIN r_standard_reference_list r1 ON p.spg_active_id &#61; r1.standard_reference_list_id&#10;                                                AND r1.reference_data_master_id &#61; (&#10;                                                    SELECT reference_data_master_id&#10;                                                    FROM r_reference_data_master&#10;                                                    WHERE code_set_name &#61; &#39;SPG_ACTIVE&#39; )&#10;                                                AND p.probation_area_id &#61; l_receiver_identity_id;&#10;    EXCEPTION&#10;        WHEN no_data_found THEN&#10;          NULL;&#10;        WHEN OTHERS THEN&#10;          RAISE;&#10;    END;&#10;    --&#10;    IF l_spg_active_code NOT IN (&#39;A&#39;,&#39;T&#39;,&#39;M&#39;) THEN&#10;        RAISE not_valid_receiver;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;200010&#39;;&#10;    info(&#39;XML generation - begin [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;    --&#10;    IF p_payload_in.interaction_code IN (&#39;REF01&#39;,&#39;REF02&#39;) THEN&#10;        --&#10;        g_label :&#61; &#39;200020&#39;;&#10;        IF SPGConfig.SPGInfoActive THEN&#10;            info(&#10;                &#39;SPGmessage.get_rd_msg (&#10;                    rdtype_in                   &#61;&gt; &#39; || CASE WHEN p_payload_in.interaction_code &#61; &#39;REF02&#39; THEN &#39;NONSTANDARD&#39; ELSE &#39;STANDARD&#39; END || &#39;,&#10;                    uniqueid_in                 &#61;&gt; &#39; || p_payload_in.grain_table_key || &#39;,&#10;                    senderidentity_in           &#61;&gt; &#39; || l_sender_identity_code || &#39;,&#10;                    receiveridentity_in         &#61;&gt; &#39; || l_receiver_identity_code || &#39;,&#10;                    sendercontrolreference_in   &#61;&gt; &#39; || l_control_reference || &#39;,&#10;                    receivercontrolreference_in &#61;&gt; NULL,&#10;                    messagetype_in              &#61;&gt; &#39; || GC_REF_MSG_TYPE || &#39;,&#10;                    messageversionnumber_in     &#61;&gt; &#39; || GC_SCHEMA_VERSION || &#39;,&#10;                    messagereferencenumber_in   &#61;&gt; 1,&#10;                    messagerecordidentifier_in  &#61;&gt; &#39;&#39;)&#39; );&#10;        END IF;&#10;        --&#10;        xmlString :&#61; SPGmessage.get_rd_msg (&#10;                          rdtype_in                   &#61;&gt; CASE WHEN p_payload_in.interaction_code &#61; &#39;REF02&#39; THEN &#39;NONSTANDARD&#39; ELSE &#39;STANDARD&#39; END,&#10;                          uniqueid_in                 &#61;&gt; p_payload_in.grain_table_key,&#10;                          senderidentity_in           &#61;&gt; l_sender_identity_code,&#10;                          receiveridentity_in         &#61;&gt; l_receiver_identity_code,&#10;                          sendercontrolreference_in   &#61;&gt; l_control_reference,&#10;                          receivercontrolreference_in &#61;&gt; NULL,&#10;                          messagetype_in              &#61;&gt; GC_REF_MSG_TYPE,&#10;                          messageversionnumber_in     &#61;&gt; GC_SCHEMA_VERSION,&#10;                          messagereferencenumber_in   &#61;&gt; 1,&#10;                          messagerecordidentifier_in  &#61;&gt; &#39;&#39;);&#10;        --&#10;    ELSIF p_payload_in.interaction_code LIKE &#39;R__CONFIG&#39; THEN&#10;        --&#10;        g_label :&#61; &#39;200025&#39;;&#10;        IF SPGConfig.SPGInfoActive THEN&#10;            info(&#10;                &#39;SPGmessage.get_rd_msg (&#10;                    rdtype_in                   &#61;&gt; &#39; || p_payload_in.interaction_code || &#39;,&#10;                    uniqueid_in                 &#61;&gt; &#39; || p_payload_in.grain_table_key || &#39;,&#10;                    senderidentity_in           &#61;&gt; &#39; || l_sender_identity_code || &#39;,&#10;                    receiveridentity_in         &#61;&gt; &#39; || l_receiver_identity_code || &#39;,&#10;                    sendercontrolreference_in   &#61;&gt; &#39; || l_control_reference || &#39;,&#10;                    receivercontrolreference_in &#61;&gt; NULL,&#10;                    messagetype_in              &#61;&gt; &#39; || GC_REF_MSG_TYPE || &#39;,&#10;                    messageversionnumber_in     &#61;&gt; &#39; || GC_SCHEMA_VERSION || &#39;,&#10;                    messagereferencenumber_in   &#61;&gt; 1,&#10;                    messagerecordidentifier_in  &#61;&gt; &#39;&#39;)&#39; );&#10;        END IF;&#10;        --&#10;        xmlString :&#61; SPGmessage.get_rd_msg (&#10;                          rdtype_in                   &#61;&gt; p_payload_in.interaction_code,&#10;                          uniqueid_in                 &#61;&gt; p_payload_in.grain_table_key,&#10;                          senderidentity_in           &#61;&gt; l_sender_identity_code,&#10;                          receiveridentity_in         &#61;&gt; l_receiver_identity_code,&#10;                          sendercontrolreference_in   &#61;&gt; l_control_reference,&#10;                          receivercontrolreference_in &#61;&gt; NULL,&#10;                          messagetype_in              &#61;&gt; GC_REF_MSG_TYPE,&#10;                          messageversionnumber_in     &#61;&gt; GC_SCHEMA_VERSION,&#10;                          messagereferencenumber_in   &#61;&gt; 1,&#10;                          messagerecordidentifier_in  &#61;&gt; &#39;&#39;);&#10;        --&#10;    ELSIF p_payload_in.interaction_code LIKE &#39;REF03&#39; THEN&#10;        --&#10;        g_label :&#61; &#39;200025&#39;;&#10;        IF SPGConfig.SPGInfoActive THEN&#10;            info(&#10;                &#39;SPGmessage.get_linkedlist_msg (&#10;                    senderidentity_in           &#61;&gt; &#39; || l_sender_identity_code || &#39;,&#10;                    receiveridentity_in         &#61;&gt; &#39; || l_receiver_identity_code || &#39;,&#10;                    sendercontrolreference_in   &#61;&gt; &#39; || l_control_reference || &#39;,&#10;                    receivercontrolreference_in &#61;&gt; NULL,&#10;                    messagetype_in              &#61;&gt; &#39; || GC_REF_MSG_TYPE || &#39;,&#10;                    messageversionnumber_in     &#61;&gt; &#39; || GC_SCHEMA_VERSION || &#39;,&#10;                    messagereferencenumber_in   &#61;&gt; 1,&#10;                    messagerecordidentifier_in  &#61;&gt; &#39;&#39;)&#39; );&#10;        END IF;&#10;        --&#10;        xmlString :&#61; SPGmessage.get_linkedlist_msg (&#10;                          senderidentity_in           &#61;&gt; l_sender_identity_code,&#10;                          receiveridentity_in         &#61;&gt; l_receiver_identity_code,&#10;                          sendercontrolreference_in   &#61;&gt; l_control_reference,&#10;                          receivercontrolreference_in &#61;&gt; NULL,&#10;                          messagetype_in              &#61;&gt; GC_REF_MSG_TYPE,&#10;                          messageversionnumber_in     &#61;&gt; GC_SCHEMA_VERSION,&#10;                          messagereferencenumber_in   &#61;&gt; 1,&#10;                          messagerecordidentifier_in  &#61;&gt; &#39;&#39;);&#10;        --&#10;    ELSIF p_payload_in.interaction_code LIKE &#39;LLBI___&#39; THEN&#10;        --&#10;        g_label :&#61; &#39;200026&#39;;&#10;        IF SPGConfig.SPGInfoActive THEN&#10;            info(&#10;                &#39;SPGmessage.get_linkedlist_msg (&#10;                    groupname_in                &#61;&gt; &#39; || p_payload_in.interaction_code || &#39;,&#10;                    uniqueid_in                 &#61;&gt; &#39; || p_payload_in.grain_table_key || &#39;,&#10;                    senderidentity_in           &#61;&gt; &#39; || l_sender_identity_code || &#39;,&#10;                    receiveridentity_in         &#61;&gt; &#39; || l_receiver_identity_code || &#39;,&#10;                    sendercontrolreference_in   &#61;&gt; &#39; || l_control_reference || &#39;,&#10;                    receivercontrolreference_in &#61;&gt; NULL,&#10;                    messagetype_in              &#61;&gt; &#39; || GC_REF_MSG_TYPE || &#39;,&#10;                    messageversionnumber_in     &#61;&gt; &#39; || GC_SCHEMA_VERSION || &#39;,&#10;                    messagereferencenumber_in   &#61;&gt; 1,&#10;                    messagerecordidentifier_in  &#61;&gt; &#39;&#39;)&#39; );&#10;        END IF;&#10;        --&#10;        xmlString :&#61; SPGmessage.get_linkedlist_msg (&#10;                          groupname_in                &#61;&gt; p_payload_in.interaction_code,&#10;                          uniqueid_in                 &#61;&gt; p_payload_in.grain_table_key,&#10;                          senderidentity_in           &#61;&gt; l_sender_identity_code,&#10;                          receiveridentity_in         &#61;&gt; l_receiver_identity_code,&#10;                          sendercontrolreference_in   &#61;&gt; l_control_reference,&#10;                          receivercontrolreference_in &#61;&gt; NULL,&#10;                          messagetype_in              &#61;&gt; GC_REF_MSG_TYPE,&#10;                          messageversionnumber_in     &#61;&gt; GC_SCHEMA_VERSION,&#10;                          messagereferencenumber_in   &#61;&gt; 1,&#10;                          messagerecordidentifier_in  &#61;&gt; &#39;&#39;);&#10;        --&#10;    ELSIF p_payload_in.interaction_code LIKE &#39;SPGALF01&#39; THEN&#10;        --&#10;        IF NOT SPGConfig.SPGPermissionDirectActive THEN&#10;            g_label :&#61; &#39;200027&#39;;&#10;            xmlString :&#61; SPGMESSAGE.get_alfresco_permission_msg(&#10;                              offenderid_in                 &#61;&gt; p_payload_in.offender_id,&#10;                              senderidentity_in             &#61;&gt; l_sender_identity_code,&#10;                              receiveridentity_in           &#61;&gt; l_receiver_identity_code,&#10;                              sendercontrolreference_in     &#61;&gt; l_control_reference,&#10;                              receivercontrolreference_in   &#61;&gt; NULL,&#10;                              messagetype_in                &#61;&gt; GC_REF_MSG_TYPE,&#10;                              messageversionnumber_in       &#61;&gt; GC_SCHEMA_VERSION,&#10;                              messagereferencenumber_in     &#61;&gt; 1,&#10;                              messagerecordidentifier_in    &#61;&gt; &#39;&#39;);&#10;        END IF;&#10;        --&#10;    ELSIF p_payload_in.interaction_code LIKE &#39;WPBI108&#39; THEN&#10;        --&#10;        g_label :&#61; &#39;200028&#39;;&#10;        --&#10;    ELSIF p_payload_in.interaction_code IN (&#39;CABI020&#39;) THEN&#10;        --&#10;        g_label :&#61; &#39;200030&#39;;&#10;        IF SPGConfig.SPGInfoActive THEN&#10;            info(&#10;                &#39;PKG_DYN_XML.get_gen_xml(&#10;                    p_bi_code             &#61;&gt; &#39; || p_payload_in.interaction_code || &#39;&#10;                    ,p_offender_id        &#61;&gt; &#39; || p_payload_in.offender_id || &#39;&#10;                    ,p_control_reference  &#61;&gt; &#39; || l_control_reference || &#39;&#10;                    ,p_receiver_ctl_reference &#61;&gt; &#39; || l_receiver_ctl_reference || &#39;&#10;                    ,p_sender_identity    &#61;&gt; &#39; || l_sender_identity_code || &#39;&#10;                    ,p_receiver_identity  &#61;&gt; &#39; || l_receiver_identity_code || &#39;&#10;                    ,p_spg_notification_id&#61;&gt; &#39; || p_payload_in.spg_notification_id || &#39;&#10;                    )&#39; );&#10;        END IF;&#10;        --&#10;        g_label :&#61; &#39;200035&#39;;&#10;        xmlString :&#61;  PKG_DYN_XML.get_gen_xml(&#10;                                  p_bi_code             &#61;&gt; p_payload_in.interaction_code&#10;                                  ,p_offender_id        &#61;&gt; p_payload_in.offender_id&#10;                                  --,p_pk_value         &#61;&gt; p_payload_in.grain_table_key /*YF: must be specified for when all other than OFFENDER tables */&#10;                                  ,p_control_reference  &#61;&gt; l_control_reference&#10;                                  ,p_receiver_ctl_reference &#61;&gt; l_receiver_ctl_reference&#10;                                  ,p_sender_identity    &#61;&gt; l_sender_identity_code&#10;                                  ,p_receiver_identity  &#61;&gt; l_receiver_identity_code&#10;                                  ,p_spg_notification_id&#61;&gt; p_payload_in.spg_notification_id&#10;                                  );&#10;        --&#10;    ELSE&#10;        --&#10;        g_label :&#61; &#39;200040&#39;;&#10;        IF SPGConfig.SPGInfoActive THEN&#10;            info(&#10;                &#39;PKG_DYN_XML.get_gen_xml(&#10;                p_bi_code             &#61;&gt; &#39;&#39;&#39; || p_payload_in.interaction_code || &#39;&#39;&#39;&#10;                ,p_offender_id        &#61;&gt; &#39; || p_payload_in.offender_id || &#39;&#10;                ,p_pk_value           &#61;&gt; &#39; || p_payload_in.grain_table_key || &#39;&#10;                ,p_control_reference  &#61;&gt; &#39;&#39;&#39; || l_control_reference || &#39;&#39;&#39;&#10;                ,p_receiver_ctl_reference &#61;&gt; &#39;&#39;&#39; || l_receiver_ctl_reference || &#39;&#39;&#39;&#10;                ,p_sender_identity    &#61;&gt; &#39;&#39;&#39; || l_sender_identity_code || &#39;&#39;&#39;&#10;                ,p_receiver_identity  &#61;&gt; &#39;&#39;&#39; || l_receiver_identity_code || &#39;&#39;&#39;&#10;                )&#39; );&#10;        END IF;&#10;        --&#10;        g_label :&#61; &#39;200050&#39;;&#10;        xmlString :&#61;  PKG_DYN_XML.get_gen_xml(&#10;                                  p_bi_code                 &#61;&gt; p_payload_in.interaction_code&#10;                                  ,p_offender_id            &#61;&gt; p_payload_in.offender_id&#10;                                  ,p_pk_value               &#61;&gt; p_payload_in.grain_table_key&#10;                                  ,p_control_reference      &#61;&gt; l_control_reference&#10;                                  ,p_receiver_ctl_reference &#61;&gt; l_receiver_ctl_reference&#10;                                  ,p_sender_identity        &#61;&gt; l_sender_identity_code&#10;                                  ,p_receiver_identity      &#61;&gt; l_receiver_identity_code&#10;                                  ,p_spg_notification_id    &#61;&gt; p_payload_in.spg_notification_id&#10;                                  );&#10;        --&#10;    END IF;&#10;    --&#10;    info(&#39;XML generation - end [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;    --&#10;    IF l_use_xml_flag THEN&#10;        IF NULLIF(LENGTH(xmlString),0) IS NULL THEN&#10;            RAISE no_xml_generated;&#10;        END IF;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;200060&#39;;&#10;    --&#10;    -- YF: Moved the below CHR(10) substitution into PKG_DynXML (xSQL level)&#10;    --  xmlString :&#61; REPLACE(xmlString, CHR(13), &#39;&#39;);&#10;    --  xmlString :&#61; REPLACE(xmlString, CHR(10), &#39;&amp;#10;&#39;);&#10;    --&#10;    IF NVL(l_export_to_file_flag, 0) &#61; 0 THEN&#10;        --&#10;        info(&#39;Publish XML - begin [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;        --&#10;        IF p_payload_in.interaction_code &#61; &#39;SPGALF01&#39; AND SPGConfig.SPGPermissionDirectActive THEN&#10;            --&#10;            ALFRESCOSUPPORT.sendOffenderPermissionMsg(&#10;                p_offender_id         &#61;&gt; p_payload_in.offender_id,&#10;                x_api_return          &#61;&gt; l_api_return,&#10;                x_api_response_string &#61;&gt; l_api_response_string,&#10;                x_api_return_string   &#61;&gt; l_api_return_string );&#10;            --&#10;            IF l_api_return IN ( &#39;200&#39; ) THEN&#10;                l_message_id :&#61; l_api_return;&#10;            ELSE&#10;                --&#10;                l_error_message :&#61;&#10;                    PKG_LstUtl.concat(&#10;                        &#39;STATUS_CODE: &#39;      || l_api_return,&#10;                        &#39;RESPONSE_HDR: &#39;     || l_api_response_string,&#10;                        &#39;RESPONSE DETAILS: &#39; || l_api_return_string,&#10;                        p_delim&#61;&gt;CHR(10) );&#10;                --&#10;                RAISE alf_permission_direct_failed;&#10;                --&#10;            END IF;&#10;            --&#10;        ELSIF p_payload_in.interaction_code &#61; &#39;WPBI108&#39; THEN&#10;            --&#10;            IF p_payload_in.grain_table_key &#61; -1 THEN&#10;                -- Pre-seed expired document WIP reset tasks&#10;                BEGIN&#10;                    ALFRESCOSUPPORT.createDocResetWIPBatch;&#10;                EXCEPTION WHEN OTHERS THEN&#10;                    l_error_message :&#61; SQLERRM;&#10;                    RAISE doc_wip_cr_batch_failed;&#10;                END;&#10;                --&#10;            ELSE&#10;                --&#10;                ALFRESCOSUPPORT.resetDocWIP(&#10;                    p_document_id         &#61;&gt; p_payload_in.grain_table_key,&#10;                    x_api_return          &#61;&gt; l_api_return,&#10;                    x_api_response_string &#61;&gt; l_api_response_string,&#10;                    x_api_return_string   &#61;&gt; l_api_return_string );&#10;                --&#10;                IF l_api_return IN ( &#39;200&#39;, &#39;205&#39;, &#39;404&#39; ) THEN&#10;                    l_message_id :&#61; l_api_return;&#10;                ELSE&#10;                    --&#10;                    l_error_message :&#61;&#10;                        PKG_LstUtl.concat(&#10;                            &#39;STATUS_CODE: &#39;      || l_api_return,&#10;                            &#39;RESPONSE_HDR: &#39;     || l_api_response_string,&#10;                            &#39;RESPONSE DETAILS: &#39; || l_api_return_string,&#10;                            p_delim&#61;&gt;CHR(10) );&#10;                    --&#10;                    RAISE doc_wip_direct_failed;&#10;                    --&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;        ELSE&#10;            -- Send XML payload using Java JMS API&#10;            l_user_name :&#61; spgconfig.get_broker_username;&#10;            IF EMPTY2NULL(l_user_name) IS NULL THEN&#10;                l_message_id :&#61; PKG_SPG_SUPPORT.sendUpdateToJMS(&#10;                                            msgClob                 &#61;&gt; xmlString,&#10;                                            jmsUrl                  &#61;&gt; spgconfig.get_outbound_broker,&#10;                                            queueName               &#61;&gt; spgconfig.get_outbound_queue,&#10;                                            senderControlReference  &#61;&gt; l_control_reference,&#10;                                            JMSPriority             &#61;&gt; 4,&#10;                                            senderIdentity          &#61;&gt; l_sender_identity_code);&#10;            ELSE&#10;                l_message_id :&#61; PKG_SPG_SUPPORT.sendUpdateTOJMS (msgClob             &#61;&gt; xmlString,&#10;                                                            jmsUser                 &#61;&gt; l_user_name,&#10;                                                            jmsPass                 &#61;&gt; spgconfig.get_broker_password(username_in &#61;&gt; spgconfig.get_broker_username),&#10;                                                            jmsUrl                  &#61;&gt; spgconfig.get_outbound_broker,&#10;                                                            queueName               &#61;&gt; spgconfig.get_outbound_queue,&#10;                                                            senderControlReference  &#61;&gt; l_control_reference,&#10;                                                            JMSPriority             &#61;&gt; 4,&#10;                                                            senderIdentity          &#61;&gt; l_sender_identity_code);&#10;            END IF;&#10;            --&#10;        END IF;&#10;        --&#10;        info(&#39;Publish XML - end [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;        --&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;200070&#39;;&#10;    info(&#39;Update notification - begin [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;    IF l_use_xml_flag AND ( SPGConfig.SPGSaveXMLActive OR SPGConfig.SPGPersistActive OR SPGConfig.SPGInfoActive ) THEN&#10;        g_label :&#61; &#39;200080&#39;;&#10;        l_xmlString :&#61; XMLTYPE(xmlString);&#10;    ELSE&#10;        g_label :&#61; &#39;200090&#39;;&#10;        l_xmlstring :&#61; NULL;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;200100&#39;;&#10;    UPDATE spg_notification SET&#10;      processed_flag     &#61; 1,&#10;      message_id         &#61; l_message_id,&#10;      processed_datetime &#61; SYSDATE,&#10;      xml_message        &#61; l_xmlString&#10;    WHERE spg_notification_id &#61; p_payload_in.spg_notification_id;&#10;    --&#10;    IF l_use_xml_flag THEN&#10;        --&#10;        IF SPGConfig.SPGPersistActive THEN&#10;            g_label :&#61; &#39;200110&#39;;&#10;            PKG_SPG_SUPPORT.persist_xml_to_disk( spg_notification_id_in&#61;&gt;p_payload_in.spg_notification_id );&#10;        ELSIF l_export_to_file_flag &#61; 1 THEN&#10;            g_label :&#61; &#39;200110&#39;;&#10;            PKG_SPG_SUPPORT.persist_xml_to_disk( spg_notification_id_in&#61;&gt;p_payload_in.spg_notification_id, p_export_caseload_flag&#61;&gt; &#39;Y&#39; );&#10;        END IF;&#10;        --&#10;    END IF;&#10;    --&#10;    IF SPGCONFIG.spgdocstodiskactive AND p_payload_in.interaction_code &#61; &#39;CABI020&#39; THEN&#10;        g_label :&#61; &#39;200120&#39;;&#10;        document_to_disk(offender_id_in &#61;&gt; p_payload_in.offender_id);&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;200130&#39;;&#10;    --&#10;    info(&#39;Update notification - end [ID&#61;&#39; || p_payload_in.spg_notification_id || &#39;]&#39;);&#10;    --&#10;    PKG_SPG_SUPPORT.do_release_jms_thread;&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;EXCEPTION&#10;    WHEN invalid_credentials THEN&#10;        SPGCONFIG.record_error_message(p_payload_in.spg_notification_id, &#39;Invalid credentials for JMS Broker&#39;);&#10;        --&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        fatal(SQLERRM);&#10;    WHEN not_valid_receiver THEN&#10;        SPGCONFIG.record_error_message(p_payload_in.spg_notification_id, &#39;Receiver has invalid status [&#39; || l_spg_active_code || &#39; &#39; || l_spg_active_description || &#39;]&#39;);&#10;        --&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        fatal(SQLERRM);&#10;    WHEN no_xml_generated THEN&#10;        SPGCONFIG.record_error_message(p_payload_in.spg_notification_id, &#39;No XML generated for parameters supplied&#39;);&#10;        --&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        fatal(SQLERRM);&#10;    WHEN alf_permission_direct_failed THEN&#10;        SPGCONFIG.record_error_message(p_payload_in.spg_notification_id, &#39;Direct Permission Message call failed&#39;);&#10;        --&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        --fatal( PKG_LstUtl.Concat(SQLERRM, l_error_message, p_delim&#61;&gt;CHR(10)) );&#10;        fatal( NVL(l_error_message, SQLERRM) );&#10;    WHEN doc_wip_cr_batch_failed THEN&#10;        SPGCONFIG.record_error_message(p_payload_in.spg_notification_id, &#39;Direct Document WIP Generate Batch call failed&#39;);&#10;        --&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        fatal( NVL(l_error_message, SQLERRM) );&#10;    WHEN doc_wip_direct_failed THEN&#10;        SPGCONFIG.record_error_message(p_payload_in.spg_notification_id, &#39;Direct Document WIP Reset Flag Message call failed&#39;);&#10;        --&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        fatal( NVL(l_error_message, SQLERRM) );&#10;    WHEN OTHERS THEN&#10;        SPGCONFIG.record_error_message(p_payload_in.spg_notification_id, SQLERRM);&#10;        --&#10;        PKG_SPG_SUPPORT.do_release_jms_thread;&#10;        --&#10;        g_procedure_name :&#61; l_procedure_name;&#10;        --&#10;        fatal(SQLERRM);&#10;END process_q_msg;&#10;--&#10;-- AQ version Overload&#10;PROCEDURE process_q_msg( p_payload_in IN spg_payload_type )&#10;IS&#10;    --&#10;    lc_proc          CONSTANT VARCHAR2(30) :&#61; &#39;PROCESS_Q_MSG_AQ&#39;;&#10;    l_procedure_name VARCHAR2(30) :&#61; g_procedure_name;&#10;    --&#10;    LC_ASYNC_FLAG VARCHAR2(1) :&#61; &#39;N&#39;;&#10;    --&#10;    PROCEDURE create_bg_process&#10;    IS&#10;        --&#10;        l_status INTEGER;&#10;        --&#10;        lc_prog_name CONSTANT VARCHAR2(30) :&#61; &#39;SPG_PROCESS_Q_MSG_PROG&#39;;&#10;        --&#10;        l_job_name  VARCHAR2(30);&#10;        --&#10;    BEGIN&#10;        -- Create DBMS_SCHEDULE job&#10;        l_job_name  :&#61; SUBSTRB(&#39;SPGQM_&#39; || p_payload_in.spg_notification_id || &#39;_&#39; || TO_CHAR(SYSDATE, &#39;MMDDHH24MMSS&#39;), 1, 30);&#10;        -- e.g. SPGQM_6379813_1004191046&#10;        --&#10;        DBMS_SCHEDULER.create_job(&#10;            job_name      &#61;&gt; l_job_name,&#10;            program_name  &#61;&gt; lc_prog_name,&#10;            start_date    &#61;&gt; SYSDATE,&#10;            end_date      &#61;&gt; SYSDATE+14,&#10;            job_style     &#61;&gt; &#39;LIGHTWEIGHT&#39;,&#10;            enabled       &#61;&gt; FALSE,&#10;            comments      &#61;&gt; &#39;SPG_PROCESS_Q_MSG_JOB&#39;);&#10;        --&#10;        DBMS_SCHEDULER.set_job_argument_value(job_name &#61;&gt; l_job_name, argument_name &#61;&gt; &#39;p_spg_notification_id&#39; , argument_value &#61;&gt; p_payload_in.spg_notification_id );&#10;        DBMS_SCHEDULER.set_job_argument_value(job_name &#61;&gt; l_job_name, argument_name &#61;&gt; &#39;p_interaction_datetime&#39;, argument_value &#61;&gt; p_payload_in.interaction_datetime);&#10;        DBMS_SCHEDULER.set_job_argument_value(job_name &#61;&gt; l_job_name, argument_name &#61;&gt; &#39;p_interaction_code&#39;    , argument_value &#61;&gt; p_payload_in.interaction_code    );&#10;        DBMS_SCHEDULER.set_job_argument_value(job_name &#61;&gt; l_job_name, argument_name &#61;&gt; &#39;p_offender_id&#39;         , argument_value &#61;&gt; p_payload_in.offender_id         );&#10;        DBMS_SCHEDULER.set_job_argument_value(job_name &#61;&gt; l_job_name, argument_name &#61;&gt; &#39;p_grain_table_key&#39;     , argument_value &#61;&gt; p_payload_in.grain_table_key     );&#10;        --&#10;        DBMS_SCHEDULER.enable(l_job_name);&#10;        --&#10;    END create_bg_process;&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; lc_proc;&#10;    g_label :&#61; CASE WHEN LC_ASYNC_FLAG &#61; &#39;N&#39; THEN &#39;00010&#39; ELSE &#39;00020&#39; END;&#10;    --&#10;    IF SPGConfig.SPGInfoActive THEN&#10;        info(&#10;            &#39;Submit PROCESS_Q_MSG job &#39; ||&#10;            &#39;(SPG_NOT_ID&#61;&#39; || p_payload_in.spg_notification_id                                  || &#39;)&#39; ||&#10;            &#39;(BI_DT&#61;&#39;      || TO_CHAR(p_payload_in.interaction_datetime, &#39;YYYYMMDD HH24:MI:SS&#39;) || &#39;)&#39; ||&#10;            &#39;(BI_CODE&#61;&#39;    || p_payload_in.interaction_code                                     || &#39;)&#39; ||&#10;            &#39;(OFF_ID&#61;&#39;     || p_payload_in.offender_id                                          || &#39;)&#39; ||&#10;            &#39;(CRN&#61;&#39;        || PKG_LOOKUPS.funcgetTabRecord(p_table&#61;&gt;&#39;offender&#39;, p_ref_col&#61;&gt;&#39;offender_id&#39;, p_ref_val&#61;&gt;TO_CHAR(p_payload_in.offender_id), p_data_fld&#61;&gt;&#39;CRN&#39;) || &#39;)&#39; ||&#10;            &#39;(UID&#61;&#39;        || p_payload_in.grain_table_key                                      || &#39;)&#39; ||&#10;            --&#10;            &#39;(bg flag&#61;&#39;    || LC_ASYNC_FLAG                                                     || &#39;)&#39; );&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;00050&#39;;&#10;    --&#10;    IF LC_ASYNC_FLAG &#61; &#39;Y&#39; THEN&#10;        create_bg_process;&#10;    ELSE&#10;        SPGMessage.process_q_msg(&#10;            p_spg_notification_id   &#61;&gt; p_payload_in.spg_notification_id,&#10;            p_interaction_datetime  &#61;&gt; p_payload_in.interaction_datetime,&#10;            p_interaction_code      &#61;&gt; p_payload_in.interaction_code,&#10;            p_offender_id           &#61;&gt; p_payload_in.offender_id,&#10;            p_grain_table_key       &#61;&gt; p_payload_in.grain_table_key );&#10;    END IF;&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;END process_q_msg;&#10;--&#10;-- MThread version Overload&#10;PROCEDURE process_q_msg(&#10;    p_spg_notification_id NUMBER,&#10;    p_component_id        PDT_THREAD.component_id%TYPE  DEFAULT NULL,&#10;    p_thread_id           PDT_THREAD.thread_id%TYPE     DEFAULT NULL )&#10;IS&#10;    --&#10;    l_procedure_name VARCHAR2(30) :&#61; g_procedure_name;&#10;    --&#10;    l_user_data SPG_PAYLOAD_TYPE;&#10;    --&#10;    CURSOR cs IS&#10;      SELECT *&#10;      FROM spg_notification&#10;      WHERE spg_notification_id &#61; p_spg_notification_id&#10;        AND message_direction &#61; &#39;O&#39;&#10;        --AND processed_flag &#61; 4&#10;        --AND message_id IS NULL&#10;    ;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    l_component_id  NUMBER;&#10;    l_thread_id     NUMBER;&#10;    l_run_fixit_job VARCHAR2(1) :&#61; &#39;N&#39;;&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;process_q_msg(number)&#39;;&#10;    --&#10;    l_component_id :&#61; p_component_id;&#10;    l_thread_id :&#61; p_thread_id;&#10;    --&#10;    g_label :&#61; &#39;100000&#39;;&#10;    info(&#39;start [id&#61;&#39; || p_spg_notification_id || &#39;][component_id&#61;&#39; || l_component_id || &#39;][thread_id&#61;&#39; || l_thread_id || &#39;]&#39;);&#10;    --&#10;    IF l_component_id IS NOT NULL THEN&#10;        PKG_MTHREAD.update_thread_progress(&#10;            p_component_id   &#61;&gt; l_component_id,&#10;            p_thread_id      &#61;&gt; l_thread_id,&#10;            p_info_msg       &#61;&gt; &#39;Commence [&#39; || p_spg_notification_id || &#39;]&#39;,&#10;            p_current_id_val &#61;&gt; p_spg_notification_id );&#10;    END IF;&#10;    --&#10;    OPEN cs;&#10;    FETCH cs INTO l_rec;&#10;    IF cs%NOTFOUND THEN&#10;        SPGCONFIG.record_error_message( p_spg_notification_id, &#39;ERROR: failed to locate record in SPG_NOTIFICATION [id&#61;&#39; || p_spg_notification_id || &#39;]&#39; );&#10;        fatal( &#39;ERROR: failed to locate record in SPG_NOTIFICATION [id&#61;&#39; || p_spg_notification_id || &#39;]&#39; );&#10;    ELSIF NVL(l_rec.processed_flag, -1) &lt;&gt; 4 THEN&#10;        --&#10;        warn( &#39;WARNING: SPG_NOTIFICATION.processed_flag is expected to be set to 4 [id&#61;&#39; || p_spg_notification_id || &#39;][processed_flag&#61;&#39; || NVL(l_rec.processed_flag, -1) || &#39;]&#39; );&#10;        IF p_component_id IS NOT NULL THEN&#10;            PKG_MTHREAD.update_thread_progress(&#10;                p_component_id    &#61;&gt; l_component_id,&#10;                p_thread_id       &#61;&gt; l_thread_id,&#10;                p_info_msg        &#61;&gt; &#39;Completed [&#39; || p_spg_notification_id || &#39;]: SPG_NOTIFICATION.processed_flag&lt;&gt;4&#39;,&#10;                p_current_id_val  &#61;&gt; p_spg_notification_id );&#10;        END IF;&#10;        --&#10;        RETURN;&#10;        --&#10;    ELSIF l_rec.message_id IS NOT NULL AND l_rec.message_id &lt;&gt; &#39;PENDING&#39; THEN&#10;        --&#10;        warn( &#39;WARNING: SPG_NOTIFICATION.message_id is expected to be set to PENDING [id&#61;&#39; || p_spg_notification_id || &#39;][message_id&#61;&#39; || l_rec.message_id || &#39;]&#39; );&#10;        IF p_component_id IS NOT NULL THEN&#10;            PKG_MTHREAD.update_thread_progress(&#10;                p_component_id    &#61;&gt; l_component_id,&#10;                p_thread_id       &#61;&gt; l_thread_id,&#10;                p_info_msg        &#61;&gt; &#39;Completed [&#39; || p_spg_notification_id || &#39;]SPG_NOTIFICATION.message_id&lt;&gt;PENDING&#39;,&#10;                p_current_id_val  &#61;&gt; p_spg_notification_id );&#10;        END IF;&#10;        --&#10;        RETURN;&#10;        --&#10;    --ELSE&#10;    --    info(&#39;successfully located record in SPG_NOTIFICATION [id&#61;&#39; || l_spg_notification_id || &#39;]&#39;);&#10;    END IF;&#10;    IF cs%ISOPEN THEN&#10;        CLOSE cs;&#10;    END IF;&#10;    --&#10;    g_procedure_name :&#61; &#39;process_q_msg(number)&#39;;&#10;    info( &#39;All checks passed - processing SPG message [SPG_NOTIFICATION_ID&#61;&#39; || p_spg_notification_id || &#39;]&#39; );&#10;--        info(&#39;establish payload(1) &#39; ||&#10;--            &#39;[spg_notification_id_orig&#61;&#39; || p_spg_notification_id     || &#39;]&#39; ||&#10;--            &#39;[spg_notification_id&#61;&#39;      || l_rec.spg_notification_id || &#39;]&#39; ||&#10;--            &#39;[bi_code&#61;&#39;                  || PKG_Lookups.funcGetBusinessInteraction(l_rec.business_interaction_id) || &#39;]&#39; ||&#10;--            &#39;[offender_id&#61;&#39;              || l_rec.offender_id         || &#39;]&#39; ||&#10;--            &#39;[unique_id&#61;&#39;                || l_rec.unique_id           || &#39;]&#39; );&#10;    l_user_data :&#61;&#10;        SPG_PAYLOAD_TYPE(&#10;            p_spg_notification_id,&#10;            l_rec.date_created,&#10;            PKG_Lookups.funcGetBusinessInteraction(l_rec.business_interaction_id),&#10;            l_rec.offender_id,&#10;            l_rec.unique_id );&#10;--        info(&#39;establish payload(2) &#39; ||&#10;--            &#39;[spg_notification_id&#61;&#39; || l_user_data.spg_notification_id || &#39;]&#39; ||&#10;--            &#39;[bi_code&#61;&#39;             || l_user_data.interaction_code    || &#39;]&#39; ||&#10;--            &#39;[offender_id&#61;&#39;         || l_user_data.offender_id         || &#39;]&#39; ||&#10;--            &#39;[unique_id&#61;&#39;           || l_user_data.grain_table_key     || &#39;]&#39; );&#10;    --&#10;    IF p_component_id IS NOT NULL THEN&#10;        PKG_MTHREAD.update_thread_progress(&#10;            p_component_id    &#61;&gt; l_component_id,&#10;            p_thread_id       &#61;&gt; l_thread_id,&#10;            p_info_msg        &#61;&gt; &#39;Submitting [&#39; || p_spg_notification_id || &#39;]&#39;,&#10;            p_current_id_val  &#61;&gt; p_spg_notification_id );&#10;    END IF;&#10;    --&#10;    BEGIN&#10;        process_q_msg( p_payload_in &#61;&gt; l_user_data );&#10;    EXCEPTION WHEN OTHERS THEN&#10;        IF SQLERRM LIKE &#39;%ORA-06512: at &quot;DELIUS_APP_SCHEMA.VALIDATE_XMLMSG&quot;%&#39; THEN&#10;            NULL;&#10;        ELSE&#10;            RAISE;&#10;        END IF;&#10;    END;&#10;    --&#10;    IF p_component_id IS NOT NULL THEN&#10;        PKG_MTHREAD.update_thread_progress(&#10;            p_component_id    &#61;&gt; l_component_id,&#10;            p_thread_id       &#61;&gt; l_thread_id,&#10;            p_info_msg        &#61;&gt; &#39;Completed [&#39; || p_spg_notification_id || &#39;]&#39;,&#10;            p_current_id_val  &#61;&gt; p_spg_notification_id );&#10;    END IF;&#10;    --&#10;--    IF p_component_id IS NOT NULL THEN&#10;--      PKG_MTHREAD.update_thread_status(p_component_id &#61;&gt; l_component_id, p_thread_id &#61;&gt; l_thread_id, p_status &#61;&gt; 3, p_info_msg &#61;&gt; &#39;Completed&#39;);&#10;--    END IF;&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    IF p_component_id IS NOT NULL THEN&#10;        PKG_MTHREAD.update_thread_status(&#10;            p_component_id  &#61;&gt; l_component_id,&#10;            p_thread_id     &#61;&gt; l_thread_id,&#10;            p_status        &#61;&gt; 2,&#10;            p_err_msg       &#61;&gt; SUBSTRB(SQLERRM || CHR(10) || DBMS_UTILITY.format_error_backtrace, 1, 4000),&#10;            p_info_msg      &#61;&gt; &#39;Error&#39;,&#10;            p_run_fixit_job &#61;&gt; l_run_fixit_job );&#10;        SPGCONFIG.record_error_message( p_spg_notification_id, &#39;ERROR: [&#39; || SUBSTRB(SQLERRM || &#39;]&#39; || CHR(10) || DBMS_UTILITY.format_error_backtrace, 1, 4000) );&#10;    END IF;&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;    --RAISE;&#10;END process_q_msg;&#10;&#10;--&#10;-- Custom Multi-threading support (using PKG_MThread) subroutines&#10;--&#10;PROCEDURE SPG_MT_stop_workers(p_component_id NUMBER DEFAULT NULL)&#10;IS&#10;    PRAGMA AUTONOMOUS_TRANSACTION;&#10;BEGIN&#10;    FOR l_i IN 100..107 LOOP&#10;        IF NVL(p_component_id, l_i) &#61; l_i THEN&#10;            MERGE INTO pdt_semaphore t0&#10;            USING (&#10;              SELECT l_i AS component_code, &#39;STOP&#39; AS signal FROM dual&#10;            ) t1&#10;            ON (t0.component_code &#61; t1.component_code)&#10;            WHEN MATCHED     THEN UPDATE SET t0.signal &#61; t1.signal&#10;            WHEN NOT MATCHED THEN INSERT (component_code   , signal   ) VALUES&#10;                                         (t1.component_code, t1.signal);&#10;        END IF;&#10;    END LOOP;&#10;    COMMIT;&#10;END SPG_MT_stop_workers;&#10;--&#10;PROCEDURE SPG_MT_clear_stop_flags(p_component_id NUMBER DEFAULT NULL)&#10;IS&#10;    --&#10;    CURSOR cs IS&#10;      SELECT DISTINCT component_id, thread_id&#10;      FROM pdt_thread&#10;      WHERE status &#61; 2&#10;        AND component_id BETWEEN 100 AND 107&#10;        AND NVL(p_component_id, component_id) &#61; component_id;&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    PRAGMA AUTONOMOUS_TRANSACTION;&#10;    --&#10;BEGIN&#10;    DELETE FROM pdt_semaphore&#10;    WHERE component_code BETWEEN 100 AND 107&#10;      AND ( component_code &#61; &#39;100&#39; OR&#10;            NVL(TO_CHAR(p_component_id), component_code) &#61; component_code&#10;          )&#10;    ;&#10;    COMMIT;&#10;    --&#10;    OPEN cs;&#10;    LOOP&#10;        FETCH cs INTO l_rec;&#10;        EXIT WHEN cs%NOTFOUND;&#10;        --&#10;        UPDATE spg_notification SET message_id &#61; &#39;&#39;&#10;        WHERE message_direction &#61; &#39;O&#39;&#10;          AND processed_flag &#61; 4&#10;          AND NVL(p_component_id, mt_component_id) &#61; mt_component_id&#10;          AND message_id&#61;&#39;PENDING&#39;;&#10;        --&#10;        -- COMMIT will be implicitly issued from within the PKG_MThread.reset_threads API call&#10;        PKG_MThread.reset_threads(p_component_id&#61;&gt;l_rec.component_id, p_thread_id&#61;&gt;l_rec.thread_id, p_autonomous_trx&#61;&gt;&#39;N&#39;);&#10;        --&#10;    END LOOP;&#10;    CLOSE cs;&#10;    --&#10;    --COMMIT;&#10;    --&#10;END spg_mt_clear_stop_flags;&#10;--&#10;PROCEDURE SPG_MT_create_scheduler_job(p_instance_number INTEGER DEFAULT NULL, p_DROP_ONLY_FLAG VARCHAR2 DEFAULT &#39;N&#39;)&#10;IS&#10;    --&#10;    --l_q_name            CONSTANT VARCHAR2(30) :&#61; &#39;SPG_OUTBOUND&#39;;&#10;    l_job_name          CONSTANT VARCHAR2(30) :&#61; &#39;SPG_OUTBOUND_OXML_JOB&#39;;&#10;    l_program_name      CONSTANT VARCHAR2(30) :&#61; &#39;SPG_OUTBOUND_OXML_PROGRAM&#39;;&#10;    l_schedule_name     CONSTANT VARCHAR2(30) :&#61; &#39;SPG_OUTBOUND_OXML_SCHEDULE&#39;;&#10;    l_schedule_interval CONSTANT INTEGER      :&#61; LEAST( PKG_Lookups.funcgetNDParameterValue(GC_MT_OXML_MASTER_INTERVAL, 1), 59); -- default 1 second; max 59 seconds&#10;    --&#10;    --PRAGMA AUTONOMOUS_TRANSACTION;&#10;    --&#10;    --&#10;BEGIN&#10;    --&#10;    SPG_MT_stop_workers;&#10;    DBMS_LOCK.sleep(10);&#10;    --&#10;    BEGIN&#10;        DBMS_SCHEDULER.drop_job(job_name &#61;&gt; l_job_name, force &#61;&gt; FALSE);&#10;    EXCEPTION WHEN OTHERS THEN&#10;        warn(&#39;Error dropping job [&#39; || l_job_name|| &#39;] &#39; || SQLERRM || &#39;[&#39; || SQLCODE || &#39;]&#39;);&#10;    END;&#10;    --&#10;    BEGIN&#10;        DBMS_SCHEDULER.drop_program(program_name &#61;&gt; l_program_name, force &#61;&gt; FALSE);&#10;    EXCEPTION WHEN OTHERS THEN&#10;        warn(&#39;Error dropping program [&#39;||l_program_name||&#39;] &#39;|| SQLERRM || &#39;[&#39; || SQLCODE || &#39;]&#39;);&#10;    END;&#10;    --&#10;    BEGIN&#10;        DBMS_SCHEDULER.drop_schedule(schedule_name &#61;&gt; l_schedule_name, force &#61;&gt; FALSE);&#10;    EXCEPTION WHEN OTHERS THEN&#10;        warn(&#39;Error dropping schedule [&#39; || l_schedule_name|| &#39;] &#39; || SQLERRM || &#39;[&#39; || SQLCODE || &#39;]&#39;);&#10;    END;&#10;    --&#10;    IF p_DROP_ONLY_FLAG &#61; &#39;Y&#39; THEN&#10;        SPG_MT_clear_stop_flags;&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    DBMS_SCHEDULER.CREATE_SCHEDULE(&#10;        schedule_name   &#61;&gt; l_schedule_name,&#10;        start_date      &#61;&gt; SYSDATE,&#10;        repeat_interval &#61;&gt; &#39;FREQ&#61;SECONDLY;INTERVAL&#61;&#39; || l_schedule_interval,&#10;        end_date        &#61;&gt; NULL,&#10;        comments        &#61;&gt; &#39;SPG Outbound Messages Schedule&#39; );&#10;    --&#10;    IF 1&#61;1 /*SPGConfig.SPGMultiThreadActive*/ THEN&#10;        --&#10;        DBMS_SCHEDULER.create_program(&#10;            program_name        &#61;&gt; l_program_name,&#10;            program_action      &#61;&gt; &#39;SPGMESSAGE.oxml_master&#39;,&#10;            program_type        &#61;&gt; &#39;stored_procedure&#39;,&#10;            number_of_arguments &#61;&gt; 0,&#10;            enabled             &#61;&gt; FALSE );&#10;        --&#10;--        DBMS_SCHEDULER.define_program_argument(&#10;--            program_name      &#61;&gt; l_program_name,&#10;--            argument_name     &#61;&gt; &#39;maxthreads_in&#39;,&#10;--            argument_position &#61;&gt; 1,&#10;--            argument_type     &#61;&gt; &#39;NUMBER&#39; );&#10;        --&#10;        DBMS_SCHEDULER.enable(name &#61;&gt; l_program_name);&#10;        --&#10;--  job_name                IN VARCHAR2,&#10;--  program_name            IN VARCHAR2,&#10;--  schedule_name           IN VARCHAR2,&#10;--  job_class               IN VARCHAR2              DEFAULT &#39;DEFAULT_JOB_CLASS&#39;,&#10;--  enabled                 IN BOOLEAN                  DEFAULT FALSE,&#10;--  auto_drop               IN BOOLEAN                  DEFAULT TRUE,&#10;--  comments                 IN VARCHAR2                 DEFAULT NULL,&#10;--  job_style               IN VARCHAR2                 DEFAULT &#39;REGULAR&#39;,&#10;--  credential_name         IN VARCHAR2                 DEFAULT NULL,&#10;--  destination_name        IN VARCHAR2                 DEFAULT NULL);&#10;&#10;        DBMS_SCHEDULER.create_job(&#10;            job_name      &#61;&gt; l_job_name,&#10;            program_name  &#61;&gt; l_program_name,&#10;            schedule_name &#61;&gt; l_schedule_name,&#10;            --job_type      &#61;&gt; &#39;PLSQL_BLOCK&#39;,&#10;            --start_date    &#61;&gt; SYSDATE,&#10;            enabled       &#61;&gt; FALSE,&#10;            auto_drop     &#61;&gt; TRUE,&#10;            comments      &#61;&gt; &#39;SPG_OUTBOUND_MSG_JOB&#39; );&#10;        --&#10;--        DBMS_SCHEDULER.set_job_argument_value(&#10;--            job_name          &#61;&gt; l_job_name,&#10;--            argument_position &#61;&gt; 1,&#10;--            argument_value    &#61;&gt; (CASE WHEN PKG_Global.GC_SPG_AQ_PARALLEL_MAX &gt; 0 THEN TO_CHAR(PKG_Global.GC_SPG_AQ_PARALLEL_MAX) ELSE &#39;-1&#39; END) );&#10;        --&#10;        IF p_instance_number IS NOT NULL THEN&#10;            -- Set job attribute to single instance number&#10;            DBMS_SCHEDULER.set_attribute(&#10;                name      &#61;&gt; l_job_name,&#10;                attribute &#61;&gt; &#39;instance_id&#39;,&#10;                value     &#61;&gt; p_instance_number );&#10;        END IF;&#10;        --&#10;        DBMS_SCHEDULER.set_attribute(&#10;            name      &#61;&gt; l_job_name,&#10;            attribute &#61;&gt; &#39;parallel_instances&#39;,&#10;            value     &#61;&gt; FALSE );&#10;        --&#10;    END IF;&#10;    --&#10;    /* YF: PG version only&#10;    UPDATE PGAGENT.pga_jobstep SET&#10;      jstonerror &#61; &#39;s&#39;&#10;    WHERE jstjobid &#61; ( SELECT jobid FROM PGAGENT.pga_job WHERE jobname &#61; l_job_name );&#10;    */&#10;    --&#10;    COMMIT;&#10;    --&#10;    DBMS_SCHEDULER.enable(l_job_name);&#10;    --&#10;    SPG_MT_clear_stop_flags;&#10;    --&#10;    --&#10;END SPG_MT_create_scheduler_job;&#10;--&#10;PROCEDURE recover_scheduler_job&#10;IS&#10;    --&#10;    l_job_name        VARCHAR2(30) :&#61; &#39;SPG_OUTBOUND_JOB&#39;;&#10;    l_job_id          NUMBER;&#10;    l_job_step_id     NUMBER;&#10;    l_job_step_log_id NUMBER;&#10;    --&#10;BEGIN&#10;    --&#10;    warn( &#39;SPGMessage.recover_scheduler_job: crash recovery of the [&#39; || l_job_name || &#39;] scheduled job&#39; );&#10;    --&#10;    /* YF: PG version only&#10;    UPDATE pgagent.PGA_JOB SET&#10;      jobagentid&#61;NULL&#10;    WHERE jobid &#61; ( SELECT jobid FROM pgagent.PGA_JOB WHERE jobname &#61; l_job_name )&#10;    RETURNING jobid INTO l_job_id;&#10;    --&#10;    warn( &#39;SPGMessage.recover_scheduler_job: &#39; || SQL%ROWCOUNT || &#39; rows updated in pgagent.PGA_JOB (jobid&#61;&#39; || l_job_id || &#39;)&#39; );&#10;    --&#10;    UPDATE pgagent.PGA_JOBSTEP set jstonerror &#61; &#39;s&#39;&#10;    WHERE jstjobid &#61; l_job_id&#10;    RETURNING jstid INTO l_job_step_id;&#10;    --&#10;    warn( &#39;SPGMessage.recover_scheduler_job: &#39; || SQL%ROWCOUNT || &#39; rows updated in pgagent.PGA_JOBSTEP (jstid&#61;&#39; || l_job_step_id || &#39;)&#39; );&#10;    --&#10;    UPDATE pgagent.PGA_JOBSTEPLOG SET&#10;      jslstatus &#61; &#39;s&#39;,&#10;      jslresult &#61; 0,&#10;      jslduration &#61; TO_DATE(&#39;19700101 12:00:01&#39;, &#39;YYYYMMDD HH24:MI:SS&#39;) - TO_DATE(&#39;19700101 12:00:00&#39;, &#39;YYYYMMDD HH24:MI:SS&#39;),&#10;      jsloutput &#61; &#39;Manually terminated&#39;&#10;    WHERE jsljstid &#61; l_job_step_id&#10;      AND jslstatus &#61; &#39;r&#39;&#10;    --RETURNING jslid INTO l_job_step_log_id&#10;    ;&#10;    --&#10;    warn( &#39;SPGMessage.recover_scheduler_job: &#39; || SQL%ROWCOUNT || &#39; rows updated in pgagent.PGA_JOBSTEPLOG (jstid&#61;&#39; || l_job_step_id || &#39;)(jstid&#61;&#39; || l_job_step_id || &#39;)&#39; );&#10;    --&#10;--    UPDATE pgagent.PGA_JOBLOG SET&#10;--      jlgstatus &#61; &#39;s&#39;,&#10;--      jlgduration &#61; TO_DATE(&#39;19700101 12:00:01&#39;, &#39;YYYYMMDD HH24:MI:SS&#39;) - TO_DATE(&#39;19700101 12:00:00&#39;, &#39;YYYYMMDD HH24:MI:SS&#39;)&#10;--    WHERE jlgjobid &#61; l_job_id;&#10;--    --&#10;--    warn( &#39;SPGMessage.recover_scheduler_job: &#39; || SQL%ROWCOUNT || &#39; rows updated in pgagent.PGA_JOBLOG (jlgjobid&#61;&#39; || l_job_id || &#39;)&#39; );&#10;    */&#10;    --&#10;    NULL;&#10;    --&#10;END recover_scheduler_job;&#10;--&#10;&#10;--&#10;-- OXML Master Process&#10;--&#10;&#10;-- PG (old) logic:&#10;--    l_master_thread_id :&#61;&#10;--        PKG_MTHREAD.get_available_thread(&#10;--            p_component_id  &#61;&gt; LC_MASTER_COMPONENT_ID,&#10;--            p_wait          &#61;&gt; lc_wait,&#10;--            p_timeout       &#61;&gt; lc_timeout,&#10;--            p_max_threads   &#61;&gt; lc_max_threads );&#10;--    info(&#39;oxml_master: master thread_id&#61;&#39; || l_master_thread_id);&#10;--    --&#10;--    IF l_master_thread_id &gt; 0 THEN&#10;--        oxml_master_worker(slave_componentid_in &#61;&gt; (lc_master_component_id + l_master_thread_id));&#10;--    END IF;&#10;--&#10;FUNCTION get_spg_mt_max_threads(&#10;    p_master_thread_id INTEGER,&#10;    p_date_time        DATE DEFAULT SYSDATE )&#10;RETURN INTEGER IS&#10;    --&#10;    l_peak_start_time INTEGER;&#10;    l_peak_end_time   INTEGER;&#10;    l_peak_time_flag  BOOLEAN;&#10;    --&#10;    l_nd_parameter    VARCHAR2(100);&#10;    --&#10;    l_max_threads     INTEGER;&#10;    --&#10;BEGIN&#10;    --&#10;    --    GC_MT_OXML_PARALLEL_1_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_1_PEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_1_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_1_OFFPEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_2_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_2_PEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_2_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_2_OFFPEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_3_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_3_PEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_3_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_3_OFFPEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_4_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_4_PEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_4_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_4_OFFPEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_5_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_5_PEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_5_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_5_OFFPEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_6_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_6_PEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_6_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_6_OFFPEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_7_PEAK    CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_7_PEAK&#39;;&#10;    --    GC_MT_OXML_PARALLEL_7_OFFPEAK CONSTANT VARCHAR2(100) :&#61; &#39;SPG_MT_OXML_PARALLEL_7_OFFPEAK&#39;;&#10;    --&#10;    l_peak_start_time :&#61; PKG_Lookups.funcgetNDParameterValue(&#39;PEAK_START_TIME&#39;, 9  * 3600000 );&#10;    l_peak_end_time   :&#61; PKG_Lookups.funcgetNDParameterValue(&#39;PEAK_END_TIME&#39;  , 18 * 3600000 );&#10;    l_peak_time_flag  :&#61; ( (p_date_time - TRUNC(p_date_time)) * 24 * 3600000 BETWEEN l_peak_start_time AND l_peak_end_time );&#10;    l_nd_parameter    :&#61; &#39;SPG_MT_OXML_PARALLEL_&#39; || p_master_thread_id || &#39;_&#39; || CASE WHEN l_peak_time_flag THEN &#39;PEAK&#39; ELSE &#39;OFFPEAK&#39; END;&#10;    --&#10;    l_max_threads :&#61;&#10;        PKG_Lookups.funcgetNDParameterValue(&#10;            l_nd_parameter,&#10;            CASE&#10;             WHEN p_master_thread_id &#61; GC_SPG_MT_DOCUMENTS_WIP THEN 5&#10;             WHEN p_master_thread_id &#61; GC_SPG_MT_DOCUMENTS     THEN 10&#10;             WHEN p_master_thread_id &#61; GC_SPG_MT_REF_DATA      THEN 1&#10;             WHEN p_master_thread_id &#61; GC_SPG_MT_CRC_EXPORT    THEN 2&#10;             WHEN p_master_thread_id &#61; GC_SPG_MT_SEARCH        THEN 10&#10;             WHEN p_master_thread_id &#61; GC_SPG_MT_COMMON_ALLOC  THEN 2&#10;             WHEN p_master_thread_id &#61; GC_SPG_MT_COMMON        THEN 10&#10;             ELSE 1&#10;         END&#10;    );&#10;    --&#10;    RETURN l_max_threads;&#10;    --&#10;END get_spg_mt_max_threads;&#10;--&#10;PROCEDURE oxml_master&#10;IS&#10;    --&#10;    l_procedure_name VARCHAR2(30) :&#61; g_procedure_name;&#10;    --&#10;    l_lock_name   VARCHAR2(30) :&#61; &#39;SPG_OXML_MASTER_LOCK&#39;;&#10;    l_lock_handle VARCHAR2(128);&#10;    l_dummy       PLS_INTEGER;&#10;    --&#10;    LC_MASTER_COMPONENT_ID  CONSTANT INTEGER :&#61; 100;&#10;    --&#10;    lc_wait                INTEGER :&#61; LEAST( PKG_Lookups.funcgetNDParameterValue(GC_MT_OXML_MASTER_WAIT, 1), 5);   -- default 1 second; max 5 seconds&#10;    lc_timeout             INTEGER :&#61; 30;    -- 30 minutes&#10;    lc_max_threads         INTEGER :&#61; 7;     -- 1*ALF + 1*REF + 1*CRCExport + 1*Allocate + 1*SPG + 1*SEARCH + 1*ALF_WIP&#10;    --&#10;    l_master_thread_id     INTEGER;&#10;    l_thread_status        INTEGER;&#10;    l_all_threads_finished BOOLEAN;&#10;    --&#10;    l_slave_component_id   INTEGER;&#10;    l_max_threads          INTEGER;&#10;    l_slave_program_action VARCHAR2(512);&#10;    --&#10;    TYPE l_mt_batches_tab_TYP IS TABLE OF NUMBER INDEX BY PLS_INTEGER;&#10;    l_mt_batches_tab l_mt_batches_tab_TYP;&#10;    --&#10;    PROCEDURE do_allocate_soft_lock IS&#10;    BEGIN&#10;        DBMS_LOCK.allocate_unique(l_lock_name, l_lock_handle);&#10;        l_dummy :&#61; DBMS_LOCK.request(l_lock_handle, DBMS_LOCK.x_mode, DBMS_LOCK.maxwait, FALSE);&#10;    END do_allocate_soft_lock;&#10;    --&#10;    PROCEDURE do_release_soft_lock IS&#10;    BEGIN&#10;        l_dummy :&#61; DBMS_LOCK.release(l_lock_handle);&#10;    END do_release_soft_lock;&#10;    --&#10;    PROCEDURE do_pull_pending_records&#10;    IS&#10;        --&#10;        CURSOR cs IS&#10;          WITH T AS (&#10;            SELECT /*+ INDEX (S, XIE2SPG_NOTIFICATION) */&#10;              spg_notification_id,&#10;              BI.business_interaction_code AS bi_code,&#10;              sender_identity_id,&#10;--              PA1.code                     AS sender_area,&#10;              receiver_identity_id,&#10;--              PA2.code                     AS receiver_area,&#10;              S.offender_id,&#10;--              O.crn,&#10;              S.unique_id,&#10;              S.date_created,&#10;              S.control_reference,&#10;              S.receiver_control_reference,&#10;              S.error_flag,&#10;              S.error_message,&#10;              S.processed_flag,&#10;              S.mt_component_id,&#10;              S.mt_thread_id,&#10;              NVL(S.export_to_file_flag, 0) AS export_to_file_flag&#10;            FROM&#10;              spg_notification S&#10;                --LEFT OUTER JOIN offender O ON O.offender_id &#61; S.offender_id&#10;                INNER JOIN business_interaction BI ON BI.business_interaction_id &#61; S.business_interaction_id&#10;                --LEFT OUTER JOIN probation_area PA1 ON PA1.probation_area_id &#61; S.sender_identity_id&#10;                --LEFT OUTER JOIN probation_area PA2 ON PA2.probation_area_id &#61; S.receiver_identity_id&#10;            WHERE 1&#61;1&#10;              AND BI.business_interaction_code NOT LIKE &#39;SPGISN___&#39;&#10;              AND ( ( message_direction &#61; &#39;O&#39; AND processed_flag &#61; 0 ) OR&#10;                    ( message_direction &#61; &#39;O&#39; AND processed_flag &#61; 4 AND NVL(message_id, &#39;XYZ&#39;) &lt;&gt; &#39;PENDING&#39; )&#10;                  )&#10;--              AND ( message_direction, processed_flag, NVL(mt_component_id, -1) ) IN (&#10;--                    SELECT &#39;O&#39;, 0, -1 FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, lc_master_component_id + GC_SPG_MT_DOCUMENTS_WIP FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, lc_master_component_id + GC_SPG_MT_DOCUMENTS     FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, lc_master_component_id + GC_SPG_MT_REF_DATA      FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, lc_master_component_id + GC_SPG_MT_CRC_EXPORT    FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, lc_master_component_id + GC_SPG_MT_SEARCH        FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, lc_master_component_id + GC_SPG_MT_COMMON_ALLOC  FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, lc_master_component_id + GC_SPG_MT_COMMON        FROM dual UNION ALL&#10;--                    SELECT &#39;O&#39;, 4, -1                                               FROM dual&#10;--                  )&#10;              AND ( NVL(mt_thread_id, -1) &#61; -1 OR ( mt_thread_id &gt; 0 AND SYSDATE - date_created &gt; 1 * 1/24/60 ) )&#10;            )&#10;            --&#10;            SELECT&#10;              CASE&#10;                  -- SPG Alfresco WIP Flag Reset&#10;                  WHEN bi_code LIKE &#39;WPBI108&#39;&#10;                      THEN GC_SPG_MT_DOCUMENTS_WIP&#10;                  -- SPG Alfresco Permission&#10;                  WHEN bi_code LIKE &#39;SPGALF%&#39;&#10;                      THEN GC_SPG_MT_DOCUMENTS&#10;                  -- SPG Reference Data&#10;                  WHEN bi_code LIKE &#39;REF%&#39; OR bi_code LIKE &#39;R__CONFIG&#39; OR bi_code LIKE &#39;LLBI___&#39;&#10;                      THEN GC_SPG_MT_REF_DATA&#10;                  WHEN ( SELECT COUNT(1)&#10;                         FROM offender_crc_export&#10;                         WHERE offender_id &#61; T.offender_id&#10;                           AND crc_provider_id &#61; T.receiver_identity_id&#10;                           AND current_record_flag &#61; &#39;Y&#39;&#10;                           AND processed_datetime IS NULL&#10;                           AND error_flag &#61; 0&#10;                           AND BATCH_FLAG &#61; 1 ) &gt;&#61; 1&#10;                      THEN GC_SPG_MT_CRC_EXPORT&#10;                  WHEN T.export_to_file_flag &#61; 1 AND bi_code IN ( &#39;CABI020&#39;, &#39;CABI041&#39; )&#10;                      THEN GC_SPG_MT_CRC_EXPORT&#10;                  WHEN bi_code IN ( &#39;SPGBI902&#39;,   --&#39;2224&#39;, &#39;OFFLOCRequest&#39;&#10;                                    &#39;SPGBI904&#39;,   --&#39;2226&#39;, &#39;NationalSearchRequest&#39;&#10;                                    &#39;SPGBI905&#39;,   --&#39;2228&#39;, &#39;NatSearchResponse&#39;, &#39;2228,2227,2230,2231,2232&#39;&#10;                                    &#39;SPGBI903&#39;,   --&#39;2229&#39;, &#39;OFFLOCResponse&#39;, &#39;2229,2225&#39;&#10;                                    &#39;SPGADBI015&#39;, --&#39;5001&#39;, &#39;GetEntity&#39;, &#39;5001&#39;&#10;                                    &#39;NSBI010&#39;,    --&#39;5003&#39;, &#39;SearchContact&#39;, &#39;5003&#39;&#10;                                    &#39;SPGADBI016&#39;, --&#39;5006&#39;, &#39;GetDocumentList&#39;, &#39;5006&#39;&#10;                                    &#39;SPGBI112&#39;    --&#39;1065&#39;, &#39;DocumentList&#39;, &#39;1065,1066&#39;&#10;                                  )&#10;                      THEN GC_SPG_MT_SEARCH&#10;                  WHEN bi_code IN ( &#39;CABI020&#39;, &#39;CABI041&#39; )&#10;                      THEN GC_SPG_MT_COMMON_ALLOC&#10;                  ELSE GC_SPG_MT_COMMON&#10;              END AS oxml_master_thread_id,&#10;              --&#10;              T.*&#10;            FROM T&#10;            WHERE 1&#61;1&#10;            ORDER BY&#10;              processed_flag,&#10;              1,&#10;              date_created,&#10;              control_reference;&#10;        --&#10;        TYPE l_TAB_TYP IS TABLE OF cs%ROWTYPE;&#10;        l_TAB l_TAB_TYP;&#10;        l_rec cs%ROWTYPE;&#10;        --&#10;        --PRAGMA AUTONOMOUS_TRANSACTION;&#10;        --&#10;    BEGIN&#10;        --&#10;        FOR l_idx IN 1..lc_max_threads LOOP&#10;            l_mt_batches_tab(l_idx) :&#61; 0;&#10;        END LOOP;&#10;        --&#10;        OPEN cs;&#10;        FETCH cs BULK COLLECT INTO l_TAB LIMIT 1000000;&#10;        CLOSE cs;&#10;        --&#10;        debug_msg(&#39;OXML_MASTER.do_pull_pending_records:&#39; || NVL(l_TAB.COUNT, 0) || &#39; records have been fetched from SPG_NOTIFICATION&#39;);&#10;        --&#10;        FOR l_idx IN 1..l_TAB.COUNT LOOP&#10;            --&#10;            l_rec :&#61; l_TAB(l_idx);&#10;            l_mt_batches_tab(l_rec.oxml_master_thread_id) :&#61; l_mt_batches_tab(l_rec.oxml_master_thread_id) + 1;&#10;            --&#10;            IF l_rec.processed_flag &#61; 0 THEN&#10;                UPDATE spg_notification SET&#10;                  processed_flag  &#61; 4,&#10;                  date_submitted  &#61; SYSDATE,&#10;                  mt_component_id &#61; lc_master_component_id + l_rec.oxml_master_thread_id,&#10;                  mt_thread_id    &#61; -1&#10;                WHERE spg_notification_id &#61; l_rec.spg_notification_id&#10;                  AND processed_flag &#61; 0&#10;                  AND message_direction &#61; &#39;O&#39;;&#10;            END IF;&#10;            --&#10;        END LOOP;&#10;        --&#10;        IF l_mt_batches_tab(GC_SPG_MT_DOCUMENTS_WIP) &#61; 0 THEN&#10;            AlfrescoSupport.submitDocResetWIPBatch;&#10;        END IF;&#10;        --COMMIT;&#10;        --&#10;--        debug_msg(&#39;OXML_MASTER.do_pull_pending_records - pending messages per MThread:&#39;);&#10;--        FOR l_idx IN 1..lc_max_threads LOOP&#10;--            debug_msg(&#39;  &#39; || l_idx || &#39; - &#39; || l_mt_batches_tab(l_idx) || &#39; records&#39;);&#10;--        END LOOP;&#10;        --&#10;    END do_pull_pending_records;&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;oxml_master&#39;;&#10;    --&#10;    IF NOT SPGConfig.SPGMultiThreadActive THEN&#10;        info(&#39;oxml_master: SPGConfig.SPGMultiThreadActive is set to FALSE&#39;);&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    do_allocate_soft_lock;&#10;    --&#10;    info(&#39;oxml_master: max_threads&#61;&#39; || lc_max_threads);&#10;    --&#10;    --      2.1. In OXML_Worker - scan SPG_NOTIFICATION for (processed_flag&#61;0 AND mt_thread_id&#61;..)&#10;    --&#10;    LOOP&#10;        --&#10;        l_all_threads_finished :&#61; TRUE;&#10;        --&#10;        EXIT WHEN PKG_MTHREAD.check_semaphore( p_component_code&#61;&gt;TO_CHAR(lc_master_component_id), p_signal&#61;&gt;&#39;STOP&#39; ) &#61; &#39;Y&#39;;&#10;        --&#10;        do_pull_pending_records;&#10;        COMMIT;&#10;        --&#10;        FOR l_master_thread_id IN 1..lc_max_threads LOOP&#10;            --&#10;            debug_msg(&#39;Checking OXML Master Thread [&#39; || l_master_thread_id || &#39;][&#39; || l_mt_batches_tab(l_master_thread_id) || &#39; records]&#39;);&#10;            --&#10;            IF l_mt_batches_tab(l_master_thread_id) &gt; 0 THEN&#10;                --&#10;                l_slave_component_id :&#61; (lc_master_component_id + l_master_thread_id);&#10;                --&#10;                --&#10;                -- GC_SPG_MT_DOCUMENTS     CONSTANT INTEGER :&#61; 1;&#10;                -- GC_SPG_MT_REF_DATA      CONSTANT INTEGER :&#61; 2;&#10;                -- GC_SPG_MT_CRC_EXPORT    CONSTANT INTEGER :&#61; 3;&#10;                -- GC_SPG_MT_SEARCH        CONSTANT INTEGER :&#61; 4;&#10;                -- GC_SPG_MT_COMMON_ALLOC  CONSTANT INTEGER :&#61; 5;&#10;                -- GC_SPG_MT_COMMON        CONSTANT INTEGER :&#61; 6;&#10;                -- GC_SPG_MT_DOCUMENTS_WIP CONSTANT INTEGER :&#61; 7;&#10;                --&#10;                l_max_threads :&#61; get_spg_mt_max_threads(l_master_thread_id);&#10;                --&#10;                --PKG_MThread.wait_for_threads_to_finish( p_component_id&#61;&gt;LC_MASTER_COMPONENT_ID, p_thread_id&#61;&gt;l_master_thread_id, p_wait&#61;&gt;0.5 );&#10;                --&#10;                l_thread_status :&#61; PKG_MThread.get_thread_status( LC_MASTER_COMPONENT_ID, l_master_thread_id );&#10;                --&#10;                debug_msg(&#39;OXML Master Thread Component &#39; ||&#10;                    &#39;[&#39;             || LC_MASTER_COMPONENT_ID   || &#39;]&#39; ||&#10;                    &#39;[&#39;             || l_master_thread_id       || &#39;]&#39; ||&#10;                    &#39;[MAX_THREADS&#61;&#39; || l_max_threads            || &#39;]&#39; ||&#10;                    &#39;[STATUS&#61;&#39;      || l_thread_status          || &#39;]&#39; );&#10;                --&#10;                IF    l_thread_status &#61; 1 THEN&#10;                    -- Master Thread is still running&#10;                    --   .. should carry on picking up records with PROCESSED_FLAG&#61;4&#10;                    PKG_MTHREAD.check_heartbeat_ALL(lc_master_component_id, l_master_thread_id);&#10;                    --&#10;                    l_all_threads_finished :&#61; FALSE;&#10;                ELSIF l_thread_status IN( -1, 3 ) THEN -- Completed successfully&#10;                    --&#10;                    l_all_threads_finished :&#61; FALSE;&#10;                    --&#10;                    l_slave_program_action :&#61; &#39;BEGIN SPGMessage.oxml_master_worker(slave_componentid_in&#61;&gt;&#39; || l_slave_component_id || &#39;, maxthreads_in&#61;&gt;NULL&#39; /*|| l_max_threads*/ || &#39;); END;&#39;;&#10;                    --&#10;                    PKG_MTHREAD.create_thread_process(&#10;                        p_component_id      &#61;&gt; lc_master_component_id,&#10;                        p_thread_id         &#61;&gt; l_master_thread_id,&#10;                        p_program_action    &#61;&gt; l_slave_program_action,&#10;                        p_job_name          &#61;&gt; &#39;SPG OXML Master Worker&#39;,&#10;                        p_thread_label      &#61;&gt; TO_CHAR(l_slave_component_id),&#10;                        p_instance_number   &#61;&gt; 1 );&#10;                    --&#10;                ELSIF l_thread_status &#61; 2 THEN -- Completed with ERROR&#10;                    warn(&#10;                        &#39;SPGMessage.oxml_master[&#39; || lc_master_component_id || &#39;][&#39; || l_master_thread_id || &#39;] thread status &#61; 2 detected: &#39; || CHR(10) ||&#10;                        PKG_Lookups.funcgetTabRecord(&#10;                            p_table &#61;&gt; &#39;PDT_THREAD&#39;,&#10;                            p_ref_col     &#61;&gt; &#39;component_id&#39;,&#10;                            p_ref_val     &#61;&gt; TO_CHAR(lc_master_component_id),&#10;                            p_where       &#61;&gt; &#39;thread_id &#61; TO_NUMBER(:p_thread_id)&#39;,&#10;                            p_bind_var1   &#61;&gt; TO_CHAR(l_master_thread_id),&#10;                            p_data_fld    &#61;&gt; &#39;SUBSTR(&#39;&#39;[INFO&#61;&#39;&#39; || info_message || &#39;&#39;][ERRM&#61;&#39;&#39; || error_message || &#39;&#39;]&#39;&#39;, 1, 4000)&#39; ) );&#10;                END IF;&#10;                --&#10;            END IF; --IF l_mt_batches_tab(l_idx) &gt; 0&#10;            --&#10;        END LOOP;&#10;        --&#10;        EXIT WHEN l_all_threads_finished &#61; TRUE;&#10;        --&#10;        SYS.DBMS_LOCK.sleep(lc_wait);&#10;        --&#10;    END LOOP;&#10;    --&#10;    info(&#39;OXML_MASTER: SPG Outbound Master Process has completed due to no outbound messages left in the SPG Outbound queue&#39;);&#10;    --&#10;    do_release_soft_lock;&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    do_release_soft_lock;&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;    RAISE;&#10;    --&#10;END oxml_master;&#10;--&#10;PROCEDURE oxml_master_worker(&#10;    slave_componentid_in PDT_THREAD.component_id%TYPE,&#10;    maxthreads_in        NUMBER DEFAULT -1 )&#10;IS&#10;    --&#10;    l_procedure_name VARCHAR2(30) :&#61; g_procedure_name;&#10;    --&#10;    l_component_id          PDT_THREAD.component_id%TYPE;&#10;    lc_master_component_id  PDT_THREAD.component_id%TYPE;&#10;    l_master_thread_id      PDT_THREAD.thread_id%TYPE;&#10;    l_spg_master_thread_id  PDT_THREAD.thread_id%TYPE;&#10;    --&#10;    --&#10;    l_wait              NUMBER  :&#61; LEAST( PKG_Lookups.funcgetNDParameterValue(GC_MT_OXML_WORKER_WAIT, 0.5), 5); -- default 0.5 seconds; max 5 seconds&#10;    l_timeout           INTEGER :&#61; 30;&#10;    l_max_threads       INTEGER;&#10;    --&#10;    l_thread_id         PDT_THREAD.thread_id%TYPE;&#10;    l_program_action    VARCHAR2(4000);&#10;    --&#10;    l_stop_flag         VARCHAR2(1) :&#61; &#39;N&#39;;&#10;    l_wait_counter      INTEGER :&#61; 0;&#10;    --&#10;    CURSOR cs IS&#10;      WITH T AS (&#10;        SELECT&#10;          spg_notification_id,&#10;          S.offender_id,&#10;          S.unique_id,&#10;          S.date_created,&#10;          S.control_reference,&#10;          S.mt_component_id,&#10;          S.mt_thread_id&#10;        FROM&#10;          spg_notification S&#10;        WHERE 1&#61;1&#10;          AND S.message_direction     &#61; &#39;O&#39;&#10;          AND S.processed_flag        &#61; 4&#10;          AND S.mt_component_id       &#61; slave_componentid_in&#10;          AND NVL(message_id, &#39;XYZ&#39;) &lt;&gt; &#39;PENDING&#39;&#10;        )&#10;        --&#10;        SELECT T.*&#10;        FROM T&#10;        WHERE 1&#61;1&#10;        ORDER BY&#10;          date_created,&#10;          offender_id,&#10;          control_reference;&#10;    --&#10;    TYPE l_TAB_TYP IS TABLE OF cs%ROWTYPE;&#10;    l_TAB l_TAB_TYP;&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    PROCEDURE do_pull_pending_records&#10;    IS&#10;        --&#10;        --PRAGMA AUTONOMOUS_TRANSACTION;&#10;        --&#10;    BEGIN&#10;        --&#10;--        FOR l_idx IN 1..lc_max_threads LOOP&#10;--            l_mt_batches_tab(l_idx) :&#61; 0;&#10;--        END LOOP;&#10;        --&#10;        OPEN cs;&#10;        FETCH cs BULK COLLECT INTO l_TAB LIMIT 10000;&#10;        CLOSE cs;&#10;        --&#10;        info(&#39;OXML_MASTER_WORKER.do_pull_pending_records[&#39; || slave_componentid_in || &#39;]:&#39; || NVL(l_TAB.COUNT, 0) || &#39; records have been fetched from SPG_NOTIFICATION&#39;);&#10;        --&#10;    END do_pull_pending_records;&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;oxml_master_worker&#39;;&#10;    --&#10;    -- determine master thread from slave component_id&#10;    lc_master_component_id  :&#61; 100;&#10;    l_master_thread_id      :&#61; slave_componentid_in - lc_master_component_id;&#10;    --&#10;    -- update master thread&#10;    -- YF: in ORA version, OXML_MASTER_WORKER is already running as MT Thread, -&#10;    --     therefore no need in creating a fake MT process&#10;--    PKG_MTHREAD.create_thread_process(&#10;--        p_component_id      &#61;&gt; lc_master_component_id,&#10;--        p_thread_id         &#61;&gt; l_master_thread_id,&#10;--        p_program_action    &#61;&gt; &#39;no_program_action&#39;,&#10;--        p_job_name          &#61;&gt; &#39;OXML Master&#39;,&#10;--        p_thread_label      &#61;&gt; TO_CHAR(slave_componentid_in),&#10;--        p_instance_number   &#61;&gt; 1 );&#10;    --&#10;    PKG_MTHREAD.update_thread_status(&#10;        p_component_id    &#61;&gt; lc_master_component_id,&#10;        p_thread_id       &#61;&gt; l_master_thread_id,&#10;        p_status          &#61;&gt; 1,&#10;        p_info_msg        &#61;&gt; &#39;Master commenced&#39;&#10;        /*p_autonomous_trx  &#61;&gt; &#39;Y&#39;*/ );&#10;    --&#10;    l_component_id :&#61; slave_componentid_in;&#10;    --PKG_MTHREAD.check_heartbeat_ALL(p_component_id &#61;&gt; l_component_id);&#10;    --PKG_MTHREAD.reset_threads(p_component_id &#61;&gt; l_component_id);&#10;    --COMMIT;&#10;&#10;    --&#10;    l_wait_counter :&#61; 0;&#10;    --&#10;    LOOP&#10;        --&#10;        EXIT WHEN PKG_MTHREAD.check_semaphore(p_component_code&#61;&gt;TO_CHAR(l_component_id), p_signal&#61;&gt;&#39;STOP&#39;) &#61; &#39;Y&#39;;&#10;        --&#10;        -- Pull up to 10,000 pending records (with PROCESSED_FLAG&#61;4)&#10;        do_pull_pending_records;&#10;        --&#10;        EXIT WHEN NVL(l_TAB.COUNT, 0) &#61; 0 AND l_wait_counter &gt;&#61; 10;&#10;        --&#10;        PKG_MTHREAD.update_thread_status(&#10;            p_component_id  &#61;&gt; lc_master_component_id,&#10;            p_thread_id     &#61;&gt; l_master_thread_id,&#10;            p_status        &#61;&gt; 1,&#10;            p_info_msg      &#61;&gt; &#39;Master commenced [wait counter &#61; &#39; || TO_CHAR(l_wait_counter) || &#39;]&#39;);&#10;        --&#10;        FOR l_idx IN 1..l_TAB.COUNT LOOP&#10;            --&#10;            l_rec :&#61; l_TAB(l_idx);&#10;            --&#10;            PKG_MTHREAD.update_thread_status(&#10;                p_component_id  &#61;&gt; lc_master_component_id,&#10;                p_thread_id     &#61;&gt; l_master_thread_id,&#10;                p_status        &#61;&gt; 1,&#10;                p_info_msg      &#61;&gt; &#39;Master commenced [wait counter &#61; &#39; || TO_CHAR(l_wait_counter) || &#39;][spg_not_id&#61;&#39; || l_rec.spg_notification_id || &#39;]&#39;);&#10;            --&#10;            info(&#39;OXML_MASTER_WORKER: get_available_thread(&#39; || l_component_id || &#39;, &#39; || l_wait || &#39;, &#39; || l_timeout || &#39; ,&#39; || l_max_threads || &#39;)&#39;);&#10;            --&#10;            l_max_threads :&#61;&#10;                CASE&#10;                    WHEN maxthreads_in &gt; 1 THEN&#10;                        LEAST( maxthreads_in, 8 * PKG_MThread.get_cpu_count )&#10;                    ELSE&#10;                        LEAST( get_spg_mt_max_threads(l_master_thread_id), 8 * PKG_MThread.get_cpu_count )&#10;                END;&#10;            --&#10;            LOOP&#10;                l_thread_id :&#61; PKG_MTHREAD.get_available_thread(&#10;                                    p_component_id &#61;&gt; l_component_id,&#10;                                    p_wait         &#61;&gt; l_wait,&#10;                                    p_timeout      &#61;&gt; l_timeout,&#10;                                    p_max_threads  &#61;&gt; l_max_threads);&#10;                EXIT WHEN l_thread_id &gt; 0;&#10;            END LOOP;&#10;            --&#10;            info(&#39;OXML_MASTER_WORKER: get_available_thread - end [component_id&#61;&#39; || l_component_id || &#39;][thread_id&#61;&#39; || l_thread_id || &#39;]&#39;);&#10;            --&#10;            PKG_DynSQL.exec_SQL_atnm(&#10;               &#39;UPDATE spg_notification SET&#10;                  /*YF: status should stay at value 4: processed_flag &#61; 0,*/&#10;                  mt_thread_id   &#61; :p_thread_id,&#10;                  date_submitted &#61; SYSDATE,&#10;                  message_id     &#61; &#39;&#39;PENDING&#39;&#39;&#10;                WHERE spg_notification_id &#61; :p_spg_notification_id&#39;,&#10;               p_param_1 &#61;&gt; TO_CHAR(l_thread_id),&#10;               p_param_2 &#61;&gt; TO_CHAR(l_rec.spg_notification_id) );&#10;            --&#10;            l_program_action :&#61; &#39;BEGIN SPGMESSAGE.oxml_worker(slave_componentid_in&#61;&gt;&#39; || l_component_id || &#39;, slave_threadid_in&#61;&gt;&#39; || l_thread_id || &#39;, p_spg_notification_id&#61;&gt;NULL); END;&#39;;&#10;            --&#10;            PKG_MTHREAD.update_thread_status(&#10;                p_component_id  &#61;&gt; lc_master_component_id,&#10;                p_thread_id     &#61;&gt; l_master_thread_id,&#10;                p_status        &#61;&gt; 1,&#10;                p_info_msg      &#61;&gt; &#39;Master commenced [wait counter &#61; &#39; || TO_CHAR(l_wait_counter) || &#39;][spg_not_id&#61;&#39; || l_rec.spg_notification_id || &#39;][thread&#61;&#39; || l_thread_id || &#39;]&#39;);&#10;            --&#10;            PKG_MTHREAD.create_thread_process(&#10;                p_component_id      &#61;&gt; l_component_id,&#10;                p_thread_id         &#61;&gt; l_thread_id,&#10;                p_min_id_val        &#61;&gt; NULL,&#10;                p_max_id_val        &#61;&gt; NULL,&#10;                p_current_id_val    &#61;&gt; l_rec.spg_notification_id,&#10;                p_program_action    &#61;&gt; l_program_action,&#10;                p_job_name          &#61;&gt; &#39;OXML Slave&#39;,&#10;                p_thread_label      &#61;&gt; NULL, --TO_CHAR(mq_row.spg_notification_id),&#10;                p_instance_number   &#61;&gt; 1,&#10;                p_fixit_proc        &#61;&gt; NULL /*&#39;SPGMessage.oxml_worker_failover&#39;*/ );&#10;            --&#10;        END LOOP;&#10;        --&#10;        l_wait_counter :&#61; l_wait_counter + 1;&#10;        DBMS_LOCK.sleep(l_wait);&#10;        --&#10;    END LOOP;&#10;    --&#10;    PKG_MTHREAD.update_thread_status(&#10;        p_component_id  &#61;&gt; lc_master_component_id,&#10;        p_thread_id     &#61;&gt; l_master_thread_id,&#10;        p_status        &#61;&gt; 1,&#10;        p_info_msg      &#61;&gt; &#39;Master Completed [wait counter &#61; &#39; || TO_CHAR(l_wait_counter) || &#39;]: wait for all threads to finish&#39;);&#10;    --&#10;    PKG_MTHREAD.wait_for_threads_to_finish(p_component_id  &#61;&gt; l_component_id);&#10;    --&#10;    PKG_MTHREAD.update_thread_status(&#10;        p_component_id &#61;&gt; lc_master_component_id,&#10;        p_thread_id    &#61;&gt; l_master_thread_id,&#10;        p_status       &#61;&gt; 3,&#10;        p_info_msg     &#61;&gt; &#39;Master Completed&#39; );&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    PKG_MTHREAD.update_thread_status(&#10;        p_component_id &#61;&gt; lc_master_component_id,&#10;        p_thread_id    &#61;&gt; l_master_thread_id,&#10;        p_status       &#61;&gt; 2,&#10;        p_err_msg      &#61;&gt; SUBSTRB(SQLERRM || CHR(10) || DBMS_UTILITY.format_error_backtrace, 1, 4000),&#10;        p_info_msg     &#61;&gt; &#39;Master Error&#39; );&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;    --RAISE;&#10;END oxml_master_worker;&#10;--&#10;PROCEDURE oxml_worker(&#10;    slave_componentid_in  IN PDT_THREAD.component_id%TYPE,&#10;    slave_threadid_in     IN PDT_THREAD.thread_id%TYPE,&#10;    p_spg_notification_id IN NUMBER )&#10;IS&#10;    --&#10;    l_procedure_name VARCHAR2(30) :&#61; g_procedure_name;&#10;    --&#10;    l_spg_notification_id NUMBER;&#10;    --&#10;    PROCEDURE do_prepare_message_record&#10;    IS&#10;        --PRAGMA AUTONOMOUS_TRANSACTION;&#10;    BEGIN&#10;        IF p_spg_notification_id IS NULL THEN&#10;            BEGIN&#10;                SELECT current_id_val&#10;                INTO l_spg_notification_id&#10;                FROM pdt_thread&#10;                WHERE component_id &#61; slave_componentid_in&#10;                  AND thread_id &#61; slave_threadid_in&#10;                  AND status &#61; 1;&#10;            EXCEPTION WHEN NO_DATA_FOUND THEN&#10;                raise_application_error(-20001,&#10;                    &#39;OXML_WORKER.do_prepare_message_record(&#39; || slave_componentid_in || &#39;, &#39; || slave_threadid_in || &#39;, &#39; || p_spg_notification_id || &#39;): &#39; ||&#10;                    &#39;FAILED to identify the record in PDT_THREAD table&#39;);&#10;            END;&#10;        ELSE&#10;            l_spg_notification_id :&#61; p_spg_notification_id;&#10;        END IF;&#10;        --&#10;        /* YF: SPG_NOTIFICATION.processed_flag should stay at 4 (indicating that the record is being processed)&#10;        UPDATE spg_notification SET&#10;          processed_flag &#61; 0&#10;          --mt_component_id &#61; lc_master_component_id + l_rec.oxml_master_thread_id,&#10;          --mt_thread_id    &#61; l_master_thread_id&#10;        WHERE spg_notification_id &#61; l_spg_notification_id&#10;          AND processed_flag &#61; 4&#10;          AND message_direction &#61; &#39;O&#39;;&#10;        */&#10;        --&#10;        --COMMIT;&#10;        --&#10;    END do_prepare_message_record;&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;oxml_worker&#39;;&#10;    --&#10;    do_prepare_message_record;&#10;    --&#10;    PKG_MTHREAD.update_thread_status(&#10;        p_component_id  &#61;&gt; slave_componentid_in,&#10;        p_thread_id     &#61;&gt; slave_threadid_in,&#10;        p_status        &#61;&gt; 1,&#10;        p_info_msg      &#61;&gt; &#39;Worker Commenced [&#39; || TO_CHAR(l_spg_notification_id) || &#39;]&#39; );&#10;    --&#10;    SPGMESSAGE.process_q_msg(&#10;        p_spg_notification_id &#61;&gt; l_spg_notification_id,&#10;        p_component_id        &#61;&gt; slave_componentid_in,&#10;        p_thread_id           &#61;&gt; slave_threadid_in );&#10;    --&#10;    PKG_MTHREAD.update_thread_status(&#10;        p_component_id  &#61;&gt; slave_componentid_in,&#10;        p_thread_id     &#61;&gt; slave_threadid_in,&#10;        p_status        &#61;&gt; 3,&#10;        p_info_msg      &#61;&gt; &#39;Worker Completed [&#39; || TO_CHAR(p_spg_notification_id) || &#39;]&#39; );&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    PKG_MTHREAD.update_thread_status(&#10;        p_component_id  &#61;&gt; slave_componentid_in,&#10;        p_thread_id     &#61;&gt; slave_threadid_in,&#10;        p_status        &#61;&gt; 2,&#10;        p_err_msg       &#61;&gt; SUBSTRB(SQLERRM || CHR(10) || DBMS_UTILITY.format_error_backtrace, 1, 4000),&#10;        p_info_msg      &#61;&gt; &#39;Worker Error [&#39; || TO_CHAR(p_spg_notification_id) || &#39;]&#39;,&#10;        p_run_fixit_job &#61;&gt; &#39;N&#39; );&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;END oxml_worker;&#10;--&#10;PROCEDURE oxml_worker_failover(&#10;    slave_componentid_in  IN PDT_THREAD.component_id%TYPE,&#10;    slave_threadid_in     IN PDT_THREAD.thread_id%TYPE,&#10;    p_spg_notification_id IN NUMBER )&#10;IS&#10;    l_spg_notification_id NUMBER;&#10;    --&#10;    l_procedure_name VARCHAR2(30) :&#61; g_procedure_name;&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;oxml_worker_failover&#39;;&#10;    --&#10;&#10;    -- Try to recover failed job&#10;    BEGIN&#10;        SELECT spg_notification_id INTO l_spg_notification_id&#10;        FROM spg_notification&#10;        WHERE spg_notification_id &#61; p_spg_notification_id&#10;          AND processed_flag &#61; 1&#10;          AND error_flag &#61; 1&#10;          AND row_version &#61; 0&#10;          AND UPPER(error_message) LIKE UPPER(&#39;%broker%invalid%credentials&#39;);&#10;    EXCEPTION WHEN NO_DATA_FOUND THEN&#10;        l_spg_notification_id :&#61; -1;&#10;    END;&#10;    --&#10;    /* YF: nDelius model does not use a buffer SPG_MESSAGE_EVENT_QUEUE table&#10;    BEGIN&#10;        INSERT INTO spg_message_event_queue ( spg_notification_id, message_payload )&#10;        SELECT&#10;          spg_notification_id,&#10;          spg_payload_type(&#10;                S.spg_notification_id,&#10;                SYSDATE,&#10;                PKG_Lookups.funcGetBusinessInteraction(S.business_interaction_id),&#10;                S.offender_id,&#10;                S.unique_id )&#10;        FROM spg_notification S&#10;        WHERE S.spg_notification_id &#61; p_spg_notification_id&#10;          AND processed_flag &#61; 0&#10;        RETURNING spg_notification_id INTO l_spg_notification_id;&#10;    EXCEPTION WHEN NO_DATA_FOUND THEN&#10;        l_spg_notification_id :&#61; -1;&#10;    END;*/&#10;    --&#10;--    UPDATE spg_message_event_queue Q SET&#10;--      processed_flag &#61; 0&#10;--    WHERE spg_notification_id &#61; p_spg_notification_id&#10;--      AND processed_flag !&#61; 0&#10;--      AND EXISTS(&#10;--          SELECT 1&#10;--          FROM spg_notification S&#10;--          WHERE S.spg_notification_id &#61; Q.spg_notification_id&#10;--            AND S.processed_flag &#61; 0 )&#10;--      AND ROWNUM &#61; 1&#10;--    RETURNING spg_notification_id INTO l_spg_notification_id;&#10;    --&#10;    IF l_spg_notification_id &gt; 0 THEN&#10;        UPDATE spg_notification SET&#10;          row_version        &#61; row_version + 1,&#10;          processed_flag     &#61; 0,&#10;          error_flag         &#61; 0,&#10;          processed_datetime &#61; SYSDATE,&#10;          --&#10;          error_message &#61; PKG_LstUtl.concat_CLOB( error_message,&#10;                              &#39;SPG background thread ERROR: [&#39; ||&#10;                              PKG_Lookups.funcgetTabRecord(p_table &#61;&gt; &#39;PDT_THREAD&#39;,&#10;                                  p_ref_col     &#61;&gt; &#39;component_id&#39;,&#10;                                  p_ref_val     &#61;&gt; TO_CHAR(slave_componentid_in),&#10;                                  p_where       &#61;&gt; &#39;thread_id &#61; TO_NUMBER(:p_thread_id)&#39;,&#10;                                  p_bind_var1   &#61;&gt; TO_CHAR(slave_threadid_in),&#10;                                  p_data_fld    &#61;&gt; &#39;error_message&#39; ) ||&#10;                              &#39;]. re-sumbitted at &#39; || TO_CHAR(SYSDATE, &#39;YYYYMMDD HH24:MI:SS&#39;), p_delim &#61;&gt; CHR(10) )&#10;        WHERE spg_notification_id &#61; l_spg_notification_id;&#10;    END IF;&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    warn( &#39;ERROR in SPGMessage.oxml_worker_failover&#39; ||&#10;        &#39;[component_id&#61;&#39;        || slave_componentid_in  || &#39;]&#39;   ||&#10;        &#39;[thread_id&#61;&#39;           || slave_threadid_in     || &#39;]&#39;   ||&#10;        &#39;[spg_notification_id&#61;&#39; || p_spg_notification_id || &#39;]: &#39; ||&#10;        SQLERRM );&#10;    --&#10;    g_procedure_name :&#61; l_procedure_name;&#10;    --&#10;    RAISE;&#10;END oxml_worker_failover;&#10;&#10;--&#10;--FUNCTION get_msg_queue_next_row( p_thread_id NUMBER, p_autonomous_trx  VARCHAR2 DEFAULT &#39;N&#39; ) RETURN NUMBER&#10;--IS&#10;--    --&#10;--    --mq_row       SPG_MESSAGE_EVENT_QUEUE%rowtype;&#10;--    l_spg_message_event_queue_id NUMBER;&#10;--    --&#10;--BEGIN&#10;--    --&#10;--    IF NVLSTR(p_autonomous_trx, &#39;N&#39;) &#61; &#39;N&#39; THEN&#10;--        PKG_DynSQL.exec_SQL_atnm(&#10;--           &#39;DECLARE&#10;--                 l_spg_message_event_queue_id NUMBER;&#10;--            BEGIN&#10;--                 l_spg_message_event_queue_id :&#61; SPGMessage.get_msg_queue_next_row( p_thread_id &#61;&gt; TO_NUMBER(:p_param_1), p_autonomous_trx &#61;&gt; &#39;&#39;Y&#39;&#39; );&#10;--            END;&#39;,&#10;--            p_param_1 &#61;&gt; TO_CHAR(p_thread_id) );&#10;--        --&#10;--        SELECT spg_message_event_queue_id&#10;--        INTO l_spg_message_event_queue_id&#10;--        FROM spg_message_event_queue&#10;--        WHERE processed_flag &#61; 2&#10;--          AND master_thread_id &#61; p_thread_id;&#10;--        --&#10;--    ELSE&#10;--        --&#10;----        do_allocate_aq_thread;&#10;--        --&#10;--        DECLARE&#10;--            CURSOR cs IS&#10;--              WITH Q1 AS (&#10;--                SELECT Q.*&#10;--                FROM spg_message_event_queue Q&#10;--                WHERE processed_flag &#61; 0&#10;--                  --AND EXISTS( SELECT 1 FROM spg_notification WHERE spg_notification_id &#61; Q.spg_notification_id AND message_direction &#61; &#39;O&#39; AND processed_flag &#61; 0 )&#10;--                ORDER BY created_timestamp ASC, spg_message_event_queue_id ASC&#10;--                LIMIT 50 )&#10;--              --&#10;--              SELECT&#10;--                Q2.spg_message_event_queue_id,&#10;--                Q2.processed_flag,&#10;--                Q2.master_thread_id,&#10;--                Q2.processed_timestamp&#10;--              FROM&#10;--                Q1&#10;--                  INNER JOIN spg_message_event_queue Q2 ON Q2.spg_message_event_queue_id &#61; Q1.spg_message_event_queue_id&#10;--              ORDER BY Q1.created_timestamp DESC, Q1.spg_message_event_queue_id DESC&#10;--              LIMIT 1&#10;--              FOR UPDATE OF Q2&#10;--                --processed_flag,&#10;--                --master_thread_id,&#10;--                --processed_timestamp&#10;--            ;&#10;--            --&#10;--            l_rec cs%ROWTYPE;&#10;--            --&#10;--        BEGIN&#10;--            OPEN cs;&#10;--            FETCH cs INTO l_rec;&#10;--            IF cs%FOUND THEN&#10;--                UPDATE spg_message_event_queue SET&#10;--                  processed_flag      &#61; 2,&#10;--                  master_thread_id    &#61; p_thread_id,&#10;--                  processed_timestamp &#61; SYSTIMESTAMP&#10;--                WHERE CURRENT OF cs&#10;--                RETURNING spg_message_event_queue_id INTO l_spg_message_event_queue_id;&#10;--            ELSE&#10;--                l_spg_message_event_queue_id :&#61; -1;&#10;--            END IF;&#10;--            CLOSE cs;&#10;--            --&#10;--            /*&#10;--            WITH next_record AS (&#10;--              UPDATE spg_message_event_queue SET&#10;--                processed_flag      &#61; 2,&#10;--                master_thread_id    &#61; p_thread_id,&#10;--                processed_timestamp &#61; SYSTIMESTAMP&#10;--              FROM (&#10;--                SELECT Q2.*&#10;--                FROM&#10;--                  ( SELECT Q.spg_message_event_queue_id&#10;--                    FROM spg_message_event_queue Q&#10;--                    WHERE processed_flag &#61; 0&#10;--                      --AND EXISTS( SELECT 1 FROM spg_notification WHERE spg_notification_id &#61; Q.spg_notification_id AND message_direction &#61; &#39;O&#39; AND processed_flag &#61; 0 )&#10;--                    ORDER BY created_timestamp ASC, spg_message_event_queue_id ASC&#10;--                    LIMIT p_thread_id ) Q1&#10;--                  INNER JOIN spg_message_event_queue Q2 ON Q2.spg_message_event_queue_id &#61; Q1.spg_message_event_queue_id&#10;--                ORDER BY created_timestamp DESC, spg_message_event_queue_id DESC&#10;--                LIMIT 1&#10;--                FOR UPDATE ) AS to_select&#10;--              WHERE spg_message_event_queue.spg_message_event_queue_id &#61; to_select.spg_message_event_queue_id&#10;--              RETURNING to_select.* )&#10;--            SELECT spg_message_event_queue_id INTO l_spg_message_event_queue_id&#10;--            FROM next_record&#10;--            ORDER BY spg_message_event_queue_id;&#10;--            */&#10;--            --&#10;--            COMMIT;&#10;--            --&#10;----            do_release_aq_thread;&#10;--            --&#10;--        EXCEPTION&#10;--            WHEN NO_DATA_FOUND THEN&#10;--                l_spg_message_event_queue_id :&#61; -1;&#10;--            WHEN OTHERS THEN&#10;----                do_release_aq_thread;&#10;--                RAISE;&#10;--        END;&#10;--        --&#10;--    END IF;&#10;--    --&#10;--    --RETURN mq_row;&#10;--    RETURN l_spg_message_event_queue_id;&#10;--    --&#10;--END get_msg_queue_next_row;&#10;--&#10;&#10;--&#10;--&#10;-- PLSQL package Initialisation block&#10;--&#10;BEGIN&#10;    --&#10;    PKG_Global.do_init;&#10;    --&#10;    do_init_vars;&#10;    --&#10;END SPGMessage;</textarea>
                        </div>
                    </div>
                </section>
            </div>
            <!-- /.content-wrapper -->
            <footer class="main-footer">
                <div>
                    <div class="pull-right hidden-xs">
                        <a href="https://github.com/schemaspy/schemaspy" title="GitHub for SchemaSpy"><i class="fa fa-github-square fa-2x"></i></a>
                        <a href="http://stackoverflow.com/questions/tagged/schemaspy" title="StackOverflow for SchemaSpy"><i class="fa fa-stack-overflow fa-2x"></i></a>
                    </div>
                    <strong>Generated by <a href="http://schemaspy.org/" class="logo-text"><i class="fa fa-database"></i> SchemaSpy 6.2.4</a></strong>
                </div>
                <!-- /.container -->
            </footer>
        </div>
        <!-- ./wrapper -->

        <!-- jQuery 2.2.3 -->
        <script src="../bower/admin-lte/plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../bower/admin-lte/plugins/jQueryUI/jquery-ui.min.js"></script>
        <!-- Bootstrap 3.3.5 -->
        <script src="../bower/admin-lte/bootstrap/js/bootstrap.min.js"></script>
        <!-- DataTables -->
        <script src="../bower/datatables.net/jquery.dataTables.min.js"></script>
        <script src="../bower/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/dataTables.buttons.min.js"></script>
        <script src="../bower/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.html5.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.print.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.colVis.min.js"></script>
        <!-- SheetJS -->
        <script src="../bower/js-xlsx/xlsx.full.min.js"></script>
        <!-- pdfmake -->
        <script src="../bower/pdfmake/pdfmake.min.js"></script>
        <script src="../bower/pdfmake/vfs_fonts.js"></script>
        <!-- SlimScroll -->
        <script src="../bower/admin-lte/plugins/slimScroll/jquery.slimscroll.min.js"></script>
        <!-- FastClick -->
        <script src="../bower/admin-lte/plugins/fastclick/fastclick.js"></script>
        <!-- Salvattore -->
        <script src="../bower/salvattore/salvattore.min.js"></script>
        <!-- AnchorJS -->
        <script src="../bower/anchor-js/anchor.min.js"></script>
        <!-- CodeMirror -->
        <script src="../bower/codemirror/codemirror.js"></script>
        <script src="../bower/codemirror/sql.js"></script>
        <!-- AdminLTE App -->
        <script src="../bower/admin-lte/dist/js/app.min.js"></script>
        <script src="routine.js"></script>
        <script src="../schemaSpy.js"></script>
    </body>
</html>