<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>TSTNDA.DELIUS_APP_SCHEMA</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
        <!-- Bootstrap 3.3.5 -->
        <link rel="stylesheet" href="../bower/admin-lte/bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="../bower/font-awesome/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="../bower/ionicons/css/ionicons.min.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="../bower/datatables.net-bs/css/dataTables.bootstrap.min.css">
        <link rel="stylesheet" href="../bower/datatables.net-buttons-bs/css/buttons.bootstrap.min.css">
        <!-- Code Mirror -->
        <link rel="stylesheet" href="../bower/codemirror/codemirror.css">
        <!-- Fonts -->
        <link href='../fonts/indieflower/indie-flower.css' rel='stylesheet' type='text/css'>
        <link href='../fonts/source-sans-pro/source-sans-pro.css' rel='stylesheet' type='text/css'>

        <!-- Theme style -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/AdminLTE.min.css">
        <!-- Salvattore -->
        <link rel="stylesheet" href="../bower/salvattore/salvattore.css">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
           folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/skins/_all-skins.min.css">
        <!-- SchemaSpy -->
        <link rel="stylesheet" href="../schemaSpy.css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="../bower/html5shiv/html5shiv.min.js"></script>
        <script src="../bower/respond/respond.min.js"></script>
        <![endif]-->
    </head>
    <!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->
    <body class="hold-transition skin-blue layout-top-nav">
        <div class="wrapper">
            <header class="main-header">
                <nav class="navbar navbar-static-top">
                    <div class="container">
                        <div class="navbar-header">
                            <a href="../index.html" class="navbar-brand"><b>TSTNDA</b></a><span class="navbar-brand" style="padding-left: 0">.DELIUS_APP_SCHEMA</span>
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"><i class="fa fa-bars"></i></button>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                            <ul class="nav navbar-nav">
                                <li><a href="../index.html">Tables <span class="sr-only">(current)</span></a></li>
                                <li><a href="../columns.html" title="All of the columns in the schema">Columns</a></li>
                                <li><a href="../constraints.html" title="Useful for diagnosing error messages that just give constraint name or number">Constraints</a></li>
                                <li><a href="../relationships.html" title="Diagram of table relationships">Relationships</a></li>
                                <li><a href="../orphans.html" title="View of tables with neither parents nor children">Orphan&nbsp;Tables</a></li>
                                <li><a href="../anomalies.html" title="Things that might not be quite right">Anomalies</a></li>
                                <li><a href="../routines.html" title="Procedures and functions">Routines</a></li>
                            </ul>
                        </div>
                        <!-- /.navbar-collapse -->
                        <!-- Navbar Right Menu -->
                    </div>
                    <!-- /.container-fluid -->
                </nav>
            </header>
            <!-- Main content -->
            <!-- Full Width Column -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>DELIUS_APP_SCHEMA.PKG_MERGE_OFFENDER</h1><br />
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                            <h3 id="Columns" class="box-title">Parameters</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <table id="standard_table" class="table table-bordered table-striped dataTable" role="grid">
                                <thead align='left'>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Mode</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-code-o"></i>
                            <h3 id="RoutineDefinition" class="box-title">Definition</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <textarea id="sql-script-codemirror" name="sql-script-codemirror" rows="" style="display: none;">PACKAGE BODY pkg_merge_offender&#10;AS&#10;--&#10;--&#10;&#10;-- message type&#10;mt_information    CONSTANT NUMBER :&#61; 1;&#10;mt_warning        CONSTANT NUMBER :&#61; 2;&#10;mt_error          CONSTANT NUMBER :&#61; 3;&#10;mt_fatal_error    CONSTANT NUMBER :&#61; 4;&#10;&#10;g_component_code  CONSTANT VARCHAR2(3)  :&#61; &#39;MRG&#39;;&#10;g_package_name    CONSTANT VARCHAR2(30) :&#61; &#39;PKG_MERGE_OFFENDER&#39;;&#10;g_procedure_name  VARCHAR2(30)  :&#61; &#39;initial_value&#39;;&#10;g_label           VARCHAR2(30)  :&#61; &#39;00000&#39;;&#10;&#10;--&#10;-- MMS Merge / Unmerge global declarations&#10;--&#10;GC_UNMERGE_MOVE_OFF_FLAG   CONSTANT VARCHAR2(1) :&#61; &#39;Y&#39;;&#10;GC_UNMERGE_MOVE_EVENT_FLAG CONSTANT VARCHAR2(1) :&#61; &#39;Y&#39;;&#10;&#10;GC_RETAIN_ON_TGT CONSTANT VARCHAR2(100) :&#61; &#39;NDM-167: created new%when%P_MOVE_PROVIDER&#61;Y%&#39;;&#10;GC_MOVE_TO_SRC   CONSTANT VARCHAR2(100) :&#61; &#39;NDM-161: created new % OMD record&#39;;&#10;&#10;G_TABLE_NAME   VARCHAR2(100);&#10;G_PARENT_TABLE VARCHAR2(100);&#10;G_ROW_ID       ROWID;&#10;&#10;-- Offender Merge Changes (Column Values) Log&#10;TYPE g_ch_log_rec_TYP IS RECORD(&#10;  column_name VARCHAR2(30),&#10;  data_type   VARCHAR2(1),&#10;  old_value   VARCHAR2(100),&#10;  new_value   VARCHAR2(100),&#10;  pk_value    VARCHAR2(100) );&#10;TYPE g_ch_log_TAB_TYP IS TABLE OF g_ch_log_rec_TYP;&#10;&#10;TYPE g_merge_ctx_rec_TYP IS RECORD(&#10;  src_offender_id             NUMBER,&#10;  tgt_offender_id             NUMBER,&#10;  src_crn                     OFFENDER.crn%TYPE,&#10;  tgt_crn                     OFFENDER.crn%TYPE,&#10;  already_merged              VARCHAR2(1),&#10;  merged_date_time            DATE,&#10;  --&#10;  src_off_addr_id_MAIN        NUMBER,&#10;  src_off_addr_id_POSTAL      NUMBER,&#10;  tgt_off_addr_id_MAIN        NUMBER,&#10;  tgt_off_addr_id_POSTAL      NUMBER,&#10;  --&#10;  old_tgt_offender_manager_id    NUMBER,&#10;  old_tgt_om_probation_area_id   NUMBER,&#10;  old_tgt_om_team_id             NUMBER,&#10;  old_tgt_om_staff_id            NUMBER,&#10;  old_tgt_responsible_officer_id NUMBER,&#10;  src_offender_manager_id        NUMBER,&#10;  src_om_probation_area_id       NUMBER,&#10;  src_om_team_id                 NUMBER,&#10;  src_om_staff_id                NUMBER,&#10;  src_responsible_officer_id     NUMBER,&#10;  --&#10;  new_tgt_offender_manager_id    NUMBER,&#10;  new_tgt_responsible_officer_id NUMBER,&#10;  new_tgt_ro_contact_id          NUMBER,&#10;  new_tgt_master_transfer_id     NUMBER,&#10;  new_tgt_offender_transfer_id   NUMBER,&#10;  new_tgt_transfer_contact_id_0  NUMBER,&#10;  new_tgt_transfer_contact_id_1  NUMBER,&#10;  new_tgt_transfer_contact_id_2  NUMBER,&#10;  --&#10;  src_event_soft_deleted_CNT  NUMBER,&#10;  --&#10;  src_iaps_of_interest        SMALLINT,&#10;  tgt_iaps_of_interest        SMALLINT,&#10;  --&#10;  move_crn                    VARCHAR2(1),&#10;  move_dob                    VARCHAR2(1),&#10;  move_first_name             VARCHAR2(1),&#10;  move_gender                 VARCHAR2(1),&#10;  move_prev_name              VARCHAR2(1),&#10;  move_second_name            VARCHAR2(1),&#10;  move_surname                VARCHAR2(1),&#10;  move_third_name             VARCHAR2(1),&#10;  move_title                  VARCHAR2(1),&#10;  move_cro                    VARCHAR2(1),&#10;  move_date_died              VARCHAR2(1),&#10;  move_email                  VARCHAR2(1),&#10;  move_mobile                 VARCHAR2(1),&#10;  move_ni                     VARCHAR2(1),&#10;  move_noms                   VARCHAR2(1),&#10;  move_pnc                    VARCHAR2(1),&#10;  move_sms                    VARCHAR2(1),&#10;  move_telephone              VARCHAR2(1),&#10;  move_ethnicity              VARCHAR2(1),&#10;  move_ethnicity_1            VARCHAR2(1),&#10;  move_immigration_number     VARCHAR2(1),&#10;  move_immigration_status     VARCHAR2(1),&#10;  move_interpreter_required   VARCHAR2(1),&#10;  move_language               VARCHAR2(1),&#10;  move_nationality            VARCHAR2(1),&#10;  move_religion               VARCHAR2(1),&#10;  move_religion_desc          VARCHAR2(1),&#10;  off_religion_hist_cnt       INTEGER,&#10;  move_second_nationality     VARCHAR2(1),&#10;  move_sexual_orientation     VARCHAR2(1),&#10;  --&#10;  move_provider               VARCHAR2(1),&#10;  move_main_address           VARCHAR2(1),&#10;  move_postal_address         VARCHAR2(1),&#10;  --&#10;  move_responsible_officer    VARCHAR2(1),&#10;  --&#10;  move_precon_doc             VARCHAR2(1),&#10;  --&#10;  bg_flag         VARCHAR2(1),&#10;  debug_flag      VARCHAR2(1) );&#10;--&#10;g_merge_ctx_rec g_merge_ctx_rec_TYP;&#10;&#10;-- OMD records cache&#10;TYPE g_omd_cache_TAB_TYP IS TABLE OF VARCHAR2(1024) INDEX BY VARCHAR2(512);&#10;g_omd_cache_TAB g_omd_cache_TAB_TYP;&#10;&#10;G_NEW_MERGE_RUNNING_FLAG VARCHAR2(1) :&#61; &#39;N&#39;;&#10;&#10;TYPE g_OMD_del_rec_TYP IS RECORD(&#10;  offender_id    NUMBER,&#10;  table_name     VARCHAR2(30),&#10;  primary_key_id VARCHAR2(100) );&#10;TYPE g_OMD_del_TAB_TYP IS TABLE OF g_OMD_del_rec_TYP INDEX BY VARCHAR2(512);&#10;&#10;g_OMD_del_TAB g_OMD_del_TAB_TYP;&#10;--&#10;g_del_OMD_rec_in_progress_FLAG VARCHAR2(1) :&#61; &#39;N&#39;;&#10;--&#10;&#10;--&#10;-- PKG_COMMON wrappers&#10;--&#10;PROCEDURE procDebug(p_msg CLOB, p_print_flag VARCHAR2 DEFAULT &#39;N&#39;) IS&#10;BEGIN&#10;    PKG_Debug.procDebug(&#39;[&#39; || g_component_code || &#39;]: &#39; || p_msg, p_print_flag);&#10;END procDebug;&#10;--&#10;PROCEDURE message(p_msg VARCHAR2, p_trace_level NUMBER DEFAULT 1) IS&#10;BEGIN&#10;    --&#10;    IF NVL(p_trace_level, PKG_Common.GET_TRACE_LEVEL) &lt;&#61; PKG_Common.GET_TRACE_LEVEL THEN&#10;        procDebug(p_msg);&#10;        PKG_Common.print_message(&#10;            p_msg         &#61;&gt; p_msg,&#10;            p_trace_level &#61;&gt; NVL(p_trace_level, PKG_Common.GET_TRACE_LEVEL),&#10;            p_label       &#61;&gt; g_label );&#10;    END IF;&#10;    --&#10;END message;&#10;--&#10;FUNCTION empty2null(p_str VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.empty2null(p_str);&#10;END empty2null;&#10;&#10;FUNCTION nvlstr(p_str1 VARCHAR2, p_str2 VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.NVLSTR(p_str1, p_str2);&#10;END nvlstr;&#10;&#10;FUNCTION is_str_empty(p_str VARCHAR2, p_ignore_spaces_and_zeroes VARCHAR2 DEFAULT &#39;N&#39;) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.is_str_empty( p_str, p_ignore_spaces_and_zeroes );&#10;END is_str_empty;&#10;--&#10;PROCEDURE raise_error(p_err_msg VARCHAR2, p_proc VARCHAR2 DEFAULT NULL, p_label VARCHAR2 DEFAULT NULL ) IS&#10;BEGIN&#10;    PKG_Common.raise_error( p_err_msg, &#39;PKG_Merge_Offender.&#39; || NVL(p_proc, g_procedure_name), p_label );&#10;END raise_error;&#10;--&#10;--&#10;--&#10;--***************************************************&#10;-- Helpers                                          *&#10;--***************************************************&#10;--&#10;-- Used to populate mtt_message_log with information type message&#10;PROCEDURE info(message_in VARCHAR2, p_trace_level INTEGER DEFAULT 15, p_proc VARCHAR2 DEFAULT NULL) IS&#10;BEGIN&#10;    --&#10;    IF g_merge_ctx_rec.debug_flag &#61; &#39;Y&#39; THEN&#10;        message(NVL(p_proc, g_procedure_name) || &#39;: &#39; || message_in, p_trace_level);&#10;    END IF;&#10;    --&#10;    IF SPGConfig.SPGInfoActive THEN&#10;        SPGConfig.insert_message_log(&#10;            message_type_id_in  &#61;&gt; mt_information,&#10;            component_code_in   &#61;&gt; g_component_code,&#10;            package_name_in     &#61;&gt; g_package_name,&#10;            procedure_name_in   &#61;&gt; NVL(p_proc, g_procedure_name),&#10;            label_in            &#61;&gt; g_label,&#10;            message_text_in     &#61;&gt; message_in );&#10;    END IF;&#10;END info;&#10;--&#10;-- Will populate mtt_message_log with warning message - will populate mtt_error_log if result of exception&#10;PROCEDURE warn(message_in VARCHAR2, p_proc VARCHAR2 DEFAULT NULL) IS&#10;BEGIN&#10;    --&#10;    IF g_merge_ctx_rec.debug_flag &#61; &#39;Y&#39; THEN&#10;        message(&#39;WARNING in &#39; || NVL(p_proc, g_procedure_name) || &#39;: &#39; || message_in, 0);&#10;    END IF;&#10;    --&#10;    IF SPGConfig.SPGWarnActive THEN&#10;        SPGConfig.record_error(&#10;            message_type_id_in &#61;&gt; mt_warning,&#10;            component_code_in  &#61;&gt; g_component_code,&#10;            package_name_in    &#61;&gt; g_package_name,&#10;            procedure_name_in  &#61;&gt; NVL(p_proc, g_procedure_name),&#10;            label_in           &#61;&gt; g_label,&#10;            message_text_in    &#61;&gt; message_in );&#10;    END IF;&#10;    --&#10;END warn;&#10;--&#10;-- Will populate mtt_message_log with error message and populate mtt_error_log with exception - used for log and continue&#10;PROCEDURE error(message_in VARCHAR2, p_proc VARCHAR2 DEFAULT NULL)&#10;IS&#10;BEGIN&#10;    --&#10;    IF g_merge_ctx_rec.debug_flag &#61; &#39;Y&#39; THEN&#10;        message(&#39;ERROR in &#39; || NVL(p_proc, g_procedure_name) || &#39;: &#39; || message_in, 5);&#10;    END IF;&#10;    --&#10;    SPGConfig.record_error(&#10;        message_type_id_in &#61;&gt; mt_error,&#10;        component_code_in  &#61;&gt; g_component_code,&#10;        package_name_in    &#61;&gt; g_package_name,&#10;        procedure_name_in  &#61;&gt; NVL(p_proc, g_procedure_name),&#10;        label_in           &#61;&gt; g_label,&#10;        message_text_in    &#61;&gt; message_in);&#10;    --&#10;END error;&#10;--&#10;-- Will populate mtt_message_log, mtt_error_log with error message and raise exception - used for log and halt&#10;PROCEDURE fatal(message_in VARCHAR2, p_proc VARCHAR2 DEFAULT NULL) IS&#10;BEGIN&#10;    --&#10;    IF g_merge_ctx_rec.debug_flag &#61; &#39;Y&#39; THEN&#10;        message(&#39;FATAL ERROR in &#39; || NVL(p_proc, g_procedure_name) || &#39;: &#39; || message_in, 0);&#10;    END IF;&#10;    --&#10;    SPGConfig.record_error(&#10;        message_type_id_in &#61;&gt; mt_fatal_error,&#10;        component_code_in  &#61;&gt; g_component_code,&#10;        package_name_in    &#61;&gt; g_package_name,&#10;        procedure_name_in  &#61;&gt; NVL(p_proc, g_procedure_name),&#10;        label_in           &#61;&gt; g_label,&#10;        message_text_in    &#61;&gt; message_in,&#10;        raise_error_in     &#61;&gt; TRUE );&#10;    --&#10;END fatal;&#10;--&#10;--&#10;--&#10;FUNCTION get_dq_message(p_msg VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN C08001_PDT_SUPPORT.get_dq_message(p_msg);&#10;END get_dq_message;&#10;--&#10;--&#10;--&#10;&#10;--&#10;-- TEST Offender Merge&#10;PROCEDURE do_test_merge(&#10;    p_src_CRN VARCHAR2,&#10;    p_tgt_CRN VARCHAR2,&#10;    p_move_crn                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_dob                  VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_move_first_name           VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_gender               VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_prev_name            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_second_name          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_surname              VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_move_third_name           VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_title                VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_cro                  VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_move_date_died            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_email                VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_mobile               VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ni                   VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_move_noms                 VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_move_pnc                  VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_move_sms                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_telephone            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ethnicity            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ethnicity_1          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_immigration_number   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_immigration_status   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_interpreter_required VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_language             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_nationality          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_religion             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_second_nationality   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_sexual_orientation   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_move_provider             VARCHAR2 DEFAULT &#39;Y&#39;,&#10;    p_move_responsible_officer  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_main_address         VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_postal_address       VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_src_CRN VARCHAR2(10) :&#61; p_src_CRN;&#10;    l_tgt_CRN VARCHAR2(10) :&#61; p_tgt_CRN;&#10;    --&#10;    l_TAB T_TAB_ORGANISATIONS :&#61; T_TAB_ORGANISATIONS(&#39;xOFFENDER_ADDRESS&#39;, &#39;xOFFENDER_MANAGER&#39;);&#10;    --&#10;    CURSOR cs IS&#10;      SELECT&#10;        table_name,&#10;        hierarchy_level AS hier_level,&#10;        parent_table,&#10;        COUNT(1)        AS qty&#10;      FROM&#10;        offender_merge_details OMD&#10;          INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;          INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;      WHERE 1&#61;1&#10;        AND O1.crn &#61; l_src_CRN&#10;        AND O2.crn &#61; l_tgt_CRN&#10;    --  AND OMD.table_name IN (SELECT * FROM TABLE(l_TAB))&#10;      GROUP BY&#10;        table_name,&#10;        hierarchy_level,&#10;        parent_table&#10;      ORDER BY 1,2,3;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    --&#10;    CURSOR cs1 IS&#10;      SELECT&#10;        OMD.offender_merge_details_id,&#10;        OMD1.offender_merge_details_id AS offender_merge_details_id1&#10;    FROM&#10;      offender_merge_details OMD&#10;        INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;        INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;        LEFT OUTER JOIN offender_merge_details OMD1 ON OMD1.table_name &#61; OMD.parent_table&#10;                                                   AND OMD1.source_offender_id &#61; OMD.source_offender_id&#10;                                                   AND OMD1.target_offender_id &#61; OMD.target_offender_id&#10;                                                   AND OMD1.source_pk_value &#61; OMD.source_fk_value&#10;    WHERE 1&#61;1&#10;        AND O1.crn &#61; l_src_CRN&#10;        AND O2.crn &#61; l_tgt_CRN&#10;    --  AND OMD.table_name IN (SELECT * FROM TABLE(l_TAB))&#10;    ;&#10;    --&#10;    l_rec1 cs1%ROWTYPE;&#10;    --&#10;BEGIN&#10;    --&#10;    DBMS_OUTPUT.enable(NULL);&#10;    --&#10;    PKG_Common.set_trace_level(15);&#10;    PKG_VPD_CTX.set_client_identifier(userID &#61;&gt; 4);&#10;    --&#10;    PKG_MERGE_OFFENDER.procMergeOffenders_NEW(&#10;        p_source_offender_crn &#61;&gt; l_src_CRN,&#10;        p_target_offender_crn &#61;&gt; l_tgt_CRN,&#10;        --&#10;        p_move_crn                  &#61;&gt; p_move_crn,&#10;        p_move_dob                  &#61;&gt; p_move_dob,&#10;        p_move_first_name           &#61;&gt; p_move_first_name,&#10;        p_move_gender               &#61;&gt; p_move_gender,&#10;        p_move_prev_name            &#61;&gt; p_move_prev_name,&#10;        p_move_second_name          &#61;&gt; p_move_second_name,&#10;        p_move_surname              &#61;&gt; p_move_surname,&#10;        p_move_third_name           &#61;&gt; p_move_third_name,&#10;        p_move_title                &#61;&gt; p_move_title,&#10;        p_move_cro                  &#61;&gt; p_move_cro,&#10;        p_move_date_died            &#61;&gt; p_move_date_died,&#10;        p_move_email                &#61;&gt; p_move_email,&#10;        p_move_mobile               &#61;&gt; p_move_mobile,&#10;        p_move_ni                   &#61;&gt; p_move_ni,&#10;        p_move_noms                 &#61;&gt; p_move_noms,&#10;        p_move_pnc                  &#61;&gt; p_move_pnc,&#10;        p_move_sms                  &#61;&gt; p_move_sms,&#10;        p_move_telephone            &#61;&gt; p_move_telephone,&#10;        p_move_ethnicity            &#61;&gt; p_move_ethnicity,&#10;        p_move_ethnicity_1          &#61;&gt; p_move_ethnicity_1,&#10;        p_move_immigration_number   &#61;&gt; p_move_immigration_number,&#10;        p_move_immigration_status   &#61;&gt; p_move_immigration_status,&#10;        p_move_interpreter_required &#61;&gt; p_move_interpreter_required,&#10;        p_move_language             &#61;&gt; p_move_language,&#10;        p_move_nationality          &#61;&gt; p_move_nationality,&#10;        p_move_religion             &#61;&gt; p_move_religion,&#10;        p_move_second_nationality   &#61;&gt; p_move_second_nationality,&#10;        p_move_sexual_orientation   &#61;&gt; p_move_sexual_orientation,&#10;        --&#10;        p_move_provider             &#61;&gt; p_move_provider,&#10;        p_move_responsible_officer  &#61;&gt; p_move_responsible_officer,&#10;        p_move_main_address         &#61;&gt; p_move_main_address,&#10;        p_move_postal_address       &#61;&gt; p_move_postal_address,&#10;        --&#10;        p_bg_flag    &#61;&gt; &#39;N&#39;,&#10;        p_debug_flag &#61;&gt; &#39;Y&#39; );&#10;    --&#10;--    DBMS_OUTPUT.put_line( CHR(10) || &#39;******** OFFENDER_MERGE_DETAILS ctx ********&#39; || CHR(10) ||&#10;--        PKG_Merge_Offender.get_merge_ctx || CHR(10) || CHR(10) );&#10;    --&#10;--    DBMS_OUTPUT.put_line( CHR(10) || &#39;******** OFFENDER_MERGE_DETAILS DETAILS Report (&#39; || PKG_LstUtl.get_array_2_list(l_TAB) || &#39;) tables sample ********&#39; );&#10;--    --&#10;--    OPEN cs;&#10;--    LOOP&#10;--        FETCH cs INTO l_rec;&#10;--        EXIT WHEN cs%NOTFOUND;&#10;--        --&#10;--        DBMS_OUTPUT.put_line(&#10;--            &#39;[&#39; || l_rec.table_name   || &#39;]&#39; ||&#10;--            &#39;[&#39; || l_rec.hier_level   || &#39;]&#39; ||&#10;--            &#39;[&#39; || l_rec.parent_table || &#39;]: &#39; ||&#10;--            l_rec.qty );&#10;--    END LOOP;&#10;--    CLOSE cs;&#10;    --&#10;    DBMS_OUTPUT.put_line(CHR(10) || CHR(10) || &#39;******************* OFFENDER_MERGE_DETAILS SUMMARY REPORT *************&#39;);&#10;    --&#10;    OPEN cs1;&#10;    LOOP&#10;        FETCH cs1 INTO l_rec1;&#10;        EXIT WHEN cs1%NOTFOUND;&#10;        --&#10;        DBMS_OUTPUT.put_line(&#39;***** OFFENDER_MERGE_DETAILS record:&#39; || CHR(10) || get_off_merge_details_1(l_rec1.offender_merge_details_id) || CHR(10));&#10;        --DBMS_OUTPUT.put_line(&#39;***** OFFENDER_MERGE_DETAILS record (Parent):&#39; || CHR(10) || get_off_merge_details_1(l_rec1.offender_merge_details_id1) || CHR(10) || CHR(10) );&#10;        --&#10;    END LOOP;&#10;    CLOSE cs1;&#10;    --&#10;    --ROLLBACK;&#10;    --&#10;END do_test_merge;&#10;&#10;&#10;--&#10;-- Un-Merge TEST&#10;PROCEDURE do_test_unmerge(p_src_CRN VARCHAR2, p_tgt_CRN VARCHAR2)&#10;IS&#10;    --&#10;    l_src_CRN VARCHAR2(10) :&#61; p_src_CRN;&#10;    l_tgt_CRN VARCHAR2(10) :&#61; p_tgt_CRN;&#10;    --&#10;    l_src_offender_id NUMBER;&#10;    l_tgt_offender_id NUMBER;&#10;    --&#10;    CURSOR cs IS&#10;      SELECT&#10;        O1.offender_id AS src_offender_id,&#10;        O1.crn         AS src_crn,&#10;        ( SELECT COUNT(1) FROM event WHERE offender_id &#61; l_src_offender_id) as qty_event_src,&#10;        ( SELECT COUNT(1)&#10;          FROM&#10;            event E&#10;              INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;EVENT&#39;&#10;                                                   AND OMD.source_offender_id &#61; l_src_offender_id&#10;                                                   AND OMD.source_pk_value &#61; E.event_id&#10;          WHERE offender_id &#61; l_src_offender_id&#10;        ) AS qty_event_src1,&#10;        --&#10;        O2.offender_id AS tgt_offender_id,&#10;        O2.crn         AS tgt_crn,&#10;        ( SELECT COUNT(1) FROM event WHERE offender_id &#61; l_tgt_offender_id) as qty_event_tgt,&#10;        ( SELECT COUNT(1)&#10;          FROM&#10;            event E&#10;              INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;EVENT&#39;&#10;                                                   AND OMD.target_offender_id &#61; l_tgt_offender_id&#10;                                                   AND OMD.target_pk_value &#61; E.event_id&#10;          WHERE offender_id &#61; l_tgt_offender_id&#10;        ) AS qty_event_tgt1&#10;      FROM offender O1, offender O2&#10;      WHERE 1&#61;1&#10;        AND O1.crn &#61; l_src_crn&#10;        AND O2.crn &#61; l_tgt_crn&#10;    ;&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    PROCEDURE do_fetch(p_title VARCHAR2) IS&#10;    BEGIN&#10;        --&#10;        IF l_src_crn IS NOT NULL THEN&#10;            SELECT offender_id INTO l_src_offender_id&#10;            FROM offender&#10;            WHERE crn &#61; l_src_CRN;&#10;        END IF;&#10;        IF l_tgt_crn IS NOT NULL THEN&#10;            SELECT offender_id INTO l_tgt_offender_id&#10;            FROM offender&#10;            WHERE crn &#61; l_tgt_CRN;&#10;        END IF;&#10;        --&#10;        OPEN cs;&#10;        FETCH cs INTO l_rec;&#10;        CLOSE cs;&#10;        --&#10;        DBMS_OUTPUT.put_line(p_title || CHR(10) ||&#10;          &#39;[src_offender_id&#61;&#39; || l_rec.src_offender_id || &#39;]&#39; || CHR(10) ||&#10;          &#39;[src_crn&#61;&#39;         || l_rec.src_crn         || &#39;]&#39; || CHR(10) ||&#10;          &#39;[qty_EVENT_src&#61;&#39;   || l_rec.qty_event_src   || &#39;]&#39; || CHR(10) ||&#10;          &#39;[qty_EVENT_src_1&#61;&#39; || l_rec.qty_event_src1  || &#39;]&#39; || CHR(10) ||&#10;          --&#10;          &#39;[tgt_offender_id&#61;&#39; || l_rec.tgt_offender_id || &#39;]&#39; || CHR(10) ||&#10;          &#39;[tgt_crn&#61;&#39;         || l_rec.tgt_crn         || &#39;]&#39; || CHR(10) ||&#10;          &#39;[qty_EVENT_tgt&#61;&#39;   || l_rec.qty_event_tgt   || &#39;]&#39; || CHR(10) ||&#10;          &#39;[qty_EVENT_tgt_1&#61;&#39; || l_rec.qty_event_tgt1  || &#39;]&#39; || CHR(10) );&#10;    END do_fetch;&#10;    --&#10;BEGIN&#10;    --&#10;    DBMS_OUTPUT.enable(NULL);&#10;    --&#10;    PKG_Common.set_trace_level(15);&#10;    PKG_VPD_CTX.set_client_identifier(userID &#61;&gt; 4);&#10;    --&#10;    do_fetch(&#39;****** PRE-unmerge stats:&#39;);&#10;    --&#10;    PKG_MERGE_OFFENDER.procUnmergeOffenders_NEW(&#10;        p_source_offender_crn &#61;&gt; l_rec.src_crn,&#10;        p_target_offender_crn &#61;&gt; l_rec.tgt_crn,&#10;        --&#10;        p_debug_flag &#61;&gt; &#39;Y&#39; );&#10;    --&#10;    do_fetch(CHR(10) || &#39;****** POST-unmerge stats:&#39;);&#10;    --&#10;END do_test_unmerge;&#10;&#10;--&#10;-- MMS Skip Subtree List function&#10;--&#10;FUNCTION get_merge_skip_subtree_list RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN&#10;        PKG_LstUtl.concat(&#10;            --p_exclude_nodes_lst,&#10;            &#39;&#39;,&#10;            --&#10;            &#39;ADDITIONAL_IDENTIFIER/NSI, &#39;                                                                 ||&#10;            &#39;OFFENDER/CONTACT_ALERT, &#39; ||&#10;            --&#39;*/OFFENDER_MANAGER&#39;, &#39;*/OFFENDER_TRANSFER&#39;, &#39;*/PRISON_OFFENDER_MANAGER&#39;, &#39;*/PROVIDER_LAO, &#39;  ||&#10;            --&#39;*/RESPONSIBLE_OFFICER,&#39; ||&#10;            &#39;OFFENDER_MANAGER/CONTACT_ALERT, &#39;                                                            ||&#10;            --&#10;            &#39;CONTACT/ASSESSMENT, CONTACT/CONTACTxxx, &#39;                                                    ||&#10;            &#39;CONTACT/DEREGISTRATION, CONTACT/ENFORCEMENTxxx, CONTACT/OASYS_ASSESSMENT, &#39;                  ||&#10;            &#39;CONTACT/REGISTRATION, CONTACT/REGISTRATION_REVIEW, CONTACT/SUBJECT_ACCESS_REPORT_CONTACT, &#39;  ||&#10;            &#39;CONTACT/UPW_APPOINTMENT, UPW_APPOINTMENT/ENFORCEMENT, &#39;                                      ||&#10;            --NDM-184: Allow EVENT&lt;-ASSESSMENT pair&#10;            --&#39;EVENT/ASSESSMENT, &#39;                                                                          ||&#10;            --&#10;            &#39;CONTACT_ALERT/*, &#39;                                                                           ||&#10;            --&#10;            &#39;OFFENDER_TRANSFER/*, ORDER_TRANSFER/*, RQMNT_TRANSFER/*, LIC_CONDITION_TRANSFER/*, &#39;         ||&#10;            &#39;PSS_RQMNT_TRANSFER/*, NSI_TRANSFER/*, &#39;                                                      ||&#10;--            &#39;COURT_REPORT_TRANSFER/*, INSTITUTIONAL_REPORT_TRANSFER/*, &#39;                                  ||&#10;            &#39;MASTER_TRANSFER/COURT_REPORT_TRANSFER, MASTER_TRANSFER/INSTITUTIONAL_REPORT_TRANSFER, &#39;      ||&#10;            --&#10;            &#39;*/ORGANISATION_OFFENDER, */CASELOAD, */COHORT_DIARY, &#39;                                       ||&#10;            &#39;*/REJECTED_TRANSFER_DIARY, &#39;                                                                 ||&#10;            &#39;*/SPG_NOTIFICATION, */SPG_EXCEPTION, */SPG_VERSION_ENTRY, */OFFENDER_CRC_EXPORT, &#39;           ||&#10;            &#39;/*DSS_SEARCH_REQUEST, */SPG_DOCUMENT_REQUEST, */SPG_SEARCH_OFFENDER, &#39;                       ||&#10;            &#39;*/CRC_INACTIVE_OFFENDER, */DATA_SCRIPT_MESSAGE, */SQL_SCRIPT_MESSAGE, &#39;                      ||&#10;            &#39;*/MOST_RECENTLY_VIEWED_OFFENDERS, &#39;                                                          ||&#10;            &#39;*/MERGE_HISTORY, */MERGE_DUPLICATES, */MERGE_OFFENDER_VALUES, */OFFENDER_MERGE_DETAILS, &#39;    ||&#10;            -- GDPR tables&#10;            &#39;*/GDPR_OFFENDER_DUPLICATE, */GDPR_OFFENDER_RETAINED, */GDPR_OFF_ELIGIBLE_DELETION, &#39;         ||&#10;            &#39;*/GDPR_OFFENDER_FREE_TEXT, */GDPR_DESTRUCTION_LOG, &#39;                                         ||&#10;            &#39;/*GDPR_OFF_ELIGIBLE_SEARCH, */GDPR_OFF_IICSA_SEARCH, &#39;                                       ||&#10;            -- POST PDM 21.05&#10;            &#39;*/MANAGEMENT_TIER_EVENT, &#39;                                                                   ||&#10;            -- DST-9035: exclude Offender Level Drug Profile tables - they should stay with the Source&#10;            &#39;OFFENDER/OFFENDER_DRUG_PROFILE&#39;,&#10;            --&#10;            p_delim &#61;&gt; &#39;, &#39; );&#10;    --&#10;END get_merge_skip_subtree_list;&#10;&#10;FUNCTION get_off_summary_TAB(&#10;    p_src_crn    VARCHAR2,&#10;    p_tgt_crn    VARCHAR2,&#10;    p_skip_nodes VARCHAR2 DEFAULT NULL )&#10;RETURN off_summary_tab_TYP PIPELINED&#10;IS&#10;    --&#10;    CURSOR cs IS&#10;      WITH O AS (&#10;        SELECT &#39;SRC&#39; AS src_or_tgt, p_src_crn AS crn FROM dual&#10;        UNION&#10;        SELECT &#39;TGT&#39; AS src_or_tgt, p_tgt_crn AS crn FROM dual ),&#10;      T AS (&#10;        SELECT&#10;          O.src_or_tgt,&#10;          O.crn,&#10;          hier_level,&#10;          table_name,&#10;          parent_table,&#10;          row_count,&#10;          id_list&#10;        FROM&#10;          O,&#10;          TABLE(&#10;              PKG_HIER_SUPPORT.get_off_data_nodes_summary(&#10;                  p_crn        &#61;&gt; O.crn,&#10;                  p_skip_nodes &#61;&gt; CASE WHEN p_skip_nodes IS NULL THEN PKG_MERGE_OFFENDER.get_merge_skip_subtree_list ELSE p_skip_nodes END,&#10;                  --&#10;                  p_include_merged       &#61;&gt; CASE WHEN src_or_tgt &#61; &#39;TGT&#39; THEN &#39;Y&#39; END,&#10;                  p_include_merged_level &#61;&gt; CASE WHEN src_or_tgt &#61; &#39;TGT&#39; THEN 1   END,&#10;                  p_crn1                 &#61;&gt; CASE WHEN src_or_tgt &#61; &#39;TGT&#39; THEN (SELECT crn FROM O WHERE src_or_tgt &#61; &#39;SRC&#39;) END ) )&#10;        )&#10;      --&#10;      SELECT&#10;        LPAD(&#39; &#39;, 2*hier_level) || table_name AS table_name,&#10;        hier_level,&#10;        parent_table,&#10;        row_count,&#10;        crn,&#10;        src_or_tgt,&#10;        CASE WHEN src_or_tgt &#61; &#39;TGT&#39; AND table_name NOT IN ( &#39;OFFENDER&#39; ) THEN&#10;            ( SELECT&#10;                LISTAGG (&#10;                    PKG_LstUtl.concat(&#10;                        column_value,&#10;                        PKG_Lookups.funcgetTabRecord(&#10;                            p_data_fld  &#61;&gt; &#39;OMD.source_pk_value&#39;,&#10;                            p_table     &#61;&gt; &#39;offender_merge_details OMD INNER JOIN offender O ON O.offender_id &#61; OMD.target_offender_id&#39;,&#10;                            p_ref_col   &#61;&gt; &#39;O.crn&#39;,&#10;                            p_ref_val   &#61;&gt; crn,&#10;                            p_where     &#61;&gt; &#39;OMD.table_name &#61; :p_tab_name AND OMD.target_pk_value &#61; :p_tgt_pk_value&#39;,&#10;                            p_bind_var1 &#61;&gt; table_name,&#10;                            p_bind_var2 &#61;&gt; column_value ),&#10;                        p_delim&#61;&gt;&#39;&lt;&#61;&#39; ),&#10;                    &#39;,&#39;)&#10;                WITHIN GROUP (ORDER BY column_value ASC)&#10;              FROM TABLE( PKG_LstUtl.get_list_2_array(id_list) )&#10;            )&#10;        ELSE&#10;            ( SELECT LISTAGG (column_value, &#39;,&#39;) WITHIN GROUP (ORDER BY column_value ASC)&#10;              FROM TABLE( PKG_LstUtl.get_list_2_array(id_list) )&#10;            )&#10;        END AS id_lst&#10;      FROM T&#10;--      ORDER BY&#10;--        DECODE(src_or_tgt, &#39;SRC&#39;, 1, 0),&#10;--        hier_level,&#10;--        parent_table,&#10;--        TRIM(table_name)&#10;      ;&#10;    --&#10;    l_rec off_summary_rec_TYP;&#10;    --&#10;BEGIN&#10;    --&#10;    OPEN cs;&#10;    LOOP&#10;        FETCH cs INTO&#10;          l_rec.table_name,&#10;          l_rec.hier_level,&#10;          l_rec.parent_table,&#10;          l_rec.row_count,&#10;          l_rec.crn,&#10;          l_rec.src_or_tgt,&#10;          l_rec.id_lst;&#10;        EXIT WHEN cs%NOTFOUND;&#10;        --&#10;        PIPE ROW (l_rec);&#10;    END LOOP;&#10;    CLOSE cs;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    IF cs%ISOPEN THEN CLOSE cs; END IF;&#10;    RAISE;&#10;END get_off_summary_TAB;&#10;&#10;&#10;--&#10;-- MMS process running state&#10;--&#10;FUNCTION get_merge_running_flag RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN NVL( G_NEW_MERGE_RUNNING_FLAG, &#39;N&#39; );&#10;END get_merge_running_flag;&#10;--&#10;PROCEDURE set_merge_running_flag(p_flag VARCHAR2) IS&#10;BEGIN&#10;    G_NEW_MERGE_RUNNING_FLAG :&#61; ( CASE WHEN p_flag &#61; &#39;Y&#39; THEN &#39;Y&#39; ELSE &#39;N&#39; END );&#10;END set_merge_running_flag;&#10;--&#10;&#10;--&#10;-- Get Offender Merge date / time for a specified pair of CRNs&#10;--&#10;FUNCTION get_merge_date_time(p_src_offender_id NUMBER, p_tgt_offender_id NUMBER)&#10;RETURN DATE&#10;IS&#10;    --&#10;    CURSOR cs IS&#10;      SELECT C.contact_date&#10;      FROM&#10;        offender_merge_details OMD&#10;          INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;          INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;            INNER JOIN contact C ON C.offender_id &#61; O2.offender_id&#10;              INNER JOIN r_contact_type CT ON CT.contact_type_id &#61; C.contact_type_id&#10;      WHERE 1&#61;1&#10;        AND OMD.table_name &#61; &#39;OFFENDER&#39;&#10;        AND OMD.source_offender_id &#61; p_src_offender_id&#10;        AND OMD.target_offender_id &#61; p_tgt_offender_id&#10;        AND CT.code &#61; &#39;OMRG&#39;&#10;        AND C.notes LIKE &#39;%Target Offender&#39; || CHR(10) ||&#10;                         &#39;CRN: &#39; || O2.crn  || CHR(10) ||&#10;                         &#39;%Source Offender&#39; || CHR(10) ||&#10;                         &#39;CRN: &#39; || O1.crn  || CHR(10) ||&#10;                         &#39;%&#39;&#10;      ORDER BY C.contact_date DESC;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    l_found_flag BOOLEAN;&#10;    --&#10;BEGIN&#10;    --&#10;    OPEN cs;&#10;    FETCH cs INTO l_rec;&#10;    l_found_flag :&#61; cs%FOUND;&#10;    CLOSE cs;&#10;    --&#10;    RETURN CASE WHEN l_found_flag THEN l_rec.contact_date ELSE NULL END;&#10;END get_merge_date_time;&#10;&#10;--&#10;-- MMS Merge run context subroutines&#10;--&#10;PROCEDURE set_merge_debug(p_debug_flag VARCHAR2) IS&#10;BEGIN&#10;    g_merge_ctx_rec.debug_flag :&#61; CASE WHEN p_debug_flag IN (&#39;Y&#39;, &#39;N&#39;) THEN p_debug_flag ELSE &#39;N&#39; END;&#10;END set_merge_debug;&#10;--&#10;FUNCTION get_merge_ctx RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN&#10;        &#39;[src_off_id&#61;&#39;                  || g_merge_ctx_rec.src_offender_id           || &#39;]&#39; || CHR(10) ||&#10;        &#39;[tgt_offender_id&#61;&#39;             || g_merge_ctx_rec.tgt_offender_id           || &#39;]&#39; || CHR(10) ||&#10;        &#39;[src_crn&#61;&#39;                     || g_merge_ctx_rec.src_crn                   || &#39;]&#39; || CHR(10) ||&#10;        &#39;[tgt_crn&#61;&#39;                     || g_merge_ctx_rec.tgt_crn                   || &#39;]&#39; || CHR(10) ||&#10;        &#39;[already_merged&#61;&#39;              || g_merge_ctx_rec.already_merged            || &#39;]&#39; || CHR(10) ||&#10;        &#39;[merged_date_time&#61;&#39;            || g_merge_ctx_rec.merged_date_time          || &#39;]&#39; || CHR(10) ||&#10;        --&#10;        &#39;[tgt_om_id_BAK&#61;&#39;               || g_merge_ctx_rec.old_tgt_offender_manager_id    || &#39;]&#39; || CHR(10) ||&#10;        &#39;[src_om_id_NEW&#61;&#39;               || g_merge_ctx_rec.src_offender_manager_id        || &#39;]&#39; || CHR(10) ||&#10;        &#39;[tgt_ro_id_BAK&#61;&#39;               || g_merge_ctx_rec.old_tgt_responsible_officer_id || &#39;]&#39; || CHR(10) ||&#10;        &#39;[src_ro_id_NEW&#61;&#39;               || g_merge_ctx_rec.src_responsible_officer_id     || &#39;]&#39; || CHR(10) ||&#10;        --&#10;        &#39;[move_crn&#61;&#39;                    || g_merge_ctx_rec.move_crn                  || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_dob&#61;&#39;                    || g_merge_ctx_rec.move_dob                  || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_first_name&#61;&#39;             || g_merge_ctx_rec.move_first_name           || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_gender&#61;&#39;                 || g_merge_ctx_rec.move_gender               || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_prev_name&#61;&#39;              || g_merge_ctx_rec.move_prev_name            || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_second_name&#61;&#39;            || g_merge_ctx_rec.move_second_name          || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_surname&#61;&#39;                || g_merge_ctx_rec.move_surname              || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_third_name&#61;&#39;             || g_merge_ctx_rec.move_third_name           || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_title&#61;&#39;                  || g_merge_ctx_rec.move_title                || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_cro&#61;&#39;                    || g_merge_ctx_rec.move_cro                  || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_date_died&#61;&#39;              || g_merge_ctx_rec.move_date_died            || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_email&#61;&#39;                  || g_merge_ctx_rec.move_email                || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_mobile&#61;&#39;                 || g_merge_ctx_rec.move_mobile               || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_ni&#61;&#39;                     || g_merge_ctx_rec.move_ni                   || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_noms&#61;&#39;                   || g_merge_ctx_rec.move_noms                 || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_pnc&#61;&#39;                    || g_merge_ctx_rec.move_pnc                  || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_sms&#61;&#39;                    || g_merge_ctx_rec.move_sms                  || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_telephone&#61;&#39;              || g_merge_ctx_rec.move_telephone            || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_ethnicity&#61;&#39;              || g_merge_ctx_rec.move_ethnicity            || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_ethnicity_1&#61;&#39;            || g_merge_ctx_rec.move_ethnicity_1          || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_immigration_number&#61;&#39;     || g_merge_ctx_rec.move_immigration_number   || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_immigration_status&#61;&#39;     || g_merge_ctx_rec.move_immigration_status   || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_interpreter_required&#61;&#39;   || g_merge_ctx_rec.move_interpreter_required || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_language&#61;&#39;               || g_merge_ctx_rec.move_language             || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_nationality&#61;&#39;            || g_merge_ctx_rec.move_nationality          || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_religion&#61;&#39;               || g_merge_ctx_rec.move_religion             || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_religion_desc&#61;&#39;          || g_merge_ctx_rec.move_religion_desc        || &#39;]&#39; || CHR(10) ||&#10;        &#39;[off_religion_hist_cnt&#61;&#39;       || g_merge_ctx_rec.off_religion_hist_cnt     || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_second_nationality&#61;&#39;     || g_merge_ctx_rec.move_second_nationality   || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_sexual_orientation&#61;&#39;     || g_merge_ctx_rec.move_sexual_orientation   || &#39;]&#39; || CHR(10) ||&#10;        --&#10;        &#39;[move_provider&#61;&#39;               || g_merge_ctx_rec.move_provider             || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_main_address&#61;&#39;           || g_merge_ctx_rec.move_main_address         || &#39;]&#39; || CHR(10) ||&#10;        &#39;[move_postal_address&#61;&#39;         || g_merge_ctx_rec.move_postal_address       || &#39;]&#39; || CHR(10) ||&#10;        --&#10;        &#39;[move_responsible_officer&#61;&#39;    || g_merge_ctx_rec.move_responsible_officer  || &#39;]&#39; || CHR(10) ||&#10;        --&#10;        &#39;[move_precon_doc&#61;&#39;             || g_merge_ctx_rec.move_precon_doc           || &#39;]&#39; || CHR(10) ||&#10;        --&#10;        &#39;[bg_flag&#61;&#39;     || g_merge_ctx_rec.bg_flag    || &#39;]&#39; || CHR(10) ||&#10;        &#39;[debug_flag&#61;&#39;  || g_merge_ctx_rec.debug_flag || &#39;]&#39;;&#10;    --&#10;END get_merge_ctx;&#10;--&#10;PROCEDURE do_set_merge_ctx(&#10;    p_src_offender_id           NUMBER DEFAULT -1,&#10;    p_tgt_offender_id           NUMBER DEFAULT -1,&#10;    --&#10;    p_source_offender_crn       VARCHAR2,&#10;    p_target_offender_crn       VARCHAR2,&#10;    --&#10;    p_already_merged            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_merged_date_time          DATE     DEFAULT NULL,&#10;    --&#10;    p_move_crn                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_dob                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_first_name           VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_gender               VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_prev_name            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_second_name          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_surname              VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_third_name           VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_title                VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_cro                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_date_died            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_email                VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_mobile               VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ni                   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_noms                 VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_pnc                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_sms                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_telephone            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ethnicity            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ethnicity_1          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_immigration_number   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_immigration_status   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_interpreter_required VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_language             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_nationality          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_religion             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_religion_desc        VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_off_religion_hist_cnt     INTEGER  DEFAULT NULL,&#10;    p_move_second_nationality   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_sexual_orientation   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_move_provider             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_main_address         VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_postal_address       VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_move_responsible_officer  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_move_precon_doc           VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_bg_flag                   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_debug_flag                VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_rec g_merge_ctx_rec_TYP;&#10;    --&#10;BEGIN&#10;    --&#10;    l_rec.src_offender_id           :&#61; p_src_offender_id;&#10;    l_rec.tgt_offender_id           :&#61; p_tgt_offender_id;&#10;    l_rec.src_crn                   :&#61; p_source_offender_crn;&#10;    l_rec.tgt_crn                   :&#61; p_target_offender_crn;&#10;    l_rec.already_merged            :&#61; p_already_merged;&#10;    l_rec.merged_date_time          :&#61; p_merged_date_time;&#10;    --&#10;    l_rec.move_crn                  :&#61; p_move_crn;&#10;    l_rec.move_dob                  :&#61; p_move_dob;&#10;    l_rec.move_first_name           :&#61; p_move_first_name;&#10;    l_rec.move_gender               :&#61; p_move_gender;&#10;    l_rec.move_prev_name            :&#61; p_move_prev_name;&#10;    l_rec.move_second_name          :&#61; p_move_second_name;&#10;    l_rec.move_surname              :&#61; p_move_surname;&#10;    l_rec.move_third_name           :&#61; p_move_third_name;&#10;    l_rec.move_title                :&#61; p_move_title;&#10;    l_rec.move_cro                  :&#61; p_move_cro;&#10;    l_rec.move_date_died            :&#61; p_move_date_died;&#10;    l_rec.move_email                :&#61; p_move_email;&#10;    l_rec.move_mobile               :&#61; p_move_mobile;&#10;    l_rec.move_ni                   :&#61; p_move_ni;&#10;    l_rec.move_noms                 :&#61; p_move_noms;&#10;    l_rec.move_pnc                  :&#61; p_move_pnc;&#10;    l_rec.move_sms                  :&#61; p_move_sms;&#10;    l_rec.move_telephone            :&#61; p_move_telephone;&#10;    l_rec.move_ethnicity            :&#61; p_move_ethnicity;&#10;    l_rec.move_ethnicity_1          :&#61; p_move_ethnicity_1;&#10;    l_rec.move_immigration_number   :&#61; p_move_immigration_number;&#10;    l_rec.move_immigration_status   :&#61; p_move_immigration_status;&#10;    l_rec.move_interpreter_required :&#61; p_move_interpreter_required;&#10;    l_rec.move_language             :&#61; p_move_language;&#10;    l_rec.move_nationality          :&#61; p_move_nationality;&#10;    l_rec.move_religion             :&#61; p_move_religion;&#10;    l_rec.move_religion_desc        :&#61; p_move_religion_desc;&#10;    l_rec.off_religion_hist_cnt     :&#61; p_off_religion_hist_cnt;&#10;    l_rec.move_second_nationality   :&#61; p_move_second_nationality;&#10;    l_rec.move_sexual_orientation   :&#61; p_move_sexual_orientation;&#10;    --&#10;    l_rec.move_provider             :&#61; p_move_provider;&#10;    l_rec.move_main_address         :&#61; p_move_main_address;&#10;    l_rec.move_postal_address       :&#61; p_move_postal_address;&#10;    --&#10;    l_rec.move_responsible_officer  :&#61; p_move_responsible_officer;&#10;    --&#10;    l_rec.move_precon_doc           :&#61; p_move_precon_doc;&#10;    --&#10;    l_rec.bg_flag                   :&#61; p_bg_flag;&#10;    l_rec.debug_flag                :&#61; p_debug_flag;&#10;    --&#10;    g_merge_ctx_rec :&#61; l_rec;&#10;    --&#10;    g_omd_cache_TAB.DELETE;&#10;    --&#10;END do_set_merge_ctx;&#10;--&#10;&#10;--&#10;-- MMS Merge OMD/OMDH helpers&#10;--&#10;FUNCTION get_merged_primary_key_id(&#10;    p_table              VARCHAR2,&#10;    p_src_offender_id    NUMBER,&#10;    p_src_primary_key_id VARCHAR2,&#10;    p_default_value      VARCHAR2 DEFAULT NULL)&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    CURSOR cs IS&#10;      SELECT target_pk_value&#10;      FROM offender_merge_details&#10;      WHERE table_name &#61; p_table&#10;        AND source_offender_id &#61; p_src_offender_id&#10;        AND source_pk_value &#61; p_src_primary_key_id;&#10;    --&#10;    l_rec   cs%ROWTYPE;&#10;    l_found BOOLEAN;&#10;    --&#10;BEGIN&#10;    OPEN cs;&#10;    FETCH cs INTO l_rec;&#10;    l_found :&#61; cs%FOUND;&#10;    CLOSE cs;&#10;    --&#10;    RETURN&#10;        CASE&#10;            WHEN l_found THEN l_rec.target_pk_value&#10;            ELSE p_default_value&#10;        END;&#10;END get_merged_primary_key_id;&#10;--&#10;FUNCTION get_omd_hist(&#10;    p_merge_det_ID  NUMBER,&#10;    p_fld_name      VARCHAR2,&#10;    p_old_new_flag  VARCHAR2,&#10;    p_tab_pk_value  VARCHAR2 DEFAULT NULL,&#10;    p_value_if_null VARCHAR2 DEFAULT NULL )&#10;RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_proc1 VARCHAR2(30) :&#61; &#39;GET_OMD_HIST&#39;;&#10;    --&#10;    CURSOR csOMDH IS&#10;      SELECT *&#10;      FROM offender_merge_details_hist&#10;      WHERE offender_merge_details_ID &#61; p_merge_det_id&#10;        AND column_name &#61; UPPER(p_fld_name)&#10;        --AND data_type &#61; p_data_type&#10;        AND ( ( p_tab_pk_value IS NULL )                                      OR&#10;              ( p_tab_pk_value  &#61; &#39;NOT NULL&#39; AND table_pk_value IS NOT NULL ) OR&#10;              ( p_tab_pk_value &lt;&gt; &#39;NOT NULL&#39; AND table_pk_value &#61; p_tab_pk_value )&#10;            );&#10;    --&#10;    l_rec_OMDH csOMDH%ROWTYPE;&#10;    --&#10;    l_found_flag BOOLEAN;&#10;    l_ret        VARCHAR2(255);&#10;    --&#10;BEGIN&#10;    --&#10;    OPEN csOMDH;&#10;    FETCH csOMDH INTO l_rec_OMDH;&#10;    l_found_flag :&#61; csOMDH%FOUND;&#10;    CLOSE csOMDH;&#10;    --&#10;    l_ret :&#61;&#10;        CASE&#10;            WHEN p_old_new_flag &#61; &#39;NEW&#39; THEN l_rec_OMDH.new_value&#10;            WHEN p_old_new_flag &#61; &#39;OLD&#39; THEN l_rec_OMDH.old_value&#10;            WHEN p_old_new_flag &#61; &#39;PK&#39;  THEN l_rec_OMDH.table_pk_value&#10;            ELSE NULL&#10;        END;&#10;    --&#10;    IF l_ret IS NULL AND l_found_flag THEN&#10;        l_ret :&#61; p_value_if_null;&#10;    END IF;&#10;    --&#10;    RETURN l_ret;&#10;END get_omd_hist;&#10;--&#10;FUNCTION get_off_merge_details(p_off_merge_det_id NUMBER, p_incl_debug_notes VARCHAR2 DEFAULT &#39;Y&#39;, p_incl_omd_hist VARCHAR2 DEFAULT &#39;Y&#39;) RETURN CLOB&#10;IS&#10;    --&#10;    l_ret CLOB;&#10;    --&#10;    CURSOR cs1 IS&#10;      SELECT&#10;        offender_merge_details_id,&#10;        hierarchy_level,&#10;        parent_table,&#10;        table_name,&#10;        source_offender_id AS src_offender_id,&#10;        target_offender_id AS tgt_offender_id,&#10;        source_pk_value    AS src_pk_value,&#10;        target_pk_value    AS tgt_pk_value,&#10;        source_fk_value    AS src_fk_value,&#10;        target_fk_value    AS tgt_fk_value,&#10;        debug_notes&#10;      FROM offender_merge_details&#10;      WHERE offender_merge_details_id &#61; p_off_merge_det_id;&#10;    --&#10;    l_rec1 cs1%ROWTYPE;&#10;    --&#10;BEGIN&#10;    --&#10;    OPEN cs1;&#10;    FETCH cs1 INTO l_rec1;&#10;    CLOSE cs1;&#10;    --&#10;    l_ret :&#61;&#10;        PKG_LstUtl.concat_CLOB(&#10;            &#39;[off_merge_det_id&#61;&#39; || l_rec1.offender_merge_details_id || &#39;]&#39; ||&#10;            &#39;[hier_level&#61;&#39;       || l_rec1.hierarchy_level           || &#39;]&#39; ||&#10;            &#39;[parent_tab&#61;&#39;       || l_rec1.parent_table              || &#39;]&#39; ||&#10;            &#39;[tab&#61;&#39;              || l_rec1.table_name                || &#39;]&#39;,&#10;            --&#10;            &#39;[src_off_id&#61;&#39;       || l_rec1.src_offender_id           || &#39;]&#39; ||&#10;            &#39;[tgt_off_id&#61;&#39;       || l_rec1.tgt_offender_id           || &#39;]&#39;,&#10;            --&#10;            &#39;[src_pk&#61;&#39;           || l_rec1.src_pk_value              || &#39;]&#39; ||&#10;            &#39;[tgt_pk&#61;&#39;           || l_rec1.tgt_pk_value              || &#39;]&#39;,&#10;            --&#10;            &#39;[src_fk&#61;&#39;           || l_rec1.src_fk_value              || &#39;]&#39; ||&#10;            &#39;[tgt_fk&#61;&#39;           || l_rec1.tgt_fk_value              || &#39;]&#39;,&#10;            --&#10;            CASE WHEN p_incl_debug_notes &#61; &#39;Y&#39; THEN &#39;OMD Debug Notes: &#39; || CHR(10) || l_rec1.debug_notes || CHR(10) END,&#10;            --&#10;            CASE WHEN p_incl_omd_hist &#61; &#39;Y&#39; THEN&#10;                PKG_LstUtl.concat_CLOB(&#10;                    &#39;***** OFFENDER_MERGE_DETAILS_HISTORY details *****&#39;,&#10;                    PKG_Lookups.funcgetTabRecord(&#10;                        p_table       &#61;&gt; &#39;OFFENDER_MERGE_DETAILS_HIST&#39;,&#10;                        p_data_fld    &#61;&gt;&#10;                            &#39;&#39;&#39;[col&#61;&#39;&#39; || column_name || &#39;&#39;]&#39; ||&#10;                              &#39;[type&#61;&#39;&#39; || data_type || &#39;&#39;]&#39; ||&#10;                              &#39;[old_val&#61;&#39;&#39; || old_value || &#39;&#39;]&#39; ||&#10;                              &#39;[new_val&#61;&#39;&#39; || new_value || &#39;&#39;]&#39;&#39; || &#39; ||&#10;                              &#39;CASE WHEN table_pk_value IS NOT NULL THEN &#39;&#39;[tab_pk_val&#61;&#39;&#39; || table_pk_value || &#39;&#39;]&#39;&#39; END&#39;,&#10;                        p_ref_col     &#61;&gt; &#39;offender_merge_details_id&#39;,&#10;                        p_ref_val     &#61;&gt; l_rec1.offender_merge_details_id,&#10;                        p_order_by    &#61;&gt; &#39;offender_merge_details_hist_id&#39;,&#10;                        p_all_records &#61;&gt; &#39;Y&#39;,&#10;                        p_delim       &#61;&gt; CHR(10) ),&#10;                    --&#10;                    p_delim&#61;&gt;CHR(10) )&#10;            END,&#10;            --&#10;            p_delim &#61;&gt; CHR(10) );&#10;    --&#10;    RETURN l_ret;&#10;END get_off_merge_details;&#10;--&#10;FUNCTION get_off_merge_details_1(p_off_merge_det_id NUMBER, p_incl_debug_notes VARCHAR2 DEFAULT &#39;Y&#39;, p_incl_omd_hist VARCHAR2 DEFAULT &#39;Y&#39;, p_max_len NUMBER DEFAULT 32000) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN SUBSTR(get_off_merge_details(p_off_merge_det_id, p_incl_debug_notes, p_incl_omd_hist), 1, NVL(p_max_len, 32000));&#10;END get_off_merge_details_1;&#10;--&#10;PROCEDURE do_ins_omd_rec(&#10;    p_hierarchy_level  NUMBER,&#10;    p_parent_table     VARCHAR2,&#10;    p_table_name       VARCHAR2,&#10;    p_src_offender_id  VARCHAR2,&#10;    p_tgt_offender_id  VARCHAR2,&#10;    p_src_pk_value     VARCHAR2,&#10;    p_tgt_pk_value     VARCHAR2,&#10;    p_src_fk_value     VARCHAR2,&#10;    p_tgt_fk_value     VARCHAR2,&#10;    p_debug_notes      VARCHAR2 DEFAULT NULL,&#10;    p_off_merge_det_id NUMBER DEFAULT -1,&#10;    x_changes_log_TAB  IN OUT g_ch_log_tab_TYP,&#10;    x_off_merge_det_id IN OUT NUMBER )&#10;IS&#10;    --PRAGMA AUTONOMOUS_TRANSACTION;&#10;    --&#10;    l_off_merge_det_id NUMBER;&#10;    --&#10;    l_rec g_ch_log_rec_TYP;&#10;    --&#10;BEGIN&#10;    --&#10;    IF NVL(p_off_merge_det_id, -1) &gt; 0 THEN&#10;        --&#10;        l_off_merge_det_id :&#61; p_off_merge_det_id;&#10;        --&#10;        IF p_debug_notes IS NOT NULL THEN&#10;            UPDATE offender_merge_details SET&#10;              debug_notes &#61; PKG_LstUtl.concat_CLOB(debug_notes, p_debug_notes, p_delim&#61;&gt;CHR(10))&#10;            WHERE offender_merge_details_ID &#61; l_off_merge_det_id;&#10;        END IF;&#10;        --&#10;    ELSE&#10;        --&#10;        l_off_merge_det_id :&#61; offender_merge_details_ID_SEQ.nextval;&#10;        --&#10;        INSERT INTO offender_merge_details(&#10;          /*01*/ offender_merge_details_ID,&#10;          /*02*/ hierarchy_level,&#10;          /*03*/ parent_table,&#10;          /*04*/ table_name,&#10;          /*05*/ source_offender_id,&#10;          /*06*/ target_offender_id,&#10;          /*07*/ source_pk_value,&#10;          /*08*/ target_pk_value,&#10;          /*09*/ source_fk_value,&#10;          /*10*/ target_fk_value,&#10;          /*11*/ debug_notes&#10;        ) VALUES (&#10;          /*01*/ l_off_merge_det_id,&#10;          /*02*/ p_hierarchy_level,&#10;          /*03*/ p_parent_table,&#10;          /*04*/ p_table_name,&#10;          /*05*/ p_src_offender_id,&#10;          /*06*/ p_tgt_offender_id,&#10;          /*07*/ CASE&#10;                     WHEN p_src_pk_value IS NULL THEN TO_CHAR(-1*TO_NUMBER(p_tgt_pk_value)) -- Record added on the Target side only&#10;                     ELSE p_src_pk_value&#10;                 END,&#10;          /*08*/ p_tgt_pk_value,&#10;          /*09*/ CASE&#10;                     WHEN p_src_fk_value IS NULL AND p_parent_table IS NOT NULL THEN TO_CHAR(-1*TO_NUMBER(p_tgt_fk_value)) -- Record added on the Target side only&#10;                     ELSE p_src_fk_value&#10;                 END,&#10;          /*10*/ p_tgt_fk_value,&#10;          /*11*/ p_debug_notes );&#10;        --COMMIT;&#10;    END IF;&#10;    --&#10;    IF x_changes_log_TAB IS NOT NULL THEN&#10;        --&#10;        FOR l_idx IN 1..x_changes_log_TAB.COUNT LOOP&#10;            --&#10;            l_rec :&#61; x_changes_log_TAB(l_idx);&#10;            --&#10;            INSERT INTO offender_merge_details_hist(&#10;              offender_merge_details_hist_id,&#10;              offender_merge_details_ID,&#10;              column_name,&#10;              data_type,&#10;              old_value,&#10;              new_value,&#10;              table_pk_value&#10;            ) VALUES (&#10;              offender_merge_det_hist_id_SEQ.nextval,&#10;              l_off_merge_det_id,&#10;              l_rec.column_name,&#10;              l_rec.data_type,&#10;              l_rec.old_value,&#10;              l_rec.new_value,&#10;              l_rec.pk_value);&#10;            --&#10;        END LOOP;&#10;        --&#10;        x_changes_log_TAB.DELETE;&#10;        --&#10;    END IF;&#10;    --&#10;    x_off_merge_det_id :&#61; l_off_merge_det_id;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --IF SQLERRM LIKE &#39;%ORA-%:%unique constraint%violated%&#39; THEN&#10;    --    --l_skip_FLAG :&#61; TRUE;&#10;    --    NULL;&#10;    --ELSE&#10;        --debugMessage(&#39;INSERT current record INTO OFFENDER_MERGE_DETAILS: &#39; || SQLERRM, p_err_flag&#61;&gt;&#39;Y&#39;);&#10;        fatal(get_dq_message(SQLERRM), &#39;do_ins_omd_rec&#39;);&#10;    --END IF;&#10;END do_ins_omd_rec;&#10;--&#10;-- Overload 1&#10;PROCEDURE do_ins_omd_rec(&#10;    p_hierarchy_level  NUMBER,&#10;    p_parent_table     VARCHAR2,&#10;    p_table_name       VARCHAR2,&#10;    p_src_offender_id  VARCHAR2,&#10;    p_tgt_offender_id  VARCHAR2,&#10;    p_src_pk_value     VARCHAR2,&#10;    p_tgt_pk_value     VARCHAR2,&#10;    p_src_fk_value     VARCHAR2,&#10;    p_tgt_fk_value     VARCHAR2,&#10;    p_debug_notes      VARCHAR2 DEFAULT NULL,&#10;    p_off_merge_det_id NUMBER DEFAULT -1,&#10;    x_changes_log_TAB  IN OUT g_ch_log_tab_TYP )&#10;IS&#10;    --&#10;    l_omd_id_TMP NUMBER;&#10;    --&#10;BEGIN&#10;    do_ins_omd_rec(&#10;        p_hierarchy_level  &#61;&gt; p_hierarchy_level,&#10;        p_parent_table     &#61;&gt; p_parent_table,&#10;        p_table_name       &#61;&gt; p_table_name,&#10;        p_src_offender_id  &#61;&gt; p_src_offender_id,&#10;        p_tgt_offender_id  &#61;&gt; p_tgt_offender_id,&#10;        p_src_pk_value     &#61;&gt; p_src_pk_value,&#10;        p_tgt_pk_value     &#61;&gt; p_tgt_pk_value,&#10;        p_src_fk_value     &#61;&gt; p_src_fk_value,&#10;        p_tgt_fk_value     &#61;&gt; p_tgt_fk_value,&#10;        p_debug_notes      &#61;&gt; p_debug_notes,&#10;        p_off_merge_det_id &#61;&gt; p_off_merge_det_id,&#10;        x_changes_log_TAB  &#61;&gt; x_changes_log_TAB,&#10;        x_off_merge_det_id &#61;&gt; l_omd_id_TMP );&#10;    --&#10;END do_ins_omd_rec;&#10;--&#10;-- Overload 1a (Update existing OMD record + (optionally) ad new OMDH&#10;PROCEDURE do_ins_omd_rec(&#10;    p_off_merge_det_id NUMBER,&#10;    p_debug_notes      VARCHAR2 DEFAULT NULL,&#10;    --&#10;    x_changes_log_TAB  IN OUT g_ch_log_tab_TYP )&#10;IS&#10;    --&#10;    l_omd_id_TMP NUMBER;&#10;    --&#10;BEGIN&#10;    --&#10;    do_ins_omd_rec(&#10;        p_hierarchy_level  &#61;&gt; NULL,&#10;        p_parent_table     &#61;&gt; NULL,&#10;        p_table_name       &#61;&gt; NULL,&#10;        p_src_offender_id  &#61;&gt; NULL,&#10;        p_tgt_offender_id  &#61;&gt; NULL,&#10;        p_src_pk_value     &#61;&gt; NULL,&#10;        p_tgt_pk_value     &#61;&gt; NULL,&#10;        p_src_fk_value     &#61;&gt; NULL,&#10;        p_tgt_fk_value     &#61;&gt; NULL,&#10;        p_debug_notes      &#61;&gt; p_debug_notes,&#10;        p_off_merge_det_id &#61;&gt; p_off_merge_det_id,&#10;        x_changes_log_TAB  &#61;&gt; x_changes_log_TAB,&#10;        x_off_merge_det_id &#61;&gt; l_omd_id_TMP );&#10;    --&#10;END do_ins_omd_rec;&#10;--&#10;-- Overload 2&#10;PROCEDURE do_ins_omd_rec(&#10;    p_hierarchy_level  NUMBER,&#10;    p_parent_table     VARCHAR2,&#10;    p_table_name       VARCHAR2,&#10;    p_src_offender_id  VARCHAR2,&#10;    p_tgt_offender_id  VARCHAR2,&#10;    p_src_pk_value     VARCHAR2,&#10;    p_tgt_pk_value     VARCHAR2,&#10;    p_src_fk_value     VARCHAR2,&#10;    p_tgt_fk_value     VARCHAR2,&#10;    p_debug_notes      VARCHAR2 DEFAULT NULL,&#10;    x_off_merge_det_id IN OUT NUMBER )&#10;IS&#10;    --&#10;    l_changes_log_TAB  g_ch_log_tab_TYP :&#61; g_ch_log_tab_TYP();&#10;    --&#10;BEGIN&#10;    do_ins_omd_rec(&#10;        p_hierarchy_level  &#61;&gt; p_hierarchy_level,&#10;        p_parent_table     &#61;&gt; p_parent_table,&#10;        p_table_name       &#61;&gt; p_table_name,&#10;        p_src_offender_id  &#61;&gt; p_src_offender_id,&#10;        p_tgt_offender_id  &#61;&gt; p_tgt_offender_id,&#10;        p_src_pk_value     &#61;&gt; p_src_pk_value,&#10;        p_tgt_pk_value     &#61;&gt; p_tgt_pk_value,&#10;        p_src_fk_value     &#61;&gt; p_src_fk_value,&#10;        p_tgt_fk_value     &#61;&gt; p_tgt_fk_value,&#10;        p_debug_notes      &#61;&gt; p_debug_notes,&#10;        x_changes_log_TAB  &#61;&gt; l_changes_log_TAB,&#10;        x_off_merge_det_id &#61;&gt; x_off_merge_det_id );&#10;END do_ins_omd_rec;&#10;--&#10;PROCEDURE do_del_OMD_rec(p_omd_id NUMBER) IS&#10;BEGIN&#10;    --&#10;    DELETE FROM offender_merge_details_hist&#10;    WHERE offender_merge_details_ID &#61; p_omd_id;&#10;    --&#10;    DELETE FROM offender_merge_details&#10;    WHERE offender_merge_details_ID &#61; p_omd_id;&#10;    --&#10;END do_del_OMD_rec;&#10;--&#10;PROCEDURE do_del_OMD_rec(&#10;    p_offender_id    NUMBER,&#10;    p_table_name     VARCHAR2,&#10;    p_primary_key_id VARCHAR2,&#10;    p_del_src_record VARCHAR2 DEFAULT &#39;Y&#39; )&#10;IS&#10;    --&#10;    l_proc VARCHAR2(30) :&#61; &#39;do_del_orphaned_OMD_1&#39;;&#10;    --&#10;    l_rows_OMD INTEGER :&#61; 0;&#10;    --&#10;    CURSOR csOMD IS&#10;      WITH OMD1 AS (&#10;        SELECT&#10;          O1.crn AS src_crn,&#10;          O2.crn AS tgt_crn,&#10;          PKG_Lookups.funcgetTabRecord(&#10;              p_table       &#61;&gt; OMD.table_name,&#10;              p_data_fld    &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;              p_ref_col     &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;              p_ref_val     &#61;&gt; OMD.target_pk_value,&#10;              p_default_val &#61;&gt; &#39;-1&#39;&#10;          ) AS tgt_cur_pk_value,&#10;          PKG_Lookups.funcgetTabRecord(&#10;              p_table       &#61;&gt; OMD.table_name,&#10;              p_data_fld    &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;              p_ref_col     &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;              p_ref_val     &#61;&gt; OMD.source_pk_value,&#10;              p_default_val &#61;&gt; &#39;-1&#39;&#10;          ) AS src_cur_pk_value,&#10;          OMD.*&#10;        FROM&#10;          offender_merge_details OMD&#10;            INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;            INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;        WHERE OMD.target_offender_id &#61; p_offender_id&#10;          AND OMD.table_name &#61; UPPER(p_table_name)&#10;          AND OMD.target_pk_value &#61; p_primary_key_id&#10;        )&#10;      --&#10;      SELECT *&#10;      FROM OMD1;&#10;    --&#10;    l_rec_OMD csOMD%ROWTYPE;&#10;    --&#10;    PROCEDURE do_check_ai_immn&#10;    IS&#10;        --&#10;        l_found_flag BOOLEAN;&#10;        --&#10;        CURSOR csAI IS&#10;          SELECT&#10;            O.offender_id,&#10;            O.crn,&#10;            O.soft_deleted AS off_soft_deleted,&#10;            O.immigration_number,&#10;            AI.additional_identifier_id,&#10;            R.code_value AS ai_type_code,&#10;            AI.soft_deleted&#10;          FROM&#10;            additional_identifier AI&#10;              INNER JOIN r_standard_reference_list R ON R.standard_reference_list_id &#61; AI.identifier_name_id&#10;              INNER JOIN offender O ON O.offender_id &#61; AI.offender_id&#10;          WHERE AI.additional_identifier_id &#61; l_rec_OMD.source_pk_value;&#10;        --&#10;        l_rec_AI csAI%ROWTYPE;&#10;        --&#10;    BEGIN&#10;        --&#10;        OPEN csAI;&#10;        FETCH csAI INTO l_rec_AI;&#10;        l_found_flag :&#61; csAI%FOUND;&#10;        CLOSE csAI;&#10;        --&#10;        IF l_rec_AI.offender_id &lt;&gt; l_rec_OMD.source_offender_id THEN&#10;            fatal(&#10;                &#39;ERROR in DO_CHECK_AI_IMMN: ADDITIONAL_IDENTIFIER.offender_id does not match the Source Record in OMD &#39; ||&#10;                &#39;[src_crn&#61;&#39;    || l_rec_OMD.src_crn         || &#39;]&#39; ||&#10;                &#39;[AI_crn&#61;&#39;     || l_rec_AI.crn              || &#39;]&#39; ||&#10;                &#39;[AI_src_pk&#61;&#39;  || l_rec_OMD.source_pk_value || &#39;]&#39;,&#10;                --&#10;                l_proc );&#10;        END IF;&#10;        --&#10;        IF l_found_flag                   AND&#10;           l_rec_AI.ai_type_code &#61; &#39;IMMN&#39; AND&#10;           l_rec_AI.immigration_number IS NOT NULL&#10;        THEN&#10;            --&#10;            UPDATE offender SET immigration_number &#61; NULL&#10;            WHERE offender_id &#61; l_rec_OMD.source_offender_id;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_check_ai_immn;&#10;    --&#10;    PROCEDURE do_init&#10;    IS&#10;        --&#10;        PROCEDURE do_error(p_msg VARCHAR2, p_label VARCHAR2 DEFAULT NULL) IS&#10;        BEGIN&#10;            fatal(&#10;                &#39;ERROR &#39;           ||&#10;                &#39;[off_id&#61;&#39;         || p_offender_id     || &#39;]&#39; ||&#10;                &#39;[tab_name&#61;&#39;       || p_table_name      || &#39;]&#39; ||&#10;                &#39;[tab_pk_value&#61;&#39;   || p_primary_key_id  || &#39;]&#39; ||&#10;                &#39;[del_src_record&#61;&#39; || p_del_src_record  || &#39;]: &#39; ||&#10;                p_msg,&#10;                l_proc );&#10;        END do_error;&#10;        --&#10;        PROCEDURE do_perform_checks IS&#10;        BEGIN&#10;            --&#10;            IF p_offender_id IS NULL THEN&#10;                do_error(&#39;Offender ID value must be specified&#39;);&#10;            ELSIF p_table_name IS NULL THEN&#10;                do_error(&#39;Table Name value must be specified&#39;);&#10;            ELSIF p_primary_key_id IS NULL THEN&#10;                do_error(&#39;Table Primary Key value must be specified&#39;);&#10;            ELSIF p_del_src_record IS NULL THEN&#10;                do_error(&#39;P_DEL_SRC_RECORD value can only be set to either Y or N values&#39;);&#10;            END IF;&#10;            --&#10;        END do_perform_checks;&#10;        --&#10;    BEGIN&#10;        --&#10;        do_perform_checks;&#10;        --&#10;    END do_init;&#10;    --&#10;BEGIN&#10;    --&#10;    do_init;&#10;    --&#10;    OPEN csOMD;&#10;    LOOP&#10;        FETCH csOMD INTO l_rec_OMD;&#10;        EXIT WHEN csOMD%NOTFOUND;&#10;        --&#10;        IF l_rec_OMD.tgt_cur_pk_value &lt;&gt; &#39;-1&#39; THEN&#10;            fatal(&#10;                &#39;ERROR: A merged Target record still exist &#39; ||&#10;                &#39;[tab&#61;&#39;    || l_rec_OMD.table_name      || &#39;]&#39; ||&#10;                &#39;[tgt_pk&#61;&#39; || l_rec_OMD.target_pk_value || &#39;]&#39; ||&#10;                &#39;[src_pk&#61;&#39; || l_rec_OMD.source_pk_value || &#39;]&#39; ||&#10;                &#39;[parent&#61;&#39; || l_rec_OMD.parent_table    || &#39;]&#39; ||&#10;                &#39;[tgt_fk&#61;&#39; || l_rec_OMD.target_fk_value || &#39;]&#39; ||&#10;                &#39;[src_fk&#61;&#39; || l_rec_OMD.source_fk_value || &#39;]&#39; ||&#10;                &#39;[del_src_record&#61;&#39; || p_del_src_record  || &#39;]&#39;,&#10;                --&#10;                l_proc );&#10;        END IF;&#10;        --&#10;        warn(&#10;            &#39;Delete orphaned records from OFFENDER_MERGE_DETAILS &#39; ||&#10;            &#39;[tab&#61;&#39;    || l_rec_OMD.table_name      || &#39;]&#39; ||&#10;            &#39;[tgt_pk&#61;&#39; || l_rec_OMD.target_pk_value || &#39;]&#39; ||&#10;            &#39;[src_pk&#61;&#39; || l_rec_OMD.source_pk_value || &#39;]&#39; ||&#10;            &#39;[parent&#61;&#39; || l_rec_OMD.parent_table    || &#39;]&#39; ||&#10;            &#39;[tgt_fk&#61;&#39; || l_rec_OMD.target_fk_value || &#39;]&#39; ||&#10;            &#39;[src_fk&#61;&#39; || l_rec_OMD.source_fk_value || &#39;]&#39; ||&#10;            &#39;[del_src_record&#61;&#39; || p_del_src_record  || &#39;]&#39;,&#10;            --&#10;            l_proc );&#10;        --&#10;        IF NVL(p_del_src_record, &#39;Y&#39;) &#61; &#39;Y&#39; THEN&#10;            --&#10;            IF UPPER(l_rec_OMD.table_name) &#61; &#39;ADDITIONAL_IDENTIFIER&#39; THEN&#10;                do_check_ai_immn;&#10;            END IF;&#10;            --&#10;            EXECUTE IMMEDIATE&#10;             &#39;DELETE FROM &#39; || l_rec_OMD.table_name || &#39;&#10;              WHERE &#39; || PKG_DynSQL.get_tab_pk_fld_lst(l_rec_OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1) || &#39; &#61; :p_pk&#39;&#10;            USING&#10;              l_rec_OMD.source_pk_value;&#10;            --&#10;            IF SQL%ROWCOUNT &#61; 1 THEN&#10;                --&#10;                warn( &#39;WARNING: deleted 1 record from the Source &#39; || l_rec_OMD.table_name || &#39; table (as it does not exist on the Target anymore&#39;, l_proc );&#10;                --&#10;            END IF;&#10;            --&#10;        END IF;&#10;        --&#10;        -- Overload&#10;        do_del_OMD_rec(p_omd_id&#61;&gt;l_rec_OMD.offender_merge_details_ID);&#10;        --&#10;        l_rows_OMD :&#61; l_rows_OMD + 1;&#10;        --&#10;    END LOOP;&#10;    CLOSE csOMD;&#10;    --&#10;    IF l_rows_OMD &#61; 1 THEN&#10;        warn( &#39;Total OMD rows&#61;&#39; || l_rows_OMD || &#39;] - deleted&#39;, l_proc );&#10;    ELSIF l_rows_OMD &gt; 1 THEN&#10;        fatal( &#39;Total OMD rows&#61;&#39; || l_rows_OMD || &#39;] - deleted (expected no more than 1)&#39;, l_proc );&#10;    END IF;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    IF csOMD%ISOPEN THEN CLOSE csOMD; END IF;&#10;    RAISE;&#10;    --&#10;END do_del_OMD_rec;&#10;--&#10;PROCEDURE do_del_OMD_rec_ext(&#10;    p_offender_id    NUMBER,&#10;    p_table_name     VARCHAR2,&#10;    p_primary_key_id VARCHAR2,&#10;    p_del_src_record VARCHAR2 DEFAULT &#39;Y&#39; )&#10;IS&#10;    --&#10;    l_key VARCHAR2(512);&#10;    l_rec g_OMD_del_rec_TYP;&#10;    --&#10;BEGIN&#10;    --&#10;    IF get_merge_running_flag &#61; &#39;N&#39; AND g_del_OMD_rec_in_progress_FLAG &#61; &#39;N&#39; THEN&#10;        --&#10;        l_key :&#61;&#10;            p_offender_id || &#39;|&#39; ||&#10;            p_table_name  || &#39;|&#39; ||&#10;            p_primary_key_id;&#10;        --&#10;        IF NOT g_OMD_del_TAB.EXISTS(l_key) THEN&#10;            --&#10;            l_rec.offender_id :&#61; p_offender_id;&#10;            l_rec.table_name :&#61; p_table_name;&#10;            l_rec.primary_key_id :&#61; p_primary_key_id;&#10;            --&#10;            g_OMD_del_TAB(l_key) :&#61; l_rec;&#10;            --&#10;        END IF;&#10;        --&#10;    END IF;&#10;    --&#10;END do_del_OMD_rec_ext;&#10;--&#10;PROCEDURE do_del_OMD_rec_ext_FLUSH(p_table_name VARCHAR2)&#10;IS&#10;    --&#10;    l_key  VARCHAR2(512);&#10;    l_rec  g_OMD_del_rec_TYP;&#10;    l_rec1 g_OMD_del_rec_TYP;&#10;    l_init_flag BOOLEAN :&#61; FALSE;&#10;    --&#10;    PROCEDURE do_check_rec IS&#10;    BEGIN&#10;        --&#10;        IF l_rec.table_name &lt;&gt; p_table_name THEN&#10;            --&#10;            raise_application_error( 20001,&#10;                &#39;ERROR in do_del_OMD_rec_ext_FLUSH &#39; ||&#10;                &#39;[tab&#61;&#39;   || l_rec.table_name || &#39;]&#39; ||&#10;                &#39;[p_tab&#61;&#39; || p_table_name     || &#39;]&#39; );&#10;            --&#10;        END IF;&#10;        --&#10;        IF l_init_flag THEN&#10;            --&#10;            IF l_rec.offender_id &lt;&gt; l_rec1.offender_id OR&#10;               l_rec.table_name  &lt;&gt; l_rec1.table_name&#10;            THEN&#10;                raise_application_error( 20001,&#10;                    &#39;ERROR in do_del_OMD_rec_ext_FLUSH.do_check_rec &#39; ||&#10;                    &#39;[off_id&#61;&#39;   || l_rec.offender_id  || &#39;]&#39; ||&#10;                    &#39;[off_id_1&#61;&#39; || l_rec1.offender_id || &#39;]&#39; ||&#10;                    &#39;[tab&#61;&#39;      || l_rec.table_name   || &#39;]&#39; ||&#10;                    &#39;[tab_1&#61;&#39;    || l_rec1.table_name  || &#39;]&#39; );&#10;            END IF;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_check_rec;&#10;    --&#10;    PROCEDURE do_del_OMD_rec_1 IS&#10;    BEGIN&#10;        --&#10;        g_del_OMD_rec_in_progress_FLAG :&#61; &#39;Y&#39;;&#10;        --&#10;        do_del_OMD_rec(&#10;            p_offender_id    &#61;&gt; l_rec.offender_id,&#10;            p_table_name     &#61;&gt; l_rec.table_name,&#10;            p_primary_key_id &#61;&gt; l_rec.primary_key_id,&#10;            p_del_src_record &#61;&gt; &#39;Y&#39; );&#10;        --&#10;        g_del_OMD_rec_in_progress_FLAG :&#61; &#39;N&#39;;&#10;        --&#10;    EXCEPTION WHEN OTHERS THEN&#10;        --&#10;        g_del_OMD_rec_in_progress_FLAG :&#61; &#39;N&#39;;&#10;        RAISE;&#10;        --&#10;    END do_del_OMD_rec_1;&#10;    --&#10;BEGIN&#10;    --&#10;    IF get_merge_running_flag &#61; &#39;N&#39; AND g_del_OMD_rec_in_progress_FLAG &#61; &#39;N&#39; THEN&#10;        --&#10;        l_key :&#61; g_OMD_del_TAB.FIRST;&#10;        LOOP&#10;            EXIT WHEN l_key IS NULL;&#10;            --&#10;            l_rec :&#61; g_OMD_del_TAB(l_key);&#10;            --&#10;            do_check_rec;&#10;            do_del_OMD_rec_1;&#10;            --&#10;            l_key       :&#61; g_OMD_del_TAB.NEXT(l_key);&#10;            l_rec1      :&#61; l_rec;&#10;            l_init_flag :&#61; TRUE;&#10;            --&#10;        END LOOP;&#10;        --&#10;        g_OMD_del_TAB.DELETE;&#10;        --&#10;    END IF;&#10;    --&#10;END do_del_OMD_rec_ext_FLUSH;&#10;--&#10;PROCEDURE do_del_OMD_subtree(&#10;    p_src_offender_id NUMBER,&#10;    p_table_name      VARCHAR2,&#10;    p_source_pk_value VARCHAR2 )&#10;IS&#10;    --&#10;    l_rows_OMD INTEGER :&#61; 0;&#10;    --&#10;    CURSOR csOMD IS&#10;      WITH OMD1 AS (&#10;        SELECT&#10;          level,&#10;          LPAD(&#39; &#39;, (level-1)*2) || OMD.table_name AS table_name1,&#10;          offender_merge_details_id,&#10;          hierarchy_level,&#10;          parent_table,&#10;          table_name,&#10;          source_offender_id,&#10;          target_offender_id,&#10;          source_pk_value,&#10;          target_pk_value,&#10;          source_fk_value,&#10;          target_fk_value,&#10;          debug_notes&#10;        FROM&#10;          offender_merge_details OMD&#10;            --INNER JOIN offender O ON O.offender_id &#61; OMD.source_offender_id&#10;        START WITH OMD.source_offender_id &#61; p_src_offender_id&#10;               AND OMD.table_name &#61; p_table_name&#10;               AND OMD.source_pk_value &#61; p_source_pk_value&#10;        CONNECT BY&#10;          1&#61;1&#10;          AND PRIOR OMD.table_name         &#61; OMD.parent_table&#10;          AND PRIOR OMD.source_offender_id &#61; OMD.source_offender_id&#10;          AND PRIOR OMD.source_pk_value    &#61; OMD.source_fk_value&#10;        )&#10;      --&#10;      SELECT DISTINCT offender_merge_details_id&#10;      FROM OMD1;&#10;    --&#10;    l_rec_OMD csOMD%ROWTYPE;&#10;    --&#10;BEGIN&#10;    --&#10;    OPEN csOMD;&#10;    LOOP&#10;        FETCH csOMD INTO l_rec_OMD;&#10;        EXIT WHEN csOMD%NOTFOUND;&#10;        --&#10;        do_del_omd_rec(p_omd_id&#61;&gt;l_rec_OMD.offender_merge_details_ID);&#10;        --&#10;        l_rows_OMD :&#61; l_rows_OMD + 1;&#10;        --&#10;    END LOOP;&#10;    CLOSE csOMD;&#10;    --&#10;    info(&#10;        --l_proc2 || &#39;: &#39; ||&#10;        &#39;Delete records (recursively) from OFFENDER_MERGE_DETAILS [tab&#61;&#39; || p_table_name || &#39;][pk&#61;&#39; || p_source_pk_value || &#39;][total rows deleted&#61;&#39; || l_rows_OMD || &#39;]&#39;,&#10;        --&#10;        p_trace_level &#61;&gt; 15,&#10;        p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;    --&#10;END do_del_OMD_subtree;&#10;--&#10;PROCEDURE get_check_src_rec_for_deletion(x_table_name OUT VARCHAR2, x_parent_table OUT VARCHAR2, x_row_id OUT ROWID) IS&#10;BEGIN&#10;    x_table_name   :&#61; G_TABLE_NAME;&#10;    x_parent_table :&#61; G_PARENT_TABLE;&#10;    x_row_id       :&#61; G_ROW_ID;&#10;END get_check_src_rec_for_deletion;&#10;--&#10;PROCEDURE do_check_src_rec_for_deletion(&#10;    p_parent_table      VARCHAR2,&#10;    p_table             VARCHAR2,&#10;    p_offender_id       NUMBER,&#10;    l_parent_row_id     ROWID,&#10;    p_row_id            ROWID,&#10;    p_recursive_level   INTEGER )&#10;IS&#10;    --&#10;    l_table VARCHAR2(30);&#10;    --&#10;    l_crn_lst VARCHAR2(4000);&#10;    --&#10;    l_pk_fld VARCHAR2(512);&#10;    --&#10;    PROCEDURE do_upd_omd_PREV&#10;    IS&#10;        --&#10;        l_omd_id_PREV NUMBER;&#10;        l_omd_id_CURR NUMBER;&#10;        --&#10;        l_omd_details_PREV CLOB;&#10;        l_omd_details_CURR CLOB;&#10;        --&#10;        CURSOR csOMD1(p_omd_id NUMBER) IS&#10;          SELECT&#10;            OMD.*,&#10;            O1.crn AS src_crn,&#10;            O2.crn AS tgt_crn&#10;          FROM&#10;            offender_merge_details OMD&#10;              INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;              INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;          WHERE offender_merge_details_id &#61; p_omd_id;&#10;        --&#10;        l_rec_omd_PREV csOMD1%ROWTYPE;&#10;        l_rec_omd_CURR csOMD1%ROWTYPE;&#10;        --&#10;        l_omd_key VARCHAR2(512);&#10;        --&#10;        FUNCTION get_omd_key(p_table_name VARCHAR2, p_source_offender_id NUMBER, p_source_pk_value VARCHAR2) RETURN VARCHAR IS&#10;        BEGIN&#10;            RETURN p_table_name || &#39;|&#39; || p_source_offender_id || &#39;|&#39; ||  p_source_pk_value;&#10;        END get_omd_key;&#10;        --&#10;        PROCEDURE do_fetch_omd_details&#10;        IS&#10;            --&#10;            l_ret_str VARCHAR2(1024);&#10;            --&#10;            PROCEDURE do_cache_OMD&#10;            IS&#10;                --&#10;                l_OMD_id NUMBER;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_OMD_id :&#61;&#10;                    PKG_Lookups.funcgetTabRecord(&#10;                        p_data_fld  &#61;&gt; &#39;OMD.offender_merge_details_id&#39;,&#10;                        p_table     &#61;&gt; l_table || &#39;&#10;  -- Current (OMD)&#10;  INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;&#39;&#39; || l_table || &#39;&#39;&#39;&#10;                                       AND OMD.source_pk_value &#61; TO_CHAR(&#39; || l_table || &#39;.&#39; || l_pk_fld || &#39;)&#39;,&#10;                        --&#10;                        p_ref_col   &#61;&gt; l_table || &#39;.rowid&#39;,&#10;                        p_ref_val   &#61;&gt; p_row_id,&#10;                        p_where     &#61;&gt; &#39;OMD.source_offender_id &#61; :p_src_offender_id&#39;,&#10;                        p_bind_var1 &#61;&gt; g_merge_ctx_rec.src_offender_id );&#10;--                    PKG_Lookups.funcgetTabRecord(&#10;--                        p_data_fld  &#61;&gt; &#39;OMD.offender_merge_details_id&#39;,&#10;--                        p_table     &#61;&gt;&#10;--                            l_table || &#39;&#10;--                               -- Current (OMD)&#10;--                               INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;&#39;&#39; || l_table || &#39;&#39;&#39;&#10;--&#10;--                                                                    AND OMD.source_pk_value &#61; &#39; || l_table || &#39;.&#39; || l_pk_fld,&#10;--                        p_ref_col   &#61;&gt; l_table || &#39;.rowid&#39;,&#10;--                        p_ref_val   &#61;&gt; p_row_id,&#10;--                        p_where     &#61;&gt; &#39;OMD.source_offender_id &#61; :p_src_offender_id&#39;,&#10;--                        p_bind_var1 &#61;&gt; g_merge_ctx_rec.src_offender_id );&#10;                --&#10;                IF l_OMD_id &gt; 0 THEN&#10;                    --&#10;                    OPEN csOMD1(l_omd_id);&#10;                    FETCH csOMD1 INTO l_rec_omd_CURR;&#10;                    CLOSE csOMD1;&#10;                    --&#10;                    l_omd_key :&#61; get_omd_key(l_rec_omd_CURR.table_name, l_rec_omd_CURR.source_offender_id, l_rec_omd_CURR.source_pk_value);&#10;                    g_omd_cache_TAB(l_omd_key) :&#61; l_rec_omd_CURR.target_pk_value;&#10;                    --&#10;                    info(&#39;GET_CHECK_SRC_REC_FOR_DELETION.do_fetch_omd_details.do_cache_OMD&#39; || &#39;: &#39; ||&#10;                        &#39;Added new entry into OMD cache: [&#39; || l_omd_key || &#39;]: &#39; || l_rec_omd_CURR.target_pk_value,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_cache_OMD;&#10;            --&#10;        BEGIN&#10;            --&#10;            l_ret_str :&#61;&#10;                PKG_Lookups.funcgetTabRecord(&#10;                    p_data_fld  &#61;&gt; &#39;PKG_LstUtl.concat(OMD.offender_merge_details_id, OMD1.offender_merge_details_id, p_delim&#61;&gt;&#39;&#39;|&#39;&#39;)&#39;,&#10;                    p_table     &#61;&gt; l_table || &#39;&#10;  --Previous (OMD)&#10;  INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;&#39;&#39; || l_table || &#39;&#39;&#39;&#10;                                       AND OMD.target_pk_value &#61; TO_CHAR(&#39; || l_table || &#39;.&#39; || l_pk_fld || &#39;)&#10;    -- Current (OMD1)&#10;    INNER JOIN offender_merge_details OMD1 ON OMD1.table_name &#61; OMD.table_name&#10;      AND OMD1.source_pk_value &#61; OMD.target_pk_value&#10;      AND OMD1.source_offender_id &#61; OMD.target_offender_id&#10;      --AND NVL(OMD1.parent_table, &#39;&#39;OFFENDER&#39;&#39;) &#61; NVL(OMD.parent_table, &#39;&#39;OFFENDER&#39;&#39;)&#10;      --AND OMD1.hierarchy_level &#61; OMD.hierarchy_level&#39;,&#10;                    --&#10;                    p_ref_col   &#61;&gt; l_table || &#39;.rowid&#39;,&#10;                    p_ref_val   &#61;&gt; p_row_id,&#10;                    p_where     &#61;&gt; &#39;OMD.target_offender_id &#61; :p_tgt_offender_id&#39;,&#10;                    p_bind_var1 &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                    p_order_by  &#61;&gt; &#39;OMD.offender_merge_details_id, OMD1.offender_merge_details_id&#39; );&#10;--                PKG_Lookups.funcgetTabRecord(&#10;--                    p_data_fld  &#61;&gt; &#39;PKG_LstUtl.concat(OMD.offender_merge_details_id, OMD1.offender_merge_details_id, p_delim&#61;&gt;&#39;&#39;|&#39;&#39;)&#39;,&#10;--                    p_table     &#61;&gt;&#10;--                        &#39;--Previous (OMD)&#10;--                         offender_merge_details OMD&#10;--                           INNER JOIN &#39; || l_table || &#39; ON &#39; || l_table || &#39;.&#39; || l_pk_fld || &#39; &#61; OMD.target_pk_value&#10;--                           -- Current (OMD1)&#10;--                           INNER JOIN offender_merge_details OMD1 ON OMD1.table_name &#61; OMD.table_name&#10;--                             AND OMD1.source_pk_value &#61; OMD.target_pk_value&#10;--                             AND OMD1.source_offender_id &#61; OMD.target_offender_id&#10;--                             --AND NVL(OMD1.parent_table, &#39;&#39;OFFENDER&#39;&#39;) &#61; NVL(OMD.parent_table, &#39;&#39;OFFENDER&#39;&#39;)&#10;--                             --AND OMD1.hierarchy_level &#61; OMD.hierarchy_level&#39;,&#10;--                    p_ref_col   &#61;&gt; l_table || &#39;.rowid&#39;,&#10;--                    p_ref_val   &#61;&gt; p_row_id,&#10;--                    p_where     &#61;&gt; &#39;OMD.table_name &#61; :p_table_name AND OMD.target_offender_id &#61; :p_tgt_offender_id&#39;,&#10;--                    p_bind_var1 &#61;&gt; l_table,&#10;--                    p_bind_var2 &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;--                    p_order_by  &#61;&gt; &#39;OMD.offender_merge_details_id, OMD1.offender_merge_details_id&#39; );&#10;            --&#10;--            --&#10;--            info(&#39;GET_CHECK_SRC_REC_FOR_DELETION.do_fetch_omd_details&#39; || &#39;: &#39; ||&#10;--                &#39;[tab&#61;&#39;        || l_table                         || &#39;]&#39; ||&#10;--                &#39;[row_id&#61;&#39;     || p_row_id                        || &#39;]&#39; ||&#10;--                &#39;[src_off_id&#61;&#39; || g_merge_ctx_rec.src_offender_id || &#39;]&#39; ||&#10;--                &#39;[ret&#61;&#39;        || l_ret_str                       || &#39;]&#39;,&#10;--                --&#10;--                p_trace_level &#61;&gt; 15,&#10;--                p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;            --&#10;            IF l_ret_str IS NULL THEN&#10;                --&#10;                do_cache_OMD;&#10;                --&#10;                l_omd_id_PREV :&#61; -1;&#10;                l_omd_id_CURR :&#61; -1;&#10;                --&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            l_omd_id_PREV :&#61; PKG_LstUtl.list_num_elem(l_ret_str, &#39;|&#39;, 1);&#10;            l_omd_id_CURR :&#61; PKG_LstUtl.list_num_elem(l_ret_str, &#39;|&#39;, 2);&#10;            --&#10;            OPEN csOMD1(l_omd_id_PREV);&#10;            FETCH csOMD1 INTO l_rec_omd_PREV;&#10;            CLOSE csOMD1;&#10;            --&#10;            OPEN csOMD1(l_omd_id_CURR);&#10;            FETCH csOMD1 INTO l_rec_omd_CURR;&#10;            CLOSE csOMD1;&#10;            --&#10;            l_omd_key :&#61; get_omd_key(l_rec_omd_CURR.table_name, l_rec_omd_CURR.source_offender_id, l_rec_omd_CURR.source_pk_value);&#10;            g_omd_cache_TAB(l_omd_key) :&#61; l_rec_omd_CURR.target_pk_value;&#10;            --&#10;            info(&#39;GET_CHECK_SRC_REC_FOR_DELETION.do_fetch_omd_details&#39; || &#39;: &#39; ||&#10;                &#39;Added new entry into OMD cache: [&#39; || l_omd_key || &#39;]: &#39; || l_rec_omd_CURR.target_pk_value,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;            --&#10;        END do_fetch_omd_details;&#10;        --&#10;        PROCEDURE do_upd_omd_PREV1&#10;        IS&#10;            --&#10;            l_tgt_pk_value OFFENDER_MERGE_DETAILS.target_pk_value%TYPE;&#10;            --&#10;        BEGIN&#10;            --&#10;            l_tgt_pk_value :&#61; l_rec_omd_CURR.target_pk_value;&#10;            --&#10;            IF l_rec_omd_CURR.table_name IN (&#10;               &#39;MANAGEMENT_TIER&#39;,&#10;               &#39;OFFENDER_PRISONER&#39; )&#10;            THEN&#10;                l_tgt_pk_value :&#61;&#10;                    PKG_LstUtl.concat(&#10;                        l_rec_omd_PREV.target_offender_id,&#10;                        PKG_LstUtl.list_num_tail(l_tgt_pk_value, &#39;:&#39;, 1),&#10;                        p_delim&#61;&gt;&#39;:&#39; );&#10;            ELSIF l_rec_omd_CURR.table_name IN (&#10;                  &#39;MOST_RECENTLY_VIEWED_OFFENDERS&#39;,&#10;                  &#39;ORGANISATION_OFFENDER&#39;,&#10;                  &#39;SPG_SEARCH_OFFENDER&#39; )&#10;            THEN&#10;                l_tgt_pk_value :&#61;&#10;                    PKG_LstUtl.concat(&#10;                        PKG_LstUtl.list_num_head(l_tgt_pk_value, &#39;:&#39;, 1),&#10;                        l_rec_omd_PREV.target_offender_id,&#10;                        p_delim&#61;&gt;&#39;:&#39; );&#10;            END IF;&#10;            --&#10;            UPDATE offender_merge_details SET&#10;              --&#10;              target_pk_value &#61; l_tgt_pk_value,&#10;              target_fk_value &#61;&#10;                  CASE WHEN parent_table &#61; l_rec_omd_CURR.parent_table THEN&#10;                      l_rec_omd_CURR.target_fk_value&#10;                  ELSE&#10;                      target_fk_value&#10;                  END,&#10;              --&#10;              -- For records created (during the Merge) on the Target CRN&#10;              source_pk_value &#61;&#10;                  CASE WHEN source_pk_value &#61; &#39;-&#39; || target_pk_value THEN&#10;                      &#39;-&#39; || l_tgt_pk_value&#10;                  ELSE&#10;                      source_pk_value&#10;                  END,&#10;              source_fk_value &#61;&#10;                  CASE WHEN source_fk_value &#61; &#39;-&#39; || target_fk_value AND&#10;                            parent_table &#61; l_rec_omd_CURR.parent_table&#10;                  THEN&#10;                      &#39;-&#39; || l_rec_omd_CURR.target_fk_value&#10;                  ELSE&#10;                      source_fk_value&#10;                  END&#10;              --&#10;            WHERE offender_merge_details_id &#61; l_omd_id_PREV;&#10;            --&#10;        END do_upd_omd_PREV1;&#10;        --&#10;        PROCEDURE do_upd_omd_hist_PREV1&#10;        IS&#10;            --&#10;            l_table_pk_value_NEW OFFENDER_MERGE_DETAILS_HIST.table_pk_value%TYPE;&#10;            --&#10;            CURSOR csOMDH1 IS&#10;              SELECT *&#10;              FROM&#10;                offender_merge_details_hist&#10;              WHERE offender_merge_details_id &#61; l_omd_id_PREV&#10;                AND table_pk_value IS NOT NULL&#10;              ORDER BY&#10;                column_name,&#10;                table_pk_value;&#10;            --&#10;            l_rec_OMDH1 csOMDH1%ROWTYPE;&#10;            --&#10;        BEGIN&#10;            --&#10;            OPEN csOMDH1;&#10;            LOOP&#10;                FETCH csOMDH1 INTO l_rec_OMDH1;&#10;                EXIT WHEN csOMDH1%NOTFOUND;&#10;                --&#10;                -- DST-15317: The OMD record we are looking for may have already been deleted (via the Unmerge) -&#10;                -- we will therefore try it first to get its details from the local OMD cache&#10;                l_omd_key :&#61; get_omd_key(l_rec_omd_CURR.table_name, l_rec_omd_CURR.source_offender_id, l_rec_OMDH1.table_pk_value);&#10;                IF g_omd_cache_TAB.EXISTS(l_omd_key) THEN&#10;                    l_table_pk_value_NEW :&#61; g_omd_cache_TAB(l_omd_key);&#10;                ELSE&#10;                    l_table_pk_value_NEW :&#61;&#10;                        PKG_Lookups.funcgetTabRecord(&#10;                            p_data_fld    &#61;&gt; &#39;target_pk_value&#39;,&#10;                            p_default_val &#61;&gt; &#39;NOT FOUND&#39;,&#10;                            p_table       &#61;&gt; &#39;offender_merge_details&#39;,&#10;                            p_ref_col     &#61;&gt; &#39;table_name&#39;,&#10;                            p_ref_val     &#61;&gt;&#10;                                CASE&#10;                                    WHEN l_rec_OMDH1.column_name IN ( &#39;DUPL_NEXT_REVIEW_DATE&#39;, &#39;DUPL_DEREGISTERED&#39;, &#39;DUPL_REGISTRATION_NOTES&#39; ) THEN &#39;REGISTRATION&#39;&#10;                                    WHEN l_rec_OMDH1.column_name IN ( &#39;DUPL_DEREGISTRATION_CONTACT_ID&#39;, &#39;DUPL_REG_REVIEW_CONTACT_ID&#39; )          THEN &#39;CONTACT&#39;&#10;                                    WHEN l_rec_OMDH1.column_name IN ( &#39;DUPL_DEREGISTRATION_ID&#39; )                                                THEN &#39;DEREGISTRATION&#39;&#10;                                    WHEN l_rec_OMDH1.column_name IN ( &#39;DUPL_REGISTRATION_REVIEW_ID&#39;, &#39;DUPL_REG_REVIEW_DATE_DUE&#39; )               THEN &#39;REGISTRATION_REVIEW&#39;&#10;                                    --&#10;                                    ELSE l_rec_omd_CURR.table_name&#10;                                END,&#10;                            p_where       &#61;&gt; &#39;source_offender_id &#61; :p_src_offender_id AND source_pk_value &#61; :p_src_pk_value&#39;,&#10;                            p_bind_var1   &#61;&gt; l_rec_omd_CURR.source_offender_id,&#10;                            p_bind_var2   &#61;&gt; l_rec_OMDH1.table_pk_value );&#10;                END IF;&#10;                --&#10;                IF l_table_pk_value_NEW &lt;&gt; &#39;NOT FOUND&#39; THEN&#10;                    --&#10;                    UPDATE offender_merge_details_hist SET table_pk_value &#61; l_table_pk_value_NEW&#10;                    WHERE offender_merge_details_hist_id &#61; l_rec_OMDH1.offender_merge_details_hist_id;&#10;                    --&#10;                END IF;&#10;                --&#10;            END LOOP;&#10;            CLOSE csOMDH1;&#10;            --&#10;        END do_upd_omd_hist_PREV1;&#10;        --&#10;        PROCEDURE do_upd_omd_notes IS&#10;        BEGIN&#10;            --&#10;            UPDATE offender_merge_details SET&#10;              debug_notes &#61;&#10;                PKG_LstUtl.concat_CLOB(&#10;                    debug_notes || CHR(10),&#10;                    &#39;** WARNING: Consequtive merge ( A[&#39; || l_rec_omd_PREV.src_crn || &#39;] &#61;&gt; B[&#39; || l_rec_omd_PREV.tgt_crn || &#39;] &#61;&gt; [&#39; || l_rec_omd_CURR.tgt_crn || &#39;]) has been reversed from A&#61;&gt;B&#61;&gt;C to A&#61;&gt;B.&#39;,&#10;                    &#39;OMD record for &#39; || l_rec_omd_PREV.tgt_crn || &#39; CRN has been updated with the new PK/FK identifiers.&#39; || CHR(10),&#10;                    &#39;---* Original OMD details:&#39;,&#10;                    l_omd_details_PREV || CHR(10),&#10;                    &#39;---* Updated (post Unmerge) OMD details:&#39;,&#10;                    l_omd_details_CURR,&#10;                    CASE WHEN l_rec_omd_PREV.parent_table &lt;&gt; l_rec_omd_CURR.parent_table THEN&#10;                        CHR(10) ||&#10;                        &#39;WARNING: Previous OMD parent table [&#39; || l_rec_omd_PREV.parent_table || &#39;] IS NOT the same as the current one [&#39; || l_rec_omd_CURR.parent_table || &#39;] - &#39; ||&#10;                        &#39;OMD.target_fk_value remains unchanged.&#39;&#10;                    END,&#10;                    &#39;--********&#39;,&#10;                    --&#10;                    p_delim &#61;&gt; CHR(10) )&#10;            WHERE offender_merge_details_id &#61; l_rec_omd_PREV.offender_merge_details_id;&#10;            --&#10;        END do_upd_omd_notes;&#10;        --&#10;    BEGIN&#10;        --&#10;        do_fetch_omd_details;&#10;        --&#10;        IF l_omd_id_CURR &#61; -1 THEN&#10;            RETURN;&#10;        END IF;&#10;        --&#10;        -- Update OMD PREV&lt;&#61;CURR&#10;        l_omd_details_PREV :&#61; get_off_merge_details(l_rec_omd_PREV.offender_merge_details_id, p_incl_debug_notes&#61;&gt;&#39;N&#39;);&#10;        --&#10;        do_upd_omd_PREV1;&#10;        --&#10;        -- Update OMD History PREV&lt;&#61;CURR&#10;        do_upd_omd_hist_PREV1;&#10;        --&#10;        l_omd_details_CURR :&#61; get_off_merge_details(l_rec_omd_PREV.offender_merge_details_id, p_incl_debug_notes&#61;&gt;&#39;N&#39;, p_incl_omd_hist&#61;&gt;&#39;N&#39;);&#10;        --&#10;        do_upd_omd_notes;&#10;        --&#10;    END do_upd_omd_PREV;&#10;    --&#10;BEGIN&#10;    --&#10;    G_ROW_ID       :&#61; NULL;&#10;    G_TABLE_NAME   :&#61; NULL;&#10;    G_PARENT_TABLE :&#61; NULL;&#10;    --&#10;    l_table  :&#61; UPPER(TRIM(PKG_LstUtl.list_num_tail(p_table, &#39;.&#39;, 1)));&#10;    l_pk_fld :&#61; PKG_DynSQL.get_tab_pk_fld_lst(l_table, &#39; || &#39;&#39;:&#39;&#39; || &#39; || l_table || &#39;.&#39;, -1);&#10;    --&#10;--    info(&#10;--        &#39;PKG_MERGE_OFFENDER.do_check_src_rec_for_deletion: &#39; ||&#10;--            &#39;[parent_tab&#61;&#39;      || p_parent_table         || &#39;]&#39; ||&#10;--            &#39;[tab&#61;&#39;             || p_table                || &#39;]&#39; ||&#10;--            &#39;[off_id&#61;&#39;          || p_offender_id          || &#39;]&#39; ||&#10;--            &#39;[parent_row_id&#61;&#39;   || l_parent_row_id        || &#39;]&#39; ||&#10;--            &#39;[row_id&#61;&#39;          || p_row_id               || &#39;]&#39; ||&#10;--            &#39;[recursive_level&#61;&#39; || p_recursive_level      || &#39;]&#39; ||&#10;--            &#39;[merge_flag&#61;&#39;      || get_merge_running_flag || &#39;]&#39;,&#10;--        --&#10;--        p_trace_level &#61;&gt; 15,&#10;--        p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;    --&#10;    IF get_merge_running_flag &#61; &#39;Y&#39; THEN&#10;        -- Update previous OMD record (if there are consequtive merges)&#10;        do_upd_omd_PREV;&#10;    END IF;&#10;    --&#10;    IF l_table IN ( &#39;ADDITIONAL_IDENTIFIER&#39;, &#39;MANAGEMENT_TIER&#39; ) THEN&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    l_crn_lst :&#61;&#10;        PKG_Lookups.funcgetTabRecord(&#10;            p_data_fld    &#61;&gt; &#39;PKG_LstUtl.concat(O1.crn, O2.crn, p_delim&#61;&gt;&#39;&#39;-&gt;&#39;&#39;)&#39;,&#10;            p_table       &#61;&gt; l_table || &#39;&#10;  INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;&#39;&#39; || l_table || &#39;&#39;&#39;&#10;                                    AND OMD.target_pk_value &#61; TO_CHAR(&#39; || l_table || &#39;.&#39; || l_pk_fld || &#39;)&#10;    INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;    INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#39;,&#10;            --&#10;            p_ref_col     &#61;&gt; l_table || &#39;.rowid&#39;,&#10;            p_ref_val     &#61;&gt; p_row_id,&#10;            p_order_by    &#61;&gt; &#39;OMD.table_name&#39;,&#10;            p_all_records &#61;&gt; &#39;Y&#39;, p_delim &#61;&gt; CHR(10) );&#10;--        PKG_Lookups.funcgetTabRecord(&#10;--            p_data_fld    &#61;&gt; &#39;PKG_LstUtl.concat(O1.crn, O2.crn, p_delim&#61;&gt;&#39;&#39;-&gt;&#39;&#39;)&#39;,&#10;--            p_table       &#61;&gt;&#10;--            --&#10;--&#39;offender_merge_details OMD&#10;--  INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;--  INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;--  INNER JOIN &#39; || l_table || &#39; ON &#39; ||&#10;--             l_table || &#39;.&#39; || l_pk_fld || &#39; &#61; OMD.target_pk_value&#10;--    AND OMD.table_name &#61; &#39;&#39;&#39; || l_table || &#39;&#39;&#39;&#39;,&#10;--            --&#10;--            p_ref_col     &#61;&gt; l_table || &#39;.rowid&#39;,&#10;--            p_ref_val     &#61;&gt; p_row_id,&#10;--            --p_where       &#61;&gt; &#39;OMD.source_offender_id &#61; :p_src_offender_id&#39;,&#10;--            --p_bind_var1   &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;--            p_order_by    &#61;&gt; &#39;OMD.table_name&#39;,&#10;--            p_all_records &#61;&gt; &#39;Y&#39;, p_delim &#61;&gt; CHR(10) );&#10;    --&#10;    IF empty2null(l_crn_lst) IS NOT NULL THEN&#10;        --&#10;        info(&#10;            &#39;ERROR in PKG_MERGE_OFFENDER.do_check_src_rec_for_deletion &#39; ||&#10;            &#39;[src_crn&#61;&#39; || g_merge_ctx_rec.src_crn || &#39;]&#39; ||&#10;            &#39;[tgt_crn&#61;&#39; || g_merge_ctx_rec.tgt_crn || &#39;]&#39; ||&#10;            &#39;SQL: &#39;     || CHR(10) ||&#10;--&#10;&#39;SELECT&#10;  O1.crn AS src_crn,&#10;  O2.crn AS tgt_crn,&#10;  OMD.*&#10;FROM&#10;  &#39; || l_table || &#39;&#10;  INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;&#39;&#39; || l_table || &#39;&#39;&#39;&#10;                                    AND OMD.target_pk_value &#61; TO_CHAR(&#39; || l_table || &#39;.&#39; || l_pk_fld || &#39;)&#10;    INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;    INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;WHERE &#39; || l_table || &#39;.rowid &#61; &#39;&#39;&#39; || p_row_id || &#39;&#39;&#39;&#10;ORDER BY OMD.table_name&#39;,&#10;--&#10;            p_trace_level&#61;&gt;5 );&#10;        --&#10;        raise_application_error(-20001,&#10;            &#39;ERROR in PKG_MERGE_OFFENDER.do_check_src_rec_for_deletion &#39; ||&#10;            &#39;[src_crn&#61;&#39; || g_merge_ctx_rec.src_crn || &#39;]&#39; ||&#10;            &#39;[tgt_crn&#61;&#39; || g_merge_ctx_rec.tgt_crn || &#39;]&#39; ||&#10;            &#39;[tab&#61;&#39;     || p_table                 || &#39;]&#39; ||&#10;            &#39;[parent&#61;&#39;  || p_parent_table          || &#39;]&#39; ||&#10;            &#39;[row_id&#61;&#39;  || p_row_id                || &#39;]: &#39; || CHR(10) ||&#10;            &#39;this record cannot be deleted due to a matching record found in the OFFENDER_MERGE_DETAILS (using TARGET_PK_VALUE column)&#39; || CHR(10) ||&#10;            &#39;[OMD_crn&#61;&#39; || l_crn_lst               || &#39;]&#39; ||&#10;            --&#39;SQL: &#39;    || l_SQL&#10;            &#39;&#39; );&#10;        --&#10;    END IF;&#10;    --&#10;    --raise_application_error(-20001, &#39;TEST in PKG_MERGE_OFFENDER.do_check_src_rec_for_deletion&#39;);&#10;    --&#10;    RETURN;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    G_TABLE_NAME   :&#61; p_table;&#10;    G_PARENT_TABLE :&#61; p_parent_table;&#10;    G_ROW_ID       :&#61; p_row_id;&#10;    --&#10;    raise_application_error(-20001,&#10;        &#39;ERROR in PKG_MERGE_OFFENDER.do_check_src_rec_for_deletion &#39; ||&#10;        &#39;[src_crn&#61;&#39;    || g_merge_ctx_rec.src_crn || &#39;]&#39; ||&#10;        &#39;[tgt_crn&#61;&#39;    || g_merge_ctx_rec.tgt_crn || &#39;]&#39; ||&#10;        &#39;[OMD_crn&#61;&#39;    || l_crn_lst               || &#39;]&#39; ||&#10;        &#39;[tab&#61;&#39;        || p_table                 || &#39;]&#39; ||&#10;        &#39;[parent_tab&#61;&#39; || p_parent_table          || &#39;]&#39; ||&#10;        &#39;[row_id&#61;&#39;     || p_row_id                || &#39;]: &#39; || CHR(10) ||&#10;        SQLERRM        || CHR(10) ||&#10;        --&#39;SQL: &#39;    || l_SQL&#10;        &#39;&#39; );&#10;    --&#10;END do_check_src_rec_for_deletion;&#10;--&#10;PROCEDURE do_add_omd_hist_rec(&#10;    x_changes_log_TAB IN OUT g_ch_log_tab_TYP,&#10;    --&#10;    p_fld_name     VARCHAR2,&#10;    p_data_type    VARCHAR2,&#10;    p_old_value    VARCHAR2,&#10;    p_new_value    VARCHAR2,&#10;    p_tab_pk_value VARCHAR2 DEFAULT NULL )&#10;IS&#10;    --&#10;    l_rec g_ch_log_rec_TYP;&#10;    --&#10;BEGIN&#10;    --&#10;    l_rec.column_name :&#61; p_fld_name;&#10;    l_rec.data_type   :&#61; p_data_type;&#10;    l_rec.old_value   :&#61; SUBSTRB(p_old_value, 1, 100);&#10;    l_rec.new_value   :&#61; SUBSTRB(p_new_value, 1, 100);&#10;    l_rec.pk_value    :&#61; p_tab_pk_value;&#10;    --&#10;    x_changes_log_TAB.EXTEND;&#10;    x_changes_log_TAB(x_changes_log_TAB.COUNT) :&#61; l_rec;&#10;    --&#10;END do_add_omd_hist_rec;&#10;--&#10;&#10;--&#10;-- MMS Merge offender data update helpers&#10;--&#10;FUNCTION get_iaps_flag(p_offender_id NUMBER) RETURN SMALLINT&#10;IS&#10;    --&#10;    l_ret SMALLINT;&#10;    --&#10;BEGIN&#10;    --&#10;    WITH T0 AS (&#10;      SELECT &#39;EVENT&#39; AS table_name, ( CASE WHEN COUNT(1) &gt; 0 THEN 1 ELSE 0 END ) AS qty&#10;      FROM event T INNER JOIN iaps_event T1 ON T1.event_id &#61; T.event_id&#10;      WHERE T.offender_id &#61; p_offender_id&#10;      UNION ALL&#10;      SELECT &#39;RQMNT&#39; AS table_name, ( CASE WHEN COUNT(1) &gt; 0 THEN 1 ELSE 0 END ) AS qty&#10;      FROM rqmnt T INNER JOIN iaps_rqmnt T1 ON T1.rqmnt_id &#61; T.rqmnt_id&#10;      WHERE T.offender_id &#61; p_offender_id&#10;      UNION ALL&#10;      SELECT &#39;LIC_CONDITION&#39; AS table_name, ( CASE WHEN COUNT(1) &gt; 0 THEN 1 ELSE 0 END ) AS qty&#10;      FROM lic_condition T INNER JOIN iaps_lic_condition T1 ON T1.lic_condition_id &#61; T.lic_condition_id&#10;      WHERE T.offender_id &#61; p_offender_id&#10;      UNION ALL&#10;      SELECT &#39;CONTACT&#39; AS table_name, ( CASE WHEN COUNT(1) &gt; 0 THEN 1 ELSE 0 END ) AS qty&#10;      FROM contact T INNER JOIN iaps_contact T1 ON T1.contact_id &#61; T.contact_id&#10;      WHERE T.offender_id &#61; p_offender_id )&#10;    SELECT ( CASE WHEN SUM(qty) &gt; 0 THEN 1 ELSE 0 END )&#10;    INTO l_ret&#10;    FROM T0&#10;    WHERE qty &gt; 0;&#10;    --&#10;    RETURN l_ret;&#10;END get_iaps_flag;&#10;--&#10;PROCEDURE do_upd_iaps_offender(p_offender_id NUMBER, p_iaps_flag INTEGER)&#10;/*&#10;  CLEARED(&quot;Item of interest to IAPS has not been updated.&quot;, 0),&#10;  UPDATED(&quot;Item of interest to IAPS has been updated.&quot;    , 1),&#10;  DELETED(&quot;Item of interest to IAPS has been deleted.&quot;    , 2)&#10;*/&#10;IS&#10;BEGIN&#10;    MERGE INTO iaps_offender t0&#10;    USING (&#10;      SELECT p_iaps_flag AS IAPS_FLAG, p_offender_id AS OFFENDER_ID, NULL AS TRAINING_SESSION_ID FROM dual&#10;    ) t1&#10;    ON (t0.offender_id &#61; t1.offender_id)&#10;    WHEN MATCHED     THEN UPDATE SET t0.iaps_flag &#61; t1.iaps_flag&#10;    WHEN NOT MATCHED THEN INSERT (offender_id   , iaps_flag   , training_session_id   ) VALUES&#10;                                 (t1.offender_id, t1.iaps_flag, t1.training_session_id);&#10;END do_upd_iaps_offender;&#10;--&#10;PROCEDURE do_upd_offender_flags(p_offender_id NUMBER)&#10;IS&#10;    --&#10;    CURSOR cs IS&#10;      SELECT&#10;        PKG_Lookups.funcgetTabRecord(&#10;          p_table    &#61;&gt; &#39;registration R&#10;                           INNER JOIN r_register_type RT ON RT.register_type_id &#61; R.register_type_id&#10;                             INNER JOIN r_standard_reference_list RTF ON RTF.standard_reference_list_id &#61; RT.register_type_flag_id&#39;,&#10;          p_data_fld &#61;&gt; &#39;RT.colour&#39;,&#10;          p_ref_col  &#61;&gt; &#39;R.offender_id&#39;,&#10;          p_ref_val  &#61;&gt; p_offender_id,&#10;          p_where    &#61;&gt; &#39;R.soft_deleted &#61; 0 AND RT.colour IS NOT NULL AND RTF.code_value &#61; &#39;&#39;1&#39;&#39; AND&#10;                         NOT EXISTS( SELECT 1 FROM deregistration DR WHERE DR.registration_id &#61; R.registration_id AND DR.soft_deleted &#61; 0 )&#39;,&#10;          p_order_by &#61;&gt; &#39;DECODE(UPPER(RT.colour), &#39;&#39;WHITE&#39;&#39;, 1, &#39;&#39;GREEN&#39;&#39;, 2, &#39;&#39;AMBER&#39;&#39;, 3, &#39;&#39;RED&#39;&#39;, 4, 0) DESC&#39;&#10;        ) AS current_highest_risk_colour,&#10;        --&#10;        PKG_Lookups.funcgetTabRecord(&#10;          p_table       &#61;&gt; &#39;RESTRICTION&#39;,&#10;          p_ref_col     &#61;&gt; &#39;offender_id&#39;,&#10;          p_ref_val     &#61;&gt; p_offender_id,&#10;          p_data_fld    &#61;&gt; &#39;1&#39;,&#10;          p_default_val &#61;&gt; &#39;0&#39;,&#10;          p_where       &#61;&gt; &#39;restriction_end_date IS NULL&#39;,&#10;          p_order_by    &#61;&gt; &#39;created_datetime DESC, restriction_id DESC&#39;&#10;        ) AS current_restriction,&#10;        --&#10;        PKG_Lookups.funcgetTabRecord(&#10;          p_table       &#61;&gt; &#39;EXCLUSION&#39;,&#10;          p_ref_col     &#61;&gt; &#39;offender_id&#39;,&#10;          p_ref_val     &#61;&gt; p_offender_id,&#10;          p_data_fld    &#61;&gt; &#39;1&#39;,&#10;          p_default_val &#61;&gt; &#39;0&#39;,&#10;          p_where       &#61;&gt; &#39;exclusion_end_date IS NULL&#39;,&#10;          p_order_by    &#61;&gt; &#39;created_datetime DESC, exclusion_id DESC&#39;&#10;        ) AS current_exclusion,&#10;        --&#10;        PKG_Lookups.funcgetTabRecord(&#10;            p_data_fld  &#61;&gt; &#39;CUS.prisoner_number&#39;,&#10;            p_table     &#61;&gt; &#39;event E&#10;                              INNER JOIN disposal D ON D.event_id &#61; E.event_id&#10;                                INNER JOIN custody CUS ON CUS.disposal_id &#61; D.disposal_id&#39;,&#10;            --&#10;            p_ref_col   &#61;&gt; &#39;E.offender_id&#39;,&#10;            p_ref_val   &#61;&gt; offender_id,&#10;            p_where     &#61;&gt; &#39;TRIM(CUS.prisoner_number) IS NOT NULL AND E.soft_deleted &#61; 0 AND D.soft_deleted &#61; 0 AND CUS.soft_deleted &#61; 0&#39;,&#10;            p_order_by  &#61;&gt; &#39;D.disposal_date DESC, D.created_datetime DESC, D.last_updated_datetime DESC, D.disposal_id DESC&#39;&#10;        ) AS most_recent_prisoner_number&#10;        --&#10;      FROM offender&#10;      WHERE offender_id &#61; p_offender_id;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;BEGIN&#10;    --&#10;    g_label :&#61; &#39;510000&#39;;&#10;    --&#10;    OPEN cs;&#10;    FETCH cs INTO l_rec;&#10;    CLOSE cs;&#10;    --&#10;    g_label :&#61; &#39;700300&#39;;&#10;    --&#10;    UPDATE offender O SET&#10;      O.current_highest_risk_colour &#61; l_rec.current_highest_risk_colour,&#10;      O.current_restriction         &#61; l_rec.current_restriction,&#10;      O.current_exclusion           &#61; l_rec.current_exclusion,&#10;      --&#10;      O.most_recent_prisoner_number &#61; l_rec.most_recent_prisoner_number&#10;    WHERE O.offender_id &#61; p_offender_id;&#10;    --&#10;    g_label :&#61; &#39;749000&#39;;&#10;    --&#10;END do_upd_offender_flags;&#10;--&#10;PROCEDURE do_submit_mt_change(p_offender_id NUMBER)&#10;/*&#10;    If the DISABLE_TIER_CALCULATION_NOTIFICATION (ND_parameter) is set to 0 then we need to tell the new mgt tier service&#10;    that they need to calculate a new tier, this is done by creating a new MANAGEMENT_TIER_EVENT record.&#10;    The record should be created with the following values:&#10;    - Offender ID&#10;    - Tier change reason ID &#61; standard ref data with code value of MERGE and ref data master domain of TIER CHANGE REASON&#10;    - Contact_type_id &#61; contact type id where the code value is ETCH17&#10;    - IOMNominal &#61; Flag on offender record&#10;    - Safeguardingissue&#61; Flag on offender record&#10;    - VulnerabilityIssue&#61; Flag on offender record&#10;*/&#10;IS&#10;    --&#10;    LC_USER_ID   NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;    LC_DATE_TIME DATE   :&#61; SYSDATE;&#10;    --&#10;BEGIN&#10;    --&#10;    IF PKG_Lookups.funcgetNDParameterValue(&#39;DISABLE_TIER_CALCULATION_NOTIFICATION&#39;, &#39;0&#39;) &lt;&gt; &#39;0&#39; THEN&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    INSERT INTO management_tier_event(&#10;      management_tier_event_id,&#10;      offender_id,&#10;      tier_id,&#10;      tier_change_reason_id,&#10;      contact_type_id,&#10;      iom_nominal,&#10;      safeguarding_issue,&#10;      vulnerability_issue,&#10;      row_version,&#10;      created_by_user_id,&#10;      created_datetime,&#10;      last_updated_user_id,&#10;      last_updated_datetime&#10;    )&#10;    SELECT&#10;      management_tier_event_id_SEQ.nextval                           AS management_tier_event_id,&#10;      offender_id,&#10;      --&#10;      PKG_Lookups.funcgetStdRefListID(&#39;TIER&#39;, &#39;NA&#39;)                  AS tier_id,&#10;      PKG_Lookups.funcgetStdRefListID(&#39;TIER CHANGE REASON&#39;, &#39;MERGE&#39;) AS tier_change_reason_id,&#10;      PKG_Lookups.funcGetTabRecord_CACHED(&#10;          p_table    &#61;&gt; &#39;R_CONTACT_TYPE&#39;,&#10;          p_data_fld &#61;&gt; &#39;CONTACT_TYPE_ID&#39;,&#10;          p_ref_col  &#61;&gt; &#39;code&#39;,&#10;          p_ref_val  &#61;&gt; &#39;ETCH17&#39; )                                   AS contact_type_id,&#10;      --&#10;      iom_nominal,&#10;      safeguarding_issue,&#10;      vulnerability_issue,&#10;      --&#10;      0            AS row_version,&#10;      LC_USER_ID   AS created_by_user_id,&#10;      LC_DATE_TIME AS created_datetime,&#10;      LC_USER_ID   AS last_updated_user_id,&#10;      LC_DATE_TIME AS last_updated_datetime&#10;    FROM offender&#10;    WHERE offender_id &#61; p_offender_id;&#10;    --&#10;END do_submit_mt_change;&#10;--&#10;&#10;--&#10;-- OM/RO/OT/C Create subroutine (both Merge and Unmerge)&#10;--&#10;PROCEDURE do_create_target_OM(&#10;    p_action          VARCHAR2,&#10;    p_receiving_om_id NUMBER DEFAULT NULL,&#10;    p_owning_om_id    NUMBER DEFAULT NULL )&#10;IS&#10;    --&#10;    /* nDelius DataMaintenanceBean.mergeOffenders JAVA code:&#10;       --      // Create missing OMs for VPD&#10;       -- Merge (NDM-167):&#10;          When 2 Offenders have been Merged and the Offender Manager was chosen from the Source to be applied to the Target,&#10;          in addition to copying all OFFENDER_MANAGER records from Source to Target we need to:&#10;            1. Create a new OFFENDER_MANAGER record on the target, with allocation date &#61; sysdate, details to match the resultant Offender Manager on the Target.&#10;               If the resultant transfer was an external transfer then a completed transfer request and a transfer Accept record should be created on the target&#10;               with new transfer reason &#61; &lt; &gt; also dated sysdate, adding the SGCs for Transfer Request and Transfer Accept as normal.&#10;               If the resultant transfer was an Internal then the existing OM Allocation reason (&#61; &#39;MERGE&#39; I think) can be used, no transfer records are required.&#10;            2. If the Responsible Officer on the Target Offender was following the Offender Manager, prior to the Merge, then a new row for RESPONSIBLE_OFFICER&#10;               should be added as part of the Merge, also dated sysdate, which will match the new Offender Manager on Target. No change to POM.&#10;            3. If the Responsible Officer (RO) on the Target Offender was following the Prison Offender Manager (POM), prior to the Merge, then&#10;               even though the Offender Manager on the Target has changed, no change is required to RO or POM.&#10;    */&#10;    --&#10;    LC_USER_ID    NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;    LC_DATE_TIME  DATE   :&#61; SYSDATE;&#10;    LC_DATE       DATE   :&#61; TRUNC(LC_DATE_TIME);&#10;    --&#10;    l_om_current_id           NUMBER;&#10;    l_om_allocation_reason_id NUMBER :&#61; PKG_Lookups.funcgetStdRefListID(&#39;OM ALLOCATION REASON&#39;, p_action);&#10;    l_om_allocation_date      DATE :&#61; LC_DATE_TIME;&#10;    --&#10;    l_ro_current_id           NUMBER;&#10;    --&#10;    l_receiving_om_area_id    NUMBER;&#10;    l_receiving_om_team_id    NUMBER;&#10;    l_receiving_om_staff_id   NUMBER;&#10;    --&#10;    l_owning_om_area_id       NUMBER;&#10;    l_owning_om_team_id       NUMBER;&#10;    l_owning_om_staff_id      NUMBER;&#10;    --&#10;    l_changes_log_TAB g_ch_log_tab_TYP :&#61; g_ch_log_tab_TYP();&#10;    --&#10;    PROCEDURE do_init&#10;    IS&#10;        --&#10;        CURSOR cs IS&#10;          SELECT *&#10;          FROM offender_manager&#10;          WHERE offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;            AND active_flag &#61; 1;&#10;        --&#10;        l_rec cs%ROWTYPE;&#10;        --&#10;    BEGIN&#10;        --&#10;        IF p_action &#61; &#39;MERGE&#39; THEN&#10;            --&#10;            OPEN cs;&#10;            FETCH cs INTO l_rec;&#10;            CLOSE cs;&#10;            --&#10;            l_om_current_id :&#61; l_rec.offender_manager_id;&#10;            --&#10;            l_owning_om_area_id     :&#61; g_merge_ctx_rec.old_tgt_om_probation_area_id;&#10;            l_owning_om_team_id     :&#61; g_merge_ctx_rec.old_tgt_om_team_id;&#10;            l_owning_om_staff_id    :&#61; g_merge_ctx_rec.old_tgt_om_staff_id;&#10;            --&#10;            l_receiving_om_area_id  :&#61; g_merge_ctx_rec.src_om_probation_area_id;&#10;            l_receiving_om_team_id  :&#61; g_merge_ctx_rec.src_om_team_id;&#10;            l_receiving_om_staff_id :&#61; g_merge_ctx_rec.src_om_staff_id;&#10;            --&#10;            info(&#39;do_create_target_OM.do_init: &#39; || CHR(10) ||&#10;                &#39;[old_tgt_OM_id&#61;&#39;       || g_merge_ctx_rec.old_tgt_offender_manager_id  || &#39;]&#39; ||&#10;                &#39;[old_tgt_OM_area_id&#61;&#39;  || g_merge_ctx_rec.old_tgt_om_probation_area_id || &#39;]&#39; ||&#10;                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;,&#10;                           p_data_fld &#61;&gt; &#39;code&#39;,&#10;                           p_ref_col  &#61;&gt; &#39;probation_area_id&#39;,&#10;                           p_ref_val  &#61;&gt; g_merge_ctx_rec.old_tgt_om_probation_area_id ) || &#39;]&#39; ||&#10;                &#39;[old_tgt_OM_team_id&#61;&#39;  || g_merge_ctx_rec.old_tgt_om_team_id           || &#39;]&#39; ||&#10;                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;TEAM&#39;,&#10;                           p_data_fld &#61;&gt; &#39;code&#39;,&#10;                           p_ref_col  &#61;&gt; &#39;team_id&#39;,&#10;                           p_ref_val  &#61;&gt; g_merge_ctx_rec.old_tgt_om_team_id )           || &#39;]&#39; ||&#10;                &#39;[old_tgt_OM_staff_id&#61;&#39; || g_merge_ctx_rec.old_tgt_om_staff_id          || &#39;]&#39; || CHR(10) ||&#10;                --&#10;                &#39;[src_OM_id&#61;&#39;       || g_merge_ctx_rec.src_offender_manager_id          || &#39;]&#39; ||&#10;                &#39;[src_OM_area_id&#61;&#39;  || g_merge_ctx_rec.src_om_probation_area_id         || &#39;]&#39; ||&#10;                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;,&#10;                           p_data_fld &#61;&gt; &#39;code&#39;,&#10;                           p_ref_col  &#61;&gt; &#39;probation_area_id&#39;,&#10;                           p_ref_val  &#61;&gt; g_merge_ctx_rec.src_om_probation_area_id )     || &#39;]&#39; ||&#10;                &#39;[src_OM_team_id&#61;&#39;  || g_merge_ctx_rec.src_om_team_id                   || &#39;]&#39; ||&#10;                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;TEAM&#39;,&#10;                           p_data_fld &#61;&gt; &#39;code&#39;,&#10;                           p_ref_col  &#61;&gt; &#39;team_id&#39;,&#10;                           p_ref_val  &#61;&gt; g_merge_ctx_rec.src_om_team_id )               || &#39;]&#39; ||&#10;                &#39;[src_OM_staff_id&#61;&#39; || g_merge_ctx_rec.src_om_staff_id                  || &#39;]&#39; );&#10;            --&#10;        ELSE&#10;            --&#10;            l_om_current_id :&#61; p_receiving_om_id;&#10;            --&#10;            -- Receiving Trust/Team/Staff&#10;            SELECT&#10;              probation_area_id,&#10;              team_id,&#10;              allocation_staff_id&#10;            INTO&#10;              l_receiving_om_area_id,&#10;              l_receiving_om_team_id,&#10;              l_receiving_om_staff_id&#10;            FROM offender_manager&#10;            WHERE offender_manager_id &#61; p_receiving_om_id;&#10;            --&#10;            -- Owning Trust/Team/Staff&#10;            SELECT&#10;              probation_area_id,&#10;              team_id,&#10;              allocation_staff_id&#10;            INTO&#10;              l_owning_om_area_id,&#10;              l_owning_om_team_id,&#10;              l_owning_om_staff_id&#10;            FROM offender_manager&#10;            WHERE offender_manager_id &#61; p_owning_om_id;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_init;&#10;    --&#10;    PROCEDURE do_create_OM&#10;    IS&#10;        --&#10;        l_prev_om_end_date DATE;&#10;        --&#10;    BEGIN&#10;        --&#10;        IF l_om_current_id &gt; 0 THEN&#10;            --&#10;            l_prev_om_end_date :&#61; l_om_allocation_date;&#10;            --&#10;            IF p_action &#61; &#39;MERGE&#39; AND l_receiving_om_area_id &lt;&gt; l_owning_om_area_id THEN&#10;                -- NDM-176: make sure that the Previous OM is set to the Original Tgt OM Id&#10;                l_prev_om_end_date :&#61; l_prev_om_end_date + 1/24/60/60;&#10;                --&#10;                UPDATE offender_manager SET&#10;                  end_date              &#61; l_om_allocation_date,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_user_id  &#61; LC_USER_ID,&#10;                  last_updated_datetime &#61; LC_DATE_TIME&#10;                WHERE offender_manager_id &#61; g_merge_ctx_rec.old_tgt_offender_manager_id&#10;                  AND active_flag &#61; 0;&#10;                --&#10;            END IF;&#10;            --&#10;            UPDATE offender_manager SET&#10;              end_date              &#61; l_prev_om_end_date,&#10;              row_version           &#61; row_version + 1,&#10;              last_updated_user_id  &#61; LC_USER_ID,&#10;              last_updated_datetime &#61; LC_DATE_TIME&#10;            WHERE offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;              AND active_flag &#61; 1;&#10;            --&#10;            /*public void internalOffenderTransfer(OffenderManager offenderManager, OffenderManager currentOffenderManager,&#10;                ManagementTier managementTier, boolean transferOrderManagers) throws NDeliusException*/&#10;            g_merge_ctx_rec.new_tgt_offender_manager_id :&#61; offender_manager_id_SEQ.nextval;&#10;            --&#10;            INSERT INTO offender_manager (&#10;              offender_manager_id,&#10;              offender_id,&#10;              allocation_date,&#10;              --&#10;              probation_area_id,&#10;              team_id,&#10;              provider_team_id,&#10;              allocation_staff_id,&#10;              provider_employee_id,&#10;              --&#10;              allocation_reason_id,&#10;              offender_transfer_id,&#10;              --&#10;              soft_deleted,&#10;              partition_area_id,&#10;              --&#10;              created_by_user_id,&#10;              created_datetime,&#10;              last_updated_user_id,&#10;              last_updated_datetime&#10;            )&#10;            SELECT&#10;              g_merge_ctx_rec.new_tgt_offender_manager_id,&#10;              offender_id,&#10;              l_om_allocation_date,&#10;              --&#10;              probation_area_id,&#10;              team_id,&#10;              provider_team_id,&#10;              allocation_staff_id,&#10;              provider_employee_id,&#10;              --&#10;              l_om_allocation_reason_id,&#10;              NULL         AS offender_transfer_id,&#10;              --&#10;              0            AS soft_deleted,&#10;              0            AS partition_area_id,&#10;              --&#10;              LC_USER_ID   AS created_by_user_id,&#10;              LC_DATE_TIME AS created_datetime,&#10;              LC_USER_ID   AS last_updated_user_id,&#10;              LC_DATE_TIME AS last_updated_datetime&#10;            FROM offender_manager&#10;            WHERE offender_manager_id &#61; l_om_current_id;&#10;            --&#10;            IF p_action &#61; &#39;MERGE&#39; THEN&#10;                --&#10;                l_changes_log_TAB.DELETE;&#10;                --&#10;                do_add_omd_hist_rec(&#10;                    x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                    --&#10;                    p_fld_name     &#61;&gt; &#39;ACTIVE_FLAG&#39;,&#10;                    p_data_type    &#61;&gt; &#39;N&#39;,&#10;                    p_old_value    &#61;&gt; &#39;1&#39; ,&#10;                    p_new_value    &#61;&gt; &#39;0&#39;,&#10;                    p_tab_pk_value &#61;&gt; l_om_current_id );&#10;                --&#10;                do_add_omd_hist_rec(&#10;                    x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                    --&#10;                    p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                    p_data_type    &#61;&gt; &#39;D&#39;,&#10;                    p_old_value    &#61;&gt; NULL,&#10;                    p_new_value    &#61;&gt; PKG_Common.date_2_char(l_prev_om_end_date),&#10;                    p_tab_pk_value &#61;&gt; l_om_current_id );&#10;                --&#10;                -- Overload 1&#10;                do_ins_omd_rec(&#10;                    p_hierarchy_level  &#61;&gt; 1,&#10;                    p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                    p_table_name       &#61;&gt; &#39;OFFENDER_MANAGER&#39;,&#10;                    p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                    p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                    p_src_pk_value     &#61;&gt; NULL, -- New OM record created on the Target side&#10;                    p_tgt_pk_value     &#61;&gt; g_merge_ctx_rec.new_tgt_offender_manager_id,&#10;                    p_src_fk_value     &#61;&gt; NULL,&#10;                    p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                    p_debug_notes      &#61;&gt; &#39;NDM-167: created new OM when P_MOVE_PROVIDER&#61;Y&#39;,&#10;                    p_off_merge_det_id &#61;&gt; -1,&#10;                    x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;                --&#10;            END IF;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_create_OM;&#10;    --&#10;    PROCEDURE do_create_RO&#10;    IS&#10;        --&#10;        CURSOR csRO IS&#10;          SELECT *&#10;          FROM responsible_officer&#10;          WHERE offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;            AND end_date IS NULL&#10;            -- NDM-177: There should be only one Active RO per Offender&#10;            --AND offender_manager_id IS NOT NULL&#10;          ORDER BY&#10;            start_date DESC,&#10;            created_datetime DESC;&#10;        --&#10;        l_rec_RO csRO%ROWTYPE;&#10;        --&#10;        l_init_rec_flag BOOLEAN :&#61; FALSE;&#10;        --&#10;        l_prev_RO_follows_POM_flag BOOLEAN :&#61; FALSE;&#10;        --&#10;        PROCEDURE do_create_RO_contact&#10;        IS&#10;            --&#10;            l_ro_notes CLOB;&#10;            --&#10;            FUNCTION get_ro_contact_notes(p_responsible_officer_id NUMBER) RETURN VARCHAR2&#10;            IS&#10;                l_notes CLOB;&#10;            BEGIN&#10;                SELECT&#10;                    &#39;Responsible Officer Type: &#39; ||&#10;                        CASE&#10;                          WHEN OM.offender_manager_id IS NOT NULL THEN &#39;Offender Manager&#39;&#10;                          WHEN POM.prison_offender_manager_id IS NOT NULL THEN &#39;Prison Offender Manager&#39;&#10;                          ELSE &#39;Unknown&#39;&#10;                        END || CHR(10) ||&#10;                    --&#10;                    &#39;Responsible Officer: &#39; ||&#10;                        CASE&#10;                          WHEN OM.offender_manager_id IS NOT NULL THEN&#10;                              PKG_SPG_SUPPORT.get_responsible_staff(&#10;                                  OM.allocation_staff_id, OM.provider_employee_id) ||&#10;                                  &#39; (&#39; || T.description || &#39;, &#39; || PA.description || &#39;)&#39;&#10;                          WHEN POM.prison_offender_manager_id IS NOT NULL THEN&#10;                            PKG_SPG_SUPPORT.get_responsible_staff(&#10;                                  POM.allocation_staff_id, NULL) ||&#10;                                  &#39; (&#39; || T2.description || &#39;, &#39; || PA2.description || &#39;)&#39;&#10;                          ELSE &#39;Unknown&#39;&#10;                        END || CHR(10) ||&#10;                    --&#10;                    &#39;Start Date: &#39; || TO_CHAR(RO.start_date, &#39;dd/mm/yyyy hh24:mi:ss&#39;) || CHR(10) ||&#10;                    CASE WHEN RO.end_date IS NOT NULL THEN&#10;                      &#39;End Date: &#39; || TO_CHAR(RO.end_date, &#39;dd/mm/yyyy hh24:mi:ss&#39;) || CHR(10)&#10;                    END ||&#10;                    &#39;Allocation Reason: &#39; || PKG_Lookups.funcgetStdRefListCodeDesc(OM.allocation_reason_id)&#10;                INTO l_notes&#10;                FROM&#10;                  responsible_officer RO&#10;                    LEFT OUTER JOIN offender_manager OM ON OM.offender_manager_id &#61; RO.offender_manager_id&#10;                      LEFT OUTER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;                        LEFT OUTER JOIN probation_area PA ON PA.probation_area_id &#61; T.probation_area_id&#10;                      LEFT OUTER JOIN officer S ON S.trust_provider_flag &#61; OM.trust_provider_flag AND S.staff_employee_id &#61; OM.staff_employee_id&#10;                        LEFT OUTER JOIN staff S1 ON S1.staff_id &#61; S.staff_employee_id AND S.trust_provider_flag &#61; 0&#10;                    LEFT OUTER JOIN prison_offender_manager POM ON POM.prison_offender_manager_id &#61; RO.prison_offender_manager_id&#10;                      LEFT OUTER JOIN team T2 ON T2.team_id &#61; POM.allocation_team_id&#10;                        LEFT OUTER JOIN probation_area PA2 ON PA2.probation_area_id &#61; T2.probation_area_id&#10;                      LEFT OUTER JOIN staff S2 ON S2.staff_id &#61; POM.allocation_staff_id&#10;                WHERE responsible_officer_id &#61; p_responsible_officer_id;&#10;                --&#10;                RETURN l_notes;&#10;            END get_ro_contact_notes;&#10;            --&#10;        BEGIN&#10;            --&#10;            l_ro_notes :&#61;&#10;                &#39;New Details:&#39; || CHR(10) || get_ro_contact_notes(g_merge_ctx_rec.new_tgt_responsible_officer_id) ||&#10;                CASE WHEN l_ro_current_id IS NOT NULL THEN&#10;                    CHR(10) || CHR(10) || &#39;Previous Details:&#39; || CHR(10) || get_ro_contact_notes(l_ro_current_id)&#10;                END;&#10;            --&#10;            g_merge_ctx_rec.new_tgt_ro_contact_id :&#61; contact_id_SEQ.nextval;&#10;            --&#10;            INSERT INTO contact(&#10;              contact_id,&#10;              offender_id,&#10;              contact_date,&#10;              contact_type_id,&#10;              --&#10;              probation_area_id,&#10;              team_id,&#10;              provider_team_id,&#10;              staff_id,&#10;              provider_employee_id,&#10;              --&#10;              notes,&#10;              --&#10;              soft_deleted,&#10;              partition_area_id,&#10;              --&#10;              created_by_user_id,&#10;              created_datetime,&#10;              last_updated_user_id,&#10;              last_updated_datetime  )&#10;            SELECT&#10;              g_merge_ctx_rec.new_tgt_ro_contact_id,&#10;              OM.offender_id,&#10;              TRUNC(SYSDATE) AS contact_date,&#10;              ( SELECT contact_type_id FROM r_contact_type WHERE code &#61; &#39;ROC&#39; /*Responsible Officer Change*/ ) AS contact_type_id,&#10;              --&#10;              OM.probation_area_id,&#10;              OM.team_id,&#10;              OM.provider_team_id,&#10;              OM.allocation_staff_id,&#10;              OM.provider_employee_id,&#10;              --&#10;              l_ro_notes AS notes,&#10;              --&#10;              0          AS soft_deleted,&#10;              0          AS partition_area_id,&#10;              --&#10;              LC_USER_ID,&#10;              LC_DATE_TIME,&#10;              LC_USER_ID,&#10;              LC_DATE_TIME&#10;            FROM offender_manager OM&#10;            WHERE OM.offender_manager_id &#61; g_merge_ctx_rec.new_tgt_offender_manager_id;&#10;            --&#10;            IF p_action &#61; &#39;MERGE&#39; THEN&#10;                --&#10;                l_changes_log_TAB.DELETE;&#10;                -- Overload 1&#10;                do_ins_omd_rec(&#10;                    p_hierarchy_level  &#61;&gt; 1,&#10;                    p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                    p_table_name       &#61;&gt; &#39;CONTACT&#39;,&#10;                    p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                    p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                    p_src_pk_value     &#61;&gt; NULL,&#10;                    p_tgt_pk_value     &#61;&gt; g_merge_ctx_rec.new_tgt_ro_contact_id,&#10;                    p_src_fk_value     &#61;&gt; NULL,&#10;                    p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.new_tgt_offender_manager_id,&#10;                    p_debug_notes      &#61;&gt; &#39;NDM-167: created new RO CONTACT when P_MOVE_PROVIDER&#61;Y&#39;,&#10;                    p_off_merge_det_id &#61;&gt; -1,&#10;                    x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;                --&#10;            END IF;&#10;            --&#10;        END do_create_RO_contact;&#10;        --&#10;    BEGIN&#10;        --&#10;        -- NDM-177: Fetch ALL Active RO records for the Target Offender&#10;        OPEN csRO;&#10;        LOOP&#10;            FETCH csRO INTO l_rec_RO;&#10;            EXIT WHEN csRO%NOTFOUND;&#10;            --&#10;            IF NOT l_init_rec_flag THEN&#10;                --&#10;                g_merge_ctx_rec.old_tgt_responsible_officer_id :&#61; l_rec_RO.responsible_officer_id;&#10;                --&#10;                l_ro_current_id :&#61; g_merge_ctx_rec.old_tgt_responsible_officer_id;&#10;                l_init_rec_flag :&#61; TRUE;&#10;                --&#10;                IF l_rec_RO.prison_offender_manager_id IS NOT NULL THEN&#10;                    l_prev_RO_follows_POM_flag :&#61; TRUE;&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;            -- NDM-187: If the previous RO follows POM - then it should stay unchanged&#10;            IF ( l_init_rec_flag AND (NOT l_prev_RO_follows_POM_flag) ) OR&#10;               ( NOT l_init_rec_flag )&#10;            THEN&#10;                --&#10;                UPDATE responsible_officer SET&#10;                  end_date &#61; SYSDATE,&#10;                  --&#10;                  row_version          &#61; row_version + 1,&#10;                  last_updated_user_id  &#61; LC_USER_ID,&#10;                  last_updated_datetime &#61; LC_DATE_TIME&#10;                WHERE responsible_officer_id &#61; l_rec_RO.responsible_officer_id;&#10;                --&#10;            END IF;&#10;            --&#10;        END LOOP;&#10;        CLOSE csRO;&#10;        --&#10;        -- NDM-187: If the previous RO follows POM - then no new RO is needed&#10;        IF (NOT l_prev_RO_follows_POM_flag) THEN&#10;            --&#10;            g_merge_ctx_rec.new_tgt_responsible_officer_id :&#61; responsible_officer_id_SEQ.nextval;&#10;            --&#10;            INSERT INTO responsible_officer(&#10;              responsible_officer_id,&#10;              offender_id,&#10;              offender_manager_id,&#10;              prison_offender_manager_id,&#10;              start_date,&#10;              --&#10;              created_by_user_id,&#10;              created_datetime,&#10;              last_updated_user_id,&#10;              last_updated_datetime&#10;            ) VALUES (&#10;              g_merge_ctx_rec.new_tgt_responsible_officer_id,&#10;              g_merge_ctx_rec.tgt_offender_id,&#10;              g_merge_ctx_rec.new_tgt_offender_manager_id,&#10;              NULL,&#10;              LC_DATE_TIME,&#10;              --&#10;              LC_USER_ID,&#10;              LC_DATE_TIME,&#10;              LC_USER_ID,&#10;              LC_DATE_TIME );&#10;            --&#10;            IF l_ro_current_id &gt; 0 THEN&#10;                --&#10;                IF p_action &#61; &#39;MERGE&#39; THEN&#10;                    --&#10;                    l_changes_log_TAB.DELETE;&#10;                    --&#10;                    do_add_omd_hist_rec(&#10;                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                        --&#10;                        p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                        p_data_type    &#61;&gt; &#39;D&#39;,&#10;                        p_old_value    &#61;&gt; NULL,&#10;                        p_new_value    &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                        p_tab_pk_value &#61;&gt; l_ro_current_id );&#10;                    --&#10;                    -- Overload 1&#10;                    do_ins_omd_rec(&#10;                        p_hierarchy_level  &#61;&gt; 2,&#10;                        p_parent_table     &#61;&gt; &#39;OFFENDER_MANAGER&#39;,&#10;                        p_table_name       &#61;&gt; &#39;RESPONSIBLE_OFFICER&#39;,&#10;                        p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                        p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                        p_src_pk_value     &#61;&gt; NULL,&#10;                        p_tgt_pk_value     &#61;&gt; g_merge_ctx_rec.new_tgt_responsible_officer_id,&#10;                        p_src_fk_value     &#61;&gt; NULL,&#10;                        p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.new_tgt_offender_manager_id,&#10;                        p_debug_notes      &#61;&gt; &#39;NDM-167: created new OM level RO when P_MOVE_PROVIDER&#61;Y&#39;,&#10;                        p_off_merge_det_id &#61;&gt; -1,&#10;                        x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;                    --&#10;                END IF; --p_action &#61; &#39;MERGE&#39;&#10;                --&#10;                do_create_RO_contact;&#10;                --&#10;            END IF; --l_ro_current_id &gt; 0&#10;            --&#10;        END IF; --(NOT l_prev_RO_follows_POM_flag)&#10;        --&#10;    END do_create_RO;&#10;    --&#10;    PROCEDURE do_cr_transfer_contact(&#10;        x_contact_id        IN OUT NUMBER,&#10;        p_contact_type_code VARCHAR2,&#10;        p_notes             CLOB )&#10;    IS&#10;    BEGIN&#10;        --&#10;        x_contact_id :&#61; contact_id_SEQ.NEXTVAL;&#10;        --&#10;        INSERT INTO contact(&#10;          contact_id,&#10;          offender_id,&#10;          contact_type_id,&#10;          --&#10;          probation_area_id,&#10;          team_id,&#10;          staff_id,&#10;          --&#10;          contact_date,&#10;          contact_start_time,&#10;          --&#10;          notes,&#10;          --&#10;          visor_contact,&#10;          sensitive,&#10;          --&#10;          soft_deleted,&#10;          partition_area_id,&#10;          --&#10;          created_by_user_id,&#10;          created_datetime,&#10;          last_updated_user_id,&#10;          last_updated_datetime )&#10;        SELECT&#10;          x_contact_id                                          AS contact_id,&#10;          g_merge_ctx_rec.tgt_offender_id                       AS offender_id,&#10;          PKG_LOOKUPS.funcgetTabRecord_CACHED(&#10;              p_table    &#61;&gt; &#39;R_CONTACT_TYPE&#39;,&#10;              p_data_fld &#61;&gt; &#39;contact_type_id&#39;,&#10;              p_ref_col  &#61;&gt; &#39;CODE&#39;,&#10;              p_ref_val  &#61;&gt; p_contact_type_code&#10;          )                                                     AS contact_type_id,&#10;          --&#10;          NVL(NULLIF(l_receiving_om_area_id , -1), OM.probation_area_id)   AS probation_area_id,&#10;          NVL(NULLIF(l_receiving_om_team_id , -1), OM.team_id)             AS team_id,&#10;          NVL(NULLIF(l_receiving_om_staff_id, -1), OM.allocation_staff_id) AS staff_id,&#10;          --&#10;          LC_DATE                                                                            AS contact_date,&#10;          TO_DATE(&#39;19700101 &#39; || TO_CHAR(LC_DATE_TIME, &#39;HH24:MI:SS&#39;), &#39;YYYYMMDD HH24:MI:SS&#39;) AS contact_start_time,&#10;          --&#10;          p_notes,&#10;          --&#10;          &#39;N&#39;                                                   AS visor_contact,&#10;          &#39;N&#39;                                                   AS sentitive,&#10;          --&#10;          0                                                     AS soft_deleted,&#10;          0                                                     AS partition_area_id,&#10;          --&#10;          LC_USER_ID,&#10;          LC_DATE_TIME,&#10;          LC_USER_ID,&#10;          LC_DATE_TIME&#10;        FROM offender_manager OM&#10;        WHERE OM.offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;          AND OM.active_flag &#61; 1;&#10;        --&#10;        IF p_action &#61; &#39;MERGE&#39; THEN&#10;            --&#10;            l_changes_log_TAB.DELETE;&#10;            --&#10;            -- Overload 1&#10;            do_ins_omd_rec(&#10;                p_hierarchy_level  &#61;&gt; 1,&#10;                p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                p_table_name       &#61;&gt; &#39;CONTACT&#39;,&#10;                p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                p_src_pk_value     &#61;&gt; NULL,&#10;                p_tgt_pk_value     &#61;&gt; x_contact_id,&#10;                p_src_fk_value     &#61;&gt; NULL,&#10;                p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                p_debug_notes      &#61;&gt; &#39;NDM-167: created new OM Transfer CONTACT (when P_MOVE_PROVIDER&#61;Y and SRC_OM_AREA&lt;&gt;TGT_OM_AREA)&#39;,&#10;                p_off_merge_det_id &#61;&gt; -1,&#10;                x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;            --&#10;        END IF;&#10;        --&#10;    END do_cr_transfer_contact;&#10;    --&#10;    PROCEDURE do_create_om_transfer_contact&#10;    IS&#10;        --&#10;        l_notes CLOB;&#10;        --&#10;        FUNCTION get_omt_contact_notes(p_offender_manager_id NUMBER) RETURN VARCHAR2&#10;        IS&#10;            l_notes CLOB;&#10;        BEGIN&#10;            SELECT&#10;              &#39;From Trust: &#39;   || PA.description || CHR(10) ||&#10;              &#39;From Team: &#39;    || T.description || CHR(10) ||&#10;              &#39;From Officer: &#39; || PKG_SPG_SUPPORT.get_responsible_staff(OM.allocation_staff_id, OM.provider_employee_id)&#10;            INTO l_notes&#10;            FROM&#10;              offender_manager OM&#10;                INNER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;                  INNER JOIN probation_area PA ON PA.probation_area_id &#61; T.probation_area_id&#10;                INNER JOIN officer S ON S.trust_provider_flag &#61; OM.trust_provider_flag AND S.staff_employee_id &#61; OM.staff_employee_id&#10;                  LEFT OUTER JOIN staff S1 ON S1.staff_id &#61; S.staff_employee_id AND S.trust_provider_flag &#61; 0&#10;            WHERE offender_manager_id &#61; p_offender_manager_id;&#10;            --&#10;            RETURN l_notes;&#10;        END get_omt_contact_notes;&#10;        --&#10;    BEGIN&#10;        --&#10;        l_notes :&#61;&#10;            &#39;Transfer Reason: Internal Transfer&#39; || CHR(10) ||&#10;            &#39;Transfer Date: &#39; || TO_CHAR(l_om_allocation_date, &#39;dd/mm/yyyy&#39;) || CHR(10) ||&#10;            get_omt_contact_notes(l_om_current_id);&#10;        --&#10;        do_cr_transfer_contact(&#10;            x_contact_id        &#61;&gt; g_merge_ctx_rec.new_tgt_transfer_contact_id_0,&#10;            p_contact_type_code &#61;&gt; &#39;ETOM&#39; /*Offender Manager Transfer*/,&#10;            p_notes             &#61;&gt; l_notes );&#10;        --&#10;    END do_create_om_transfer_contact;&#10;    --&#10;    PROCEDURE do_create_offender_transfer&#10;    IS&#10;        --&#10;        PROCEDURE do_cr_offender_transfer&#10;        IS&#10;            --&#10;            PROCEDURE do_cr_master_transfer IS&#10;            BEGIN&#10;                --&#10;                g_merge_ctx_rec.new_tgt_master_transfer_id :&#61; master_transfer_id_SEQ.NEXTVAL;&#10;                --&#10;                INSERT INTO master_transfer(&#10;                  master_transfer_id,&#10;                  offender_id,&#10;                  transfer_date,&#10;                  transfer_user_id,&#10;                  transfer_status_id,&#10;                  transfer_status_date,&#10;                  target_provider_id,&#10;                  --&#10;                  created_by_user_id,&#10;                  created_datetime,&#10;                  last_updated_user_id,&#10;                  last_updated_datetime&#10;                 ) VALUES (&#10;                   g_merge_ctx_rec.new_tgt_master_transfer_id,&#10;                   g_merge_ctx_rec.tgt_offender_id,&#10;                   LC_DATE_TIME,&#10;                   LC_USER_ID,&#10;                   PKG_LOOKUPS.funcgetStdRefListID(&#39;TRANSFER STATUS&#39;,&#39;PN&#39;),&#10;                   LC_DATE_TIME,&#10;                   l_receiving_om_area_id,&#10;                   --&#10;                   LC_USER_ID,&#10;                   LC_DATE_TIME,&#10;                   LC_USER_ID,&#10;                   LC_DATE_TIME );&#10;                --&#10;                IF p_action &#61; &#39;MERGE&#39; THEN&#10;                    --&#10;                    l_changes_log_TAB.DELETE;&#10;                    -- Overload 1&#10;                    do_ins_omd_rec(&#10;                        p_hierarchy_level  &#61;&gt; 1,&#10;                        p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                        p_table_name       &#61;&gt; &#39;MASTER_TRANSFER&#39;,&#10;                        p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                        p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                        p_src_pk_value     &#61;&gt; NULL,&#10;                        p_tgt_pk_value     &#61;&gt; g_merge_ctx_rec.new_tgt_master_transfer_id,&#10;                        p_src_fk_value     &#61;&gt; NULL,&#10;                        p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                        p_debug_notes      &#61;&gt; &#39;NDM-167: created new OM MASTER_TRANSFER (when P_MOVE_PROVIDER&#61;Y and SRC_OM_AREA&lt;&gt;TGT_OM_AREA)&#39;,&#10;                        p_off_merge_det_id &#61;&gt; -1,&#10;                        x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_cr_master_transfer;&#10;            --&#10;        BEGIN&#10;            --&#10;            do_cr_master_transfer;&#10;            --&#10;            g_merge_ctx_rec.new_tgt_offender_transfer_id :&#61; offender_transfer_id_SEQ.NEXTVAL;&#10;            --&#10;            INSERT INTO offender_transfer(&#10;              /*01*/ offender_transfer_id,&#10;              /*02*/ offender_id,&#10;              /*03*/ master_transfer_id,&#10;              --&#10;              /*04*/ transfer_status_date,&#10;              /*05*/ request_date,&#10;              --&#10;              /*06*/ transfer_status_id,&#10;              /*07*/ accepted_decision_id,&#10;              /*08*/ rejection_reason_id,&#10;              /*09*/ withdrawal_reason_id,&#10;              --&#10;              /*10*/ transfer_reason_id,&#10;              /*11*/ allocation_reason_id,&#10;              --&#10;              /*12*/ notes,&#10;              --&#10;              /*13*/ origin_team_id,&#10;              /*14*/ origin_staff_id,&#10;              /*15*/ origin_provider_employee_id,&#10;              /*16*/ origin_provider_team_id,&#10;              --&#10;              /*17*/ receiving_team_id,&#10;              /*18*/ receiving_staff_id,&#10;              /*19*/ receiving_provider_team_id,&#10;              /*20*/ receiving_provider_employee_id,&#10;              --&#10;              /*21*/ soft_deleted,&#10;              /*22*/ partition_area_id,&#10;              --&#10;              /*23*/ created_by_user_id,&#10;              /*24*/ created_datetime,&#10;              /*25*/ last_updated_user_id,&#10;              /*26*/ last_updated_datetime&#10;            ) VALUES (&#10;              /*01*/ g_merge_ctx_rec.new_tgt_offender_transfer_id,&#10;              /*02*/ g_merge_ctx_rec.tgt_offender_id,&#10;              /*03*/ g_merge_ctx_rec.new_tgt_master_transfer_id,&#10;              --&#10;              /*04*/ LC_DATE_TIME,&#10;              /*05*/ LC_DATE_TIME,&#10;              --&#10;              /*06*/ PKG_LOOKUPS.funcgetStdRefListID(&#39;TRANSFER STATUS&#39;, &#39;PN&#39;),&#10;              /*07*/ PKG_LOOKUPS.funcgetStdRefListID(&#39;ACCEPTED DECISION&#39;, &#39;P&#39;),&#10;              /*08*/ NULL,&#10;              /*09*/ NULL,&#10;              --&#10;              /*10*/ PKG_LOOKUPS.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;R_TRANSFER_REASON&#39;, p_data_fld&#61;&gt;&#39;transfer_reason_id&#39;, p_ref_col&#61;&gt;&#39;CODE&#39;, p_ref_val&#61;&gt;&#39;OFFENDER&#39;),&#10;              /*11*/ PKG_LOOKUPS.funcgetStdRefListID(&#39;INTER AREA TRANSFER REASON&#39;, &#39;UOM&#39;),&#10;              --&#10;              /*12*/ NULL,&#10;              --&#10;              /*13*/ l_owning_om_team_id,&#10;              /*14*/ l_owning_om_staff_id,&#10;              /*15*/ NULL,&#10;              /*16*/ NULL,&#10;              --&#10;              /*17*/ l_receiving_om_team_id,&#10;              /*18*/ l_receiving_om_staff_id,&#10;              /*19*/ NULL,&#10;              /*20*/ NULL,&#10;              --&#10;              /*21*/ 0,&#10;              /*22*/ 0,&#10;              --&#10;              /*23*/ LC_USER_ID,&#10;              /*24*/ LC_DATE_TIME,&#10;              /*25*/ LC_USER_ID,&#10;              /*26*/ LC_DATE_TIME );&#10;            --&#10;            IF l_receiving_om_area_id &lt;&gt; l_owning_om_area_id THEN&#10;                -- NDM-176: Update the New Tgt OM with OMT_ID&#10;                UPDATE offender_manager SET&#10;                  offender_transfer_id  &#61; g_merge_ctx_rec.new_tgt_offender_transfer_id,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_user_id  &#61; LC_USER_ID,&#10;                  last_updated_datetime &#61; LC_DATE_TIME&#10;                WHERE offender_manager_id &#61; g_merge_ctx_rec.new_tgt_offender_manager_id&#10;                  AND active_flag &#61; 1;&#10;            END IF;&#10;            --&#10;            IF p_action &#61; &#39;MERGE&#39; THEN&#10;                --&#10;                l_changes_log_TAB.DELETE;&#10;                -- Overload 1&#10;                do_ins_omd_rec(&#10;                    p_hierarchy_level  &#61;&gt; 1,&#10;                    p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                    p_table_name       &#61;&gt; &#39;OFFENDER_TRANSFER&#39;,&#10;                    p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                    p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                    p_src_pk_value     &#61;&gt; NULL,&#10;                    p_tgt_pk_value     &#61;&gt; g_merge_ctx_rec.new_tgt_offender_transfer_id,&#10;                    p_src_fk_value     &#61;&gt; NULL,&#10;                    p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                    p_debug_notes      &#61;&gt; &#39;NDM-167: created new OM OFFENDER_TRANSFER (when P_MOVE_PROVIDER&#61;Y and SRC_OM_AREA&lt;&gt;TGT_OM_AREA)&#39;,&#10;                    p_off_merge_det_id &#61;&gt; -1,&#10;                    x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;                --&#10;            END IF;&#10;            --&#10;            --&#10;            -- Create CONTACT for Transfer (Requested)&#10;            do_cr_transfer_contact(&#10;                x_contact_id        &#61;&gt; g_merge_ctx_rec.new_tgt_transfer_contact_id_1,&#10;                p_contact_type_code &#61;&gt; &#39;ETTR&#39;,&#10;                p_notes             &#61;&gt;&#10;                    PKG_LstUtl.Concat(&#10;                        &#39;Transfer Status: &#39; || PKG_LOOKUPS.funcgetStdRefListCodeDesc(PKG_LOOKUPS.funcgetStdRefListID(&#39;TRANSFER STATUS&#39;, &#39;PN&#39;)),&#10;                        &#39;Transfer Reason: &#39; || PKG_LOOKUPS.funcgetStdRefListCodeDesc(PKG_LOOKUPS.funcgetStdRefListID(&#39;INTER AREA TRANSFER REASON&#39;, &#39;UOM&#39;)),&#10;                        &#39;Owning Trust: &#39;    || PKG_LOOKUPS.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;, p_data_fld&#61;&gt;&#39;description&#39;, p_ref_col&#61;&gt;&#39;PROBATION_AREA_ID&#39;, p_ref_val&#61;&gt;l_owning_om_area_id),&#10;                        &#39;Receiving Trust: &#39; || PKG_LOOKUPS.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;, p_data_fld&#61;&gt;&#39;description&#39;, p_ref_col&#61;&gt;&#39;PROBATION_AREA_ID&#39;, p_ref_val&#61;&gt;l_receiving_om_area_id),&#10;                        --&#10;                        p_delim&#61;&gt;CHR(10) ) );&#10;            --&#10;        END do_cr_offender_transfer;&#10;        --&#10;        PROCEDURE do_upd_offender_transfer&#10;        IS&#10;            --&#10;            PROCEDURE do_accept_transfer&#10;            IS&#10;                --&#10;                PROCEDURE do_upd_master_transfer IS&#10;                BEGIN&#10;                    --&#10;                    UPDATE master_transfer SET&#10;                      transfer_status_id     &#61; PKG_LOOKUPS.funcgetStdRefListID(&#39;TRANSFER STATUS&#39;, &#39;TCOM&#39;),&#10;                      transfer_status_date   &#61; LC_DATE_TIME,&#10;                       last_updated_user_id  &#61; LC_USER_ID,&#10;                       last_updated_datetime &#61; LC_DATE_TIME,&#10;                       row_version           &#61; row_version + 1&#10;                    WHERE master_transfer_id &#61; g_merge_ctx_rec.new_tgt_master_transfer_id;&#10;                    --&#10;                END do_upd_master_transfer;&#10;                --&#10;            BEGIN&#10;                --&#10;                -- Update MASTER_TRANSFER record - transfer completed&#10;                do_upd_master_transfer;&#10;                --&#10;                UPDATE offender_transfer SET&#10;                  transfer_status_id       &#61; PKG_LOOKUPS.funcgetStdRefListID(&#39;TRANSFER STATUS&#39;, &#39;TA&#39;),&#10;                  transfer_status_date    &#61; LC_DATE_TIME,&#10;                  accepted_decision_id    &#61; PKG_LOOKUPS.funcgetStdRefListID(&#39;ACCEPTED DECISION&#39;, &#39;A&#39;),&#10;                  --&#10;                  notes                   &#61;&#10;                      PKG_LstUtl.concat(&#10;                          &#39;Transfer Status: &#39; || PKG_LOOKUPS.funcgetStdRefListCodeDesc(PKG_LOOKUPS.funcgetStdRefListID(&#39;TRANSFER STATUS&#39;, &#39;TA&#39;)),&#10;                          &#39;Transfer Reason: &#39; || PKG_LOOKUPS.funcgetStdRefListCodeDesc(PKG_LOOKUPS.funcgetStdRefListID(&#39;INTER AREA TRANSFER REASON&#39;, &#39;UOM&#39;)),&#10;                          &#39;Owning Trust: &#39;    || PKG_LOOKUPS.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;, p_data_fld&#61;&gt;&#39;description&#39;, p_ref_col&#61;&gt;&#39;PROBATION_AREA_ID&#39;, p_ref_val&#61;&gt;l_owning_om_area_id),&#10;                          &#39;Receiving Trust: &#39; || PKG_LOOKUPS.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;, p_data_fld&#61;&gt;&#39;description&#39;, p_ref_col&#61;&gt;&#39;PROBATION_AREA_ID&#39;, p_ref_val&#61;&gt;l_receiving_om_area_id),&#10;                          --&#10;                          p_delim&#61;&gt;CHR(10) ),&#10;                  --&#10;                  last_updated_user_id     &#61; LC_USER_ID,&#10;                  last_updated_datetime    &#61; LC_DATE_TIME,&#10;                  row_version              &#61; row_version + 1&#10;               WHERE offender_transfer_id   &#61; g_merge_ctx_rec.new_tgt_offender_transfer_id;&#10;                --&#10;            END do_accept_transfer;&#10;            --&#10;        BEGIN&#10;            -- ACCEPT TRANSFER&#10;            do_accept_transfer;&#10;            -- Create CONTACT for Transfer (Accepted)&#10;            do_cr_transfer_contact(&#10;                x_contact_id        &#61;&gt; g_merge_ctx_rec.new_tgt_transfer_contact_id_2,&#10;                p_contact_type_code &#61;&gt; &#39;ETTA&#39;,&#10;                p_notes             &#61;&gt;&#10;                  PKG_LstUtl.Concat(&#10;                      &#39;Transfer Status: &#39;   || PKG_LOOKUPS.funcgetStdRefListCodeDesc(PKG_LOOKUPS.funcgetStdRefListID(&#39;TRANSFER STATUS&#39;, &#39;TA&#39;)),&#10;                      &#39;Transfer Reason: &#39;   || PKG_LOOKUPS.funcgetStdRefListCodeDesc(PKG_LOOKUPS.funcgetStdRefListID(&#39;INTER AREA TRANSFER REASON&#39;, &#39;UOM&#39;)),&#10;                      &#39;Accepted Decision: &#39; || PKG_LOOKUPS.funcgetStdRefListCodeDesc(PKG_LOOKUPS.funcgetStdRefListID(&#39;ACCEPTED DECISION&#39;, &#39;TYA&#39;)),&#10;                      &#39;Owning Trust: &#39;      || PKG_LOOKUPS.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;, p_data_fld&#61;&gt;&#39;description&#39;, p_ref_col&#61;&gt;&#39;PROBATION_AREA_ID&#39;, p_ref_val&#61;&gt;l_owning_om_area_id),&#10;                      &#39;Receiving Trust: &#39;   || PKG_LOOKUPS.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;, p_data_fld&#61;&gt;&#39;description&#39;, p_ref_col&#61;&gt;&#39;PROBATION_AREA_ID&#39;, p_ref_val&#61;&gt;l_receiving_om_area_id),&#10;                      --&#10;                      p_delim&#61;&gt;CHR(10) ) );&#10;            --&#10;        END do_upd_offender_transfer;&#10;        --&#10;    BEGIN&#10;        --&#10;        do_cr_offender_transfer;&#10;        do_upd_offender_transfer;&#10;        --&#10;    END do_create_offender_transfer;&#10;--&#10;BEGIN&#10;    --&#10;    g_label :&#61; &#39;450100&#39;;&#10;    --&#10;    do_init;&#10;    --&#10;    -- Create new OM&#10;    --&#10;    g_label :&#61; &#39;450300&#39;;&#10;    do_create_OM;&#10;    --&#10;    -- Create Internal Transfer&#10;    --&#10;    -- 1. Create new RO (if required)&#10;    --&#10;    g_label :&#61; &#39;450400&#39;;&#10;    do_create_RO;&#10;    --&#10;    -- Add Internal OM Transfer Contact&#10;    --&#10;    g_label :&#61; &#39;450600&#39;;&#10;    IF l_receiving_om_area_id &#61; l_owning_om_area_id THEN&#10;        do_create_om_transfer_contact;&#10;    ELSE&#10;        do_create_offender_transfer;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;499000&#39;;&#10;    --&#10;END do_create_target_OM;&#10;--&#10;&#10;--&#10;-- Update Responsible Officer and POM (add to OMD)&#10;--&#10;PROCEDURE do_upd_OMD_ro_and_pom(&#10;    p_tgt_offender_id NUMBER,&#10;    p_tgt_event_id    NUMBER,&#10;    p_ro_id           NUMBER DEFAULT NULL,&#10;    p_ro_contact_id   NUMBER DEFAULT NULL,&#10;    p_pom_id          NUMBER DEFAULT NULL,&#10;    p_old_ro_id       NUMBER DEFAULT NULL,&#10;    p_old_pom_id      NUMBER DEFAULT NULL,&#10;    p_debug_flag      VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_proc        VARCHAR2(100) :&#61; &#39;DO_UPD_OMD_RO_AND_POM&#39;;&#10;    --&#10;    LC_USER_ID    NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;    LC_DATE_TIME  DATE   :&#61; SYSDATE;&#10;    LC_DATE       DATE   :&#61; TRUNC(LC_DATE_TIME);&#10;    --&#10;    l_changes_log_TAB g_ch_log_tab_TYP :&#61; g_ch_log_tab_TYP();&#10;    --&#10;    CURSOR csOMD_E IS&#10;      SELECT&#10;        O.crn,&#10;        E.event_number,&#10;        OMD.*&#10;      FROM&#10;        offender O&#10;          INNER JOIN event E ON E.offender_id &#61; O.offender_id&#10;            LEFT OUTER JOIN offender_merge_details OMD ON OMD.target_pk_value &#61; TO_CHAR(E.event_id)&#10;                                                      AND OMD.table_name &#61; &#39;EVENT&#39;&#10;                                                      AND OMD.target_offender_id &#61; O.offender_id&#10;      WHERE 1&#61;1&#10;        AND O.offender_id &#61; p_tgt_offender_id&#10;        AND E.event_id &#61; p_tgt_event_id;&#10;    --&#10;    l_OMD_rec_E csOMD_E%ROWTYPE;&#10;    --&#10;    l_OMD_E_found_flag BOOLEAN;&#10;    --&#10;    PROCEDURE do_init IS&#10;    BEGIN&#10;        --&#10;        g_procedure_name :&#61; l_proc;&#10;        --&#10;        OPEN csOMD_E;&#10;        FETCH csOMD_E INTO l_OMD_rec_E;&#10;        IF csOMD_E%NOTFOUND THEN&#10;            CLOSE csOMD_E;&#10;            fatal(&#39;Failed to locate OFFENDER/EVENT record for [offender_id&#61;&#39; || p_tgt_offender_id || &#39;][event_id&#61;&#39; || p_tgt_event_id || &#39;]&#39;);&#10;        END IF;&#10;        CLOSE csOMD_E;&#10;        --&#10;        l_OMD_E_found_flag :&#61; (l_OMD_rec_E.offender_merge_details_id IS NOT NULL);&#10;        --&#10;        g_merge_ctx_rec.src_offender_id :&#61; l_OMD_rec_E.source_offender_id;&#10;        g_merge_ctx_rec.tgt_offender_id :&#61; l_OMD_rec_E.target_offender_id;&#10;        IF p_debug_flag IN (&#39;N&#39;, &#39;Y&#39;) THEN&#10;            set_merge_debug(p_debug_flag);&#10;        END IF;&#10;        --&#10;    END do_init;&#10;    --&#10;    FUNCTION get_tab_abbreviation(p_tab_name VARCHAR2) RETURN VARCHAR2 IS&#10;    BEGIN&#10;        RETURN&#10;            CASE&#10;                WHEN p_tab_name &#61; &#39;RESPONSIBLE_OFFICER&#39;     THEN &#39;RO&#39;&#10;                WHEN p_tab_name &#61; &#39;PRISON_OFFENDER_MANAGER&#39; THEN &#39;POM&#39;&#10;                ELSE p_tab_name&#10;            END;&#10;    END get_tab_abbreviation;&#10;    --&#10;    PROCEDURE do_debug IS&#10;    BEGIN&#10;        info(&#10;            &#39;Start &#39; ||&#10;            PKG_LstUtl.concat(&#10;                PKG_LstUtl.add_prefix(&#39;[off_id&#61;&#39;       , p_tgt_offender_id),&#10;                PKG_LstUtl.add_prefix(&#39;[crn&#61;&#39;          , l_OMD_rec_E.crn),&#10;                PKG_LstUtl.add_prefix(&#39;[event_id&#61;&#39;     , p_tgt_event_id),&#10;                PKG_LstUtl.add_prefix(&#39;[event_num&#61;&#39;    , l_OMD_rec_E.event_number),&#10;                PKG_LstUtl.add_prefix(&#39;[OMD_E_found&#61;&#39;  , PKG_Common.bool_2_char(l_OMD_E_found_flag)),&#10;                PKG_LstUtl.add_prefix(&#39;[OMD_E_id&#61;&#39;     , l_OMD_rec_E.offender_merge_details_id),&#10;                PKG_LstUtl.add_prefix(&#39;[pom_id&#61;&#39;       , p_pom_id),&#10;                PKG_LstUtl.add_prefix(&#39;[old_pom_id&#61;&#39;   , p_old_pom_id),&#10;                PKG_LstUtl.add_prefix(&#39;[ro_id&#61;&#39;        , p_ro_id),&#10;                PKG_LstUtl.add_prefix(&#39;[ro_contact_id&#61;&#39;, p_ro_contact_id),&#10;                PKG_LstUtl.add_prefix(&#39;[old_ro_id&#61;&#39;    , p_old_ro_id),&#10;                PKG_LstUtl.add_prefix(&#39;[debug&#61;&#39;        , p_debug_flag),&#10;                --&#10;                p_delim&#61;&gt;&#39;]&#39; ),&#10;            --&#10;            p_trace_level &#61;&gt; 15,&#10;            p_proc        &#61;&gt; l_proc );&#10;    END do_debug;&#10;    --&#10;    PROCEDURE do_print_OMDH(p_table VARCHAR2, p_old_id NUMBER)&#10;    IS&#10;        --&#10;        l_rec g_ch_log_rec_TYP;&#10;        --&#10;    BEGIN&#10;        --&#10;        FOR l_i IN 1..l_changes_log_TAB.COUNT LOOP&#10;            IF l_i &#61; 1 THEN&#10;                info(&#39;P_OLD_&#39; || get_tab_abbreviation(p_table) || &#39;_ID &#61;&gt; &#39; || p_old_id);&#10;            END IF;&#10;            l_rec :&#61; l_changes_log_TAB(l_i);&#10;            info(&#39;do_print_OMDH &#39; ||&#10;                &#39;[i&#61;&#39;   || l_i || &#39;]&#39; ||&#10;                &#39;[col&#61;&#39; || l_rec.column_name || &#39;]&#39; ||&#10;                &#39;[typ&#61;&#39; || l_rec.data_type   || &#39;]&#39; ||&#10;                &#39;[old&#61;&#39; || l_rec.old_value   || &#39;]&#39; ||&#10;                &#39;[new&#61;&#39; || l_rec.new_value   || &#39;]&#39; ||&#10;                &#39;[pk&#61;&#39;  || l_rec.pk_value    || &#39;]&#39; );&#10;        END LOOP;&#10;        --&#10;    END do_print_OMDH;&#10;    --&#10;    PROCEDURE do_upd_OMD&#10;    IS&#10;        --&#10;        PROCEDURE do_add_pom&#10;        IS&#10;            --&#10;            CURSOR csPOM(p_id NUMBER) IS&#10;              SELECT POM.*, OMD.offender_merge_details_id&#10;              FROM&#10;                prison_offender_manager POM&#10;                  LEFT OUTER JOIN offender_merge_details OMD ON OMD.target_pk_value &#61; POM.prison_offender_manager_id&#10;                                                            AND OMD.table_name &#61; &#39;PRISON_OFFENDER_MANAGER&#39;&#10;                                                            AND OMD.source_offender_id &#61; l_OMD_rec_E.source_offender_id&#10;                                                            AND OMD.target_offender_id &#61; l_OMD_rec_E.target_offender_id&#10;              WHERE POM.prison_offender_manager_id &#61; p_id;&#10;            --&#10;            l_rec_POM  csPOM%ROWTYPE;&#10;            l_rec_POM1 csPOM%ROWTYPE;&#10;            --&#10;            l_found_flag BOOLEAN;&#10;            --&#10;            PROCEDURE do_locate_pom(x_rec_POM IN OUT csPOM%ROWTYPE, p_id NUMBER, p_old_flag VARCHAR2 DEFAULT NULL) IS&#10;            BEGIN&#10;                --&#10;                OPEN csPOM(p_id);&#10;                FETCH csPOM INTO x_rec_POM;&#10;                l_found_flag :&#61; csPOM%FOUND;&#10;                CLOSE csPOM;&#10;                --&#10;                IF NOT l_found_flag THEN&#10;                    fatal(&#39;FATAL ERROR: failed to find the PRISON_OFFENDER_MANAGER record [&#39; ||&#10;                        PKG_LstUtl.concat(&#39;P&#39;, p_old_flag, &#39;POM_ID&#61;&#39;, p_delim&#61;&gt;&#39;_&#39;) || p_id || &#39;]&#39;,&#10;                        l_proc || &#39;.do_add_pom&#39; );&#10;                END IF;&#10;                --&#10;            END do_locate_pom;&#10;            --&#10;        BEGIN&#10;            --&#10;            do_locate_pom(l_rec_POM, p_pom_id);&#10;            --&#10;            IF p_old_pom_id &gt; 0 THEN&#10;                --&#10;                do_locate_pom(l_rec_POM1, p_old_pom_id, &#39;OLD&#39;);&#10;                --&#10;                IF l_rec_POM1.offender_merge_details_id IS NULL THEN&#10;                    -- Old Active POM record belongs to the Target Offender&#10;                    do_add_omd_hist_rec(&#10;                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                        --&#10;                        p_fld_name     &#61;&gt; &#39;ACTIVE_FLAG&#39;,&#10;                        p_data_type    &#61;&gt; &#39;N&#39;,&#10;                        p_old_value    &#61;&gt; &#39;1&#39;,&#10;                        p_new_value    &#61;&gt; &#39;0&#39;,&#10;                        p_tab_pk_value &#61;&gt; p_old_pom_id );&#10;                    --&#10;                    do_add_omd_hist_rec(&#10;                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                        --&#10;                        p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                        p_data_type    &#61;&gt; &#39;D&#39;,&#10;                        p_old_value    &#61;&gt; NULL,&#10;                        p_new_value    &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                        p_tab_pk_value &#61;&gt; p_old_pom_id );&#10;                    --&#10;                    IF p_debug_flag &#61; &#39;Y&#39; THEN&#10;                        do_print_OMDH(&#39;PRISON_OFFENDER_MANAGER&#39;, p_old_pom_id);&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;            -- Overload 1&#10;            do_ins_omd_rec(&#10;                p_hierarchy_level  &#61;&gt; 1,&#10;                p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                p_table_name       &#61;&gt; &#39;PRISON_OFFENDER_MANAGER&#39;,&#10;                p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                p_src_pk_value     &#61;&gt; NULL, --&#39;-2&#39;,&#10;                p_tgt_pk_value     &#61;&gt; p_pom_id,&#10;                p_src_fk_value     &#61;&gt; NULL,&#10;                p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                p_debug_notes      &#61;&gt; &#39;NDM-161: created new POM OMD record&#39;,&#10;                p_off_merge_det_id &#61;&gt; -1,&#10;                x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;            --&#10;            l_changes_log_TAB.DELETE;&#10;            --&#10;            -- Delete old OMDH Active Source POM record&#10;            DELETE FROM offender_merge_details_hist&#10;            WHERE table_pk_value IS NULL&#10;              AND ( ( column_name &#61; &#39;END_DATE&#39; AND old_value IS NULL AND new_value IS NOT NULL ) OR&#10;                    ( column_name &#61; &#39;ACTIVE_FLAG&#39; AND old_value &#61; &#39;1&#39; AND new_value &#61; &#39;0&#39; )&#10;                  )&#10;              AND offender_merge_details_id IN (&#10;                  SELECT offender_merge_details_id&#10;                  FROM offender_merge_details&#10;                  WHERE table_name &#61; &#39;PRISON_OFFENDER_MANAGER&#39;&#10;                    AND source_offender_id &#61; g_merge_ctx_rec.src_offender_id&#10;                    AND target_offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;                    AND target_pk_value &lt;&gt; p_pom_id );&#10;            --&#10;        END do_add_pom;&#10;        --&#10;        PROCEDURE do_add_ro&#10;        IS&#10;            --&#10;            CURSOR csRO(p_id NUMBER) IS&#10;              SELECT RO.*, OMD.offender_merge_details_id&#10;              FROM&#10;                responsible_officer RO&#10;                  LEFT OUTER JOIN offender_merge_details OMD ON OMD.target_pk_value &#61; RO.responsible_officer_id&#10;                                              AND OMD.table_name &#61; &#39;RESPONSIBLE_OFFICER&#39;&#10;                                              AND OMD.source_offender_id &#61; l_OMD_rec_E.source_offender_id&#10;                                              AND OMD.target_offender_id &#61; l_OMD_rec_E.target_offender_id&#10;              WHERE RO.responsible_officer_id &#61; p_id;&#10;            --&#10;            l_rec_RO  csRO%ROWTYPE;&#10;            l_rec_RO1 csRO%ROWTYPE;&#10;            --&#10;            CURSOR csC IS&#10;              SELECT *&#10;              FROM contact&#10;              WHERE contact_id &#61; p_ro_contact_id;&#10;            l_rec_C csC%ROWTYPE;&#10;            --&#10;            l_found_flag BOOLEAN;&#10;            --&#10;            PROCEDURE do_locate_ro(x_rec_RO IN OUT csRO%ROWTYPE, p_id NUMBER, p_old_flag VARCHAR2 DEFAULT NULL) IS&#10;            BEGIN&#10;                --&#10;                OPEN csRO(p_id);&#10;                FETCH csRO INTO x_rec_RO;&#10;                l_found_flag :&#61; csRO%FOUND;&#10;                CLOSE csRO;&#10;                --&#10;                IF NOT l_found_flag THEN&#10;                    fatal(&#39;FATAL ERROR: failed to find the RESPONSIBLE_OFFICER record [&#39; ||&#10;                        PKG_LstUtl.concat(&#39;P&#39;, p_old_flag, &#39;RO_ID&#61;&#39;, p_delim&#61;&gt;&#39;_&#39;) || p_id || &#39;]&#39;,&#10;                        l_proc || &#39;.do_add_ro&#39; );&#10;                END IF;&#10;                --&#10;            END do_locate_ro;&#10;            --&#10;            PROCEDURE do_locate_ro_contact IS&#10;            BEGIN&#10;                --&#10;                OPEN csC;&#10;                FETCH csC INTO l_rec_C;&#10;                l_found_flag :&#61; csC%FOUND;&#10;                CLOSE csC;&#10;                --&#10;                IF NOT l_found_flag THEN&#10;                    fatal(&#39;FATAL ERROR: failed to find the RO CONTACT record [P_RO_CONTACT_ID&#61;&#39; || p_ro_contact_id || &#39;]&#39;, l_proc || &#39;.do_add_ro&#39;);&#10;                END IF;&#10;                --&#10;            END do_locate_ro_contact;&#10;            --&#10;        BEGIN&#10;            --&#10;            do_locate_ro(l_rec_RO, p_ro_id);&#10;            --&#10;            IF p_old_ro_id &gt; 0 THEN&#10;                --&#10;                do_locate_ro(l_rec_RO1, p_old_ro_id, &#39;OLD&#39;);&#10;                --&#10;                IF l_rec_RO1.offender_merge_details_id IS NULL THEN&#10;                    -- Old Active RO record belongs to the Target Offender&#10;                    do_add_omd_hist_rec(&#10;                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                        --&#10;                        p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                        p_data_type    &#61;&gt; &#39;D&#39;,&#10;                        p_old_value    &#61;&gt; NULL,&#10;                        p_new_value    &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                        p_tab_pk_value &#61;&gt; p_old_ro_id );&#10;                    --&#10;                    IF p_debug_flag &#61; &#39;Y&#39; THEN&#10;                        do_print_OMDH(&#39;RESPONSIBLE_OFFICER&#39;, p_old_ro_id);&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;            -- Overload 1&#10;            do_ins_omd_rec(&#10;                p_hierarchy_level  &#61;&gt; 2,&#10;                p_parent_table     &#61;&gt; CASE WHEN l_rec_RO.prison_offender_manager_id IS NOT NULL THEN &#39;PRISON_OFFENDER_MANAGER&#39; ELSE &#39;OFFENDER_MANAGER&#39; END,&#10;                p_table_name       &#61;&gt; &#39;RESPONSIBLE_OFFICER&#39;,&#10;                p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                p_src_pk_value     &#61;&gt; NULL, --&#39;-2&#39;,&#10;                p_tgt_pk_value     &#61;&gt; p_ro_id,&#10;                p_src_fk_value     &#61;&gt; NULL,&#10;                p_tgt_fk_value     &#61;&gt; NVL(l_rec_RO.prison_offender_manager_id, l_rec_RO.offender_manager_id),&#10;                p_debug_notes      &#61;&gt; &#39;NDM-161: created new RO OMD record&#39;,&#10;                p_off_merge_det_id &#61;&gt; -1,&#10;                x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;            --&#10;            l_changes_log_TAB.DELETE;&#10;            --&#10;            -- Delete old OMDH Active Source RO record&#10;            DELETE FROM offender_merge_details_hist&#10;            WHERE table_pk_value IS NULL&#10;              AND ( column_name &#61; &#39;END_DATE&#39; AND old_value IS NULL AND new_value IS NOT NULL )&#10;              AND offender_merge_details_id IN (&#10;                  SELECT offender_merge_details_id&#10;                  FROM offender_merge_details&#10;                  WHERE table_name &#61; &#39;RESPONSIBLE_OFFICER&#39;&#10;                    AND source_offender_id &#61; g_merge_ctx_rec.src_offender_id&#10;                    AND target_offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;                    AND target_pk_value &lt;&gt; p_ro_id );&#10;            --&#10;            IF p_ro_contact_id &gt; 0 THEN&#10;                --&#10;                do_locate_ro_contact;&#10;                --&#10;                -- Overload 1&#10;                do_ins_omd_rec(&#10;                    p_hierarchy_level  &#61;&gt; 1,&#10;                    p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                    p_table_name       &#61;&gt; &#39;CONTACT&#39;,&#10;                    p_src_offender_id  &#61;&gt; g_merge_ctx_rec.src_offender_id,&#10;                    p_tgt_offender_id  &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                    p_src_pk_value     &#61;&gt; NULL, --&#39;-2&#39;,&#10;                    p_tgt_pk_value     &#61;&gt; p_ro_contact_id,&#10;                    p_src_fk_value     &#61;&gt; NULL,&#10;                    p_tgt_fk_value     &#61;&gt; g_merge_ctx_rec.tgt_offender_id,&#10;                    p_debug_notes      &#61;&gt; &#39;NDM-161: created new RO CONTACT OMD record&#39;,&#10;                    p_off_merge_det_id &#61;&gt; -1,&#10;                    x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;                --&#10;            END IF;&#10;            --&#10;        END do_add_ro;&#10;        --&#10;    BEGIN&#10;        --&#10;        IF p_pom_id &gt; 0 THEN&#10;            --&#10;            do_add_pom;&#10;            --&#10;            info(&#10;                &#39;POM OMD/OMDH records added for &#39; ||&#10;                &#39;[tgt_off_id&#61;&#39;    || p_tgt_offender_id         || &#39;]&#39; ||&#10;                &#39;[tgt_crn&#61;&#39;       || l_OMD_rec_E.crn           || &#39;]&#39; ||&#10;                &#39;[tgt_event_id&#61;&#39;  || p_tgt_event_id            || &#39;]&#39; ||&#10;                &#39;[tgt_event_num&#61;&#39; || l_OMD_rec_E.event_number  || &#39;]&#39; ||&#10;                --&#10;                &#39;[pom_id&#61;&#39;        || p_pom_id                  || &#39;]&#39;,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; l_proc );&#10;            --&#10;        END IF;&#10;        --&#10;        IF p_ro_id &gt; 0 THEN&#10;            --&#10;            do_add_ro;&#10;            --&#10;            info(&#10;                &#39;RO OMD/OMDH records added for &#39; ||&#10;                &#39;[tgt_off_id&#61;&#39;    || p_tgt_offender_id         || &#39;]&#39; ||&#10;                &#39;[tgt_crn&#61;&#39;       || l_OMD_rec_E.crn           || &#39;]&#39; ||&#10;                &#39;[tgt_event_id&#61;&#39;  || p_tgt_event_id            || &#39;]&#39; ||&#10;                &#39;[tgt_event_num&#61;&#39; || l_OMD_rec_E.event_number  || &#39;]&#39; ||&#10;                --&#10;                &#39;[ro_id&#61;&#39;         || p_ro_id                   || &#39;]&#39;,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; l_proc );&#10;            --&#10;        END IF;&#10;        --&#10;    END do_upd_OMD;&#10;    --&#10;    PROCEDURE do_upd_OMDH_for_old_records&#10;    IS&#10;        --&#10;        CURSOR cs1 IS&#10;          WITH T AS (&#10;            SELECT offender_merge_details_id, table_name, target_pk_value&#10;            FROM offender_merge_details OMD&#10;            WHERE OMD.table_name &#61; &#39;RESPONSIBLE_OFFICER&#39;&#10;              AND OMD.target_pk_value &#61; TO_CHAR(p_old_ro_id)&#10;              AND OMD.target_offender_id &#61; p_tgt_offender_id&#10;            --&#10;            UNION&#10;            --&#10;            SELECT offender_merge_details_id, table_name, target_pk_value&#10;            FROM offender_merge_details OMD&#10;            WHERE OMD.table_name &#61; &#39;PRISON_OFFENDER_MANAGER&#39;&#10;              AND OMD.target_pk_value &#61; TO_CHAR(p_old_pom_id)&#10;              AND OMD.target_offender_id &#61; p_tgt_offender_id )&#10;          --&#10;          SELECT *&#10;          FROM T&#10;          WHERE 1&#61;1&#10;            AND NOT EXISTS(&#10;                SELECT 1&#10;                FROM offender_merge_details_hist&#10;                WHERE offender_merge_details_id &#61; T.offender_merge_details_id&#10;                  AND column_name &#61; &#39;END_DATE&#39;&#10;                  AND old_value IS NULL&#10;                  AND new_value IS NOT NULL&#10;                  AND table_pk_value IS NULL );&#10;        --&#10;        l_rec_1 cs1%ROWTYPE;&#10;        --&#10;    BEGIN&#10;        --&#10;        -- For all Old Active POM/RO records that belong to the Source Offender:&#10;        --   add OMDH record so their Active status can be recovered when un-Merged&#10;        --&#10;        OPEN cs1;&#10;        LOOP&#10;            FETCH cs1 INTO l_rec_1;&#10;            EXIT WHEN cs1%NOTFOUND;&#10;            --&#10;            l_changes_log_TAB.DELETE;&#10;            --&#10;            IF l_rec_1.table_name &#61; &#39;PRISON_OFFENDER_MANAGER&#39; THEN&#10;                do_add_omd_hist_rec(&#10;                    x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                    --&#10;                    p_fld_name     &#61;&gt; &#39;ACTIVE_FLAG&#39;,&#10;                    p_data_type    &#61;&gt; &#39;N&#39;,&#10;                    p_old_value    &#61;&gt; &#39;1&#39;,&#10;                    p_new_value    &#61;&gt; &#39;0&#39;,&#10;                    p_tab_pk_value &#61;&gt; p_old_pom_id );&#10;            END IF;&#10;            --&#10;            do_add_omd_hist_rec(&#10;                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                --&#10;                p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                p_data_type    &#61;&gt; &#39;D&#39;,&#10;                p_old_value    &#61;&gt; NULL,&#10;                p_new_value    &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                p_tab_pk_value &#61;&gt; p_old_pom_id );&#10;            --&#10;            IF p_debug_flag &#61; &#39;Y&#39; THEN&#10;                do_print_OMDH(l_rec_1.table_name, l_rec_1.target_pk_value);&#10;            END IF;&#10;            --&#10;            -- Overload 1a&#10;            do_ins_omd_rec(&#10;                p_off_merge_det_id &#61;&gt; l_rec_1.offender_merge_details_id,&#10;                p_debug_notes      &#61;&gt; &#39;NDM-181: Added new OMDH END_DATE for &#39; || get_tab_abbreviation(l_rec_1.table_name) || &#39; (after new Target Event has been updated)&#39;,&#10;                --&#10;                x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;            --&#10;            info(&#10;                &#39;do_upd_OMDH_for_old_records &#39; ||&#10;                &#39;[tgt_off_id&#61;&#39;    || p_tgt_offender_id         || &#39;]&#39; ||&#10;                &#39;[tgt_crn&#61;&#39;       || l_OMD_rec_E.crn           || &#39;]&#39; ||&#10;                &#39;[tgt_event_id&#61;&#39;  || p_tgt_event_id            || &#39;]&#39; ||&#10;                &#39;[tgt_event_num&#61;&#39; || l_OMD_rec_E.event_number  || &#39;]&#39; ||&#10;                --&#10;                &#39;[OMD_old_&#39; || get_tab_abbreviation(l_rec_1.table_name) || &#39;_id&#61;&#39;   || l_rec_1.offender_merge_details_id || &#39;]&#39;,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; l_proc );&#10;            --&#10;        END LOOP;&#10;        CLOSE cs1;&#10;        --&#10;    END do_upd_OMDH_for_old_records;&#10;    --&#10;BEGIN&#10;    --&#10;    do_init;&#10;    --&#10;    IF l_OMD_E_found_flag THEN&#10;        --&#10;        do_debug;&#10;        --&#10;        -- The Event being updated belongs to the Source Offender - update OMD/OMDH to include new POM/RO&#10;        do_upd_OMD;&#10;        --&#10;    ELSIF p_old_pom_id IS NOT NULL OR p_old_ro_id IS NOT NULL THEN&#10;        --&#10;        do_debug;&#10;        --&#10;        -- The Event being updated belongs to the Target Offender - update OMDH for previous POM/RO&#10;        do_upd_OMDH_for_old_records;&#10;        --&#10;    END IF;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    fatal(get_dq_message(SQLERRM), l_proc);&#10;    --&#10;END do_upd_OMD_ro_and_pom;&#10;&#10;--&#10;-- MMS Merge&#10;--&#10;PROCEDURE off_merge_curr_rec(&#10;    p_parent_table    VARCHAR2,&#10;    p_table           VARCHAR2,&#10;    p_offender_id     NUMBER,&#10;    p_parent_row_id   ROWID,&#10;    p_row_id          ROWID,&#10;    p_recursive_level NUMBER )&#10;IS&#10;    --&#10;    l_proc VARCHAR2(32) :&#61; &#39;OFF_MERGE_CURR_REC&#39;;&#10;    --&#10;    LC_USER_ID          NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;    LC_DATE_TIME        DATE   :&#61; SYSDATE;&#10;    LC_DATE             DATE   :&#61; TRUNC(LC_DATE_TIME);&#10;    --&#10;    l_src_offender_id   NUMBER;&#10;    l_tgt_offender_id   NUMBER;&#10;    --&#10;    l_src_pk_key_val    VARCHAR2(4000);&#10;    l_tgt_pk_key_val    VARCHAR2(4000);&#10;    l_pk_composite_flag VARCHAR2(1) :&#61; &#39;N&#39;;&#10;    --&#10;    l_src_fk_key_val    VARCHAR2(4000);&#10;    l_tgt_fk_key_val    VARCHAR2(4000);&#10;    --&#10;    l_already_processed VARCHAR2(1) :&#61; &#39;N&#39;;&#10;    l_off_merge_det_id  NUMBER      :&#61; -1;&#10;    --&#10;    l_SQL               CLOB;&#10;    --&#10;    l_cnt               INTEGER;&#10;    --&#10;    l_tgt_fld_list_1    VARCHAR2(32000);&#10;    l_tgt_fld_list_2    VARCHAR2(32000);&#10;    --&#10;    l_changes_log_TAB   g_ch_log_tab_TYP :&#61; g_ch_log_tab_TYP();&#10;    --&#10;    PROCEDURE do_check_src_record&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_CHECK_SRC_RECORD&#39;;&#10;        --&#10;        CURSOR csO IS&#10;          SELECT&#10;            O_src.offender_id AS src_offender_id,&#10;            O_src.crn         AS src_crn,&#10;            O_tgt.offender_id AS tgt_offender_id,&#10;            O_tgt.crn         AS tgt_crn&#10;          FROM&#10;            offender_merge_details OD&#10;              INNER JOIN offender O_src ON O_src.offender_id &#61; OD.source_offender_id&#10;              INNER JOIN offender O_tgt ON O_tgt.offender_id &#61; OD.target_offender_id&#10;          WHERE source_offender_id &#61; p_offender_id&#10;            AND table_name &#61; &#39;OFFENDER&#39;&#10;            AND source_pk_value &#61; p_offender_id;&#10;        --&#10;        l_rec_o csO%ROWTYPE;&#10;        --&#10;    BEGIN&#10;        --&#10;        g_label :&#61; &#39;20010&#39;;&#10;        --&#10;        OPEN csO;&#10;        FETCH csO INTO l_rec_o;&#10;        IF csO%NOTFOUND THEN&#10;            CLOSE csO;&#10;            fatal(&#39;FATAL ERROR: failed to find the top OFFENDER [id&#61;&#39; || p_offender_id || &#39;] record in OFFENDER_MERGE_DETAILS table&#39;, l_proc1);&#10;        END IF;&#10;        CLOSE csO;&#10;        --&#10;        IF NVL(l_rec_o.src_offender_id, -1) &lt;&gt; NVL(g_merge_ctx_rec.src_offender_id, -2) OR&#10;           NVL(l_rec_o.src_crn, &#39;XXX&#39;)      &lt;&gt; NVL(g_merge_ctx_rec.src_crn, &#39;YYY&#39;)      OR&#10;           NVL(l_rec_o.tgt_offender_id, -1) &lt;&gt; NVL(g_merge_ctx_rec.tgt_offender_id, -2) OR&#10;           NVL(l_rec_o.tgt_crn, &#39;XXX&#39;)      &lt;&gt; NVL(g_merge_ctx_rec.tgt_crn, &#39;YYY&#39;)&#10;        THEN&#10;            fatal(&#39;FATAL ERROR: G_MERGE_CTX mismatch for the OFFENDER [id&#61;&#39; || p_offender_id || &#39;]&#39;, l_proc1);&#10;        END IF;&#10;        --&#10;        l_src_offender_id :&#61; g_merge_ctx_rec.src_offender_id;&#10;        l_tgt_offender_id :&#61; g_merge_ctx_rec.tgt_offender_id;&#10;        --&#10;        g_label :&#61; &#39;20020&#39;;&#10;        l_src_pk_key_val :&#61;&#10;            PKG_Lookups.funcgetTabRecord(&#10;                p_table    &#61;&gt; p_table,&#10;                p_ref_col  &#61;&gt; &#39;ROWID&#39;,&#10;                p_ref_val  &#61;&gt; p_row_id,&#10;                p_data_fld &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(p_table, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1) );&#10;        --&#10;        IF l_src_pk_key_val IS NULL THEN&#10;            fatal(&#39;ERROR: failed to find the source &#39; || p_table || &#39; record [row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc1);&#10;        END IF;&#10;        --&#10;        IF p_parent_table IS NOT NULL THEN&#10;            g_label :&#61; &#39;20030&#39;;&#10;            l_src_fk_key_val :&#61;&#10;                PKG_Lookups.funcgetTabRecord(&#10;                    p_table    &#61;&gt; p_parent_table,&#10;                    p_ref_col  &#61;&gt; &#39;ROWID&#39;,&#10;                    p_ref_val  &#61;&gt; p_parent_row_id,&#10;                    p_data_fld &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(p_parent_table, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1) );&#10;            --&#10;            IF l_src_fk_key_val IS NULL THEN&#10;                fatal(&#39;ERROR: table[&#39; || p_table || &#39;] failed to find the Source [&#39; || p_parent_table || &#39;] Parent record [row_id&#61;&#39; || p_parent_row_id || &#39;]&#39;, l_proc1);&#10;            END IF;&#10;            --&#10;            g_label :&#61; &#39;20040&#39;;&#10;            BEGIN&#10;                SELECT target_pk_value INTO l_tgt_fk_key_val&#10;                FROM offender_merge_details&#10;                WHERE source_offender_id &#61; l_src_offender_id&#10;                  AND table_name &#61; p_parent_table&#10;                  AND source_pk_value &#61; l_src_fk_key_val;&#10;            EXCEPTION WHEN NO_DATA_FOUND THEN&#10;                fatal(&#10;                    &#39;ERROR: &#39; ||&#10;                    &#39;table[&#39; || p_table || &#39;] failed to find parent OFFENDER_MERGE_DETAILS record for the &#39; ||&#10;                    &#39;[&#39; || p_parent_table || &#39;][id&#61;&#39; || l_src_fk_key_val || &#39;]&#39;, l_proc1 );&#10;            END;&#10;            --&#10;        ELSE&#10;            --&#10;            l_src_fk_key_val :&#61; -1;&#10;            l_tgt_fk_key_val :&#61; -1;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_check_src_record;&#10;    --&#10;    PROCEDURE do_check_already_processed&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_CHECK_ALREADY_PROCESSED&#39;;&#10;        --&#10;        CURSOR cs IS&#10;          SELECT&#10;            offender_merge_details_id,&#10;            CASE WHEN source_pk_value &#61; l_src_pk_key_val&#10;                THEN &#39;the record has already been processed&#39;&#10;                ELSE &#39;this is the cloned copy (with some old FK values still pointing to the Source)&#39;&#10;            END AS msg_txt&#10;          FROM offender_merge_details&#10;          WHERE 1&#61;1&#10;            AND ( ( source_offender_id &#61; l_src_offender_id AND&#10;                    table_name         &#61; p_table           AND&#10;                    source_pk_value    &#61; l_src_pk_key_val )&#10;--                  OR&#10;--                  ( source_offender_id &#61; l_src_offender_id AND&#10;--                    table_name         &#61; p_table           AND&#10;--                    target_pk_value    &#61; l_src_pk_key_val )&#10;                );&#10;        --&#10;        l_rec cs%ROWTYPE;&#10;        --&#10;    BEGIN&#10;        --&#10;        g_label :&#61; &#39;20050&#39;;&#10;        --&#10;        l_already_processed :&#61; &#39;N&#39;;&#10;        --&#10;        IF p_table &#61; &#39;CASE_ALLOCATION_LINK&#39; AND p_parent_table &#61; &#39;REFERRAL&#39; THEN&#10;            l_already_processed :&#61; &#39;Y&#39;;&#10;        END IF;&#10;        --&#10;        IF l_already_processed &#61; &#39;N&#39; THEN&#10;            --&#10;            OPEN cs;&#10;            FETCH cs INTO l_rec;&#10;            IF cs%FOUND THEN&#10;                l_off_merge_det_id  :&#61; l_rec.offender_merge_details_id;&#10;                l_already_processed :&#61; &#39;Y&#39;;&#10;            ELSE&#10;                l_off_merge_det_id  :&#61; NULL;&#10;                l_already_processed :&#61; &#39;N&#39;;&#10;            END IF;&#10;            CLOSE cs;&#10;            --&#10;        END IF;&#10;        --&#10;        IF l_already_processed &#61; &#39;Y&#39; AND p_table NOT IN (&#39;OFFENDER&#39;) THEN&#10;            UPDATE offender_merge_details SET&#10;              debug_notes &#61;&#10;                PKG_LstUtl.concat_CLOB(&#10;                    debug_notes,&#10;                    &#39;INFO: [tab&#61;&#39;  || p_table           || &#39;]&#39; ||&#10;                    &#39;[parent_tab&#61;&#39; || p_parent_table    || &#39;]&#39; ||&#10;                    &#39;[level&#61;&#39;      || p_recursive_level || &#39;]&#39; ||&#10;                    &#39; - &#39; || l_rec.msg_txt,&#10;                    --&#10;                    p_delim&#61;&gt;CHR(10) )&#10;            WHERE offender_merge_details_id &#61; l_rec.offender_merge_details_id;&#10;        END IF;&#10;        --&#10;    EXCEPTION WHEN OTHERS THEN&#10;        --&#10;        fatal(&#10;            &#39;[off_merge_det_id&#61;&#39; || l_rec.offender_merge_details_id || &#39;]&#39; ||&#10;            &#39;[tab&#61;&#39;              || p_table                         || &#39;]&#39; ||&#10;            &#39;[parent_tab&#61;&#39;       || p_parent_table                  || &#39;]&#39; ||&#10;            &#39;[recursive level&#61;&#39;  || p_recursive_level               || &#39;]&#39; || CHR(10) ||&#10;            get_dq_message(SQLERRM));&#10;        --&#10;    END do_check_already_processed;&#10;    --&#10;    PROCEDURE do_ins_target_record&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_INS_TARGET_RECORD&#39;;&#10;        --&#10;        l_SQL CLOB;&#10;        --&#10;        FUNCTION do_substitute_key_values(p_fld_lst VARCHAR2) RETURN VARCHAR2&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_SUBSTITUTE_KEY_VALUES&#39;;&#10;            --&#10;            l_new_lst VARCHAR2(20000);&#10;            --&#10;            FUNCTION is_fld_exists(p_fld_name VARCHAR2) RETURN BOOLEAN IS&#10;            BEGIN&#10;                RETURN ( INSTR(l_new_lst, &#39;,&#39; || UPPER(TRIM(p_fld_name)) || &#39;,&#39;) &gt; 0 );&#10;            END is_fld_exists;&#10;            --&#10;            PROCEDURE do_replace_fld_with_val(&#10;                p_fld_name      VARCHAR2,&#10;                p_fld_value_NEW VARCHAR2,&#10;                p_fld_value_OLD VARCHAR2 DEFAULT NULL,&#10;                p_data_type     VARCHAR2 DEFAULT &#39;C&#39; )&#10;            IS&#10;                --&#10;                l_exists_flag BOOLEAN;&#10;                l_fld_val     VARCHAR2(1000);&#10;                --&#10;                l_fld_name    VARCHAR2(30);&#10;                l_fld_alias   VARCHAR2(30);&#10;                --&#10;            BEGIN&#10;                --&#10;                l_fld_name :&#61; PKG_LstUtl.list_num_elem(p_fld_name, &#39;|&#39;, 1);&#10;                l_fld_alias :&#61; NVL(PKG_LstUtl.list_num_elem(p_fld_name, &#39;|&#39;, 2), l_fld_name);&#10;                --&#10;                l_exists_flag :&#61; is_fld_exists(l_fld_name);&#10;                --&#10;                IF p_data_type &#61; &#39;C&#39; THEN&#10;                    l_fld_val :&#61; &#39;&#39;&#39;&#39; || p_fld_value_NEW || &#39;&#39;&#39;&#39;;&#10;                ELSIF p_data_type &#61; &#39;D&#39; THEN&#10;                    l_fld_val :&#61; &#39;PKG_Common.char_2_date(&#39;&#39;&#39; || p_fld_value_NEW || &#39;&#39;&#39;)&#39;;&#10;                ELSIF p_data_type &#61; &#39;T&#39; THEN&#10;                    l_fld_val :&#61; &#39;PKG_Common.char_2_timestamp(&#39;&#39;&#39; || p_fld_value_NEW || &#39;&#39;&#39;)&#39;;&#10;                ELSE&#10;                    l_fld_val :&#61; p_fld_value_NEW;&#10;                END IF;&#10;                --&#10;                l_new_lst :&#61;&#10;                    REPLACE(l_new_lst,&#10;                        &#39;,&#39; || UPPER(TRIM(l_fld_name)) || &#39;,&#39;,&#10;                        &#39;,&#39; || l_fld_val || &#39; AS &#39; || LOWER(TRIM(l_fld_alias)) || &#39;,&#39; );&#10;                --&#10;                IF l_exists_flag THEN&#10;                    do_add_omd_hist_rec(&#10;                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                        --&#10;                        p_fld_name  &#61;&gt; l_fld_alias,&#10;                        p_data_type &#61;&gt; NVL(p_data_type, &#39;C&#39;),&#10;                        p_old_value &#61;&gt; p_fld_value_OLD,&#10;                        p_new_value &#61;&gt; p_fld_value_NEW );&#10;               END IF;&#10;                --&#10;            END do_replace_fld_with_val;&#10;            --&#10;            PROCEDURE do_amend_off_religion_hist&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_OFF_RELIGION_HIST&#39;;&#10;                --&#10;                CURSOR cs IS&#10;                SELECT&#10;                  offender_religion_history_id,&#10;                  end_date&#10;                FROM offender_religion_history&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                l_rec cs%ROWTYPE;&#10;                --&#10;                l_found_flag BOOLEAN;&#10;                --&#10;            BEGIN&#10;                --&#10;                OPEN cs;&#10;                FETCH cs INTO l_rec;&#10;                l_found_flag :&#61; cs%FOUND;&#10;                CLOSE cs;&#10;                --&#10;                IF NOT l_found_flag THEN&#10;                    fatal(&#39;FAILED to set the &#39; || p_table || &#39;.end_date in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                END IF;&#10;                --&#10;                IF l_rec.end_date IS NULL THEN&#10;                    --&#10;                    IF g_merge_ctx_rec.off_religion_hist_cnt &gt; 0 THEN&#10;                        -- There are some records in Offender Religion History on the Target CRN&#10;                        do_replace_fld_with_val(&#10;                            p_fld_name      &#61;&gt; &#39;END_DATE&#39;,&#10;                            p_fld_value_NEW &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                            p_fld_value_OLD &#61;&gt; NULL,&#10;                            p_data_type     &#61;&gt; &#39;D&#39; );&#10;                        --&#10;                    ELSE&#10;                        --  There aren&#39;t any records in Offender Religion History on the Target CRN&#10;                        --  Therefore leave merged Source END_DATE as NULL and&#10;                        --  record this condition (both Source and Target END_DATE are NULL) into the OMDH&#10;                        do_replace_fld_with_val(&#10;                            p_fld_name      &#61;&gt; &#39;END_DATE&#39;,&#10;                            p_fld_value_NEW &#61;&gt; NULL,&#10;                            p_fld_value_OLD &#61;&gt; NULL,&#10;                            p_data_type     &#61;&gt; &#39;D&#39; );&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_amend_off_religion_hist;&#10;            --&#10;            PROCEDURE do_amend_management_tier&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_MANAGEMENT_TIER&#39;;&#10;                --&#10;                CURSOR cs IS&#10;                SELECT&#10;                  tier_id,&#10;                  date_changed,&#10;                  end_date&#10;                FROM management_tier&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                l_rec cs%ROWTYPE;&#10;                --&#10;                l_found_flag BOOLEAN;&#10;                --&#10;                l_mt_date_ORIG     MANAGEMENT_TIER.date_changed%TYPE;&#10;                l_mt_date_ADJUSTED MANAGEMENT_TIER.date_changed%TYPE;&#10;                --&#10;                PROCEDURE do_fetch_mt IS&#10;                BEGIN&#10;                    --&#10;                    OPEN cs;&#10;                    FETCH cs INTO l_rec;&#10;                    l_found_flag :&#61; cs%FOUND;&#10;                    CLOSE cs;&#10;                    --&#10;                    IF NOT l_found_flag THEN&#10;                        fatal(&#39;FAILED to set the &#39; || p_table || &#39;.end_date in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                    END IF;&#10;                    --&#10;                    l_mt_date_ORIG :&#61; l_rec.date_changed;&#10;                    --&#10;                END do_fetch_mt;&#10;                --&#10;                PROCEDURE do_upd_mt_date_changed IS&#10;                BEGIN&#10;                    --&#10;                    IF PKG_GLOBAL.get_MT_DATE_CHANGED_DATA_TYPE &#61; &#39;TIMESTAMP&#39; THEN&#10;                        --&#10;                        l_mt_date_ADJUSTED :&#61;&#10;                            PKG_Common.char_2_timestamp(&#10;                                 PKG_Lookups.funcgetTabRecord(&#10;                                     p_table       &#61;&gt; &#39;management_tier&#39;,&#10;                                     p_data_fld    &#61;&gt; &#39;PKG_Common.timestamp_2_char(date_changed + INTERVAL &#39;&#39;0 00:00:00.000001&#39;&#39; DAY TO SECOND(6))&#39;,&#10;                                     p_default_val &#61;&gt; PKG_Common.timestamp_2_char(l_mt_date_ORIG),&#10;                                     p_ref_col     &#61;&gt; &#39;offender_id&#39;,&#10;                                     p_ref_val     &#61;&gt; l_tgt_offender_id,&#10;                                     p_where       &#61;&gt; &#39;tier_id &#61; :p_tier_id&#10;                                                   AND date_changed BETWEEN PKG_Common.char_2_timestamp(:p_date_changed) AND&#10;                                                                            PKG_Common.char_2_timestamp(:p_date_changed) + INTERVAL &#39;&#39;0 00:00:00.000999&#39;&#39; DAY TO SECOND(6)&#39;,&#10;                                     p_bind_var1   &#61;&gt; l_rec.tier_id,&#10;                                     p_bind_var2   &#61;&gt; PKG_Common.timestamp_2_char(l_mt_date_ORIG),&#10;                                     p_bind_var3   &#61;&gt; PKG_Common.timestamp_2_char(l_mt_date_ORIG),&#10;                                     p_order_by    &#61;&gt; &#39;date_changed DESC&#39; ) );&#10;                        --&#10;                        IF l_mt_date_ORIG &lt;&gt; l_mt_date_ADJUSTED THEN&#10;                            --&#10;                            do_replace_fld_with_val( &#39;DATE_CHANGED&#39;, PKG_Common.timestamp_2_char(l_mt_date_ADJUSTED), PKG_Common.timestamp_2_char(l_mt_date_ORIG), &#39;T&#39; );&#10;                            l_tgt_pk_key_val :&#61; REPLACE(l_tgt_pk_key_val, PKG_Common.timestamp_2_char(l_mt_date_ORIG), PKG_Common.timestamp_2_char(l_mt_date_ADJUSTED));&#10;                            --&#10;                        END IF;&#10;                        --&#10;                    ELSE&#10;                        --&#10;                        l_mt_date_ADJUSTED :&#61;&#10;                            TO_DATE(&#10;                                 PKG_Lookups.funcgetTabRecord(&#10;                                     p_table       &#61;&gt; &#39;management_tier&#39;,&#10;                                     p_data_fld    &#61;&gt; &#39;PKG_Common.date_2_char(date_changed + 1/24/60/60)&#39;,&#10;                                     p_default_val &#61;&gt; PKG_Common.date_2_char(l_mt_date_ORIG),&#10;                                     p_ref_col     &#61;&gt; &#39;offender_id&#39;,&#10;                                     p_ref_val     &#61;&gt; l_tgt_offender_id,&#10;                                     p_where       &#61;&gt; &#39;tier_id &#61; :p_tier_id&#10;                                                   AND date_changed BETWEEN PKG_Common.char_2_date(:p_date_changed) AND&#10;                                                                            PKG_Common.char_2_date(:p_date_changed) + 1/24/60/60 * 59&#39;,&#10;                                     p_bind_var1   &#61;&gt; l_rec.tier_id,&#10;                                     p_bind_var2   &#61;&gt; PKG_Common.date_2_char(l_mt_date_ORIG),&#10;                                     p_bind_var3   &#61;&gt; PKG_Common.date_2_char(l_mt_date_ORIG),&#10;                                     p_order_by    &#61;&gt; &#39;date_changed DESC&#39; ),&#10;                                &#39;YYYYMMDD HH24:MI:SS&#39; );&#10;                        --&#10;                        IF l_mt_date_ORIG &lt;&gt; l_mt_date_ADJUSTED THEN&#10;                            --&#10;                            do_replace_fld_with_val( &#39;DATE_CHANGED&#39;, PKG_Common.date_2_char(l_mt_date_ADJUSTED), PKG_Common.date_2_char(l_mt_date_ORIG), &#39;D&#39; );&#10;                            l_tgt_pk_key_val :&#61; REPLACE(l_tgt_pk_key_val, PKG_Common.date_2_char(l_mt_date_ORIG), PKG_Common.date_2_char(l_mt_date_ADJUSTED));&#10;                            --&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END do_upd_mt_date_changed;&#10;                --&#10;                PROCEDURE do_upd_mt_end_date IS&#10;                BEGIN&#10;                    --&#10;                    IF l_rec.end_date IS NULL THEN&#10;                        --&#10;                        do_replace_fld_with_val(&#10;                            p_fld_name      &#61;&gt; &#39;END_DATE&#39;,&#10;                            p_fld_value_NEW &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                            p_fld_value_OLD &#61;&gt; NULL,&#10;                            p_data_type     &#61;&gt; &#39;D&#39; );&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END do_upd_mt_end_date;&#10;                --&#10;            BEGIN&#10;                --&#10;                do_fetch_mt;&#10;                --&#10;                do_upd_mt_date_changed;&#10;                --&#10;                do_upd_mt_end_date;&#10;                --&#10;            END do_amend_management_tier;&#10;            --&#10;            PROCEDURE do_amend_alf_doc_id&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_ALF_DOC_ID&#39;;&#10;                --&#10;                l_alf_doc_fld            VARCHAR2(30);&#10;                l_alf_doc_id             DOCUMENT.alfresco_document_id%TYPE;&#10;                l_external_reference     DOCUMENT.external_reference%TYPE;&#10;                --&#10;            BEGIN&#10;                SELECT&#10;                  DECODE( p_table,&#10;                      &#39;DOCUMENT&#39;             , &#39;ALFRESCO_DOCUMENT_ID&#39;,&#10;                      -- PDM 2703: PRECON/CPS are now stored in DOCUMENT table&#10;--                      &#39;OFFENDER&#39;             , &#39;PREV_CON_ALFRESCO_DOCUMENT_ID&#39;,&#10;--                      &#39;EVENT&#39;                , &#39;CPS_ALFRESCO_DOCUMENT_ID&#39;,&#10;                      --&#10;                      &#39;PRECON_HISTORY&#39;       , &#39;ALFRESCO_DOCUMENT_ID&#39;,&#10;                      &#39;SUBJECT_ACCESS_REPORT&#39;, &#39;SAR_ALFRESCO_ID&#39;,&#10;                      NULL )&#10;                INTO&#10;                  l_alf_doc_fld&#10;                FROM dual;&#10;                --&#10;                IF l_alf_doc_fld IS NOT NULL THEN&#10;                    --&#10;                    l_alf_doc_id :&#61;&#10;                         PKG_Lookups.funcgetTabRecord(&#10;                             p_table    &#61;&gt; p_table,&#10;                             p_data_fld &#61;&gt; l_alf_doc_fld,&#10;                             p_ref_col  &#61;&gt; &#39;ROWID&#39;,&#10;                             p_ref_val  &#61;&gt; p_row_id );&#10;                    --&#10;                    IF TRIM(l_alf_doc_id) IS NOT NULL THEN&#10;                        EXECUTE IMMEDIATE &#39;UPDATE &#39; || p_table || &#39; SET &#39; || l_alf_doc_fld || &#39;&#61;NULL WHERE ROWID &#61; :p_row_id&#39; USING p_row_id;&#10;                        --&#10;                        IF SQL%ROWCOUNT &#61; 0 THEN&#10;                            fatal(&#39;FAILED to clear the &#39; || p_table || &#39;.&#39; || l_alf_doc_fld || &#39; in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                        ELSE&#10;                            do_replace_fld_with_val( l_alf_doc_fld, l_alf_doc_id, NULL, &#39;C&#39; );&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;                IF p_table &#61; &#39;DOCUMENT&#39; THEN&#10;                    --&#10;                    SELECT external_reference INTO l_external_reference&#10;                    FROM document&#10;                    WHERE ROWID &#61; p_row_id;&#10;                    --&#10;                    UPDATE document SET external_reference &#61; NULL&#10;                    WHERE ROWID &#61; p_row_id;&#10;                    --&#10;                    IF SQL%ROWCOUNT &#61; 0 THEN&#10;                        fatal(&#39;FAILED to clear the DOCUMENT.external_reference in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                    ELSE&#10;                        do_replace_fld_with_val( &#39;EXTERNAL_REFERENCE&#39;, l_external_reference, NULL, &#39;C&#39; );&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_amend_alf_doc_id;&#10;            --&#10;            PROCEDURE do_amend_OM&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_OM&#39;;&#10;                --&#10;                l_src_active_om_flag  SMALLINT;&#10;                l_src_allocation_date DATE;&#10;                --&#10;                l_old_tgt_om_id           VARCHAR2(100);&#10;                l_old_tgt_om_area_id      NUMBER;&#10;                l_old_tgt_om_team_id      NUMBER;&#10;                l_old_tgt_om_staff_id     NUMBER;&#10;                --&#10;                l_src_om_id           NUMBER;&#10;                l_src_om_area_id      NUMBER;&#10;                l_src_om_team_id      NUMBER;&#10;                l_src_om_staff_id     NUMBER;&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT&#10;                  OM.offender_manager_id,&#10;                  OM.active_flag,&#10;                  OM.allocation_date,&#10;                  T.probation_area_id,&#10;                  OM.team_id,&#10;                  OM.allocation_staff_id&#10;                INTO&#10;                  l_src_om_id,&#10;                  l_src_active_om_flag,&#10;                  l_src_allocation_date,&#10;                  l_src_om_area_id,&#10;                  l_src_om_team_id,&#10;                  l_src_om_staff_id&#10;                FROM&#10;                    offender_manager OM&#10;                      INNER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;                WHERE OM.ROWID &#61; p_row_id;&#10;                --&#10;                IF l_src_active_om_flag &#61; 1 THEN&#10;                    --&#10;                    IF g_merge_ctx_rec.move_provider &#61; &#39;Y&#39; THEN&#10;                        -- End date current OM on the Target&#10;                        UPDATE offender_manager SET&#10;                          end_date              &#61; LC_DATE_TIME,&#10;                          active_flag           &#61; 0,&#10;                          --&#10;                          row_version           &#61; row_version + 1,&#10;                          last_updated_datetime &#61; LC_DATE_TIME,&#10;                          last_updated_user_id  &#61; LC_USER_ID&#10;                        WHERE offender_id &#61; l_tgt_offender_id&#10;                          AND active_flag &#61; 1&#10;                        RETURNING&#10;                          offender_manager_id,&#10;                          team_id,&#10;                          allocation_staff_id&#10;                        INTO&#10;                          l_old_tgt_om_id,&#10;                          l_old_tgt_om_team_id,&#10;                          l_old_tgt_om_staff_id;&#10;                        --&#10;                        IF SQL%ROWCOUNT &#61; 1 THEN&#10;                            --&#10;                            SELECT T.probation_area_id INTO l_old_tgt_om_area_id&#10;                            FROM&#10;                                offender_manager OM&#10;                                  INNER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;                            WHERE OM.offender_manager_id &#61; l_old_tgt_om_id;&#10;                            --&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                                p_data_type    &#61;&gt; &#39;D&#39;,&#10;                                p_old_value    &#61;&gt; NULL,&#10;                                p_new_value    &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                                p_tab_pk_value &#61;&gt; l_old_tgt_om_id );&#10;                            --&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; &#39;ACTIVE_FLAG&#39;,&#10;                                p_data_type    &#61;&gt; &#39;N&#39;,&#10;                                p_old_value    &#61;&gt; &#39;1&#39; ,&#10;                                p_new_value    &#61;&gt; &#39;0&#39;,&#10;                                p_tab_pk_value &#61;&gt; l_old_tgt_om_id );&#10;                            --&#10;                            g_merge_ctx_rec.old_tgt_offender_manager_id  :&#61; l_old_tgt_om_id;&#10;                            g_merge_ctx_rec.old_tgt_om_probation_area_id :&#61; l_old_tgt_om_area_id;&#10;                            g_merge_ctx_rec.old_tgt_om_team_id           :&#61; l_old_tgt_om_team_id;&#10;                            g_merge_ctx_rec.old_tgt_om_staff_id          :&#61; l_old_tgt_om_staff_id;&#10;                            --&#10;                            g_merge_ctx_rec.src_offender_manager_id      :&#61; l_src_om_id;&#10;                            g_merge_ctx_rec.src_om_probation_area_id     :&#61; l_src_om_area_id;&#10;                            g_merge_ctx_rec.src_om_team_id               :&#61; l_src_om_team_id;&#10;                            g_merge_ctx_rec.src_om_staff_id              :&#61; l_src_om_staff_id;&#10;                            --&#10;                            info(&#39;do_amend_OM: &#39; || CHR(10) ||&#10;                                &#39;[old_tgt_OM_id&#61;&#39;       || g_merge_ctx_rec.old_tgt_offender_manager_id  || &#39;]&#39; ||&#10;                                &#39;[old_tgt_OM_area_id&#61;&#39;  || g_merge_ctx_rec.old_tgt_om_probation_area_id || &#39;]&#39; ||&#10;                                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;,&#10;                                           p_data_fld &#61;&gt; &#39;code&#39;,&#10;                                           p_ref_col  &#61;&gt; &#39;probation_area_id&#39;,&#10;                                           p_ref_val  &#61;&gt; g_merge_ctx_rec.old_tgt_om_probation_area_id ) || &#39;]&#39; ||&#10;                                &#39;[old_tgt_OM_team_id&#61;&#39;  || g_merge_ctx_rec.old_tgt_om_team_id           || &#39;]&#39; ||&#10;                                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;TEAM&#39;,&#10;                                           p_data_fld &#61;&gt; &#39;code&#39;,&#10;                                           p_ref_col  &#61;&gt; &#39;team_id&#39;,&#10;                                           p_ref_val  &#61;&gt; g_merge_ctx_rec.old_tgt_om_team_id )           || &#39;]&#39; ||&#10;                                &#39;[old_tgt_OM_staff_id&#61;&#39; || g_merge_ctx_rec.old_tgt_om_staff_id          || &#39;]&#39; || CHR(10) ||&#10;                                --&#10;                                &#39;[src_OM_id&#61;&#39;       || g_merge_ctx_rec.src_offender_manager_id          || &#39;]&#39; ||&#10;                                &#39;[src_OM_area_id&#61;&#39;  || g_merge_ctx_rec.src_om_probation_area_id         || &#39;]&#39; ||&#10;                                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;PROBATION_AREA&#39;,&#10;                                          p_data_fld &#61;&gt; &#39;code&#39;,&#10;                                          p_ref_col  &#61;&gt; &#39;probation_area_id&#39;,&#10;                                          p_ref_val  &#61;&gt; g_merge_ctx_rec.src_om_probation_area_id )      || &#39;]&#39; ||&#10;                                &#39;[src_OM_team_id&#61;&#39;  || g_merge_ctx_rec.src_om_team_id                   || &#39;]&#39; ||&#10;                                &#39;[&#39; || PKG_Lookups.funcgetTabRecord_CACHED(p_table&#61;&gt;&#39;TEAM&#39;,&#10;                                           p_data_fld &#61;&gt; &#39;code&#39;,&#10;                                           p_ref_col  &#61;&gt; &#39;team_id&#39;,&#10;                                           p_ref_val  &#61;&gt; g_merge_ctx_rec.src_om_team_id )               || &#39;]&#39; ||&#10;                                &#39;[src_OM_staff_id&#61;&#39; || g_merge_ctx_rec.src_om_staff_id                  || &#39;]&#39; );&#10;                            --&#10;                            -- NDM-152: Change ALLOCATION_DATE for the cloned Source OM record&#10;                            -- YF: See NDM-167&#10;                            --do_replace_fld_with_val( &#39;ALLOCATION_DATE&#39;, PKG_Common.date_2_char(LC_DATE_TIME), PKG_Common.date_2_char(l_src_allocation_date) /*old_value*/, &#39;D&#39; );&#10;                        ELSE&#10;                            fatal(&#39;ERROR: failed to terminate the Target OM record [offender_id&#61;&#39; || l_tgt_offender_id || &#39;][om_id&#61;&#39; || l_old_tgt_om_id || &#39;]&#39;, l_proc3);&#10;                        END IF;&#10;                        -- Move Source record as it is&#10;                    ELSE&#10;                        -- Move Source record as an Inactive OM&#10;                        do_replace_fld_with_val( &#39;END_DATE&#39;, PKG_Common.date_2_char(LC_DATE_TIME+1/24/60/60), NULL /*old_value*/, &#39;D&#39; );&#10;                        do_replace_fld_with_val( &#39;ACTIVE_FLAG&#39;, &#39;0&#39;, &#39;1&#39; /*old_value*/, &#39;N&#39; );&#10;                        --&#10;                        g_merge_ctx_rec.old_tgt_offender_manager_id  :&#61; -1;&#10;                        g_merge_ctx_rec.old_tgt_om_probation_area_id :&#61; -1;&#10;                        g_merge_ctx_rec.old_tgt_om_team_id           :&#61; -1;&#10;                        g_merge_ctx_rec.old_tgt_om_staff_id          :&#61; -1;&#10;                        --&#10;                        g_merge_ctx_rec.src_offender_manager_id      :&#61; -1;&#10;                        g_merge_ctx_rec.src_om_probation_area_id     :&#61; -1;&#10;                        g_merge_ctx_rec.src_om_team_id               :&#61; -1;&#10;                        g_merge_ctx_rec.src_om_staff_id              :&#61; -1;&#10;                        --&#10;                    END IF;&#10;                END IF;&#10;                --&#10;            END do_amend_OM;&#10;            --&#10;            PROCEDURE do_amend_POM&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_POM&#39;;&#10;                --&#10;                l_active_pom_flag SMALLINT;&#10;                l_tgt_pom_id      VARCHAR2(100);&#10;                l_src_pom_id      NUMBER;&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT&#10;                  prison_offender_manager_id,&#10;                  active_flag&#10;                INTO&#10;                  l_src_pom_id,&#10;                  l_active_pom_flag&#10;                FROM prison_offender_manager&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                BEGIN&#10;                    SELECT prison_offender_manager_id INTO l_tgt_pom_id&#10;                    FROM prison_offender_manager&#10;                    WHERE offender_id &#61; l_tgt_offender_id&#10;                      AND active_flag &#61; 1;&#10;                EXCEPTION WHEN NO_DATA_FOUND THEN&#10;                    l_tgt_pom_id :&#61; -1;&#10;                END;&#10;                --&#10;                IF l_active_pom_flag &#61; 1 AND l_tgt_pom_id &gt; 1 THEN&#10;                    -- Move Source record as an Inactive POM&#10;                    do_replace_fld_with_val( &#39;END_DATE&#39;, PKG_Common.date_2_char(LC_DATE_TIME), NULL /*old_value*/, &#39;D&#39; );&#10;                    do_replace_fld_with_val( &#39;ACTIVE_FLAG&#39;, &#39;0&#39;, &#39;1&#39; /*old_value*/, &#39;N&#39; );&#10;                END IF;&#10;                --&#10;            END do_amend_POM;&#10;            --&#10;            PROCEDURE do_amend_OT&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_OT&#39;;&#10;                --&#10;                l_soft_deleted SMALLINT;&#10;                l_id           VARCHAR2(100);&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT soft_deleted INTO l_soft_deleted&#10;                FROM offender_transfer&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                IF l_soft_deleted &#61; 0 THEN&#10;                    -- Soft Delete the source OT record&#10;                    UPDATE offender_transfer SET&#10;                      soft_deleted           &#61; 1,&#10;                      --&#10;                      row_version           &#61; row_version + 1,&#10;                      last_updated_datetime &#61; LC_DATE_TIME,&#10;                      last_updated_user_id  &#61; LC_USER_ID&#10;                    WHERE ROWID &#61; p_row_id&#10;                    RETURNING offender_transfer_id INTO l_id;&#10;                    --&#10;                    IF SQL%ROWCOUNT &#61; 0 THEN&#10;                        fatal(&#39;FAILED to set the OFFENDER_TRANSFER.soft_deleted in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                    ELSE&#10;                        do_replace_fld_with_val( &#39;SOFT_DELETED&#39;, &#39;0&#39;, &#39;1&#39;, &#39;N&#39; );&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_amend_OT;&#10;            --&#10;            PROCEDURE do_amend_AP&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_AP&#39;;&#10;                --&#10;                l_external_reference APPROVED_PREMISES_REFERRAL.external_reference%TYPE;&#10;                l_soft_deleted       SMALLINT;&#10;                l_id                 VARCHAR2(100);&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT&#10;                  external_reference,&#10;                  soft_deleted&#10;                INTO&#10;                  l_external_reference,&#10;                  l_soft_deleted&#10;                FROM approved_premises_referral&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                IF l_soft_deleted &#61; 0 OR l_external_reference IS NOT NULL THEN&#10;                    -- Update EXTERNAL_REFERENCE to NULL; plus Soft Delete the source AP Referral record&#10;                    l_SQL :&#61;&#10;                    --&#10;&#39;UPDATE approved_premises_referral SET&#10;&#39; || PKG_LstUtl.concat(&#10;           CASE WHEN l_external_reference IS NOT NULL THEN &#39;  external_reference &#61; NULL&#39; END,&#10;           CASE WHEN l_soft_deleted &#61; 0               THEN &#39;  soft_deleted &#61; 1&#39;          END,&#10;           &#39;  row_version           &#61; row_version + 1&#39;,&#10;           &#39;  last_updated_datetime &#61; :p_date&#39;,&#10;           &#39;  last_updated_user_id  &#61; :p_user_id&#39;,&#10;           --&#10;           p_delim &#61;&gt; &#39;,&#39; || CHR(10) ) || &#39;&#10;  --&#10;WHERE ROWID &#61; :p_row_id&#10;RETURNING approved_premises_referral_id INTO :x_id&#39;;&#10;                    --&#10;                    EXECUTE IMMEDIATE l_SQL USING&#10;                        LC_DATE_TIME,&#10;                        LC_USER_ID,&#10;                        p_row_id&#10;                    RETURNING INTO l_id;&#10;                    --&#10;                    --raise_application_error( -20001, l_proc3 || &#39;: Updated APR record [row_id&#61;&#39; || p_row_id || &#39;][id&#61;&#39; || l_id || &#39;][rows_cnt&#61;&#39; || SQL%ROWCOUNT || &#39;]&#39; );&#10;                    --&#10;                    IF SQL%ROWCOUNT &#61; 0 THEN&#10;                        --&#10;                        fatal(&#10;                            &#39;FAILED to set the &#39; ||&#10;                            PKG_LstUtl.concat(&#10;                                CASE WHEN l_external_reference IS NOT NULL THEN &#39;[EXTERNAL_REFERENCE&#61;NULL]&#39; END,&#10;                                CASE WHEN l_soft_deleted &#61; 0               THEN &#39;[SOFT_DELETED&#61;1]&#39;          END,&#10;                                p_delim &#61;&gt; &#39;/&#39; ) ||&#10;                            &#39; on APPROVED_PREMISES_REFERRAL in the Source record &#39; ||&#10;                            &#39;[pk&#61;&#39;     || l_src_pk_key_val || &#39;]&#39; ||&#10;                            &#39;[row_id&#61;&#39; || p_row_id         || &#39;]&#39;,&#10;                            --&#10;                            l_proc3 );&#10;                        --&#10;                    ELSE&#10;                        --&#10;                        IF l_external_reference IS NOT NULL THEN&#10;                            do_replace_fld_with_val( &#39;EXTERNAL_REFERENCE&#39;, l_external_reference, NULL, &#39;C&#39; );&#10;                        END IF;&#10;                        --&#10;                        IF l_soft_deleted &#61; 0 THEN&#10;                            do_replace_fld_with_val( &#39;SOFT_DELETED&#39;, &#39;0&#39;, &#39;1&#39;, &#39;N&#39; );&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_amend_AP;&#10;            --&#10;            PROCEDURE do_amend_RO&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_RO&#39;;&#10;                --&#10;                l_id         NUMBER;&#10;                l_om_id      NUMBER;&#10;                l_pom_id     NUMBER;&#10;                l_start_date DATE;&#10;                l_end_date   DATE;&#10;                --&#10;                CURSOR csRO IS&#10;                  SELECT *&#10;                  FROM responsible_officer&#10;                  WHERE offender_id &#61; l_tgt_offender_id&#10;                    AND end_date IS NULL&#10;                    --AND ( (l_om_id  IS NOT NULL AND offender_manager_id        IS NOT NULL) OR&#10;                    --      (l_pom_id IS NOT NULL AND prison_offender_manager_id IS NOT NULL)&#10;                    --    )&#10;                ;&#10;                --&#10;                l_rec_RO     csRO%ROWTYPE;&#10;                l_found_flag BOOLEAN;&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT&#10;                  responsible_officer_id,&#10;                  offender_manager_id,&#10;                  prison_offender_manager_id,&#10;                  start_date,&#10;                  end_date&#10;                INTO&#10;                  l_id,&#10;                  l_om_id,&#10;                  l_pom_id,&#10;                  l_start_date,&#10;                  l_end_date&#10;                FROM responsible_officer&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                IF l_end_date IS NULL THEN&#10;                    --&#10;                    OPEN csRO;&#10;                    FETCH csRO INTO l_rec_RO;&#10;                    l_found_flag :&#61; csRO%FOUND;&#10;                    CLOSE csRO;&#10;                    --&#10;                    info(&#39;do_amend_RO: [old_tgt_om_id&#61;&#39; || g_merge_ctx_rec.old_tgt_offender_manager_id || &#39;][old_tgt_ro_id&#61;&#39; || l_rec_RO.responsible_officer_id || &#39;]&#39;);&#10;                    --&#10;                    IF g_merge_ctx_rec.move_responsible_officer &#61; &#39;Y&#39; /*OR&#10;                       -- NDM-138: The new RO should also be created is OM is being moved from the Source&#10;                       (l_om_id IS NOT NULL AND g_merge_ctx_rec.old_tgt_offender_manager_id IS NOT NULL)*/&#10;                       --&#10;                    THEN&#10;                        --&#10;                        g_merge_ctx_rec.old_tgt_responsible_officer_id :&#61; l_rec_RO.responsible_officer_id;&#10;                        g_merge_ctx_rec.src_responsible_officer_id :&#61; l_id;&#10;                        --&#10;                        /*IF l_om_id IS NOT NULL AND g_merge_ctx_rec.old_tgt_offender_manager_id IS NOT NULL THEN&#10;                            -- NDM-138: Set START_DATE to today&#39;s data if OM is also being moved from the Source Offender&#10;                            do_replace_fld_with_val( &#39;START_DATE&#39;, PKG_Common.date_2_char(LC_DATE_TIME), PKG_Common.date_2_char(l_start_date), &#39;D&#39; );&#10;                            IF l_end_date IS NOT NULL THEN&#10;                                do_replace_fld_with_val( &#39;END_DATE&#39;, NULL, PKG_Common.date_2_char(l_end_date), &#39;D&#39; );&#10;                            END IF;&#10;                        END IF;*/&#10;                        --&#10;                        IF l_found_flag THEN&#10;                            -- End date current RO on the Target&#10;                            --&#10;                            info(&#39;do_amend_RO: End date current RO on the Target [old_tgt_ro_id&#61;&#39; || l_rec_RO.responsible_officer_id || &#39;]&#39;);&#10;                            --&#10;                            UPDATE responsible_officer SET&#10;                              end_date              &#61; LC_DATE_TIME,&#10;                              --&#10;                              row_version           &#61; row_version + 1,&#10;                              last_updated_datetime &#61; LC_DATE_TIME,&#10;                              last_updated_user_id  &#61; LC_USER_ID&#10;                            WHERE responsible_officer_id &#61; l_rec_RO.responsible_officer_id;&#10;                            --&#10;                            IF SQL%ROWCOUNT &#61; 1 THEN&#10;                                do_add_omd_hist_rec(&#10;                                    x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                    --&#10;                                    p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                                    p_data_type    &#61;&gt; &#39;D&#39;,&#10;                                    p_old_value    &#61;&gt; NULL,&#10;                                    p_new_value    &#61;&gt; PKG_Common.date_2_char(LC_DATE_TIME),&#10;                                    p_tab_pk_value &#61;&gt; l_rec_RO.responsible_officer_id );&#10;                            ELSE&#10;                                fatal(&#10;                                    &#39;ERROR: failed to terminate the Target RO record &#39; ||&#10;                                    &#39;[offender_id&#61;&#39; || l_tgt_offender_id || &#39;]&#39; ||&#10;                                    &#39;[responsible_officer_id&#61;&#39; || l_rec_RO.responsible_officer_id || &#39;]&#39;,&#10;                                    --&#10;                                    l_proc3 );&#10;                            END IF;&#10;                            --&#10;                            -- Move Source record as it is&#10;                        END IF;&#10;                        --&#10;                    ELSIF l_found_flag THEN&#10;                        -- Move Source record as an Inactive RO&#10;                        do_replace_fld_with_val( &#39;END_DATE&#39;, PKG_Common.date_2_char(LC_DATE_TIME), NULL /*old_value*/, &#39;D&#39; );&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_amend_RO;&#10;            --&#10;            PROCEDURE do_amend_OA&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_OA&#39;;&#10;                --&#10;                l_off_addr_end_date DATE;&#10;                l_off_addr_typ      R_STANDARD_REFERENCE_LIST.code_value%TYPE;&#10;                l_off_addr_id       NUMBER;&#10;                --&#10;                l_address_status_main_id NUMBER;&#10;                l_address_status_prev_id NUMBER;&#10;                --&#10;                PROCEDURE do_end_date_tgt_OA(p_addr_type VARCHAR2)&#10;                IS&#10;                    --&#10;                    l_id VARCHAR2(100);&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    UPDATE offender_address SET&#10;                      address_status_id     &#61; CASE&#10;                                                  WHEN p_addr_type &#61; &#39;M&#39; THEN&#10;                                                      l_address_status_prev_id&#10;                                                  ELSE address_status_id&#10;                                              END,&#10;                      end_date              &#61; LC_DATE,&#10;                      row_version           &#61; row_version + 1,&#10;                      last_updated_datetime &#61; LC_DATE_TIME,&#10;                      last_updated_user_id  &#61; LC_USER_ID&#10;                    WHERE offender_id &#61; l_tgt_offender_id&#10;                      AND end_date IS NULL&#10;                      AND address_status_id &#61; PKG_Lookups.funcgetStdRefListID(p_code_set&#61;&gt;&#39;ADDRESS STATUS&#39;, p_code&#61;&gt;p_addr_type)&#10;                    RETURNING offender_address_id INTO l_id;&#10;                    --&#10;                    IF SQL%ROWCOUNT &gt; 0 THEN&#10;                        --&#10;                        do_add_omd_hist_rec(&#10;                            x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                            --&#10;                            p_fld_name     &#61;&gt; &#39;END_DATE&#39;,&#10;                            p_data_type    &#61;&gt; &#39;D&#39;,&#10;                            p_old_value    &#61;&gt; NULL,&#10;                            p_new_value    &#61;&gt; PKG_Common.date_2_char(LC_DATE),&#10;                            p_tab_pk_value &#61;&gt; l_id );&#10;                        --&#10;                        IF l_off_addr_typ &#61; &#39;M&#39; THEN&#10;                            --&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; &#39;ADDRESS_STATUS_ID&#39;,&#10;                                p_data_type    &#61;&gt; &#39;N&#39;,&#10;                                p_old_value    &#61;&gt; l_address_status_main_id,&#10;                                p_new_value    &#61;&gt; l_address_status_prev_id,&#10;                                p_tab_pk_value &#61;&gt; l_id );&#10;                            --&#10;                            g_merge_ctx_rec.tgt_off_addr_id_MAIN :&#61; l_id;&#10;                            --&#10;                        ELSIF l_off_addr_typ &#61; &#39;MA&#39; THEN&#10;                            --&#10;                            g_merge_ctx_rec.tgt_off_addr_id_POSTAL :&#61; l_id;&#10;                            --&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END do_end_date_tgt_OA;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_address_status_main_id :&#61; PKG_Lookups.funcgetStdRefListID(p_code_set&#61;&gt;&#39;ADDRESS STATUS&#39;, p_code&#61;&gt;&#39;M&#39;);&#10;                l_address_status_prev_id :&#61; PKG_Lookups.funcgetStdRefListID(p_code_set&#61;&gt;&#39;ADDRESS STATUS&#39;, p_code&#61;&gt;&#39;P&#39;);&#10;                --&#10;                SELECT&#10;                  R.code_value,&#10;                  OA.end_date,&#10;                  OA.offender_address_id&#10;                INTO&#10;                  l_off_addr_typ,&#10;                  l_off_addr_end_date,&#10;                  l_off_addr_id&#10;                FROM&#10;                  offender_address OA&#10;                    INNER JOIN r_standard_reference_list R ON R.standard_reference_list_id &#61; OA.address_status_id&#10;                WHERE OA.ROWID &#61; p_row_id;&#10;                --&#10;                IF  l_off_addr_typ IN ( &#39;M&#39;, &#39;MA&#39; ) THEN&#10;                    IF g_merge_ctx_rec.move_main_address &#61; &#39;Y&#39; THEN&#10;                        IF l_off_addr_end_date IS NULL THEN&#10;                            -- End date current Main OA on the Target&#10;                            do_end_date_tgt_OA(l_off_addr_typ);&#10;                        END IF;&#10;                        -- Move Source record as it is&#10;                    ELSIF l_off_addr_end_date IS NULL THEN&#10;                        -- Move Source record as an Inactive Main Address&#10;                        do_replace_fld_with_val( &#39;END_DATE&#39;, PKG_Common.date_2_char(LC_DATE), NULL /*old_value*/, &#39;D&#39; );&#10;                        --&#10;                        IF l_off_addr_typ &#61; &#39;M&#39; THEN&#10;                            -- DST-11698: change Address Status to P(revious)&#10;                            do_replace_fld_with_val( &#39;ADDRESS_STATUS_ID&#39;, l_address_status_prev_id, l_address_status_main_id /*old_value*/, &#39;N&#39; );&#10;                            --&#10;                            g_merge_ctx_rec.src_off_addr_id_MAIN :&#61; l_off_addr_id;&#10;                            --&#10;                        ELSIF l_off_addr_typ &#61; &#39;MA&#39; THEN&#10;                            --&#10;                            g_merge_ctx_rec.src_off_addr_id_POSTAL :&#61; l_off_addr_id;&#10;                            --&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                END IF;&#10;                --&#10;            END do_amend_OA;&#10;            --&#10;            PROCEDURE do_amend_REG&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_REG&#39;;&#10;                --&#10;                PROCEDURE do_check_for_dupl_reg&#10;                IS&#10;                    --&#10;                    l_proc4 VARCHAR2(50) :&#61; l_proc3 || &#39;.do_check_for_dupl_reg&#39;;&#10;                    --&#10;                    l_reg_id_DEREGISTERED NUMBER;&#10;                    l_reg_id_ACTIVE       NUMBER;&#10;                    --&#10;                    CURSOR cs1 IS&#10;                      WITH T AS (&#10;                        SELECT&#10;                          R.registration_id   AS src_reg_id,&#10;                          R.created_datetime  AS src_created_datetime,&#10;                          R.next_review_date  AS src_next_review_date,&#10;                          RT.register_type_id AS src_reg_type_id,&#10;                          RT.code             AS src_reg_type_code,&#10;                          --&#10;                          R1.registration_id  AS tgt_reg_id,&#10;                          R1.created_datetime AS tgt_created_datetime,&#10;                          R1.next_review_date AS tgt_next_review_date,&#10;                          --&#10;                          CASE&#10;                              WHEN R.created_datetime &lt; R1.created_datetime THEN&#10;                                  &#39;SRC&#39;&#10;                              WHEN R.created_datetime &gt; R1.created_datetime THEN&#10;                                  &#39;TGT&#39;&#10;                              WHEN R.created_datetime &#61; R1.created_datetime THEN&#10;                                  CASE WHEN R.registration_id &lt; R1.registration_id THEN &#39;SRC&#39; ELSE &#39;TGT&#39; END&#10;                          END AS what_to_deregister&#10;                          --&#10;                        FROM&#10;                            registration R&#10;                              INNER JOIN r_register_type RT ON RT.register_type_id &#61; R.register_type_id&#10;                              INNER JOIN registration R1 ON R1.offender_id &#61; l_tgt_offender_id&#10;                                                        AND R1.register_type_id &#61; R.register_type_id&#10;                                                        AND R1.soft_deleted &#61; 0&#10;                                                        AND R1.deregistered &#61; 0&#10;                                                        AND R1.registration_id &lt;&gt; R.registration_id&#10;                        WHERE R.ROWID &#61; p_row_id&#10;                          AND R.soft_deleted &#61; 0&#10;                          AND R.deregistered &#61; 0&#10;                          -- 2DO: check if we can have multiple REG on the Source?&#10;                          AND NOT EXISTS(&#10;                              SELECT 1&#10;                              FROM offender_merge_details&#10;                              WHERE source_offender_id &#61; l_src_offender_id&#10;                                AND target_offender_id &#61; l_tgt_offender_id&#10;                                AND table_name &#61; &#39;REGISTRATION&#39;&#10;                                AND target_pk_value &#61; R1.registration_id ) )&#10;                      --&#10;                      SELECT *&#10;                      FROM T&#10;                      ORDER BY&#10;                        DECODE(what_to_deregister, &#39;TGT&#39;, 0, 1),&#10;                        tgt_created_datetime,&#10;                        tgt_reg_id;&#10;                    --&#10;                    l_rec1 cs1%ROWTYPE;&#10;                    --&#10;                    l_found_flag BOOLEAN;&#10;                    --&#10;                    l_src_deregistered_flag VARCHAR2(1) :&#61; &#39;N&#39;;&#10;                    --&#10;                    PROCEDURE do_terminate_reg&#10;                    IS&#10;                        --&#10;                        l_proc5 VARCHAR2(50) :&#61; &#39;DO_CHECK_FOR_DUPL_REG.do_terminate_reg&#39;;&#10;                        --&#10;                        PROCEDURE do_upd_reg IS&#10;                        BEGIN&#10;                            --&#10;                            IF l_rec1.what_to_deregister &#61; &#39;SRC&#39; THEN&#10;                                --&#10;                                info( &#39;Deregistering the Source REG record&#39;, p_proc&#61;&gt;l_proc5 );&#10;                                --&#10;                                do_replace_fld_with_val( &#39;NEXT_REVIEW_DATE|DUPL_NEXT_REVIEW_DATE&#39;, NULL, PKG_Common.date_2_char(l_rec1.src_next_review_date) /*old_value*/, &#39;D&#39; );&#10;                                do_replace_fld_with_val( &#39;DEREGISTERED|DUPL_DEREGISTERED&#39;, &#39;1&#39;, &#39;0&#39; /*old_value*/, &#39;N&#39; );&#10;                                --&#10;                            ELSE&#10;                                --&#10;                                info( &#39;Deregistering the Target REG record&#39;, p_proc&#61;&gt;l_proc5 );&#10;                                --&#10;                                UPDATE registration SET&#10;                                  next_review_date &#61; NULL,&#10;                                  deregistered &#61; 1&#10;                                WHERE registration_id &#61; l_reg_id_DEREGISTERED;&#10;                                --&#10;                                do_add_omd_hist_rec(&#10;                                    x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                    --&#10;                                    p_fld_name     &#61;&gt; &#39;DUPL_NEXT_REVIEW_DATE&#39;,&#10;                                    p_data_type    &#61;&gt; &#39;D&#39;,&#10;                                    p_old_value    &#61;&gt; PKG_Common.date_2_char(l_rec1.tgt_next_review_date),&#10;                                    p_new_value    &#61;&gt; NULL,&#10;                                    p_tab_pk_value &#61;&gt; l_reg_id_DEREGISTERED );&#10;                                --&#10;                                do_add_omd_hist_rec(&#10;                                    x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                    --&#10;                                    p_fld_name     &#61;&gt; &#39;DUPL_DEREGISTERED&#39;,&#10;                                    p_data_type    &#61;&gt; &#39;N&#39;,&#10;                                    p_old_value    &#61;&gt; &#39;0&#39;,&#10;                                    p_new_value    &#61;&gt; &#39;1&#39;,&#10;                                    p_tab_pk_value &#61;&gt; l_reg_id_DEREGISTERED );&#10;                                --&#10;                            END IF;&#10;                            --&#10;                            IF l_reg_id_ACTIVE &gt; 0 THEN&#10;                                do_add_omd_hist_rec(&#10;                                    x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                    --&#10;                                    p_fld_name     &#61;&gt; &#39;DUPL_REGISTRATION_NOTES&#39;,&#10;                                    p_data_type    &#61;&gt; &#39;C&#39;,&#10;                                    p_old_value    &#61;&gt; NULL,&#10;                                    p_new_value    &#61;&gt; &#39;X&#39;,&#10;                                    p_tab_pk_value &#61;&gt; NULLIF(l_reg_id_ACTIVE, l_rec1.src_reg_id) );&#10;                                END IF;&#10;                            --&#10;                        END do_upd_reg;&#10;                        --&#10;                    BEGIN&#10;                        --&#10;                        do_upd_reg;&#10;                        --&#10;                    END do_terminate_reg;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN cs1;&#10;                    LOOP&#10;                        FETCH cs1 INTO l_rec1;&#10;                        EXIT WHEN cs1%NOTFOUND;&#10;                        --&#10;                        l_found_flag :&#61; TRUE;&#10;                        --&#10;                        IF l_rec1.what_to_deregister &#61; &#39;SRC&#39; THEN&#10;                            IF l_src_deregistered_flag &#61; &#39;Y&#39; THEN&#10;                                -- Src Registration has already been processed&#10;                                l_reg_id_DEREGISTERED :&#61; -1;&#10;                                l_reg_id_ACTIVE       :&#61; -1;&#10;                            ELSE&#10;                                l_reg_id_DEREGISTERED :&#61; l_rec1.src_reg_id;&#10;                                l_reg_id_ACTIVE       :&#61; l_rec1.tgt_reg_id;&#10;                            END IF;&#10;                        ELSIF l_rec1.what_to_deregister &#61; &#39;TGT&#39; THEN&#10;                            l_reg_id_DEREGISTERED :&#61; l_rec1.tgt_reg_id;&#10;                            l_reg_id_ACTIVE       :&#61; l_rec1.src_reg_id;&#10;                        ELSE&#10;                            l_reg_id_DEREGISTERED :&#61; -1;&#10;                            l_reg_id_ACTIVE       :&#61; -1;&#10;                        END IF;&#10;                        --&#10;                        info(&#10;                            &#39;[what_to_deregister&#61;&#39;    || l_rec1.what_to_deregister   || &#39;]&#39; ||&#10;                            &#39;[src_deregistered_flag&#61;&#39; || l_src_deregistered_flag     || &#39;]&#39; ||&#10;                            &#39;[REG_ID_deregistered&#61;&#39;   || l_reg_id_DEREGISTERED       || &#39;]&#39; ||&#10;                            &#39;[REG_ID_active&#61;&#39;         || l_reg_id_ACTIVE             || &#39;]&#39; ||&#10;                            &#39;[src_cr_dt&#61;&#39;             || l_rec1.src_created_datetime || &#39;]&#39; ||&#10;                            &#39;[tgt_cr_dt&#61;&#39;             || l_rec1.tgt_created_datetime || &#39;]&#39;,&#10;                            p_proc&#61;&gt;l_proc4 );&#10;                        --&#10;                        IF l_reg_id_DEREGISTERED &gt; 0 AND&#10;                           ( ( l_rec1.what_to_deregister &#61; &#39;TGT&#39; ) OR&#10;                             ( l_rec1.what_to_deregister &#61; &#39;SRC&#39; AND NOT (l_src_deregistered_flag &#61; &#39;Y&#39;) ) )&#10;                        THEN&#10;                            do_terminate_reg;&#10;                        END IF;&#10;                        --&#10;                        IF l_rec1.what_to_deregister &#61; &#39;SRC&#39; THEN&#10;                            l_src_deregistered_flag :&#61; &#39;Y&#39;;&#10;                        END IF;&#10;                        --&#10;                    END LOOP;&#10;                    CLOSE cs1;&#10;                    --&#10;                END do_check_for_dupl_reg;&#10;                --&#10;            BEGIN&#10;                --&#10;                do_check_for_dupl_reg;&#10;                --&#10;            END do_amend_REG;&#10;            --&#10;            PROCEDURE do_amend_REG_REVIEW&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_REG_REVIEW&#39;;&#10;                --&#10;                PROCEDURE do_soft_del_src_reg_review IS&#10;                    --&#10;                    CURSOR cs1 IS&#10;                      SELECT&#10;                        RR.registration_review_id,&#10;                        R.registration_id&#10;                      FROM&#10;                        registration_review RR&#10;                          INNER JOIN registration R ON R.registration_id &#61; RR.registration_id&#10;                      WHERE RR.ROWID &#61; p_row_id&#10;                        AND RR.soft_deleted &#61; 0&#10;                        AND R.soft_deleted &#61; 0&#10;                        AND R.deregistered &#61; 0&#10;                        --&#10;                        AND NOT (RR.completed &#61; &#39;Y&#39;)&#10;                        AND RR.review_date_due &gt;&#61; TRUNC(SYSDATE);&#10;                    --&#10;                    l_rec1 cs1%ROWTYPE;&#10;                    --&#10;                    l_found_flag BOOLEAN;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN cs1;&#10;                    FETCH cs1 INTO l_rec1;&#10;                    l_found_flag :&#61; cs1%FOUND;&#10;                    CLOSE cs1;&#10;                    --&#10;                    IF l_found_flag THEN&#10;                        -- Soft Delete the source RR record&#10;                        UPDATE registration_review SET&#10;                          soft_deleted           &#61; 1,&#10;                          --&#10;                          row_version           &#61; row_version + 1,&#10;                          last_updated_datetime &#61; LC_DATE_TIME,&#10;                          last_updated_user_id  &#61; LC_USER_ID&#10;                        WHERE ROWID &#61; p_row_id;&#10;                        --&#10;                        IF SQL%ROWCOUNT &#61; 0 THEN&#10;                            fatal(&#39;FAILED to set the REGISTRATION_REVIEW.soft_deleted in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                        ELSE&#10;                            do_replace_fld_with_val( &#39;SOFT_DELETED&#39;, &#39;1&#39;, &#39;0&#39; /*old_value*/, &#39;N&#39; );&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END do_soft_del_src_reg_review;&#10;                --&#10;            BEGIN&#10;                --&#10;                do_soft_del_src_reg_review;&#10;                --&#10;            END do_amend_REG_REVIEW;&#10;            --&#10;            PROCEDURE do_amend_DOC&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;do_amend_DOC&#39;;&#10;                --&#10;                PROCEDURE do_upd_precons&#10;                IS&#10;                    --&#10;                    CURSOR csDoc(p_off_id NUMBER, p_row_id_1 ROWID) IS&#10;                      SELECT&#10;                        O.crn,&#10;                        O.offender_id,&#10;                        --&#10;                        D.document_name               AS prev_conviction_document_name,&#10;                        D.date_produced               AS previous_conviction_date,&#10;                        D.alfresco_document_id        AS prev_con_alfresco_document_id,&#10;                        D.last_updated_user_id        AS prev_con_created_by_user_id,&#10;                        D.created_datetime            AS prev_con_created_datetime,&#10;                        D.created_provider_id         AS prev_con_created_provider_id,&#10;                        D.last_updated_user_id        AS prev_con_last_updated_user_id,&#10;                        D.last_upd_author_provider_id AS prev_con_last_upd_auth_prov_id,&#10;                        --&#10;                        D.document_id                 AS prev_con_document_id&#10;                        --&#10;                      FROM&#10;                        document D&#10;                          INNER JOIN offender O ON O.offender_id &#61; D.offender_id&#10;                      WHERE D.ROWID &#61; NVL(p_row_id_1, D.ROWID)&#10;                        AND D.table_name &#61; &#39;OFFENDER&#39;&#10;                        AND D.offender_id &#61; p_off_id&#10;                        AND D.primary_key_id &#61; TO_CHAR(p_off_id)&#10;                        AND D.document_type  &#61; &#39;PREVIOUS_CONVICTION&#39;&#10;                        AND D.soft_deleted   &#61; 0;&#10;                    --&#10;                    l_rec_src csDoc%ROWTYPE;&#10;                    l_rec_tgt csDoc%ROWTYPE;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN csDoc(l_src_offender_id, p_row_id);&#10;                    FETCH csDoc INTO l_rec_src;&#10;                    CLOSE csDoc;&#10;                    --&#10;                    IF l_rec_src.prev_con_alfresco_document_id IS NULL THEN&#10;                        RETURN;&#10;                    END IF;&#10;                    --&#10;                    OPEN csDoc(l_tgt_offender_id, NULL);&#10;                    FETCH csDoc INTO l_rec_tgt;&#10;                    CLOSE csDoc;&#10;                    --&#10;                    -- Still need to process the Src PRECON&#10;                    --IF l_rec_tgt.prev_con_alfresco_document_id IS NULL THEN&#10;                    --    RETURN;&#10;                    --END IF;&#10;                    --&#10;                    IF l_rec_src.prev_con_created_datetime &gt;&#61; l_rec_tgt.prev_con_created_datetime THEN&#10;                        g_merge_ctx_rec.move_precon_doc :&#61; &#39;Y&#39;;&#10;                    ELSE&#10;                        g_merge_ctx_rec.move_precon_doc :&#61; &#39;N&#39;;&#10;                    END IF;&#10;                    --&#10;                    info(&#10;                        &#39;DO_UPD_PRECONS &#39; ||&#10;                        &#39;[src_row_id&#61;&#39;          || p_row_id                        || &#39;]&#39; ||&#10;--                        &#39;[src_off_id&#61;&#39;          || l_src_offender_id               || &#39;]&#39; ||&#10;--                        &#39;[tgt_off_id&#61;&#39;          || l_tgt_offender_id               || &#39;]&#39; ||&#10;                        --&#10;                        &#39;[src_off_id&#61;&#39;          || l_rec_src.offender_id           || &#39;]&#39; ||&#10;                        &#39;[src_crn&#61;&#39;             || l_rec_src.crn                   || &#39;]&#39; ||&#10;                        &#39;[tgt_off_id&#61;&#39;          || l_rec_tgt.offender_id           || &#39;]&#39; ||&#10;                        &#39;[tgt_crn&#61;&#39;             || l_rec_tgt.crn                   || &#39;]&#39; ||&#10;                        &#39;[move_precon_flag&#61;&#39;    || g_merge_ctx_rec.move_precon_doc || &#39;]&#39; ||&#10;                        --&#10;                        &#39;[src_prev_con_doc_id&#61;&#39; || l_rec_src.prev_con_document_id          || &#39;]&#39; ||&#10;                        &#39;[src_prev_con_alf_id&#61;&#39; || l_rec_src.prev_con_alfresco_document_id || &#39;]&#39; ||&#10;                        &#39;[tgt_prev_con_doc_id&#61;&#39; || l_rec_tgt.prev_con_document_id          || &#39;]&#39; ||&#10;                        &#39;[tgt_prev_con_alf_id&#61;&#39; || l_rec_tgt.prev_con_alfresco_document_id || &#39;]&#39;,&#10;                        --&#10;                        --p_trace_level &#61;&gt; 15,&#10;                        p_proc &#61;&gt; l_proc3 );&#10;                    --&#10;                    IF l_rec_tgt.prev_con_alfresco_document_id IS NOT NULL THEN&#10;                        --&#10;                        IF g_merge_ctx_rec.move_precon_doc &#61; &#39;Y&#39; THEN&#10;                            --&#10;                            -- YF: Soft delete original PRECON document on the Target side&#10;                            UPDATE document SET soft_deleted &#61; 1&#10;                            WHERE offender_id &#61; l_rec_tgt.offender_id&#10;                              AND document_id &#61; l_rec_tgt.prev_con_document_id;&#10;                            --&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; &#39;SOFT_DELETED&#39;,&#10;                                p_data_type    &#61;&gt; &#39;N&#39;,&#10;                                p_old_value    &#61;&gt; &#39;0&#39; ,&#10;                                p_new_value    &#61;&gt; &#39;1&#39;,&#10;                                p_tab_pk_value &#61;&gt; l_rec_tgt.prev_con_document_id );&#10;                            --&#10;                        ELSIF g_merge_ctx_rec.move_precon_doc &#61; &#39;N&#39; THEN&#10;                            do_replace_fld_with_val( &#39;SOFT_DELETED&#39;, &#39;1&#39;, &#39;0&#39; /*old_value*/, &#39;N&#39; );&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                    -- DST-13409: Update the original Source record&#10;                    do_add_omd_hist_rec(&#10;                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                        --&#10;                        p_fld_name     &#61;&gt; &#39;PRECON_SOFT_DELETED&#39;,&#10;                        p_data_type    &#61;&gt; &#39;N&#39;,&#10;                        p_old_value    &#61;&gt; &#39;0&#39; ,&#10;                        p_new_value    &#61;&gt; &#39;1&#39;,&#10;                        p_tab_pk_value &#61;&gt; l_rec_src.prev_con_document_id );&#10;                    --&#10;                END do_upd_precons;&#10;                --&#10;            BEGIN&#10;                --&#10;                do_upd_precons;&#10;                --&#10;            END do_amend_DOC;&#10;            --&#10;            PROCEDURE do_amend_CONTACT&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_CONTACT&#39;;&#10;                --&#10;                l_id                 NUMBER;&#10;                l_external_reference CONTACT.external_reference%TYPE;&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT&#10;                  nomis_case_note_id,&#10;                  external_reference&#10;                INTO&#10;                  l_id,&#10;                  l_external_reference&#10;                FROM contact&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                IF l_id IS NOT NULL THEN&#10;                    --&#10;                    UPDATE contact SET nomis_case_note_id &#61; NULL WHERE ROWID &#61; p_row_id;&#10;                    --&#10;                    IF SQL%ROWCOUNT &#61; 0 THEN&#10;                        fatal(&#39;FAILED to clear the CONTACT.nomis_case_note_id in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                    ELSE&#10;                        do_replace_fld_with_val( &#39;NOMIS_CASE_NOTE_ID&#39;, l_id, NULL, &#39;N&#39; );&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;                IF l_external_reference IS NOT NULL THEN&#10;                    --&#10;                    UPDATE contact SET external_reference &#61; NULL WHERE ROWID &#61; p_row_id;&#10;                    --&#10;                    IF SQL%ROWCOUNT &#61; 0 THEN&#10;                        fatal(&#39;FAILED to clear the CONTACT.external_reference in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                    ELSE&#10;                        do_replace_fld_with_val( &#39;EXTERNAL_REFERENCE&#39;, l_external_reference, NULL, &#39;C&#39; );&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_amend_CONTACT;&#10;            --&#10;            PROCEDURE do_amend_EVENT&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_EVENT&#39;;&#10;                --&#10;                PROCEDURE do_upd_event_num&#10;                IS&#10;                    --&#10;                    l_soft_deleted     EVENT.soft_deleted%TYPE;&#10;                    l_created_datetime DATE;&#10;                    --&#10;                    l_event_number     EVENT.event_number%TYPE;&#10;                    l_event_number1    INTEGER;&#10;                    l_event_number2    INTEGER;&#10;                    l_event_number_max INTEGER;&#10;                    l_event_number3    INTEGER;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    SELECT&#10;                      event_number,&#10;                      created_datetime,&#10;                      soft_deleted&#10;                    INTO&#10;                      l_event_number,&#10;                      l_created_datetime,&#10;                      l_soft_deleted&#10;                    FROM event&#10;                    WHERE ROWID &#61; p_row_id;&#10;                    --&#10;                    IF l_soft_deleted &#61; 1 THEN&#10;                        g_merge_ctx_rec.src_event_soft_deleted_CNT :&#61; NVL(g_merge_ctx_rec.src_event_soft_deleted_CNT, 0) + 1;&#10;                    END IF;&#10;                    --&#10;                    SELECT&#10;                      MAX(CASE WHEN created_datetime &lt;&#61; l_created_datetime THEN NVL(PKG_Common.char_2_number(event_number), 1) END),&#10;                      MIN(CASE WHEN created_datetime &gt;  l_created_datetime THEN NVL(PKG_Common.char_2_number(event_number), 2) END),&#10;                      MAX(PKG_Common.char_2_number(event_number))&#10;                    INTO&#10;                      l_event_number1,&#10;                      l_event_number2,&#10;                      l_event_number_max&#10;                    FROM event&#10;                    WHERE offender_id &#61; l_tgt_offender_id;&#10;                    --&#10;                    IF l_event_number2 - l_event_number1 &gt; 1 THEN&#10;                        l_event_number3 :&#61; l_event_number1 + 1;&#10;                    ELSE&#10;                        l_event_number3 :&#61; l_event_number_max + 1;&#10;                    END IF;&#10;                    --&#10;                    IF l_event_number &lt;&gt; TO_CHAR(l_event_number3) THEN&#10;                        do_replace_fld_with_val( &#39;EVENT_NUMBER&#39;, l_event_number3, l_event_number, &#39;C&#39; );&#10;                    END IF;&#10;                    --&#10;                END do_upd_event_num;&#10;                --&#10;                PROCEDURE do_upd_court_case_urn&#10;                IS&#10;                    --&#10;                    l_found_flag BOOLEAN;&#10;                    --&#10;                    CURSOR cs IS&#10;                      SELECT&#10;                        event_id,&#10;                        court_case_urn&#10;                      FROM event E&#10;                      WHERE ROWID &#61; p_row_id&#10;                        AND court_case_urn IS NOT NULL&#10;                        AND EXISTS (&#10;                            SELECT 1&#10;                            FROM event&#10;                            WHERE offender_id &#61; l_tgt_offender_id&#10;                              AND court_case_urn &#61; E.court_case_urn );&#10;                    --&#10;                    l_rec cs%ROWTYPE;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN cs;&#10;                    FETCH cs INTO l_rec;&#10;                    l_found_flag :&#61; cs%FOUND;&#10;                    CLOSE cs;&#10;                    --&#10;                    /*raise_application_error(-20001,&#10;                      &#39;DO_AMEND_EVENT.do_upd_court_case_urn: &#39;  ||&#10;                      &#39;[src_event_row_id&#61;&#39; || p_row_id          || &#39;]&#39; ||&#10;                      &#39;[src_offender_id&#61;&#39;  || l_src_offender_id || &#39;]&#39; ||&#10;                      &#39;[tgt_offender_id&#61;&#39;  || l_tgt_offender_id || &#39;]&#39; ||&#10;                      &#39;[found_dupl_urn&#61;&#39;   || PKG_Common.bool_2_char(l_found_flag) || &#39;]&#39; );*/&#10;                    --&#10;                    IF l_found_flag  THEN&#10;                        do_replace_fld_with_val( &#39;COURT_CASE_URN&#39;, NULL, l_rec.court_case_urn /*old_value*/, &#39;C&#39; );&#10;                    END IF;&#10;                    --&#10;                END do_upd_court_case_urn;&#10;                --&#10;            BEGIN&#10;                --&#10;                do_upd_event_num;&#10;                do_upd_court_case_urn;&#10;                --&#10;            END do_amend_EVENT;&#10;            --&#10;            PROCEDURE do_amend_AI&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_AI&#39;;&#10;                --&#10;                l_soft_deleted ADDITIONAL_IDENTIFIER.soft_deleted%TYPE;&#10;                l_ai_type_code R_STANDARD_REFERENCE_LIST.code_value%TYPE;&#10;                --&#10;        BEGIN&#10;            --&#10;                SELECT&#10;                  R.code_value AS ai_type_code,&#10;                  AI.soft_deleted&#10;                INTO&#10;                  l_ai_type_code,&#10;                  l_soft_deleted&#10;                FROM&#10;                  additional_identifier AI&#10;                    INNER JOIN r_standard_reference_list R ON R.standard_reference_list_id &#61; AI.identifier_name_id&#10;                WHERE AI.ROWID &#61; p_row_id;&#10;                --&#10;                IF l_ai_type_code &#61; &#39;IMMN&#39; AND&#10;                   NOT (g_merge_ctx_rec.move_immigration_number &#61; &#39;Y&#39; ) AND&#10;                   l_soft_deleted &#61; 0&#10;                THEN&#10;                    do_replace_fld_with_val( &#39;SOFT_DELETED&#39;, &#39;1&#39;, &#39;0&#39; /*old_value*/, &#39;N&#39; );&#10;                END IF;&#10;                --&#10;            END do_amend_AI;&#10;            --&#10;            PROCEDURE do_amend_NSI&#10;            IS&#10;                --&#10;                l_proc3 VARCHAR2(30) :&#61; &#39;DO_AMEND_NSI&#39;;&#10;                --&#10;                l_external_reference  NSI.external_reference%TYPE;&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT external_reference INTO l_external_reference&#10;                FROM nsi&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                UPDATE nsi SET external_reference &#61; NULL&#10;                WHERE ROWID &#61; p_row_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#39;FAILED to clear the NSI.external_reference in the source record [pk&#61;&#39; || l_src_pk_key_val || &#39;][row_id&#61;&#39; || p_row_id || &#39;]&#39;, l_proc3);&#10;                ELSE&#10;                    do_replace_fld_with_val( &#39;EXTERNAL_REFERENCE&#39;, l_external_reference, NULL, &#39;C&#39; );&#10;                END IF;&#10;                --&#10;            END do_amend_NSI;&#10;            --&#10;        BEGIN&#10;            --&#10;            l_new_lst :&#61; &#39;,&#39; || UPPER(REPLACE(TRIM(p_fld_lst), &#39;, &#39;, &#39;,&#39;)) || &#39;,&#39;;&#10;            --&#10;            IF NVL(l_pk_composite_flag, &#39;N&#39;) &lt;&gt; &#39;Y&#39; THEN&#10;                 -- 1a. Normal - surrogate (Single-column) PK key case&#10;                do_replace_fld_with_val( PKG_DynSQL.get_tab_pk_fld_lst(p_table), l_tgt_pk_key_val , l_src_pk_key_val, &#39;N&#39; );&#10;            ELSE&#10;                -- 1b. Composite PK key case: 1st column is always the Parent Table&#39;s PK&#10;                do_replace_fld_with_val( PKG_DynSQL.get_tab_pk_fld_lst(p_parent_table), l_tgt_fk_key_val, l_src_fk_key_val, &#39;N&#39; );&#10;            END IF;&#10;            --&#10;            -- Replace &lt;parent table&gt;_ID parent key&#10;            do_replace_fld_with_val( PKG_DynSQL.get_tab_pk_fld_lst(p_parent_table), l_tgt_fk_key_val , l_src_fk_key_val, &#39;N&#39; );&#10;            --&#10;            -- Replace OFFENDER_ID parent key&#10;            do_replace_fld_with_val( &#39;OFFENDER_ID&#39;, l_tgt_offender_id, l_src_offender_id, &#39;N&#39; );&#10;            --&#10;            IF p_table &#61; &#39;OFFENDER_RELIGION_HISTORY&#39; THEN&#10;                -- 3. OFFENDER_RELIGION_HISTORY.end_date&#10;                do_amend_off_religion_hist;&#10;            END IF;&#10;            IF p_table &#61; &#39;MANAGEMENT_TIER&#39; THEN&#10;                -- 4. MANAGEMENT_TIER&#10;                do_amend_management_tier;&#10;            END IF;&#10;            IF p_table &#61; &#39;DOCUMENT&#39; THEN&#10;                -- 5a. PRECON Document&#10;                do_amend_DOC;&#10;            END IF;&#10;            IF p_table IN ( &#39;DOCUMENT&#39;, &#39;EVENT&#39;, &#39;OFFENDER&#39; ) THEN&#10;                -- 5b. Alfresco Document ID /&#10;                do_amend_alf_doc_id;&#10;            END IF;&#10;            IF p_table &#61; &#39;OFFENDER_MANAGER&#39; THEN&#10;                -- Offender Manager&#10;                do_amend_OM;&#10;            END IF;&#10;            IF p_table &#61; &#39;PRISON_OFFENDER_MANAGER&#39; THEN&#10;                -- Prison Offender Manager&#10;                do_amend_POM;&#10;            END IF;&#10;            IF p_table &#61; &#39;RESPONSIBLE_OFFICER&#39; THEN&#10;                -- Responsible Officer&#10;                do_amend_RO;&#10;            END IF;&#10;            IF p_table &#61; &#39;OFFENDER_ADDRESS&#39; THEN&#10;                -- 7. Offender ADDRESS&#10;                do_amend_OA;&#10;            END IF;&#10;            IF p_table &#61; &#39;REGISTRATION&#39; THEN&#10;                -- 7a. Registration&#10;                do_amend_REG;&#10;            END IF;&#10;            IF p_table &#61; &#39;REGISTRATION_REVIEW&#39; THEN&#10;                -- 7b. Registration Review&#10;                do_amend_REG_REVIEW;&#10;            END IF;&#10;            IF p_table &#61; &#39;CONTACT&#39; THEN&#10;                -- 8a. CONTACT.nomis_case_note_id (XAK1CONTACT unique constraint)&#10;                do_amend_CONTACT;&#10;            END IF;&#10;            IF p_table &#61; &#39;EVENT&#39; THEN&#10;                -- 8. EVENT.event_number&#10;                --raise_application_error(-20001, &#39;do_amend_EVENT&#39;);&#10;                do_amend_EVENT;&#10;            END IF;&#10;            --IF p_table &#61; &#39;SUBJECT_ACCESS_REPORT&#39; THEN&#10;            --    -- 9. SUBJECT_ACCESS_REPORT.generation_status&#10;            --    do_amend_SAR;&#10;            --END IF;&#10;            IF p_table &#61; &#39;OFFENDER_TRANSFER&#39; THEN&#10;                -- 10. OFFENDER_TRANSFER.soft_deleted (on the source)&#10;                do_amend_OT;&#10;            END IF;&#10;            IF p_table &#61; &#39;APPROVED_PREMISES_REFERRAL&#39; THEN&#10;                -- 11. APPROVED_PREMISES_REFERRAL.soft_deleted (on the source)&#10;                do_amend_AP;&#10;            END IF;&#10;            IF p_table &#61; &#39;ADDITIONAL_IDENTIFIER&#39; THEN&#10;                -- 12. ADDITIONAL_IDENTIFIER.soft_deleted&#10;                do_amend_AI;&#10;            END IF;&#10;            IF p_table &#61; &#39;NSI&#39; THEN&#10;                -- 13. NSI.external_reference&#10;                do_amend_NSI;&#10;            END IF;&#10;            --&#10;            --&#10;            -- 2DO: Last Touch columns: derive from the SRC or set to new  values?&#10;            -- 5. Last Touch columns&#10;            --do_replace_fld_with_val(&#39;CREATED_DATETIME&#39;     , PKG_Common.date_2_char(LC_DATE_TIME), NULL, &#39;D&#39;);&#10;            --do_replace_fld_with_val(&#39;LAST_UPDATED_DATETIME&#39;, PKG_Common.date_2_char(LC_DATE_TIME), NULL, &#39;D&#39;);&#10;            -- 6. Row Version column&#10;            --do_replace_fld_with_val(&#39;ROW_VERSION&#39;, &#39;0&#39;, NULL, &#39;N&#39;);&#10;            --&#10;            l_new_lst :&#61; RTRIM(LTRIM(l_new_lst, &#39;,&#39;), &#39;,&#39;);&#10;            --&#10;            RETURN l_new_lst;&#10;            --&#10;        END do_substitute_key_values;&#10;        --&#10;    BEGIN&#10;        --&#10;        l_tgt_fld_list_1 :&#61; PKG_DynSQL.get_tab_fld_lst_1(p_table);&#10;        l_tgt_fld_list_2 :&#61; do_substitute_key_values(l_tgt_fld_list_1);&#10;        --&#10;        info(&#10;            &#39;DO_SUBSTITUTE_KEY_VALUES &#39;            ||&#10;            &#39;[parent_tab&#61;&#39;    || p_parent_table    || &#39;]&#39; ||&#10;            &#39;[tab&#61;&#39;           || p_table           || &#39;]&#39; ||&#10;            &#39;[old_off_id&#61;&#39;    || l_src_offender_id || &#39;]&#39; ||&#10;            &#39;[new_off_id&#61;&#39;    || l_tgt_offender_id || &#39;]&#39; ||&#10;            &#39;[old_pk&#61;&#39;        || l_src_pk_key_val  || &#39;]&#39; ||&#10;            &#39;[new_pk&#61;&#39;        || l_tgt_pk_key_val  || &#39;]&#39; ||&#10;            &#39;[old_fk&#61;&#39;        || l_src_fk_key_val  || &#39;]&#39; ||&#10;            &#39;[new_fk&#61;&#39;        || l_tgt_fk_key_val  || &#39;]&#39; || CHR(10) ||&#10;            &#39;[orig_fld_lst&#61;&#39;  || l_tgt_fld_list_1  || &#39;]&#39; || CHR(10) ||&#10;            &#39;[new_fld_lst&#61;&#39;   || l_tgt_fld_list_2  || &#39;]&#39;,&#10;            --&#10;            p_trace_level &#61;&gt; 20,&#10;            p_proc        &#61;&gt; l_proc1 );&#10;        --&#10;        l_SQL :&#61;&#10;            &#39;INSERT INTO &#39; || p_table || &#39;(&#10;            &#39; || PKG_DynSQL.get_tab_fld_lst(p_table) || &#39;)&#10;             SELECT &#39; || l_tgt_fld_list_2 || &#39;&#10;             FROM &#39; || p_table || &#39;&#10;             WHERE ROWID &#61; :p_row_id&#39;;&#10;        EXECUTE IMMEDIATE l_SQL USING p_row_id;&#10;        --&#10;    EXCEPTION WHEN OTHERS THEN&#10;        --&#10;--        DBMS_OUTPUT.put_line(&#10;--            &#39;Error in DO_INS_TARGET_RECORD: &#39; || SQLERRM || CHR(10) ||&#10;--            l_SQL );&#10;        --&#10;        fatal(&#10;            &#39;FAILED to INSERT a record INTO &#39; || p_table || &#39; WHERE source_rowid&#61;&#39; || ROWIDTOCHAR(p_row_id) || CHR(10) ||&#10;            get_dq_message(SQLERRM) || CHR(10) ||&#10;            &#39;SQL: &#39; || l_SQL,&#10;            l_proc1 );&#10;        --&#10;    END do_ins_target_record;&#10;    --&#10;    PROCEDURE generate_new_pk_values&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;GENERATE_NEW_PK_VALUES&#39;;&#10;        --&#10;        FUNCTION get_new_pk_value RETURN VARCHAR2&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;GET_NEW_PK_VALUE&#39;;&#10;            --&#10;            l_seq_name VARCHAR2(100);&#10;            l_new_val  VARCHAR2(4000);&#10;        BEGIN&#10;            --&#10;            l_seq_name :&#61; PKG_DynSQL.get_tab_seq_name(p_table);&#10;            EXECUTE IMMEDIATE &#39;SELECT &#39; || l_seq_name || &#39;.nextval FROM dual&#39;&#10;            INTO l_new_val;&#10;            --&#10;            RETURN l_new_val;&#10;        EXCEPTION WHEN OTHERS THEN&#10;            fatal(&#10;                &#39;FAILED to generate the new PK value for &#39; || p_table || &#39; [pk&#61;&#39; || PKG_DynSQL.get_tab_pk_fld_lst(p_table, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1) || &#39;][seq&#61;&#39; || l_seq_name || &#39;]&#39; || CHR(10) ||&#10;                get_dq_message(SQLERRM) || CHR(10) ||&#10;                &#39;SQL: &#39; || l_SQL,&#10;                l_proc2 );&#10;        END get_new_pk_value;&#10;        --&#10;    BEGIN&#10;        --&#10;        l_tgt_pk_key_val    :&#61; NULL;&#10;        l_pk_composite_flag :&#61; &#39;N&#39;;&#10;        --&#10;        IF p_table IN (&#10;             &#39;CASE_ALLOCATION_LINK&#39;,&#10;             &#39;DRUGS_TEST_PROFILE_DRUG_TYPE&#39;,&#10;             &#39;MANAGEMENT_TIER&#39;,&#10;             &#39;OASYS_ASSMNT_SECTION_SCORE&#39;,&#10;             &#39;OASYS_SP_NEED&#39;,&#10;             &#39;OASYS_SP_TEXT&#39;,&#10;             &#39;OASYS_SP_WORK_SUMMARY&#39;,&#10;             &#39;OFFENDER_PRISONER&#39; )&#10;            OR&#10;            PKG_LstUtl.list_count_elem(PKG_DynSQL.get_tab_pk_fld_lst(p_table, &#39;,&#39;, -1)) &gt; 1&#10;        THEN&#10;            l_pk_composite_flag :&#61; &#39;Y&#39;;&#10;            l_tgt_pk_key_val :&#61; l_tgt_fk_key_val || &#39;:&#39; || PKG_LstUtl.list_num_tail(l_src_pk_key_val, p_num&#61;&gt;1, p_delim&#61;&gt;&#39;:&#39;);&#10;        ELSE&#10;            l_tgt_pk_key_val :&#61; get_new_pk_value;&#10;        END IF;&#10;        --&#10;    END generate_new_pk_values;&#10;    --&#10;BEGIN&#10;    g_label :&#61; &#39;20000&#39;;&#10;    --&#10;    -- Check if current record has not been mutated&#10;    g_label :&#61; &#39;20020&#39;;&#10;    do_check_src_record;&#10;    --&#10;    IF p_table &#61; &#39;OFFENDER&#39; THEN&#10;        --&#10;        l_already_processed :&#61; &#39;Y&#39;;&#10;        --&#10;        -- YF: moved to the top calling procedure&#10;--        -- Update Target Offender attributes (overwrite specified list of attributes)&#10;--        info(&#39;DO_UPD_OFFENDER [src_off_id&#61;&#39; || l_src_offender_id || &#39;][tgt_off_id&#61;&#39; || l_tgt_offender_id || &#39;]&#39;, p_trace_level&#61;&gt;15);&#10;--        do_upd_offender;&#10;        --&#10;    ELSE&#10;        -- Check if record had already been processed at the different hier. level&#10;        g_label :&#61; &#39;20050&#39;;&#10;        do_check_already_processed;&#10;        --&#10;        IF l_already_processed &#61; &#39;Y&#39; THEN&#10;            RETURN;&#10;        END IF;&#10;        --&#10;        IF p_table &#61; &#39;EQUALITY&#39; THEN&#10;            -- EQUALITY table: do not clone the Source record; there is 1:1 relationship to OFFENDER table&#10;            l_pk_composite_flag :&#61; &#39;N&#39;;&#10;            --&#10;            BEGIN&#10;                SELECT equality_id INTO l_tgt_pk_key_val&#10;                FROM equality&#10;                WHERE offender_id &#61; l_tgt_offender_id;&#10;            EXCEPTION WHEN NO_DATA_FOUND THEN&#10;                fatal( &#39;FAILED to locate EQUALITY record for the Target Offender&#39;, l_proc );&#10;            END;&#10;            --&#10;        ELSE&#10;            -- Generate new PK value&#10;            g_label :&#61; &#39;20100&#39;;&#10;            generate_new_pk_values;&#10;            --&#10;            -- Insert Current Record&#10;            g_label :&#61; &#39;20200&#39;;&#10;            do_ins_target_record;&#10;            --&#10;        END IF;&#10;        --&#10;    END IF;&#10;    --&#10;    -- Insert LOG record in OFFENDER_MERGE_DETAILS table&#10;    g_label :&#61; &#39;20300&#39;;&#10;    do_ins_omd_rec(&#10;        -- Overload 1&#10;        p_hierarchy_level  &#61;&gt; p_recursive_level-1,&#10;        p_parent_table     &#61;&gt; p_parent_table,&#10;        p_table_name       &#61;&gt; p_table,&#10;        p_src_offender_id  &#61;&gt; l_src_offender_id,&#10;        p_tgt_offender_id  &#61;&gt; l_tgt_offender_id,&#10;        p_src_pk_value     &#61;&gt; l_src_pk_key_val,&#10;        p_tgt_pk_value     &#61;&gt; l_tgt_pk_key_val,&#10;        p_src_fk_value     &#61;&gt; l_src_fk_key_val,&#10;        p_tgt_fk_value     &#61;&gt; l_tgt_fk_key_val,&#10;        p_debug_notes      &#61;&gt; &#39;SQL INSERT INTO &#39; || p_table || &#39;: SELECT &#39; || l_tgt_fld_list_2 || &#39; FROM &#39; || p_table || &#39; WHERE ROWID &#61; :p_row_id&#39;,&#10;        x_changes_log_TAB  &#61;&gt; l_changes_log_TAB,&#10;        p_off_merge_det_id &#61;&gt; l_off_merge_det_id );&#10;    --&#10;END off_merge_curr_rec;&#10;--&#10;PROCEDURE procMergeOffenders_NEW(&#10;    p_source_offender_crn       VARCHAR2,&#10;    p_target_offender_crn       VARCHAR2,&#10;    --&#10;    p_move_crn                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_dob                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_first_name           VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_gender               VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_prev_name            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_second_name          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_surname              VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_third_name           VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_title                VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_cro                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_date_died            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_email                VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_mobile               VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ni                   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_noms                 VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_pnc                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_sms                  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_telephone            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ethnicity            VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_ethnicity_1          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_immigration_number   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_immigration_status   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_interpreter_required VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_language             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_nationality          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_religion             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_second_nationality   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_sexual_orientation   VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_move_provider             VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_main_address         VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_move_postal_address       VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_move_responsible_officer  VARCHAR2 DEFAULT &#39;N&#39;,&#10;    --&#10;    p_bg_flag         VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_debug_flag      VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_proc VARCHAR2(30) :&#61; &#39;procMergeOffenders_NEW&#39;;&#10;    --&#10;    LC_USER_ID          NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;    LC_DATE_TIME        DATE   :&#61; SYSDATE;&#10;    LC_DATE             DATE   :&#61; TRUNC(LC_DATE_TIME);&#10;    --&#10;    l_src_offender_id  NUMBER;&#10;    l_tgt_offender_id  NUMBER;&#10;    --&#10;    l_already_merged   VARCHAR2(1);&#10;    l_merged_date_time DATE;&#10;    --&#10;    l_src_row_id       ROWID;&#10;    l_tgt_row_id       ROWID;&#10;    --&#10;    l_off_TAB T_TAB_ORGANISATIONS;&#10;    l_omd_id  NUMBER;&#10;    --&#10;    l_changes_log_TAB  g_ch_log_tab_TYP :&#61; g_ch_log_tab_TYP();&#10;    --&#10;    PROCEDURE do_print_debug_details IS&#10;    BEGIN&#10;        --&#10;        IF PKG_Debug.funcGetDebugActive THEN&#10;            procDebug(&#10;                PKG_LstUtl.concat(&#10;                    &#39;procMergeOffenders_NEW: (&#39;,&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_source_offender_crn&#61;&gt;&#39;&#39;&#39;, p_source_offender_crn), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_target_offender_crn&#61;&gt;&#39;&#39;&#39;, p_target_offender_crn), &#39;&#39;&#39;, &#39;),&#10;                    --&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_crn&#61;&gt;&#39;&#39;&#39;, p_move_crn), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_dob&#61;&gt;&#39;&#39;&#39;, p_move_dob), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_first_name&#61;&gt;&#39;&#39;&#39;, p_move_first_name), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_gender&#61;&gt;&#39;&#39;&#39;, p_move_gender), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_prev_name&#61;&gt;&#39;&#39;&#39;, p_move_prev_name), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_second_name&#61;&gt;&#39;&#39;&#39;, p_move_second_name), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_surname&#61;&gt;&#39;&#39;&#39;, p_move_surname), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_third_name&#61;&gt;&#39;&#39;&#39;, p_move_third_name), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_title&#61;&gt;&#39;&#39;&#39;, p_move_title), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_cro&#61;&gt;&#39;&#39;&#39;, p_move_cro), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_date_died&#61;&gt;&#39;&#39;&#39;, p_move_date_died), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_email&#61;&gt;&#39;&#39;&#39;, p_move_email), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_mobile&#61;&gt;&#39;&#39;&#39;, p_move_mobile), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_ni&#61;&gt;&#39;&#39;&#39;, p_move_ni), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_noms&#61;&gt;&#39;&#39;&#39;, p_move_noms), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_pnc&#61;&gt;&#39;&#39;&#39;, p_move_pnc), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_sms&#61;&gt;&#39;&#39;&#39;, p_move_sms), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_telephone&#61;&gt;&#39;&#39;&#39;, p_move_telephone), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_ethnicity&#61;&gt;&#39;&#39;&#39;, p_move_ethnicity), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_ethnicity_1&#61;&gt;&#39;&#39;&#39;, p_move_ethnicity_1), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_immigration_number&#61;&gt;&#39;&#39;&#39;, p_move_immigration_number), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_immigration_status&#61;&gt;&#39;&#39;&#39;, p_move_immigration_status), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_interpreter_required&#61;&gt;&#39;&#39;&#39;, p_move_interpreter_required), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_language&#61;&gt;&#39;&#39;&#39;, p_move_language), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_nationality&#61;&gt;&#39;&#39;&#39;, p_move_nationality), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_religion&#61;&gt;&#39;&#39;&#39;, p_move_religion), &#39;&#39;&#39;, &#39;),&#10;                    --PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_religion_desc&#61;&gt;&#39;&#39;&#39;, p_move_religion_desc), &#39;&#39;&#39;, &#39;),&#10;                    --PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_off_religion_hist_cnt&#61;&gt;&#39;&#39;&#39;, p_off_religion_hist_cnt), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_second_nationality&#61;&gt;&#39;&#39;&#39;, p_move_second_nationality), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_sexual_orientation&#61;&gt;&#39;&#39;&#39;, p_move_sexual_orientation), &#39;&#39;&#39;, &#39;),&#10;                    --&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_provider&#61;&gt;&#39;&#39;&#39;, p_move_provider), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_main_address&#61;&gt;&#39;&#39;&#39;, p_move_main_address), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_postal_address&#61;&gt;&#39;&#39;&#39;, p_move_postal_address), &#39;&#39;&#39;, &#39;),&#10;                    --&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_move_responsible_officer&#61;&gt;&#39;&#39;&#39;, p_move_responsible_officer), &#39;&#39;&#39;, &#39;),&#10;                    --&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_bg_flag&#61;&gt;&#39;&#39;&#39;, p_bg_flag), &#39;&#39;&#39;, &#39;),&#10;                    PKG_LstUtl.add_postfix(PKG_LstUtl.add_prefix(&#39;p_debug_flag&#61;&gt;&#39;&#39;&#39;, p_debug_flag), &#39;&#39;&#39; )&#39;),&#10;                    --&#10;                    p_delim &#61;&gt; CHR(10) ) );&#10;            --&#10;        END IF;&#10;        --&#10;    END do_print_debug_details;&#10;    --&#10;    PROCEDURE do_reset_iaps_flags(p_pre_or_post_flag VARCHAR2) IS&#10;    BEGIN&#10;        IF p_pre_or_post_flag &#61; &#39;PRE&#39; THEN&#10;            --&#10;            g_label :&#61; &#39;200010&#39;;&#10;            --&#10;            /* nDelius DataMaintenanceBean.mergeOffenders JAVA code:&#10;            --&#9;&#9;// Read IAPS flag before merge as data will change post merge&#10;            */&#10;            g_merge_ctx_rec.src_iaps_of_interest :&#61; get_iaps_flag(l_src_offender_id);&#10;            g_merge_ctx_rec.tgt_iaps_of_interest :&#61; get_iaps_flag(l_tgt_offender_id);&#10;            --&#10;            g_label :&#61; &#39;200020&#39;;&#10;            --&#10;            IF 1 &#61; g_merge_ctx_rec.src_iaps_of_interest THEN&#10;                --&#10;                g_label :&#61; &#39;200025&#39;;&#10;                --&#10;                do_upd_iaps_offender(l_src_offender_id, 2);&#10;            END IF;&#10;            --&#10;            g_label :&#61; &#39;249000&#39;;&#10;            --&#10;            -- 2DO: MERGE_HISTORY/MERGE_OFFENDER_VALUES update required?&#10;            --&#10;        ELSIF p_pre_or_post_flag &#61; &#39;POST&#39; THEN&#10;            --&#10;            g_label :&#61; &#39;600010&#39;;&#10;            --&#10;            /* nDelius DataMaintenanceBean.mergeOffenders JAVA code:&#10;            --&#9;if (g_merge_ctx_rec.src_iaps_of_interest)&#10;            */&#10;            --&#10;            IF 1 IN (g_merge_ctx_rec.src_iaps_of_interest, g_merge_ctx_rec.tgt_iaps_of_interest) THEN&#10;                do_upd_iaps_offender(l_tgt_offender_id, 1);&#10;            END IF;&#10;            --&#10;            g_label :&#61; &#39;649000&#39;;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_reset_iaps_flags;&#10;    --&#10;    PROCEDURE do_pre_merge&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_PRE_MERGE&#39;;&#10;        --&#10;        l_move_religion_desc    VARCHAR2(1);&#10;        l_off_religion_hist_cnt INTEGER;&#10;        --&#10;        PROCEDURE do_init_vars IS&#10;        BEGIN&#10;            --&#10;            SELECT&#10;              ROWID,&#10;              offender_id&#10;            INTO&#10;              l_src_row_id,&#10;              l_src_offender_id&#10;            FROM offender&#10;            WHERE crn &#61; p_source_offender_crn;&#10;            --&#10;            SELECT&#10;              ROWID,&#10;              offender_id,&#10;              DECODE(religion_description, NULL, &#39;Y&#39;, &#39;N&#39;)                                         AS move_religion_desc,&#10;              ( SELECT COUNT(1) FROM offender_religion_history WHERE offender_id &#61; O.offender_id ) AS off_religion_hist_cnt&#10;            INTO&#10;              l_tgt_row_id,&#10;              l_tgt_offender_id,&#10;              l_move_religion_desc,&#10;              l_off_religion_hist_cnt&#10;            FROM offender O&#10;            WHERE crn &#61; p_target_offender_crn;&#10;            --&#10;            l_off_TAB :&#61; T_TAB_ORGANISATIONS(l_src_offender_id, l_tgt_offender_id);&#10;            --&#10;            SELECT&#10;              (CASE WHEN COUNT(1) &gt; 0 THEN &#39;Y&#39; ELSE &#39;N&#39; END) AS already_merged,&#10;              LC_DATE_TIME                                   AS merge_date_time&#10;            INTO&#10;              l_already_merged,&#10;              l_merged_date_time&#10;            FROM offender_merge_details OMD&#10;            WHERE OMD.source_offender_id &#61; l_src_offender_id&#10;              AND OMD.table_name &#61; &#39;OFFENDER&#39;&#10;              AND OMD.source_pk_value &#61; l_src_offender_id;&#10;            --&#10;        END do_init_vars;&#10;        --&#10;    BEGIN&#10;        --&#10;        do_init_vars;&#10;        --&#10;        do_set_merge_ctx(&#10;            p_src_offender_id           &#61;&gt; l_src_offender_id,&#10;            p_tgt_offender_id           &#61;&gt; l_tgt_offender_id,&#10;            --&#10;            p_source_offender_crn       &#61;&gt; p_source_offender_crn,&#10;            p_target_offender_crn       &#61;&gt; p_target_offender_crn,&#10;            --&#10;            p_already_merged            &#61;&gt; l_already_merged,&#10;            p_merged_date_time          &#61;&gt; l_merged_date_time,&#10;            --&#10;            p_move_crn                  &#61;&gt; p_move_crn,&#10;            p_move_dob                  &#61;&gt; p_move_dob,&#10;            p_move_first_name           &#61;&gt; p_move_first_name,&#10;            p_move_gender               &#61;&gt; p_move_gender,&#10;            p_move_prev_name            &#61;&gt; p_move_prev_name,&#10;            p_move_second_name          &#61;&gt; p_move_second_name,&#10;            p_move_surname              &#61;&gt; p_move_surname,&#10;            p_move_third_name           &#61;&gt; p_move_third_name,&#10;            p_move_title                &#61;&gt; p_move_title,&#10;            p_move_cro                  &#61;&gt; p_move_cro,&#10;            p_move_date_died            &#61;&gt; p_move_date_died,&#10;            p_move_email                &#61;&gt; p_move_email,&#10;            p_move_mobile               &#61;&gt; p_move_mobile,&#10;            p_move_ni                   &#61;&gt; p_move_ni,&#10;            p_move_noms                 &#61;&gt; p_move_noms,&#10;            p_move_pnc                  &#61;&gt; p_move_pnc,&#10;            p_move_sms                  &#61;&gt; p_move_sms,&#10;            p_move_telephone            &#61;&gt; p_move_telephone,&#10;            p_move_ethnicity            &#61;&gt; p_move_ethnicity,&#10;            p_move_ethnicity_1          &#61;&gt; p_move_ethnicity_1,&#10;            p_move_immigration_number   &#61;&gt; p_move_immigration_number,&#10;            p_move_immigration_status   &#61;&gt; p_move_immigration_status,&#10;            p_move_interpreter_required &#61;&gt; p_move_interpreter_required,&#10;            p_move_language             &#61;&gt; p_move_language,&#10;            p_move_nationality          &#61;&gt; p_move_nationality,&#10;            p_move_religion             &#61;&gt; p_move_religion,&#10;            p_move_religion_desc        &#61;&gt; l_move_religion_desc,&#10;            p_off_religion_hist_cnt     &#61;&gt; l_off_religion_hist_cnt,&#10;&#10;            p_move_second_nationality   &#61;&gt; p_move_second_nationality,&#10;            p_move_sexual_orientation   &#61;&gt; p_move_sexual_orientation,&#10;            --&#10;            p_move_provider             &#61;&gt; p_move_provider,&#10;            p_move_main_address         &#61;&gt; p_move_main_address,&#10;            p_move_postal_address       &#61;&gt; p_move_postal_address,&#10;            --&#10;            p_move_responsible_officer  &#61;&gt; p_move_responsible_officer,&#10;            --&#10;            p_bg_flag                   &#61;&gt; p_bg_flag,&#10;            p_debug_flag                &#61;&gt; p_debug_flag );&#10;        --&#10;        IF l_already_merged &#61; &#39;Y&#39; THEN&#10;            fatal(&#39;Offender [crn&#61;&#39; || p_source_offender_crn || &#39;][id&#61;&#39; || l_src_offender_id || &#39;] has already been merged previously&#39;, l_proc1);&#10;        ELSE&#10;            -- Insert Top Level (HIER_LEVEL&#61;0) LOG record in OFFENDER_MERGE_DETAILS table&#10;            -- Memorise top OMD ID in L_OMD_ID variable&#10;            do_ins_omd_rec(&#10;                -- Overload 2&#10;                p_hierarchy_level  &#61;&gt; 0,&#10;                p_parent_table     &#61;&gt; NULL,&#10;                p_table_name       &#61;&gt; &#39;OFFENDER&#39;,&#10;                p_src_offender_id  &#61;&gt; l_src_offender_id,&#10;                p_tgt_offender_id  &#61;&gt; l_tgt_offender_id,&#10;                p_src_pk_value     &#61;&gt; l_src_offender_id,&#10;                p_tgt_pk_value     &#61;&gt; l_tgt_offender_id,&#10;                p_src_fk_value     &#61;&gt; NULL,&#10;                p_tgt_fk_value     &#61;&gt; NULL,&#10;                --&#10;                x_off_merge_det_id &#61;&gt; l_omd_id );&#10;            --&#10;            info(&#39;Top Level OMD ID&#61;&#39;  || l_omd_id, p_trace_level&#61;&gt;5, p_proc&#61;&gt;l_proc1);&#10;            --&#10;        END IF;&#10;        --&#10;        do_reset_iaps_flags(&#39;PRE&#39;);&#10;        --&#10;        ALFRESCOSUPPORT.removeOffendersFromQueue( offenderid_TAB_in&#61;&gt;l_off_TAB );&#10;        --&#10;    END do_pre_merge;&#10;    --&#10;    PROCEDURE do_post_merge&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_POST_MERGE&#39;;&#10;        --&#10;        PROCEDURE do_upd_offender&#10;        IS&#10;            --&#10;            CURSOR csO(p_off_id NUMBER) IS&#10;              SELECT&#10;                O.offender_id,&#10;                O.crn,&#10;                O.date_of_birth_date,&#10;                O.first_name,&#10;                O.gender_id,&#10;                O.previous_surname,&#10;                O.second_name,&#10;                O.surname,&#10;                O.third_name,&#10;                O.title_id,&#10;                O.cro_number,&#10;                O.deceased_date,&#10;                O.e_mail_address,&#10;                O.mobile_number,&#10;                O.ni_number,&#10;                O.noms_number,&#10;                O.pnc_number,&#10;                O.allow_sms,&#10;                O.telephone_number,&#10;                O.ethnicity_id,&#10;                O.ethnicity_description,&#10;                O.immigration_number,&#10;                O.immigration_status_id,&#10;                O.interpreter_required,&#10;                O.language_id,&#10;                O.nationality_id,&#10;                O.religion_id,&#10;                O.religion_description,&#10;                O.second_nationality_id,&#10;                O.sexual_orientation_id&#10;              FROM&#10;                offender O&#10;              WHERE O.offender_id &#61; p_off_id;&#10;            --&#10;            l_rec_src csO%ROWTYPE;&#10;            l_rec_tgt csO%ROWTYPE;&#10;            --&#10;            PROCEDURE do_fetch_off_records IS&#10;            BEGIN&#10;                --&#10;                OPEN csO(l_src_offender_id);&#10;                FETCH csO INTO l_rec_src;&#10;                CLOSE csO;&#10;                --&#10;                OPEN csO(l_tgt_offender_id);&#10;                FETCH csO INTO l_rec_tgt;&#10;                CLOSE csO;&#10;                --&#10;            END do_fetch_off_records;&#10;            --&#10;            PROCEDURE do_upd_tgt_off_record&#10;            IS&#10;                --&#10;                PROCEDURE do_upd_hist(p_fld_name VARCHAR2, p_fld_type VARCHAR2, p_flag VARCHAR2, p_new_val VARCHAR2, p_old_val VARCHAR2) IS&#10;                BEGIN&#10;                    IF p_flag &#61; &#39;Y&#39; THEN&#10;                        IF NVL(p_old_val, &#39;@xyz@&#39;) &lt;&gt; NVL(p_new_val, &#39;@xyz@&#39;) THEN&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; UPPER(p_fld_name),&#10;                                p_data_type    &#61;&gt; NVL(p_fld_type, &#39;C&#39;),&#10;                                p_old_value    &#61;&gt; p_old_val,&#10;                                p_new_value    &#61;&gt; p_new_val );&#10;                        END IF;&#10;                    END IF;&#10;                END do_upd_hist;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_changes_log_TAB.DELETE;&#10;                --&#10;                UPDATE offender SET&#10;                  crn                   &#61; (CASE WHEN g_merge_ctx_rec.move_crn                  &#61; &#39;Y&#39; THEN l_rec_src.crn                   ELSE crn                   END),&#10;                  date_of_birth_date    &#61; (CASE WHEN g_merge_ctx_rec.move_dob                  &#61; &#39;Y&#39; THEN l_rec_src.date_of_birth_date    ELSE date_of_birth_date    END),&#10;                  first_name            &#61; (CASE WHEN g_merge_ctx_rec.move_first_name           &#61; &#39;Y&#39; THEN l_rec_src.first_name            ELSE first_name            END),&#10;                  gender_id             &#61; (CASE WHEN g_merge_ctx_rec.move_gender               &#61; &#39;Y&#39; THEN l_rec_src.gender_id             ELSE gender_id             END),&#10;                  previous_surname      &#61; (CASE WHEN g_merge_ctx_rec.move_prev_name            &#61; &#39;Y&#39; THEN l_rec_src.previous_surname      ELSE previous_surname      END),&#10;                  second_name           &#61; (CASE WHEN g_merge_ctx_rec.move_second_name          &#61; &#39;Y&#39; THEN l_rec_src.second_name           ELSE second_name           END),&#10;                  surname               &#61; (CASE WHEN g_merge_ctx_rec.move_surname              &#61; &#39;Y&#39; THEN l_rec_src.surname               ELSE surname               END),&#10;                  third_name            &#61; (CASE WHEN g_merge_ctx_rec.move_third_name           &#61; &#39;Y&#39; THEN l_rec_src.third_name            ELSE third_name            END),&#10;                  title_id              &#61; (CASE WHEN g_merge_ctx_rec.move_title                &#61; &#39;Y&#39; THEN l_rec_src.title_id              ELSE title_id              END),&#10;                  cro_number            &#61; (CASE WHEN g_merge_ctx_rec.move_cro                  &#61; &#39;Y&#39; THEN l_rec_src.cro_number            ELSE cro_number            END),&#10;                  deceased_date         &#61; (CASE WHEN g_merge_ctx_rec.move_date_died            &#61; &#39;Y&#39; THEN l_rec_src.deceased_date         ELSE deceased_date         END),&#10;                  e_mail_address        &#61; (CASE WHEN g_merge_ctx_rec.move_email                &#61; &#39;Y&#39; THEN l_rec_src.e_mail_address        ELSE e_mail_address        END),&#10;                  mobile_number         &#61; (CASE WHEN g_merge_ctx_rec.move_mobile               &#61; &#39;Y&#39; THEN l_rec_src.mobile_number         ELSE mobile_number         END),&#10;                  ni_number             &#61; (CASE WHEN g_merge_ctx_rec.move_ni                   &#61; &#39;Y&#39; THEN l_rec_src.ni_number             ELSE ni_number             END),&#10;                  noms_number           &#61; (CASE WHEN g_merge_ctx_rec.move_noms                 &#61; &#39;Y&#39; THEN l_rec_src.noms_number           ELSE noms_number           END),&#10;                  pnc_number            &#61; (CASE WHEN g_merge_ctx_rec.move_pnc                  &#61; &#39;Y&#39; THEN l_rec_src.pnc_number            ELSE pnc_number            END),&#10;                  allow_sms             &#61; (CASE WHEN g_merge_ctx_rec.move_sms                  &#61; &#39;Y&#39; THEN l_rec_src.allow_sms             ELSE allow_sms             END),&#10;                  telephone_number      &#61; (CASE WHEN g_merge_ctx_rec.move_telephone            &#61; &#39;Y&#39; THEN l_rec_src.telephone_number      ELSE telephone_number      END),&#10;                  ethnicity_id          &#61; (CASE WHEN g_merge_ctx_rec.move_ethnicity            &#61; &#39;Y&#39; THEN l_rec_src.ethnicity_id          ELSE ethnicity_id          END),&#10;                  ethnicity_description &#61; (CASE WHEN g_merge_ctx_rec.move_ethnicity_1          &#61; &#39;Y&#39; THEN l_rec_src.ethnicity_description ELSE ethnicity_description END),&#10;                  immigration_number    &#61; (CASE WHEN g_merge_ctx_rec.move_immigration_number   &#61; &#39;Y&#39; THEN l_rec_src.immigration_number    ELSE immigration_number    END),&#10;                  immigration_status_id &#61; (CASE WHEN g_merge_ctx_rec.move_immigration_status   &#61; &#39;Y&#39; THEN l_rec_src.immigration_status_id ELSE immigration_status_id END),&#10;                  interpreter_required  &#61; (CASE WHEN g_merge_ctx_rec.move_interpreter_required &#61; &#39;Y&#39; THEN l_rec_src.interpreter_required  ELSE interpreter_required  END),&#10;                  language_id           &#61; (CASE WHEN g_merge_ctx_rec.move_language             &#61; &#39;Y&#39; THEN l_rec_src.language_id           ELSE language_id           END),&#10;                  nationality_id        &#61; (CASE WHEN g_merge_ctx_rec.move_nationality          &#61; &#39;Y&#39; THEN l_rec_src.nationality_id        ELSE nationality_id        END),&#10;                  religion_id           &#61; (CASE WHEN g_merge_ctx_rec.move_religion             &#61; &#39;Y&#39; THEN l_rec_src.religion_id           ELSE religion_id           END),&#10;                  religion_description  &#61; (CASE WHEN g_merge_ctx_rec.move_religion_desc        &#61; &#39;Y&#39; THEN l_rec_src.religion_description  ELSE religion_description  END),&#10;                  second_nationality_id &#61; (CASE WHEN g_merge_ctx_rec.move_second_nationality   &#61; &#39;Y&#39; THEN l_rec_src.second_nationality_id ELSE second_nationality_id END),&#10;                  sexual_orientation_id &#61; (CASE WHEN g_merge_ctx_rec.move_sexual_orientation   &#61; &#39;Y&#39; THEN l_rec_src.sexual_orientation_id ELSE sexual_orientation_id END)&#10;                  --&#10;                  --prev_conviction_document_name  &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.prev_conviction_document_name  ELSE prev_conviction_document_name  END),&#10;                  --previous_conviction_date       &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.previous_conviction_date       ELSE previous_conviction_date       END),&#10;                  --prev_con_alfresco_document_id  &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.prev_con_alfresco_document_id  ELSE prev_con_alfresco_document_id  END),&#10;                  --prev_con_created_by_user_id    &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.prev_con_created_by_user_id    ELSE prev_con_created_by_user_id    END),&#10;                  --prev_con_created_datetime      &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.prev_con_created_datetime      ELSE prev_con_created_datetime      END),&#10;                  --prev_con_created_provider_id   &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.prev_con_created_provider_id   ELSE prev_con_created_provider_id   END),&#10;                  --prev_con_last_updated_user_id  &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.prev_con_last_updated_user_id  ELSE prev_con_last_updated_user_id  END),&#10;                  --prev_con_last_upd_auth_prov_id &#61; (CASE WHEN g_merge_ctx_rec.move_precon_doc  &#61; &#39;Y&#39; THEN l_rec_src.prev_con_last_upd_auth_prov_id ELSE prev_con_last_upd_auth_prov_id END)&#10;                  --&#10;                WHERE offender_id &#61; l_tgt_offender_id;&#10;                --&#10;                --do_upd_hist(p_fld_name VARCHAR2, p_fld_type VARCHAR2, p_flag VARCHAR2, p_new_val VARCHAR2, p_old_val VARCHAR2) IS&#10;                do_upd_hist(&#39;crn&#39;,                   &#39;C&#39;, g_merge_ctx_rec.move_crn                 , l_rec_src.crn                  , l_rec_tgt.crn                  );&#10;                do_upd_hist(&#39;date_of_birth_date&#39;,    &#39;D&#39;, g_merge_ctx_rec.move_dob                 , l_rec_src.date_of_birth_date   , l_rec_tgt.date_of_birth_date   );&#10;                do_upd_hist(&#39;first_name&#39;,            &#39;C&#39;, g_merge_ctx_rec.move_first_name          , l_rec_src.first_name           , l_rec_tgt.first_name           );&#10;                do_upd_hist(&#39;gender_id&#39;,             &#39;N&#39;, g_merge_ctx_rec.move_gender              , l_rec_src.gender_id            , l_rec_tgt.gender_id            );&#10;                do_upd_hist(&#39;previous_surname&#39;,      &#39;C&#39;, g_merge_ctx_rec.move_prev_name           , l_rec_src.previous_surname     , l_rec_tgt.previous_surname     );&#10;                do_upd_hist(&#39;second_name&#39;,           &#39;C&#39;, g_merge_ctx_rec.move_second_name         , l_rec_src.second_name          , l_rec_tgt.second_name          );&#10;                do_upd_hist(&#39;surname&#39;,               &#39;C&#39;, g_merge_ctx_rec.move_surname             , l_rec_src.surname              , l_rec_tgt.surname              );&#10;                do_upd_hist(&#39;third_name&#39;,            &#39;C&#39;, g_merge_ctx_rec.move_third_name          , l_rec_src.third_name           , l_rec_tgt.third_name           );&#10;                do_upd_hist(&#39;title_id&#39;,              &#39;N&#39;, g_merge_ctx_rec.move_title               , l_rec_src.title_id             , l_rec_tgt.title_id             );&#10;                do_upd_hist(&#39;cro_number&#39;,            &#39;C&#39;, g_merge_ctx_rec.move_cro                 , l_rec_src.cro_number           , l_rec_tgt.cro_number           );&#10;                do_upd_hist(&#39;deceased_date&#39;,         &#39;D&#39;, g_merge_ctx_rec.move_date_died           , l_rec_src.deceased_date        , l_rec_tgt.deceased_date        );&#10;                do_upd_hist(&#39;e_mail_address&#39;,        &#39;C&#39;, g_merge_ctx_rec.move_email               , l_rec_src.e_mail_address       , l_rec_tgt.e_mail_address       );&#10;                do_upd_hist(&#39;mobile_number&#39;,         &#39;C&#39;, g_merge_ctx_rec.move_mobile              , l_rec_src.mobile_number        , l_rec_tgt.mobile_number        );&#10;                do_upd_hist(&#39;ni_number&#39;,             &#39;C&#39;, g_merge_ctx_rec.move_ni                  , l_rec_src.ni_number            , l_rec_tgt.ni_number            );&#10;                do_upd_hist(&#39;noms_number&#39;,           &#39;C&#39;, g_merge_ctx_rec.move_noms                , l_rec_src.noms_number          , l_rec_tgt.noms_number          );&#10;                do_upd_hist(&#39;pnc_number&#39;,            &#39;C&#39;, g_merge_ctx_rec.move_pnc                 , l_rec_src.pnc_number           , l_rec_tgt.pnc_number           );&#10;                do_upd_hist(&#39;allow_sms&#39;,             &#39;C&#39;, g_merge_ctx_rec.move_sms                 , l_rec_src.allow_sms            , l_rec_tgt.allow_sms            );&#10;                do_upd_hist(&#39;telephone_number&#39;,      &#39;C&#39;, g_merge_ctx_rec.move_telephone           , l_rec_src.telephone_number     , l_rec_tgt.telephone_number     );&#10;                do_upd_hist(&#39;ethnicity_id&#39;,          &#39;N&#39;, g_merge_ctx_rec.move_ethnicity           , l_rec_src.ethnicity_id         , l_rec_tgt.ethnicity_id         );&#10;                do_upd_hist(&#39;ethnicity_description&#39;, &#39;C&#39;, g_merge_ctx_rec.move_ethnicity_1         , l_rec_src.ethnicity_description, l_rec_tgt.ethnicity_description);&#10;                do_upd_hist(&#39;immigration_number&#39;,    &#39;C&#39;, g_merge_ctx_rec.move_immigration_number  , l_rec_src.immigration_number   , l_rec_tgt.immigration_number   );&#10;                do_upd_hist(&#39;immigration_status_id&#39;, &#39;N&#39;, g_merge_ctx_rec.move_immigration_status  , l_rec_src.immigration_status_id, l_rec_tgt.immigration_status_id);&#10;                do_upd_hist(&#39;interpreter_required&#39;,  &#39;C&#39;, g_merge_ctx_rec.move_interpreter_required, l_rec_src.interpreter_required , l_rec_tgt.interpreter_required );&#10;                do_upd_hist(&#39;language_id&#39;,           &#39;N&#39;, g_merge_ctx_rec.move_language            , l_rec_src.language_id          , l_rec_tgt.language_id          );&#10;                do_upd_hist(&#39;nationality_id&#39;,        &#39;N&#39;, g_merge_ctx_rec.move_nationality         , l_rec_src.nationality_id       , l_rec_tgt.nationality_id       );&#10;                do_upd_hist(&#39;religion_id&#39;,           &#39;N&#39;, g_merge_ctx_rec.move_religion            , l_rec_src.religion_id          , l_rec_tgt.religion_id          );&#10;                do_upd_hist(&#39;religion_description&#39;,  &#39;C&#39;, g_merge_ctx_rec.move_religion_desc       , l_rec_src.religion_description , l_rec_tgt.religion_description );&#10;                do_upd_hist(&#39;second_nationality_id&#39;, &#39;N&#39;, g_merge_ctx_rec.move_second_nationality  , l_rec_src.second_nationality_id, l_rec_tgt.second_nationality_id);&#10;                do_upd_hist(&#39;sexual_orientation_id&#39;, &#39;N&#39;, g_merge_ctx_rec.move_sexual_orientation  , l_rec_src.sexual_orientation_id, l_rec_tgt.sexual_orientation_id);&#10;                --&#10;                IF g_merge_ctx_rec.move_precon_doc &#61; &#39;Y&#39; THEN&#10;                    --&#10;                    -- YF: DST-11993: PRECON is now stored in DOCUMENT table&#10;                    --do_upd_hist(&#39;prev_conviction_document_name&#39; , &#39;C&#39;, &#39;Y&#39;, l_rec_src.prev_conviction_document_name , l_rec_tgt.prev_conviction_document_name );&#10;                    --do_upd_hist(&#39;previous_conviction_date&#39;      , &#39;D&#39;, &#39;Y&#39;, l_rec_src.previous_conviction_date      , l_rec_tgt.previous_conviction_date      );&#10;                    --do_upd_hist(&#39;prev_con_alfresco_document_id&#39; , &#39;C&#39;, &#39;Y&#39;, l_rec_src.prev_con_alfresco_document_id , l_rec_tgt.prev_con_alfresco_document_id );&#10;                    --do_upd_hist(&#39;prev_con_created_by_user_id&#39;   , &#39;N&#39;, &#39;Y&#39;, l_rec_src.prev_con_created_by_user_id   , l_rec_tgt.prev_con_created_by_user_id   );&#10;                    --do_upd_hist(&#39;prev_con_created_datetime&#39;     , &#39;D&#39;, &#39;Y&#39;, l_rec_src.prev_con_created_datetime     , l_rec_tgt.prev_con_created_datetime     );&#10;                    --do_upd_hist(&#39;prev_con_created_provider_id&#39;  , &#39;N&#39;, &#39;Y&#39;, l_rec_src.prev_con_created_provider_id  , l_rec_tgt.prev_con_created_provider_id  );&#10;                    --do_upd_hist(&#39;prev_con_last_updated_user_id&#39; , &#39;N&#39;, &#39;Y&#39;, l_rec_src.prev_con_last_updated_user_id , l_rec_tgt.prev_con_last_updated_user_id );&#10;                    --do_upd_hist(&#39;prev_con_last_upd_auth_prov_id&#39;, &#39;N&#39;, &#39;Y&#39;, l_rec_src.prev_con_last_upd_auth_prov_id, l_rec_tgt.prev_con_last_upd_auth_prov_id);&#10;                    --&#10;                    NULL;&#10;                    --&#10;                END IF;&#10;                --&#10;                do_ins_omd_rec(&#10;                    -- Overload 1&#10;                    p_hierarchy_level  &#61;&gt; 0,&#10;                    p_parent_table     &#61;&gt; NULL,&#10;                    p_table_name       &#61;&gt; &#39;OFFENDER&#39;,&#10;                    p_src_offender_id  &#61;&gt; l_src_offender_id,&#10;                    p_tgt_offender_id  &#61;&gt; l_tgt_offender_id,&#10;                    p_src_pk_value     &#61;&gt; NULL,&#10;                    p_tgt_pk_value     &#61;&gt; NULL,&#10;                    p_src_fk_value     &#61;&gt; NULL,&#10;                    p_tgt_fk_value     &#61;&gt; NULL,&#10;                    p_debug_notes      &#61;&gt; NULL,&#10;                    x_changes_log_TAB  &#61;&gt; l_changes_log_TAB,&#10;                    p_off_merge_det_id &#61;&gt; l_omd_id );&#10;                --&#10;            END do_upd_tgt_off_record;&#10;            --&#10;            PROCEDURE do_add_ai_crn&#10;            /* nDelius DataMaintenanceBean.mergeOffenders JAVA code:&#10;            --      AdditionalIdentifier mergedFrom &#61; new AdditionalIdentifier();&#10;            */&#10;            IS&#10;                --&#10;                l_omd_ai_id NUMBER;&#10;                --&#10;                l_src_id NUMBER;&#10;                l_tgt_id NUMBER;&#10;                --&#10;            BEGIN&#10;                --&#10;                g_label :&#61; &#39;400000&#39;;&#10;                --&#10;                l_src_id :&#61; additional_identifier_id_SEQ.nextval;&#10;                l_tgt_id :&#61; additional_identifier_id_SEQ.nextval;&#10;                --&#10;                g_label :&#61; &#39;400020&#39;;&#10;                --&#10;                INSERT INTO additional_identifier(&#10;                  additional_identifier_id,&#10;                  offender_id,&#10;                  identifier,&#10;                  soft_deleted,&#10;                  identifier_name_id,&#10;                  created_by_user_id,&#10;                  created_datetime,&#10;                  last_updated_user_id,&#10;                  last_updated_datetime )&#10;                SELECT&#10;                  l_tgt_id                              AS additional_identifier_id,&#10;                  l_tgt_offender_id                     AS offender_id,&#10;                  l_rec_src.crn                         AS identifier,&#10;                  0                                     AS soft_deleted,&#10;                  PKG_Lookups.funcgetStdRefListID(&#10;                      &#39;ADDITIONAL IDENTIFIER TYPE&#39;,&#10;                      &#39;MFCRN&#39; /*MERGED_FROM_CRN*/ )     AS identifier_name_id,&#10;                  LC_USER_ID                            AS created_by_user_id,&#10;                  LC_DATE_TIME                          AS created_datetime,&#10;                  LC_USER_ID                            AS last_updated_user_id,&#10;                  LC_DATE_TIME                          AS last_updated_datetime&#10;                FROM dual;&#10;                --&#10;                g_label :&#61; &#39;400030&#39;;&#10;                --&#10;                INSERT INTO additional_identifier(&#10;                  additional_identifier_id,&#10;                  offender_id,&#10;                  identifier,&#10;                  soft_deleted,&#10;                  identifier_name_id,&#10;                  created_by_user_id,&#10;                  created_datetime,&#10;                  last_updated_user_id,&#10;                  last_updated_datetime )&#10;                SELECT&#10;                  l_src_id                              AS additional_identifier_id,&#10;                  l_src_offender_id                     AS offender_id,&#10;                  l_rec_tgt.crn                         AS identifier,&#10;                  0                                     AS soft_deleted,&#10;                  PKG_Lookups.funcgetStdRefListID(&#10;                      &#39;ADDITIONAL IDENTIFIER TYPE&#39;,&#10;                      &#39;MTCRN&#39; /*MERGED_TO_CRN*/ )       AS identifier_name_id,&#10;                  LC_USER_ID                            AS created_by_user_id,&#10;                  LC_DATE_TIME                          AS created_datetime,&#10;                  LC_USER_ID                            AS last_updated_user_id,&#10;                  LC_DATE_TIME                          AS last_updated_datetime&#10;                FROM dual;&#10;                --&#10;                g_label :&#61; &#39;400040&#39;;&#10;                do_ins_omd_rec(&#10;                    -- Overload 2&#10;                    p_hierarchy_level  &#61;&gt; 1,&#10;                    p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                    p_table_name       &#61;&gt; &#39;ADDITIONAL_IDENTIFIER&#39;,&#10;                    p_src_offender_id  &#61;&gt; l_src_offender_id,&#10;                    p_tgt_offender_id  &#61;&gt; l_tgt_offender_id,&#10;                    p_src_pk_value     &#61;&gt; l_src_id,&#10;                    p_tgt_pk_value     &#61;&gt; l_tgt_id,&#10;                    p_src_fk_value     &#61;&gt; l_src_offender_id,&#10;                    p_tgt_fk_value     &#61;&gt; l_tgt_offender_id,&#10;                    p_debug_notes      &#61;&gt; &#39;Added MFCRN/MRCRN Additional Identifire records (to Source and Target offenders&#39;,&#10;                    x_off_merge_det_id &#61;&gt; l_omd_ai_id );&#10;                --&#10;                g_label :&#61; &#39;449000&#39;;&#10;                --&#10;            END do_add_ai_crn;&#10;            --&#10;            PROCEDURE do_upd_src_off_record IS&#10;            BEGIN&#10;                --&#10;                UPDATE offender SET&#10;                  --&#10;                  soft_deleted          &#61; 1,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                  --&#10;                WHERE offender_id &#61; l_src_offender_id;&#10;                --&#10;            END do_upd_src_off_record;&#10;            --&#10;            PROCEDURE do_upd_offender_diversity&#10;            /* nDelius DataMaintenanceBean.mergeOffenders JAVA code:&#10;                offenderDAO.updateOffenderDiversity(mergeData.getUpdatedOffender());&#10;            */&#10;            IS&#10;            BEGIN&#10;                --&#10;                g_label :&#61; &#39;250010&#39;;&#10;                --&#10;                UPDATE offender SET&#10;                  surname_soundex     &#61; SOUNDEX(surname),&#10;                  first_name_soundex  &#61; SOUNDEX(first_name),&#10;                  middle_name_soundex &#61; SOUNDEX(second_name)&#10;                WHERE offender_id IN (l_src_offender_id, l_tgt_offender_id);&#10;                --&#10;                g_label :&#61; &#39;299000&#39;;&#10;                --&#10;            END do_upd_offender_diversity;&#10;            --&#10;        BEGIN&#10;            --&#10;            do_fetch_off_records;&#10;            do_upd_tgt_off_record;&#10;            do_add_ai_crn;&#10;            do_upd_src_off_record;&#10;            do_upd_offender_diversity;&#10;            --&#10;        END do_upd_offender;&#10;        --&#10;        PROCEDURE do_create_off_merge_contact&#10;            /* nDelius DataMaintenanceBean.mergeOffenders JAVA code:&#10;            --      // Add contacts informing new offender manager&#10;            */&#10;        IS&#10;            --&#10;            l_contact_id      NUMBER;&#10;            l_off_merge_notes CLOB;&#10;            --&#10;            FUNCTION get_off_merge_contact_notes(p_offender_id NUMBER, p_extra_details VARCHAR2 DEFAULT &#39;Y&#39;, p_om_id NUMBER DEFAULT NULL) RETURN VARCHAR2&#10;            IS&#10;                --&#10;                l_ret VARCHAR2(4000);&#10;                --&#10;            BEGIN&#10;                SELECT&#10;                  &#39;CRN: &#39;   || O.crn || CHR(10) ||&#10;                  --&#39;From Team: &#39;    || T.description || CHR(10) ||&#10;                  &#39;Offender Name: &#39; || PKG_LstUtl.concat(O.surname, PKG_LstUtl.concat(O.first_name, O.second_name, O.third_name, p_delim&#61;&gt;&#39; &#39;), p_delim&#61;&gt; &#39;, &#39;) ||&#10;                  CASE WHEN p_extra_details &#61; &#39;Y&#39; THEN&#10;                    CHR(10) ||&#10;                    &#39;Offender Manager Trust: &#39;   || PA.description || CHR(10) ||&#10;                    &#39;Offender Manager Team: &#39;    || T.description || CHR(10) ||&#10;                    &#39;Offender Manager Officer: &#39; || PKG_SPG_SUPPORT.get_responsible_staff(OM.allocation_staff_id, OM.provider_employee_id)&#10;                  END&#10;                INTO l_ret&#10;                FROM&#10;                  offender_manager OM&#10;                    INNER JOIN offender O ON O.offender_id &#61; OM.offender_id&#10;                    INNER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;                      INNER JOIN probation_area PA ON PA.probation_area_id &#61; T.probation_area_id&#10;                    INNER JOIN officer S ON S.trust_provider_flag &#61; OM.trust_provider_flag AND S.staff_employee_id &#61; OM.staff_employee_id&#10;                      LEFT OUTER JOIN staff S1 ON S1.staff_id &#61; S.staff_employee_id AND S.trust_provider_flag &#61; 0&#10;                WHERE OM.offender_id &#61; p_offender_id&#10;                  AND ( (NVL(p_om_id, -1) &#61; -1 AND OM.active_flag &#61; 1              ) OR&#10;                        (p_om_id &gt; 0           AND OM.offender_manager_id &#61; p_om_id)&#10;                      );&#10;                --&#10;                RETURN l_ret;&#10;            END get_off_merge_contact_notes;&#10;            --&#10;            FUNCTION get_offender_address_details(p_offender_address_id NUMBER) RETURN VARCHAR2&#10;            IS&#10;                --&#10;                CURSOR cs IS&#10;                  SELECT OA.*&#10;                  FROM offender_address OA&#10;                  WHERE OA.offender_address_id &#61; p_offender_address_id;&#10;                l_rec cs%ROWTYPE;&#10;                --&#10;            BEGIN&#10;                OPEN cs;&#10;                FETCH cs INTO l_rec;&#10;                CLOSE cs;&#10;                --&#10;                RETURN&#10;                    PKG_LstUtl.concat(&#10;                        l_rec.building_name,&#10;                        PKG_LstUtl.concat(l_rec.address_number, l_rec.street_name, p_delim&#61;&gt;&#39; &#39;),&#10;                        l_rec.district,&#10;                        l_rec.town_city,&#10;                        l_rec.county,&#10;                        l_rec.postcode,&#10;                        p_delim&#61;&gt;CHR(10) );&#10;            END get_offender_address_details;&#10;            --&#10;            FUNCTION get_offender_merge_history RETURN VARCHAR2 IS&#10;            BEGIN&#10;                RETURN&#10;                    PKG_Lookups.funcGetTabRecord(&#10;                        p_table       &#61;&gt; &#39;OFFENDER_MERGE_DETAILS&#39;,&#10;                        p_data_fld    &#61;&gt;&#10;                           &#39;REPLACE(DECODE(table_name, &#39;&#39;PROVISION&#39;&#39;, &#39;&#39;Adjustment&#39;&#39;, table_name), &#39;&#39;_&#39;&#39;, &#39;&#39; &#39;&#39;) || &#39;&#39;: &#39;&#39; ||&#10;                            COUNT(1) || &#39;&#39; &#39;&#39; || CASE WHEN COUNT(1) &gt; 1 THEN &#39;&#39;Records&#39;&#39; ELSE &#39;&#39;Record&#39;&#39; END ||&#10;                            CASE WHEN table_name &#61; &#39;&#39;EVENT&#39;&#39; AND :p_soft_deleted &gt; 0 THEN &#39;&#39; &#39;&#39; || :p_soft_deleted || &#39;&#39; Soft Deleted&#39;&#39; END&#39;,&#10;                        p_ref_col     &#61;&gt; &#39;1&#39;,&#10;                        p_ref_val     &#61;&gt; g_merge_ctx_rec.src_event_soft_deleted_CNT,&#10;                        p_where       &#61;&gt; &#39;target_offender_id &#61; :p_tgt_offender_id_TGT AND source_offender_id &#61; :p_src_offender_id_SRC GROUP BY table_name ORDER BY table_name&#39;,&#10;                        p_bind_var1   &#61;&gt; g_merge_ctx_rec.src_event_soft_deleted_CNT,&#10;                        p_bind_var2   &#61;&gt; 1 /*P_REF_VAL off set*/,&#10;                        p_bind_var3   &#61;&gt; l_tgt_offender_id,&#10;                        p_bind_var4   &#61;&gt; l_src_offender_id,&#10;                        p_all_records &#61;&gt; &#39;Y&#39;,&#10;                        p_delim       &#61;&gt; CHR(10) );&#10;            END get_offender_merge_history;&#10;            --&#10;            FUNCTION get_offender_merge_duplicates RETURN VARCHAR2 IS&#10;            BEGIN&#10;                RETURN&#10;                    PKG_Lookups.funcGetTabRecord(&#10;                        p_table       &#61;&gt; &#39;merge_duplicates&#39;,&#10;                        p_data_fld    &#61;&gt;&#10;                           &#39;REPLACE(DECODE(table_name, &#39;&#39;PROVISION&#39;&#39;, &#39;&#39;Adjustment&#39;&#39;, table_name), &#39;&#39;_&#39;&#39;, &#39;&#39; &#39;&#39;) || &#39;&#39;: &#39;&#39; ||&#10;                            DECODE(type_table,&#10;                                &#39;&#39;R_STANDARD_REFERENCE_LIST&#39;&#39;, PKG_Lookups.funcgetStdRefListCodeDesc(type_id),&#10;                                &#39;&#39;R_DISPOSAL_TYPE&#39;&#39;, PKG_Lookups.funcGetTabRecord(p_table&#61;&gt;&#39;&#39;R_DISPOSAL_TYPE&#39;&#39;, p_data_fld&#61;&gt;&#39;&#39;description&#39;&#39;, p_ref_col&#61;&gt;&#39;&#39;disposal_type_id&#39;&#39;, p_ref_val&#61;&gt;type_id),&#10;                                &#39;&#39;R_REGISTER_TYPE&#39;&#39;, PKG_Lookups.funcGetTabRecord(p_table&#61;&gt;&#39;&#39;R_REGISTER_TYPE&#39;&#39;, p_data_fld&#61;&gt;&#39;&#39;description&#39;&#39;, p_ref_col&#61;&gt;&#39;&#39;register_type_id&#39;&#39;, p_ref_val&#61;&gt;type_id),&#10;                                &#39;&#39;R_CIRCUMSTANCE_SUB_TYPE&#39;&#39;, PKG_Lookups.funcGetTabRecord(p_table&#61;&gt;&#39;&#39;R_CIRCUMSTANCE_SUB_TYPE&#39;&#39;, p_data_fld&#61;&gt;&#39;&#39;code_description&#39;&#39;, p_ref_col&#61;&gt;&#39;&#39;circumstance_sub_type_id&#39;&#39;, p_ref_val&#61;&gt;type_id),&#10;                                table_name || &#39;&#39;/type_id&#61;&#39;&#39; || type_id&#10;                            ) || &#39;&#39;: &#39;&#39; ||&#10;                            duplicates || &#39;&#39; &#39;&#39; || CASE WHEN duplicates &gt; 1 THEN &#39;&#39;Records&#39;&#39; ELSE &#39;&#39;Record&#39;&#39; END&#39;,&#10;                        p_ref_col     &#61;&gt; &#39;target_offender_id&#39;,&#10;                        p_ref_val     &#61;&gt; l_tgt_offender_id,&#10;                        p_where       &#61;&gt; &#39;origin_offender_id &#61; :p_offender_id_SRC&#39;,&#10;                        p_bind_var1   &#61;&gt; l_src_offender_id,&#10;                        p_order_by    &#61;&gt; &#39;table_name, type_id&#39;,&#10;                        p_all_records &#61;&gt; &#39;Y&#39;,&#10;                        p_delim       &#61;&gt; CHR(10) );&#10;            END get_offender_merge_duplicates;&#10;            --&#10;            FUNCTION get_offender_drug_profile(p_offender_id NUMBER) RETURN VARCHAR2&#10;            IS&#10;                --&#10;                CURSOR cs1 IS&#10;                  SELECT&#10;                    offender_drug_profile_id,&#10;                    PKG_LstUtl.concat(&#10;                        PKG_LstUtl.add_prefix(&#39;Assessment Date: &#39;, TO_CHAR(assessment_date, &#39;DD-Mon-YYYY&#39;)    , p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39;),&#10;                        PKG_LstUtl.add_prefix(&#39;Team: &#39;           , PKG_Lookups.GetResponsibleTeam(team_id)    , p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39;),&#10;                        PKG_LstUtl.add_prefix(&#39;Officer: &#39;        , PKG_Lookups.GetResponsibleOfficer(staff_id), p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39;),&#10;                        PKG_LstUtl.add_prefix(&#39;Weekly Cost: &#39;    , weekly_cost                                , p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39;),&#10;                        PKG_LstUtl.add_prefix(&#39;Notes: &#39;          , notes                                      , p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39;),&#10;                        --&#10;                        PKG_LstUtl.add_prefix(&#39;Medicine Details: &#39; || CHR(10),&#10;                            PKG_LstUtl.get_indented_text( PKG_Lookups.funcGetTabRecord(&#10;                                p_table       &#61;&gt; &#39;OFFENDER_DRUG_PROFILE_MEDS&#39;,&#10;                                p_data_fld    &#61;&gt;&#10;                                   &#39;PKG_LstUtl.concat(&#10;                                        PKG_LstUtl.add_prefix(&#39;&#39;Start Date: &#39;&#39;, TO_CHAR(start_date, &#39;&#39;DD-Mon-YYYY&#39;&#39;)               , p_ignore_spaces_and_zeroes&#61;&gt;&#39;&#39;Y&#39;&#39;),&#10;                                        PKG_LstUtl.add_prefix(&#39;&#39;End Date: &#39;&#39;, TO_CHAR(start_date, &#39;&#39;DD-Mon-YYYY&#39;&#39;)                 , p_ignore_spaces_and_zeroes&#61;&gt;&#39;&#39;Y&#39;&#39;),&#10;                                        PKG_LstUtl.add_prefix(&#39;&#39;Medicine: &#39;&#39;, PKG_Lookups.funcgetStdRefListCodeAndDesc(medicine_id), p_ignore_spaces_and_zeroes&#61;&gt;&#39;&#39;Y&#39;&#39;),&#10;                                        --&#10;                                        p_delim&#61;&gt;&#39;&#39;; &#39;&#39;)&#39;,&#10;                                p_ref_col     &#61;&gt; &#39;offender_drug_profile_id&#39;,&#10;                                p_ref_val     &#61;&gt; offender_drug_profile_id,&#10;                                p_where       &#61;&gt; &#39;soft_deleted &#61; 0&#39;,&#10;                                p_order_by    &#61;&gt; &#39;start_date DESC, created_datetime DESC&#39;,&#10;                                p_all_records &#61;&gt; &#39;Y&#39;,&#10;                                p_delim       &#61;&gt; CHR(10) ), 2 ) ),&#10;                        --&#10;                        PKG_LstUtl.add_prefix(&#39;Drugs Details: &#39; || CHR(10),&#10;                            PKG_LstUtl.get_indented_text( PKG_Lookups.funcGetTabRecord(&#10;                                p_table       &#61;&gt; &#39;OFFENDER_DRUG_PROFILE_DRUG T, R_DRUG_TYPE DT&#39;,&#10;                                p_data_fld    &#61;&gt;&#10;                                   &#39;PKG_LstUtl.concat(&#10;                                        PKG_LstUtl.add_prefix(&#39;&#39;Drug Type: &#39;&#39;  , DT.code || &#39;&#39;,&#39;&#39; || DT.description                  , p_ignore_spaces_and_zeroes&#61;&gt;&#39;&#39;Y&#39;&#39;),&#10;                                        PKG_LstUtl.add_prefix(&#39;&#39;Main Drug: &#39;&#39;  , T.main_drug                                         , p_ignore_spaces_and_zeroes&#61;&gt;&#39;&#39;Y&#39;&#39;),&#10;                                        PKG_LstUtl.add_prefix(&#39;&#39;Screen Type: &#39;&#39;, T.screen_type                                       , p_ignore_spaces_and_zeroes&#61;&gt;&#39;&#39;Y&#39;&#39;),&#10;                                        PKG_LstUtl.add_prefix(&#39;&#39;Test Type: &#39;&#39;  , T.test_type                                         , p_ignore_spaces_and_zeroes&#61;&gt;&#39;&#39;Y&#39;&#39;),&#10;                                        --&#10;                                        p_delim&#61;&gt;&#39;&#39;; &#39;&#39;)&#39;,&#10;                                p_ref_col     &#61;&gt; &#39;T.offender_drug_profile_id&#39;,&#10;                                p_ref_val     &#61;&gt; offender_drug_profile_id,&#10;                                p_where       &#61;&gt; &#39;DT.drug_type_id &#61; T.drug_type_id AND T.soft_deleted &#61; 0&#39;,&#10;                                p_order_by    &#61;&gt; &#39;DECODE(T.main_drug, &#39;&#39;Y&#39;&#39;, 1, 0) DESC, T.created_datetime DESC&#39;,&#10;                                p_all_records &#61;&gt; &#39;Y&#39;,&#10;                                p_delim       &#61;&gt; CHR(10) ), 2 ) ),&#10;                        --&#10;                        p_delim&#61;&gt;CHR(10) ) AS txt_det&#10;                  FROM offender_drug_profile&#10;                  WHERE soft_deleted &#61; 0&#10;                    AND offender_id &#61; p_offender_id&#10;                  ORDER BY assessment_date DESC;&#10;                --&#10;                l_rec1 cs1%ROWTYPE;&#10;                --&#10;                l_ret VARCHAR2(32000);&#10;                --&#10;            BEGIN&#10;                --&#10;                OPEN cs1;&#10;                LOOP&#10;                    FETCH cs1 INTO l_rec1;&#10;                    EXIT WHEN cs1%NOTFOUND;&#10;                    --&#10;                    l_ret :&#61; PKG_LstUtl.concat(l_ret, l_rec1.txt_det, p_delim&#61;&gt;CHR(10)||CHR(10), p_max_len&#61;&gt; 32000);&#10;                END LOOP;&#10;                CLOSE cs1;&#10;                --&#10;                RETURN l_ret;&#10;            END get_offender_drug_profile;&#10;            --&#10;        BEGIN&#10;            --&#10;            g_label :&#61; &#39;550100&#39;;&#10;            l_off_merge_notes :&#61;&#10;                PKG_LstUtl.concat(&#10;                    &#39;Target Offender&#39;,&#10;                    get_off_merge_contact_notes(l_tgt_offender_id, p_om_id&#61;&gt;g_merge_ctx_rec.old_tgt_offender_manager_id),&#10;                    --&#10;                    CASE WHEN g_merge_ctx_rec.tgt_off_addr_id_MAIN &gt; 0 THEN&#10;                      CHR(10) || &#39;The following main address has been end dated&#39; || CHR(10) || get_offender_address_details(g_merge_ctx_rec.tgt_off_addr_id_MAIN)&#10;                    END,&#10;                    CASE WHEN g_merge_ctx_rec.tgt_off_addr_id_POSTAL &gt; 0 THEN&#10;                      CHR(10) || &#39;The following postal address has been end dated&#39; || CHR(10) || get_offender_address_details(g_merge_ctx_rec.tgt_off_addr_id_POSTAL)&#10;                    END,&#10;                    --&#10;                    CHR(10) || &#39;Source Offender&#39;,&#10;                    get_off_merge_contact_notes(l_src_offender_id),&#10;                    CASE WHEN g_merge_ctx_rec.src_off_addr_id_MAIN &gt; 0 THEN&#10;                      CHR(10) || &#39;The following main address has been end dated&#39; || CHR(10) ||&#10;                      get_offender_address_details(&#10;                          get_merged_primary_key_id(&#10;                              &#39;OFFENDER_ADDRESS&#39;,&#10;                              l_src_offender_id,&#10;                              g_merge_ctx_rec.src_off_addr_id_MAIN) )&#10;                    END,&#10;                    CASE WHEN g_merge_ctx_rec.src_off_addr_id_POSTAL &gt; 0 THEN&#10;                      CHR(10) || &#39;The following postal address has been end dated&#39; || CHR(10) ||&#10;                      get_offender_address_details(&#10;                          get_merged_primary_key_id(&#10;                              &#39;OFFENDER_ADDRESS&#39;,&#10;                              l_src_offender_id,&#10;                              g_merge_ctx_rec.src_off_addr_id_POSTAL) )&#10;                    END,&#10;                    --&#10;                    PKG_LstUtl.add_prefix(&#10;                        CHR(10) || &#39;The following records have been merged into this offender:&#39; || CHR(10),&#10;                        get_offender_merge_history,&#10;                        p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39; ),&#10;                    PKG_LstUtl.add_prefix(&#10;                        CHR(10) || &#39;The following records should be checked for duplication:&#39; || CHR(10),&#10;                        get_offender_merge_duplicates,&#10;                        p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39; ),&#10;                    --&#10;                    PKG_LstUtl.add_prefix(&#10;                        CHR(10) || &#39;The following Offender Level Drug Profile records have been retained on the Source Offender:&#39; || CHR(10),&#10;                        get_offender_drug_profile(l_src_offender_id),&#10;                        p_ignore_spaces_and_zeroes&#61;&gt;&#39;Y&#39; ),&#10;                    --&#10;                    p_delim&#61;&gt;CHR(10) );&#10;            --&#10;            g_label :&#61; &#39;550200&#39;;&#10;            --&#10;            l_contact_id :&#61; contact_id_SEQ.nextval;&#10;            --&#10;            INSERT INTO contact(&#10;              contact_id,&#10;              offender_id,&#10;              contact_date,&#10;              contact_type_id,&#10;              --&#10;              probation_area_id,&#10;              team_id,&#10;              provider_team_id,&#10;              staff_id,&#10;              provider_employee_id,&#10;              --&#10;              notes,&#10;              --&#10;              created_by_user_id,&#10;              created_datetime,&#10;              last_updated_user_id,&#10;              last_updated_datetime,&#10;              soft_deleted,&#10;              partition_area_id )&#10;            SELECT&#10;              l_contact_id,&#10;              OM.offender_id,&#10;              SYSDATE AS contact_date,&#10;              ( SELECT contact_type_id FROM r_contact_type WHERE code &#61; &#39;OMRG&#39; /*Merge Offenders*/ ) AS contact_type_id,&#10;              --&#10;              OM.probation_area_id,&#10;              OM.team_id,&#10;              OM.provider_team_id,&#10;              OM.allocation_staff_id,&#10;              OM.provider_employee_id,&#10;              --&#10;              l_off_merge_notes AS notes,&#10;              --&#10;              LC_USER_ID,&#10;              LC_DATE_TIME,&#10;              LC_USER_ID,&#10;              LC_DATE_TIME,&#10;              0,&#10;              0&#10;            FROM offender_manager OM&#10;            WHERE OM.offender_id &#61; l_tgt_offender_id&#10;              AND OM.active_flag &#61; 1;&#10;            --&#10;            info(&#39;DO_CREATE_OFF_MERGE_CONTACT: create new Merge Contact record [contact_id&#61;&#39; || l_contact_id || &#39;]&#39;, p_trace_level&#61;&gt;15, p_proc&#61;&gt;&#39;DO_CREATE_OFF_MERGE_CONTACT&#39;);&#10;            --&#10;            g_label :&#61; &#39;599000&#39;;&#10;            --&#10;        END do_create_off_merge_contact;&#10;        --&#10;        PROCEDURE do_create_om_transfer_contact&#10;        IS&#10;            --&#10;            l_contact_id         NUMBER;&#10;            l_om_notes           CLOB;&#10;            l_omt_contact_date   DATE :&#61; TRUNC(LC_DATE_TIME);&#10;            --&#10;            FUNCTION get_om_contact_notes(p_om_id NUMBER) RETURN VARCHAR2&#10;            IS&#10;                l_notes CLOB;&#10;            BEGIN&#10;                SELECT&#10;                  &#39;From Trust: &#39;   || PA.description || CHR(10) ||&#10;                  &#39;From Team: &#39;    || T.description || CHR(10) ||&#10;                  &#39;From Officer: &#39; || PKG_SPG_SUPPORT.get_responsible_staff(OM.allocation_staff_id, OM.provider_employee_id)&#10;                INTO l_notes&#10;                FROM&#10;                  offender_manager OM&#10;                    INNER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;                      INNER JOIN probation_area PA ON PA.probation_area_id &#61; T.probation_area_id&#10;                    INNER JOIN officer S ON S.trust_provider_flag &#61; OM.trust_provider_flag AND S.staff_employee_id &#61; OM.staff_employee_id&#10;                      LEFT OUTER JOIN staff S1 ON S1.staff_id &#61; S.staff_employee_id AND S.trust_provider_flag &#61; 0&#10;                WHERE 1&#61;1&#10;                  AND OM.offender_id &#61; l_tgt_offender_id&#10;                  AND ( (NVL(p_om_id, -1) &#61; -1 AND OM.active_flag &#61; 1) OR&#10;                        (p_om_id &gt; 0           AND OM.offender_manager_id &#61; p_om_id) );&#10;                --&#10;                RETURN l_notes;&#10;                --&#10;            EXCEPTION WHEN NO_DATA_FOUND THEN&#10;                fatal(&#39;ERROR in GET_OM_CONTACT_NOTES [off_id&#61;&#39; || l_tgt_offender_id || &#39;][om_id&#61;&#39; || p_om_id || &#39;]: No Data Found.&#39;);&#10;            END get_om_contact_notes;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF g_merge_ctx_rec.old_tgt_offender_manager_id IS NULL THEN&#10;                -- Source Active OM has been copied to the target with the ACTIVE_FLAG&#61;0&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            -- Example:&#10;            --    Transfer Reason: Internal Transfer&#10;            --    Transfer Date: 12/08/2020&#10;            --    From Trust: NPS North West&#10;            --    From Team: Unallocated Team(N01)&#10;            --    From Officer: Unallocated&#10;            l_om_notes :&#61;&#10;                &#39;Transfer Reason: &#39; ||&#10;                CASE&#10;                    WHEN g_merge_ctx_rec.old_tgt_om_probation_area_id &#61; NVL(g_merge_ctx_rec.src_om_probation_area_id, g_merge_ctx_rec.old_tgt_om_probation_area_id)&#10;                    THEN &#39;Internal Transfer&#39;&#10;                    ELSE &#39;External Transfer&#39;&#10;                END || CHR(10) ||&#10;                &#39;Transfer Date: &#39; || TO_CHAR(l_omt_contact_date, &#39;dd/mm/yyyy&#39;) || CHR(10) ||&#10;                get_om_contact_notes(g_merge_ctx_rec.old_tgt_offender_manager_id);&#10;            --&#10;            l_contact_id :&#61; contact_id_SEQ.nextval;&#10;            --&#10;            INSERT INTO contact(&#10;              contact_id,&#10;              offender_id,&#10;              contact_date,&#10;              contact_type_id,&#10;              --&#10;              probation_area_id,&#10;              team_id,&#10;              provider_team_id,&#10;              staff_id,&#10;              provider_employee_id,&#10;              --&#10;              notes,&#10;              --&#10;              created_by_user_id,&#10;              created_datetime,&#10;              last_updated_user_id,&#10;              last_updated_datetime,&#10;              soft_deleted,&#10;              partition_area_id )&#10;            SELECT&#10;              l_contact_id,&#10;              OM.offender_id,&#10;              TRUNC(LC_DATE_TIME) /*allocation_date*/ AS contact_date,&#10;              ( SELECT contact_type_id FROM r_contact_type WHERE code &#61; &#39;ETOM&#39; /*Offender Manager Transfer*/ ) AS contact_type_id,&#10;              --&#10;              OM.probation_area_id,&#10;              OM.team_id,&#10;              OM.provider_team_id,&#10;              OM.allocation_staff_id,&#10;              OM.provider_employee_id,&#10;              --&#10;              l_om_notes AS notes,&#10;              --&#10;              LC_USER_ID,&#10;              LC_DATE_TIME,&#10;              LC_USER_ID,&#10;              LC_DATE_TIME,&#10;              0,&#10;              0&#10;            FROM offender_manager OM&#10;            WHERE OM.offender_id &#61; l_tgt_offender_id&#10;              AND OM.active_flag &#61; 1;&#10;            --&#10;            info(&#39;DO_CREATE_OM_TRANSFER_CONTACT: [OM_ID&#61;&#39; || g_merge_ctx_rec.old_tgt_offender_manager_id || &#39;][num_of_sgc_ETOM&#61;&#39; || SQL%ROWCOUNT || &#39;][SGC_contact_id&#61;&#39; || l_contact_id || &#39;]&#39;);&#10;            --&#10;        END do_create_om_transfer_contact;&#10;        --&#10;        PROCEDURE do_check_target_OM IS&#10;        BEGIN&#10;            -- NDM-168: Create same set of OM/RO/OT/C records&#10;            do_create_target_OM(&#39;MERGE&#39;);&#10;            --&#10;        END do_check_target_OM;&#10;        --&#10;        PROCEDURE do_rebuild_orgs IS&#10;        BEGIN&#10;            --&#10;            PKG_TriggerSupport.procRebuildOptTables_ALL(&#10;                p_force_flag              &#61;&gt; &#39;Y&#39;,&#10;                p_offender_id_LST         &#61;&gt; /*l_src_offender_id || &#39;,&#39; ||*/ TO_CHAR(l_tgt_offender_id),&#10;                p_update_offender_id_flag &#61;&gt; &#39;N&#39;,&#10;                p_process_alfresco_flag   &#61;&gt; &#39;Y&#39;,&#10;                p_exclude_nodes_lst       &#61;&gt; &#39;&#39; );&#10;            --&#10;            --PKG_VPD_CTX.set_table_value(&#39;REJ_TRANSFERS_REBUILD_REQUIRED&#39;, &#39;Y&#39;);&#10;            --PKG_TriggerSupport.procRebuildRejTransfersDiary(l_tgt_offender_id);&#10;            --&#10;        END do_rebuild_orgs;&#10;        --&#10;        PROCEDURE do_identify_duplicates IS&#10;        BEGIN&#10;            --&#10;            DELETE FROM merge_duplicates&#10;            WHERE target_offender_id &#61; l_tgt_offender_id&#10;              AND origin_offender_id &#61; l_src_offender_id;&#10;            --&#10;            INSERT INTO merge_duplicates( merge_duplicates_id, table_name, target_offender_id, origin_offender_id, type_table, type_id, duplicates )&#10;            --&#10;            WITH T AS (&#10;              SELECT&#10;                &#39;ALIAS&#39;           AS table_name,&#10;                l_tgt_offender_id AS target_off,&#10;                l_src_offender_id AS orig_off,&#10;                NULL              AS ref_item_type,&#10;                NULL              AS ref_item_id,&#10;                COUNT( alias_id ) AS duplicate_count&#10;              FROM alias&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;              GROUP BY&#10;                UPPER(first_name),&#10;                UPPER(surname),&#10;                gender_id&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT &#39;DISABILITY&#39;           AS table_name,&#10;                l_tgt_offender_id           AS target_off,&#10;                l_src_offender_id           AS orig_off,&#10;                &#39;R_STANDARD_REFERENCE_LIST&#39; AS ref_item_type,&#10;                disability_type_id          AS ref_item_id,&#10;                COUNT( disability_type_id ) AS duplicate_count&#10;              FROM disability D&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;                AND finish_date IS NULL&#10;                AND ( SELECT COUNT(disability_type_id)&#10;                      FROM disability&#10;                      WHERE offender_id &#61; D.offender_id&#10;                        AND D.disability_type_id &#61; disability_type_id&#10;                        AND finish_date IS NULL&#10;                    ) &gt; 1&#10;              GROUP BY&#10;                &#39;DISABILITY&#39;,&#10;                disability_type_id&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT&#10;                &#39;PROVISION&#39;                 AS table_name,&#10;                l_tgt_offender_id           AS target_off,&#10;                l_src_offender_id           AS orig_off,&#10;                &#39;R_STANDARD_REFERENCE_LIST&#39; AS ref_item_type,&#10;                provision_type_id           AS ref_item_id,&#10;                COUNT( provision_type_id )  AS duplicate_count&#10;              FROM provision&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;                AND finish_date IS NULL&#10;              GROUP BY provision_type_id&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT&#10;                &#39;PERSONAL_CIRCUMSTANCE&#39;         AS table_name,&#10;                l_tgt_offender_id               AS target_off,&#10;                l_src_offender_id               AS orig_off,&#10;                &#39;R_CIRCUMSTANCE_SUB_TYPE&#39;       AS ref_item_type,&#10;                circumstance_sub_type_id        AS ref_item_id,&#10;                COUNT(circumstance_sub_type_id) AS duplicate_count&#10;              FROM personal_circumstance&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;                 AND end_date IS NULL&#10;              GROUP BY circumstance_sub_type_id&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT&#10;                &#39;ADDITIONAL_IDENTIFIER&#39;     AS table_name,&#10;                l_tgt_offender_id           AS target_off,&#10;                l_src_offender_id           AS orig_off,&#10;                &#39;R_STANDARD_REFERENCE_LIST&#39; AS ref_item_type,&#10;                identifier_name_id          AS ref_item_id,&#10;                COUNT(identifier_name_id)   AS duplicate_count&#10;              FROM additional_identifier&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;              GROUP BY identifier_name_id, identifier&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT&#10;                &#39;REGISTRATION&#39;          AS table_name,&#10;                l_tgt_offender_id       AS target_off,&#10;                l_src_offender_id       AS orig_off,&#10;                &#39;R_REGISTER_TYPE&#39;       AS ref_item_type,&#10;                register_type_id        AS ref_item_id,&#10;                COUNT(REGISTER_TYPE_ID) AS duplicate_count&#10;              FROM registration&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;                AND deregistered &#61; 0&#10;              GROUP BY REGISTER_TYPE_ID&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT&#10;                &#39;RESTRICTION&#39;          AS table_name,&#10;                l_tgt_offender_id      AS target_off,&#10;                l_src_offender_id      AS orig_off,&#10;                NULL                   AS ref_item_type,&#10;                NULL                   AS ref_item_id,&#10;                COUNT(restriction_id)  AS duplicate_count&#10;              FROM restriction&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;                AND restriction_end_date IS NULL&#10;              GROUP BY&#10;                user_id&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT&#10;                &#39;EXCLUSION&#39;            AS table_name,&#10;                l_tgt_offender_id      AS target_off,&#10;                l_src_offender_id      AS orig_off,&#10;                NULL                   AS ref_item_type,&#10;                NULL                   AS ref_item_id,&#10;                COUNT(exclusion_id)    AS duplicate_count&#10;              FROM exclusion&#10;              WHERE offender_id &#61; l_tgt_offender_id&#10;                AND exclusion_end_date IS NULL&#10;              GROUP BY&#10;                user_id&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;              UNION ALL&#10;              --&#10;              SELECT&#10;                &#39;EVENT&#39;                 AS table_name,&#10;                l_tgt_offender_id           AS target_off,&#10;                l_src_offender_id           AS orig_off,&#10;                &#39;R_DISPOSAL_TYPE&#39;       AS ref_item_type,&#10;                disposal_type_id        AS ref_item_id,&#10;                COUNT(disposal_type_id) AS duplicate_count&#10;              FROM&#10;                disposal D&#10;                  INNER JOIN event E ON E.event_id &#61; D.event_id&#10;              WHERE E.offender_id &#61; l_tgt_offender_id&#10;                AND termination_date IS NULL&#10;              GROUP BY D.disposal_type_id&#10;              HAVING COUNT(1) &gt; 1&#10;              --&#10;            )&#10;            --&#10;            SELECT&#10;              merge_duplicates_id_seq.NEXTVAL,&#10;              table_name,&#10;              target_off,&#10;              orig_off,&#10;              ref_item_type,&#10;              ref_item_id,&#10;              duplicate_count&#10;            FROM T;&#10;            --&#10;        END do_identify_duplicates;&#10;        --&#10;        PROCEDURE do_post_merge_updates&#10;        IS&#10;            --&#10;            PROCEDURE do_upd_iaps_components&#10;            IS&#10;                --&#10;                CURSOR cs IS&#10;                  WITH OMD AS (&#10;                    SELECT *&#10;                    FROM offender_merge_details OMD&#10;                    WHERE OMD.table_name IN ( &#39;EVENT&#39;, &#39;LIC_CONDITION&#39;, &#39;RQMNT&#39;, &#39;CONTACT&#39; )&#10;                    AND OMD.source_offender_id &#61; l_src_offender_id )&#10;                  --&#10;                  SELECT *&#10;                  FROM OMD&#10;                  WHERE table_name &#61; &#39;EVENT&#39;&#10;                    AND EXISTS( SELECT 1 FROM iaps_event WHERE event_id &#61; OMD.source_pk_value )&#10;                  UNION ALL&#10;                  SELECT *&#10;                  FROM OMD&#10;                  WHERE table_name &#61; &#39;LIC_CONDITION&#39;&#10;                    AND EXISTS( SELECT 1 FROM iaps_lic_condition WHERE lic_condition_id &#61; OMD.source_pk_value )&#10;                  UNION ALL&#10;                  SELECT *&#10;                  FROM OMD&#10;                  WHERE table_name &#61; &#39;RQMNT&#39;&#10;                    AND EXISTS( SELECT 1 FROM iaps_rqmnt WHERE rqmnt_id &#61; OMD.source_pk_value )&#10;                  UNION ALL&#10;                  SELECT *&#10;                  FROM OMD&#10;                  WHERE table_name &#61; &#39;CONTACT&#39;&#10;                    AND EXISTS( SELECT 1 FROM iaps_contact WHERE contact_id &#61; OMD.source_pk_value );&#10;                --&#10;                l_rec cs%ROWTYPE;&#10;                --&#10;            BEGIN&#10;                --&#10;                OPEN cs;&#10;                LOOP&#10;                    FETCH cs INTO l_rec;&#10;                    EXIT WHEN cs%NOTFOUND;&#10;                    --&#10;                    EXECUTE IMMEDIATE&#10;                     &#39;UPDATE iaps_&#39; || l_rec.table_name || &#39; SET iaps_flag &#61; 2&#10;                      WHERE &#39; || l_rec.table_name || &#39;_id &#61; :p_src_pk&#39;&#10;                    USING l_rec.source_pk_value;&#10;                    --&#10;                    EXECUTE IMMEDIATE&#10;                     &#39;INSERT INTO iaps_&#39; || l_rec.table_name || &#39;(&#10;                        &#39; || l_rec.table_name || &#39;_id,&#10;                        iaps_flag&#10;                      ) VALUES (&#10;                        :p_tgt_pk,&#10;                        1 )&#39;&#10;                    USING l_rec.target_pk_value;&#10;                    --&#10;                END LOOP;&#10;                CLOSE cs;&#10;                --&#10;                do_reset_iaps_flags(&#39;POST&#39;);&#10;                --&#10;            END do_upd_iaps_components;&#10;            --&#10;            PROCEDURE do_upd_secondary_fk&#10;            IS&#10;                --&#10;                CURSOR csFK IS&#10;                  SELECT DISTINCT&#10;                    table_name,&#10;                    parent_table,&#10;                    fk_fld AS fk_fld_name,&#10;                    CASE&#10;                        WHEN table_name &#61; &#39;CONTACT&#39; AND parent_table &#61; &#39;EVENT&#39;&#10;                            THEN &#39;T.event_id IS NOT NULL&#39;&#10;                        WHEN table_name IN ( &#39;ENFORCEMENT&#39;, &#39;REPORT_MANAGER&#39; )&#10;                            THEN &#39;&#39;&#10;                        ELSE&#10;                            REPLACE(where_clause, &#39;table_name&#39;, &#39;T.table_name&#39;)&#10;                    END AS where_clause,&#10;                    not_null_col_name&#10;                  FROM offender_hierarchy OH&#10;                  WHERE 1&#61;1&#10;                    AND EXISTS( SELECT 1 FROM offender_hierarchy WHERE table_name &#61; OH.table_name GROUP BY table_name HAVING COUNT(parent_table) &gt; 1)&#10;                    AND table_name NOT IN (&#10;                        &#39;CASELOAD&#39;,&#10;                        &#39;COHORT_DIARY&#39;,&#10;                        &#39;CONTACT_ALERT_CLEAR&#39;,&#10;                        &#39;CRC_INACTIVE_OFFENDER&#39;,&#10;                        &#39;DATA_SCRIPT_MESSAGE&#39;, &#39;SQL_SCRIPT_MESSAGE&#39;,&#10;                        &#39;DSS_SEARCH_OFFENDER&#39;, &#39;DSS_SEARCH_REQUEST&#39;,&#10;                        &#39;GDPR_OFFENDER_DUPLICATE&#39;, &#39;GDPR_OFFENDER_RETAINED&#39;, &#39;GDPR_OFF_ELIGIBLE_DELETION&#39;,&#10;                        &#39;GDPR_OFFENDER_FREE_TEXT&#39;, &#39;GDPR_DESTRUCTION_LOG&#39;,&#10;                        &#39;GDPR_OFF_ELIGIBLE_SEARCH&#39;, &#39;GDPR_OFF_IICSA_SEARCH&#39;,&#10;                        &#39;MERGE_HISTORY&#39;, &#39;MERGE_DUPLICATES&#39;, &#39;MERGE_OFFENDER_VALUES&#39;, &#39;OFFENDER_MERGE_DETAILS&#39;,&#10;                        &#39;MANAGEMENT_TIER_EVENT&#39;,&#10;                        &#39;MOST_RECENTLY_VIEWED_OFFENDERS&#39;,&#10;                        &#39;OFFENDER_CRC_EXPORT&#39;,&#10;                        &#39;ORGANISATION_OFFENDER&#39;,&#10;                        &#39;REJECTED_TRANSFER_DIARY&#39;,&#10;                        &#39;SPG_DOCUMENT_REQUEST&#39;, &#39;SPG_ERROR_DETAIL&#39;, &#39;SPG_EXCEPTION&#39;, &#39;SPG_NOTIFICATION&#39;, &#39;SPG_SEARCH_OFFENDER&#39;, &#39;SPG_VERSION_ENTRY&#39; )&#10;                    AND ( ( parent_table NOT IN ( &#39;OFFENDER&#39; ) ) OR&#10;                          ( table_name &#61; &#39;DOCUMENT&#39; AND parent_table &#61; &#39;OFFENDER&#39; AND where_clause LIKE &#39;%table_name &#61; &#39;&#39;OFFENDER&#39;&#39;&#39; )&#10;                        )&#10;                    --&#10;                  ORDER BY&#10;                    table_name,&#10;                    parent_table;&#10;                --&#10;                l_rec_FK csFK%ROWTYPE;&#10;                --&#10;                PROCEDURE do_upd_fk(&#10;                    p_table        VARCHAR2,&#10;                    p_parent_table VARCHAR2,&#10;                    p_fk_col       VARCHAR2,&#10;                    p_where        VARCHAR2 DEFAULT NULL )&#10;                IS&#10;                    --&#10;                    TYPE l_cur_TYP IS REF CURSOR;&#10;                    l_cur l_cur_TYP;&#10;                    --&#10;                    TYPE l_rec_TYP IS RECORD(&#10;                      row_id                     ROWID,&#10;                      offender_merge_details_id  NUMBER,&#10;                      offender_merge_details_id1 NUMBER,&#10;                      cur_pk_value               VARCHAR2(100),&#10;                      cur_fk_value               VARCHAR2(100),&#10;                      tgt_fk_value               VARCHAR2(100) );&#10;                    --&#10;                    l_rec l_rec_TYP;&#10;                    --&#10;                    l_SQL CLOB;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    l_changes_log_TAB.DELETE;&#10;                    --&#10;                    l_SQL :&#61;&#10;                       &#39;SELECT&#10;                          T.ROWID                       AS row_id,&#10;                          TH.offender_merge_details_id,&#10;                          TH1.offender_merge_details_id AS offender_merge_details_id1,&#10;                          TH.target_pk_value            AS cur_pk_value,&#10;                          T.&#39; || p_fk_col || &#39;          AS cur_fk_value,&#10;                          TH1.target_pk_value           AS tgt_fk_value&#10;                        FROM&#10;                          &#39; || p_table || &#39; T&#10;                            INNER JOIN offender_merge_details TH  ON TH.target_pk_value &#61; T.&#39; || PKG_DynSQL.get_tab_pk_fld_lst(p_table, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1) || &#39;&#10;                                                                 AND TH.table_name &#61; :p_table&#10;                                                                 AND TH.source_offender_id &#61; :p_src_offender_id&#10;                                                                 AND TH.target_offender_id &#61; :p_tgt_offender_id&#10;                            INNER JOIN offender_merge_details TH1 ON TH1.source_pk_value &#61; T.&#39; || p_fk_col || &#39;&#10;                                                                 AND TH1.table_name &#61; :p_parent_table&#10;                                                                 AND TH1.source_offender_id &#61; :p_src_offender_id&#10;                                                                 AND TH1.target_offender_id &#61; :p_tgt_offender_id&#10;                        WHERE ( &#39; || NVL(p_where, &#39;1&#61;1&#39;) || &#39; )&#10;                          AND T.&#39; || p_fk_col || &#39; &lt;&gt; TH1.target_pk_value --IS NOT NULL&#10;                        ORDER BY 1&#39;;&#10;                    --&#10;                    OPEN l_cur FOR l_SQL&#10;                    USING&#10;                      p_table,&#10;                      l_src_offender_id,&#10;                      l_tgt_offender_id,&#10;                      --&#10;                      p_parent_table,&#10;                      l_src_offender_id,&#10;                      l_tgt_offender_id;&#10;                    --&#10;                    LOOP&#10;                        FETCH l_cur INTO l_rec;&#10;                        EXIT WHEN l_cur%NOTFOUND;&#10;                        --&#10;                        l_SQL :&#61; &#39;UPDATE &#39; || p_table || &#39; SET &#39; || p_fk_col || &#39; &#61; :p_tgt_fk_value WHERE ROWID &#61; :p_row_id&#39;;&#10;                        EXECUTE IMMEDIATE l_SQL USING l_rec.tgt_fk_value, l_rec.row_id;&#10;                        --&#10;                        do_add_omd_hist_rec(&#10;                            x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                            --&#10;                            p_fld_name     &#61;&gt; p_fk_col,&#10;                            p_data_type    &#61;&gt; &#39;N&#39;,&#10;                            p_old_value    &#61;&gt; l_rec.cur_fk_value,&#10;                            p_new_value    &#61;&gt; l_rec.tgt_fk_value,&#10;                            p_tab_pk_value &#61;&gt; NULL );&#10;                        --&#10;                        do_ins_omd_rec(&#10;                            -- Overload 1&#10;                            p_hierarchy_level  &#61;&gt; NULL,&#10;                            p_parent_table     &#61;&gt; p_parent_table,&#10;                            p_table_name       &#61;&gt; p_table,&#10;                            p_src_offender_id  &#61;&gt; l_src_offender_id,&#10;                            p_tgt_offender_id  &#61;&gt; l_tgt_offender_id,&#10;                            p_src_pk_value     &#61;&gt; NULL,&#10;                            p_tgt_pk_value     &#61;&gt; NULL,&#10;                            p_src_fk_value     &#61;&gt; NULL,&#10;                            p_tgt_fk_value     &#61;&gt; NULL,&#10;                            p_debug_notes      &#61;&gt; NULL,&#10;                            x_changes_log_TAB  &#61;&gt; l_changes_log_TAB,&#10;                            p_off_merge_det_id &#61;&gt; l_rec.offender_merge_details_id );&#10;                        --&#10;                    END LOOP;&#10;                    CLOSE l_cur;&#10;                    --&#10;                EXCEPTION WHEN OTHERS THEN&#10;                    --&#10;                    IF l_cur%ISOPEN THEN CLOSE l_cur; END IF;&#10;                    --&#10;                    fatal(&#10;                        SUBSTR(PKG_LstUtl.concat_CLOB(&#10;                            &#39;ERROR in DO_UPD_FK &#39;,&#10;                            --&#10;                            &#39;[tab&#61;&#39;               || p_table                         || &#39;]&#39; ||&#10;                            &#39;[src_off_id&#61;&#39;        || l_src_offender_id               || &#39;]&#39; ||&#10;                            &#39;[tgt_off_id&#61;&#39;        || l_tgt_offender_id               || &#39;]&#39; ||&#10;                            &#39;[parent_tab&#61;&#39;        || p_parent_table                  || &#39;]&#39; ||&#10;                            &#39;[fk_col&#61;&#39;            || p_fk_col                        || &#39;]&#39; ||&#10;                            &#39;[where&#61;&#39;             || p_where                         || &#39;]&#39;,&#10;                            --&#10;                            --&#39;[rowid&#61;&#39;             || l_rec.row_id                    || &#39;]&#39; ||&#10;                            &#39;[off_merge_det_id&#61;&#39;  || l_rec.offender_merge_details_id || &#39;]&#39; ||&#10;                            &#39;[cur_pk_val&#61;&#39;        || l_rec.cur_pk_value              || &#39;]&#39; ||&#10;                            &#39;[cur_fk_val&#61;&#39;        || l_rec.cur_fk_value              || &#39;]&#39; ||&#10;                            &#39;[tgt_fk_val&#61;&#39;        || l_rec.tgt_fk_value              || &#39;]&#39; || CHR(10),&#10;                            --&#10;                            &#39;***** OFFENDER_MERGE_DETAILS record:&#39;          || CHR(10) || get_off_merge_details_1(l_rec.offender_merge_details_id , p_incl_debug_notes&#61;&gt;&#39;N&#39;) || CHR(10),&#10;                            &#39;***** OFFENDER_MERGE_DETAILS record (Parent):&#39; || CHR(10) || get_off_merge_details_1(l_rec.offender_merge_details_id1, p_incl_debug_notes&#61;&gt;&#39;N&#39;) || CHR(10),&#10;                            --&#10;                            &#39;SQL: &#39; || l_SQL,&#10;                            &#39;ERRM: &#39; || get_dq_message(SQLERRM),&#10;                            --&#10;                            p_delim&#61;&gt;CHR(10)), 1, 32000),&#10;                        --&#10;                        &#39;DO_UPD_FK&#39; );&#10;                    --&#10;                END do_upd_fk;&#10;                --&#10;            BEGIN&#10;                --&#10;                OPEN csFK;&#10;                LOOP&#10;                    FETCH csFK INTO l_rec_FK;&#10;                    EXIT WHEN csFK%NOTFOUND;&#10;                    --&#10;                    do_upd_fk(l_rec_FK.table_name, l_rec_FK.parent_table, l_rec_FK.fk_fld_name, l_rec_FK.where_clause);&#10;                END LOOP;&#10;                CLOSE csFK;&#10;                --&#10;            END do_upd_secondary_fk;&#10;            --&#10;            PROCEDURE do_flush_OMDH(p_offender_merge_details_id NUMBER) IS&#10;            BEGIN&#10;                --&#10;                do_ins_omd_rec(&#10;                    -- Overload 1&#10;                    p_hierarchy_level  &#61;&gt; NULL,&#10;                    p_parent_table     &#61;&gt; &#39;OFFENDER&#39;,&#10;                    p_table_name       &#61;&gt; &#39;REGISTRATION&#39;,&#10;                    p_src_offender_id  &#61;&gt; l_src_offender_id,&#10;                    p_tgt_offender_id  &#61;&gt; l_tgt_offender_id,&#10;                    p_src_pk_value     &#61;&gt; NULL,&#10;                    p_tgt_pk_value     &#61;&gt; NULL,&#10;                    p_src_fk_value     &#61;&gt; NULL,&#10;                    p_tgt_fk_value     &#61;&gt; NULL,&#10;                    p_debug_notes      &#61;&gt; NULL,&#10;                    x_changes_log_TAB  &#61;&gt; l_changes_log_TAB,&#10;                    p_off_merge_det_id &#61;&gt; p_offender_merge_details_id );&#10;                --&#10;                l_changes_log_TAB.DELETE;&#10;                --&#10;            END do_flush_OMDH;&#10;            --&#10;            PROCEDURE do_process_dupl_reg&#10;            IS&#10;                --&#10;                PROCEDURE do_cr_dereg&#10;                IS&#10;                    --&#10;                    l_dereg_id         NUMBER;&#10;                    l_dereg_contact_id NUMBER;&#10;                    --&#10;                    l_dereg_notes VARCHAR2(255) :&#61; &#39;Register was De-Registered as part of a Merge on &#39; || TO_CHAR(LC_DATE, &#39;DD/MM/YYYY&#39;) || &#39;.&#39;;&#10;                    --&#10;                    CURSOR cs1 IS&#10;                      SELECT&#10;                        OMD.offender_merge_details_id,&#10;                        NVL(OMDH.table_pk_value, OMD.target_pk_value) AS registration_id&#10;                      FROM&#10;                        offender_merge_details OMD&#10;                          INNER JOIN offender_merge_details_hist OMDH ON OMDH.offender_merge_details_id &#61; OMD.offender_merge_details_id&#10;                                                                     AND OMDH.column_name &#61; &#39;DUPL_DEREGISTERED&#39;&#10;                                                                     AND old_value &#61; &#39;0&#39;&#10;                                                                     AND new_value &#61; &#39;1&#39;&#10;                      WHERE 1&#61;1&#10;                        AND OMD.table_name &#61; &#39;REGISTRATION&#39;&#10;                        AND OMD.source_offender_id &#61; l_src_offender_id&#10;                        AND OMD.target_offender_id &#61; l_tgt_offender_id;&#10;                    --&#10;                    l_rec1 cs1%ROWTYPE;&#10;                    --&#10;                    CURSOR csReg IS&#10;                      SELECT&#10;                        R.registration_id,&#10;                        RT.deregistration_contact_type_id,&#10;                        R.registering_team_id,&#10;                        R.registering_staff_id,&#10;                        T.probation_area_id     AS registering_probation_area_id,&#10;                        OM.team_id              AS OM_team_id,&#10;                        OM.allocation_staff_id  AS OM_staff_id,&#10;                        OM.probation_area_id    AS OM_probation_area_id,&#10;                        OM.provider_employee_id AS OM_provider_employee_id,&#10;                        OM.provider_team_id     AS OM_provider_team_id&#10;                      FROM&#10;                        registration R&#10;                          INNER JOIN r_register_type RT ON RT.register_type_id &#61; R.register_type_id&#10;                          INNER JOIN team T ON T.team_id &#61; registering_team_id&#10;                          INNER JOIN offender_manager OM ON OM.offender_id &#61; R.offender_id AND OM.active_flag &#61; 1&#10;                      WHERE R.registration_id &#61; l_rec1.registration_id;&#10;                    --&#10;                    l_rec_reg csReg%ROWTYPE;&#10;                    --&#10;                    PROCEDURE do_cr_dereg_contact IS&#10;                    BEGIN&#10;                        --&#10;                        INSERT INTO contact(&#10;                          contact_id,&#10;                          offender_id,&#10;                          contact_date,&#10;                          contact_type_id,&#10;                          --&#10;                          alert_active,&#10;                          visor_exported,&#10;                          sensitive,&#10;                          --&#10;                          probation_area_id,&#10;                          team_id,&#10;                          provider_team_id,&#10;                          staff_id,&#10;                          provider_employee_id,&#10;                          --&#10;                          notes,&#10;                          --&#10;                          soft_deleted,&#10;                          row_version,&#10;                          partition_area_id,&#10;                          --&#10;                          created_by_user_id,&#10;                          created_datetime,&#10;                          last_updated_user_id,&#10;                          last_updated_datetime&#10;                        ) VALUES (&#10;                          l_dereg_contact_id,&#10;                          g_merge_ctx_rec.tgt_offender_id,&#10;                          LC_DATE,&#10;                          l_rec_reg.deregistration_contact_type_id,&#10;                          --&#10;                          &#39;N&#39;,&#10;                          &#39;N&#39;,&#10;                          &#39;N&#39;,&#10;                          --&#10;                          l_rec_reg.OM_probation_area_id,&#10;                          l_rec_reg.OM_team_id,&#10;                          l_rec_reg.OM_provider_team_id,&#10;                          l_rec_reg.OM_staff_id,&#10;                          l_rec_reg.OM_provider_employee_id,&#10;                          --&#10;                          &#39;As per the Notes in the De-Registration&#39;, -- l_dereg_notes,&#10;                          --&#10;                          0,&#10;                          0,&#10;                          0,&#10;                          --&#10;                          LC_USER_ID,&#10;                          LC_DATE_TIME,&#10;                          LC_USER_ID,&#10;                          LC_DATE_TIME );&#10;                        --&#10;                        do_add_omd_hist_rec(&#10;                            x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                            --&#10;                            p_fld_name     &#61;&gt; &#39;DUPL_DEREGISTRATION_CONTACT_ID&#39;,&#10;                            p_data_type    &#61;&gt; &#39;N&#39;,&#10;                            p_old_value    &#61;&gt; NULL,&#10;                            p_new_value    &#61;&gt; &#39;1&#39;,&#10;                            p_tab_pk_value &#61;&gt; l_dereg_contact_id );&#10;                        --&#10;                    END do_cr_dereg_contact;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN cs1;&#10;                    LOOP&#10;                        FETCH cs1 INTO l_rec1;&#10;                        EXIT WHEN cs1%NOTFOUND;&#10;                        --&#10;                        OPEN csReg;&#10;                        FETCH csReg INTO l_rec_reg;&#10;                        CLOSE csReg;&#10;                        --&#10;                        IF l_rec_reg.registration_id &gt; 0 THEN&#10;                            --&#10;                            IF l_rec_reg.deregistration_contact_type_id &gt; 0 THEN&#10;                                l_dereg_contact_id :&#61; contact_id_SEQ.nextval;&#10;                                do_cr_dereg_contact;&#10;                            ELSE&#10;                                l_dereg_contact_id :&#61; NULL;&#10;                            END IF;&#10;                            --&#10;                            l_dereg_id :&#61; deregistration_id_SEQ.nextval;&#10;                            --&#10;                            INSERT INTO deregistration (&#10;                              deregistration_id,&#10;                              offender_id,&#10;                              registration_id,&#10;                              contact_id,&#10;                              --&#10;                              deregistration_date,&#10;                              --&#10;                              deregistering_team_id,&#10;                              deregistering_staff_id,&#10;                              --&#10;                              deregistering_notes,&#10;                              --&#10;                              soft_deleted,&#10;                              row_version,&#10;                              partition_area_id,&#10;                              --&#10;                              created_by_user_id,&#10;                              created_datetime,&#10;                              last_updated_user_id,&#10;                              last_updated_datetime&#10;                            ) VALUES (&#10;                              l_dereg_id,&#10;                              g_merge_ctx_rec.tgt_offender_id,&#10;                              l_rec1.registration_id,&#10;                              l_dereg_contact_id,&#10;                              --&#10;                              LC_DATE_TIME,&#10;                              --&#10;                              l_rec_reg.OM_team_id,&#10;                              l_rec_reg.OM_staff_id,&#10;                              --&#10;                              l_dereg_notes,&#10;                              --&#10;                              0,&#10;                              0,&#10;                              0,&#10;                              --&#10;                              LC_USER_ID,&#10;                              LC_DATE_TIME,&#10;                              LC_USER_ID,&#10;                              LC_DATE_TIME );&#10;                            --&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; &#39;DUPL_DEREGISTRATION_ID&#39;,&#10;                                p_data_type    &#61;&gt; &#39;N&#39;,&#10;                                p_old_value    &#61;&gt; NULL,&#10;                                p_new_value    &#61;&gt; &#39;1&#39;,&#10;                                p_tab_pk_value &#61;&gt; l_dereg_id );&#10;                            --&#10;                        END IF; --l_rec_reg.registration_id &gt; 0 THEN&#10;                        --&#10;                        do_flush_OMDH(l_rec1.offender_merge_details_id);&#10;                        --&#10;                    END LOOP;&#10;                    CLOSE cs1;&#10;                    --&#10;                END do_cr_dereg;&#10;                --&#10;                PROCEDURE do_upd_reg_review&#10;                IS&#10;                    --&#10;                    CURSOR cs1 IS&#10;                      SELECT&#10;                        OMD.offender_merge_details_id,&#10;                        OMD.source_pk_value,&#10;                        OMD.target_pk_value,&#10;                        DR.registration_id&#10;                      FROM&#10;                        offender_merge_details OMD&#10;                          INNER JOIN offender_merge_details_hist OMDH ON OMDH.offender_merge_details_id &#61; OMD.offender_merge_details_id&#10;                                                                     AND OMDH.column_name &#61; &#39;DUPL_DEREGISTRATION_ID&#39;&#10;                          INNER JOIN deregistration DR ON DR.deregistration_id &#61; OMDH.table_pk_value&#10;                      WHERE 1&#61;1&#10;                        AND OMD.table_name &#61; &#39;REGISTRATION&#39;&#10;                        AND OMD.source_offender_id &#61; l_src_offender_id&#10;                        AND OMD.target_offender_id &#61; l_tgt_offender_id;&#10;                    --&#10;                    l_rec1 cs1%ROWTYPE;&#10;                    --&#10;                    PROCEDURE do_terminate_reg_review&#10;                    IS&#10;                        --&#10;                        CURSOR cs2 IS&#10;                          SELECT&#10;                            registration_review_id,&#10;                            contact_id&#10;                          FROM registration_review&#10;                          WHERE registration_id &#61; l_rec1.registration_id&#10;                            AND soft_deleted &#61; 0&#10;                            AND NOT (completed &#61; &#39;Y&#39;);&#10;                        --&#10;                        l_rec2 cs2%ROWTYPE;&#10;                        --&#10;                        CURSOR cs3 IS&#10;                          SELECT&#10;                            registration_review_id,&#10;                            review_date_due&#10;                          FROM registration_review&#10;                          WHERE registration_id &#61; l_rec1.registration_id&#10;                            AND soft_deleted &#61; 0&#10;                            AND review_date_due IS NOT NULL&#10;                            AND completed &#61; &#39;Y&#39;&#10;                          ORDER BY&#10;                            review_date DESC,&#10;                            registration_review_id DESC;&#10;                        --&#10;                        l_rec3 cs3%ROWTYPE;&#10;                        --&#10;                    BEGIN&#10;                        --&#10;                        OPEN cs2;&#10;                        LOOP&#10;                            FETCH cs2 INTO l_rec2;&#10;                            EXIT WHEN cs2%NOTFOUND;&#10;                            --&#10;                            UPDATE registration_review SET soft_deleted &#61; 1&#10;                            WHERE registration_review_id &#61; l_rec2.registration_review_id;&#10;                            --&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; &#39;DUPL_REGISTRATION_REVIEW_ID&#39;,&#10;                                p_data_type    &#61;&gt; &#39;N&#39;,&#10;                                p_old_value    &#61;&gt; &#39;0&#39;,&#10;                                p_new_value    &#61;&gt; &#39;1&#39;,&#10;                                p_tab_pk_value &#61;&gt; l_rec2.registration_review_id );&#10;                            --&#10;                            IF l_rec2.contact_id IS NOT NULL THEN&#10;                                --&#10;                                UPDATE contact SET soft_deleted &#61; 1&#10;                                WHERE contact_id &#61; l_rec2.contact_id&#10;                                  AND soft_deleted &#61; 0;&#10;                                --&#10;                                IF SQL%ROWCOUNT &#61; 1 THEN&#10;                                    do_add_omd_hist_rec(&#10;                                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                        --&#10;                                        p_fld_name     &#61;&gt; &#39;DUPL_REG_REVIEW_CONTACT_ID&#39;,&#10;                                        p_data_type    &#61;&gt; &#39;N&#39;,&#10;                                        p_old_value    &#61;&gt; &#39;0&#39;,&#10;                                        p_new_value    &#61;&gt; &#39;1&#39;,&#10;                                        p_tab_pk_value &#61;&gt; l_rec2.contact_id );&#10;                                END IF;&#10;                                --&#10;                            END IF;&#10;                            --&#10;                        END LOOP;&#10;                        CLOSE cs2;&#10;                        --&#10;                        -- DST-13392: Update previuos Completed Registration Review record (if exists)&#10;                        OPEN cs3;&#10;                        FETCH cs3 INTO l_rec3;&#10;                        CLOSE cs3;&#10;                        --&#10;                        IF l_rec3.registration_review_id &gt; 0 THEN&#10;                            --&#10;                            UPDATE registration_review SET review_date_due &#61; NULL&#10;                            WHERE registration_review_id &#61; l_rec3.registration_review_id;&#10;                            --&#10;                            do_add_omd_hist_rec(&#10;                                x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                                --&#10;                                p_fld_name     &#61;&gt; &#39;DUPL_REG_REVIEW_DATE_DUE&#39;,&#10;                                p_data_type    &#61;&gt; &#39;D&#39;,&#10;                                p_old_value    &#61;&gt; PKG_Common.date_2_char(l_rec3.review_date_due),&#10;                                p_new_value    &#61;&gt; NULL,&#10;                                p_tab_pk_value &#61;&gt; l_rec3.registration_review_id );&#10;                            --&#10;                        END IF;&#10;                        --&#10;                    END do_terminate_reg_review;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN cs1;&#10;                    LOOP&#10;                        FETCH cs1 INTO l_rec1;&#10;                        EXIT WHEN cs1%NOTFOUND;&#10;                        --&#10;                        do_terminate_reg_review;&#10;                        --&#10;                        do_flush_OMDH(l_rec1.offender_merge_details_id);&#10;                        --&#10;                    END LOOP;&#10;                    CLOSE cs1;&#10;                    --&#10;                END do_upd_reg_review;&#10;                --&#10;                PROCEDURE do_upd_active_reg&#10;                IS&#10;                    --&#10;                    l_reg_notes   VARCHAR2(255) :&#61; &#39;When this Record was merged two registrations of the same register type were active. &#39; ||&#10;                                                   &#39;Please review the De-Registered registrations to ensure you have a complete view of the registration history.&#39;;&#10;                    --&#10;                    CURSOR cs1 IS&#10;                      SELECT&#10;                        OMD.offender_merge_details_id,&#10;                        NVL(OMDH.table_pk_value, OMD.target_pk_value) AS reg_id_ACTIVE&#10;                      FROM&#10;                        offender_merge_details OMD&#10;                          INNER JOIN offender_merge_details_hist OMDH ON OMDH.offender_merge_details_id &#61; OMD.offender_merge_details_id&#10;                                                                     AND OMDH.column_name &#61; &#39;DUPL_REGISTRATION_NOTES&#39;&#10;                                                                     AND old_value IS NULL&#10;                                                                     AND new_value &#61; &#39;X&#39;&#10;                      WHERE 1&#61;1&#10;                        AND OMD.table_name &#61; &#39;REGISTRATION&#39;&#10;                        AND OMD.source_offender_id &#61; l_src_offender_id&#10;                        AND OMD.target_offender_id &#61; l_tgt_offender_id;&#10;                    --&#10;                    l_rec1 cs1%ROWTYPE;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN cs1;&#10;                    LOOP&#10;                        FETCH cs1 INTO l_rec1;&#10;                        EXIT WHEN cs1%NOTFOUND;&#10;                        --&#10;                        UPDATE registration SET&#10;                          registration_notes &#61; registration_notes || CHR(10) || l_reg_notes,&#10;                          --&#10;                          row_version &#61; row_version + 1,&#10;                          --&#10;                          last_updated_user_id  &#61; LC_USER_ID,&#10;                          last_updated_datetime &#61; LC_DATE_TIME&#10;                        WHERE registration_id &#61; l_rec1.reg_id_ACTIVE;&#10;                    END LOOP;&#10;                    CLOSE cs1;&#10;                    --&#10;                END do_upd_active_reg;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_changes_log_TAB.DELETE;&#10;                --&#10;                do_cr_dereg;&#10;                do_upd_reg_review;&#10;                do_upd_active_reg;&#10;                --&#10;            END do_process_dupl_reg;&#10;            --&#10;            PROCEDURE do_process_precon&#10;            IS&#10;                --&#10;                CURSOR cs1 IS&#10;                  SELECT&#10;                    OMD.offender_merge_details_id,&#10;                    OMDH.table_pk_value AS document_id&#10;                  FROM&#10;                    offender_merge_details OMD&#10;                      INNER JOIN offender_merge_details_hist OMDH ON OMDH.offender_merge_details_id &#61; OMD.offender_merge_details_id&#10;                                                                 AND OMDH.column_name &#61; &#39;PRECON_SOFT_DELETED&#39;&#10;                                                                 AND old_value &#61; &#39;0&#39;&#10;                                                                 AND new_value &#61; &#39;1&#39;&#10;                  WHERE OMD.table_name &#61; &#39;DOCUMENT&#39;&#10;                    AND OMD.source_offender_id &#61; l_src_offender_id&#10;                    AND OMD.target_offender_id &#61; l_tgt_offender_id;&#10;                --&#10;                l_rec1 cs1%ROWTYPE;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_changes_log_TAB.DELETE;&#10;                --&#10;                OPEN cs1;&#10;                LOOP&#10;                    FETCH cs1 INTO l_rec1;&#10;                    EXIT WHEN cs1%NOTFOUND;&#10;                    --&#10;                    -- DST-13409: soft delete the Original Source PRECON record&#10;                    UPDATE document SET soft_deleted &#61; 1&#10;                    WHERE document_id &#61; l_rec1.document_id;&#10;                    --&#10;                END LOOP;&#10;                CLOSE cs1;&#10;                --&#10;            END do_process_precon;&#10;            --&#10;            PROCEDURE do_amend_SAR IS&#10;            BEGIN&#10;                --&#10;                UPDATE subject_access_report SET&#10;                  generation_status &#61; &#39;A&#39;,&#10;                  --&#10;                  row_number &#61; row_number + 1,&#10;                  --&#10;                  last_updated_user_id  &#61; LC_USER_ID,&#10;                  last_updated_datetime &#61; LC_DATE_TIME&#10;                WHERE offender_id IN ( /*l_src_offender_id,*/ l_tgt_offender_id )&#10;                  AND generation_status &#61; &#39;C&#39;;&#10;                --&#10;            END do_amend_SAR;&#10;            --&#10;            PROCEDURE do_upd_OASYS_event_num&#10;            IS&#10;                --&#10;                CURSOR cs IS&#10;                  SELECT&#10;                    OMD.offender_merge_details_id  AS OMD_id_E,&#10;                    OMD1.offender_merge_details_id AS OMD_id_OA,&#10;                    O.crn          AS tgt_crn,&#10;                    OA.oasys_assessment_id,&#10;                    OA.rowid       AS row_id,&#10;                    OMDH.old_value AS src_event_number,&#10;                    OMDH.new_value AS tgt_event_number&#10;                  FROM&#10;                    offender_merge_details OMD&#10;                      INNER JOIN offender O ON O.offender_id &#61; OMD.target_offender_id&#10;                      INNER JOIN offender_merge_details_hist OMDH ON OMDH.offender_merge_details_id &#61; OMD.offender_merge_details_id&#10;                                                                 AND OMDH.column_name &#61; &#39;EVENT_NUMBER&#39;&#10;                        INNER JOIN oasys_assessment OA ON OA.offender_id &#61; l_tgt_offender_id&#10;                                                      AND OA.event_number &#61; OMDH.old_value&#10;                          INNER JOIN offender_merge_details OMD1 ON OMD1.target_pk_value &#61; OA.oasys_assessment_id&#10;                                                                AND OMD1.table_name &#61; &#39;OASYS_ASSESSMENT&#39;&#10;                                                                AND OMD1.source_offender_id &#61; l_src_offender_id&#10;                                                                AND OMD1.target_offender_id &#61; l_tgt_offender_id&#10;                  WHERE 1&#61;1&#10;                    AND OMD.table_name &#61; &#39;EVENT&#39;&#10;                    AND OMD.source_offender_id &#61; l_src_offender_id&#10;                    AND OMD.target_offender_id &#61; l_tgt_offender_id;&#10;                --&#10;                l_rec cs%ROWTYPE;&#10;                --&#10;            BEGIN&#10;                --&#10;                OPEN cs;&#10;                LOOP&#10;                    FETCH cs INTO l_rec;&#10;                    EXIT WHEN cs%NOTFOUND;&#10;                    --&#10;                    UPDATE oasys_assessment SET&#10;                      event_number &#61; l_rec.tgt_event_number&#10;                    WHERE ROWID &#61; l_rec.row_id&#10;                      AND offender_id &#61; l_tgt_offender_id&#10;                      AND event_number &#61; l_rec.src_event_number;&#10;                    --&#10;                    l_changes_log_TAB.DELETE;&#10;                    --&#10;                    do_add_omd_hist_rec(&#10;                        x_changes_log_TAB &#61;&gt; l_changes_log_TAB,&#10;                        --&#10;                        p_fld_name     &#61;&gt; &#39;EVENT_NUMBER&#39;,&#10;                        p_data_type    &#61;&gt; &#39;C&#39;,&#10;                        p_old_value    &#61;&gt; l_rec.src_event_number,&#10;                        p_new_value    &#61;&gt; l_rec.tgt_event_number );&#10;                    --&#10;                    -- Overload 1a&#10;                    do_ins_omd_rec(&#10;                        p_off_merge_det_id &#61;&gt; l_rec.OMD_id_OA,&#10;                        p_debug_notes      &#61;&gt; &#39;DST-19876: OASYS_ASSESSMENT.event_number has been synchronised with the corresponding Target EVENT.event_number&#39;,&#10;                        --&#10;                        x_changes_log_TAB  &#61;&gt; l_changes_log_TAB );&#10;                    --&#10;                    info(&#10;                        &#39;POST_MERGE.do_upd_OASYS_event_num &#39; ||&#10;                        &#39;[tgt_off_id&#61;&#39;    || l_tgt_offender_id      || &#39;]&#39; ||&#10;                        &#39;[tgt_crn&#61;&#39;       || l_rec.tgt_crn          || &#39;]&#39; ||&#10;                        &#39;[tgt_event_num&#61;&#39; || l_rec.tgt_event_number || &#39;]&#39;,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; l_proc );&#10;&#10;                    --&#10;                END LOOP;&#10;                CLOSE cs;&#10;                --&#10;            END do_upd_OASYS_event_num;&#10;            --&#10;            PROCEDURE do_CAS_calc IS&#10;            BEGIN&#10;                --&#10;                PKG_TriggerSupport.procAddCASDeferred(l_tgt_offender_id);&#10;                PKG_TriggerSupport.procUpdateCAS_DEFERRED(p_trigger_name &#61;&gt; &#39;DO_POST_MERGE&#39;);&#10;                --&#10;            END do_CAS_calc;&#10;            --&#10;        BEGIN&#10;            --&#10;            do_upd_secondary_fk;&#10;            --&#10;            do_process_dupl_reg;&#10;            do_process_precon;&#10;            --DST-12291: Set SAR status to (A)rchived&#10;            do_amend_SAR;&#10;            --&#10;            --DST-19876: Synchronise OASYS_ASSESSMENT.event_number&#10;            do_upd_OASYS_event_num;&#10;            --&#10;            -- Update IAPS flags prior to move so only moved records are of interest&#10;            do_upd_iaps_components;&#10;            -- Update CurrentRestriction / CurrentExclusion flags / Highest Risk Colour flags&#10;            do_upd_offender_flags(l_tgt_offender_id);&#10;            --&#10;            do_submit_mt_change(l_tgt_offender_id);&#10;            --&#10;            -- DST-11782: Perform CAS calculationfor the Target Offender&#10;            do_CAS_calc;&#10;            --&#10;        END do_post_merge_updates;&#10;        --&#10;    BEGIN&#10;        --&#10;        LC_DATE_TIME :&#61; SYSDATE;&#10;        LC_DATE      :&#61; TRUNC(LC_DATE_TIME);&#10;        --&#10;        -- Update Target Offender attributes (overwrite specified list of attributes)&#10;        info(&#39;DO_UPD_OFFENDER [src_off_id&#61;&#39; || l_src_offender_id || &#39;][tgt_off_id&#61;&#39; || l_tgt_offender_id || &#39;]&#39;, p_trace_level&#61;&gt;15, p_proc&#61;&gt;l_proc1);&#10;        do_upd_offender;&#10;        --&#10;        do_identify_duplicates;&#10;        do_post_merge_updates;&#10;        do_create_off_merge_contact;&#10;        do_create_om_transfer_contact;&#10;        --&#10;        -- NDM-180: Create new Target OM/RO/OT/SGC only when P_MOVE_PROVIDER&#61;Y&#10;        IF g_merge_ctx_rec.move_provider &#61; &#39;Y&#39; THEN&#10;            info(&#39; ** NDM-180: Calling do_check_target_OM to create new OM/RO/OT/SGC on the Target Offender&#39;);&#10;            -- NDM-167: Create new OM/RO/OT/SGC Contacts&#10;            do_check_target_OM;&#10;        END IF;&#10;        --&#10;        do_rebuild_orgs;&#10;        --&#10;    END do_post_merge;&#10;    --&#10;BEGIN /*procMergeOffenders_NEW*/&#10;    --&#10;    g_procedure_name  :&#61; l_proc;&#10;    g_label           :&#61; &#39;00010&#39;;&#10;    --&#10;    set_merge_running_flag(&#39;Y&#39;);&#10;    --&#10;    do_print_debug_details;&#10;    --&#10;    do_pre_merge;&#10;    --&#10;    g_label           :&#61; &#39;00020&#39;;&#10;    --&#10;    PKG_hier_support.offender_records_iterator(&#10;        --&#10;        p_offender_id         &#61;&gt; l_src_offender_id,&#10;        p_offender_id_1       &#61;&gt; l_tgt_offender_id,&#10;        --&#10;        p_tab_name            &#61;&gt; &#39;OFFENDER&#39;,&#10;        p_row_id              &#61;&gt; l_src_row_id,&#10;        p_recursive_level     &#61;&gt; 1,&#10;        --&#10;        p_when_to_execute     &#61;&gt; &#39;PRE&#39;,&#10;        p_ignore_where_clause &#61;&gt; &#39;N&#39;,&#10;        --&#10;        p_exclude_merged      &#61;&gt; &#39;Y&#39;,&#10;        --&#10;        p_dyn_SQL             &#61;&gt;&#10;           &#39;DECLARE&#10;                --&#10;                l_parent_table    VARCHAR2(30) :&#61; :p_parent_table;&#10;                l_table           VARCHAR2(30) :&#61; :p_table;&#10;                l_offender_id     NUMBER       :&#61; :p_offender_id;&#10;                l_parent_row_id   ROWID        :&#61; :p_parent_row_id;&#10;                l_row_id          ROWID        :&#61; :p_row_id;&#10;                l_recursive_level INTEGER      :&#61; :p_recursive_level;&#10;                --&#10;            BEGIN&#10;                IF l_parent_table IS NOT NULL THEN&#10;                    PKG_Merge_Offender.off_merge_curr_rec(&#10;                        p_parent_table    &#61;&gt; l_parent_table,&#10;                        p_table           &#61;&gt; l_table,&#10;                        p_offender_id     &#61;&gt; l_offender_id,&#10;                        p_parent_row_id   &#61;&gt; l_parent_row_id,&#10;                        p_row_id          &#61;&gt; l_row_id,&#10;                        p_recursive_level &#61;&gt; l_recursive_level );&#10;                END IF;&#10;            END;&#39;,&#10;            --&#10;            p_skip_subtrees &#61;&gt; get_merge_skip_subtree_list&#10;            );&#10;    --&#10;    do_post_merge;&#10;    --&#10;    set_merge_running_flag(&#39;N&#39;);&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    set_merge_running_flag(&#39;N&#39;);&#10;    --&#10;    RAISE;&#10;    --&#10;END procMergeOffenders_NEW;&#10;--&#10;--&#10;-- MMS Unmerge&#10;--&#10;PROCEDURE off_unmerge_curr_rec(&#10;    p_parent_table    VARCHAR2,&#10;    p_table           VARCHAR2,&#10;    p_offender_id     NUMBER,&#10;    p_parent_row_id   ROWID,&#10;    p_row_id          ROWID,&#10;    p_recursive_level NUMBER )&#10;IS&#10;    --&#10;    l_proc VARCHAR2(30) :&#61; &#39;OFF_UNMERGE_CURR_REC&#39;;&#10;    --&#10;    LC_USER_ID          NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;    LC_DATE_TIME        DATE   :&#61; SYSDATE;&#10;    LC_DATE             DATE   :&#61; TRUNC(LC_DATE_TIME);&#10;    --&#10;    l_rows        INTEGER :&#61; 0;&#10;    --&#10;    l_OMD_found_flag  BOOLEAN :&#61; FALSE;&#10;    l_move_2_src_flag BOOLEAN :&#61; FALSE;&#10;    --&#10;    TYPE l_rec_OMD_TYP IS RECORD(&#10;      src_crn OFFENDER.crn%TYPE,&#10;      tgt_crn OFFENDER.crn%TYPE,&#10;      --&#10;      offender_merge_details_id NUMBER,&#10;      hierarchy_level           OFFENDER_MERGE_DETAILS.hierarchy_level%TYPE,&#10;      parent_table              OFFENDER_MERGE_DETAILS.parent_table%TYPE,&#10;      table_name                OFFENDER_MERGE_DETAILS.table_name%TYPE,&#10;      source_offender_id        NUMBER,&#10;      target_offender_id        NUMBER,&#10;      source_pk_value           OFFENDER_MERGE_DETAILS.source_pk_value%TYPE,&#10;      target_pk_value           OFFENDER_MERGE_DETAILS.target_pk_value%TYPE,&#10;      source_fk_value           OFFENDER_MERGE_DETAILS.source_fk_value%TYPE,&#10;      target_fk_value           OFFENDER_MERGE_DETAILS.target_fk_value%TYPE,&#10;      debug_notes               OFFENDER_MERGE_DETAILS.debug_notes%TYPE );&#10;    --&#10;    l_rec_OMD     l_rec_OMD_TYP;&#10;    --&#10;    l_tab_pk_key  VARCHAR2(1000);&#10;    --&#10;    l_alf_doc_fld        VARCHAR2(30);&#10;    l_alf_doc_id         DOCUMENT.alfresco_document_id%TYPE;&#10;    l_external_reference DOCUMENT.external_reference%TYPE;&#10;    --&#10;    PROCEDURE do_fetch_OMD&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_FETCH_OMD&#39;;&#10;        --&#10;        TYPE l_cur_TYP IS REF CURSOR;&#10;        --&#10;        l_cur        l_cur_TYP;&#10;        l_SQL        VARCHAR2(2048);&#10;        l_found_flag BOOLEAN;&#10;        --&#10;    BEGIN&#10;        --&#10;        l_tab_pk_key :&#61; PKG_DynSQL.get_tab_pk_fld_lst(p_table, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1);&#10;        --&#10;        l_SQL :&#61;&#10;           &#39;SELECT&#10;             O1.crn AS src_crn,&#10;             O2.crn AS tgt_crn,&#10;             --&#10;             OMD.offender_merge_details_id,&#10;             OMD.hierarchy_level,&#10;             OMD.parent_table,&#10;             OMD.table_name,&#10;             OMD.source_offender_id,&#10;             OMD.target_offender_id,&#10;             OMD.source_pk_value,&#10;             OMD.target_pk_value,&#10;             OMD.source_fk_value,&#10;             OMD.target_fk_value,&#10;             OMD.debug_notes&#10;            FROM&#10;              &#39; || p_table || &#39; T&#10;                INNER JOIN offender_merge_details OMD ON OMD.table_name &#61; &#39;&#39;&#39; || UPPER(TRIM(p_table)) || &#39;&#39;&#39;&#10;                                                     AND OMD.target_pk_value &#61; &#39; || l_tab_pk_key || &#39;&#10;                                                     AND OMD.source_offender_id &#61; :p_src_offender_id&#10;                  INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;                  INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;            WHERE T.rowid &#61; :p_row_id&#39;;&#10;        --&#10;        OPEN l_cur FOR l_SQL USING g_merge_ctx_rec.src_offender_id, p_row_id;&#10;        FETCH l_cur INTO l_rec_OMD;&#10;        l_found_flag :&#61; l_cur%FOUND;&#10;        CLOSE l_cur;&#10;        --&#10;        IF NOT l_found_flag THEN&#10;            l_OMD_found_flag :&#61; FALSE;&#10;            --&#10;            info(&#10;                &#39;[parent_table&#61;&#39;    || p_parent_table    || &#39;]&#39;   ||&#10;                &#39;[table&#61;&#39;           || p_table           || &#39;]&#39;   ||&#10;                &#39;[offender_id&#61;&#39;     || p_offender_id     || &#39;]&#39;   ||&#10;                &#39;[parent_ROWID&#61;&#39;    || p_parent_row_id   || &#39;]&#39;   ||&#10;                &#39;[ROWID&#61;&#39;           || p_row_id          || &#39;]: &#39; ||&#10;                &#39;WARNING - record must have been deleted as a previous level&#39;,&#10;                --&#10;                p_trace_level &#61;&gt; 30,&#10;                p_proc        &#61;&gt; l_proc1 );&#10;        ELSE&#10;            l_OMD_found_flag :&#61; TRUE;&#10;        END IF;&#10;        --&#10;    END do_fetch_OMD;&#10;    --&#10;    PROCEDURE do_restore_orig_fld_values(p_init_flag VARCHAR2 DEFAULT &#39;N&#39;)&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_RESTORE_ORIG_FLD_VALUES&#39;;&#10;        --&#10;        l_OMD_ID NUMBER;&#10;        --&#10;        PROCEDURE do_amend_alf_doc_id_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_ALF_DOC_ID_U&#39;;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                --&#10;                SELECT&#10;                  DECODE( p_table,&#10;                      &#39;DOCUMENT&#39;             , &#39;ALFRESCO_DOCUMENT_ID&#39;,&#10;--                      &#39;OFFENDER&#39;             , &#39;PREV_CON_ALFRESCO_DOCUMENT_ID&#39;,&#10;--                      &#39;EVENT&#39;                , &#39;CPS_ALFRESCO_DOCUMENT_ID&#39;,&#10;                      &#39;PRECON_HISTORY&#39;       , &#39;ALFRESCO_DOCUMENT_ID&#39;,&#10;                      &#39;SUBJECT_ACCESS_REPORT&#39;, &#39;SAR_ALFRESCO_ID&#39;,&#10;                      NULL )&#10;                INTO&#10;                  l_alf_doc_fld&#10;                FROM dual;&#10;                --&#10;                IF l_alf_doc_fld IS NOT NULL THEN&#10;                    l_alf_doc_id :&#61; get_omd_hist(l_OMD_ID, l_alf_doc_fld, &#39;NEW&#39;);&#10;                END IF;&#10;                --&#10;                IF p_table &#61; &#39;DOCUMENT&#39; THEN&#10;                    l_external_reference :&#61; get_omd_hist(l_OMD_ID, &#39;EXTERNAL_REFERENCE&#39;, &#39;NEW&#39;);&#10;                END IF;&#10;                --&#10;            ELSE -- p_init_flag&#61;N&#10;                --&#10;                IF TRIM(l_alf_doc_id) IS NOT NULL THEN&#10;                    --&#10;                    EXECUTE IMMEDIATE&#10;                     &#39;UPDATE &#39; || p_table || &#39; SET &#39; || l_alf_doc_fld || &#39; &#61; :p_alf_doc_id&#10;                      WHERE &#39; || l_tab_pk_key || &#39; &#61; :p_pk_val&#39;&#10;                    USING&#10;                      l_alf_doc_id,&#10;                      l_rec_OMD.source_pk_value;&#10;                    --&#10;                    IF SQL%ROWCOUNT &#61; 0 THEN&#10;                        fatal( &#39;FAILED to restore the &#39; || p_table || &#39;.&#39; || l_alf_doc_fld || &#39; in the source record &#39; ||&#10;                            &#39;[pk&#61;&#39;     || l_rec_OMD.source_pk_value           || &#39;]&#39; ||&#10;                            &#39;[omd_id&#61;&#39; || l_rec_OMD.offender_merge_details_ID || &#39;]&#39;,&#10;                            --&#10;                            l_proc2 );&#10;                    END IF;&#10;                    --&#10;                    info( l_proc1 || &#39;: Restored ALF_DOC_ID on &#39; || p_table || &#39; for the Source Offender &#39; ||&#10;                        &#39;[src_offender_id&#61;&#39; || g_merge_ctx_rec.src_offender_id || &#39;]&#39; ||&#10;                        &#39;[src_crn&#61;&#39;         || g_merge_ctx_rec.src_crn         || &#39;]&#39; ||&#10;                        &#39;[pk&#61;&#39;              || l_rec_OMD.source_pk_value       || &#39;]&#39; ||&#10;                        &#39;[ALF_DOC_ID&#61;&#39;      || l_alf_doc_id                    || &#39;]&#39;,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; l_proc2 );&#10;                    --&#10;                END IF;&#10;                --&#10;                IF p_table &#61; &#39;DOCUMENT&#39; AND TRIM(l_external_reference) IS NOT NULL THEN&#10;                    --&#10;                    UPDATE document SET external_reference &#61; l_external_reference&#10;                    WHERE document_id &#61; l_rec_OMD.source_pk_value;&#10;                    --&#10;                    IF SQL%ROWCOUNT &#61; 0 THEN&#10;                        fatal( &#39;FAILED to restore the DOCUMENT.external_reference in the source record &#39; ||&#10;                            &#39;[pk&#61;&#39;     || l_rec_OMD.source_pk_value           || &#39;]&#39; ||&#10;                            &#39;[omd_id&#61;&#39; || l_rec_OMD.offender_merge_details_ID || &#39;]&#39;,&#10;                            --&#10;                            l_proc2 );&#10;                    END IF;&#10;                    --&#10;                    info( l_proc1 || &#39;: Restored EXTERNAL_REFERENCE on &#39; || p_table || &#39; for the Source Offender &#39; ||&#10;                        &#39;[src_offender_id&#61;&#39;    || g_merge_ctx_rec.src_offender_id || &#39;]&#39; ||&#10;                        &#39;[src_crn&#61;&#39;            || g_merge_ctx_rec.src_crn         || &#39;]&#39; ||&#10;                        &#39;[pk&#61;&#39;                 || l_rec_OMD.source_pk_value       || &#39;]&#39; ||&#10;                        &#39;[EXTERNAL_REFERENCE&#61;&#39; || l_external_reference            || &#39;]&#39;,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; l_proc2 );&#10;                    --&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;        END do_amend_alf_doc_id_U;&#10;        --&#10;        PROCEDURE do_amend_OM_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_OM_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_OM IS&#10;            BEGIN&#10;                --&#10;                -- Restore original active OM&#10;                UPDATE offender_manager SET&#10;                  end_date              &#61; NULL,&#10;                  active_flag           &#61; 1,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; NVL(l_offender_id, offender_id)&#10;                  AND offender_manager_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; Active OM record &#39; ||&#10;                        &#39;[OMD_id&#61;&#39;           || l_rec_OMD.offender_merge_details_id || &#39;]&#39; ||&#10;                        &#39;[offender_id&#61;&#39;      || l_offender_id                       || &#39;]&#39; ||&#10;                        &#39;[om_id&#61;&#39;            || l_id                                || &#39;]&#39; ||&#10;                        &#39;[tgt_pk_value&#61;&#39;     || l_rec_OMD.target_pk_value           || &#39;]&#39; ||&#10;                        &#39;[debug_notes&#61;&#39;      || l_rec_OMD.debug_notes               || &#39;]&#39; ||&#10;                        &#39;[GC_RETAIN_ON_TGT&#61;&#39; || GC_RETAIN_ON_TGT                    || &#39;]&#39;,&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(&#10;                    l_proc1 || &#39;: Restored Original Active OM on &#39; || p_table || &#39; for the &#39; ||&#10;                    l_src_tgt ||&#10;                    &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn                           || &#39;]&#39; ||&#10;                    &#39;[om_id&#61;&#39;       || l_id                            || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_OM;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Restore Active OM on either the Source or Target&#10;                IF get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;NEW&#39;) &#61; 0 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;OLD&#39;) &#61; 1&#10;                THEN&#10;                    l_id :&#61; get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;PK&#39;, NULL, p_value_if_null&#61;&gt;l_rec_OMD.target_pk_value);&#10;                    IF    l_id &#61; l_rec_OMD.target_pk_value                                                      -- Source Record (P_MOVE_PROVIDER&#61;N)&#10;                       OR ( l_id &lt;&gt; l_rec_OMD.target_pk_value AND l_rec_OMD.debug_notes LIKE GC_RETAIN_ON_TGT ) -- New Tgt OM (NDM-167)&#10;                    THEN&#10;                        -- Restore OM Active Flag on Source&#10;                        l_src_tgt     :&#61; &#39;Source&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                        IF l_rec_OMD.debug_notes LIKE GC_RETAIN_ON_TGT THEN&#10;                            l_offender_id :&#61; NULL;&#10;                        ELSE&#10;                            l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                        END IF;&#10;                    ELSE&#10;                        -- NDM-168: no need restoring the original Active OM - new record will be created instead&#10;                        l_id :&#61; -1;&#10;                        --&#10;                        -- Restore OM Active Flag on Target&#10;                        l_src_tgt     :&#61; &#39;Target&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                    END IF;&#10;                END IF;&#10;            ELSE&#10;                -- Restore Active OM on the Target&#10;                IF get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;NEW&#39;, &#39;NOT NULL&#39;) &#61; 0 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;OLD&#39;, &#39;NOT NULL&#39;) &#61; 1&#10;                THEN&#10;                    l_src_tgt     :&#61; &#39;Target&#39;;&#10;                    l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                    l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                    l_id          :&#61; get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;PK&#39;, &#39;NOT NULL&#39;);&#10;                END IF;&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_OM;&#10;            END IF;&#10;            --&#10;        END do_amend_OM_U;&#10;        --&#10;        PROCEDURE do_amend_off_religion_hist_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_OFF_RELIGION_HIST_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            l_orh_end_date DATE;&#10;            --&#10;            PROCEDURE do_upd_off_religion_hist IS&#10;            BEGIN&#10;                --&#10;                UPDATE offender_religion_history SET&#10;                  end_date &#61; l_orh_end_date&#10;--                  row_version           &#61; row_version + 1,&#10;--                  last_updated_datetime &#61; LC_DATE_TIME,&#10;--                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND offender_religion_history_id &#61; l_id&#10;                ;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; ORH record &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[orh_id&#61;&#39;      || l_id          || &#39;]&#39;,&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored ORH.end_date for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn         || &#39;]&#39; ||&#10;                    &#39;[orh_id&#61;&#39;      || l_id          || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_off_religion_hist;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                --&#10;                IF get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;NEW&#39;) IS NOT NULL AND&#10;                   get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;) IS NULL&#10;                THEN&#10;                    --&#10;                    l_id :&#61; l_rec_OMD.target_pk_value;&#10;                    l_orh_end_date :&#61; PKG_Common.char_2_date(get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;));&#10;                    -- Restore MT.end_date on Source&#10;                    l_src_tgt     :&#61; &#39;Source&#39;;&#10;                    l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                    l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                    --&#10;                ELSIF get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;NEW&#39;, p_value_if_null&#61;&gt;&#39;xNULLx&#39;) &#61; &#39;xNULLx&#39; AND&#10;                      get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;, p_value_if_null&#61;&gt;&#39;xNULLx&#39;) &#61; &#39;xNULLx&#39;&#10;                THEN&#10;                    -- The merged Source records wasn&#39;t end dated&#10;                    -- therefore make sure it is still Active (END_DATE IS NULL) after it is moved back to the Source CRN&#10;                    l_id :&#61; l_rec_OMD.target_pk_value;&#10;                    l_orh_end_date :&#61; NULL;&#10;                    -- Restore MT.end_date on Source&#10;                    l_src_tgt     :&#61; &#39;Source&#39;;&#10;                    l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                    l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                    --&#10;                END IF;&#10;            ELSE&#10;                --&#10;                l_id :&#61; &#39;-1&#39;;&#10;                --&#10;            END IF;&#10;            --&#10;            IF l_id &lt;&gt; &#39;-1&#39; THEN&#10;                do_upd_off_religion_hist;&#10;            END IF;&#10;            --&#10;        END do_amend_off_religion_hist_U;&#10;        --&#10;        PROCEDURE do_amend_management_tier_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;do_amend_management_tier_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            l_mt_end_date DATE;&#10;            --&#10;            PROCEDURE do_upd_MT IS&#10;            BEGIN&#10;                --&#10;                IF l_mt_end_date IS NULL THEN&#10;                    --&#10;                    UPDATE management_tier SET&#10;                      end_date              &#61; LC_DATE_TIME,&#10;                      row_version           &#61; row_version + 1,&#10;                      --last_updated_datetime &#61; LC_DATE_TIME,&#10;                      last_updated_user_id  &#61; LC_USER_ID&#10;                    WHERE offender_id &#61; l_offender_id&#10;                      AND end_date IS NULL&#10;                      AND offender_id || &#39;:&#39; || tier_id || &#39;:&#39; || date_changed &lt;&gt; l_id;&#10;                    --&#10;                END IF;&#10;                --&#10;                UPDATE management_tier SET&#10;                  end_date &#61; l_mt_end_date&#10;--                  row_version           &#61; row_version + 1,&#10;--                  last_updated_datetime &#61; LC_DATE_TIME,&#10;--                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND tier_id &#61; PKG_LstUtl.list_num_elem(l_id, &#39;:&#39;, 2)&#10;                  AND offender_id || &#39;:&#39; || tier_id || &#39;:&#39; || date_changed &#61; l_id&#10;                  --AND date_changed &#61; PKG_Common.char_2_timestamp(PKG_LstUtl.list_num_elem(l_id, &#39;:&#39;, 3))&#10;                ;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; MT record &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[mt_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored MT.end_date for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn         || &#39;]&#39; ||&#10;                    &#39;[mt_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_MT;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                --&#10;                IF NVL(get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;NEW&#39;), &#39;xyz&#39;) &lt;&gt; NVL(get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;), &#39;xyz&#39;) THEN&#10;                    --&#10;                    l_id :&#61; REPLACE(l_rec_OMD.target_pk_value, l_rec_OMD.target_offender_id || &#39;:&#39;, l_rec_OMD.source_offender_id || &#39;:&#39;);&#10;                    l_mt_end_date :&#61; PKG_Common.char_2_date(get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;));&#10;                    -- Restore MT.end_date on Source&#10;                    l_src_tgt     :&#61; &#39;Source&#39;;&#10;                    l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                    l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                    --&#10;                END IF;&#10;            ELSE&#10;                --&#10;                l_id :&#61; &#39;-1&#39;;&#10;                --&#10;            END IF;&#10;            --&#10;            IF l_id &lt;&gt; &#39;-1&#39; THEN&#10;                do_upd_MT;&#10;            END IF;&#10;            --&#10;        END do_amend_management_tier_U;&#10;        --&#10;        PROCEDURE do_amend_POM_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_POM_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_POM IS&#10;            BEGIN&#10;                --&#10;                UPDATE prison_offender_manager SET&#10;                  end_date              &#61; NULL,&#10;                  active_flag           &#61; 1,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND prison_offender_manager_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;ERROR: failed to restore the Active POM on the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[pom_id&#61;&#39;      || l_id          || &#39;]&#39;,&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                IF l_src_tgt &#61; &#39;Source&#39; THEN&#10;                    -- End Date all previous Source POM records&#10;                    UPDATE prison_offender_manager SET&#10;                      end_date              &#61; LC_DATE_TIME,&#10;                      active_flag           &#61; 0,&#10;                      row_version           &#61; row_version + 1,&#10;                      last_updated_datetime &#61; LC_DATE_TIME,&#10;                      last_updated_user_id  &#61; LC_USER_ID&#10;                    WHERE offender_id &#61; l_offender_id&#10;                      AND prison_offender_manager_id &lt;&gt; l_id&#10;                      AND end_date IS NULL;&#10;                    --&#10;                    IF SQL%ROWCOUNT &gt; 0 THEN&#10;                        info(&#10;                            l_proc1 || &#39;: &#39; || SQL%ROWCOUNT || &#39; previous Active POM record(s) have been end dated for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                            --&#39;[offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39; ||&#10;                            &#39;[crn&#61;&#39; || l_crn || &#39;]&#39;,&#10;                            --&#10;                            p_trace_level &#61;&gt; 15,&#10;                            p_proc        &#61;&gt; l_proc2 );&#10;&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;                info(&#10;                    l_proc1 || &#39;: Restored Original Active POM for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn                           || &#39;]&#39; ||&#10;                    &#39;[pom_id&#61;&#39;      || l_id                            || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_POM;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Restore Active POM on the either Source or Target&#10;                IF get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;NEW&#39;) &#61; 0 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;OLD&#39;) &#61; 1&#10;                THEN&#10;                    l_id :&#61; get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;PK&#39;, NULL, p_value_if_null&#61;&gt;l_rec_OMD.target_pk_value);&#10;                    IF l_id &#61; l_rec_OMD.target_pk_value THEN&#10;                        -- Restore POM Active Flag on Source&#10;                        l_src_tgt     :&#61; &#39;Source&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                        --&#10;                    ELSIF ( -- End Dated POM was the Src record (already moved back to the Source)&#10;                            TO_CHAR(l_rec_OMD.source_offender_id) &#61;&#10;                            PKG_Lookups.funcgetTabRecord(&#10;                                p_table    &#61;&gt; &#39;PRISON_OFFENDER_MANAGER&#39;,&#10;                                p_data_fld &#61;&gt; &#39;offender_id&#39;,&#10;                                p_ref_col  &#61;&gt; &#39;PRISON_OFFENDER_MANAGER_ID&#39;,&#10;                                p_ref_val  &#61;&gt; l_id )&#10;                          ) OR (&#10;                            -- End Dated POM was the Src record (has not been moved back yet to the Source)&#10;                            &#39;1&#39; &#61;&#10;                            PKG_Lookups.funcgetTabRecord(&#10;                                p_table    &#61;&gt; &#39;OFFENDER_MERGE_DETAILS&#39;,&#10;                                p_data_fld &#61;&gt; &#39;1&#39;,&#10;                                p_ref_col  &#61;&gt; &#39;target_pk_value&#39;,&#10;                                p_ref_val  &#61;&gt; l_id,&#10;                                p_where    &#61;&gt; &#39;table_name &#61; :p_table_name&#10;                                           AND target_pk_value &#61; :p_tgt_pk&#10;                                           AND source_offender_id &#61; :p_src_offender_id&#10;                                           AND target_offender_id &#61; :p_tgt_offender_id&#39;,&#10;                                p_bind_var1 &#61;&gt; &#39;PRISON_OFFENDER_MANAGER&#39;,&#10;                                p_bind_var2 &#61;&gt; l_id,&#10;                                p_bind_var3 &#61;&gt; l_rec_OMD.source_offender_id,&#10;                                p_bind_var4 &#61;&gt; l_rec_OMD.target_offender_id )&#10;                          )&#10;                    THEN&#10;                        --&#10;                        l_id          :&#61; -1;&#10;                        l_src_tgt     :&#61; &#39;Source&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                        --&#10;                        info(&#10;                            l_proc1 || &#39;: No need to Restore the Original Active POM for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                            --&#39;[offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39; ||&#10;                            &#39;[crn&#61;&#39;         || l_crn                           || &#39;]&#39; ||&#10;                            &#39;[pom_id&#61;&#39;      || l_id                            || &#39;]&#39;,&#10;                            --&#10;                            p_trace_level &#61;&gt; 15,&#10;                            p_proc        &#61;&gt; l_proc2 );&#10;                        --&#10;                    ELSE&#10;                        -- Restore POM Active Flag on Target&#10;                        l_src_tgt     :&#61; &#39;Target&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                    END IF;&#10;                END IF;&#10;            ELSE&#10;                -- No need doing anything on the Target POM records&#10;                l_id :&#61; -1; -- get_omd_hist(l_OMD_ID, &#39;ACTIVE_FLAG&#39;, &#39;PK&#39;, &#39;NOT NULL&#39;);&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_POM;&#10;            END IF;&#10;            --&#10;        END do_amend_POM_U;&#10;        --&#10;        PROCEDURE do_amend_OT_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_OT_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_OT IS&#10;            BEGIN&#10;                --&#10;                UPDATE offender_transfer SET&#10;                  soft_deleted           &#61; 0,&#10;                  --&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND offender_transfer_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;FAILED to restore the OFFENDER_TRANSFER.soft_deleted in the &#39; || l_src_tgt || &#39; Ofender &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[ot_id&#61;&#39;       || l_id          || &#39;]&#39; ||&#10;                        &#39;[omd_id&#61;&#39;      || l_rec_OMD.offender_merge_details_ID || &#39;]&#39;,&#10;                        --&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored SOFT_DELETED on OFFENDER_TRANSFER for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    &#39;[offender_id&#61;&#39;  || l_offender_id             || &#39;]&#39; ||&#10;                    &#39;[src_crn&#61;&#39;      || l_crn                     || &#39;]&#39; ||&#10;                    &#39;[pk&#61;&#39;           || l_rec_OMD.source_pk_value || &#39;]&#39; ||&#10;                    &#39;[SOFT_DELETED&#61;&#39; || &#39;0&#39;                       || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_OT;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Cloned OT will already be undeleted so no need doing anything&#10;                l_id :&#61; -1;&#10;            ELSE&#10;                -- Recover soft deleted OT on the Source&#10;                IF get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;NEW&#39;) &#61; 0 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;OLD&#39;) &#61; 1&#10;                THEN&#10;                    --&#10;                    l_src_tgt     :&#61; &#39;Source&#39;;&#10;                    l_id          :&#61; l_rec_OMD.source_pk_value;&#10;                    l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                    l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                    --&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_OT;&#10;            END IF;&#10;            --&#10;        END do_amend_OT_U;&#10;        --&#10;        PROCEDURE do_amend_AP_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_AP_U&#39;;&#10;            --&#10;            l_ext_ref      APPROVED_PREMISES_REFERRAL.external_reference%TYPE;&#10;            l_soft_deleted APPROVED_PREMISES_REFERRAL.soft_deleted%TYPE;&#10;            --&#10;            l_id           VARCHAR2(100);&#10;            l_offender_id  NUMBER;&#10;            l_crn          OFFENDER.crn%TYPE;&#10;            l_src_tgt      VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_AP&#10;            IS&#10;                --&#10;                l_SQL CLOB;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_SQL :&#61;&#10;                --&#10;&#39;UPDATE approved_premises_referral SET&#10;&#39; || PKG_LstUtl.concat(&#10;           CASE WHEN l_ext_ref      IS NOT NULL THEN &#39;  external_reference &#61; &#39;&#39;&#39; || l_ext_ref || &#39;&#39;&#39;&#39; END,&#10;           CASE WHEN l_soft_deleted IS NOT NULL THEN &#39;  soft_deleted &#61; &#39;         || l_soft_deleted    END,&#10;           &#39;  row_version           &#61; row_version + 1&#39;,&#10;           &#39;  last_updated_datetime &#61; :p_date&#39;,&#10;           &#39;  last_updated_user_id  &#61; :p_user_id&#39;,&#10;           --&#10;           p_delim &#61;&gt; &#39;,&#39; || CHR(10) ) || &#39;&#10;  --&#10;WHERE offender_id &#61; :p_offender_id&#10;  AND approved_premises_referral_id &#61; :p_id&#39;;&#10;                --&#10;                EXECUTE IMMEDIATE l_SQL USING&#10;                    LC_DATE_TIME,&#10;                    LC_USER_ID,&#10;                    l_offender_id,&#10;                    l_id;&#10;                    --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;FAILED to restore the &#39; ||&#10;                        PKG_LstUtl.concat(&#10;                            CASE WHEN l_ext_ref      IS NOT NULL THEN &#39;[EXTERNAL_REFERENCE&#61;&#39; || l_ext_ref      || &#39;]&#39; END,&#10;                            CASE WHEN l_soft_deleted IS NOT NULL THEN &#39;[SOFT_DELETED&#61;&#39;       || l_soft_deleted || &#39;]&#39; END,&#10;                            p_delim &#61;&gt; &#39;/&#39; ) ||&#10;                        &#39; on APPROVED_PREMISES_REFERRAL in the &#39; || l_src_tgt || &#39; Ofender &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id                       || &#39;]&#39; ||&#10;                        &#39;[ot_id&#61;&#39;       || l_id                                || &#39;]&#39; ||&#10;                        &#39;[omd_id&#61;&#39;      || l_rec_OMD.offender_merge_details_ID || &#39;]&#39;,&#10;                        --&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(&#10;                    l_proc1 || &#39;: Restored &#39; ||&#10;                    PKG_LstUtl.concat(&#10;                        CASE WHEN l_ext_ref      IS NOT NULL THEN &#39;[EXTERNAL_REFERENCE&#61;&#39; || l_ext_ref      || &#39;]&#39; END,&#10;                        CASE WHEN l_soft_deleted IS NOT NULL THEN &#39;[SOFT_DELETED&#61;&#39;       || l_soft_deleted || &#39;]&#39; END,&#10;                        p_delim &#61;&gt; &#39;/&#39; ) ||&#10;                    &#39; on APPROVED_PREMISES_REFERRAL for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    &#39;[offender_id&#61;&#39; || l_offender_id             || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn                     || &#39;]&#39; ||&#10;                    &#39;[pk&#61;&#39;          || l_rec_OMD.source_pk_value || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_AP;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Cloned APR will already be undeleted so no need doing anything&#10;                l_id :&#61; -1;&#10;            ELSE&#10;                -- Recover soft deleted APR on the Source&#10;                IF get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;NEW&#39;) &#61; 0 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;OLD&#39;) &#61; 1&#10;                THEN&#10;                    l_soft_deleted :&#61; 0;&#10;                END IF;&#10;                --&#10;                l_ext_ref :&#61; get_omd_hist(l_OMD_ID, &#39;EXTERNAL_REFERENCE&#39;, &#39;NEW&#39;);&#10;                IF NOT( l_ext_ref IS NOT NULL AND&#10;                        get_omd_hist(l_OMD_ID, &#39;EXTERNAL_REFERENCE&#39;, &#39;OLD&#39;) IS NULL&#10;                      )&#10;                THEN&#10;                    l_ext_ref :&#61; NULL;&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_AP;&#10;            END IF;&#10;            --&#10;        END do_amend_AP_U;&#10;        --&#10;        PROCEDURE do_amend_RO_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_RO_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_RO IS&#10;            BEGIN&#10;                --&#10;                IF l_src_tgt IN ( &#39;Source&#39;, &#39;Target&#39; ) AND&#10;                   l_offender_id IS NOT NULL AND l_id IS NOT NULL&#10;                THEN&#10;                    -- End Date all previous Source RO records&#10;                    UPDATE responsible_officer SET&#10;                      end_date              &#61; LC_DATE_TIME,&#10;                      row_version           &#61; row_version + 1,&#10;                      last_updated_datetime &#61; LC_DATE_TIME,&#10;                      last_updated_user_id  &#61; LC_USER_ID&#10;                    WHERE offender_id &#61; l_offender_id&#10;                      AND responsible_officer_id &lt;&gt; l_id&#10;                      AND end_date IS NULL;&#10;                    --&#10;                    IF SQL%ROWCOUNT &gt; 0 THEN&#10;                        --&#10;                        info(&#10;                            l_proc1 || &#39;: &#39; || SQL%ROWCOUNT || &#39; previous Active RO record(s) have been end dated for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                            --&#39;[offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39; ||&#10;                            &#39;[crn&#61;&#39; || l_crn || &#39;]&#39;,&#10;                            --&#10;                            p_trace_level &#61;&gt; 15,&#10;                            p_proc        &#61;&gt; l_proc2 );&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;                -- Restore original active RO&#10;                UPDATE responsible_officer SET&#10;                  end_date              &#61; NULL,&#10;                  --&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE 1&#61;1&#10;                  AND offender_id &#61; NVL(l_offender_id, offender_id)&#10;                  AND responsible_officer_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    --&#10;                    DECLARE&#10;                        l_om_CRN VARCHAR2(10);&#10;                        l_ro_CRN VARCHAR2(10);&#10;                    BEGIN&#10;                        --&#10;                        SELECT O1.crn AS ro_CRN, O2.crn AS om_CRN INTO  l_ro_CRN, l_om_CRN&#10;                        FROM&#10;                          responsible_officer RO&#10;                            INNER JOIN offender O1 ON O1.offender_id &#61; RO.offender_id&#10;                            INNER JOIN offender_manager OM ON OM.offender_manager_id &#61; RO.offender_manager_id&#10;                              INNER JOIN offender O2 ON O2.offender_id &#61; OM.offender_id&#10;                        WHERE RO.responsible_officer_id &#61; l_id;&#10;                        --&#10;                        fatal(&#10;                            &#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; Active RO record &#39; ||&#10;                            &#39;[OMD_id&#61;&#39;           || l_rec_OMD.offender_merge_details_id || &#39;]&#39; ||&#10;                            &#39;[offender_id&#61;&#39;      || l_offender_id                       || &#39;]&#39; ||&#10;                            &#39;[ro_id&#61;&#39;            || l_id                                || &#39;]&#39; ||&#10;                            &#39;[tgt_pk_value&#61;&#39;     || l_rec_OMD.target_pk_value           || &#39;]&#39; ||&#10;                            &#39;[debug_notes&#61;&#39;      || l_rec_OMD.debug_notes               || &#39;]&#39; ||&#10;                            &#39;[GC_RETAIN_ON_TGT&#61;&#39; || GC_RETAIN_ON_TGT                    || &#39;]&#39; ||&#10;                            &#39;[ro_CRN&#61;&#39;           || l_ro_crn                            || &#39;]&#39; ||&#10;                            &#39;[om_CRN&#61;&#39;           || l_om_crn                            || &#39;]&#39;,&#10;                            --&#10;                            l_proc2);&#10;                        --&#10;                    END;&#10;                    --&#10;                END IF;&#10;                --&#10;                info(&#10;                    l_proc1 || &#39;: Restored Original Active RO on &#39; || p_table || &#39; for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn         || &#39;]&#39; ||&#10;                    &#39;[ro_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_RO;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Restore Active RO on either Source or Target&#10;                IF get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;NEW&#39;) IS NOT NULL AND&#10;                   get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;) IS NULL&#10;                THEN&#10;                    --&#10;                    l_id :&#61; get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;PK&#39;, NULL, p_value_if_null&#61;&gt;l_rec_OMD.target_pk_value);&#10;                    --&#10;                    IF l_id &#61; l_rec_OMD.target_pk_value THEN&#10;                        -- Source Record (P_MOVE_RO&#61;N)&#10;                        -- Restore Active RO on Source&#10;                        l_src_tgt     :&#61; &#39;Source&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                        --&#10;                    ELSIF l_id &lt;&gt; l_rec_OMD.target_pk_value AND l_rec_OMD.debug_notes LIKE GC_RETAIN_ON_TGT THEN&#10;                        -- Tgt Record (NDM-167)&#10;                        -- DST-14152: Restore Active RO on Target&#10;                        DECLARE&#10;                            --&#10;                            FUNCTION get_src_active_ro_qty_1 RETURN NUMBER&#10;                            IS&#10;                                l_qty NUMBER;&#10;                            BEGIN&#10;                                --&#10;                                SELECT COUNT(1)&#10;                                INTO l_qty&#10;                                FROM responsible_officer&#10;                                WHERE offender_id &#61; l_rec_OMD.source_offender_id&#10;                                  AND responsible_officer_id &#61; l_id&#10;                                  AND NOT EXISTS(&#10;                                    SELECT 1&#10;                                    FROM offender_merge_details&#10;                                    WHERE table_name &#61; &#39;RESPONSIBLE_OFFICER&#39;&#10;                                      AND source_offender_id &#61; l_rec_OMD.source_offender_id&#10;                                      AND target_offender_id &#61; l_rec_OMD.target_offender_id&#10;                                      AND target_pk_value &#61; l_id );&#10;                                --&#10;                                RETURN l_qty;&#10;                                --&#10;                            END get_src_active_ro_qty_1;&#10;                            --&#10;                            FUNCTION get_src_active_ro_qty_2 RETURN NUMBER&#10;                            IS&#10;                                l_qty NUMBER;&#10;                            BEGIN&#10;                                --&#10;                                SELECT COUNT(1)&#10;                                INTO l_qty&#10;                                FROM&#10;                                  offender_merge_details OMD&#10;                                    INNER JOIN responsible_officer RO ON RO.responsible_officer_id &#61; OMD.target_pk_value&#10;                                                                     AND RO.offender_id &#61; OMD.target_offender_id&#10;                                WHERE OMD.table_name &#61; &#39;RESPONSIBLE_OFFICER&#39;&#10;                                  AND OMD.source_offender_id &#61; l_rec_OMD.source_offender_id&#10;                                  AND OMD.target_offender_id &#61; l_rec_OMD.target_offender_id&#10;                                  AND OMD.target_pk_value &#61; l_id&#10;                                  AND OMD.offender_merge_details_id &lt;&gt; l_OMD_ID;&#10;                                --&#10;                                RETURN l_qty;&#10;                                --&#10;                            END get_src_active_ro_qty_2;&#10;                            --&#10;                        BEGIN&#10;                            --&#10;                            IF get_src_active_ro_qty_1 &gt; 0 THEN     -- Check if the l_ID actually belongs to the Source Active RO record: already moved back to the Src CRN?&#10;                                --&#10;                                l_src_tgt     :&#61; &#39;Source&#39;;&#10;                                l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                                l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                                --&#10;                                info(&#10;                                    l_proc1 || &#39;: GET_SRC_ACTIVE_RO_QTY_1 &gt; 0 on Active RO for the Source Offender &#39; ||&#10;                                    --&#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                                    &#39;[crn&#61;&#39;         || l_crn         || &#39;]&#39; ||&#10;                                    &#39;[ro_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                                    --&#10;                                    p_trace_level &#61;&gt; 15,&#10;                                    p_proc        &#61;&gt; l_proc2 );&#10;                                --&#10;                            ELSIF get_src_active_ro_qty_2 &gt; 0 THEN  -- Check if the l_ID actually belongs to the Source Active RO record: RO record is still with the Tgt CRN&#10;                                --&#10;                                l_src_tgt     :&#61; &#39;Source&#39;;&#10;                                l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                                l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                                --&#10;                                info(&#10;                                    l_proc1 || &#39;: GET_SRC_ACTIVE_RO_QTY_2 &gt; 0 on Active RO for the Source Offender &#39; ||&#10;                                    --&#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                                    &#39;[crn&#61;&#39;         || l_crn         || &#39;]&#39; ||&#10;                                    &#39;[ro_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                                    --&#10;                                    p_trace_level &#61;&gt; 15,&#10;                                    p_proc        &#61;&gt; l_proc2 );&#10;                                --&#10;                            ELSE&#10;                                l_src_tgt     :&#61; &#39;Target&#39;;&#10;                                l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                                l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                            END IF;&#10;                            --&#10;                        END;&#10;                        --&#10;                    ELSIF ( -- End Dated RO was the Src record (already moved back to the Source)&#10;                            TO_CHAR(l_rec_OMD.source_offender_id) &#61;&#10;                            PKG_Lookups.funcgetTabRecord(&#10;                                p_table    &#61;&gt; &#39;RESPONSIBLE_OFFICER&#39;,&#10;                                p_data_fld &#61;&gt; &#39;offender_id&#39;,&#10;                                p_ref_col  &#61;&gt; &#39;RESPONSIBLE_OFFICER_ID&#39;,&#10;                                p_ref_val  &#61;&gt; l_id )&#10;                          ) OR (&#10;                            -- End Dated RO was the Src record (has not been moved back yet to the Source)&#10;                            &#39;1&#39; &#61;&#10;                            PKG_Lookups.funcgetTabRecord(&#10;                                p_table    &#61;&gt; &#39;OFFENDER_MERGE_DETAILS&#39;,&#10;                                p_data_fld &#61;&gt; &#39;1&#39;,&#10;                                p_ref_col  &#61;&gt; &#39;target_pk_value&#39;,&#10;                                p_ref_val  &#61;&gt; l_id,&#10;                                p_where    &#61;&gt; &#39;table_name &#61; :p_table_name&#10;                                           AND target_pk_value &#61; :p_tgt_pk&#10;                                           AND source_offender_id &#61; :p_src_offender_id&#10;                                           AND target_offender_id &#61; :p_tgt_offender_id&#39;,&#10;                                p_bind_var1 &#61;&gt; &#39;RESPONSIBLE_OFFICER&#39;,&#10;                                p_bind_var2 &#61;&gt; l_id,&#10;                                p_bind_var3 &#61;&gt; l_rec_OMD.source_offender_id,&#10;                                p_bind_var4 &#61;&gt; l_rec_OMD.target_offender_id )&#10;                          )&#10;                    THEN&#10;                        --&#10;                        l_id          :&#61; -1;&#10;                        l_src_tgt     :&#61; &#39;Source&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                        --&#10;                        info(&#10;                            l_proc1 || &#39;: No need to Restore the Original Active RO for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                            --&#39;[offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39; ||&#10;                            &#39;[crn&#61;&#39;   || l_crn || &#39;]&#39; ||&#10;                            &#39;[ro_id&#61;&#39; || l_id  || &#39;]&#39;,&#10;                            --&#10;                            p_trace_level &#61;&gt; 15,&#10;                            p_proc        &#61;&gt; l_proc2 );&#10;                        --&#10;                    ELSE&#10;                        -- Restore Active RO on Target&#10;                        l_src_tgt     :&#61; &#39;Target&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                        --&#10;                    END IF;&#10;                END IF;&#10;            ELSE&#10;                IF get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;NEW&#39;, &#39;NOT NULL&#39;) IS NOT NULL AND&#10;                   get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;, &#39;NOT NULL&#39;) IS NULL&#10;                THEN&#10;                    -- Restore Active RO on the Target&#10;                    l_src_tgt     :&#61; &#39;Target&#39;;&#10;                    l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                    l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                    l_id          :&#61; get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;PK&#39;, &#39;NOT NULL&#39;);&#10;                END IF;&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_RO;&#10;            END IF;&#10;            --&#10;        END do_amend_RO_U;&#10;        --&#10;        PROCEDURE do_amend_OA_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_OA_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            l_address_status_id NUMBER;&#10;            --&#10;            PROCEDURE do_upd_OA&#10;            IS&#10;                --&#10;                l_address_status_main_id NUMBER;&#10;                l_address_status_prev_id NUMBER;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_address_status_main_id :&#61; PKG_Lookups.funcgetStdRefListID(p_code_set&#61;&gt;&#39;ADDRESS STATUS&#39;, p_code&#61;&gt;&#39;M&#39;);&#10;                l_address_status_prev_id :&#61; PKG_Lookups.funcgetStdRefListID(p_code_set&#61;&gt;&#39;ADDRESS STATUS&#39;, p_code&#61;&gt;&#39;P&#39;);&#10;                --&#10;                UPDATE offender_address SET&#10;                  address_status_id     &#61; NVL(l_address_status_id, address_status_id),&#10;                  end_date              &#61; NULL,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND offender_address_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; Active Offender Address record &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[oa_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored Original Active OA for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn         || &#39;]&#39; ||&#10;                    &#39;[oa_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_OA;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                --&#10;                IF get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;NEW&#39;) IS NOT NULL AND&#10;                   get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;) IS NULL&#10;                THEN&#10;                    --&#10;                    l_id :&#61; get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;PK&#39;, NULL, p_value_if_null&#61;&gt;l_rec_OMD.target_pk_value);&#10;                    IF l_id &#61; l_rec_OMD.target_pk_value THEN&#10;                        -- Restore Active OA on Source&#10;                        l_src_tgt     :&#61; &#39;Source&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                    ELSE&#10;                        -- Restore Active OA on Target&#10;                        l_src_tgt     :&#61; &#39;Target&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                    END IF;&#10;                    --&#10;                    l_address_status_id :&#61; get_omd_hist(l_OMD_ID, &#39;ADDRESS_STATUS_ID&#39;, &#39;OLD&#39;);&#10;                    --&#10;                END IF;&#10;            ELSE&#10;                IF get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;NEW&#39;, &#39;NOT NULL&#39;) IS NOT NULL AND&#10;                   get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;OLD&#39;, &#39;NOT NULL&#39;) IS NULL&#10;                THEN&#10;                    -- Restore original active OA&#10;                    l_src_tgt     :&#61; &#39;Target&#39;;&#10;                    l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                    l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                    l_id          :&#61; get_omd_hist(l_OMD_ID, &#39;END_DATE&#39;, &#39;PK&#39;, &#39;NOT NULL&#39;);&#10;                    --&#10;                    l_address_status_id :&#61; get_omd_hist(l_OMD_ID, &#39;ADDRESS_STATUS_ID&#39;, &#39;OLD&#39;);&#10;                    --&#10;                END IF;&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_OA;&#10;            END IF;&#10;            --&#10;        END do_amend_OA_U;&#10;        --&#10;        PROCEDURE do_amend_REG_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_REG_U&#39;;&#10;            --&#10;            l_soft_deleted VARCHAR2(1);&#10;            l_id           VARCHAR2(100);&#10;            l_offender_id  NUMBER;&#10;            l_crn          OFFENDER.crn%TYPE;&#10;            l_src_tgt      VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_check_for_dupl_reg_U&#10;            IS&#10;                --&#10;                l_proc2 VARCHAR2(30) :&#61; &#39;do_check_for_dupl_reg_U&#39;;&#10;                --&#10;                CURSOR cs1 IS&#10;                  SELECT DISTINCT&#10;                    OMD.offender_merge_details_id,&#10;                    OMD.source_pk_value,&#10;                    OMD.target_pk_value,&#10;                    DR.deregistration_id,&#10;                    DR.registration_id,&#10;                    DR.contact_id AS deregistration_contact_id&#10;                  FROM&#10;                    offender_merge_details OMD&#10;                      INNER JOIN offender_merge_details_hist OMDH ON OMDH.offender_merge_details_id &#61; OMD.offender_merge_details_id&#10;                                                                 AND OMDH.column_name &#61; &#39;DUPL_DEREGISTRATION_ID&#39;&#10;                        INNER JOIN deregistration DR ON DR.deregistration_id &#61; OMDH.table_pk_value&#10;                  WHERE 1&#61;1&#10;                    AND OMD.table_name &#61; &#39;REGISTRATION&#39;&#10;                    AND OMD.source_offender_id &#61; l_rec_OMD.source_offender_id&#10;                    AND OMD.target_offender_id &#61; l_rec_OMD.target_offender_id;&#10;                --&#10;                l_rec1 cs1%ROWTYPE;&#10;                --&#10;                PROCEDURE do_terminate_reg_review_U&#10;                IS&#10;                    --&#10;                    l_proc3 VARCHAR2(50) :&#61; l_proc2 || &#39;.&#39; || &#39;do_terminate_reg_review_U&#39;;&#10;                    --&#10;                    CURSOR cs2 IS&#10;                        SELECT DISTINCT&#10;                          RR.registration_review_id,&#10;                          RR.contact_id AS reg_review_contact_id&#10;                        FROM&#10;                          offender_merge_details_hist OMDH&#10;                            INNER JOIN registration_review RR ON RR.registration_review_id &#61; OMDH.table_pk_value&#10;                        WHERE OMDH.offender_merge_details_id &#61; l_rec1.offender_merge_details_id&#10;                          AND OMDH.column_name &#61; &#39;DUPL_REGISTRATION_REVIEW_ID&#39;;&#10;                    --&#10;                    l_rec2 cs2%ROWTYPE;&#10;                    --&#10;                    CURSOR cs3 IS&#10;                        SELECT DISTINCT&#10;                          RR.registration_review_id,&#10;                          PKG_Common.char_2_date(OMDH.old_value) AS review_date_due&#10;                        FROM&#10;                          offender_merge_details_hist OMDH&#10;                            INNER JOIN registration_review RR ON RR.registration_review_id &#61; OMDH.table_pk_value&#10;                        WHERE OMDH.offender_merge_details_id &#61; l_rec1.offender_merge_details_id&#10;                          AND OMDH.column_name &#61; &#39;DUPL_REG_REVIEW_DATE_DUE&#39;;&#10;                    --&#10;                    l_rec3 cs3%ROWTYPE;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    OPEN cs2;&#10;                    LOOP&#10;                        FETCH cs2 INTO l_rec2;&#10;                        EXIT WHEN cs2%NOTFOUND;&#10;                        --&#10;                        UPDATE registration_review SET soft_deleted &#61; 0&#10;                        WHERE registration_review_id &#61; l_rec2.registration_review_id&#10;                          AND soft_deleted &#61; 1;&#10;                        --&#10;                        info(SQL%ROWCOUNT || &#39; rows recovered (soft_deleted set back to 0) in REGISTRATION_REVIEW [id&#61;&#39; || l_rec2.registration_review_id || &#39;]&#39;, p_proc&#61;&gt;l_proc3);&#10;                        --&#10;                        UPDATE contact SET soft_deleted &#61; 0&#10;                        WHERE contact_id &#61; l_rec2.reg_review_contact_id&#10;                          AND soft_deleted &#61; 1;&#10;                        --&#10;                        info(SQL%ROWCOUNT || &#39; rows recovered (soft_deleted set back to 0) in CONTACT [id&#61;&#39; || l_rec2.reg_review_contact_id || &#39;]&#39;, p_proc&#61;&gt;l_proc3);&#10;                        --&#10;                    END LOOP;&#10;                    CLOSE cs2;&#10;                    --&#10;                    OPEN cs3;&#10;                    LOOP&#10;                        FETCH cs3 INTO l_rec3;&#10;                        EXIT WHEN cs3%NOTFOUND;&#10;                        --&#10;                        UPDATE registration_review SET review_date_due &#61; l_rec3.review_date_due&#10;                        WHERE registration_review_id &#61; l_rec3.registration_review_id&#10;                          AND review_date_due IS NULL;&#10;                        --&#10;                        info(SQL%ROWCOUNT || &#39; rows updated (REVIEW_DATE_DUE set to an original value) in REGISTRATION_REVIEW [id&#61;&#39; || l_rec3.registration_review_id || &#39;]&#39;, p_proc&#61;&gt;l_proc3);&#10;                        --&#10;                    END LOOP;&#10;                    CLOSE cs3;&#10;                    --&#10;                END do_terminate_reg_review_U;&#10;                --&#10;                PROCEDURE do_cr_dereg_U&#10;                IS&#10;                    --&#10;                    l_proc3 VARCHAR2(50) :&#61; l_proc2 || &#39;.&#39; || &#39;do_cr_dereg_U&#39;;&#10;                    --&#10;                    CURSOR cs2 IS&#10;                        SELECT DISTINCT&#10;                          NVL(table_pk_value, l_rec1.target_pk_value) AS registration_id,&#10;                          PKG_Common.char_2_date(old_value)           AS next_review_date&#10;                        FROM offender_merge_details_hist&#10;                        WHERE offender_merge_details_id &#61; l_rec1.offender_merge_details_id&#10;                          AND column_name &#61; &#39;DUPL_NEXT_REVIEW_DATE&#39;&#10;                          AND data_type &#61; &#39;D&#39;&#10;                          AND new_value IS NULL&#10;                          AND ( ( l_rec1.registration_id &#61;  l_rec1.target_pk_value AND table_pk_value IS NULL ) OR&#10;                                ( l_rec1.registration_id &lt;&gt; l_rec1.target_pk_value AND table_pk_value &#61; TO_CHAR(l_rec1.registration_id) ) );&#10;                    --&#10;                    l_rec2 cs2%ROWTYPE;&#10;                    --&#10;                BEGIN&#10;                    --&#10;                    DELETE FROM deregistration&#10;                    WHERE deregistration_id &#61; l_rec1.deregistration_id;&#10;                    --&#10;                    info(SQL%ROWCOUNT || &#39; rows deleted from DEREGISTRATION [id&#61;&#39; || l_rec1.deregistration_id || &#39;]&#39;, p_proc&#61;&gt;l_proc3);&#10;                    --&#10;                    DELETE FROM contact&#10;                    WHERE contact_id &#61; l_rec1.deregistration_contact_id;&#10;                    --&#10;                    info(SQL%ROWCOUNT || &#39; rows deleted from CONTACT [id&#61;&#39; || l_rec1.deregistration_contact_id || &#39;]&#39;, p_proc&#61;&gt;l_proc3);&#10;                    --&#10;                    OPEN cs2;&#10;                    LOOP&#10;                        FETCH cs2 INTO l_rec2;&#10;                        EXIT WHEN cs2%NOTFOUND;&#10;                        --&#10;                        UPDATE registration SET&#10;                          deregistered &#61; 0,&#10;                          next_review_date &#61; l_rec2.next_review_date&#10;                        WHERE registration_id &#61; l_rec2.registration_id&#10;                          AND deregistered &#61; 1;&#10;                        --&#10;                        info(SQL%ROWCOUNT || &#39; rows updated in REGISTRATION [id&#61;&#39; ||  l_rec2.registration_id || &#39;]&#39;, p_proc&#61;&gt;l_proc3);&#10;                        --&#10;                    END LOOP;&#10;                    CLOSE cs2;&#10;                    --&#10;                END do_cr_dereg_U;&#10;                --&#10;            BEGIN&#10;                --&#10;                OPEN cs1;&#10;                LOOP&#10;                    FETCH cs1 INTO l_rec1;&#10;                    EXIT WHEN cs1%NOTFOUND;&#10;                    --&#10;                    do_terminate_reg_review_U;&#10;                    do_cr_dereg_U;&#10;                    --&#10;                END LOOP;&#10;                CLOSE cs1;&#10;                --&#10;            END do_check_for_dupl_reg_U;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                --&#10;                l_id :&#61; -1;&#10;                --&#10;                -- DST-13073/DST-13097: Soft delete deregistered Registration Reviews&#10;                -- NOTE: At the REG record level (DO_AMEND_REG.do_check_for_dupl_reg) we have created DEREGISTRATION/DEREG_CONTACT records.&#10;                --       Now as all OMD (tergat_pk_value) data set is ready, we need to cancel (soft delete), all active REG_REVIEW record (if there are any)&#10;                do_check_for_dupl_reg_U;&#10;                --&#10;            ELSE&#10;                l_id :&#61; -1;&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                -- Restore original Registration&#10;                NULL;&#10;            END IF;&#10;            --&#10;        END do_amend_REG_U;&#10;        --&#10;        PROCEDURE do_amend_REG_REVIEW_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_REG_REVIEW_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_REG_REVIEW IS&#10;            BEGIN&#10;                --&#10;                UPDATE registration_review SET&#10;                  soft_deleted           &#61; 0,&#10;                  --&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND registration_review_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;FAILED to restore the REGISTRATION_REVIEW.soft_deleted in the &#39; || l_src_tgt || &#39; Ofender &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[ot_id&#61;&#39;       || l_id          || &#39;]&#39; ||&#10;                        &#39;[omd_id&#61;&#39;      || l_rec_OMD.offender_merge_details_ID || &#39;]&#39;,&#10;                        --&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored SOFT_DELETED on REGISTRATION_REVIEW for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    &#39;[offender_id&#61;&#39;  || l_offender_id             || &#39;]&#39; ||&#10;                    &#39;[src_crn&#61;&#39;      || l_crn                     || &#39;]&#39; ||&#10;                    &#39;[pk&#61;&#39;           || l_rec_OMD.source_pk_value || &#39;]&#39; ||&#10;                    &#39;[SOFT_DELETED&#61;&#39; || &#39;0&#39;                       || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_REG_REVIEW;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Cloned RR will already be undeleted so no need doing anything&#10;                l_id :&#61; -1;&#10;            ELSE&#10;                -- Recover soft deleted OT on the Source&#10;                IF get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;NEW&#39;) &#61; 0 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;OLD&#39;) &#61; 1&#10;                THEN&#10;                    --&#10;                    l_src_tgt     :&#61; &#39;Source&#39;;&#10;                    l_id          :&#61; l_rec_OMD.source_pk_value;&#10;                    l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                    l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                    --&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_REG_REVIEW;&#10;            END IF;&#10;            --&#10;        END do_amend_REG_REVIEW_U;&#10;        --&#10;        PROCEDURE do_amend_DOC_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;do_amend_DOC_U&#39;;&#10;            --&#10;            l_id           VARCHAR2(100);&#10;            l_offender_id  NUMBER;&#10;            l_crn          OFFENDER.crn%TYPE;&#10;            l_src_tgt      VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_DOC&#10;            IS&#10;                --&#10;                l_doc_type DOCUMENT.document_type%TYPE;&#10;                --&#10;            BEGIN&#10;                --&#10;                UPDATE document SET soft_deleted &#61; 0&#10;                WHERE document_id &#61; l_id&#10;                  AND soft_deleted &#61; 1&#10;                RETURNING document_type INTO l_doc_type;&#10;                --&#10;                IF l_doc_type &#61; &#39;PREVIOUS_CONVICTION&#39; THEN&#10;                    --&#10;                    UPDATE document SET soft_deleted &#61; 0&#10;                    WHERE document_id &#61; l_rec_OMD.source_pk_value&#10;                      AND soft_deleted &#61; 1;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_upd_DOC;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                --&#10;                -- Restore DOCUMENT on either the Source or Target&#10;                IF get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;NEW&#39;) &#61; 1 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;OLD&#39;) &#61; 0&#10;                THEN&#10;                    --&#10;                    l_id :&#61; get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;PK&#39;, NULL, p_value_if_null&#61;&gt;l_rec_OMD.target_pk_value);&#10;                    --&#10;                    IF l_id &#61; l_rec_OMD.target_pk_value THEN&#10;                        -- Source PRECON Record (P_MOVE_PRECON&#61;N)&#10;                        l_src_tgt      :&#61; &#39;Source&#39;;&#10;                        l_crn          :&#61; g_merge_ctx_rec.src_crn;&#10;                        l_offender_id  :&#61; l_rec_OMD.source_offender_id;&#10;                    ELSIF l_id NOT IN ( l_rec_OMD.source_pk_value, l_rec_OMD.target_pk_value ) THEN&#10;                        -- Restore PRECON on Target&#10;                        l_src_tgt     :&#61; &#39;Target&#39;;&#10;                        l_crn         :&#61; g_merge_ctx_rec.tgt_crn;&#10;                        l_offender_id :&#61; l_rec_OMD.target_offender_id;&#10;                    ELSE&#10;                        l_id :&#61; -1;&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;            ELSE&#10;                l_id :&#61; -1;&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_DOC;&#10;            END IF;&#10;            --&#10;        END do_amend_DOC_U;&#10;        --&#10;        PROCEDURE do_amend_CONTACT_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_CONTACT_U&#39;;&#10;            --&#10;            l_ext_ref     CONTACT.external_reference%TYPE;&#10;            l_nomis_id    VARCHAR2(100);&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_C IS&#10;            BEGIN&#10;                --&#10;                UPDATE contact SET&#10;                  nomis_case_note_id    &#61; l_nomis_id,&#10;                  external_reference    &#61; l_ext_ref,&#10;                  --&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND contact_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; CONTACT.nomis_case_note_id/external_reference [offender_id&#61;&#39; || l_rec_OMD.target_offender_id || &#39;][id&#61;&#39; || l_rec_OMD.source_pk_value || &#39;]&#39;, l_proc2);&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored Original CONTACT.nomis_case_note_id/external_reference on &#39; || p_table || &#39; for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39;        || g_merge_ctx_rec.src_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;                || l_crn         || &#39;]&#39; ||&#10;                    &#39;[contact_id&#61;&#39;         || l_id          || &#39;]&#39; ||&#10;                    &#39;[nomis_case_note_id&#61;&#39; || l_nomis_id    || &#39;]&#39; ||&#10;                    &#39;[external_reference&#61;&#39; || l_ext_ref     || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_C;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                l_id :&#61; -1;&#10;            ELSE&#10;                -- Restore the CONTACT NOMIS Case ID on the Source&#10;                l_src_tgt     :&#61; &#39;Source&#39;;&#10;                l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                l_id          :&#61; l_rec_OMD.source_pk_value;&#10;                l_nomis_id    :&#61; get_omd_hist(l_OMD_ID, &#39;NOMIS_CASE_NOTE_ID&#39;, &#39;NEW&#39;);&#10;                l_ext_ref     :&#61; get_omd_hist(l_OMD_ID, &#39;EXTERNAL_REFERENCE&#39;, &#39;NEW&#39;);&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                -- Restore original active OA&#10;                do_upd_C;&#10;            END IF;&#10;            --&#10;        END do_amend_CONTACT_U;&#10;        --&#10;        PROCEDURE do_amend_AI_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_AI_U&#39;;&#10;            --&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_AI IS&#10;            BEGIN&#10;                --&#10;                UPDATE additional_identifier SET soft_deleted &#61; 0&#10;                WHERE additional_identifier_id &#61; l_id&#10;                  AND soft_deleted &#61; 1;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    warn(&#10;                        &#39;WARNING: failed to restore the Additional Identifier on the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[ai_id&#61;&#39;       || l_id          || &#39;]&#39;,&#10;                        l_proc2 );&#10;                ELSE&#10;                    info(&#10;                        l_proc1 || &#39;: Recovered Original AI for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                        &#39;[crn&#61;&#39;   || l_crn || &#39;]&#39; ||&#10;                        &#39;[ai_id&#61;&#39; || l_id  || &#39;]&#39;,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; l_proc2 );&#10;                END IF;&#10;                --&#10;            END do_upd_AI;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Recover soft deleted AI on the Target (before it moves back to the Source CRN)&#10;                IF get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;NEW&#39;) &#61; 1 AND&#10;                   get_omd_hist(l_OMD_ID, &#39;SOFT_DELETED&#39;, &#39;OLD&#39;) &#61; 0&#10;                THEN&#10;                    l_id :&#61; l_rec_OMD.target_pk_value;&#10;                    -- Restore AI Soft Deleted Flag on Source&#10;                    l_src_tgt     :&#61; &#39;Source&#39;;&#10;                    l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                    l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                    --&#10;                END IF;&#10;            ELSE&#10;                -- No need doing anything on the Target AI records&#10;                l_id :&#61; -1;&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                do_upd_AI;&#10;            END IF;&#10;            --&#10;        END do_amend_AI_U;&#10;        --&#10;        PROCEDURE do_amend_NSI_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_NSI_U&#39;;&#10;            --&#10;            l_ext_ref     NSI.external_reference%TYPE;&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_N IS&#10;            BEGIN&#10;                --&#10;                UPDATE nsi SET&#10;                  external_reference    &#61; l_ext_ref,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_offender_id&#10;                  AND nsi_id &#61; l_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; NSI.nomis_case_note_id [offender_id&#61;&#39; || l_rec_OMD.target_offender_id || &#39;][id&#61;&#39; || l_rec_OMD.source_pk_value || &#39;]&#39;, l_proc2);&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored Original NSO.external_reference on &#39; || p_table || &#39; for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    --&#39;[offender_id&#61;&#39;        || g_merge_ctx_rec.src_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;                || l_crn         || &#39;]&#39; ||&#10;                    &#39;[nsi_id&#61;&#39;             || l_id          || &#39;]&#39; ||&#10;                    &#39;[external_reference&#61;&#39; || l_ext_ref     || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_N;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                l_id :&#61; -1;&#10;            ELSE&#10;                -- Restore the NSI External REF on the Source&#10;                l_src_tgt     :&#61; &#39;Source&#39;;&#10;                l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                l_id          :&#61; l_rec_OMD.source_pk_value;&#10;                l_ext_ref     :&#61; get_omd_hist(l_OMD_ID, &#39;EXTERNAL_REFERENCE&#39;, &#39;NEW&#39;);&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                -- Restore original NSI&#10;                do_upd_N;&#10;            END IF;&#10;            --&#10;        END do_amend_NSI_U;&#10;        --&#10;        PROCEDURE do_upd_OASYS_event_num_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_UPD_OASYS_EVENT_NUM_U&#39;;&#10;            --&#10;            l_event_num   VARCHAR2(100);&#10;            l_id          VARCHAR2(100);&#10;            l_offender_id NUMBER;&#10;            l_crn         OFFENDER.crn%TYPE;&#10;            l_src_tgt     VARCHAR2(30);&#10;            --&#10;            PROCEDURE do_upd_OASYS IS&#10;            BEGIN&#10;                --&#10;                UPDATE oasys_assessment SET&#10;                  event_number          &#61; l_event_num&#10;                  --row_version           &#61; row_version + 1,&#10;                  --last_updated_datetime &#61; LC_DATE_TIME,&#10;                  --last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE 1&#61;1&#10;                  AND offender_id &#61; l_offender_id&#10;                  AND oasys_assessment_id &#61; l_id&#10;                /*RETURNING offender_id INTO l_offender_id*/;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#10;                        &#39;ERROR: failed to restore the &#39; || l_src_tgt || &#39; OASYS_ASSESSMENT.event_number &#39; ||&#10;                        &#39;[offender_id&#61;&#39;   || l_offender_id || &#39;]&#39; ||&#10;                        &#39;[id&#61;&#39;            || l_id          || &#39;]&#39; ||&#10;                        &#39;[event_num_old&#61;&#39; || l_event_num   || &#39;]&#39;,&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored OASYS_ASSESSMENT.event_number on &#39; || p_table || &#39; &#39; ||&#10;                    &#39;[parent_tab&#61;&#39;   || p_parent_table || &#39;] for the &#39; || l_src_tgt || &#39; Offender &#39; ||&#10;                    &#39;[init_flag&#61;&#39;    || p_init_flag || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;          || l_crn         || &#39;]&#39; ||&#10;                    &#39;[off_id&#61;&#39;       || l_offender_id || &#39;]&#39; ||&#10;                    &#39;[oa_id&#61;&#39;        || l_id          || &#39;]&#39; ||&#10;                    &#39;[event_number&#61;&#39; || l_event_num   || &#39;]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;            END do_upd_OASYS;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            IF l_move_2_src_flag THEN&#10;                -- Restore the OASYS_ASSESSMENT.event_number on the cloned Target&#10;                l_src_tgt     :&#61; &#39;Source&#39;;&#10;                l_crn         :&#61; g_merge_ctx_rec.src_crn;&#10;                l_offender_id :&#61; l_rec_OMD.source_offender_id;&#10;                l_event_num   :&#61; get_omd_hist(l_OMD_ID, &#39;EVENT_NUMBER&#39;, &#39;OLD&#39;);&#10;                --&#10;                IF l_event_num IS NOT NULL THEN&#10;                    l_id :&#61; l_rec_OMD.target_pk_value;&#10;                ELSE&#10;                    l_id :&#61; -1;&#10;                END IF;&#10;                --&#10;            ELSE&#10;                -- Restore the OASYS_ASSESSMENT.event_number on the Source&#10;                l_id :&#61; -1;&#10;            END IF;&#10;            --&#10;            IF l_id &gt; 0 THEN&#10;                -- Restore original OASYS_ASSESSMENT.event_number&#10;                do_upd_OASYS;&#10;            END IF;&#10;            --&#10;        END do_upd_OASYS_event_num_U;&#10;        --&#10;        PROCEDURE do_amend_off_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;DO_AMEND_OFF_U&#39;;&#10;            --&#10;            l_SQL1 CLOB;&#10;            --&#10;            l_tgt_precon_alf_doc_id DOCUMENT.alfresco_document_id%TYPE;&#10;            l_src_precon_alf_doc_id DOCUMENT.alfresco_document_id%TYPE;&#10;            --&#10;            PROCEDURE do_add_off_attr_U(p_fld VARCHAR2)&#10;            IS&#10;                --&#10;                l_val VARCHAR2(100);&#10;                --&#10;                FUNCTION get_omdh_val(p_val VARCHAR2) RETURN VARCHAR2 IS&#10;                BEGIN&#10;                    RETURN&#10;                        CASE&#10;                            WHEN p_val &#61; &#39;xNULLx&#39; THEN NULL&#10;                            ELSE p_val&#10;                        END;&#10;                END get_omdh_val;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_val :&#61; get_omd_hist(l_omd_ID, p_fld, &#39;OLD&#39;, NULL, &#39;xNULLx&#39;);&#10;                --&#10;                IF l_val IS NOT NULL THEN&#10;                    IF l_val &#61; &#39;xNULLx&#39; THEN&#10;                        l_SQL1 :&#61; PKG_LstUtl.concat(l_SQL1, p_fld || &#39; &#61; NULL&#39;, p_delim&#61;&gt;&#39;,&#39; || CHR(10));&#10;                    ELSE&#10;                        l_SQL1 :&#61; PKG_LstUtl.concat(l_SQL1, p_fld || &#39; &#61; &#39;&#39;&#39; || l_val || &#39;&#39;&#39;&#39;, p_delim&#61;&gt;&#39;,&#39; || CHR(10));&#10;                    END IF;&#10;                END IF;&#10;                --&#10;                IF p_fld &#61; &#39;prev_con_alfresco_document_id&#39; THEN&#10;                    l_tgt_precon_alf_doc_id :&#61; get_omdh_val(l_val);&#10;                    l_src_precon_alf_doc_id :&#61; get_omdh_val(get_omd_hist(l_omd_ID, p_fld, &#39;NEW&#39;, NULL, &#39;xNULLx&#39;));&#10;                END IF;&#10;                --&#10;            END do_add_off_attr_U;&#10;            --&#10;        BEGIN&#10;            --&#10;            IF p_init_flag &#61; &#39;Y&#39; THEN&#10;                -- Init mode is not needed&#10;                -- (prior to when the cloned Source Offender record is deleted on the TARGET)&#10;                RETURN;&#10;            END IF;&#10;            --&#10;            do_add_off_attr_U(&#39;crn&#39;);&#10;            do_add_off_attr_U(&#39;date_of_birth_date&#39;);&#10;            do_add_off_attr_U(&#39;first_name&#39;);&#10;            do_add_off_attr_U(&#39;gender_id&#39;);&#10;            do_add_off_attr_U(&#39;previous_surname&#39;);&#10;            do_add_off_attr_U(&#39;second_name&#39;);&#10;            do_add_off_attr_U(&#39;surname&#39;);&#10;            do_add_off_attr_U(&#39;third_name&#39;);&#10;            do_add_off_attr_U(&#39;title_id&#39;);&#10;            do_add_off_attr_U(&#39;cro_number&#39;);&#10;            do_add_off_attr_U(&#39;deceased_date&#39;);&#10;            do_add_off_attr_U(&#39;e_mail_address&#39;);&#10;            do_add_off_attr_U(&#39;mobile_number&#39;);&#10;            do_add_off_attr_U(&#39;ni_number&#39;);&#10;            do_add_off_attr_U(&#39;noms_number&#39;);&#10;            do_add_off_attr_U(&#39;pnc_number&#39;);&#10;            do_add_off_attr_U(&#39;allow_sms&#39;);&#10;            do_add_off_attr_U(&#39;telephone_number&#39;);&#10;            do_add_off_attr_U(&#39;ethnicity_id&#39;);&#10;            do_add_off_attr_U(&#39;ethnicity_description&#39;);&#10;            do_add_off_attr_U(&#39;immigration_number&#39;);&#10;            do_add_off_attr_U(&#39;immigration_status_id&#39;);&#10;            do_add_off_attr_U(&#39;interpreter_required&#39;);&#10;            do_add_off_attr_U(&#39;language_id&#39;);&#10;            do_add_off_attr_U(&#39;nationality_id&#39;);&#10;            do_add_off_attr_U(&#39;religion_id&#39;);&#10;            IF g_merge_ctx_rec.move_religion_desc &#61; &#39;Y&#39; THEN&#10;                do_add_off_attr_U(&#39;religion_description&#39;);&#10;            END IF;&#10;            do_add_off_attr_U(&#39;second_nationality_id&#39;);&#10;            do_add_off_attr_U(&#39;sexual_orientation_id&#39;);&#10;            --&#10;            -- YF: DST-11993 PRECON is now stored in DOCUMENT table&#10;            --do_add_off_attr_U(&#39;prev_conviction_document_name&#39;);&#10;            --do_add_off_attr_U(&#39;previous_conviction_date&#39;);&#10;            --do_add_off_attr_U(&#39;prev_con_alfresco_document_id&#39;);&#10;            --do_add_off_attr_U(&#39;prev_con_created_by_user_id&#39;);&#10;            --do_add_off_attr_U(&#39;prev_con_created_datetime&#39;);&#10;            --do_add_off_attr_U(&#39;prev_con_created_provider_id&#39;);&#10;            --do_add_off_attr_U(&#39;prev_con_last_updated_user_id&#39;);&#10;            --do_add_off_attr_U(&#39;prev_con_last_upd_auth_prov_id&#39;);&#10;            --&#10;            IF l_SQL1 IS NOT NULL THEN&#10;                l_SQL1 :&#61;&#10;                --&#10;&#39;UPDATE offender SET&#39; || CHR(10) ||&#10;  PKG_LstUtl.get_indented_text(l_SQL1, 2) || &#39;,&#10;  --&#10;  row_version           &#61; row_version + 1,&#10;  last_updated_datetime &#61; :p_datetime,&#10;  last_updated_user_id  &#61; :p_user_id&#10;  --&#10;WHERE offender_id &#61; :p_offender_id&#39;;&#10;                --&#10;                EXECUTE IMMEDIATE l_SQL1&#10;                USING&#10;                  LC_DATE_TIME,&#10;                  LC_USER_ID,&#10;                  l_rec_OMD.target_offender_id;&#10;                --&#10;                IF SQL%ROWCOUNT &#61; 0 THEN&#10;                    fatal(&#39;ERROR: failed to restore the Target Offender record Attributes &#39; ||&#10;                        &#39;[offender_id&#61;&#39; || l_rec_OMD.target_offender_id || &#39;]&#39; ||&#10;                        &#39;[crn&#61;&#39;         || g_merge_ctx_rec.tgt_crn || &#39;]&#39; || CHR(10) ||&#10;                        &#39;SQL: &#39;         || l_SQL1,&#10;                        --&#10;                        l_proc2 );&#10;                END IF;&#10;                --&#10;                info(l_proc1 || &#39;: Restored Original Target Offender record Attrbutes &#39; ||&#10;                    &#39;[tgt_offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39; ||&#10;                    &#39;[tgt_crn&#61;&#39;         || g_merge_ctx_rec.tgt_crn         || &#39;]&#39; || CHR(10) ||&#10;                    &#39;SQL&#61;&#39;              || l_SQL1,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc2 );&#10;                --&#10;                -- YF: DST-11993 PRECON has now been moved into DOCUMENT table&#10;                --IF l_src_precon_alf_doc_id IS NOT NULL AND l_tgt_precon_alf_doc_id IS NULL THEN&#10;                --    -- NDM-196: Restore Precon ALF DOC ID on the Source Offender&#10;                --    UPDATE offender SET&#10;                --      prev_con_alfresco_document_id &#61; l_src_precon_alf_doc_id&#10;                --    WHERE offender_id &#61; l_rec_OMD.source_offender_id;&#10;                --END IF;&#10;                --&#10;            END IF;&#10;            --&#10;        END do_amend_off_U;&#10;        --&#10;    BEGIN&#10;        --&#10;        l_OMD_ID :&#61; l_rec_OMD.offender_merge_details_ID;&#10;        --&#10;        -- YF: Restore original values on OFFENDER record (should be called prior to the DO_AMEND_ALF_DOC_ID_U)&#10;        IF p_table &#61; &#39;OFFENDER&#39; THEN&#10;            do_amend_off_U;&#10;        END IF;&#10;        --&#10;        IF p_table &#61; &#39;OFFENDER_RELIGION_HISTORY&#39; THEN&#10;            -- 4. OFFENDER_RELIGION_HISTORY.end_date&#10;            do_amend_off_religion_hist_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;MANAGEMENT_TIER&#39; THEN&#10;            -- 4. MANAGEMENT_TIER&#10;            do_amend_management_tier_U;&#10;        END IF;&#10;        --&#10;        IF p_table &#61; &#39;DOCUMENT&#39; THEN&#10;            -- 5a. PRECON Document&#10;            do_amend_DOC_U;&#10;        END IF;&#10;        IF p_table IN ( &#39;DOCUMENT&#39;, &#39;EVENT&#39;, &#39;OFFENDER&#39; ) THEN&#10;            -- 5b. Alfresco Document ID&#10;            do_amend_alf_doc_id_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;OFFENDER_MANAGER&#39; THEN&#10;            -- Offender Manager&#10;            do_amend_OM_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;PRISON_OFFENDER_MANAGER&#39; THEN&#10;            -- Prison Offender Manager&#10;            do_amend_POM_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;RESPONSIBLE_OFFICER&#39; THEN&#10;            do_amend_RO_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;OFFENDER_ADDRESS&#39; THEN&#10;            -- 7. Offender ADDRESS&#10;            do_amend_OA_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;REGISTRATION&#39; THEN&#10;            -- 7a. Registration&#10;            do_amend_REG_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;REGISTRATION_REVIEW&#39; THEN&#10;            -- 7b. Registration Review&#10;            do_amend_REG_REVIEW_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;CONTACT&#39; THEN&#10;            -- 8a. CONTACT.nomis_case_note_id&#10;            do_amend_CONTACT_U;&#10;        END IF;&#10;        --IF p_table &#61; &#39;EVENT&#39; THEN&#10;        --    -- 8. EVENT.event_number/court_case_urn&#10;        --    --raise_application_error(-20001, &#39;do_amend_EVENT_U&#39;);&#10;        --    do_amend_EVENT_U;&#10;        --END IF;&#10;        --IF p_table &#61; &#39;SUBJECT_ACCESS_REPORT&#39; THEN&#10;        --    -- 9. SUBJECT_ACCESS_REPORT.generation_status&#10;        --    do_amend_SAR_U;&#10;        --END IF;&#10;        IF p_table &#61; &#39;OFFENDER_TRANSFER&#39; THEN&#10;            -- 10. OFFENDER_TRANSFER.soft_deleted (on the source)&#10;            do_amend_OT_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;APPROVED_PREMISES_REFERRAL&#39; THEN&#10;            -- 11. APPROVED_PREMISES_REFERRAL.soft_deleted (on the source)&#10;            do_amend_AP_U;&#10;        END IF;&#10;        IF p_table &#61; &#39;ADDITIONAL_IDENTIFIER&#39; THEN&#10;            -- 12. ADDITIONAL_IDENTIFIER.soft_deleted&#10;            do_amend_AI_U;&#10;        END IF;&#10;        --&#10;        IF p_table &#61; &#39;NSI&#39; THEN&#10;            -- 13. NSI.external_reference&#10;            do_amend_NSI_U;&#10;        END IF;&#10;        --&#10;        IF p_table &#61; &#39;OASYS_ASSESSMENT&#39; THEN&#10;            -- 14. OASYS_ASSESSMENT.event_number (added as per the DST-19878)&#10;            do_upd_OASYS_event_num_U;&#10;        END IF;&#10;        --&#10;    END do_restore_orig_fld_values;&#10;    --&#10;    PROCEDURE do_del_merge_ai&#10;    IS&#10;        --&#10;        LC_AI_MERGED_FROM_CRN CONSTANT VARCHAR2(10) :&#61; &#39;MFCRN&#39;; /*MERGED_FROM_CRN*/&#10;        LC_AI_MERGED_TO_CRN   CONSTANT VARCHAR2(10) :&#61; &#39;MTCRN&#39;; /*MERGED_TO_CRN*/&#10;        --&#10;        PROCEDURE do_del_ai(&#10;            p_id        NUMBER,&#10;            p_type_code VARCHAR2,&#10;            p_crn       VARCHAR2 )&#10;        IS&#10;            --&#10;            l_ai_type_id VARCHAR2(10);&#10;            --&#10;        BEGIN&#10;            --&#10;            l_ai_type_id :&#61; PKG_Lookups.funcgetStdRefListID( &#39;ADDITIONAL IDENTIFIER TYPE&#39;, p_type_code );&#10;            --&#10;            DELETE FROM additional_identifier&#10;            WHERE additional_identifier_id &#61; p_id&#10;              AND identifier_name_id &#61; l_ai_type_id&#10;              AND identifier &#61; p_crn;&#10;            --&#10;            l_rows :&#61; SQL%ROWCOUNT;&#10;            IF l_rows &gt; 0 THEN&#10;                info(&#10;                    &#39;[offender_id&#61;&#39; || p_offender_id || &#39;]&#39; ||&#10;                    &#39;[id&#61;&#39;          || p_id          || &#39;]&#39; ||&#10;                    &#39;[type&#61;&#39;        || p_type_code   || &#39;]&#39; ||&#10;                    &#39;[identifier&#61;&#39;  || p_crn         || &#39;]: &#39; || l_rows || &#39; rows in ADDITIONAL_IDENTIFIER deleted&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc );&#10;            END IF;&#10;            --&#10;        END do_del_ai;&#10;        --&#10;    BEGIN&#10;        --&#10;        do_del_ai(l_rec_OMD.source_pk_value, LC_AI_MERGED_TO_CRN, l_rec_OMD.tgt_crn);&#10;        --&#10;        IF GC_UNMERGE_MOVE_OFF_FLAG &#61; &#39;Y&#39; THEN&#10;            do_del_ai(l_rec_OMD.target_pk_value, LC_AI_MERGED_FROM_CRN, l_rec_OMD.src_crn);&#10;        END IF;&#10;        --&#10;    END do_del_merge_ai;&#10;    --&#10;    PROCEDURE do_move_off_level_rec_2_src&#10;    IS&#10;        --&#10;        l_proc2 VARCHAR2(30) :&#61; &#39;do_move_off_level_rec_2_src&#39;;&#10;        --&#10;        l_cnt_src_T INTEGER :&#61; 0;&#10;        l_cnt_tgt_T INTEGER :&#61; 0;&#10;        --&#10;        TYPE l_cur_TYP IS REF CURSOR;&#10;        --&#10;        TYPE l_rec_TYP IS RECORD(&#10;          src_crn OFFENDER.crn%TYPE,&#10;          tgt_crn OFFENDER.crn%TYPE,&#10;          src_row_id ROWID,&#10;          tgt_row_id ROWID,&#10;          --&#10;          offender_merge_details_id NUMBER,&#10;          hierarchy_level           NUMBER,&#10;          parent_table              OFFENDER_MERGE_DETAILS.parent_table%TYPE,&#10;          table_name                OFFENDER_MERGE_DETAILS.table_name%TYPE,&#10;          source_offender_id        NUMBER,&#10;          target_offender_id        NUMBER,&#10;          source_pk_value           OFFENDER_MERGE_DETAILS.source_pk_value%TYPE,&#10;          target_pk_value           OFFENDER_MERGE_DETAILS.target_pk_value%TYPE,&#10;          source_fk_value           OFFENDER_MERGE_DETAILS.source_fk_value%TYPE,&#10;          target_fk_value           OFFENDER_MERGE_DETAILS.target_fk_value%TYPE );&#10;        --&#10;        l_cur_T l_cur_TYP;&#10;        l_rec_T l_rec_TYP;&#10;        --&#10;        l_tab_pk_fld VARCHAR2(100) :&#61; PKG_DynSQL.get_tab_pk_fld_lst(l_rec_OMD.TABLE_NAME, &#39; || &#39;&#39;:&#39;&#39; || T1.&#39;, -1);&#10;        --&#10;        l_SQL CLOB;&#10;        --&#10;        l_composite_pk_flag BOOLEAN;&#10;        --&#10;        PROCEDURE do_move_o_rec&#10;        IS&#10;            --&#10;            l_offender_id_col_flag VARCHAR2(1);&#10;            --&#10;            PROCEDURE do_del_src_record IS&#10;            BEGIN&#10;                --&#10;                PKG_DPA_DELETION.P_DEL_REC(&#10;                    p_tab_name  &#61;&gt; l_rec_OMD.TABLE_NAME,&#10;                    p_row_id    &#61;&gt; l_rec_T.src_row_id,&#10;                    p_check_sql &#61;&gt; &#39;PKG_MERGE_OFFENDER.do_check_src_rec_for_deletion&#39; );&#10;                --&#10;            END do_del_src_record;&#10;            --&#10;            PROCEDURE do_terminate_ro IS&#10;            BEGIN&#10;                -- End Date all previous Source RO records&#10;                UPDATE responsible_officer SET&#10;                  end_date              &#61; LC_DATE_TIME,&#10;                  row_version           &#61; row_version + 1,&#10;                  last_updated_datetime &#61; LC_DATE_TIME,&#10;                  last_updated_user_id  &#61; LC_USER_ID&#10;                WHERE offender_id &#61; l_rec_T.source_offender_id&#10;                  AND end_date IS NULL&#10;                  AND EXISTS(&#10;                      SELECT 1&#10;                      FROM responsible_officer&#10;                      WHERE ROWID &#61; l_rec_T.tgt_row_id&#10;                        AND end_date IS NULL );&#10;                --&#10;                IF SQL%ROWCOUNT &gt; 0 THEN&#10;                    info(&#10;                        &#39;OFF_UNMERGE_CURR_REC.do_move_off_level_rec_2_src.do_move_o_rec.do_terminate_ro : &#39; || SQL%ROWCOUNT || &#39; previous Active RO record(s) have been end dated for the Source Offender &#39; ||&#10;                        --&#39;[offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39; ||&#10;                        &#39;[crn&#61;&#39; || l_rec_T.src_crn || &#39;]&#39;,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; l_proc2 );&#10;                END IF;&#10;                --&#10;            END do_terminate_ro;&#10;            --&#10;            PROCEDURE do_move_equality_doc_rec_2_src&#10;            IS&#10;                --&#10;                l_proc2 VARCHAR2(30) :&#61; &#39;do_move_equality_doc_rec_2_src&#39;;&#10;                --&#10;            BEGIN&#10;                --&#10;                IF l_rec_T.table_name &#61; &#39;DOCUMENT&#39; AND l_rec_T.parent_table &#61; &#39;EQUALITY&#39; THEN&#10;                    --&#10;                    UPDATE document SET primary_key_id &#61; l_rec_T.source_fk_value&#10;                    WHERE ROWID &#61; l_rec_T.tgt_row_id&#10;                      AND table_name &#61; &#39;EQUALITY&#39;;&#10;                    --&#10;                    l_rows :&#61; SQL%ROWCOUNT;&#10;                    --&#10;                    IF l_rows &gt; 0 THEN&#10;                        info(l_proc2 || &#39;: &#39; ||&#10;                            &#39;Total of &#39; || l_rows || &#39; original Document (table_name&#61;EQUALITY) records have been replaced with their cloned copies&#39;,&#10;                            --&#10;                            p_trace_level &#61;&gt; 15,&#10;                            p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;                    END IF;&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_move_equality_doc_rec_2_src;&#10;            --&#10;        BEGIN&#10;            --&#10;            info(&#10;                --l_proc2 || &#39;:&#39; ||&#10;                &#39;Delete original &#39; || INITCAP(l_rec_OMD.TABLE_NAME) || &#39; record &#39; ||&#10;                &#39;[src_pk&#61;&#39;    || l_rec_OMD.source_pk_value || &#39;]&#39; ||&#10;                &#39;[src_rowid&#61;&#39; || l_rec_T.src_row_id        || &#39;]&#39;, -- (recursively)&#39;,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;            --&#10;            do_del_src_record;&#10;            --&#10;            IF l_rec_T.tgt_row_id IS NOT NULL THEN&#10;                --&#10;                info(&#10;                    --l_proc2 || &#39;:&#39; ||&#10;                    &#39;Move cloned &#39; || l_rec_OMD.table_name || &#39; record (recursively) back to the Source Offender; &#39; ||&#10;                    &#39;update OFFENDER_ID from &#39;   ||&#10;                    &#39;[tgt_off_id&#61;&#39; || l_rec_T.tgt_crn || &#39; (&#39; || l_rec_T.target_offender_id || &#39;)] to &#39; ||&#10;                    &#39;[src_off_id&#61;&#39; || l_rec_T.src_crn || &#39; (&#39; || l_rec_T.source_offender_id || &#39;)]&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;                --&#10;                SELECT /*+ RESULT_CACHE */ DISTINCT offender_id_col_exists&#10;                INTO l_offender_id_col_flag&#10;                FROM offender_hierarchy&#10;                WHERE parent_table &#61; l_rec_OMD.parent_table&#10;                  AND table_name &#61; l_rec_OMD.table_name;&#10;                --&#10;                IF l_offender_id_col_flag &#61; &#39;Y&#39; THEN&#10;                    --&#10;                    IF l_rec_OMD.TABLE_NAME &#61; &#39;RESPONSIBLE_OFFICER&#39; THEN&#10;                        -- DST-12192: Enforce the OFFENDER_ID+ACTIVE_FLAG unique constraint for the Source RO records&#10;                        do_terminate_ro;&#10;                    ELSIF l_rec_OMD.TABLE_NAME &#61; &#39;DOCUMENT&#39; THEN&#10;                        -- DST-15170: Move EQUALITY type Document record back to SRC&#10;                        do_move_equality_doc_rec_2_src;&#10;                    END IF;&#10;                    --&#10;                    EXECUTE IMMEDIATE &#39;UPDATE &#39; || l_rec_OMD.table_name || &#39; SET offender_id  &#61; :p_offender_id WHERE ROWID &#61; :p_row_id&#39;&#10;                    USING l_rec_T.source_offender_id, l_rec_T.tgt_row_id;&#10;                    --&#10;                END IF;&#10;                --&#10;                -- Update recursively OFFENDER_ID for the moved Offender Level record&#10;                PKG_TriggerSupport.procCascadeUpdateOffenderID(&#10;                    p_offender_id       &#61;&gt; l_rec_T.source_offender_id,&#10;                    p_table_name        &#61;&gt; l_rec_OMD.table_name,&#10;                    p_row_id            &#61;&gt; l_rec_T.tgt_row_id,&#10;                    p_exclude_nodes_lst &#61;&gt; NULL );&#10;                --&#10;            END IF;&#10;            --&#10;        END do_move_o_rec;&#10;        --&#10;    BEGIN&#10;        --&#10;        info(&#10;            l_proc2 || &#39;: Moving cloned records back to the Source Offender: &#39; ||&#10;                &#39;[tab&#61;&#39;        || l_rec_OMD.table_name         || &#39;]&#39; ||&#10;                &#39;[parent_tab&#61;&#39; || l_rec_OMD.parent_table       || &#39;]&#39; ||&#10;                &#39;[src_off_id&#61;&#39; || l_rec_OMD.source_offender_id || &#39;]&#39; ||&#10;                &#39;[tgt_off_id&#61;&#39; || l_rec_OMD.target_offender_id || &#39;]&#39; ||&#10;                &#39;[src_pk&#61;&#39;     || l_rec_OMD.source_pk_value    || &#39;]&#39; ||&#10;                &#39;[tgt_pk&#61;&#39;     || l_rec_OMD.target_pk_value    || &#39;]&#39;,&#10;            --&#10;            p_trace_level &#61;&gt; 15,&#10;            p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;        --&#10;        IF UPPER(TRIM(l_rec_OMD.table_name)) IN (&#10;           &#39;MANAGEMENT_TIER&#39;,&#10;           &#39;OASYS_SP_NEED&#39;,&#10;           &#39;OASYS_SP_TEXT&#39;,&#10;           &#39;OASYS_SP_WORK_SUMMARY&#39;,&#10;           &#39;OFFENDER_PRISONER&#39; )&#10;        THEN&#10;            l_composite_pk_flag :&#61; TRUE;&#10;        ELSE&#10;            l_composite_pk_flag :&#61; FALSE;&#10;        END IF;&#10;        --&#10;        l_SQL :&#61;&#10;         &#39;SELECT&#10;            O.crn           AS src_crn,&#10;            O1.crn          AS tgt_crn,&#10;            --&#10;            T.rowid         AS src_row_id,&#10;            T1.rowid        AS tgt_row_id,&#10;            --&#10;            OMD.offender_merge_details_id,&#10;            OMD.hierarchy_level,&#10;            OMD.parent_table,&#10;            OMD.table_name,&#10;            OMD.source_offender_id,&#10;            OMD.target_offender_id,&#10;            OMD.source_pk_value,&#10;            OMD.target_pk_value,&#10;            OMD.source_fk_value,&#10;            OMD.target_fk_value&#10;          FROM&#10;            offender_merge_details OMD&#10;              INNER JOIN offender O  ON O.offender_id  &#61; OMD.source_offender_id&#10;              INNER JOIN offender O1 ON O1.offender_id &#61; OMD.target_offender_id&#10;              LEFT OUTER JOIN &#39; || l_rec_OMD.TABLE_NAME || &#39; T ON T.&#39; || REPLACE(l_tab_pk_fld, &#39;T1.&#39;, &#39;T.&#39;) || &#39; &#61; OMD.source_pk_value&#39; ||&#10;                                   CASE WHEN l_composite_pk_flag THEN &#39; AND T.offender_id &#61; OMD.source_offender_id&#39; END || &#39;&#10;              LEFT OUTER JOIN &#39; || l_rec_OMD.TABLE_NAME || &#39; T1 ON T1.&#39; || l_tab_pk_fld || &#39; &#61; OMD.target_pk_value&#39; ||&#10;                                   CASE WHEN l_composite_pk_flag THEN &#39; AND T1.offender_id &#61; OMD.target_offender_id&#39; END || &#39;&#10;          WHERE 1&#61;1&#10;            AND OMD.source_offender_id &#61; :p_src_offender_id&#10;            AND OMD.target_offender_id &#61; :p_tgt_offender_id&#10;            -- NDM-161: some SRC records can be created post-merge&#10;            --AND OMD.source_pk_value    &#61; :p_src_pk_value&#10;            AND OMD.target_pk_value    &#61; :p_tgt_pk_value&#10;            --AND O.crn &#61; &#39;&#39;X018538&#39;&#39;&#10;            AND OMD.table_name &#61; :p_table_name&#10;            AND OMD.parent_table &#61; :p_parent&#10;          ORDER BY&#10;            OMD.source_pk_value&#39;;&#10;--           &#39; || CASE WHEN l_rec_OMD.TABLE_NAME &#61; &#39;DOCUMENT&#39; THEN&#10;--            &#39;AND NOT EXISTS(&#10;--                SELECT 1&#10;--                FROM document D&#10;--                WHERE D.document_id &#61; OMD.target_pk_value&#10;--                  AND D.table_name &#61; &#39;&#39;EQUALITY&#39;&#39; )&#39; ELSE &#39;--&#39; END || &#39;&#10;&#10;        --&#10;        OPEN l_cur_T FOR l_SQL&#10;        USING&#10;          l_rec_OMD.source_offender_id,&#10;          l_rec_OMD.target_offender_id,&#10;            -- NDM-161: some SRC records can be created post-merge&#10;          --l_rec_OMD.source_pk_value,&#10;          l_rec_OMD.target_pk_value,&#10;          l_rec_OMD.table_name,&#10;          l_rec_OMD.parent_table;&#10;        --&#10;        l_rows :&#61; 0;&#10;        --&#10;        LOOP&#10;            FETCH l_cur_T INTO l_rec_T;&#10;            EXIT WHEN l_cur_T%NOTFOUND;&#10;            --&#10;            l_cnt_src_T :&#61; l_cnt_src_T + 1;&#10;            IF l_rec_T.tgt_row_id IS NOT NULL THEN&#10;                l_cnt_tgt_T :&#61; l_cnt_tgt_T + 1;&#10;            END IF;&#10;            --&#10;            do_move_o_rec;&#10;            --&#10;            l_rows :&#61; l_rows + 1;&#10;            --&#10;        END LOOP;&#10;        CLOSE l_cur_T;&#10;        --&#10;        info(l_proc2 || &#39;: &#39; ||&#10;            &#39;Total of &#39; || l_cnt_src_T || &#39; original &#39; || INITCAP(l_rec_OMD.TABLE_NAME) || &#39; records have been replaced with &#39; || l_cnt_tgt_T || &#39; cloned ones&#39;,&#10;            --&#10;            p_trace_level &#61;&gt; 15,&#10;            p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;        --&#10;    EXCEPTION WHEN OTHERS THEN&#10;        fatal( &#39;ERROR in &#39; || l_proc2 || &#39;: &#39; || SQLERRM || CHR(10) ||&#10;            &#39;[src_offender_id&#61;&#39; || l_rec_OMD.source_offender_id || &#39;]&#39; ||&#10;            &#39;[tgt_offender_id&#61;&#39; || l_rec_OMD.target_offender_id || &#39;]&#39; ||&#10;            &#39;[tab_name&#61;&#39;        || l_rec_OMD.TABLE_NAME         || &#39;]&#39; ||&#10;            &#39;[tab_pk_fld&#61;&#39;      || l_tab_pk_fld                 || &#39;]&#39; ||&#10;            &#39;[src_pk_val&#61;&#39;      || l_rec_OMD.source_pk_value    || &#39;]&#39; ||&#10;            &#39;[tgt_pk_val&#61;&#39;      || l_rec_OMD.target_pk_value    || &#39;]&#39; ||&#10;            CHR(10) ||&#10;            SUBSTRB(SQLERRM || CHR(10) || DBMS_UTILITY.format_error_backtrace, 1, 4000) ||&#10;            CHR(10) ||&#10;            &#39;SQL: &#39; || l_SQL );&#10;    END do_move_off_level_rec_2_src;&#10;    --&#10;BEGIN&#10;    --&#10;    do_fetch_OMD;&#10;    --&#10;    IF GC_UNMERGE_MOVE_OFF_FLAG &#61; &#39;Y&#39; AND&#10;       l_rec_OMD.TABLE_NAME NOT IN (&#39;EVENT&#39;, &#39;DISABILITY&#39;, &#39;PROVISION&#39;)&#10;    THEN&#10;        -- Replace the original Source record with its clone from the Target&#10;        l_move_2_src_flag :&#61; TRUE;&#10;    ELSE&#10;        l_move_2_src_flag :&#61; FALSE;&#10;    END IF;&#10;    --&#10;    IF l_OMD_found_flag THEN&#10;        --&#10;        IF l_rec_OMD.source_pk_value &#61; &#39;-&#39; || l_rec_OMD.target_pk_value AND&#10;           l_rec_OMD.debug_notes LIKE GC_RETAIN_ON_TGT&#10;        THEN&#10;            --&#10;            IF l_rec_OMD.table_name IN ( &#39;OFFENDER_MANAGER&#39;, &#39;RESPONSIBLE_OFFICER&#39; ) THEN&#10;                -- Restore Active OM/RO on the Source (when unmerged)&#10;                do_restore_orig_fld_values(p_init_flag&#61;&gt;&#39;Y&#39;);&#10;                do_restore_orig_fld_values;&#10;            END IF;&#10;            --&#10;            -- Record that has been created on the Target during the Merge&#10;            do_del_omd_rec(p_omd_id&#61;&gt;l_rec_OMD.offender_merge_details_ID);&#10;            --&#10;            info(&#10;                &#39;[parent_table&#61;&#39;    || p_parent_table  || &#39;]&#39;  ||&#10;                &#39;[table&#61;&#39;           || p_table         || &#39;]&#39;  ||&#10;                &#39;[offender_id&#61;&#39;     || p_offender_id   || &#39;]&#39;  ||&#10;                &#39;[parent_ROWID&#61;&#39;    || p_parent_row_id || &#39;]&#39;  ||&#10;                &#39;[ROWID&#61;&#39;           || p_row_id        || &#39;] &#39; ||&#10;                &#39;[pk&#61;&#39;              || l_rec_OMD.target_pk_value || &#39;]&#39;  ||&#10;                &#39;[fk&#61;&#39;              || l_rec_OMD.target_fk_value || &#39;]:&#39; ||&#10;                &#39; record has been retained on the Target&#39;,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; l_proc );&#10;            --&#10;        ELSE&#10;            --&#10;            do_restore_orig_fld_values(p_init_flag&#61;&gt;&#39;Y&#39;);&#10;            --&#10;            IF p_table &#61; &#39;ADDITIONAL_IDENTIFIER&#39; THEN&#10;                do_del_merge_ai;&#10;            END IF;&#10;            --&#10;            IF p_table &#61; &#39;OFFENDER&#39; THEN&#10;                -- Do nothing for the top level OFFENDER record&#10;                NULL;&#10;                --&#10;            ELSIF p_table &#61; &#39;EQUALITY&#39; THEN&#10;                -- See DO_MOVE_O_REC.do_move_equality_doc_rec_2_src&#10;                NULL;&#10;                --&#10;            ELSE&#10;                --&#10;                IF l_move_2_src_flag THEN&#10;                    -- YF: DO_MOVE_OFF_LEVEL_REC_2_SRC is now aware of the GC_UNMERGE_MOVE_OFF_FLAG&#61;Y/N context&#10;                    do_move_off_level_rec_2_src;&#10;                    --&#10;                ELSE&#10;--                    BEGIN&#10;                        -- Restore the original Source record and delete the cloned Target&#10;                        EXECUTE IMMEDIATE &#39;DELETE FROM &#39; || p_table || &#39; WHERE ROWID &#61; :p_row_id&#39; USING p_row_id;&#10;                        l_rows :&#61; SQL%ROWCOUNT;&#10;--                    EXCEPTION WHEN OTHERS THEN&#10;--                        raise_application_error(-20001,&#10;--                            &#39;ERROR in off_unmerge_curr_rec while trying to Restore the original Source record and delete the cloned Target &#39; ||&#10;--                            &#39;[tab&#61;&#39;   || p_table  || &#39;]&#39; ||&#10;--                            &#39;[rowid&#61;&#39; || p_row_id || &#39;]: &#39; || SQLERRM );&#10;--                    END;&#10;                    --&#10;                END IF;&#10;                --&#10;            END IF;&#10;            --&#10;            --IF NOT l_move_2_src_flag THEN&#10;                -- Restore original values on Source (e.g. ALF references) / Target (e.g. CRN or NOMS)&#10;                do_restore_orig_fld_values;&#10;            --END IF;&#10;            --&#10;            do_del_omd_rec(p_omd_id&#61;&gt;l_rec_OMD.offender_merge_details_ID);&#10;            --&#10;            info(&#10;                &#39;[parent_table&#61;&#39;    || p_parent_table  || &#39;]&#39; ||&#10;                &#39;[table&#61;&#39;           || p_table         || &#39;]&#39; ||&#10;                &#39;[offender_id&#61;&#39;     || p_offender_id   || &#39;]&#39; ||&#10;                &#39;[parent_ROWID&#61;&#39;    || p_parent_row_id || &#39;]&#39; ||&#10;                &#39;[ROWID&#61;&#39;           || p_row_id        || &#39;]&#39; ||&#10;                &#39;[pk&#61;&#39;              || l_rec_OMD.target_pk_value || &#39;]&#39;  ||&#10;                &#39;[fk&#61;&#39;              || l_rec_OMD.target_fk_value || &#39;]:&#39; ||&#10;                l_rows || CASE WHEN l_rows &#61; 1 THEN &#39; record has been&#39; ELSE &#39; records have been&#39; END || &#39; &#39; ||&#10;                CASE WHEN l_move_2_src_flag THEN &#39;moved back to the Source&#39; ELSE &#39;deleted&#39; END,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; l_proc );&#10;            --&#10;        END IF;&#10;        --&#10;    ELSE -- l_OMD_found_flag&#61;FALSE&#10;        NULL;&#10;    END IF;&#10;    --&#10;END off_unmerge_curr_rec;&#10;--&#10;PROCEDURE procUnmergeOffenders_NEW(&#10;    p_source_offender_id NUMBER,&#10;    p_target_offender_id NUMBER,&#10;    p_debug_flag         VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    LC_USER_ID          NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;    LC_DATE_TIME        DATE   :&#61; SYSDATE;&#10;    LC_DATE             DATE   :&#61; TRUNC(LC_DATE_TIME);&#10;    --&#10;    CURSOR cs IS&#10;      SELECT&#10;        O1.offender_id  AS src_offender_id,&#10;        O1.crn          AS src_crn,&#10;        O2.offender_id  AS tgt_offender_id,&#10;        O2.crn          AS tgt_crn,&#10;        O2.ROWID        AS tgt_row_id,&#10;        --&#10;        PKG_Merge_Offender.get_merge_date_time(O1.offender_id, O2.offender_id) AS merged_date_time,&#10;        --&#10;        CASE&#10;            WHEN O1.religion_description IS NOT NULL THEN&#10;                CASE&#10;                    WHEN O1.religion_description &#61; O2.religion_description  THEN &#39;Y&#39;&#10;                    WHEN O1.religion_description &lt;&gt; O2.religion_description THEN &#39;N&#39;&#10;                END&#10;            ELSE &#39;N&#39;&#10;        END AS reset_tgt_religion_desc&#10;        --&#10;      FROM&#10;        offender_merge_details OMD&#10;          INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;          INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;      WHERE 1&#61;1&#10;        AND OMD.source_offender_id &#61; p_source_offender_id&#10;        AND OMD.target_offender_id &#61; p_target_offender_id&#10;        AND OMD.table_name &#61; &#39;OFFENDER&#39;&#10;        AND OMD.parent_table IS NULL&#10;        AND OMD.hierarchy_level &#61; 0&#10;        --&#10;        AND O1.soft_deleted &#61; 1;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    l_found_flag BOOLEAN;&#10;    --&#10;    l_owning_om_id    NUMBER;&#10;    l_receiving_om_id NUMBER;&#10;    --&#10;    PROCEDURE do_check_target_OM_U(p_init_flag VARCHAR2 DEFAULT NULL)&#10;    IS&#10;        --&#10;        CURSOR csOM IS&#10;          SELECT&#10;            OMD.offender_merge_details_id,&#10;            OM.*&#10;          FROM&#10;            offender_merge_details OMD&#10;              INNER JOIN offender_merge_details_hist OMDH ON OMDH.offender_merge_details_id &#61; OMD.offender_merge_details_id&#10;                INNER JOIN offender_manager OM ON OM.offender_manager_id &#61; OMDH.table_pk_value&#10;          WHERE OMD.table_name &#61; &#39;OFFENDER_MANAGER&#39;&#10;            AND OMD.source_offender_id &#61; g_merge_ctx_rec.src_offender_id&#10;            AND OMD.target_offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;            AND OMDH.column_name &#61; &#39;ACTIVE_FLAG&#39;&#10;            AND OMDH.old_value &#61; &#39;1&#39;&#10;            AND OMDH.new_value &#61; &#39;0&#39;&#10;            AND OMDH.table_pk_value IS NOT NULL&#10;            -- NDM-176: Exclude new &quot;Post-Merge&quot; Target OM record&#10;            AND OMD.source_pk_value &lt;&gt; &#39;-&#39; || OMD.target_pk_value&#10;          ORDER BY&#10;            -- An earliest occurence of the End Dated (upon the Merge) OM record on the Target&#10;            OMDH.offender_merge_details_hist_ID ASC&#10;        ;&#10;        --&#10;        l_rec_OM csOM%ROWTYPE;&#10;        --&#10;        CURSOR csOMU IS&#10;          SELECT&#10;            offender_merge_details_id,&#10;            table_name,&#10;            target_pk_value&#10;          FROM offender_merge_details&#10;          WHERE 1&#61;1&#10;            AND source_offender_id &#61; g_merge_ctx_rec.src_offender_id&#10;            AND target_offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;            AND source_pk_value IS NULL --&#39;-1&#39;&#10;            AND debug_notes LIKE GC_RETAIN_ON_TGT&#10;            AND table_name IN (&#39;OFFENDER_MANAGER&#39;, &#39;RESPONSIBLE_OFFICER&#39;, &#39;MASTER_TRANSFER&#39;, &#39;OFFENDER_TRANSFER&#39;, &#39;CONTACT&#39;)&#10;          ORDER BY&#10;            DECODE( table_name,&#10;              &#39;OFFENDER_MANAGER&#39;,    5,&#10;              &#39;MASTER_TRANSFER&#39;,     4,&#10;              &#39;OFFENDER_TRANSFER&#39;,   3,&#10;              &#39;CONTACT&#39;,             2,&#10;              &#39;RESPONSIBLE_OFFICER&#39;, 1,&#10;              -1 );&#10;        --&#10;        l_rec_OMU csOMU%ROWTYPE;&#10;        l_id  NUMBER;&#10;        --&#10;    BEGIN&#10;        --&#10;        IF p_init_flag &#61; &#39;Y&#39; THEN&#10;            --&#10;            OPEN csOM;&#10;            FETCH csOM INTO l_rec_OM;&#10;            CLOSE csOM;&#10;            --&#10;            l_receiving_om_id :&#61; l_rec_OM.offender_manager_id;&#10;            --&#10;            BEGIN&#10;                SELECT offender_manager_id&#10;                INTO l_owning_om_id&#10;                FROM offender_manager&#10;                WHERE offender_id &#61; g_merge_ctx_rec.tgt_offender_id&#10;                  AND active_flag &#61; 1;&#10;            EXCEPTION WHEN NO_DATA_FOUND THEN&#10;                raise_application_error(-20001,&#10;                    &#39;FATAL ERROR in do_check_target_OM_U (p_init_flag&#61;Y): &#39; ||&#10;                    &#39;There is no Active OM for the Target CRN &#39; ||&#10;                    &#39;[offender_id&#61;&#39; || g_merge_ctx_rec.tgt_offender_id || &#39;]&#39;);&#10;            END;&#10;            --&#10;            IF l_receiving_om_id IS NULL THEN&#10;                l_receiving_om_id :&#61; l_owning_om_id;&#10;            END IF;&#10;            --&#10;            OPEN csOMU;&#10;            LOOP&#10;                FETCH csOMU INTO l_rec_OMU;&#10;                EXIT WHEN csOMU%NOTFOUND;&#10;                --&#10;                do_del_omd_rec(p_omd_id&#61;&gt;l_rec_OMU.offender_merge_details_id);&#10;                --&#10;            END LOOP;&#10;            CLOSE csOMU;&#10;        ELSE&#10;            --&#10;            -- NDM-168: Create same set of OM/RO/OT/C records - same as during the Merge&#10;            do_create_target_OM(&#10;                p_action          &#61;&gt; &#39;UNMERGE&#39;,&#10;                p_receiving_om_id &#61;&gt; l_receiving_om_id,&#10;                p_owning_om_id    &#61;&gt; l_owning_om_id );&#10;            --&#10;        END IF;&#10;        --&#10;    END do_check_target_OM_U;&#10;    --&#10;    PROCEDURE do_pre_unmerge&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_PRE_UNMERGE&#39;;&#10;        --&#10;        PROCEDURE do_upd_secondary_fk_U&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;do_upd_secondary_fk_U&#39;;&#10;            --&#10;            PROCEDURE do_upd_fk_U(&#10;                p_table               VARCHAR2,&#10;                p_parent_table         VARCHAR2,&#10;                p_fk_col               VARCHAR2,&#10;                p_where                VARCHAR2 DEFAULT NULL,&#10;                p_del_OMD_flag         VARCHAR2 DEFAULT &#39;N&#39;,&#10;                p_del_OMD_parent_table VARCHAR2 DEFAULT NULL )&#10;            IS&#10;                --&#10;                TYPE l_cur_TYP IS REF CURSOR;&#10;                l_cur1 l_cur_TYP;&#10;                --&#10;                TYPE l_rec_TYP IS RECORD(&#10;                  row_id                     ROWID,&#10;                  offender_merge_details_id  NUMBER,&#10;                  parent_table               VARCHAR2(30),&#10;                  offender_merge_details_id1 NUMBER,&#10;                  cur_pk_value               VARCHAR2(100),&#10;                  cur_fk_value               VARCHAR2(100),&#10;                  src_fk_value               VARCHAR2(100) );&#10;                l_rec1 l_rec_TYP;&#10;                --&#10;                l_SQL CLOB;&#10;                --&#10;            BEGIN&#10;                --&#10;                l_SQL :&#61;&#10;                   &#39;SELECT&#10;                      T.ROWID                       AS row_id,&#10;                      TH.offender_merge_details_id,&#10;                      TH.parent_table,&#10;                      TH1.offender_merge_details_id AS offender_merge_details_id1,&#10;                      TH.target_pk_value            AS cur_pk_value,&#10;                      T.&#39; || p_fk_col || &#39;          AS cur_fk_value,&#10;                      TH1.source_pk_value           AS src_fk_value&#10;                    FROM&#10;                      &#39; || p_table || &#39; T&#10;                        INNER JOIN offender_merge_details TH  ON TH.&#39; ||&#10;                                                             CASE WHEN p_table IN (&#39;ENFORCEMENTxxx&#39;)&#10;                                                               THEN &#39;source_pk_value&#39;&#10;                                                               ELSE &#39;target_pk_value&#39;&#10;                                                             END ||&#10;                                                                 &#39; &#61; T.&#39; || PKG_DynSQL.get_tab_pk_fld_lst(p_table, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1) || &#39;&#10;                                                             AND TH.table_name &#61; :p_table&#10;                                                             AND TH.source_offender_id &#61; :p_src_offender_id&#10;                                                             AND TH.target_offender_id &#61; :p_tgt_offender_id&#10;                        INNER JOIN offender_merge_details TH1 ON TH1.target_pk_value &#61; T.&#39; || p_fk_col || &#39;&#10;                                                             AND TH1.table_name &#61; :p_parent_table&#10;                                                             AND TH1.source_offender_id &#61; :p_src_offender_id&#10;                                                             AND TH1.target_offender_id &#61; :p_tgt_offender_id&#10;                    WHERE ( &#39; || NVL(p_where, &#39;1&#61;1&#39;) || &#39; )&#10;                      AND T.&#39; || p_fk_col || &#39; IS NOT NULL&#10;                    ORDER BY 1&#39;;&#10;                --&#10;                OPEN l_cur1 FOR l_SQL&#10;                USING&#10;                  p_table,&#10;                  l_rec.src_offender_id,&#10;                  l_rec.tgt_offender_id,&#10;                  --&#10;                  p_parent_table,&#10;                  l_rec.src_offender_id,&#10;                  l_rec.tgt_offender_id;&#10;                --&#10;                LOOP&#10;                    FETCH l_cur1 INTO l_rec1;&#10;                    EXIT WHEN l_cur1%NOTFOUND;&#10;                    --&#10;                    l_SQL :&#61; &#39;UPDATE &#39; || p_table || &#39; SET &#39; || p_fk_col || &#39; &#61; :p_src_fk_value WHERE ROWID &#61; :p_row_id&#39;;&#10;                    EXECUTE IMMEDIATE l_SQL USING l_rec1.src_fk_value, l_rec1.row_id;&#10;                    --&#10;                    IF p_del_OMD_flag &#61; &#39;Y&#39; THEN&#10;                        --&#10;                        IF p_del_OMD_parent_table IS NULL OR p_del_OMD_parent_table &#61; l_rec1.parent_table THEN&#10;                            --&#10;                            do_del_omd_rec(p_omd_id&#61;&gt;l_rec1.offender_merge_details_ID);&#10;                            --&#10;                            info(&#39;DO_UPD_FK_U: deleted OMD record &#39; ||&#10;                                &#39;[tab&#61;&#39;               || p_table                         || &#39;]&#39; ||&#10;                                &#39;[parent_tab&#61;&#39;        || p_parent_table                  || &#39;]&#39; ||&#10;                                --&#10;                                &#39;[OMD_id&#61;&#39;            || l_rec1.offender_merge_details_id || &#39;]&#39; ||&#10;                                &#39;[cur_pk_val&#61;&#39;        || l_rec1.cur_pk_value              || &#39;]&#39; ||&#10;                                --&#39;[where&#61;&#39;             || p_where                         || &#39;]&#39; || CHR(10) ||&#10;                                --&#39;[src_off_id&#61;&#39;        || l_rec.src_offender_id           || &#39;]&#39; ||&#10;                                --&#39;[tgt_off_id&#61;&#39;        || l_rec.tgt_offender_id           || &#39;]&#39; ||&#10;                                --&#39;[fk_col&#61;&#39;            || p_fk_col                        || &#39;]&#39; ||&#10;                                --&#39;[cur_fk_val&#61;&#39;        || l_rec1.cur_fk_value             || &#39;]&#39; ||&#10;                                --&#39;[src_fk_val&#61;&#39;        || l_rec1.src_fk_value             || &#39;]&#39;&#10;                                &#39;&#39;,&#10;                                --&#10;                                p_trace_level &#61;&gt; 15,&#10;                                p_proc        &#61;&gt; l_proc1 );&#10;                            --&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                END LOOP;&#10;                CLOSE l_cur1;&#10;                --&#10;            EXCEPTION WHEN OTHERS THEN&#10;                --&#10;                IF l_cur1%ISOPEN THEN CLOSE l_cur1; END IF;&#10;                --&#10;                fatal(&#10;                    SUBSTR(PKG_LstUtl.concat_CLOB(&#10;                        &#39;ERROR in DO_UPD_FK_U &#39;,&#10;                        --&#10;                        &#39;[tab&#61;&#39;         || p_table                         || &#39;]&#39; ||&#10;                        &#39;[src_off_id&#61;&#39;  || l_rec.src_offender_id           || &#39;]&#39; ||&#10;                        &#39;[tgt_off_id&#61;&#39;  || l_rec.tgt_offender_id           || &#39;]&#39; ||&#10;                        &#39;[parent_tab&#61;&#39;  || p_parent_table                  || &#39;]&#39; ||&#10;                        &#39;[fk_col&#61;&#39;      || p_fk_col                        || &#39;]&#39; ||&#10;                        &#39;[where&#61;&#39;       || p_where                         || &#39;]&#39;,&#10;                        --&#10;                        --&#39;[rowid&#61;&#39;             || l_rec.row_id                    || &#39;]&#39; ||&#10;                        &#39;[OMD_id&#61;&#39;      || l_rec1.offender_merge_details_id || &#39;]&#39; ||&#10;                        &#39;[cur_pk_val&#61;&#39;  || l_rec1.cur_pk_value              || &#39;]&#39; ||&#10;                        &#39;[cur_fk_val&#61;&#39;  || l_rec1.cur_fk_value              || &#39;]&#39; ||&#10;                        &#39;[src_fk_val&#61;&#39;  || l_rec1.src_fk_value              || &#39;]&#39; || CHR(10),&#10;                        --&#10;                        &#39;***** OFFENDER_MERGE_DETAILS record:&#39;          || CHR(10) || get_off_merge_details_1(l_rec1.offender_merge_details_id , p_incl_debug_notes&#61;&gt;&#39;N&#39;) || CHR(10),&#10;                        &#39;***** OFFENDER_MERGE_DETAILS record (Parent):&#39; || CHR(10) || get_off_merge_details_1(l_rec1.offender_merge_details_id1, p_incl_debug_notes&#61;&gt;&#39;N&#39;) || CHR(10),&#10;                        --&#10;                        &#39;SQL: &#39; || l_SQL,&#10;                        &#39;ERRM: &#39; || get_dq_message(SQLERRM),&#10;                        --&#10;                        p_delim&#61;&gt;CHR(10) ), 1, 32000),&#10;                    --&#10;                    &#39;DO_UPD_FK_U&#39; );&#10;                --&#10;            END do_upd_fk_U;&#10;            --&#10;        BEGIN&#10;            --&#10;            -- Update EVENT level Contact records that are linked to OFFENDER level parent Contact&#10;            do_upd_fk_U(&#39;CONTACT&#39;, &#39;CONTACT&#39;, &#39;LINKED_CONTACT_ID&#39;, &#39;NOT (T.event_id IS NULL AND T.table_name IS NULL) AND EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.linked_contact_id AND C1.event_id IS NULL AND C1.table_name IS NULL )&#39;);&#10;            do_upd_fk_U(&#39;CONTACT&#39;, &#39;CONTACT&#39;, &#39;LINKED_DOCUMENT_CONTACT_ID&#39;, &#39;NOT (T.event_id IS NULL AND T.table_name IS NULL) AND EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.linked_document_contact_id AND C1.event_id IS NULL AND C1.table_name IS NULL )&#39;);&#10;            do_upd_fk_U(&#39;CONTACT&#39;, &#39;CONTACT&#39;, &#39;RAR_LINKED_CONTACT_ID&#39;, &#39;NOT (T.event_id IS NULL AND T.table_name IS NULL) AND EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.rar_linked_contact_id AND C1.event_id IS NULL AND C1.table_name IS NULL )&#39;);&#10;            --&#10;            -- Update Contact Alert (only those linked to EVENT level CONTACTs) with the Source OM ID&#10;            do_upd_fk_U(&#39;CONTACT_ALERT&#39;, &#39;OFFENDER_MANAGER&#39;, &#39;OFFENDER_MANAGER_ID&#39;, &#39;EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.contact_id AND NOT (C1.event_id IS NULL AND C1.table_name IS NULL) )&#39;);&#10;            -- .. otherwise leave Contact Alert as it is as it will be deleted on the Merged Offender side anyway&#10;            --do_upd_fk_U(&#39;CONTACT_ALERT&#39;, &#39;CONTACT&#39;, &#39;CONTACT_ID&#39;, &#39;EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.contact_id AND C1.event_id IS NULL AND C1.table_name IS NULL )&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;);&#10;            --&#10;            do_upd_fk_U(&#39;ORDER_TRANSFER&#39;               , &#39;MASTER_TRANSFER&#39;, &#39;MASTER_TRANSFER_ID&#39;, &#39;&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;, p_del_OMD_parent_table&#61;&gt;&#39;MASTER_TRANSFER&#39;);&#10;            do_upd_fk_U(&#39;COURT_REPORT_TRANSFER&#39;        , &#39;MASTER_TRANSFER&#39;, &#39;MASTER_TRANSFER_ID&#39;, &#39;&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;, p_del_OMD_parent_table&#61;&gt;&#39;MASTER_TRANSFER&#39;);&#10;            do_upd_fk_U(&#39;INSTITUTIONAL_REPORT_TRANSFER&#39;, &#39;MASTER_TRANSFER&#39;, &#39;MASTER_TRANSFER_ID&#39;, &#39;&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;, p_del_OMD_parent_table&#61;&gt;&#39;MASTER_TRANSFER&#39;);&#10;            do_upd_fk_U(&#39;LIC_CONDITION_TRANSFER&#39;       , &#39;MASTER_TRANSFER&#39;, &#39;MASTER_TRANSFER_ID&#39;, &#39;&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;, p_del_OMD_parent_table&#61;&gt;&#39;MASTER_TRANSFER&#39;);&#10;            do_upd_fk_U(&#39;RQMNT_TRANSFER&#39;               , &#39;MASTER_TRANSFER&#39;, &#39;MASTER_TRANSFER_ID&#39;, &#39;&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;, p_del_OMD_parent_table&#61;&gt;&#39;MASTER_TRANSFER&#39;);&#10;            do_upd_fk_U(&#39;PSS_RQMNT_TRANSFER&#39;           , &#39;MASTER_TRANSFER&#39;, &#39;MASTER_TRANSFER_ID&#39;, &#39;&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;, p_del_OMD_parent_table&#61;&gt;&#39;MASTER_TRANSFER&#39;);&#10;            -- Update EVENT level Nsi only.OFFENDER level Nsi records will be deleted on the Merged Offender side&#10;            do_upd_fk_U(&#39;NSI_TRANSFER&#39;                 , &#39;MASTER_TRANSFER&#39;, &#39;MASTER_TRANSFER_ID&#39;, &#39;EXISTS( SELECT 1 FROM nsi WHERE nsi_id &#61; T.nsi_id AND event_id IS NOT NULL )&#39;, p_del_OMD_flag&#61;&gt;&#39;Y&#39;, p_del_OMD_parent_table&#61;&gt;&#39;MASTER_TRANSFER&#39;);&#10;            --&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;ADDRESS_ASSESSMENT&#39;        , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;ADDRESSASSESSMENT&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;ASSESSMENT&#39;                , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;ASSESSMENT&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;APPROVED_PREMISES_REFERRAL&#39;, &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;APPROVED_PREMISES_REFERRAL&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;CASE_ALLOCATION&#39;           , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;REFERRAL&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;CONTACT&#39;                   , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;CONTACT&#39;&#39; AND EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.PRIMARY_KEY_ID AND C1.event_id IS NULL AND C1.table_name IS NULL )&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;COURT_REPORT&#39;              , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;COURT_REPORT&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;EQUALITY&#39;                  , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;EQUALITY&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;EVENT&#39;                     , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;EVENT&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;INSTITUTIONAL_REPORT&#39;      , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;INSTITUTIONAL_REPORT&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;NSI&#39;                       , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;NSI&#39;&#39;&#39;);&#10;            --&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;OFFENDER&#39;                  , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;OFFENDER&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;OFFENDER_ADDRESS&#39;          , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;OFFENDER_ADDRESS&#39;&#39;&#39;);&#10;            --&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;PERSONAL_CONTACT&#39;          , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;PERSONALCONTACT&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;PERSONAL_CIRCUMSTANCE&#39;     , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;PERSONAL_CIRCUMSTANCE&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;REFERRAL&#39;                  , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;REFERRAL&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;REGISTRATION&#39;              , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;REGISTRATION&#39;&#39;&#39;);&#10;            --do_upd_fk_U(&#39;DOCUMENT&#39;, &#39;UPW_APPOINTMENT&#39;           , &#39;PRIMARY_KEY_ID&#39;, &#39;T.table_name &#61; &#39;&#39;UPW_APPOINTMENT&#39;&#39;&#39;);&#10;            --&#10;            -- Update Enforcement that are linked to OFFENDER level Contact&#10;            do_upd_fk_U(&#39;ENFORCEMENT&#39;, &#39;CONTACT&#39;, &#39;CONTACT_ID&#39;, &#39;EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.contact_id AND C1.event_id IS NULL AND C1.table_name IS NULL )&#39;);&#10;            --&#10;            -- Update EVENT level Nsi&#10;            do_upd_fk_U(&#39;NSI&#39;, &#39;ADDITIONAL_IDENTIFIER&#39;, &#39;ADDITIONAL_IDENTIFIER1_ID&#39;, &#39;T.event_id IS NOT NULL&#39;);&#10;            do_upd_fk_U(&#39;NSI&#39;, &#39;ADDITIONAL_IDENTIFIER&#39;, &#39;ADDITIONAL_IDENTIFIER2_ID&#39;, &#39;T.event_id IS NOT NULL&#39;);&#10;            --&#10;            -- OFFENDER LEVEL tables: no need to update FK as these records will be deleted on the Merged Offender side anyway?&#10;            --do_upd_fk_U(&#39;OASYS_ASSESSMENT&#39;, &#39;CONTACT&#39;, &#39;CONTACT_ID&#39;, &#39;EXISTS( SELECT 1 FROM contact C1 WHERE C1.contact_id &#61; T.contact_id AND C1.event_id IS NULL AND C1.table_name IS NULL )&#39;);&#10;            --do_upd_fk_U(&#39;SUBJECT_ACCESS_REPORT_CONTACT&#39;, &#39;CONTACT&#39;, &#39;CONTACT_ID&#39;, &#39;&#39;);&#10;            --&#10;            --do_upd_fk_U(&#39;SUBJECT_ACCESS_REPORT_DOCUMENT&#39;, &#39;SUBJECT_ACCESS_REPORT&#39;, &#39;SUBJECT_ACCESS_REPORT_ID&#39;, &#39;&#39;);&#10;            --&#10;            --do_del_o_level_OMD;&#10;            --&#10;        END do_upd_secondary_fk_U;&#10;        --&#10;        PROCEDURE do_move_events_2_src&#10;        IS&#10;            --&#10;            l_proc2 VARCHAR2(30) :&#61; &#39;do_move_events_2_src&#39;;&#10;            --&#10;            l_cnt_src_E INTEGER :&#61; 0;&#10;            l_cnt_tgt_E INTEGER :&#61; 0;&#10;            --&#10;            CURSOR csE IS&#10;              SELECT&#10;                O.crn           AS src_crn,&#10;                O1.crn          AS tgt_crn,&#10;                --&#10;                PKG_Merge_Offender.get_omd_hist(offender_merge_details_id, &#39;EVENT_NUMBER&#39;, &#39;OLD&#39;) AS old_event_number,&#10;                PKG_Merge_Offender.get_omd_hist(offender_merge_details_id, &#39;EVENT_NUMBER&#39;, &#39;NEW&#39;) AS new_event_number,&#10;                --&#10;                PKG_Merge_Offender.get_omd_hist(offender_merge_details_id, &#39;COURT_CASE_URN&#39;, &#39;OLD&#39;) AS old_court_case_urn,&#10;                PKG_Merge_Offender.get_omd_hist(offender_merge_details_id, &#39;COURT_CASE_URN&#39;, &#39;NEW&#39;) AS new_court_case_urn,&#10;                --&#10;                E.rowid         AS src_row_id,&#10;                E.event_id      AS src_event_id,&#10;                E.event_number  AS src_event_number,&#10;                E1.rowid        AS tgt_row_id,&#10;                E1.event_id     AS tgt_event_id,&#10;                E1.event_number AS tgt_event_number,&#10;                --&#10;                E1.offender_id  AS tgt_offender_id_1,&#10;                O2.crn          AS tgt_crn_1,&#10;                --&#10;                OMD.*&#10;              FROM&#10;                offender_merge_details OMD&#10;                  INNER JOIN offender O  ON O.offender_id  &#61; OMD.source_offender_id&#10;                  INNER JOIN offender O1 ON O1.offender_id &#61; OMD.target_offender_id&#10;                  INNER JOIN event E ON E.event_id &#61; OMD.source_pk_value&#10;                  LEFT OUTER JOIN event E1 ON E1.event_id &#61; OMD.target_pk_value&#10;                    LEFT OUTER JOIN offender O2 ON O2.offender_id &#61; E1.offender_id&#10;              WHERE 1&#61;1&#10;                AND OMD.source_offender_id &#61; l_rec.src_offender_id&#10;                AND OMD.target_offender_id &#61; l_rec.tgt_offender_id&#10;                --AND O.crn &#61; &#39;X018538&#39;&#10;                AND OMD.table_name &#61; &#39;EVENT&#39;&#10;                AND OMD.parent_table &#61; &#39;OFFENDER&#39;&#10;              ORDER BY&#10;                LPAD(E.event_number, 10);&#10;            --&#10;            l_rec_E csE%ROWTYPE;&#10;            --&#10;            PROCEDURE do_move_event&#10;            IS&#10;                --&#10;                PROCEDURE do_del_src_event IS&#10;                BEGIN&#10;                    PKG_DPA_DELETION.P_DEL_REC(&#10;                        p_tab_name  &#61;&gt; &#39;EVENT&#39;,&#10;                        p_row_id    &#61;&gt; l_rec_E.src_row_id,&#10;                        p_check_sql &#61;&gt; &#39;PKG_MERGE_OFFENDER.do_check_src_rec_for_deletion&#39; );&#10;                END do_del_src_event;&#10;                --&#10;            BEGIN&#10;                --&#10;                info(&#10;                    --l_proc2 || &#39;:&#39; ||&#10;                    &#39;Delete original Event (recursively)&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;                --&#10;                do_del_src_event;&#10;                --&#10;                IF l_rec_E.tgt_event_id IS NOT NULL THEN&#10;                    --&#10;                    IF l_rec_E.tgt_crn_1 &lt;&gt; l_rec_E.tgt_crn THEN&#10;                        info(&#10;                            --l_proc2 || &#39;:&#39; ||&#10;                            &#39;WARNING: Since the Merge, the Event had been moved to another offender [crn&#61;&#39; || l_rec_E.tgt_crn_1 || &#39;]&#39;,&#10;                            --&#10;                            p_trace_level &#61;&gt; 15,&#10;                            p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;                    ELSE&#10;                        -- Move cloned Event back to the Source offender&#10;                        info(&#10;                            --l_proc2 || &#39;:&#39; ||&#10;                            &#39;Move cloned Event back to the Source offender; &#39; ||&#10;                            &#39;update OFFENDER_ID (recursively) from &#39;   ||&#10;                            &#39;[tgt_off_id&#61;&#39; || l_rec_E.tgt_crn || &#39; (&#39; || l_rec_E.target_offender_id || &#39;)] to &#39; ||&#10;                            &#39;[src_off_id&#61;&#39; || l_rec_E.src_crn || &#39; (&#39; || l_rec_E.source_offender_id || &#39;)]&#39;,&#10;                            --&#10;                            p_trace_level &#61;&gt; 15,&#10;                            p_proc        &#61;&gt; &#39;**&#39;/*l_proc1*/ );&#10;                        --&#10;                        UPDATE event SET&#10;                          offender_id    &#61; l_rec_E.source_offender_id,&#10;                          event_number   &#61; NVL(l_rec_E.old_event_number, event_number),&#10;                          court_case_urn &#61; NVL(l_rec_E.old_court_case_urn, court_case_urn)&#10;                        WHERE ROWID &#61; l_rec_E.tgt_row_id;&#10;                        --&#10;                        -- Update recursively OFFENDER_ID for the moved Event record&#10;                        PKG_TriggerSupport.procCascadeUpdateOffenderID(&#10;                            p_offender_id       &#61;&gt; l_rec_E.source_offender_id,&#10;                            p_table_name        &#61;&gt; &#39;EVENT&#39;,&#10;                            p_row_id            &#61;&gt; l_rec_E.tgt_row_id,&#10;                            p_exclude_nodes_lst &#61;&gt; NULL );&#10;                        --&#10;                    END IF; --l_rec_E.tgt_crn_1 &lt;&gt; l_rec_E.tgt_crn&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_move_event;&#10;            --&#10;        BEGIN&#10;            --&#10;--            info(&#10;--                l_proc2 || &#39;: Moving cloned Event records back to the Source Offender&#39;,&#10;--                --&#10;--                p_trace_level &#61;&gt; 15,&#10;--                p_proc        &#61;&gt; l_proc1 );&#10;            --&#10;            OPEN csE;&#10;            LOOP&#10;                FETCH csE INTO l_rec_E;&#10;                EXIT WHEN csE%NOTFOUND;&#10;                --&#10;                l_cnt_src_E :&#61; l_cnt_src_E + 1;&#10;                IF l_rec_E.tgt_event_id IS NOT NULL THEN&#10;                    l_cnt_tgt_E :&#61; l_cnt_tgt_E + 1;&#10;                END IF;&#10;                --&#10;                info(&#10;                    l_proc2 || &#39;: Event &#39; ||&#10;                    &#39;[tgt_event_id&#61;&#39;       || l_rec_E.tgt_event_id       || &#39;]&#39; ||&#10;                    &#39;[tgt_event_num&#61;&#39;      || l_rec_E.tgt_event_number   || &#39;]&#39; ||&#10;                    &#39;[upd_event_num&#61;&#39;      || l_rec_E.old_event_number   || &#39;]&#39; ||&#10;                    &#39;[upd_court_case_urn&#61;&#39; || l_rec_E.old_court_case_urn || &#39;]&#39; || CHR(10),&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; l_proc1 );&#10;                --&#10;                do_move_event;&#10;                do_del_OMD_subtree(l_rec_E.source_offender_id, &#39;EVENT&#39;, l_rec_E.src_event_id);&#10;                --&#10;            END LOOP;&#10;            CLOSE csE;&#10;            --&#10;            info(l_proc2 || &#39;: &#39; ||&#10;                &#39;Total of &#39; || l_cnt_src_E || &#39; original Event records have been replaced with &#39; || l_cnt_tgt_E || &#39; cloned ones&#39;,&#10;                --&#10;                p_trace_level &#61;&gt; 15,&#10;                p_proc        &#61;&gt; l_proc1 );&#10;            --&#10;        END do_move_events_2_src;&#10;        --&#10;    BEGIN&#10;        --&#10;        OPEN cs;&#10;        FETCH cs INTO l_rec;&#10;        l_found_flag :&#61; cs%FOUND;&#10;        CLOSE cs;&#10;        --&#10;        IF NOT l_found_flag THEN&#10;            fatal(&#10;                &#39;ERROR in procUnmergeOffenders_NEW.do_pre_unmerge &#39; ||&#10;                &#39;[src_off_id&#61;&#39; || p_source_offender_id || &#39;]&#39;    ||&#10;                &#39;[tgt_off_id&#61;&#39; || p_target_offender_id || &#39;]: &#39;  ||&#10;                --&#10;                &#39;Failed to find details within OFFENDER_MERGE_DETAILS table&#39;,&#10;                l_proc1 );&#10;            RETURN;&#10;        END IF;&#10;        --&#10;        do_set_merge_ctx(&#10;            p_src_offender_id           &#61;&gt; l_rec.src_offender_id,&#10;            p_tgt_offender_id           &#61;&gt; l_rec.tgt_offender_id,&#10;            --&#10;            p_source_offender_crn       &#61;&gt; l_rec.src_crn,&#10;            p_target_offender_crn       &#61;&gt; l_rec.tgt_crn,&#10;            --&#10;            p_already_merged            &#61;&gt; &#39;Y&#39;,&#10;            p_merged_date_time          &#61;&gt; l_rec.merged_date_time,&#10;            --&#10;            p_move_religion_desc        &#61;&gt; l_rec.reset_tgt_religion_desc,&#10;            --&#10;            p_debug_flag                &#61;&gt; NVL(p_debug_flag, &#39;N&#39;) );&#10;        --&#10;        IF GC_UNMERGE_MOVE_OFF_FLAG &#61; &#39;Y&#39; THEN&#10;            NULL;&#10;        END IF;&#10;        --&#10;        -- Identify the original (pre-merge) Active OM record&#10;        do_check_target_OM_U(&#39;Y&#39;);&#10;        --&#10;        IF GC_UNMERGE_MOVE_EVENT_FLAG &#61; &#39;Y&#39; THEN&#10;            --&#10;            -- NDM-147: move Event level data from the Target back to the Source offender&#10;            --&#10;            IF GC_UNMERGE_MOVE_OFF_FLAG &#61; &#39;N&#39; THEN&#10;                -- Step1. Update secondary FK (for parent O-level ONLY tables)&#10;                do_upd_secondary_fk_U;&#10;            END IF;&#10;            --&#10;            -- Step 2. Move cloned Event level subtrees back to the Source Offender&#10;            do_move_events_2_src;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_pre_unmerge;&#10;    --&#10;    PROCEDURE do_post_unmerge&#10;    IS&#10;        --&#10;        l_proc1 VARCHAR2(30) :&#61; &#39;DO_POST_UNMERGE&#39;;&#10;        --&#10;        LC_USER_ID          NUMBER :&#61; PKG_LOOKUPS.GetUserID(p_distinguished_name &#61;&gt; PKG_Common.NVLSTR(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;), &#39;[Data Maintenance]&#39;));&#10;        LC_DATE_TIME        DATE   :&#61; SYSDATE;&#10;        LC_DATE             DATE   :&#61; TRUNC(LC_DATE_TIME);&#10;        --&#10;        --&#10;        l_OMD_qty NUMBER;&#10;        --&#10;        PROCEDURE do_del_orphaned_OMD(&#10;            p_table          VARCHAR2,&#10;            p_del_src_record VARCHAR2 DEFAULT NULL,&#10;            p_hier_level     INTEGER DEFAULT NULL )&#10;        IS&#10;            --&#10;            l_rows_OMD INTEGER :&#61; 0;&#10;            --&#10;            CURSOR csOMD IS&#10;              WITH OMD1 AS (&#10;                SELECT&#10;                  PKG_Lookups.funcgetTabRecord(&#10;                      p_table       &#61;&gt; OMD.table_name,&#10;                      p_data_fld    &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;                      p_ref_col     &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;                      p_ref_val     &#61;&gt; OMD.target_pk_value,&#10;                      p_default_val &#61;&gt; &#39;-1&#39;&#10;                  ) AS tgt_cur_pk_value,&#10;                  PKG_Lookups.funcgetTabRecord(&#10;                      p_table       &#61;&gt; OMD.table_name,&#10;                      p_data_fld    &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;                      p_ref_col     &#61;&gt; PKG_DynSQL.get_tab_pk_fld_lst(OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1),&#10;                      p_ref_val     &#61;&gt; OMD.source_pk_value,&#10;                      p_default_val &#61;&gt; &#39;-1&#39;&#10;                  ) AS src_cur_pk_value,&#10;                  OMD.*&#10;                FROM&#10;                  offender_merge_details OMD&#10;                    --INNER JOIN offender O ON O.offender_id &#61; OMD.source_offender_id&#10;                WHERE 1&#61;1&#10;                  --AND O.crn &#61; &#39;X017034&#39;&#10;                  AND OMD.source_offender_id &#61; l_rec.src_offender_id&#10;                  AND OMD.target_offender_id &#61; l_rec.tgt_offender_id&#10;                  AND OMD.table_name &#61; p_table&#10;                  AND OMD.hierarchy_level &#61; NVL(p_hier_level, OMD.hierarchy_level)&#10;                  --AND OMD.source_pk_value NOT IN ( &#39;-2&#39; )&#10;                )&#10;              --&#10;              SELECT *&#10;              FROM OMD1&#10;              WHERE 1&#61;1&#10;                AND tgt_cur_pk_value &#61; &#39;-1&#39;;&#10;            --&#10;            l_rec_OMD csOMD%ROWTYPE;&#10;            --&#10;            PROCEDURE do_process_orphaned_precon&#10;            IS&#10;                --&#10;                CURSOR csDoc IS&#10;                  SELECT document_id&#10;                  FROM document&#10;                  WHERE offender_id &#61; l_rec_OMD.source_offender_id&#10;                    AND document_id &#61; l_rec_OMD.source_pk_value&#10;                    AND document_type &#61; &#39;PREVIOUS_CONVICTION&#39;;&#10;                --&#10;                l_rec_doc csDoc%ROWTYPE;&#10;                --&#10;                l_found_flag BOOLEAN;&#10;                --&#10;            BEGIN&#10;                --&#10;                OPEN csDoc;&#10;                FETCH csDoc INTO l_rec_doc;&#10;                l_found_flag :&#61; csDoc%FOUND;&#10;                CLOSE csDoc;&#10;                --&#10;                IF l_found_flag THEN&#10;                    --&#10;                    info(&#10;                        &#39;do_del_orphaned_OMD.do_process_orphaned_precon:&#39; ||&#10;                        &#39; - delete orphaned PRECON records from OFFENDER_MERGE_DETAILS &#39; ||&#10;                        &#39;[tgt_pk&#61;&#39; || l_rec_OMD.target_pk_value || &#39;]&#39; ||&#10;                        &#39;[src_pk&#61;&#39; || l_rec_OMD.source_pk_value || &#39;]&#39;,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; l_proc1 );&#10;                    --&#10;                    IF 1&#61;1 /*p_del_src_record &#61; &#39;Y&#39;*/ THEN&#10;                        --&#10;                        DELETE FROM document WHERE document_id &#61; l_rec_doc.document_id;&#10;                        --&#10;                        IF SQL%ROWCOUNT &#61; 1 THEN&#10;                            info(&#10;                                &#39;WARNING: deleted 1 record from the Source DOCUMENT (document_type&#61;PREVIOUS_CONVICTION) table (as it does not exist on the Target anymore&#39;,&#10;                                --&#10;                                p_trace_level &#61;&gt; 15,&#10;                                p_proc        &#61;&gt; &#39;**&#39; );&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                    do_del_OMD_rec(p_omd_id&#61;&gt;l_rec_OMD.offender_merge_details_ID);&#10;                    --&#10;                END IF;&#10;                --&#10;            END do_process_orphaned_precon;&#10;            --&#10;        BEGIN&#10;            --&#10;            OPEN csOMD;&#10;            LOOP&#10;                FETCH csOMD INTO l_rec_OMD;&#10;                EXIT WHEN csOMD%NOTFOUND;&#10;                --&#10;                IF p_table &#61; &#39;DOCUMENT&#39; THEN&#10;                    --&#10;                    do_process_orphaned_precon;&#10;                    --&#10;                ELSE&#10;                    --&#10;                    info(&#10;                        &#39;do_del_orphaned_OMD:&#39; ||&#10;                        &#39; - delete orphaned records from OFFENDER_MERGE_DETAILS &#39; ||&#10;                        &#39;[tab&#61;&#39;    || l_rec_OMD.table_name      || &#39;]&#39; ||&#10;                        &#39;[tgt_pk&#61;&#39; || l_rec_OMD.target_pk_value || &#39;]&#39; ||&#10;                        &#39;[src_pk&#61;&#39; || l_rec_OMD.source_pk_value || &#39;]&#39; ||&#10;                        &#39;[parent&#61;&#39; || l_rec_OMD.parent_table    || &#39;]&#39; ||&#10;                        &#39;[tgt_fk&#61;&#39; || l_rec_OMD.target_fk_value || &#39;]&#39; ||&#10;                        &#39;[src_fk&#61;&#39; || l_rec_OMD.source_fk_value || &#39;]&#39; ||&#10;                        &#39;[del_src_record&#61;&#39; || p_del_src_record  || &#39;]&#39;,&#10;                        --&#10;                        p_trace_level &#61;&gt; 15,&#10;                        p_proc        &#61;&gt; l_proc1 );&#10;                    --&#10;                    IF p_del_src_record &#61; &#39;Y&#39; THEN&#10;                        --&#10;                        EXECUTE IMMEDIATE&#10;                         &#39;DELETE FROM &#39; || l_rec_OMD.table_name || &#39;&#10;                          WHERE &#39; || PKG_DynSQL.get_tab_pk_fld_lst(l_rec_OMD.table_name, &#39; || &#39;&#39;:&#39;&#39; || &#39;, -1) || &#39; &#61; :p_pk&#39;&#10;                        USING&#10;                          l_rec_OMD.source_pk_value;&#10;                        --&#10;                        IF SQL%ROWCOUNT &#61; 1 THEN&#10;                            info(&#10;                                &#39;WARNING: deleted 1 record from the Source &#39; || l_rec_OMD.table_name || &#39; table (as it does not exist on the Target anymore&#39;,&#10;                                --&#10;                                p_trace_level &#61;&gt; 15,&#10;                                p_proc        &#61;&gt; &#39;**&#39; );&#10;                        END IF;&#10;                        --&#10;                    END IF;&#10;                    --&#10;                    do_del_OMD_rec(p_omd_id&#61;&gt;l_rec_OMD.offender_merge_details_ID);&#10;                    --&#10;                END IF;&#10;                --&#10;                l_rows_OMD :&#61; l_rows_OMD + 1;&#10;                --&#10;            END LOOP;&#10;            CLOSE csOMD;&#10;            --&#10;            IF l_rows_OMD &gt; 0 THEN&#10;                info(&#10;                    --&#39;do_del_orphaned_OMD: &#39; ||&#10;                    &#39;[total rows&#61;&#39; || l_rows_OMD || &#39;] - deleted&#39;,&#10;                    --&#10;                    p_trace_level &#61;&gt; 15,&#10;                    p_proc        &#61;&gt; &#39;**&#39; );&#10;            END IF;&#10;            --&#10;        END do_del_orphaned_OMD;&#10;        --&#10;        PROCEDURE do_check_OMD IS&#10;        BEGIN&#10;            --&#10;            SELECT COUNT(1) INTO l_OMD_qty&#10;            FROM offender_merge_details&#10;            WHERE source_offender_id &#61; l_rec.src_offender_id&#10;              AND target_offender_id &#61; l_rec.tgt_offender_id;&#10;            --&#10;            IF l_OMD_qty &gt; 0 THEN&#10;                fatal(&#10;                    &#39;ERROR in procUnmergeOffenders_NEW.do_post_unmerge &#39; ||&#10;                    &#39;[src_off_id&#61;&#39; || p_source_offender_id || &#39;]&#39;     ||&#10;                    &#39;[tgt_off_id&#61;&#39; || p_target_offender_id || &#39;]: &#39;   ||&#10;                    --&#10;                    &#39;There are some remaining records in OFFENDER_MERGE_DETAILS table:&#39; || CHR(10) ||&#10;                    PKG_Lookups.funcgetTabRecord(&#10;                        p_table       &#61;&gt; &#39;offender_merge_details OMD, offender O&#39;,&#10;                        p_data_fld    &#61;&gt;&#10;--                        &#39;SUBSTR(RPAD(table_name, 32) || COUNT(1) || &#39;&#39; &#39;&#39; || SUBSTR(&#39;&#39;(&#39;&#39; || LISTAGG(target_pk_value, &#39;&#39;, &#39;&#39;) WITHIN GROUP (ORDER BY target_pk_value) || &#39;&#39;)&#39;&#39;, 1, 4000), 1, 4000)&#39;,&#10;                           &#39;PKG_LstUtl.concat(&#10;                                table_name,&#10;                                COUNT(1),&#10;                                --&#10;                                --SUBSTR(&#39;&#39;(&#39;&#39; || LISTAGG(target_pk_value, &#39;&#39;, &#39;&#39;) WITHIN GROUP (ORDER BY target_pk_value) || &#39;&#39;)&#39;&#39;, 1, 4000),&#10;                                &#39;&#39;(&#39;&#39; ||&#10;                                PKG_Lookups.funcgetTabRecord(&#10;                                    p_table       &#61;&gt; &#39;&#39;offender_merge_details&#39;&#39;,&#10;                                    p_data_fld    &#61;&gt; &#39;&#39;target_pk_value&#39;&#39;,&#10;                                    p_ref_col     &#61;&gt; &#39;&#39;source_offender_id&#39;&#39;,&#10;                                    p_ref_val     &#61;&gt; O.offender_id,&#10;                                    p_where       &#61;&gt; &#39;&#39;table_name &#61; :p_table&#39;&#39;,&#10;                                    p_order_by    &#61;&gt; &#39;&#39;target_pk_value&#39;&#39;,&#10;                                    p_bind_var1   &#61;&gt; OMD.table_name,&#10;                                    p_all_records &#61;&gt; &#39;&#39;Y&#39;&#39;,&#10;                                    p_delim       &#61;&gt; &#39;&#39;,&#39;&#39;,&#10;                                    p_max_len     &#61;&gt; 3998 ) ||&#10;                                &#39;&#39;)&#39;&#39;,&#10;                                --&#10;                                p_delim     &#61;&gt; &#39;&#39; &#39;&#39;,&#10;                                p_max_len   &#61;&gt; 4000 )&#39;,&#10;                        p_ref_col     &#61;&gt; &#39;O.offender_id&#39;,&#10;                        p_ref_val     &#61;&gt; l_rec.src_offender_id,&#10;                        p_where       &#61;&gt; &#39;O.offender_id &#61; OMD.source_offender_id GROUP BY O.offender_id, table_name&#39;,&#10;                        p_order_by    &#61;&gt; &#39;OMD.table_name&#39;,&#10;                        p_all_records &#61;&gt; &#39;Y&#39;,&#10;                        p_delim       &#61;&gt; CHR(10) ),&#10;                    l_proc1 );&#10;            END IF;&#10;            --&#10;        END do_check_OMD;&#10;        --&#10;        PROCEDURE do_reset_soft_deleted IS&#10;        BEGIN&#10;            --&#10;            UPDATE offender SET&#10;              soft_deleted &#61; 0,&#10;              --&#10;              row_version           &#61; row_version + 1,&#10;              last_updated_datetime &#61; LC_DATE_TIME,&#10;              last_updated_user_id  &#61; LC_USER_ID&#10;            WHERE offender_id &#61; l_rec.src_offender_id;&#10;            --&#10;        END do_reset_soft_deleted;&#10;        --&#10;        PROCEDURE do_create_off_unmerge_contact&#10;        IS&#10;            --&#10;            l_contact_id      NUMBER;&#10;            l_off_merge_notes CLOB;&#10;            --&#10;            FUNCTION get_off_unmerge_contact_notes(p_offender_id NUMBER, p_extra_details VARCHAR2 DEFAULT &#39;Y&#39;) RETURN VARCHAR2&#10;            IS&#10;                --&#10;                l_ret VARCHAR2(4000);&#10;                l_crn OFFENDER.crn%TYPE;&#10;                --&#10;            BEGIN&#10;                --&#10;                SELECT crn INTO l_crn&#10;                FROM offender&#10;                WHERE offender_id &#61; p_offender_id;&#10;                --&#10;                SELECT&#10;                  &#39;CRN: &#39;   || O.crn || CHR(10) ||&#10;                  --&#39;From Team: &#39;    || T.description || CHR(10) ||&#10;                  &#39;Offender Name: &#39; || PKG_LstUtl.concat(O.surname, PKG_LstUtl.concat(O.first_name, O.second_name, O.third_name, p_delim&#61;&gt;&#39; &#39;), p_delim&#61;&gt; &#39;, &#39;) ||&#10;                  CASE WHEN p_extra_details &#61; &#39;Y&#39; THEN&#10;                    CHR(10) ||&#10;                    &#39;Offender Manager Trust: &#39;   || PA.description || CHR(10) ||&#10;                    &#39;Offender Manager Team: &#39;    || T.description || CHR(10) ||&#10;                    &#39;Offender Manager Officer: &#39; || PKG_SPG_SUPPORT.get_responsible_staff(OM.allocation_staff_id, OM.provider_employee_id)&#10;                  END&#10;                INTO l_ret&#10;                FROM&#10;                  offender_manager OM&#10;                    INNER JOIN offender O ON O.offender_id &#61; OM.offender_id&#10;                    INNER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;                      INNER JOIN probation_area PA ON PA.probation_area_id &#61; T.probation_area_id&#10;                    INNER JOIN officer S ON S.trust_provider_flag &#61; OM.trust_provider_flag AND S.staff_employee_id &#61; OM.staff_employee_id&#10;                      LEFT OUTER JOIN staff S1 ON S1.staff_id &#61; S.staff_employee_id AND S.trust_provider_flag &#61; 0&#10;                WHERE OM.offender_id &#61; p_offender_id&#10;                  AND OM.active_flag &#61; 1;&#10;                --&#10;                RETURN l_ret;&#10;                --&#10;            EXCEPTION WHEN NO_DATA_FOUND THEN&#10;                --&#10;                RETURN&#10;                    &#39;NO_DATA_FOUND: failed to locate ACTIVE OM record for &#39; ||&#10;                    &#39;[offender_id&#61;&#39; || p_offender_id || &#39;]&#39; ||&#10;                    &#39;[crn&#61;&#39;         || l_crn         || &#39;]&#39;;&#10;                --&#10;            END get_off_unmerge_contact_notes;&#10;            --&#10;            PROCEDURE do_cr_sgc_unmerge_contact(p_tgt_flag VARCHAR2)&#10;            IS&#10;                --&#10;                l_off_id NUMBER;&#10;                --&#10;            BEGIN&#10;                --&#10;                g_label :&#61; &#39;550100&#39;;&#10;                l_off_merge_notes :&#61;&#10;                    PKG_LstUtl.concat(&#10;                        &#39;Target Offender&#39;,&#10;                        get_off_unmerge_contact_notes(l_rec.tgt_offender_id, &#39;N&#39;),&#10;                        --&#10;                        CHR(10) || &#39;Source Offender&#39;,&#10;                        get_off_unmerge_contact_notes(l_rec.src_offender_id),&#10;                        --&#10;                        PKG_LstUtl.concat(&#10;                          CHR(10) || &#39;Some data items may have changed and should be corrected as necessary. Please review the following data items:&#39;,&#10;                          CASE WHEN p_tgt_flag &#61; &#39;N&#39; THEN&#10;                              PKG_LstUtl.concat(&#10;                                  &#39;- Main Address&#39;,&#10;                                  &#39;- Postal Address&#39;,&#10;                                  p_delim&#61;&gt;CHR(10) )&#10;                          ELSE&#10;                              PKG_LstUtl.concat(&#10;                                  &#39;- Offender Manager&#39;,&#10;                                  &#39;- Management Tier&#39;,&#10;                                  &#39;- Main Address&#39;,&#10;                                  &#39;- Postal Address&#39;,&#10;                                  p_delim&#61;&gt;CHR(10) )&#10;                          END,&#10;                          --&#10;                          p_delim&#61;&gt;CHR(10) ),&#10;                        --&#10;                        p_delim&#61;&gt;CHR(10) );&#10;                --&#10;                g_label :&#61; &#39;550200&#39;;&#10;                --&#10;                SELECT&#10;                  DECODE(p_tgt_flag, &#39;Y&#39;, l_rec.tgt_offender_id, l_rec.src_offender_id),&#10;                  contact_id_SEQ.nextval&#10;                INTO&#10;                  l_off_id,&#10;                  l_contact_id&#10;                FROM dual;&#10;                --&#10;                INSERT INTO contact(&#10;                  contact_id,&#10;                  offender_id,&#10;                  contact_date,&#10;                  contact_type_id,&#10;                  --&#10;                  visor_contact,&#10;                  visor_exported,&#10;                  --&#10;                  probation_area_id,&#10;                  team_id,&#10;                  provider_team_id,&#10;                  staff_id,&#10;                  provider_employee_id,&#10;                  --&#10;                  notes,&#10;                  --&#10;                  created_by_user_id,&#10;                  created_datetime,&#10;                  last_updated_user_id,&#10;                  last_updated_datetime,&#10;                  soft_deleted,&#10;                  partition_area_id )&#10;                SELECT&#10;                  l_contact_id,&#10;                  OM.offender_id,&#10;                  SYSDATE AS contact_date,&#10;                  ( SELECT contact_type_id FROM r_contact_type WHERE code &#61; &#39;UMRG&#39; /*Unerge Offenders*/ ) AS contact_type_id,&#10;                  --&#10;                  &#39;N&#39;,&#10;                  &#39;N&#39;,&#10;                  --&#10;                  OM.probation_area_id,&#10;                  OM.team_id,&#10;                  OM.provider_team_id,&#10;                  OM.allocation_staff_id,&#10;                  OM.provider_employee_id,&#10;                  --&#10;                  l_off_merge_notes AS notes,&#10;                  --&#10;                  LC_USER_ID,&#10;                  LC_DATE_TIME,&#10;                  LC_USER_ID,&#10;                  LC_DATE_TIME,&#10;                  0,&#10;                  0&#10;                FROM offender_manager OM&#10;                WHERE OM.offender_id &#61; l_off_id&#10;                  AND OM.active_flag &#61; 1;&#10;                --&#10;                info(&#39;DO_CREATE_OFF_UNMERGE_CONTACT: create new Unmerge Contact record [offender_id&#61;&#39; || l_off_id || &#39;][contact_id&#61;&#39; || l_contact_id || &#39;]&#39;, p_trace_level&#61;&gt;15, p_proc&#61;&gt;&#39;DO_CREATE_OFF_UNMERGE_CONTACT&#39;);&#10;                --&#10;                g_label :&#61; &#39;599000&#39;;&#10;                --&#10;            END do_cr_sgc_unmerge_contact;&#10;            --&#10;        BEGIN&#10;            --&#10;            do_cr_sgc_unmerge_contact(p_tgt_flag&#61;&gt;&#39;N&#39;);&#10;            do_cr_sgc_unmerge_contact(p_tgt_flag&#61;&gt;&#39;Y&#39;);&#10;            --&#10;        END do_create_off_unmerge_contact;&#10;        --&#10;        PROCEDURE do_upd_iaps_components_U&#10;        IS&#10;        BEGIN&#10;            --Update IAPS flags prior to move so only moved records are of interest&#10;            UPDATE iaps_event           SET iaps_flag &#61; 1 WHERE event_id         IN (SELECT event_id         FROM event         WHERE offender_id &#61; l_rec.src_offender_id);&#10;            UPDATE iaps_lic_condition   SET iaps_flag &#61; 1 WHERE lic_condition_id IN (SELECT lic_condition_id FROM lic_condition WHERE offender_id &#61; l_rec.src_offender_id);&#10;            UPDATE iaps_rqmnt           SET iaps_flag &#61; 1 WHERE rqmnt_id         IN (SELECT rqmnt_id         FROM rqmnt         WHERE offender_id &#61; l_rec.src_offender_id);&#10;            UPDATE iaps_contact         SET iaps_flag &#61; 1 WHERE contact_id       IN (SELECT contact_id       FROM contact       WHERE offender_id &#61; l_rec.src_offender_id);&#10;            --&#10;            g_merge_ctx_rec.src_iaps_of_interest :&#61; get_iaps_flag(l_rec.src_offender_id);&#10;            --&#10;        END do_upd_iaps_components_U;&#10;        --&#10;        PROCEDURE do_upd_doc_pk_id IS&#10;        BEGIN&#10;            UPDATE document SET&#10;              primary_key_id &#61; TO_CHAR(l_rec.src_offender_id)&#10;            WHERE offender_id &#61; l_rec.src_offender_id&#10;              AND table_name &#61; &#39;OFFENDER&#39;&#10;              AND primary_key_id &lt;&gt; TO_CHAR(l_rec.src_offender_id);&#10;        END do_upd_doc_pk_id;&#10;        --&#10;        PROCEDURE do_amend_SAR_U IS&#10;        BEGIN&#10;            --&#10;            UPDATE subject_access_report SET&#10;              generation_status &#61; &#39;A&#39;,&#10;              --&#10;              row_number &#61; row_number + 1,&#10;              --&#10;              last_updated_user_id  &#61; LC_USER_ID,&#10;              last_updated_datetime &#61; LC_DATE_TIME&#10;            WHERE offender_id IN ( l_rec.src_offender_id, l_rec.tgt_offender_id )&#10;              AND generation_status &#61; &#39;C&#39;;&#10;            --&#10;        END do_amend_SAR_U;&#10;        --&#10;        PROCEDURE do_CAS_calc_U IS&#10;        BEGIN&#10;            --&#10;            PKG_TriggerSupport.procAddCASDeferred(l_rec.src_offender_id);&#10;            PKG_TriggerSupport.procAddCASDeferred(l_rec.tgt_offender_id);&#10;            PKG_TriggerSupport.procUpdateCAS_DEFERRED(p_trigger_name &#61;&gt; &#39;DO_POST_UNMERGE&#39;);&#10;            --&#10;        END do_CAS_calc_U;&#10;        --&#10;    BEGIN&#10;        --&#10;        -- NDM-168: Create post-unmerge OM/RO/OT/C records&#10;        do_check_target_OM_U;&#10;        --&#10;        -- Process records that have been deleted while merged on the Target CRN&#10;        do_del_orphaned_OMD( &#39;CONTACT_ALERT&#39; );&#10;        do_del_orphaned_OMD( &#39;DOCUMENT&#39;      );&#10;        --&#10;        IF GC_UNMERGE_MOVE_OFF_FLAG &#61; &#39;Y&#39; THEN&#10;            --&#10;            do_del_orphaned_OMD( &#39;ADDITIONAL_IDENTIFIER&#39;, &#39;Y&#39; );&#10;            --&#10;            do_del_orphaned_OMD( &#39;CONTACT&#39;              , &#39;Y&#39;, 1 );&#10;            do_del_orphaned_OMD( &#39;OFFENDER_ADDRESS&#39;     , &#39;Y&#39; );&#10;            do_del_orphaned_OMD( &#39;REGISTRATION_REVIEW&#39;  , &#39;Y&#39; );&#10;            --&#10;            do_del_orphaned_OMD( &#39;PROVISION&#39;            , &#39;N&#39; );&#10;            do_del_orphaned_OMD( &#39;DISABILITY&#39;           , &#39;N&#39; );&#10;            --&#10;            do_del_orphaned_OMD( &#39;OFFENDER_PRISONER&#39;    , &#39;N&#39; );&#10;            --&#10;            --do_del_orphaned_OMD( &#39;MANAGEMENT_TIER&#39;    , &#39;N&#39;);&#10;            --&#10;        END IF;&#10;        --&#10;        -- Check if the are any remaining OMD records (should not be any)&#10;        do_check_OMD;&#10;        IF l_OMD_qty &gt; 0 THEN&#10;            RETURN;&#10;        END IF;&#10;        --&#10;        do_upd_offender_flags(l_rec.src_offender_id);&#10;        do_upd_offender_flags(l_rec.tgt_offender_id);&#10;        --&#10;        do_submit_mt_change(l_rec.tgt_offender_id);&#10;        --&#10;        LC_DATE_TIME :&#61; SYSDATE;&#10;        --&#10;        do_reset_soft_deleted;&#10;        --&#10;        do_create_off_unmerge_contact;&#10;        --&#10;        -- NDM-191: Update IAPS Flags on the Source&#10;        do_upd_iaps_components_U;&#10;        --&#10;        IF g_merge_ctx_rec.src_iaps_of_interest &#61; 1 THEN&#10;            do_upd_iaps_offender(l_rec.src_offender_id, 1);&#10;            -- NDM-153: Update original Target Offender IAPP_OFFENDER (if necessary)&#10;            g_merge_ctx_rec.tgt_iaps_of_interest :&#61; get_iaps_flag(l_rec.tgt_offender_id);&#10;            IF g_merge_ctx_rec.tgt_iaps_of_interest &#61; 0 THEN&#10;                -- Reset IAPS interest flag on the original Target Offender:&#10;                do_upd_iaps_offender(l_rec.tgt_offender_id, 2);&#10;            END IF;&#10;        END IF;&#10;        --&#10;        -- NDM-197: Restore Source Offender ID&#10;        do_upd_doc_pk_id;&#10;        --DST-12291: Set SAR status to (A)rchived&#10;        do_amend_SAR_U;&#10;        --&#10;        -- DST-13582: Recalculate CAS for both Source and Target Offenders&#10;        do_CAS_calc_U;&#10;        --&#10;    END do_post_unmerge;&#10;    --&#10;BEGIN&#10;    --&#10;    set_merge_running_flag(&#39;Y&#39;);&#10;    --&#10;    do_pre_unmerge;&#10;    --&#10;    PKG_hier_support.offender_records_iterator(&#10;        --&#10;        p_offender_id         &#61;&gt; l_rec.tgt_offender_id,&#10;        p_offender_id_1       &#61;&gt; l_rec.src_offender_id,&#10;        --&#10;        p_tab_name            &#61;&gt; &#39;OFFENDER&#39;,&#10;        p_row_id              &#61;&gt; l_rec.tgt_row_id,&#10;        p_recursive_level     &#61;&gt; 1,&#10;        --&#10;        p_when_to_execute     &#61;&gt; &#39;POST&#39;,&#10;        p_ignore_where_clause &#61;&gt; &#39;N&#39;,&#10;        --&#10;        p_include_merged      &#61;&gt; &#39;Y&#39;,&#10;        p_skip_subtrees       &#61;&gt;&#10;            PKG_LstUtl.concat(&#10;                &#39;&#39;,&#10;                &#39;*/OFFENDER_MERGE_DETAILS&#39;,&#10;                --&#10;                p_delim &#61;&gt; &#39;, &#39; ),&#10;        --&#10;        p_dyn_SQL             &#61;&gt;&#10;           &#39;DECLARE&#10;                --&#10;                l_parent_table    VARCHAR2(30) :&#61; :p_parent_table;&#10;                l_table           VARCHAR2(30) :&#61; :p_table;&#10;                l_offender_id     NUMBER       :&#61; :p_offender_id;&#10;                l_parent_row_id   ROWID        :&#61; :p_parent_row_id;&#10;                l_row_id          ROWID        :&#61; :p_row_id;&#10;                l_recursive_level INTEGER      :&#61; :p_recursive_level;&#10;                --&#10;            BEGIN&#10;                --IF l_parent_table IS NOT NULL THEN&#10;                    PKG_Merge_Offender.off_unmerge_curr_rec(&#10;                        p_parent_table    &#61;&gt; l_parent_table,&#10;                        p_table           &#61;&gt; l_table,&#10;                        p_offender_id     &#61;&gt; l_offender_id,&#10;                        p_parent_row_id   &#61;&gt; l_parent_row_id,&#10;                        p_row_id          &#61;&gt; l_row_id,&#10;                        p_recursive_level &#61;&gt; l_recursive_level );&#10;                --END IF;&#10;            END;&#39; );&#10;    --&#10;    do_post_unmerge;&#10;    --&#10;    set_merge_running_flag(&#39;N&#39;);&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    set_merge_running_flag(&#39;N&#39;);&#10;    --&#10;    RAISE;&#10;    --&#10;END procUnmergeOffenders_NEW;&#10;&#10;-- Overload&#10;PROCEDURE procUnmergeOffenders_NEW(&#10;    p_source_offender_crn VARCHAR2,&#10;    p_target_offender_crn VARCHAR2,&#10;    p_debug_flag          VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    CURSOR cs IS&#10;      SELECT&#10;        O1.offender_id AS source_offender_id,&#10;        O2.offender_id AS target_offender_id&#10;        --&#10;      FROM&#10;        offender_merge_details OMD&#10;          INNER JOIN offender O1 ON O1.offender_id &#61; OMD.source_offender_id&#10;          INNER JOIN offender O2 ON O2.offender_id &#61; OMD.target_offender_id&#10;      WHERE OMD.table_name &#61; &#39;OFFENDER&#39;&#10;        AND OMD.parent_table IS NULL&#10;        AND OMD.hierarchy_level &#61; 0&#10;        AND O1.crn &#61; p_source_offender_crn&#10;        AND O2.crn &#61; p_target_offender_crn;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    l_found_flag BOOLEAN;&#10;    --&#10;BEGIN&#10;    --&#10;    OPEN cs;&#10;    FETCH cs INTO l_rec;&#10;    l_found_flag :&#61; cs%FOUND;&#10;    CLOSE cs;&#10;    --&#10;    IF l_found_flag THEN&#10;        procUnmergeOffenders_NEW(&#10;            p_source_offender_id &#61;&gt; l_rec.source_offender_id,&#10;            p_target_offender_id &#61;&gt; l_rec.target_offender_id,&#10;            p_debug_flag         &#61;&gt; p_debug_flag );&#10;    ELSE&#10;        fatal(&#10;            &#39;ERROR: failed to identify Source [&#39; || p_source_offender_crn || &#39;] and Target [&#39; || p_target_offender_crn || &#39;] records in OFFENDER_MERGE_DETAILS&#39;,&#10;            &#39;&#39; );&#10;    END IF;&#10;    --&#10;END procUnmergeOffenders_NEW; -- Overload(1)&#10;--&#10;--&#10;--&#10;&#10;--&#10;-- Old Merge / Unmerge start from Line 11750&#10;--&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;--****************************************************************************--&#10;--&#10;-- Old Legacy Merge / UnMerge subroutines&#10;--&#10;--****************************************************************************--&#10;PROCEDURE procMergeOffenders(&#10;    p_target_offender NUMBER,&#10;    p_origin_offender NUMBER,&#10;    --&#10;    p_bg_flag         VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_debug_flag      VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_merge_off_tab_OLD_FLAG BOOLEAN :&#61; ( PKG_Lookups.funcgetNDParameterValue(&#39;MERGE_OFFENDER_OLD_FLAG&#39;, 0) &#61; 1 );&#10;    --&#10;    CURSOR cs IS&#10;      SELECT DISTINCT&#10;        table_name,&#10;        DECODE(table_name,&#10;            &#39;MANAGEMENT_TIER&#39;, &#39;tier_id&#39;,&#10;            LOWER(PKG_DynSQL.get_tab_pk_fld_lst(table_name))&#10;        ) AS unique_id_fld,&#10;        DECODE(table_name,&#10;            &#39;MANAGEMENT_TIER&#39;, &#39;date_changed&#39;,&#10;            &#39;NULL&#39;&#10;        ) AS extra_date_fld,&#10;        DECODE(table_name,&#10;          &#39;X&#39;, &#39;NULL&#39;,&#10;          &#39;NULL&#39;&#10;        ) AS extra_number_fld,&#10;        DECODE(table_name,&#10;            &#39;OFFENDER_PRISONER&#39;, &#39;prisoner_number&#39;,&#10;            &#39;NULL&#39;&#10;        ) AS extra_string_fld,&#10;        --&#10;        DECODE(table_name,&#10;            &#39;CONTACT&#39;, &#39;event_id IS NULL&#39;,&#10;            &#39;NSI&#39;    , &#39;event_id IS NULL&#39;,&#10;            NULL&#10;        ) AS where_clause&#10;        --&#10;        /*PKG_Lookups.funcGetTabRecord(&#10;            p_table       &#61;&gt; &#39;TABLE( PKG_DynSQL.get_tab_list ) T1&#39;,&#10;            p_data_fld    &#61;&gt; &#39;DISTINCT T1.table_name&#39;,&#10;            p_ref_col     &#61;&gt; &#39;T1.parent_table&#39;,&#10;            p_ref_val     &#61;&gt; table_name,&#10;            p_where       &#61;&gt; &#39;T1.table_type &#61; &#39;&#39;O&#39;&#39;&#39;,&#10;            p_order_by    &#61;&gt; &#39;T1.table_name&#39;,&#10;            p_all_records &#61;&gt; &#39;Y&#39;,&#10;            p_delim       &#61;&gt; &#39;, &#39;&#10;        ) AS chld_tab_lst*/&#10;      FROM TABLE( PKG_DynSQL.get_tab_list ) T&#10;      WHERE table_type &#61; &#39;O&#39;&#10;        AND parent_table &#61; &#39;OFFENDER&#39;&#10;        AND table_name NOT IN (&#10;            &#39;EQUALITY&#39;,&#10;            &#39;OFFENDER_MANAGER&#39;, &#39;OFFENDER_TRANSFER&#39;, &#39;PRISON_OFFENDER_MANAGER&#39;, &#39;PROVIDER_LAO&#39;, &#39;RESPONSIBLE_OFFICER&#39;,&#10;            --&#10;            &#39;ORGANISATION_OFFENDER&#39;, &#39;CASELOAD&#39;, &#39;COHORT_DIARY&#39;, &#39;CONTACT_ALERT&#39;,&#10;            --&#10;            &#39;OFFENDER_CRC_EXPORT&#39;, &#39;CRC_INACTIVE_OFFENDER&#39;,&#10;            &#39;DSS_SEARCH_REQUEST&#39;, &#39;SPG_DOCUMENT_REQUEST&#39;, &#39;SPG_SEARCH_OFFENDER&#39;,&#10;            &#39;SPG_NOTIFICATION&#39;, &#39;SPG_EXCEPTION&#39;, &#39;SPG_VERSION_ENTRY&#39;,&#10;            &#39;DATA_SCRIPT_MESSAGE&#39;, &#39;SQL_SCRIPT_MESSAGE&#39;,&#10;              --&#10;            &#39;MOST_RECENTLY_VIEWED_OFFENDERS&#39;,&#10;            &#39;MERGE_HISTORY&#39;, &#39;MERGE_DUPLICATES&#39;, &#39;MERGE_OFFENDER_VALUES&#39;,&#10;            &#39;OFFENDER_MERGE_DETAILS&#39;, &#39;OFFENDER_MERGE_DETAILS_HIST&#39; )&#10;        --AND NOT EXISTS( SELECT 1 FROM TABLE( PKG_DynSQL.get_tab_list ) T1 WHERE T1.table_type &#61; &#39;O&#39; AND T1.parent_table &#61; T.table_name )&#10;      ORDER BY&#10;        DECODE(table_name,&#10;            &#39;ALIAS&#39;                   , &#39;01&#39;,&#10;            &#39;OFFENDER_ADDRESS&#39;        , &#39;02&#39;,&#10;            &#39;DISABILITY&#39;              , &#39;03&#39;,&#10;            -- PROVISION is a child of DISABILITY&#10;            &#39;MANAGEMENT_TIER&#39;         , &#39;04&#39;,&#10;            &#39;PERSONAL_CIRCUMSTANCE&#39;   , &#39;05&#39;,&#10;            &#39;PERSONAL_CONTACT&#39;        , &#39;06&#39;,&#10;            &#39;ADDITIONAL_IDENTIFIER&#39;   , &#39;07&#39;,&#10;            &#39;OFFENDER_PRISONER&#39;       , &#39;08&#39;,&#10;            &#39;REGISTRATION&#39;            , &#39;09&#39;,&#10;            --REGISTRATION_REVIEW is a child of REGISTRATION&#10;            --DEREGISTRATION is a child of REGISTRATION&#10;            &#39;SUBJECT_ACCESS_REPORT&#39;   , &#39;10&#39;,&#10;            &#39;CONTACT&#39;                 , &#39;11&#39;,&#10;            --CONTACT_ALERT is a child of CONTACT&#10;            &#39;NSI&#39;                     , &#39;12&#39;,&#10;            --NSI_TRANSFER is a child of NSI&#10;            &#39;RESTRICTION&#39;             , &#39;13&#39;,&#10;            &#39;EXCLUSION&#39;               , &#39;14&#39;,&#10;            &#39;EVENT&#39;                   , &#39;15&#39;,&#10;            &#39;OASYS_ASSESSMENT&#39;        , &#39;16&#39;,&#10;            --OASYS_SENTENCE_PLAN is a child of OASYS_ASSESSMENT&#10;            --OASYS_SP_NEED is a child of OASYS_SENTENCE_PLAN&#10;            --OASYS_SP_TEXT is a child of OASYS_SENTENCE_PLAN&#10;            --OASYS_SP_WORK_SUMMARY is a child of OASYS_SENTENCE_PLAN&#10;            &#39;DOCUMENT&#39;                , &#39;17&#39;,&#10;            &#39;MASTER_TRANSFER&#39;         , &#39;18&#39;,&#10;            table_name );&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;    TYPE l_mh_rec_TYP IS RECORD(&#10;      table_name   VARCHAR2(30),&#10;      unique_id    NUMBER,&#10;      extra_date   DATE,&#10;      extra_number NUMBER,&#10;      extra_string VARCHAR2(400) );&#10;    TYPE l_mh_tab_TYP IS TABLE OF l_mh_rec_TYP;&#10;    --&#10;    l_mh_tab     l_mh_tab_TYP :&#61; l_mh_tab_TYP();&#10;    l_mh_tab_ALL l_mh_tab_TYP :&#61; l_mh_tab_TYP();&#10;    --&#10;    TYPE l_L1_off_tab_TYP IS TABLE OF VARCHAR2(30);&#10;    l_L1_off_tab  T_TAB_ORGANISATIONS :&#61; T_TAB_ORGANISATIONS();&#10;    l_L1_off_tab1 T_TAB_ORGANISATIONS :&#61; T_TAB_ORGANISATIONS();&#10;    --&#10;    PROCEDURE msg(p_msg VARCHAR2, p_warn_flag VARCHAR2 DEFAULT &#39;N&#39;) IS&#10;    BEGIN&#10;        --DBMS_OUTPUT.put_line(p_msg);&#10;        procDebug(p_msg);&#10;        IF p_warn_flag &#61; &#39;Y&#39; THEN&#10;            warn(p_msg);&#10;        END IF;&#10;    END msg;&#10;    --&#10;    PROCEDURE do_print_mh_tab IS&#10;    BEGIN&#10;        --&#10;        msg(&#39;SRC offender_id&#61;&#39; || p_origin_offender);&#10;        msg(&#39;TGT offender_id&#61;&#39; || p_target_offender);&#10;        msg(&#39;----------- MERGE OFFENDER (Hier_Level&#61;1) RECORDS LOG -------------&#39;);&#10;        --&#10;        FOR l_i IN 1..l_mh_tab_ALL.COUNT LOOP&#10;            msg(&#39;Record #&#39; || LPAD(l_i, 4) || &#39;: &#39; ||&#10;                PKG_LstUtl.concat(&#10;                    &#39;tab&#61;&#39; || l_mh_tab_ALL(l_i).table_name,&#10;                    &#39;id&#61;&#39;  || l_mh_tab_ALL(l_i).unique_id,&#10;                    PKG_LstUtl.add_prefix(&#39;extra_date&#61;&#39;, l_mh_tab_ALL(l_i).extra_date  ),&#10;                    PKG_LstUtl.add_prefix(&#39;extra_num&#61;&#39; , l_mh_tab_ALL(l_i).extra_number),&#10;                    PKG_LstUtl.add_prefix(&#39;extra_str&#61;&#39; , l_mh_tab_ALL(l_i).extra_string),&#10;                    p_delim&#61;&gt; &#39;, &#39; ), &#39;Y&#39; );&#10;        END LOOP;&#10;        --&#10;    END do_print_mh_tab;&#10;    --&#10;    PROCEDURE do_flush_mh_tab(p_commit_into_db_flag VARCHAR2 DEFAULT &#39;N&#39;) IS&#10;    BEGIN&#10;        FOR l_i IN 1..l_mh_tab.COUNT LOOP&#10;            l_mh_tab_ALL.EXTEND;&#10;            l_mh_tab_ALL(l_mh_tab_ALL.COUNT) :&#61; l_mh_tab(l_i);&#10;            --&#10;            SELECT l_L1_off_tab MULTISET UNION DISTINCT t_tab_ORGANISATIONS(l_mh_tab(l_i).table_name)&#10;            INTO l_L1_off_tab&#10;            FROM dual;&#10;            --&#10;        END LOOP;&#10;        l_mh_tab.DELETE;&#10;        --&#10;        IF p_commit_into_db_flag &#61; &#39;Y&#39; THEN&#10;            FORALL l_i IN 1..l_mh_tab_ALL.COUNT&#10;                INSERT INTO merge_history(&#10;                  merge_history_id,&#10;                  table_name,&#10;                  unique_id,&#10;                  origin_offender_id,&#10;                  target_offender_id,&#10;                  extra_date_id,&#10;                  extra_number_id,&#10;                  extra_string_id&#10;                ) VALUES (&#10;                  merge_history_id_SEQ.NextVal,&#10;                  l_mh_tab_ALL(l_i).table_name,&#10;                  l_mh_tab_ALL(l_i).unique_id,&#10;                  p_origin_offender,&#10;                  p_target_offender,&#10;                  l_mh_tab_ALL(l_i).extra_date,&#10;                  l_mh_tab_ALL(l_i).extra_number,&#10;                  l_mh_tab_ALL(l_i).extra_string&#10;                );&#10;            --&#10;            --IF p_debug_flag &#61; &#39;Y&#39; THEN&#10;                do_print_mh_tab;&#10;            --END IF;&#10;            --&#10;            l_mh_tab_ALL.DELETE;&#10;            --&#10;        END IF;&#10;        --&#10;    END do_flush_mh_tab;&#10;    --&#10;    PROCEDURE do_identify_duplicates IS&#10;    BEGIN&#10;        --&#10;        INSERT INTO merge_duplicates( merge_duplicates_id, table_name, target_offender_id, origin_offender_id, type_table, type_id, duplicates )&#10;        --&#10;        WITH T AS (&#10;          SELECT&#10;            &#39;ALIAS&#39;           AS table_name,&#10;            P_TARGET_offender AS target_off,&#10;            P_ORIGIN_offender AS orig_off,&#10;            NULL              AS ref_item_type,&#10;            NULL              AS ref_item_id,&#10;            COUNT( alias_id ) AS duplicate_count&#10;          FROM alias&#10;          WHERE offender_id &#61; P_TARGET_offender&#10;          GROUP BY&#10;            UPPER(first_name),&#10;            UPPER(surname),&#10;            gender_id&#10;          HAVING COUNT(1) &gt; 1&#10;          --&#10;          UNION ALL&#10;          --&#10;          SELECT &#39;DISABILITY&#39;           AS table_name,&#10;            P_TARGET_offender           AS target_off,&#10;            P_ORIGIN_offender           AS orig_off,&#10;            &#39;R_STANDARD_REFERENCE_LIST&#39; AS ref_item_type,&#10;            disability_type_id          AS ref_item_id,&#10;            COUNT( disability_type_id ) AS duplicate_count&#10;          FROM disability D&#10;          WHERE offender_id &#61; P_TARGET_offender&#10;            AND finish_date IS NULL&#10;            AND (select count(disability_type_id) from DISABILITY where offender_id &#61; d.offender_id and d.disability_type_id &#61; disability_type_id and FINISH_DATE is null) &gt; 1&#10;          GROUP BY&#10;            &#39;DISABILITY&#39;,&#10;            disability_type_id&#10;          HAVING COUNT(1) &gt; 1&#10;          --&#10;          UNION ALL&#10;          --&#10;          SELECT&#10;            &#39;PROVISION&#39;                 AS table_name,&#10;            P_TARGET_offender           AS target_off,&#10;            P_ORIGIN_offender           AS orig_off,&#10;            &#39;R_STANDARD_REFERENCE_LIST&#39; AS ref_item_type,&#10;            provision_type_id           AS ref_item_id,&#10;            COUNT( provision_type_id )  AS duplicate_count&#10;          FROM provision&#10;          WHERE offender_id &#61; P_TARGET_offender&#10;            AND finish_date IS NULL&#10;          GROUP BY provision_type_id&#10;          HAVING COUNT(1) &gt; 1&#10;          --&#10;          UNION ALL&#10;          --&#10;          SELECT&#10;            &#39;PERSONAL_CIRCUMSTANCE&#39;         AS table_name,&#10;            P_TARGET_offender               AS target_off,&#10;            P_ORIGIN_offender               AS orig_off,&#10;            &#39;R_CIRCUMSTANCE_SUB_TYPE&#39;       AS ref_item_type,&#10;            circumstance_sub_type_id        AS ref_item_id,&#10;            COUNT(circumstance_sub_type_id) AS duplicate_count&#10;           FROM personal_circumstance&#10;           WHERE offender_id &#61; P_TARGET_offender&#10;             AND end_date IS NULL&#10;           GROUP BY circumstance_sub_type_id&#10;           HAVING COUNT(1) &gt; 1&#10;           --&#10;           UNION ALL&#10;           --&#10;           SELECT&#10;             &#39;ADDITIONAL_IDENTIFIER&#39;     AS table_name,&#10;             P_TARGET_offender           AS target_off,&#10;             P_ORIGIN_offender           AS orig_off,&#10;             &#39;R_STANDARD_REFERENCE_LIST&#39; AS ref_item_type,&#10;             identifier_name_id          AS ref_item_id,&#10;             COUNT(identifier_name_id)   AS duplicate_count&#10;           FROM additional_identifier&#10;           WHERE offender_id &#61; P_TARGET_offender&#10;           GROUP BY identifier_name_id, identifier&#10;           HAVING COUNT(1) &gt; 1&#10;           --&#10;           UNION ALL&#10;           --&#10;           SELECT&#10;             &#39;REGISTRATION&#39;          AS table_name,&#10;             P_TARGET_offender       AS target_off,&#10;             P_ORIGIN_offender       AS orig_off,&#10;             &#39;R_REGISTER_TYPE&#39;       AS ref_item_type,&#10;             register_type_id        AS ref_item_id,&#10;             COUNT(REGISTER_TYPE_ID) AS duplicate_count&#10;           FROM registration&#10;           WHERE offender_id &#61; P_TARGET_offender&#10;             AND deregistered &#61; 0&#10;           GROUP BY REGISTER_TYPE_ID&#10;           HAVING COUNT(1) &gt; 1&#10;           --&#10;           UNION ALL&#10;           --&#10;           SELECT&#10;             &#39;RESTRICTION&#39;          AS table_name,&#10;             P_TARGET_offender      AS target_off,&#10;             P_ORIGIN_offender      AS orig_off,&#10;             NULL                   AS ref_item_type,&#10;             NULL                   AS ref_item_id,&#10;             COUNT(restriction_id)  AS duplicate_count&#10;           FROM restriction&#10;           WHERE offender_id &#61; P_TARGET_offender&#10;             AND restriction_end_date IS NULL&#10;           GROUP BY&#10;             user_id&#10;           HAVING COUNT(1) &gt; 1&#10;           --&#10;           UNION ALL&#10;           --&#10;           SELECT&#10;             &#39;EXCLUSION&#39;            AS table_name,&#10;             P_TARGET_offender      AS target_off,&#10;             P_ORIGIN_offender      AS orig_off,&#10;             NULL                   AS ref_item_type,&#10;             NULL                   AS ref_item_id,&#10;             COUNT(exclusion_id)    AS duplicate_count&#10;           FROM exclusion&#10;           WHERE offender_id &#61; P_TARGET_offender&#10;             AND exclusion_end_date IS NULL&#10;           GROUP BY&#10;             user_id&#10;           HAVING COUNT(1) &gt; 1&#10;           --&#10;           UNION ALL&#10;           --&#10;           SELECT&#10;             &#39;EVENT&#39;                 AS table_name,&#10;             P_TARGET_offender       AS target_off,&#10;             P_ORIGIN_offender       AS orig_off,&#10;             &#39;R_DISPOSAL_TYPE&#39;       AS ref_item_type,&#10;             disposal_type_id        AS ref_item_id,&#10;             COUNT(disposal_type_id) AS duplicate_count&#10;           FROM&#10;             disposal D&#10;               INNER JOIN event E ON E.event_id &#61; D.event_id&#10;           WHERE E.offender_id &#61; P_TARGET_offender&#10;             AND termination_date IS NULL&#10;           GROUP BY D.disposal_type_id&#10;           HAVING COUNT(1) &gt; 1&#10;           --&#10;        )&#10;        --&#10;        SELECT&#10;          merge_duplicates_id_seq.NEXTVAL,&#10;          table_name,&#10;          target_off,&#10;          orig_off,&#10;          ref_item_type,&#10;          ref_item_id,&#10;          duplicate_count&#10;        FROM T;&#10;        --&#10;    END do_identify_duplicates;&#10;    --&#10;    PROCEDURE do_post_merge_updates&#10;    IS&#10;    BEGIN&#10;        --Update IAPS flags prior to move so only moved records are of interest&#10;        UPDATE iaps_event           SET iaps_flag &#61; 1 WHERE event_id         IN (SELECT event_id         FROM event         WHERE offender_id &#61; p_origin_offender);&#10;        UPDATE iaps_lic_condition   SET iaps_flag &#61; 1 WHERE lic_condition_id IN (SELECT lic_condition_id FROM lic_condition WHERE offender_id &#61; p_origin_offender);&#10;        UPDATE iaps_rqmnt           SET iaps_flag &#61; 1 WHERE rqmnt_id         IN (SELECT rqmnt_id         FROM rqmnt         WHERE offender_id &#61; p_origin_offender);&#10;        UPDATE iaps_contact         SET iaps_flag &#61; 1 WHERE contact_id       IN (SELECT contact_id       FROM contact       WHERE offender_id &#61; p_origin_offender);&#10;        --&#10;        UPDATE offender O SET&#10;          current_restriction &#61; ( SELECT COUNT(1)&#10;                                  FROM restriction&#10;                                  WHERE offender_id &#61; O.offender_id&#10;                                    AND restriction_end_date IS NULL&#10;                                    AND ROWNUM &lt;&#61; 1 ),&#10;          current_exclusion   &#61; ( SELECT COUNT(1)&#10;                                  FROM exclusion&#10;                                  WHERE offender_id &#61; o.offender_id&#10;                                    AND exclusion_end_date IS NULL&#10;                                    AND ROWNUM &lt;&#61; 1 )&#10;        WHERE o.offender_id IN ( p_target_offender, p_origin_offender );&#10;        --&#10;    END do_post_merge_updates;&#10;    --&#10;    PROCEDURE do_merge_table(&#10;        p_table_name        VARCHAR2,&#10;        p_unique_id_fld     VARCHAR2,&#10;        p_extra_date_fld    VARCHAR2,&#10;        p_extra_number_fld  VARCHAR2,&#10;        p_extra_string_fld  VARCHAR2,&#10;        p_where_clause      VARCHAR2 )&#10;    IS&#10;        --&#10;        TYPE l_tab_num_TYP  IS TABLE OF NUMBER;&#10;        TYPE l_tab_char_TYP IS TABLE OF VARCHAR2(100);&#10;        TYPE l_tab_date_TYP IS TABLE OF DATE;&#10;        --&#10;        l_tab_unique_id l_tab_num_TYP;&#10;        l_tab_date      l_tab_date_TYP;&#10;        l_tab_char      l_tab_char_TYP;&#10;        l_tab_num       l_tab_num_TYP;&#10;        --&#10;        --&#10;        PROCEDURE do_upd_documents&#10;        IS&#10;            --&#10;            l_equality_id NUMBER;&#10;            --&#10;            CURSOR csD IS&#10;              WITH D AS (&#10;                SELECT&#10;                  document_id,&#10;                  table_name,&#10;                  primary_key_id,&#10;                  DECODE(table_name, &#39;OFFENDER&#39;, p_target_offender, &#39;EQUALITY&#39;, l_equality_id ) AS tgt_key_id&#10;                FROM document&#10;                WHERE offender_id &#61; p_origin_offender&#10;                  AND table_name IN ( &#39;OFFENDER&#39;, &#39;EQUALITY&#39; )&#10;                )&#10;              --&#10;              SELECT *&#10;              FROM D&#10;              WHERE primary_key_id &lt;&gt; tgt_key_id;&#10;            --&#10;            l_recD csD%ROWTYPE;&#10;            --&#10;        BEGIN&#10;            --&#10;            SELECT equality_id INTO l_equality_id&#10;            FROM equality&#10;            WHERE offender_id &#61; p_target_offender;&#10;            --&#10;            msg(&#39;Move OFFENDER/EQUALITY document for [orig_offender_id&#61;&#39; || p_origin_offender || &#39;]&#39;);&#10;            --&#10;            OPEN csD;&#10;            LOOP&#10;              FETCH csD INTO l_recD;&#10;              EXIT WHEN csD%NOTFOUND;&#10;              --&#10;              msg(&#39;[document_id&#61;&#39; || l_recD.document_id || &#39;][type&#39; || l_recD.table_name || &#39;][new key_id&#61;&#39; || l_recD.tgt_key_id || &#39;]&#39;);&#10;              UPDATE document SET primary_key_id &#61; l_recD.tgt_key_id&#10;              WHERE document_id &#61; l_recD.document_id;&#10;              --&#10;            END LOOP;&#10;            CLOSE csD;&#10;            --&#10;        EXCEPTION WHEN NO_DATA_FOUND THEN&#10;            --&#10;            IF csD%ISOPEN THEN CLOSE csD; END IF;&#10;            --&#10;            raise_application_error(-20001, &#39;ERROR: FAILED to find the EQUALITY record for offender_id&#61;&#39; || p_target_offender);&#10;        END do_upd_documents;&#10;        --&#10;        PROCEDURE do_merge_management_tier&#10;        IS&#10;            --&#10;            CURSOR cs IS&#10;              SELECT DISTINCT *&#10;              FROM management_tier&#10;              WHERE offender_id &#61; p_origin_offender;&#10;            --&#10;            l_tier cs%ROWTYPE;&#10;            l_count NUMBER;&#10;            l_loop_count NUMBER;&#10;            l_loop_date DATE;&#10;            --&#10;        BEGIN&#10;            OPEN cs;&#10;            LOOP&#10;                FETCH cs INTO l_tier;&#10;                EXIT WHEN cs%NOTFOUND;&#10;                --&#10;                l_loop_date :&#61;&#10;                    TO_DATE(&#10;                         PKG_Lookups.funcgetTabRecord(&#10;                             p_table       &#61;&gt; &#39;management_tier&#39;,&#10;                             p_data_fld    &#61;&gt; &#39;TO_CHAR(date_changed + 1/24/60/60, &#39;&#39;YYYYMMDD HH24:MI:SS&#39;&#39;)&#39;,&#10;                             p_default_val &#61;&gt; TO_CHAR(l_tier.date_changed, &#39;YYYYMMDD HH24:MI:SS&#39;),&#10;                             p_ref_col     &#61;&gt; &#39;offender_id&#39;,&#10;                             p_ref_val     &#61;&gt; p_target_offender,&#10;                             p_where       &#61;&gt; &#39;tier_id &#61; :p_tier_id AND date_changed BETWEEN TO_DATE(:p_date_changed, &#39;&#39;YYYYMMDD HH24:MI:SS&#39;&#39;) AND TO_DATE(:p_date_changed, &#39;&#39;YYYYMMDD HH24:MI:SS&#39;&#39;) + 1/24/60/60 * 59&#39;,&#10;                             p_bind_var1   &#61;&gt; l_tier.tier_id,&#10;                             p_bind_var2   &#61;&gt; TO_CHAR(l_tier.date_changed, &#39;YYYYMMDD HH24:MI:SS&#39;),&#10;                             p_bind_var3   &#61;&gt; TO_CHAR(l_tier.date_changed, &#39;YYYYMMDD HH24:MI:SS&#39;),&#10;                             p_order_by    &#61;&gt; &#39;date_changed DESC&#39; ),&#10;                        &#39;YYYYMMDD HH24:MI:SS&#39; );&#10;                --&#10;                UPDATE management_tier SET&#10;                  offender_id  &#61; p_target_offender,&#10;                  date_changed &#61; l_loop_date&#10;                WHERE offender_id &#61; p_origin_offender&#10;                  AND tier_id &#61; l_tier.tier_id&#10;                  AND date_changed &#61; l_tier.date_changed&#10;                RETURNING &#39;MANAGEMENT_TIER&#39;, tier_id, date_changed, NULL, NULL BULK COLLECT INTO l_mh_tab;&#10;                --&#10;                do_flush_mh_tab;&#10;                --&#10;            END LOOP;&#10;            --&#10;            CLOSE cs;&#10;            --&#10;        END do_merge_management_tier;&#10;        --&#10;    BEGIN&#10;        --&#10;        IF p_table_name &#61; &#39;MANAGEMENT_TIER&#39; THEN&#10;            do_merge_management_tier;&#10;        ELSE&#10;            -- DST-8895: Move EQUALITY/OFFENDER type records on DOCUMENT&#10;            IF p_table_name &#61; &#39;DOCUMENT&#39; THEN&#10;                do_upd_documents;&#10;            END IF;&#10;            --&#10;            DECLARE&#10;                TYPE l_rowid_tab_TYP IS TABLE OF ROWID;&#10;                --&#10;                l_rowid_tab l_rowid_tab_TYP;&#10;                l_mh_rec    l_mh_rec_TYP;&#10;                --&#10;                l_SQL CLOB;&#10;                --&#10;            BEGIN&#10;                l_SQL :&#61;&#10;                   &#39;UPDATE &#39; || p_table_name || &#39; SET offender_id &#61; :p_target_offender&#10;                    WHERE offender_id &#61; :p_origin_offender&#10;                    RETURNING &#39; || p_unique_id_fld || &#39;, &#39; || p_extra_date_fld || &#39;, &#39; || p_extra_number_fld || &#39;, &#39; || p_extra_string_fld || &#39;&#10;                    INTO :p_unique_id_fld, :p_extra_date_fld, :p_extra_number_fld, :p_extra_string_fld&#39;;&#10;                --&#10;                EXECUTE IMMEDIATE l_SQL&#10;                USING p_target_offender, p_origin_offender&#10;                RETURNING BULK COLLECT INTO&#10;                  l_tab_unique_id,&#10;                  l_tab_date,&#10;                  l_tab_num,&#10;                  l_tab_char&#10;                ;&#10;                IF UPPER(p_table_name) &#61; &#39;DOCUMENT&#39; THEN&#10;                    msg(&#39;Update DOCUMENT.offender_id&#61;&#39; || p_target_offender);&#10;                    msg(&#39;SQL: &#39; || l_SQL);&#10;                END IF;&#10;                --&#10;                FOR l_idx IN 1..l_tab_unique_id.COUNT LOOP&#10;                    --&#10;                    l_mh_rec.table_name   :&#61; UPPER(p_table_name);&#10;                    l_mh_rec.unique_id    :&#61; l_tab_unique_id(l_idx);&#10;                    l_mh_rec.extra_date   :&#61; l_tab_date(l_idx);&#10;                    l_mh_rec.extra_number :&#61; l_tab_num(l_idx);&#10;                    l_mh_rec.extra_string :&#61; l_tab_char(l_idx);&#10;                    --&#10;                    l_mh_tab.EXTEND;&#10;                    l_mh_tab(l_mh_tab.COUNT) :&#61; l_mh_rec;&#10;                    --&#10;                    IF UPPER(p_table_name) &#61; &#39;DOCUMENT&#39; THEN&#10;                        msg(&#39;document_id&#61;&#39; || l_mh_rec.unique_id);&#10;                    END IF;&#10;                    --&#10;                END LOOP;&#10;                --&#10;            EXCEPTION WHEN OTHERS THEN&#10;                fatal(&#39;ERROR in procMergeOffenders.do_merge_table: &#39; || SQLERRM || CHR(10) ||&#10;                &#39;table&#61;&#39; || p_table_name || CHR(10) ||&#10;                &#39;SQL: &#39; || l_SQL );&#10;            END;&#10;            --&#10;            do_flush_mh_tab;&#10;            --&#10;        END IF;&#10;    END do_merge_table;&#10;    --&#10;BEGIN&#10;    --&#10;    -- Begin merge&#10;    --&#10;    g_procedure_name  :&#61; &#39;procMergeOffenders&#39;;&#10;    g_label           :&#61; &#39;00010&#39;;&#10;    --&#10;    warn(&#39;PKG_MERGE_OFFENDER.procMergeOffenders(&#39; ||&#10;        &#39;NEW&#61;&#39;          || PKG_Common.bool_2_char(NOT l_merge_off_tab_OLD_FLAG) || &#39;, &#39; ||&#10;        &#39;target_off&#61;&#39;   || p_target_offender || &#39;, &#39; ||&#10;        &#39;orig_off&#61;&#39;     || p_origin_offender || &#39;, &#39; ||&#10;        &#39;bg&#61;&#39;           || p_bg_flag         || &#39;, &#39; ||&#10;        &#39;debug&#61;&#39;        || p_debug_flag      || &#39;)&#39;&#10;    );&#10;    --&#10;--    IF l_merge_off_tab_OLD_FLAG THEN&#10;--        procMergeOffenders_OLD(&#10;--            p_target_offender &#61;&gt; p_target_offender,&#10;--            p_origin_offender &#61;&gt; p_origin_offender );&#10;--        --&#10;--        RETURN;&#10;--        --&#10;--    END IF;&#10;    --&#10;    OPEN cs;&#10;    LOOP&#10;        FETCH cs INTO l_rec;&#10;        EXIT WHEN cs%NOTFOUND;&#10;        --&#10;        do_merge_table(&#10;            l_rec.table_name,&#10;            l_rec.unique_id_fld,&#10;            l_rec.extra_date_fld,&#10;            l_rec.extra_number_fld,&#10;            l_rec.extra_string_fld,&#10;            l_rec.where_clause );&#10;    END LOOP;&#10;    CLOSE cs;&#10;    --&#10;    -- Build up the P_EXCLUDE_NODES list&#10;    WITH T AS (&#10;      SELECT column_value AS table_name&#10;      FROM TABLE( l_L1_off_tab ) )&#10;    SELECT table_name BULK COLLECT INTO l_L1_off_tab1&#10;    FROM T&#10;    WHERE NOT EXISTS( SELECT 1 FROM offender_hierarchy T1 WHERE T1.parent_table &#61; T.table_name );&#10;    --&#10;    PKG_TriggerSupport.procRebuildOptTables_ALL(&#10;        p_force_flag              &#61;&gt; &#39;Y&#39;,&#10;        p_offender_id_LST         &#61;&gt; PKG_LstUtl.concat(p_origin_offender, p_target_offender, p_delim&#61;&gt;&#39;,&#39;),&#10;        p_process_alfresco_flag   &#61;&gt; &#39;N&#39;,&#10;        p_update_offender_id_flag &#61;&gt; &#39;Y&#39;,&#10;        p_exclude_nodes_lst       &#61;&gt; PKG_LstUtl.get_array_2_list( l_L1_off_tab1, p_max_len &#61;&gt; 32767, p_iterator_function &#61;&gt; &#39;&#39;&#39;OFFENDER/&#39;&#39; || :p_table_name&#39; ) );&#10;    --&#10;    do_post_merge_updates;&#10;    --&#10;    do_identify_duplicates;&#10;    --&#10;    l_mh_tab.EXTEND;&#10;    l_mh_tab(1).table_name :&#61; &#39;OFFENDER&#39;;&#10;    l_mh_tab(1).unique_id  :&#61; p_origin_offender;&#10;    do_flush_mh_tab( p_commit_into_db_flag&#61;&gt;&#39;Y&#39; );&#10;    --&#10;    IF p_debug_flag &#61; &#39;Y&#39; THEN&#10;        ROLLBACK;&#10;    END IF;&#10;    --&#10;END procMergeOffenders;&#10;--&#10;--&#10;--&#10;PROCEDURE procUnmergeOffenders(&#10;    p_target_offender NUMBER,&#10;    p_origin_offender NUMBER )&#10;IS&#10;BEGIN&#10;&#10;    update alias set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and alias_id in (select alias_id from alias join merge_history on alias_id &#61; unique_id and table_name &#61; &#39;ALIAS&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;ALIAS&#39; and unique_id in (select alias_id from alias where offender_id &#61; p_origin_offender);&#10;&#10;    update OFFENDER_ADDRESS set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and offender_address_id in (select offender_address_id from OFFENDER_ADDRESS join merge_history on offender_address_id &#61; unique_id and table_name &#61; &#39;OFFENDER_ADDRESS&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OFFENDER_ADDRESS&#39; and unique_id in (select OFFENDER_ADDRESS_ID from OFFENDER_ADDRESS where offender_id &#61; p_origin_offender);&#10;&#10;    update DISABILITY set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and disability_id in (select disability_id from DISABILITY join merge_history on disability_id &#61; unique_id and table_name &#61; &#39;DISABILITY&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;DISABILITY&#39; and unique_id in (select DISABILITY_ID from DISABILITY where offender_id &#61; p_origin_offender);&#10;&#10;    update PROVISION set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and provision_id in (select provision_id from PROVISION join merge_history on provision_id &#61; unique_id and table_name &#61; &#39;PROVISION&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;PROVISION&#39; and unique_id in (select PROVISION_ID from PROVISION where offender_id &#61; p_origin_offender);&#10;&#10;    update MANAGEMENT_TIER mt set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender&#10;     and offender_id || &#39;,&#39; || TIER_ID || &#39;,&#39; || to_char(date_changed, &#39;DD.MM.YYYY hh24:mi:ss&#39;) in (select offender_id || &#39;,&#39; || TIER_ID || &#39;,&#39; || to_char(date_changed, &#39;DD.MM.YYYY hh24:mi:ss&#39;) from MANAGEMENT_TIER mt join merge_history mh on mt.date_changed &#61; mh.extra_date_id and mh.unique_id &#61; mt.tier_id and mh.target_offender_id &#61; mt.offender_id and table_name &#61; &#39;MANAGEMENT_TIER&#39; where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender);&#10;    delete from merge_history mh where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;MANAGEMENT_TIER&#39; and p_origin_offender || &#39;,&#39; || unique_id || &#39;,&#39; || to_char(extra_date_id, &#39;DD.MM.YYYY hh24:mi:ss&#39;) in (select offender_id || &#39;,&#39; || TIER_ID || &#39;,&#39; || to_char(date_changed, &#39;DD.MM.YYYY hh24:mi:ss&#39;) from MANAGEMENT_TIER mt where mt.offender_id &#61; p_origin_offender and mt.tier_id &#61; mh.unique_id and mt.date_changed &#61; mh.extra_date_id);&#10;&#10;    update PERSONAL_CIRCUMSTANCE set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and PERSONAL_CIRCUMSTANCE_ID in (select PERSONAL_CIRCUMSTANCE_ID from PERSONAL_CIRCUMSTANCE join merge_history on PERSONAL_CIRCUMSTANCE_ID &#61; unique_id and table_name &#61; &#39;PERSONAL_CIRCUMSTANCE&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;PERSONAL_CIRCUMSTANCE&#39; and unique_id in (select PERSONAL_CIRCUMSTANCE_ID from PERSONAL_CIRCUMSTANCE where offender_id &#61; p_origin_offender);&#10;&#10;    update PERSONAL_CONTACT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and PERSONAL_CONTACT_ID in (select PERSONAL_CONTACT_ID from PERSONAL_CONTACT join merge_history on PERSONAL_CONTACT_ID &#61; unique_id and table_name &#61; &#39;PERSONAL_CONTACT&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;PERSONAL_CONTACT&#39; and unique_id in (select PERSONAL_CONTACT_ID from PERSONAL_CONTACT where offender_id &#61; p_origin_offender);&#10;&#10;    update ADDITIONAL_IDENTIFIER set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and ADDITIONAL_IDENTIFIER_ID in (select ADDITIONAL_IDENTIFIER_ID from ADDITIONAL_IDENTIFIER join merge_history on ADDITIONAL_IDENTIFIER_ID &#61; unique_id and table_name &#61; &#39;ADDITIONAL_IDENTIFIER&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;ADDITIONAL_IDENTIFIER&#39; and unique_id in (select ADDITIONAL_IDENTIFIER_ID from ADDITIONAL_IDENTIFIER where offender_id &#61; p_origin_offender);&#10;&#10;    update OFFENDER_PRISONER mt set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and offender_id || &#39;,&#39; || offender_id || &#39;,&#39; || PRISONER_NUMBER in (select offender_id || &#39;,&#39; || offender_id || &#39;,&#39; || PRISONER_NUMBER from OFFENDER_PRISONER mt join merge_history mh on mt.PRISONER_NUMBER &#61; mh.extra_string_id and mh.unique_id &#61; mt.offender_id and mh.target_offender_id &#61; mt.offender_id and table_name &#61; &#39;OFFENDER_PRISONER&#39; where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender);&#10;    delete from merge_history mh where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OFFENDER_PRISONER&#39; and TARGET_OFFENDER_ID || &#39;,&#39; || ORIGIN_OFFENDER_ID || &#39;,&#39; || EXTRA_STRING_ID in (select p_target_offender || &#39;,&#39; || offender_id || &#39;,&#39; || PRISONER_NUMBER from OFFENDER_PRISONER mt where mt.offender_id &#61; p_origin_offender and mt.PRISONER_NUMBER &#61; mh.extra_string_id);&#10;&#10;    update REGISTRATION set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and REGISTRATION_ID in (select REGISTRATION_ID from REGISTRATION join merge_history on REGISTRATION_ID &#61; unique_id and table_name &#61; &#39;REGISTRATION&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;REGISTRATION&#39; and unique_id in (select REGISTRATION_ID from REGISTRATION where offender_id &#61; p_origin_offender);&#10;&#10;    update REGISTRATION_REVIEW set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and REGISTRATION_REVIEW_ID in (select REGISTRATION_REVIEW_ID from REGISTRATION_REVIEW join merge_history on REGISTRATION_REVIEW_ID &#61; unique_id and table_name &#61; &#39;REGISTRATION_REVIEW&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;REGISTRATION_REVIEW&#39; and unique_id in (select REGISTRATION_REVIEW_ID from REGISTRATION_REVIEW where offender_id &#61; p_origin_offender);&#10;&#10;    update DEREGISTRATION set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and DEREGISTRATION_ID in (select DEREGISTRATION_ID from DEREGISTRATION join merge_history on DEREGISTRATION_ID &#61; unique_id and table_name &#61; &#39;DEREGISTRATION&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;DEREGISTRATION&#39; and unique_id in (select DEREGISTRATION_ID from DEREGISTRATION where offender_id &#61; p_origin_offender);&#10;&#10;    update SUBJECT_ACCESS_REPORT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and SUBJECT_ACCESS_REPORT_ID in (select SUBJECT_ACCESS_REPORT_ID from SUBJECT_ACCESS_REPORT join merge_history on SUBJECT_ACCESS_REPORT_ID &#61; unique_id and table_name &#61; &#39;SUBJECT_ACCESS_REPORT&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;SUBJECT_ACCESS_REPORT&#39; and unique_id in (select SUBJECT_ACCESS_REPORT_ID from SUBJECT_ACCESS_REPORT where offender_id &#61; p_origin_offender);&#10;&#10;    update CONTACT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and CONTACT_ID in (select CONTACT_ID from CONTACT join merge_history on CONTACT_ID &#61; merge_history.unique_id and merge_history.table_name &#61; &#39;CONTACT&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and merge_history.table_name &#61; &#39;CONTACT&#39; and unique_id in (select CONTACT_ID from CONTACT where offender_id &#61; p_origin_offender);&#10;&#10;    update CONTACT_ALERT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and CONTACT_ALERT_ID in (select CONTACT_ALERT_ID from CONTACT_ALERT join merge_history on CONTACT_ALERT_ID &#61; merge_history.unique_id and merge_history.table_name &#61; &#39;CONTACT_ALERT&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;CONTACT_ALERT&#39; and unique_id in (select CONTACT_ALERT_ID from CONTACT_ALERT where offender_id &#61; p_origin_offender);&#10;&#10;&#10;    update NSI set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and NSI_ID in (select NSI_ID from NSI join merge_history on NSI_ID &#61; unique_id and table_name &#61; &#39;NSI&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;NSI&#39; and unique_id in (select NSI_ID from NSI where offender_id &#61; p_origin_offender);&#10;&#10;    update NSI_TRANSFER set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and NSI_TRANSFER_ID in (select NSI_TRANSFER_ID from NSI_TRANSFER join merge_history on NSI_TRANSFER_ID &#61; unique_id and table_name &#61; &#39;NSI_TRANSFER&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;NSI_TRANSFER&#39; and unique_id in (select NSI_TRANSFER_ID from NSI_TRANSFER where offender_id &#61; p_origin_offender);&#10;&#10;&#10;    update RESTRICTION set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and RESTRICTION_ID in (select RESTRICTION_ID from RESTRICTION join merge_history on RESTRICTION_ID &#61; unique_id and table_name &#61; &#39;RESTRICTION&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;RESTRICTION&#39; and unique_id in (select RESTRICTION_ID from RESTRICTION where offender_id &#61; p_origin_offender);&#10;    update OFFENDER o set CURRENT_RESTRICTION &#61; (select count(*) from RESTRICTION where offender_id &#61; o.offender_id and RESTRICTION_END_DATE is null and rownum &lt;&#61; 1) where o.offender_id &#61; p_target_offender;&#10;    update OFFENDER o set CURRENT_RESTRICTION &#61; (select count(*) from RESTRICTION where offender_id &#61; o.offender_id and RESTRICTION_END_DATE is null and rownum &lt;&#61; 1) where o.offender_id &#61; p_origin_offender;&#10;&#10;    update EXCLUSION set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and EXCLUSION_ID in (select EXCLUSION_ID from EXCLUSION join merge_history on EXCLUSION_ID &#61; unique_id and table_name &#61; &#39;EXCLUSION&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;EXCLUSION&#39; and unique_id in (select EXCLUSION_ID from EXCLUSION where offender_id &#61; p_origin_offender);&#10;    update OFFENDER o set CURRENT_EXCLUSION &#61; (select count(*) from EXCLUSION where offender_id &#61; o.offender_id and EXCLUSION_END_DATE is null and rownum &lt;&#61; 1) where o.offender_id &#61; p_target_offender;&#10;    update OFFENDER o set CURRENT_EXCLUSION &#61; (select count(*) from EXCLUSION where offender_id &#61; o.offender_id and EXCLUSION_END_DATE is null and rownum &lt;&#61; 1) where o.offender_id &#61; p_origin_offender;&#10;&#10;    update EVENT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and EVENT_ID in (select EVENT_ID from EVENT join merge_history on EVENT_ID &#61; unique_id and table_name &#61; &#39;EVENT&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;EVENT&#39; and unique_id in (select EVENT_ID from EVENT where offender_id &#61; p_origin_offender);&#10;&#10;    update OASYS_ASSESSMENT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and OASYS_ASSESSMENT_ID in (select OASYS_ASSESSMENT_ID from OASYS_ASSESSMENT join merge_history on OASYS_ASSESSMENT_ID &#61; unique_id and table_name &#61; &#39;OASYS_ASSESSMENT&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OASYS_ASSESSMENT&#39; and unique_id in (select OASYS_ASSESSMENT_ID from OASYS_ASSESSMENT where offender_id &#61; p_origin_offender);&#10;&#10;    update OASYS_SENTENCE_PLAN set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and OASYS_SENTENCE_PLAN_ID in (select OASYS_SENTENCE_PLAN_ID from OASYS_SENTENCE_PLAN join merge_history on OASYS_SENTENCE_PLAN_ID &#61; unique_id and table_name &#61; &#39;OASYS_SENTENCE_PLAN&#39; where origin_offender_id &#61; p_origin_offender);&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OASYS_SENTENCE_PLAN&#39; and unique_id in (select OASYS_SENTENCE_PLAN_ID from OASYS_SENTENCE_PLAN where offender_id &#61; p_origin_offender);&#10;&#10;    update OASYS_SP_NEED mt set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender&#10;     and offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ in (select offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ from OASYS_SP_NEED mt join merge_history mh on mt.LEVEL_ &#61; mh.extra_number_id and mh.unique_id &#61; mt.OASYS_SENTENCE_PLAN_ID and mh.target_offender_id &#61; mt.offender_id where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender);&#10;    delete from merge_history mh where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OASYS_SP_NEED&#39; and p_origin_offender || &#39;,&#39; || unique_id || &#39;,&#39; || extra_number_id in (select offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ from OASYS_SP_NEED mt where mt.offender_id &#61; p_origin_offender and mt.OASYS_SENTENCE_PLAN_ID &#61; mh.unique_id and mt.LEVEL_ &#61; mh.extra_number_id);&#10;&#10;    update OASYS_SP_TEXT mt set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender&#10;     and offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ in (select offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ from OASYS_SP_TEXT mt join merge_history mh on mt.LEVEL_ &#61; mh.extra_number_id and mh.unique_id &#61; mt.OASYS_SENTENCE_PLAN_ID and mh.target_offender_id &#61; mt.offender_id where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender);&#10;    delete from merge_history mh where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OASYS_SP_TEXT&#39; and p_origin_offender || &#39;,&#39; || unique_id || &#39;,&#39; || extra_number_id in (select offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ from OASYS_SP_TEXT mt where mt.offender_id &#61; p_origin_offender and mt.OASYS_SENTENCE_PLAN_ID &#61; mh.unique_id and mt.LEVEL_ &#61; mh.extra_number_id);&#10;&#10;    update OASYS_SP_WORK_SUMMARY mt set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender&#10;     and offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ in (select offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ from OASYS_SP_WORK_SUMMARY mt join merge_history mh on mt.LEVEL_ &#61; mh.extra_number_id and mh.unique_id &#61; mt.OASYS_SENTENCE_PLAN_ID and mh.target_offender_id &#61; mt.offender_id where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender);&#10;    delete from merge_history mh where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OASYS_SP_WORK_SUMMARY&#39; and p_origin_offender || &#39;,&#39; || unique_id || &#39;,&#39; || extra_number_id in (select offender_id || &#39;,&#39; || OASYS_SENTENCE_PLAN_ID || &#39;,&#39; || LEVEL_ from OASYS_SP_WORK_SUMMARY mt where mt.offender_id &#61; p_origin_offender and mt.OASYS_SENTENCE_PLAN_ID &#61; mh.unique_id and mt.LEVEL_ &#61; mh.extra_number_id);&#10;    --&#10;    UPDATE document SET&#10;      primary_key_id &#61; p_origin_offender&#10;    WHERE offender_id &#61; p_target_offender&#10;      AND table_name &#61; &#39;OFFENDER&#39;&#10;      AND DOCUMENT_ID IN (&#10;          SELECT document_id&#10;          FROM&#10;            DOCUMENT&#10;              JOIN merge_history H ON document_id &#61; H.unique_id&#10;                                  AND H.table_name &#61; &#39;DOCUMENT&#39;&#10;          WHERE origin_offender_id &#61; p_origin_offender);&#10;    --&#10;    UPDATE document SET&#10;      primary_key_id &#61; ( SELECT equality_id&#10;                         FROM equality&#10;                         WHERE offender_id &#61; p_origin_offender )&#10;    WHERE offender_id &#61; p_target_offender&#10;      AND table_name &#61; &#39;EQUALITY&#39;&#10;      AND EXISTS(&#10;          SELECT 1&#10;          FROM equality&#10;          WHERE offender_id &#61; p_origin_offender )&#10;      AND DOCUMENT_ID IN (&#10;          SELECT document_id&#10;          FROM&#10;            DOCUMENT&#10;              JOIN merge_history H ON document_id &#61; H.unique_id&#10;                                  AND H.table_name &#61; &#39;DOCUMENT&#39;&#10;          WHERE origin_offender_id &#61; p_origin_offender);&#10;    --&#10;    UPDATE document SET offender_id &#61; p_origin_offender&#10;    WHERE offender_id &#61; p_target_offender&#10;      AND DOCUMENT_ID IN (&#10;          SELECT document_id&#10;          FROM&#10;            DOCUMENT&#10;              JOIN merge_history H ON DOCUMENT_ID &#61; H.unique_id&#10;                                  AND H.table_name &#61; &#39;DOCUMENT&#39;&#10;          WHERE origin_offender_id &#61; p_origin_offender );&#10;    --&#10;    delete from merge_history h where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and h.table_name &#61; &#39;DOCUMENT&#39; and h.unique_id in (select DOCUMENT_ID from DOCUMENT where offender_id &#61; p_origin_offender);&#10;    --&#10;    --&#10;    declare&#10;        CURSOR cs IS select e.* from event e where e.offender_id &#61; p_origin_offender;&#10;        l_event cs%ROWTYPE;&#10;    begin&#10;        OPEN cs;&#10;&#10;        loop&#10;            FETCH cs INTO l_event;&#10;            EXIT WHEN cs%NOTFOUND;&#10;&#10;            update CONTACT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update CONTACT_ALERT CA set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and CONTACT_ID in (select CONTACT_ID from CONTACT where contact_id &#61; CA.contact_id and event_id &#61; l_event.event_id);&#10;            update MAIN_OFFENCE set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update DISPOSAL set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update ADDITIONAL_SENTENCE set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update APPROVED_PREMISES_REFERRAL set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update APPROVED_PREMISES_RESIDENCE set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and APPROVED_PREMISES_REFERRAL_ID in (select APPROVED_PREMISES_REFERRAL_ID from APPROVED_PREMISES_REFERRAL where event_id &#61; l_event.event_id);&#10;            update REFERRAL set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update ASSESSMENT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and REFERRAL_ID in (select REFERRAL_ID from REFERRAL where event_id &#61; l_event.event_id);&#10;            update DRUG_TEST_PROFILE set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update DRUGS_TEST set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update DRUG_TEST_RESULT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and DRUGS_TEST_ID in (select DRUGS_TEST_ID from DRUGS_TEST where event_id &#61; l_event.event_id);&#10;            update COURT_APPEARANCE set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update COURT_REPORT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and COURT_APPEARANCE_ID in (select COURT_APPEARANCE_ID from COURT_APPEARANCE where event_id &#61; l_event.event_id);&#10;            update CUSTODY set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id);&#10;            update CUSTODY_HISTORY set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and CUSTODY_ID in (select CUSTODY_ID from CUSTODY where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id));&#10;            update INSTITUTIONAL_REPORT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and CUSTODY_ID in (select CUSTODY_ID from CUSTODY where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id));&#10;            update INSTITUTIONAL_REPORT_TRANSFER set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and INSTITUTIONAL_REPORT_ID in (select INSTITUTIONAL_REPORT_ID FROM INSTITUTIONAL_REPORT where CUSTODY_ID in (select CUSTODY_ID from CUSTODY where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id)));&#10;            update RELEASE set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and CUSTODY_ID in (select CUSTODY_ID from CUSTODY where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id));&#10;            update RECALL set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and RELEASE_ID in (select RELEASE_ID from RELEASE where CUSTODY_ID in (select CUSTODY_ID from CUSTODY where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id)));&#10;            update LIC_CONDITION set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id);&#10;            update LIC_CONDITION_TRANSFER CA set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and LIC_CONDITION_ID in (select LIC_CONDITION_ID from LIC_CONDITION where LIC_CONDITION_id &#61; CA.LIC_CONDITION_id and DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id));&#10;            update RQMNT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id);&#10;            update RQMNT_TRANSFER CA set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and RQMNT_ID in (select RQMNT_ID from RQMNT where RQMNT_id &#61; CA.RQMNT_id and DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id));&#10;            update UPW_DETAILS set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id);&#10;            update UPW_APPOINTMENT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and UPW_DETAILS_ID in (select UPW_DETAILS_ID from UPW_DETAILS where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id));&#10;            update NSI set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update NSI_TRANSFER CA set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and NSI_ID in (select NSI_ID from NSI where NSI_id &#61; CA.NSI_id and event_id &#61; l_event.event_id);&#10;            update ORDER_TRANSFER set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update COHORT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update COHORT_HISTORY set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;            update PSS_RQMNT set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and CUSTODY_ID in (select CUSTODY_ID from CUSTODY where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id));&#10;            update PSS_RQMNT_TRANSFER CA set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and PSS_RQMNT_ID in (select PSS_RQMNT_ID from PSS_RQMNT where PSS_RQMNT_id &#61; CA.PSS_RQMNT_id and CUSTODY_ID in (select CUSTODY_ID from CUSTODY where DISPOSAL_ID in (select DISPOSAL_ID from DISPOSAL where event_id &#61; l_event.event_id)));&#10;            update CASE_ALLOCATION set offender_id &#61; p_origin_offender where offender_id &#61; p_target_offender and event_id &#61; l_event.event_id;&#10;&#10;&#10;        end loop;&#10;&#10;        close cs;&#10;    end;&#10;&#10;    --Update IAPS flags prior to move so only moved records are of interest&#10;    update IAPS_EVENT set IAPS_FLAG &#61; 1 where event_id in (select event_id from event where offender_id &#61; p_origin_offender);&#10;    update IAPS_LIC_CONDITION set IAPS_FLAG &#61; 1 where lic_condition_id in (select lic_condition_id from lic_condition where offender_id &#61; p_origin_offender);&#10;    update IAPS_RQMNT set IAPS_FLAG &#61; 1 where rqmnt_id in (select rqmnt_id from rqmnt where offender_id &#61; p_origin_offender);&#10;    update IAPS_CONTACT set IAPS_FLAG &#61; 1 where contact_id in (select contact_id from contact where offender_id &#61; p_origin_offender);&#10;&#10;    delete from merge_history where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender and table_name &#61; &#39;OFFENDER&#39;;&#10;&#10;    delete from merge_duplicates where origin_offender_id &#61; p_origin_offender and target_offender_id &#61; p_target_offender;&#10;    --&#10;    --&#10;    PKG_TriggerSupport.procRebuildOptTables_ALL( p_force_flag&#61;&gt;&#39;Y&#39;, p_offender_id_LST&#61;&gt;PKG_LstUtl.concat(p_origin_offender, p_target_offender, p_delim&#61;&gt;&#39;,&#39;) );&#10;    --&#10;END procUnmergeOffenders;&#10;--&#10;--&#10;--&#10;PROCEDURE procIsConcurrentConsecutive(&#10;    p_offender_id           NUMBER,&#10;    p_origin_offender_id    NUMBER,&#10;    p_outcursor             OUT SYS_REFCURSOR )&#10;AS&#10;BEGIN&#10;   OPEN p_outcursor FOR&#10;     select event_id, CONSECUTIVE_TO_EVENT_ID,CONCURRENT_WITH_EVENT_ID from event where offender_id &#61; p_offender_id&#10;     and (CONSECUTIVE_TO_EVENT_ID is not null or CONCURRENT_WITH_EVENT_ID is not null)&#10;     and (&#10;      (event_id not in (select unique_id from merge_history where TABLE_NAME &#61; &#39;EVENT&#39; and origin_offender_id &#61; p_origin_offender_id))&#10;      and (CONSECUTIVE_TO_EVENT_ID is null or CONSECUTIVE_TO_EVENT_ID not in (select unique_id from merge_history where TABLE_NAME &#61; &#39;EVENT&#39; and origin_offender_id &#61; p_origin_offender_id))&#10;      and (CONCURRENT_WITH_EVENT_ID is not null or CONCURRENT_WITH_EVENT_ID not in (select unique_id from merge_history where TABLE_NAME &#61; &#39;EVENT&#39; and origin_offender_id &#61; p_origin_offender_id))&#10;      );&#10;END procIsConcurrentConsecutive;&#10;--&#10;PROCEDURE moveCourtReportDocuments(&#10;    p_courtReportId NUMBER,&#10;    p_srcOffenderId NUMBER,&#10;    p_outcursor     OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;COURT_REPORT&#39; AND primary_key_id &#61; p_courtReportId&#10;      UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;        (&#10;            SELECT contact_id FROM contact c&#10;              INNER JOIN r_contact_type ct&#10;              ON ct.contact_type_id &#61; c.contact_type_id&#10;              INNER JOIN court_report cr&#10;              ON c.offender_id &#61; cr.offender_id&#10;              INNER JOIN court_appearance ca&#10;              ON cr.court_appearance_id &#61; ca.court_appearance_id&#10;              INNER JOIN event e&#10;              ON ca.event_id &#61; e.event_id&#10;              WHERE ct.code &#61; &#39;ECRP&#39;&#10;              AND c.created_datetime &#61; cr.created_datetime&#10;              AND cr.court_report_id &#61; p_courtReportId&#10;        );&#10;END moveCourtReportDocuments;&#10;--&#10;PROCEDURE moveCourtAppearanceDocuments(&#10;    p_courtAppearanceId NUMBER,&#10;    p_srcOffenderId     NUMBER,&#10;    p_outcursor         OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    --&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;COURT_REPORT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT court_report_id FROM court_report where court_appearance_id &#61; p_courtAppearanceId and offender_id &#61; p_srcOffenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;          INNER JOIN r_contact_type ct&#10;          ON ct.contact_type_id &#61; c.contact_type_id&#10;          INNER JOIN court_report cr&#10;          ON c.offender_id &#61; cr.offender_id&#10;          INNER JOIN court_appearance ca&#10;          ON cr.court_appearance_id &#61; ca.court_appearance_id&#10;          WHERE ct.code &#61; &#39;ECRP&#39;&#10;          AND ca.event_id &#61; c.event_id&#10;          AND c.created_datetime &#61; cr.created_datetime&#10;          AND ca.court_appearance_id &#61; p_courtAppearanceId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;          INNER JOIN r_contact_type ct&#10;          ON ct.contact_type_id &#61; c.contact_type_id&#10;          INNER JOIN court_report cr&#10;          ON c.offender_id &#61; cr.offender_id&#10;          INNER JOIN court_appearance ca&#10;          ON cr.court_appearance_id &#61; ca.court_appearance_id&#10;          WHERE ct.code &#61; &#39;EAPP&#39;&#10;          AND ca.event_id &#61; c.event_id&#10;          AND c.created_datetime &#61; cr.created_datetime&#10;          AND ca.court_appearance_id &#61; p_courtAppearanceId&#10;    );&#10;    --&#10;END moveCourtAppearanceDocuments;&#10;--&#10;PROCEDURE moveAPReferralDocuments(&#10;    p_referral_id   NUMBER,&#10;    p_srcOffenderId NUMBER,&#10;    p_outcursor     OUT SYS_REFCURSOR )&#10;IS&#10;    v_event_id approved_premises_referral.event_id%TYPE ;&#10;    v_offender_id approved_premises_referral.offender_id%TYPE ;&#10;    v_created_datetime approved_premises_referral.created_datetime%TYPE;&#10;BEGIN&#10;    --&#10;    SELECT event_id,offender_id,created_datetime&#10;        INTO v_event_id, v_offender_id, v_created_datetime&#10;        FROM approved_premises_referral&#10;        WHERE approved_premises_referral_id &#61; p_referral_id;&#10;&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;APPROVED_PREMISES_REFERRAL&#39; AND primary_key_id &#61; p_referral_id&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;        INNER JOIN r_contact_type ct&#10;        ON ct.contact_type_id &#61; c.contact_type_id&#10;        INNER JOIN approved_premises_referral ap&#10;        ON ap.event_id &#61; c.event_id&#10;        WHERE ct.code &#61; &#39;EAPR&#39;&#10;        AND c.offender_id &#61; v_offender_id&#10;        AND c.event_id &#61; v_event_id&#10;        AND (TRUNC(c.created_datetime) &#61; TRUNC(ap.created_datetime))&#10;        AND c.offender_id &#61; p_srcOffenderId&#10;        AND ap.approved_premises_referral_id &#61; p_referral_id&#10;    )&#10;    UNION&#10;    /* AP Referral Decision Contacts */&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;        INNER JOIN r_contact_type ct&#10;        ON ct.contact_type_id &#61; c.contact_type_id&#10;        INNER JOIN approved_premises_referral ap&#10;        ON ap.event_id &#61; c.event_id&#10;        WHERE ct.code &#61; &#39;EAPE&#39;&#10;        AND c.offender_id &#61; v_offender_id&#10;        AND c.event_id &#61; v_event_id&#10;        AND (TRUNC(c.created_datetime) &#61; TRUNC(ap.created_datetime))&#10;        AND c.offender_id &#61; p_srcOffenderId&#10;        AND ap.approved_premises_referral_id &#61; p_referral_id&#10;    )&#10;    /* AP Referral Non Arrival Contacts */&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;        INNER JOIN r_contact_type ct&#10;        ON ct.contact_type_id &#61; c.contact_type_id&#10;        INNER JOIN approved_premises_referral ap&#10;        ON ap.event_id &#61; c.event_id&#10;        WHERE ct.code &#61; &#39;EAPX&#39;&#10;        AND c.offender_id &#61; v_offender_id&#10;        AND c.event_id &#61; v_event_id&#10;        AND (TRUNC(c.created_datetime) &#61; TRUNC(ap.created_datetime))&#10;        AND c.offender_id &#61; p_srcOffenderId&#10;        AND ap.approved_premises_referral_id &#61; p_referral_id&#10;    )&#10;    /* Residence Records */&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;        INNER JOIN r_contact_type ct&#10;        ON ct.contact_type_id &#61; c.contact_type_id&#10;        INNER JOIN approved_premises_referral ap&#10;        ON ap.event_id &#61; c.event_id&#10;        WHERE ct.code &#61; &#39;EAPA&#39;&#10;        AND c.offender_id &#61; v_offender_id&#10;        AND c.event_id &#61; v_event_id&#10;        AND (TRUNC(c.created_datetime) &#61; TRUNC(ap.created_datetime))&#10;        AND c.offender_id &#61; p_srcOffenderId&#10;        AND ap.approved_premises_referral_id &#61; p_referral_id&#10;    )&#10;    /* AP Referral Admission Contacts */&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;        INNER JOIN r_contact_type ct&#10;        ON ct.contact_type_id &#61; c.contact_type_id&#10;        INNER JOIN approved_premises_referral ap&#10;        ON ap.event_id &#61; c.event_id&#10;        WHERE ct.code &#61; &#39;EAPD&#39;&#10;        AND c.offender_id &#61; v_offender_id&#10;        AND c.event_id &#61; v_event_id&#10;        AND (TRUNC(c.created_datetime) &#61; TRUNC(ap.created_datetime))&#10;        AND c.offender_id &#61; p_srcOffenderId&#10;        AND ap.approved_premises_referral_id &#61; p_referral_id&#10;    )&#10;    UNION&#10;    /* Documents attached to Institutional Reports */&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;        INNER JOIN r_contact_type ct&#10;        ON ct.contact_type_id &#61; c.contact_type_id&#10;        INNER JOIN approved_premises_referral ap&#10;        ON ap.event_id &#61; c.event_id&#10;        WHERE ct.code &#61; &#39;EIRP&#39;&#10;        AND c.offender_id &#61; v_offender_id&#10;        AND c.event_id &#61; v_event_id&#10;        AND (TRUNC(c.created_datetime) &#61; TRUNC(ap.created_datetime))&#10;        AND c.offender_id &#61; p_srcOffenderId&#10;        AND ap.approved_premises_referral_id &#61; p_referral_id&#10;    );&#10;    --&#10;END moveAPReferralDocuments;&#10;--&#10;PROCEDURE moveInstReportDoc (&#10;    p_institutionalReportId NUMBER,&#10;    p_srcOffenderId         NUMBER,&#10;    p_outcursor             OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    --&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;INSTITUTIONAL_REPORT&#39; AND primary_key_id &#61; p_institutionalReportId&#10;    UNION&#10;    /* Documents attached to Institutional Reports */&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c&#10;        INNER JOIN r_contact_type ct&#10;        ON ct.contact_type_id &#61; c.contact_type_id&#10;        INNER JOIN institutional_report ir&#10;        ON ir.offender_id &#61; c.offender_id&#10;        INNER JOIN custody cust&#10;        ON cust.custody_id &#61; ir.custody_id&#10;        INNER JOIN disposal disp&#10;        ON disp.disposal_id &#61; cust.disposal_id&#10;        INNER JOIN event e&#10;        ON disp.event_id &#61; e.event_id&#10;        WHERE ct.code &#61; &#39;EIRP&#39;&#10;        AND ir.institutional_report_id &#61; p_institutionalReportId&#10;        AND c.event_id &#61; e.event_id&#10;        AND c.created_datetime &#61; ir.created_datetime&#10;        AND c.offender_id &#61; e.offender_id&#10;    );&#10;END moveInstReportDoc;&#10;--&#10;PROCEDURE moveNSIDocuments (&#10;    p_nsiId         NUMBER,&#10;    p_srcOffenderId NUMBER,&#10;    p_outcursor     OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c WHERE c.nsi_id &#61; p_nsiId and c.offender_id &#61; p_srcOffenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND primary_key_id &#61; p_nsiId ;&#10;END moveNSIDocuments;&#10;--&#10;PROCEDURE moveSupervisionRequirements (&#10;    p_pssId         NUMBER,&#10;    p_srcOffenderId NUMBER,&#10;    p_outcursor     OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_srcOffenderId AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c WHERE c.pss_rqmnt_id &#61; p_pssId and c.offender_id &#61; p_srcOffenderId&#10;    );&#10;END moveSupervisionRequirements;&#10;--&#10;PROCEDURE moveEventDocuments (&#10;    p_eventId       NUMBER,&#10;    p_srcOffenderId NUMBER,&#10;    p_outcursor     OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;        /* CPS documents attached to the Event - note these are not stored in the document table */&#10;        SELECT&#10;          null,&#10;          D.alfresco_document_id AS cps_alfresco_document_id&#10;        FROM&#10;          event E&#10;            INNER JOIN document D ON D.offender_id &#61; E.offender_id&#10;                                 AND D.table_name &#61; &#39;EVENT&#39;&#10;                                 AND D.primary_key_id &#61; TO_CHAR(E.event_id)&#10;                                 AND D.document_type &#61; &#39;CPS_PACK&#39;&#10;        WHERE E.event_id &#61; p_eventId&#10;        UNION&#10;        /* Documents attached to Events */&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;EVENT&#39; AND primary_key_id &#61; p_eventId&#10;        /* Documents attached to NSIs */&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND primary_key_id IN&#10;        (&#10;            SELECT nsi_id FROM nsi WHERE event_id &#61; p_eventId and offender_id &#61; p_srcOffenderId&#10;        )&#10;        /* Documents attached to Court Reports */&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;COURT_REPORT&#39; AND primary_key_id IN&#10;        (&#10;            SELECT court_report_id FROM court_report cr&#10;              INNER JOIN court_appearance ca&#10;              ON cr.court_appearance_id &#61; ca.court_appearance_id&#10;              WHERE ca.event_id &#61; p_eventId&#10;        )&#10;        /* Documents attached to Institutional Reports */&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;INSTITUTIONAL_REPORT&#39; AND primary_key_id IN&#10;        (&#10;            SELECT institutional_report_id from institutional_report ir&#10;            INNER JOIN custody cust&#10;            ON cust.custody_id &#61; ir.custody_id&#10;            INNER JOIN disposal disp&#10;            ON disp.disposal_id &#61; cust.disposal_id&#10;            INNER JOIN event e&#10;            ON disp.event_id &#61; e.event_id&#10;            AND disp.event_id &#61; p_eventId&#10;        )&#10;        /* Documents attached to Referrals */&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;REFERRAL&#39; AND primary_key_id IN&#10;        (&#10;            SELECT referral_id from referral where event_id &#61; p_eventId&#10;        )&#10;        /* Documents attached to Assessments */&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;ASSESSMENT&#39; AND primary_key_id IN&#10;        (&#10;            SELECT assessment_id from assessment a&#10;            INNER JOIN referral r&#10;            ON a.referral_id &#61; r.referral_id&#10;            WHERE r.event_id &#61; p_eventId&#10;        )&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;APPROVED_PREMISES_REFERRAL&#39; AND primary_key_id IN&#10;        (&#10;            SELECT approved_premises_referral_id FROM approved_premises_referral ap WHERE ap.event_id &#61; p_eventId&#10;        )&#10;        /* Documents attached to Contacts */&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;        (&#10;            SELECT contact_id FROM contact WHERE event_id &#61; p_eventId&#10;        )&#10;        /* Documents attached to Case Allocation */&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CASE_ALLOCATION&#39; AND primary_key_id IN&#10;        (&#10;            SELECT case_allocation_id FROM case_allocation WHERE event_id &#61; p_eventId&#10;        )&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;UPW_APPOINTMENT&#39; AND primary_key_id IN&#10;        (&#10;          SELECT upw_appointment_id FROM upw_appointment UA&#10;          INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;            INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;          WHERE D.event_id &#61; p_eventId&#10;        )&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND primary_key_id IN&#10;        (&#10;          SELECT DISTINCT contact_id FROM upw_appointment UA&#10;          INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;            INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;          WHERE D.event_id &#61; p_eventId&#10;        )&#10;    ;&#10;    --&#10;END moveEventDocuments;&#10;--&#10;PROCEDURE softDeleteEventDocuments(&#10;    p_eventId    NUMBER,&#10;    p_offenderId NUMBER,&#10;    p_softDelete SMALLINT,&#10;    p_outcursor  OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    /* soft delete event documents at the event level */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;EVENT&#39; AND primary_key_id &#61; p_eventId AND offender_id &#61; p_offenderId;&#10;&#10;    /* soft delete CPS documents from the event table */&#10;--    UPDATE event SET cps_soft_deleted &#61; p_softDelete WHERE event_id &#61; p_eventId;&#10;&#10;    /* delete case allocation documents */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CASE_ALLOCATION&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            select case_allocation_id from case_allocation where event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete DRR/generic referrals documents */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;REFERRAL&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT r.referral_id FROM referral r&#10;            WHERE r.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete documents for Drugs Test documents */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;DRUGS_TEST&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT dt.drugs_test_id FROM drugs_test dt&#10;        WHERE dt.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete DRR/generic assessments and attached to referrals */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;ASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT ass.assessment_id FROM assessment ass&#10;            INNER JOIN referral r&#10;                ON ass.referral_id &#61; r.referral_id&#10;            WHERE r.event_id &#61; p_eventId&#10;        UNION&#10;        SELECT ass.assessment_id FROM assessment ass WHERE ass.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete documents for approved premises referral */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;APPROVED_PREMISES_REFERRAL&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT approved_premises_referral_id FROM approved_premises_referral apr where apr.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete documents associated with event level contacts */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT contact_id FROM contact c where c.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete documents associated with NSIs */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT nsi_id FROM NSI nsi where nsi.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete court report document */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;COURT_REPORT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT court_report_id FROM court_report&#10;        INNER JOIN court_appearance ca&#10;            ON court_report.court_appearance_id &#61; ca.court_appearance_id&#10;        INNER JOIN event e&#10;            ON ca.event_id &#61; e.event_id&#10;        WHERE e.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete institutional report document */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;INSTITUTIONAL_REPORT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT institutional_report_id FROM institutional_report report&#10;        INNER JOIN custody custody&#10;            ON custody.custody_id &#61; report.custody_id&#10;        INNER JOIN disposal d&#10;            ON d.disposal_id &#61; custody.disposal_id&#10;        INNER JOIN event e&#10;            ON e.event_id &#61; d.event_id&#10;        WHERE e.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* soft delete UPW Appointment document */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;UPW_APPOINTMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;          SELECT upw_appointment_id FROM upw_appointment UA&#10;          INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;            INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;          WHERE D.event_id &#61; p_eventId&#10;    );&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;          SELECT DISTINCT contact_id FROM upw_appointment UA&#10;          INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;            INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;          WHERE D.event_id &#61; p_eventId&#10;    );&#10;&#10;    /* gather the id of all documents that have been soft deleted and pass them back */&#10;    OPEN p_outcursor FOR&#10;            SELECT&#10;              null,&#10;              D.alfresco_document_id AS cps_alfresco_document_id&#10;            FROM&#10;              event E&#10;                INNER JOIN document D ON D.offender_id &#61; E.offender_id&#10;                                     AND D.table_name &#61; &#39;EVENT&#39;&#10;                                     AND D.primary_key_id &#61; TO_CHAR(E.event_id)&#10;                                     AND D.document_type &#61; &#39;CPS_PACK&#39;&#10;            WHERE E.event_id &#61; p_eventId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CASE_ALLOCATION&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT case_allocation_id from case_allocation WHERE event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;EVENT&#39; AND primary_key_id &#61; p_eventId AND offender_id &#61; p_offenderId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;REFERRAL&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT r.referral_id FROM referral r&#10;            WHERE r.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;ASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT ass.assessment_id FROM assessment ass&#10;            INNER JOIN referral r&#10;                ON ass.referral_id &#61; r.referral_id&#10;            WHERE r.event_id &#61; p_eventId&#10;        UNION&#10;        SELECT ass.assessment_id FROM assessment ass WHERE ass.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;DRUGS_TEST&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;                SELECT dt.drugs_test_id FROM drugs_test dt&#10;                WHERE dt.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;APPROVED_PREMISES_REFERRAL&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;      SELECT approved_premises_referral_id FROM approved_premises_referral apr where apr.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;      SELECT contact_id FROM contact c where c.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;      SELECT nsi_id FROM NSI nsi where nsi.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;COURT_REPORT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT court_report_id FROM court_report&#10;        INNER JOIN court_appearance ca&#10;            ON court_report.court_appearance_id &#61; ca.court_appearance_id&#10;        INNER JOIN event e&#10;            ON ca.event_id &#61; e.event_id&#10;        WHERE e.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;INSTITUTIONAL_REPORT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT institutional_report_id FROM institutional_report report&#10;        INNER JOIN custody custody&#10;            ON custody.custody_id &#61; report.custody_id&#10;        INNER JOIN disposal d&#10;            ON d.disposal_id &#61; custody.disposal_id&#10;        INNER JOIN event e&#10;            ON e.event_id &#61; d.event_id&#10;        WHERE e.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;UPW_APPOINTMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT upw_appointment_id FROM upw_appointment UA&#10;        INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;          INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;        WHERE D.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT DISTINCT contact_id FROM upw_appointment UA&#10;        INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;          INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;        WHERE D.event_id &#61; p_eventId&#10;    )&#10;    ;&#10;    --&#10;END softDeleteEventDocuments;&#10;&#10;PROCEDURE findEventLevelDocuments(&#10;    p_eventId    NUMBER,&#10;    p_offenderId NUMBER,&#10;    p_outcursor  OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;            SELECT&#10;              null,&#10;              D.alfresco_document_id AS cps_alfresco_document_id&#10;            FROM&#10;              event E&#10;                INNER JOIN document D ON D.offender_id &#61; E.offender_id&#10;                                     AND D.table_name &#61; &#39;EVENT&#39;&#10;                                     AND D.primary_key_id &#61; TO_CHAR(E.event_id)&#10;                                     AND D.document_type &#61; &#39;CPS_PACK&#39;&#10;            WHERE E.event_id &#61; p_eventId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CASE_ALLOCATION&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT case_allocation_id from case_allocation WHERE event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;EVENT&#39; AND primary_key_id &#61; p_eventId AND offender_id &#61; p_offenderId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;REFERRAL&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT r.referral_id FROM referral r&#10;            WHERE r.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;ASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT ass.assessment_id FROM assessment ass&#10;            INNER JOIN referral r&#10;                ON ass.referral_id &#61; r.referral_id&#10;            WHERE r.event_id &#61; p_eventId&#10;        UNION&#10;        SELECT ass.assessment_id FROM assessment ass WHERE ass.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;DRUGS_TEST&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT dt.drugs_test_id FROM drugs_test dt&#10;        WHERE dt.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;APPROVED_PREMISES_REFERRAL&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;      SELECT approved_premises_referral_id FROM approved_premises_referral apr where apr.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;      SELECT contact_id FROM contact c where c.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;      SELECT nsi_id FROM NSI nsi where nsi.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;COURT_REPORT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT court_report_id FROM court_report&#10;        INNER JOIN court_appearance ca&#10;            ON court_report.court_appearance_id &#61; ca.court_appearance_id&#10;        INNER JOIN event e&#10;            ON ca.event_id &#61; e.event_id&#10;        WHERE e.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;INSTITUTIONAL_REPORT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT institutional_report_id FROM institutional_report report&#10;        INNER JOIN custody custody&#10;            ON custody.custody_id &#61; report.custody_id&#10;        INNER JOIN disposal d&#10;            ON d.disposal_id &#61; custody.disposal_id&#10;        INNER JOIN event e&#10;            ON e.event_id &#61; d.event_id&#10;        WHERE e.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;UPW_APPOINTMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT upw_appointment_id FROM upw_appointment UA&#10;        INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;          INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;        WHERE D.event_id &#61; p_eventId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT DISTINCT contact_id FROM upw_appointment UA&#10;        INNER JOIN upw_details UD ON UD.upw_details_id &#61; UA.upw_details_id&#10;          INNER JOIN disposal D ON D.disposal_id &#61; UD.disposal_id&#10;        WHERE D.event_id &#61; p_eventId&#10;    )&#10;    ;&#10;    --&#10;END findEventLevelDocuments;&#10;--&#10;PROCEDURE findSentenceDocuments(&#10;    p_componentType  VARCHAR2,&#10;    p_primaryKeyId   NUMBER,&#10;    p_offenderId     NUMBER,&#10;    p_outcursor      OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;       CASE&#10;         WHEN  p_componentType &#61; &#39;REQUIREMENT&#39;&#10;         THEN&#10;            OPEN p_outcursor FOR&#10;            SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;            (&#10;                SELECT contact_id FROM contact c WHERE c.rqmnt_id &#61; p_primaryKeyId&#10;            );&#10;         WHEN  p_componentType &#61; &#39;LICENCECONDITION&#39;&#10;         THEN&#10;            OPEN p_outcursor FOR&#10;            SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;            (&#10;                    SELECT contact_id FROM contact c WHERE c.lic_condition_id &#61; p_primaryKeyId&#10;            );&#10;         WHEN p_componentType IN (&#39;UPWAPPOINTMENT&#39;, &#39;UPW_APPOINTMENT&#39;)&#10;         THEN&#10;            OPEN p_outcursor FOR&#10;            SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;            (&#10;                   SELECT DISTINCT contact_id FROM upw_appointment WHERE upw_appointment_id &#61; p_primaryKeyId&#10;            );&#10;         END CASE;&#10;END findSentenceDocuments;&#10;--&#10;PROCEDURE findPSSDocuments(&#10;    p_primaryKeyId NUMBER,&#10;    p_offenderId   NUMBER,&#10;    p_outcursor    OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;      SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;PSS&#39; AND offender_id &#61; p_offenderId AND primary_key_id &#61; p_primaryKeyId;&#10;END findPSSDocuments;&#10;--&#10;PROCEDURE softDeleteComponentDocuments(&#10;    p_componentType VARCHAR2,&#10;    p_primaryKeyId  NUMBER,&#10;    p_offenderId    NUMBER,&#10;    p_softDelete    SMALLINT,&#10;    p_outcursor     OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;   CASE&#10;     /* soft delete documents associated with a single PSS */&#10;     WHEN  p_componentType &#61; &#39;PSS&#39;&#10;     THEN&#10;        UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT contact_id FROM contact c WHERE c.pss_rqmnt_id &#61; p_primaryKeyId&#10;        );&#10;        OPEN p_outcursor FOR&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;        (&#10;            SELECT contact_id FROM contact c WHERE c.pss_rqmnt_id &#61; p_primaryKeyId&#10;        );&#10;     /* soft delete documents associated with a single Requirement */&#10;     WHEN  p_componentType &#61; &#39;REQUIREMENT&#39;&#10;     THEN&#10;        UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT contact_id FROM contact c WHERE c.rqmnt_id &#61; p_primaryKeyId&#10;        );&#10;        OPEN p_outcursor FOR&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;        (&#10;            SELECT contact_id FROM contact c WHERE c.rqmnt_id &#61; p_primaryKeyId&#10;        );&#10;     /* soft delete documents associated with a single Licence condition */&#10;     WHEN  p_componentType &#61; &#39;LICENCECONDITION&#39;&#10;     THEN&#10;        UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT contact_id FROM contact c WHERE c.lic_condition_id &#61; p_primaryKeyId&#10;        );&#10;        OPEN p_outcursor FOR&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;        (&#10;                SELECT contact_id FROM contact c WHERE c.lic_condition_id &#61; p_primaryKeyId&#10;        );&#10;     /* soft delete address assessment documents */&#10;     WHEN  p_componentType &#61; &#39;ADDRESSASSESSMENT&#39;&#10;     THEN&#10;        UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;ADDRESSASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id &#61; p_primaryKeyId;&#10;        OPEN p_outcursor FOR&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;ADDRESSASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id &#61; p_primaryKeyId;&#10;&#10;     /* NSI */&#10;     WHEN p_componentType &#61; &#39;NSI&#39;&#10;     THEN&#10;     /* soft delete documents associated with NSI directly and documents hanging off NSI contacts */&#10;        UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT contact_id FROM contact c WHERE c.nsi_id &#61; p_primaryKeyId&#10;        );&#10;        UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id &#61; p_primaryKeyId ;&#10;        OPEN p_outcursor FOR&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;        (&#10;                SELECT contact_id FROM contact c WHERE c.nsi_id &#61; p_primaryKeyId&#10;        )&#10;        UNION&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id &#61; p_primaryKeyId;&#10;     /* soft delete address assessment documents */&#10;     WHEN  p_componentType IN ( &#39;UPWAPPOINTMENT&#39;, &#39;UPW_APPOINTMENT&#39; )&#10;     THEN&#10;        UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT DISTINCT contact_id FROM upw_appointment WHERE upw_appointment_id &#61; p_primaryKeyId&#10;        );&#10;        OPEN p_outcursor FOR&#10;        SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;        (&#10;            SELECT DISTINCT contact_id FROM upw_appointment WHERE upw_appointment_id &#61; p_primaryKeyId&#10;        );&#10;   END CASE;&#10;   --&#10;END softDeleteComponentDocuments;&#10;--&#10;PROCEDURE findNsiDocuments(&#10;    p_primaryKeyId NUMBER,&#10;    p_offenderId NUMBER,&#10;    p_outcursor  OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;            SELECT contact_id FROM contact c WHERE c.nsi_id &#61; p_primaryKeyId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id &#61; p_primaryKeyId;&#10;END findNsiDocuments;&#10;--&#10;PROCEDURE findAssessmentDocuments(&#10;    p_primaryKeyId NUMBER,&#10;    p_offenderId   NUMBER,&#10;    p_outcursor    OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;ADDRESSASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id &#61; p_primaryKeyId;&#10;END findAssessmentDocuments;&#10;--&#10;PROCEDURE softDeleteOffenderDocuments(&#10;    p_offenderId NUMBER,&#10;    p_softDelete SMALLINT,&#10;    p_outcursor  OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    /* soft delete offender documents */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;OFFENDER&#39; AND offender_id &#61; p_offenderId;&#10;&#10;    /* address assessment documents */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;ADDRESSASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT address_assessment_id FROM address_assessment WHERE offender_id &#61; p_offenderId&#10;    );&#10;&#10;    /* personal contacts */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;PERSONALCONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;            SELECT personal_contact_id FROM personal_contact WHERE offender_id &#61; p_offenderId&#10;    );&#10;&#10;    /* personal circumstances */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;PERSONAL_CIRCUMSTANCE&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT personal_circumstance_id FROM personal_circumstance WHERE offender_id &#61; p_offenderId&#10;    );&#10;&#10;    /* offender addresses */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;OFFENDER_ADDRESS&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT offender_address_id FROM offender_address WHERE offender_id &#61; p_offenderId&#10;    );&#10;&#10;    /* soft delete documents associated with offender level contacts */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT contact_id FROM contact c where c.offender_id &#61; p_offenderId&#10;    );&#10;&#10;    /* offender level nsi */&#10;    UPDATE document SET soft_deleted &#61; p_softDelete WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN (&#10;        SELECT nsi_id FROM NSI nsi where nsi.offender_id &#61; p_offenderId&#10;    );&#10;&#10;    /* gather the id of all documents that have been soft deleted and pass them back */&#10;    OPEN p_outcursor FOR&#10;    SELECT&#10;      null,&#10;      D.alfresco_document_id AS prev_con_alfresco_document_id&#10;    FROM&#10;      offender O&#10;        INNER JOIN document D ON D.offender_id &#61; O.offender_id&#10;                             AND D.table_name &#61; &#39;OFFENDER&#39;&#10;                             AND D.primary_key_id &#61; TO_CHAR(O.offender_id)&#10;                             AND D.document_type &#61; &#39;PREVIOUS_CONVICTION&#39;&#10;    WHERE O.offender_id &#61; p_offenderId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;OFFENDER&#39; AND offender_id &#61; p_offenderId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;ADDRESSASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT address_assessment_id FROM address_assessment WHERE offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;PERSONALCONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT personal_contact_id FROM personal_contact WHERE offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;PERSONAL_CIRCUMSTANCE&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT personal_circumstance_id FROM personal_circumstance WHERE offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c where c.offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT nsi_id FROM NSI nsi where nsi.offender_id &#61; p_offenderId&#10;    );&#10;END softDeleteOffenderDocuments;&#10;--&#10;PROCEDURE updateDocumentName(&#10;    p_alfrescoDocumentID VARCHAR2,&#10;    p_documentName       VARCHAR2,&#10;    p_outcursor          OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    /* if applicable update offender documents */&#10;    UPDATE document SET document_name &#61; p_documentName WHERE alfresco_document_id &#61; p_alfrescoDocumentID;&#10;&#10;    /*  if applicable update the pre con document name attached to offender table */&#10;--    UPDATE offender SET prev_conviction_document_name &#61; p_documentName WHERE prev_con_alfresco_document_id &#61; p_alfrescoDocumentID;&#10;&#10;    /* if applicable update the cps pack doc name attached to the event table*/&#10;--    UPDATE event SET cps_document_name &#61; p_documentName WHERE cps_alfresco_document_id &#61; p_alfrescoDocumentID;&#10;&#10;    /* gather the id of all documents that have been renamed and pass them back */&#10;    OPEN p_outcursor FOR&#10;    SELECT document_id, alfresco_document_id from document where alfresco_document_id &#61; p_alfrescoDocumentID;&#10;END updateDocumentName;&#10;--&#10;--&#10;--&#10;PROCEDURE findOffenderDocuments(&#10;    p_offenderId NUMBER,&#10;    p_outcursor  OUT SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    OPEN p_outcursor FOR&#10;    SELECT&#10;      null,&#10;      D.alfresco_document_id AS prev_con_alfresco_document_id&#10;    FROM&#10;      offender O&#10;        INNER JOIN document D ON D.offender_id &#61; O.offender_id&#10;                             AND D.table_name &#61; &#39;OFFENDER&#39;&#10;                             AND D.primary_key_id &#61; TO_CHAR(O.offender_id)&#10;                             AND D.document_type &#61; &#39;PREVIOUS_CONVICTION&#39;&#10;    WHERE O.offender_id &#61; p_offenderId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;OFFENDER&#39; AND offender_id &#61; p_offenderId&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;ADDRESSASSESSMENT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT address_assessment_id FROM address_assessment WHERE offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;PERSONALCONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT personal_contact_id FROM personal_contact WHERE offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;PERSONAL_CIRCUMSTANCE&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT personal_circumstance_id FROM personal_circumstance WHERE offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;OFFENDER_ADDRESS&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT offender_address_id FROM offender_address WHERE offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;CONTACT&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT contact_id FROM contact c where c.offender_id &#61; p_offenderId&#10;    )&#10;    UNION&#10;    SELECT document_id, alfresco_document_id FROM document WHERE table_name &#61; &#39;NSI&#39; AND offender_id &#61; p_offenderId AND primary_key_id IN&#10;    (&#10;        SELECT nsi_id FROM NSI nsi where nsi.offender_id &#61; p_offenderId&#10;    );&#10;    --&#10;END findOffenderDocuments;&#10;--&#10;--&#10;BEGIN&#10;--&#10;--&#10;    PKG_Global.do_init;&#10;--&#10;--&#10;END pkg_merge_offender;</textarea>
                        </div>
                    </div>
                </section>
            </div>
            <!-- /.content-wrapper -->
            <footer class="main-footer">
                <div>
                    <div class="pull-right hidden-xs">
                        <a href="https://github.com/schemaspy/schemaspy" title="GitHub for SchemaSpy"><i class="fa fa-github-square fa-2x"></i></a>
                        <a href="http://stackoverflow.com/questions/tagged/schemaspy" title="StackOverflow for SchemaSpy"><i class="fa fa-stack-overflow fa-2x"></i></a>
                    </div>
                    <strong>Generated by <a href="http://schemaspy.org/" class="logo-text"><i class="fa fa-database"></i> SchemaSpy 6.2.4</a></strong>
                </div>
                <!-- /.container -->
            </footer>
        </div>
        <!-- ./wrapper -->

        <!-- jQuery 2.2.3 -->
        <script src="../bower/admin-lte/plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../bower/admin-lte/plugins/jQueryUI/jquery-ui.min.js"></script>
        <!-- Bootstrap 3.3.5 -->
        <script src="../bower/admin-lte/bootstrap/js/bootstrap.min.js"></script>
        <!-- DataTables -->
        <script src="../bower/datatables.net/jquery.dataTables.min.js"></script>
        <script src="../bower/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/dataTables.buttons.min.js"></script>
        <script src="../bower/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.html5.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.print.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.colVis.min.js"></script>
        <!-- SheetJS -->
        <script src="../bower/js-xlsx/xlsx.full.min.js"></script>
        <!-- pdfmake -->
        <script src="../bower/pdfmake/pdfmake.min.js"></script>
        <script src="../bower/pdfmake/vfs_fonts.js"></script>
        <!-- SlimScroll -->
        <script src="../bower/admin-lte/plugins/slimScroll/jquery.slimscroll.min.js"></script>
        <!-- FastClick -->
        <script src="../bower/admin-lte/plugins/fastclick/fastclick.js"></script>
        <!-- Salvattore -->
        <script src="../bower/salvattore/salvattore.min.js"></script>
        <!-- AnchorJS -->
        <script src="../bower/anchor-js/anchor.min.js"></script>
        <!-- CodeMirror -->
        <script src="../bower/codemirror/codemirror.js"></script>
        <script src="../bower/codemirror/sql.js"></script>
        <!-- AdminLTE App -->
        <script src="../bower/admin-lte/dist/js/app.min.js"></script>
        <script src="routine.js"></script>
        <script src="../schemaSpy.js"></script>
    </body>
</html>