<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>TSTNDA.DELIUS_APP_SCHEMA</title>
        <!-- Tell the browser to be responsive to screen width -->
        <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
        <link rel="icon" type="image/png" sizes="16x16" href="../favicon.png">
        <!-- Bootstrap 3.3.5 -->
        <link rel="stylesheet" href="../bower/admin-lte/bootstrap/css/bootstrap.min.css">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="../bower/font-awesome/css/font-awesome.min.css">
        <!-- Ionicons -->
        <link rel="stylesheet" href="../bower/ionicons/css/ionicons.min.css">
        <!-- DataTables -->
        <link rel="stylesheet" href="../bower/datatables.net-bs/css/dataTables.bootstrap.min.css">
        <link rel="stylesheet" href="../bower/datatables.net-buttons-bs/css/buttons.bootstrap.min.css">
        <!-- Code Mirror -->
        <link rel="stylesheet" href="../bower/codemirror/codemirror.css">
        <!-- Fonts -->
        <link href='../fonts/indieflower/indie-flower.css' rel='stylesheet' type='text/css'>
        <link href='../fonts/source-sans-pro/source-sans-pro.css' rel='stylesheet' type='text/css'>

        <!-- Theme style -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/AdminLTE.min.css">
        <!-- Salvattore -->
        <link rel="stylesheet" href="../bower/salvattore/salvattore.css">
        <!-- AdminLTE Skins. Choose a skin from the css/skins
           folder instead of downloading all of them to reduce the load. -->
        <link rel="stylesheet" href="../bower/admin-lte/dist/css/skins/_all-skins.min.css">
        <!-- SchemaSpy -->
        <link rel="stylesheet" href="../schemaSpy.css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="../bower/html5shiv/html5shiv.min.js"></script>
        <script src="../bower/respond/respond.min.js"></script>
        <![endif]-->
    </head>
    <!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->
    <body class="hold-transition skin-blue layout-top-nav">
        <div class="wrapper">
            <header class="main-header">
                <nav class="navbar navbar-static-top">
                    <div class="container">
                        <div class="navbar-header">
                            <a href="../index.html" class="navbar-brand"><b>TSTNDA</b></a><span class="navbar-brand" style="padding-left: 0">.DELIUS_APP_SCHEMA</span>
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"><i class="fa fa-bars"></i></button>
                        </div>

                        <!-- Collect the nav links, forms, and other content for toggling -->
                        <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                            <ul class="nav navbar-nav">
                                <li><a href="../index.html">Tables <span class="sr-only">(current)</span></a></li>
                                <li><a href="../columns.html" title="All of the columns in the schema">Columns</a></li>
                                <li><a href="../constraints.html" title="Useful for diagnosing error messages that just give constraint name or number">Constraints</a></li>
                                <li><a href="../relationships.html" title="Diagram of table relationships">Relationships</a></li>
                                <li><a href="../orphans.html" title="View of tables with neither parents nor children">Orphan&nbsp;Tables</a></li>
                                <li><a href="../anomalies.html" title="Things that might not be quite right">Anomalies</a></li>
                                <li><a href="../routines.html" title="Procedures and functions">Routines</a></li>
                            </ul>
                        </div>
                        <!-- /.navbar-collapse -->
                        <!-- Navbar Right Menu -->
                    </div>
                    <!-- /.container-fluid -->
                </nav>
            </header>
            <!-- Main content -->
            <!-- Full Width Column -->
            <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                <section class="content-header">
                    <h1>DELIUS_APP_SCHEMA.PKG_DPA_DELETION</h1><br />
                </section>
                <!-- Main content -->
                <section class="content">
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
                            <h3 id="Columns" class="box-title">Parameters</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <table id="standard_table" class="table table-bordered table-striped dataTable" role="grid">
                                <thead align='left'>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Mode</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <i class="fa fa-file-code-o"></i>
                            <h3 id="RoutineDefinition" class="box-title">Definition</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                                <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <textarea id="sql-script-codemirror" name="sql-script-codemirror" rows="" style="display: none;">PACKAGE BODY pkg_dpa_deletion&#10;AS&#10;--&#10;--&#10;&#10;g_label             VARCHAR2(30) :&#61; &#39;00000&#39;;&#10;g_debug_print_FLAG  VARCHAR2(1)  :&#61; &#39;N&#39;;&#10;&#10;-- message type&#10;mt_information    CONSTANT NUMBER :&#61; 1;&#10;mt_warning        CONSTANT NUMBER :&#61; 2;&#10;mt_error          CONSTANT NUMBER :&#61; 3;&#10;mt_fatal_error    CONSTANT NUMBER :&#61; 4;&#10;&#10;g_component_code  CONSTANT VARCHAR2(3)  :&#61; &#39;DPA&#39;;&#10;g_package_name    CONSTANT VARCHAR2(30) :&#61; &#39;PKG_DPA_DELETION&#39;;&#10;&#10;--&#10;g_procedure_name  VARCHAR2(30)  :&#61; &#39;initial_value&#39;;&#10;g_pdm             NUMBER;&#10;&#10;&#10;TYPE g_tab_hier_rec_TYP IS RECORD(&#10;  table_name          VARCHAR2(30),&#10;  constraint_name     VARCHAR2(30),&#10;  r_constraint_name   VARCHAR2(30),&#10;  constraint_type     VARCHAR2(3),&#10;  parent_table        VARCHAR2(30),&#10;  --&#10;  FK_fld              VARCHAR2(4000),&#10;  PK_fld              VARCHAR2(4000)&#10;);&#10;TYPE g_tab_hier_tab_TYP IS TABLE OF g_tab_hier_rec_TYP;&#10;--&#10;TYPE g_tab_info_TYP IS TABLE OF g_tab_hier_tab_TYP INDEX BY VARCHAR2(30);&#10;g_tab_info g_tab_info_TYP;&#10;&#10;--&#10;-- GDPR Global Variables&#10;--&#10;g_GDPR_init_flag BOOLEAN :&#61; FALSE;&#10;&#10;g_GDPR_text_rule_TAB ttab_GDPR_text_rule;&#10;g_GDPR_text_rule_expr_1     VARCHAR2(1024);&#10;g_GDPR_text_rule_expr_2     VARCHAR2(1024);&#10;g_GDPR_text_rule_expr_3     VARCHAR2(1024);&#10;g_GDPR_text_rule_expr_adhoc VARCHAR2(1024);&#10;&#10;g_GDPR_tab_info_tab ttab_GDPR_tab_info;&#10;&#10;g_GDPR_search_text_TAB ttab_GDPR_search_text;&#10;&#10;&#10;&#10;&#10;&#10;--&#10;--&#10;--&#10;PROCEDURE set_debug_print_flag(p_flag VARCHAR2) IS&#10;BEGIN&#10;    g_debug_print_FLAG :&#61; UPPER(NVL((CASE WHEN UPPER(p_flag) NOT IN (&#39;Y&#39;, &#39;N&#39;) THEN &#39;N&#39; ELSE p_flag END), &#39;N&#39;));&#10;END set_debug_print_flag;&#10;&#10;FUNCTION get_debug_print_flag RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN NVL(g_debug_print_FLAG, &#39;N&#39;);&#10;END get_debug_print_flag;&#10;&#10;FUNCTION funcgetDebugMode RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Debug.funcgetDebugMode;&#10;END funcgetDebugMode;&#10;&#10;PROCEDURE procDebug(p_msg VARCHAR2, p_debug_print_flag VARCHAR2 DEFAULT &#39;N&#39;) IS&#10;BEGIN&#10;    --&#10;    PKG_Debug.procDebug(SUBSTR(&#39;PKG_DPA_DELETION.&#39; || p_msg, 1, 30000));&#10;    --&#10;    IF g_debug_print_FLAG &#61; &#39;Y&#39; AND p_debug_print_flag &#61; &#39;Y&#39; THEN&#10;        DECLARE&#10;            l_prefix VARCHAR2(1024);&#10;            --&#10;        BEGIN&#10;            l_prefix :&#61;&#10;                TO_CHAR(SYSDATE)                            || &#39; [&#39; ||&#10;                SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;) || &#39;][&#39; ||&#10;                SYS_CONTEXT(&#39;USERENV&#39;, &#39;SID&#39;)               || &#39;][&#39; ||&#10;                PKG_VpdSupport.get_current_scn_number       || &#39;]&#39;;&#10;            --&#10;            DBMS_OUTPUT.put_line(l_prefix || &#39;: &#39; || SUBSTR(p_msg, 1, 32000));&#10;            --&#10;        END;&#10;    END IF;&#10;    --&#10;END procDebug;&#10;--&#10;--&#10;--&#10;--***************************************************&#10;-- PKG_COMMON wrappers                              *&#10;--***************************************************&#10;FUNCTION is_str_empty(p_str VARCHAR2, p_ignore_spaces_and_zeroes VARCHAR2 DEFAULT &#39;N&#39;) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.is_str_empty( p_str, p_ignore_spaces_and_zeroes );&#10;END is_str_empty;&#10;--&#10;FUNCTION empty2null(p_str VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;    RETURN PKG_Common.empty2null(p_str);&#10;END empty2null;&#10;&#10;FUNCTION nvlstr(p_str1 VARCHAR2, p_str2 VARCHAR2) RETURN VARCHAR2 IS&#10;BEGIN&#10;   RETURN PKG_Common.NVLSTR(p_str1 &#61;&gt; p_str1, p_str2 &#61;&gt; p_str2);&#10;END nvlstr;&#10;--&#10;--&#10;PROCEDURE raise_error(&#10;    error_code_in    IN PLS_INTEGER DEFAULT NULL,&#10;    error_message_in IN VARCHAR2 DEFAULT NULL)&#10;IS&#10;    l_error_code    PLS_INTEGER :&#61; NVL(error_code_in, SQLCODE);&#10;    l_error_message VARCHAR2(4000) :&#61; SUBSTR(NVLSTR(error_message_in, SQLERRM), 1, 4000);&#10;BEGIN&#10;    g_procedure_name :&#61; &#39;raise_error&#39;;&#10;    IF l_error_code BETWEEN -20999 AND -20000 THEN&#10;        RAISE_APPLICATION_ERROR (l_error_code, l_error_message);&#10;    ELSIF l_error_code &gt; 0 AND l_error_code NOT IN (1,100) THEN&#10;        RAISE_APPLICATION_ERROR (-20000, l_error_code||&#39; - &#39;||l_error_message);&#10;    ELSIF l_error_code IN (100, -1403) THEN&#10;        RAISE_APPLICATION_ERROR (-20000, l_error_code||&#39; - &#39;||l_error_message);&#10;    ELSIF l_error_code &lt;&gt; 0 THEN&#10;        RAISE_APPLICATION_ERROR(-20000, &#39;INTERNAL ERROR: An unexpected error in PL/SQL&#39;);&#10;    END IF;&#10;END raise_error;&#10;--&#10;--&#10;--***************************************************&#10;-- Helpers                                          *&#10;--***************************************************&#10;--&#10;-- Used to populate mtt_message_log with information type message&#10;PROCEDURE info (message_in VARCHAR2)&#10;IS&#10;BEGIN&#10;    IF SPGConfig.SPGInfoActive THEN&#10;        SPGConfig.insert_message_log(&#10;            message_type_id_in  &#61;&gt; mt_information,&#10;            component_code_in   &#61;&gt; g_component_code,&#10;            package_name_in     &#61;&gt; g_package_name,&#10;            procedure_name_in   &#61;&gt; g_procedure_name,&#10;            label_in            &#61;&gt; g_label,&#10;            message_text_in     &#61;&gt; message_in );&#10;    END IF;&#10;END info;&#10;--&#10;-- Will populate mtt_message_log with warning message - will populate mtt_error_log if result of exception&#10;PROCEDURE warn(message_in VARCHAR2) IS&#10;BEGIN&#10;    IF SPGConfig.SPGWarnActive THEN&#10;        SPGConfig.record_error(&#10;            message_type_id_in    &#61;&gt; mt_warning,&#10;            component_code_in     &#61;&gt; g_component_code,&#10;            package_name_in       &#61;&gt; g_package_name,&#10;            procedure_name_in     &#61;&gt; g_procedure_name,&#10;            label_in              &#61;&gt; g_label,&#10;            message_text_in       &#61;&gt; message_in );&#10;    END IF;&#10;END warn;&#10;--&#10;-- Will populate mtt_message_log with error message and populate mtt_error_log with exception - used for log and continue&#10;PROCEDURE error (message_in VARCHAR2)&#10;IS&#10;BEGIN&#10;    SPGConfig.record_error(&#10;        message_type_id_in    &#61;&gt; mt_error,&#10;        component_code_in     &#61;&gt; g_component_code,&#10;        package_name_in       &#61;&gt; g_package_name,&#10;        procedure_name_in     &#61;&gt; g_procedure_name,&#10;        label_in              &#61;&gt; g_label,&#10;        message_text_in       &#61;&gt; message_in);&#10;END error;&#10;--&#10;-- Will populate mtt_message_log, mtt_error_log with error message and raise exception - used for log and halt&#10;PROCEDURE fatal (message_in VARCHAR2)&#10;IS&#10;BEGIN&#10;    SPGConfig.record_error(&#10;        message_type_id_in    &#61;&gt; mt_fatal_error,&#10;        component_code_in     &#61;&gt; g_component_code,&#10;        package_name_in       &#61;&gt; g_package_name,&#10;        procedure_name_in     &#61;&gt; g_procedure_name,&#10;        label_in              &#61;&gt; g_label,&#10;        message_text_in       &#61;&gt; message_in,&#10;        raise_error_in        &#61;&gt; TRUE );&#10;END fatal;&#10;--&#10;--&#10;PROCEDURE do_set_vpd_ctx(p_user_name IN VARCHAR2, x_user_id IN OUT NUMBeR)&#10;IS&#10;    --&#10;    l_user_name USER_.distinguished_name%TYPE;&#10;    --&#10;BEGIN&#10;    IF TRIM(p_user_name) IS NULL THEN&#10;        l_user_name :&#61; SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;);&#10;    ELSE&#10;        l_user_name :&#61; UPPER(TRIM(p_user_name));&#10;    END IF;&#10;    x_user_id :&#61; PKG_Lookups.GetUserID(l_user_name);&#10;    --&#10;    IF x_user_id IS NOT NULL OR TRIM(SYS_CONTEXT(&#39;USERENV&#39;, &#39;CLIENT_IDENTIFIER&#39;)) IS NULL THEN&#10;        PKG_VPD_CTX.set_client_identifier(userID &#61;&gt; x_user_id);&#10;    END IF;&#10;    --&#10;END do_set_vpd_ctx;&#10;--&#10;--&#10;PROCEDURE P_DEL_current_record(&#10;    p_parent_table    VARCHAR2,&#10;    p_table           VARCHAR2,&#10;    p_offender_id     NUMBER,&#10;    p_parent_row_id   ROWID,&#10;    p_row_id          ROWID,&#10;    p_recursive_level INTEGER )&#10;IS&#10;    --&#10;    l_rows       INTEGER :&#61; 0;&#10;    l_debug_flag BOOLEAN :&#61; PKG_Debug.funcGetDebugActive;&#10;    --&#10;    --l_event_id   NUMBER;&#10;    l_table VARCHAR2(100) :&#61; UPPER(p_table);&#10;    --&#10;BEGIN&#10;    --&#10;    IF l_table &#61; &#39;OFFENDER&#39; THEN&#10;        DELETE FROM SPG_VERSION_ENTRY WHERE offender_id &#61; p_offender_id;&#10;    END IF;&#10;    --&#10;    EXECUTE IMMEDIATE &#39;DELETE FROM &#39; || p_table || &#39; WHERE ROWID &#61; :p_row_id&#39; USING p_row_id;&#10;    l_rows :&#61; SQL%ROWCOUNT;&#10;    --&#10;    IF l_debug_flag THEN&#10;        procDebug(&#10;            &#39;PKG_DPA_DELETION.P_DEL_current_record &#39;  ||&#10;            &#39;[parent_table&#61;&#39;    || p_parent_table    || &#39;]&#39;   ||&#10;            &#39;[table&#61;&#39;           || p_table           || &#39;]&#39;   ||&#10;            &#39;[offender_id&#61;&#39;     || p_offender_id     || &#39;]&#39;   ||&#10;            &#39;[parent_ROWID&#61;&#39;    || p_parent_row_id   || &#39;]&#39;   ||&#10;            &#39;[ROWID&#61;&#39;           || p_row_id          || &#39;]: &#39; ||&#10;            l_rows || CASE WHEN l_rows &#61; 1 THEN &#39; record has been&#39; ELSE &#39; records have been&#39; END || &#39; deleted&#39;,&#10;            --&#10;            p_debug_print_flag &#61;&gt; (CASE WHEN l_rows &#61; 0 THEN g_debug_print_flag ELSE &#39;N&#39; END) );&#10;    END IF;&#10;    --&#10;EXCEPTION WHEN NO_DATA_FOUND THEN&#10;    procDebug(&#10;        &#39;PKG_DPA_DELETION.P_DEL_current_record &#39;  ||&#10;        &#39;[parent_table&#61;&#39;    || p_parent_table    || &#39;]&#39;   ||&#10;        &#39;[table&#61;&#39;           || p_table           || &#39;]&#39;   ||&#10;        &#39;[offender_id&#61;&#39;     || p_offender_id     || &#39;]&#39;   ||&#10;        &#39;[parent_ROWID&#61;&#39;    || p_parent_row_id   || &#39;]&#39;   ||&#10;        &#39;[ROWID&#61;&#39;           || p_row_id          || &#39;]: &#39; ||&#10;        &#39;WARNING: NO_DATA_FOUND&#39;,&#10;        --&#10;        p_debug_print_flag &#61;&gt; (CASE WHEN l_rows &#61; 0 THEN g_debug_print_flag ELSE &#39;N&#39; END) );&#10;END P_DEL_current_record;&#10;--&#10;PROCEDURE P_DEL_REC(&#10;    p_tab_name        VARCHAR2,&#10;    p_row_id          ROWID,&#10;    p_debug_message   VARCHAR2 DEFAULT NULL,&#10;    p_recursive_level INTEGER DEFAULT 1,&#10;    p_dest_schema     VARCHAR2 DEFAULT GC_DEST_SCHEMA,&#10;    p_check_sql       VARCHAR2 DEFAULT NULL )&#10;IS&#10;    --&#10;    l_offender_id NUMBER;&#10;    l_debug_flag  BOOLEAN :&#61; PKG_Debug.funcGetDebugActive;&#10;    --&#10;BEGIN&#10;    --&#10;    IF p_dest_schema &lt;&gt; GC_DEST_SCHEMA THEN&#10;        raise_application_error(-20001, &#39;ERROR in PKG_DPA_DELETION.p_del_rec: P_DEST_SCHEMA parameter must be always set to &#39; || GC_DEST_SCHEMA);&#10;    END IF;&#10;    --p_debug_message   VARCHAR2 DEFAULT NULL,&#10;    --p_recursive_level INTEGER DEFAULT 1,&#10;&#10;    --&#10;    IF p_tab_name &#61; &#39;OFFENDER&#39; THEN&#10;        SELECT offender_id INTO l_offender_id&#10;        FROM offender&#10;        WHERE ROWID &#61; p_row_id;&#10;    ELSE&#10;        l_offender_id :&#61; -1;&#10;    END IF;&#10;    --&#10;    IF l_debug_flag THEN&#10;        procDebug(&#39;PKG_DPA_DELETION.P_DEL_REC: Invoking the PKG_hier_support.offender_records_iterator([tab&#61;&#39; || p_tab_name || &#39;][offender_id&#61;&#39; || l_offender_id || &#39;][row_id&#61;&#39; || p_row_id || &#39;])&#39;);&#10;    END IF;&#10;    --&#10;    PKG_hier_support.offender_records_iterator(&#10;        p_offender_id         &#61;&gt; l_offender_id,&#10;        p_tab_name            &#61;&gt; p_tab_name,&#10;        p_row_id              &#61;&gt; p_row_id,&#10;        p_recursive_level     &#61;&gt; p_recursive_level,&#10;        --&#10;        p_when_to_execute     &#61;&gt; &#39;POST&#39;,&#10;        p_ignore_where_clause &#61;&gt; &#39;Y&#39;,&#10;        --&#10;        p_dyn_SQL             &#61;&gt;&#10;           &#39;DECLARE&#10;                --&#10;                l_parent_table    VARCHAR2(30) :&#61; :p_parent_table;&#10;                l_table           VARCHAR2(30) :&#61; :p_table;&#10;                l_offender_id     NUMBER       :&#61; :p_offender_id;&#10;                l_parent_row_id   ROWID        :&#61; :p_parent_row_id;&#10;                l_row_id          ROWID        :&#61; :p_row_id;&#10;                l_recursive_level INTEGER      :&#61; :p_recursive_level;&#10;                --&#10;            BEGIN&#10;               &#39; || CASE WHEN p_check_sql IS NOT NULL THEN p_check_sql || &#39;(l_parent_table, l_table, l_offender_id, l_parent_row_id, l_row_id, l_recursive_level);&#39; ELSE &#39;--&#39; END || &#39;&#10;                PKG_DPA_DELETION.P_DEL_current_record(&#10;                    p_parent_table    &#61;&gt; l_parent_table,&#10;                    p_table           &#61;&gt; l_table,&#10;                    p_offender_id     &#61;&gt; l_offender_id,&#10;                    p_parent_row_id   &#61;&gt; l_parent_row_id,&#10;                    p_row_id          &#61;&gt; l_row_id,&#10;                    p_recursive_level &#61;&gt; l_recursive_level );&#10;            END;&#39; );&#10;    --&#10;END P_DEL_REC;&#10;--&#10;--&#10;--&#10;&#10;FUNCTION funcFindRegistrations(p_offenderid IN NUMBER) RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_registration_list VARCHAR2(100) :&#61; &#39;&#39;;&#10;    l_current_reg VARCHAR2(30) :&#61; &#39;&#39;;&#10;    l_counter NUMBER :&#61; 0;&#10;    --&#10;    CURSOR l_cur_reg IS&#10;      SELECT DISTINCT (RT.code)&#10;      FROM&#10;        registration R&#10;          INNER JOIN r_register_type RT ON RT.register_type_id &#61; R.register_type_id&#10;      WHERE R.offender_id &#61; p_offenderid&#10;        AND NOT EXISTS ( select 1 from deregistration where registration_id &#61; R.registration_id );&#10;    --&#10;BEGIN&#10;    --&#10;    OPEN l_cur_reg;&#10;    LOOP&#10;        FETCH l_cur_reg into l_current_reg;&#10;        EXIT WHEN l_cur_reg%NOTFOUND;&#10;        --&#10;        IF (l_counter &gt; 0) THEN&#10;            l_registration_list :&#61; SUBSTR(l_registration_list || &#39;, &#39;, 1, 100);&#10;        END IF;&#10;        l_registration_list :&#61; SUBSTR(l_registration_list || l_current_reg, 1, 100);&#10;        l_counter :&#61; l_counter + 1;&#10;    END LOOP;&#10;    CLOSE l_cur_reg;&#10;    --&#10;    RETURN l_registration_list;&#10;    --&#10;EXCEPTION WHEN NO_DATA_FOUND THEN&#10;    RETURN NULL;&#10;END funcFindRegistrations;&#10;--&#10;FUNCTION funcTerminationDate(p_offenderid IN NUMBER) RETURN DATE&#10;IS&#10;    l_termination_date DATE;&#10;BEGIN&#10;    SELECT MAX(D.termination_date) INTO l_termination_date&#10;    FROM&#10;      event E&#10;        INNER JOIN disposal D ON D.event_id &#61; E.event_id&#10;    WHERE E.offender_id &#61; p_offenderid;&#10;    --&#10;    RETURN l_termination_date;&#10;END funcTerminationDate;&#10;--&#10;FUNCTION funcLastContactDate(p_offenderid IN NUMBER) RETURN DATE&#10;IS&#10;    l_contact_date DATE;&#10;BEGIN&#10;    SELECT MAX(contact_date) INTO l_contact_date&#10;    FROM contact&#10;    WHERE offender_id &#61; p_offenderid&#10;      AND contact_date &lt;&#61; SYSDATE;&#10;    --&#10;    RETURN l_contact_date;&#10;END funcLastContactDate;&#10;--&#10;FUNCTION funcLateContactDate(p_offenderid IN NUMBER, p_dpa_period IN NUMBER) RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_late_contact_flag VARCHAR2(1);&#10;    --&#10;BEGIN&#10;    --&#10;    SELECT CASE WHEN COUNT(1) &gt; 0 THEN &#39;Y&#39; ELSE &#39;N&#39; END&#10;    INTO l_late_contact_flag&#10;    FROM&#10;      contact C&#10;        INNER JOIN r_contact_type CT ON CT.contact_type_id &#61; C.contact_type_id&#10;    WHERE C.offender_id &#61; p_offenderid&#10;      AND CT.dpa_exclude &#61; &#39;Y&#39;&#10;      AND C.contact_date &gt;&#61; ADD_MONTHS(SYSDATE, (p_dpa_period * 12) * -1);&#10;    --&#10;    RETURN l_late_contact_flag;&#10;END funcLateContactDate;&#10;--&#10;&#10;--&#10;-- GDPR Subroutines&#10;--&#10;PROCEDURE do_add_GDPR_adhoc_rule(p_code VARCHAR2, p_expr VARCHAR2, p_notes VARCHAR2)&#10;IS&#10;    l_rec trec_GDPR_text_rule;&#10;BEGIN&#10;    --&#10;    l_rec.rule_no          :&#61; p_code;&#10;    l_rec.rule_expr        :&#61; p_expr;&#10;    l_rec.rule_description :&#61; p_notes;&#10;    l_rec.test_flag        :&#61; &#39;Y&#39;;&#10;    --&#10;    g_GDPR_text_rule_TAB.EXTEND;&#10;    g_GDPR_text_rule_TAB(g_GDPR_text_rule_TAB.COUNT) :&#61; l_rec;&#10;    --&#10;    IF g_GDPR_text_rule_expr_adhoc IS NULL THEN&#10;        g_GDPR_text_rule_expr_adhoc :&#61; &#39;(&#39; || p_expr || &#39;)&#39;;&#10;    ELSE&#10;        g_GDPR_text_rule_expr_adhoc :&#61; g_GDPR_text_rule_expr_adhoc || &#39;|(&#39; || p_expr || &#39;)&#39;;&#10;    END IF;&#10;    --&#10;END do_add_GDPR_adhoc_rule;&#10;--&#10;PROCEDURE do_init_GDPR(p_force_flag VARCHAR2 DEFAULT &#39;N&#39;)&#10;IS&#10;    --&#10;    PROCEDURE do_init_GDPR_eval_text&#10;    IS&#10;        --&#10;        PROCEDURE do_add_rule(p_expr_concat IN OUT VARCHAR2, p_code VARCHAR2, p_expr VARCHAR2, p_notes VARCHAR2)&#10;        IS&#10;            l_rec trec_GDPR_text_rule;&#10;        BEGIN&#10;            l_rec.rule_no          :&#61; p_code;&#10;            l_rec.rule_expr        :&#61; p_expr;&#10;            l_rec.rule_description :&#61; p_notes;&#10;            --&#10;            g_GDPR_text_rule_TAB.EXTEND;&#10;            g_GDPR_text_rule_TAB(g_GDPR_text_rule_TAB.COUNT) :&#61; l_rec;&#10;            --&#10;            IF p_expr_concat IS NULL THEN&#10;                p_expr_concat :&#61; &#39;(&#39; || p_expr || &#39;)&#39;;&#10;            ELSE&#10;                p_expr_concat :&#61; p_expr_concat || &#39;|(&#39; || p_expr || &#39;)&#39;;&#10;            END IF;&#10;            --&#10;        END do_add_rule;&#10;        --&#10;    BEGIN&#10;        --&#10;        g_GDPR_text_rule_TAB :&#61; ttab_GDPR_text_rule();&#10;        g_GDPR_text_rule_expr_1     :&#61; NULL;&#10;        g_GDPR_text_rule_expr_2     :&#61; NULL;&#10;        g_GDPR_text_rule_expr_3     :&#61; NULL;&#10;        g_GDPR_text_rule_expr_adhoc :&#61; NULL;&#10;        --&#10;        --Hopefully we could run searches such as:  (&quot;sexual abuse&quot; OR &quot;sex abuse&quot;) AND (child OR children OR youth OR young OR juvenile)&#10;        --&#10;        do_add_rule(g_GDPR_text_rule_expr_1, &#39;01&#39;, &#39;(child|children|young|yung|juvenile|youth|youths) +(sex|sexual) +([a,o]buse|exploitation|exploiting)&#39;, &#39;1a, 1b: &quot;child sexual abuse&quot; OR &quot;child sex abuse&quot; OR &quot;child sexual exploitation&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_1, &#39;02&#39;, &#39;(paedophile|paedophilia)|((sex|sexual) +(offender|ofender))&#39;, &#39;2b, 2b: paedophiles OR paedophilia OR &quot;sex* offenders&quot;&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_1, &#39;03&#39;, &#39;((children&#39;&#39;s|childrens|children) +(homes|home))|((looked|looking) +(after|for) +(children|child|kids))|(adoption|adopted)|(foster +care)&#39;, &#39;3a, 3b, 3c, 3d: &quot;children&#39;&#39;s homes&quot; OR &quot;looked after children&quot; OR adoption OR &quot;foster care&quot;&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_1, &#39;04&#39;, &#39;school|nurser|college|colege&#39;, &#39;4a, 4b, 4c: School* OR nurser* OR college* (looking especially for residential or boarding schools)&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_2, &#39;05&#39;, &#39;(borstal)|((youth|youths|young|yung) +(custody|custodi))|((youth|youths|young|yung) +(offender|ofender) +(institution))|(YOI|Y\.O\.I\.)|((youth|youths|youth|young|yung) +detention +(centre|center))&#39;, &#39;5a, 5b, 5c, 5d, 5e: borstals OR &quot;youth custody&quot; OR &quot;young offender institutions&quot; OR YOI OR &quot;youth detention centre*&quot;&quot;&#39;);&#10;&#10;        do_add_rule(g_GDPR_text_rule_expr_2, &#39;06&#39;, &#39;((uniformed|uniform) +organi[zs]ation)|(voluntary +organi[zs]ation)|(faith +(communities|community))|(religion)&#39;, &#39;6a, 6b, 6c, 6d: &quot;uniformed organisations&quot; OR &quot;voluntary organisations&quot; OR &quot;faith communities&quot; OR religion*&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_2, &#39;07&#39;, &#39;internet|((online|on-line|on +line) +safety)&#39;, &#39;7a, 7b: internet OR &quot;online safety&quot;&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_2, &#39;08&#39;, &#39;safeguarding|((child|children) +protection)|((child|children) +safety)&#39;, &#39;8a, 8b, 8c: safeguarding OR &quot;child protection&quot; OR &quot;child safety&quot;&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_2, &#39;09&#39;, &#39;public +appointment&#39;, &#39;9a: &quot;public appointments&quot;&quot;&#39;);&#10;        --&#10;        do_add_rule(g_GDPR_text_rule_expr_3, &#39;10&#39;, &#39;blood +(donat|contaminat|infect)&#39;, &#39;10a, 10b, 10c: Blood AND (donat* OR contaminat* OR infect*)&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_3, &#39;11&#39;, &#39;blood +product&#39;, &#39;11: &quot;blood products&quot;&quot;&#39;);&#10;        do_add_rule(g_GDPR_text_rule_expr_3, &#39;12&#39;, &#39;(hepatit[iu]s|hephatit[iu]s)|(HIV|H\.I\.V)&#39;, &#39;11a, 11b: Hepatitis OR HIV&quot;&#39;);&#10;        --&#10;    END do_init_GDPR_eval_text;&#10;    --&#10;    PROCEDURE do_init_GDPR_search_text&#10;    IS&#10;        --&#10;        l_rec trec_GDPR_tab_info;&#10;        l_TAB ttab_GDPR_tab_info1;&#10;        --&#10;    BEGIN&#10;        --&#10;        g_GDPR_tab_info_tab.DELETE;&#10;        --&#10;        --WITH T AS ( SELECT table_name FROM TABLE( PKG_DynSQL.get_tab_list ) WHERE table_type &#61; &#39;O&#39; )&#10;        WITH T AS ( SELECT /*+RESULT_CACHE */ &#39;OFFENDER&#39; AS table_name FROM dual UNION SELECT DISTINCT table_name FROM offender_hierarchy )&#10;        SELECT /*+RESULT_CACHE*/&#10;          table_name,&#10;          PKG_Lookups.funcgetTabRecord_CACHED(&#10;              p_table       &#61;&gt; &#39;all_tab_columns&#39;,&#10;              p_data_fld    &#61;&gt; &#39;column_name&#39;,&#10;              p_ref_col     &#61;&gt; &#39;table_name&#39;,&#10;              p_ref_val     &#61;&gt; T.table_name,&#10;              p_where       &#61;&gt; &#39;owner &#61; :p_owner AND data_type IN (&#39;&#39;CLOB&#39;&#39;, &#39;&#39;VARCHAR2&#39;&#39;) AND ( data_type &#61; &#39;&#39;CLOB&#39;&#39; OR data_length &gt; 512 )&#39;,&#10;              p_bind_var1   &#61;&gt; GC_DEST_SCHEMA,&#10;              p_all_records &#61;&gt; &#39;Y&#39;,&#10;              p_delim       &#61;&gt; &#39;,&#39;&#10;          ) AS clob_fld_lst&#10;        BULK COLLECT INTO l_TAB&#10;        FROM T&#10;        WHERE 1&#61;1&#10;          AND EXISTS(&#10;              SELECT 1&#10;              FROM all_tab_columns&#10;              WHERE owner &#61; GC_DEST_SCHEMA&#10;                AND table_name &#61; T.table_name&#10;                AND data_type IN (&#39;CLOB&#39;, &#39;VARCHAR2&#39;)&#10;                AND ( data_type &#61; &#39;CLOB&#39; OR data_length &gt; 512 ) );&#10;        --&#10;        FOR l_idx IN 1..l_TAB.COUNT LOOP&#10;            l_rec :&#61; l_TAB(l_idx);&#10;            g_GDPR_tab_info_tab(l_rec.table_name) :&#61; l_rec;&#10;        END LOOP;&#10;        --&#10;    END do_init_GDPR_search_text;&#10;    --&#10;BEGIN&#10;    --&#10;    IF p_force_flag &#61; &#39;Y&#39; OR (NOT NVL(g_GDPR_init_flag, FALSE)) THEN&#10;        do_init_GDPR_eval_text;&#10;        do_init_GDPR_search_text;&#10;        --&#10;        g_GDPR_init_flag :&#61; TRUE;&#10;    END IF;&#10;    --&#10;END do_init_GDPR;&#10;--&#10;FUNCTION procGetOffenderGDPRTextFldTAB RETURN ttab_GDPR_tab_info1 PIPELINED&#10;IS&#10;    --&#10;    l_key VARCHAR2(30);&#10;    l_rec trec_GDPR_tab_info;&#10;    --&#10;BEGIN&#10;    --&#10;    l_key :&#61; g_GDPR_tab_info_tab.FIRST;&#10;    LOOP&#10;        EXIT WHEN l_key IS NULL;&#10;        --&#10;        l_rec :&#61; g_GDPR_tab_info_tab(l_key);&#10;        PIPE ROW (l_rec);&#10;        --&#10;        l_key :&#61; g_GDPR_tab_info_tab.NEXT(l_key);&#10;    END LOOP;&#10;    --&#10;END procGetOffenderGDPRTextFldTAB;&#10;--&#10;FUNCTION procGetGDPRTextRulesTAB RETURN ttab_GDPR_text_rule PIPELINED&#10;IS&#10;    --&#10;    l_rec trec_GDPR_text_rule;&#10;    --&#10;BEGIN&#10;    FOR l_idx IN 1..g_GDPR_text_rule_TAB.COUNT LOOP&#10;        l_rec :&#61; g_GDPR_text_rule_TAB(l_idx);&#10;        PIPE ROW(l_rec);&#10;    END LOOP;&#10;END procGetGDPRTextRulesTAB;&#10;--&#10;FUNCTION GDPR_eval_text(p_text CLOB, p_debug_flag VARCHAR2 DEFAULT &#39;N&#39;) RETURN VARCHAR2&#10;IS&#10;    --&#10;    l_ret  VARCHAR2(255);&#10;    l_text CLOB;&#10;    --&#10;    l_rec trec_GDPR_text_rule;&#10;    --&#10;BEGIN&#10;    --&#10;    l_text :&#61;&#10;        PKG_Common.empty2null(&#10;            REPLACE(p_text, CHR(9), &#39; &#39;),&#10;            p_remove_line_ret_flag &#61;&gt; &#39;Y&#39;,&#10;            p_replace_CR_with      &#61;&gt; &#39; &#39;,&#10;            p_printable_only_flag  &#61;&gt; &#39;Y&#39;);&#10;    --&#10;    IF p_debug_flag &#61; &#39;Y&#39; THEN&#10;        FOR l_idx IN 1..g_GDPR_text_rule_TAB.COUNT LOOP&#10;            l_rec :&#61; g_GDPR_text_rule_TAB(l_idx);&#10;            l_ret :&#61; PKG_LstUtl.concat( l_ret, ( CASE WHEN REGEXP_LIKE( l_text, l_rec.rule_expr, &#39;i&#39; ) THEN LPAD(l_rec.rule_no, 2, &#39;0&#39;) END ), p_delim&#61;&gt;&#39;,&#39; );&#10;        END LOOP;&#10;    ELSE&#10;        l_ret :&#61;&#10;            CASE&#10;                WHEN REGEXP_LIKE( l_text, g_GDPR_text_rule_expr_1, &#39;i&#39; ) OR&#10;                     REGEXP_LIKE( l_text, g_GDPR_text_rule_expr_2, &#39;i&#39; ) OR&#10;                     REGEXP_LIKE( l_text, g_GDPR_text_rule_expr_3, &#39;i&#39; ) OR&#10;                     ( g_GDPR_text_rule_expr_adhoc IS NOT NULL AND REGEXP_LIKE( l_text, g_GDPR_text_rule_expr_adhoc, &#39;i&#39; ) )&#10;                THEN &#39;Y&#39;&#10;                ELSE &#39;N&#39;&#10;            END;&#10;    END IF;&#10;    --&#10;    RETURN l_ret;&#10;    --&#10;END GDPR_eval_text;&#10;--&#10;PROCEDURE GDPR_search_text_add_line(&#10;    p_recursive_level INTEGER,&#10;    p_table           VARCHAR2,&#10;    p_offender_id     NUMBER,&#10;    p_row_id          ROWID,&#10;    p_parent_table    VARCHAR2,&#10;    p_parent_row_id   ROWID,&#10;    p_debug_flag      VARCHAR2 DEFAULT &#39;N&#39; )&#10;IS&#10;    --&#10;    l_rec trec_GDPR_tab_info;&#10;    --&#10;    l_fld_lst  VARCHAR2(4094);&#10;    l_fld_name VARCHAR2(30);&#10;    --&#10;    l_text     CLOB;&#10;    l_SQL      CLOB;&#10;    --&#10;    l_ret      VARCHAR2(1024);&#10;    --&#10;    --TYPE trec_GDPR_search_text IS RECORD (&#10;    --  offender_id          NUMBER,&#10;    --  table_name           VARCHAR2(30),&#10;    --  table_unique_key     VARCHAR2(100),&#10;    --  row_id               ROWID,&#10;    --  column_name          VARCHAR2(30),&#10;    --  column_value         CLOB,&#10;    --  rules_matched        CLOB );&#10;    --TYPE ttab_GDPR_search_text  IS TABLE OF trec_GDPR_search_text;&#10;    --&#10;    l_res_rec trec_GDPR_search_text;&#10;    --&#10; BEGIN&#10;    --&#10;    IF funcgetDebugMode &gt; 0 THEN&#10;        procDebug(&#39;PKG_DPA_DELETION.GDPR_search_text_add_line &#39; ||&#10;            &#39;[&#39; || p_recursive_level || &#39;]&#39; ||&#10;            &#39;[&#39; || p_table           || &#39;]&#39; ||&#10;            &#39;[&#39; || p_offender_id     || &#39;]&#39; ||&#10;            &#39;[&#39; || p_row_id          || &#39;]&#39; ||&#10;            &#39;[&#39; || p_parent_table    || &#39;]&#39; ||&#10;            &#39;[&#39; || p_parent_row_id   || &#39;]&#39; ||&#10;            &#39;[&#39; || p_debug_flag      || &#39;]&#39; );&#10;    END IF;&#10;    --&#10;    IF g_GDPR_tab_info_tab.EXISTS(p_table) THEN&#10;        --&#10;        l_rec :&#61; g_GDPR_tab_info_tab(p_table);&#10;        l_fld_lst :&#61; l_rec.CLOB_fld_lst;&#10;        --&#10;        LOOP&#10;            l_fld_name :&#61; TRIM(PKG_LstUtl.list_next_elem(l_fld_lst, &#39;,&#39;));&#10;            EXIT WHEN EMPTY2NULL(l_fld_lst) IS NULL AND EMPTY2NULL(l_fld_name) IS NULL ;&#10;            --&#10;            l_res_rec :&#61; NULL;&#10;            --&#10;            l_SQL :&#61; &#39;SELECT &#39; || l_fld_name || &#39;, &#39; || PKG_Lookups.funcGetTabPkFields/*PKG_DynSQL.get_tab_pk_fld_lst*/(p_table, p_delim&#61;&gt;&#39; || &#39;&#39;:&#39;&#39; || &#39;) || &#39; AS unique_key FROM &#39; || p_table || &#39; WHERE ROWID &#61; :p_row_id&#39;;&#10;            EXECUTE IMMEDIATE l_SQL&#10;            INTO l_text, l_res_rec.table_unique_key&#10;            USING p_row_id;&#10;            --&#10;            l_ret :&#61; PKG_DPA_DELETION.GDPR_eval_text(l_text, p_debug_flag&#61;&gt;p_debug_flag);&#10;            --&#10;            IF ( NVL(p_debug_flag, &#39;N&#39;) &#61; &#39;Y&#39; AND l_ret IS NOT NULL ) OR&#10;               ( l_ret &#61; &#39;Y&#39; )&#10;            THEN&#10;                l_res_rec.offender_id   :&#61; p_offender_id;&#10;                l_res_rec.table_name    :&#61; p_table;&#10;                --l_res_rec.table_unique_key :&#61; ;&#10;                l_res_rec.row_id        :&#61; p_row_id;&#10;                l_res_rec.column_name   :&#61; l_fld_name;&#10;                l_res_rec.rules_matched :&#61; CASE WHEN p_debug_flag &#61; &#39;Y&#39; THEN l_ret END;&#10;                l_res_rec.column_val    :&#61; l_text;&#10;                --&#10;                g_GDPR_search_text_TAB.EXTEND;&#10;                g_GDPR_search_text_TAB(g_GDPR_search_text_TAB.COUNT) :&#61; l_res_rec;&#10;                --&#10;            END IF;&#10;            --&#10;        END LOOP;&#10;        --&#10;    END IF;&#10;    --&#10;EXCEPTION WHEN OTHERS THEN&#10;    --&#10;    warn(&#39;ERROR in PKG_DPA_DELETION.GDPR_search_text_add_line &#39; ||&#10;        &#39;[&#39; || p_recursive_level || &#39;]&#39; ||&#10;        &#39;[&#39; || p_table           || &#39;]&#39; ||&#10;        &#39;[&#39; || p_offender_id     || &#39;]&#39; ||&#10;        &#39;[&#39; || p_row_id          || &#39;]&#39; ||&#10;        &#39;[&#39; || p_parent_table    || &#39;]&#39; ||&#10;        &#39;[&#39; || p_parent_row_id   || &#39;]&#39; ||&#10;        &#39;[&#39; || p_debug_flag      || &#39;]:&#39; || CHR(10) ||&#10;        SQLERRM || CHR(10) ||&#10;        l_SQL );&#10;    --&#10;    RAISE;&#10;    --&#10;END GDPR_search_text_add_line;&#10;--&#10;FUNCTION procSearchOffenderGDPRTextTAB(&#10;    p_offender_id            NUMBER,&#10;    p_text_eval_details_flag VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_last_run_flag          VARCHAR2 DEFAULT &#39;N&#39; )&#10;RETURN ttab_GDPR_search_text PIPELINED&#10;IS&#10;    --&#10;    l_rec trec_GDPR_search_text;&#10;    --&#10;    l_user_id NUMBER;&#10;    --&#10;    l_row_id ROWID;&#10;    l_crn    OFFENDER.crn%TYPE;&#10;    --&#10;BEGIN&#10;    --&#10;    IF p_last_run_flag &#61; &#39;Y&#39; THEN&#10;        FOR l_idx IN 1..g_GDPR_search_text_TAB.COUNT LOOP&#10;            --&#10;            l_rec :&#61; g_GDPR_search_text_TAB(l_idx);&#10;            --&#10;--            IF NVL(p_text_eval_details_flag, &#39;N&#39;) &#61; &#39;Y&#39; THEN&#10;--                l_rec.rules_matched :&#61; PKG_DPA_DELETION.GDPR_eval_text(l_rec.column_val, p_debug_flag&#61;&gt;&#39;Y&#39;);&#10;--            END IF;&#10;--            --&#10;--            IF NOT (NVL(p_text_eval_details_flag, &#39;N&#39;) &#61; &#39;Y&#39;) THEN&#10;--                l_rec.column_val :&#61; NULL;&#10;--            END IF;&#10;            PIPE ROW (l_rec);&#10;        END LOOP;&#10;        --&#10;        RETURN;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;00400&#39;;&#10;    do_set_vpd_ctx(NULL, l_user_id);&#10;    IF l_user_id IS NULL THEN&#10;        g_label :&#61; &#39;00410&#39;;&#10;        do_set_vpd_ctx(&#39;GDPR_USER&#39;, l_user_id);&#10;    END IF;&#10;    --&#10;    g_GDPR_search_text_TAB :&#61; ttab_GDPR_search_text();&#10;    --&#10;    SELECT ROWID, crn INTO l_row_id, l_crn&#10;    FROM offender&#10;    WHERE offender_id &#61; p_offender_id;&#10;    --&#10;    PKG_hier_support.offender_records_iterator(&#10;        p_row_id          &#61;&gt; l_row_id,&#10;        p_offender_id     &#61;&gt; p_offender_id,&#10;        p_tab_name        &#61;&gt; &#39;OFFENDER&#39;,&#10;        p_when_to_execute &#61;&gt; &#39;PRE&#39;,&#10;        p_dyn_SQL         &#61;&gt;&#10;--EXECUTE IMMEDIATE l_SQL USING p_parent_table, p_dest_table, p_offender_id, p_parent_row_id, p_row_id, p_recursive_level;&#10;&#39;DECLARE&#10;    --&#10;    l_parent_table    VARCHAR2(30) :&#61; :p_parent_table;&#10;    l_table           VARCHAR2(30) :&#61; :p_table;&#10;    l_offender_id     NUMBER       :&#61; :p_offender_id;&#10;    l_parent_row_id   ROWID        :&#61; :p_parent_row_id;&#10;    l_row_id          ROWID        :&#61; :p_row_id;&#10;    l_recursive_level NUMBER       :&#61; :p_recursive_level;&#10;    --&#10;BEGIN&#10;    PKG_DPA_DELETION.GDPR_search_text_add_line(&#10;        p_recursive_level &#61;&gt; l_recursive_level,&#10;        p_table           &#61;&gt; l_table,&#10;        p_row_id          &#61;&gt; l_row_id,&#10;        p_parent_table    &#61;&gt; l_parent_table,&#10;        p_parent_row_id   &#61;&gt; l_parent_row_id,&#10;        p_offender_id     &#61;&gt; l_offender_id );&#10;END;&#39;,&#10;--&#10;        p_skip_subtrees &#61;&gt;&#10;          &#39;OFFENDER/MOST_RECENTLY_VIEWED_OFFENDERS, &#39;                                                   ||&#10;          &#39;OFFENDER/ORGANISATION_OFFENDER, OFFENDER/CASELOAD, OFFENDER/COHORT_DIARY, &#39;                  ||&#10;          &#39;OFFENDER/SPG_NOTIFICATION, OFFENDER/SPG_VERSION_ENTRY, OFFENDER/OFFENDER_CRC_EXPORT, &#39;       ||&#10;          --&#10;          &#39;OFFENDER_MANAGER/CONTACT_ALERT, &#39;                                                            ||&#10;          --&#10;          &#39;CONTACT/DEREGISTRATION, CONTACT/ENFORCEMENTxxx, CONTACT/OASYS_ASSESSMENT, &#39;                  ||&#10;          &#39;CONTACT/REGISTRATION, CONTACT/REGISTRATION_REVIEW, CONTACT/SUBJECT_ACCESS_REPORT_CONTACT, &#39;  ||&#10;          &#39;CONTACT/UPW_APPOINTMENT, UPW_APPOINTMENT/ENFORCEMENTxxx, &#39;                                   ||&#10;          --&#10;          &#39;CONTACT_ALERT/*, &#39;                                                                           ||&#10;          --&#10;          &#39;OFFENDER_TRANSFER/*, NSI_TRANSFER/*, RQMNT_TRANSFER/*, LIC_CONDITION_TRANSFER/*, &#39;           ||&#10;          &#39;PSS_RQMNT_TRANSFER/*, NSI_TRANSFER/*, &#39;                                                      ||&#10;          &#39;COURT_REPORT_TRANSFER/*, INSTITUTIONAL_REPORT_TRANSFER/*, &#39;                                  ||&#10;          --&#10;          &#39;*/OFFENDER_CRC_EXPORT, &#39;                                                                     ||&#10;          &#39;*/OFFENDER_MERGE_DETAILS, */OFFENDER_MERGE_DETAILS_HIST, &#39;                                   ||&#10;          --&#10;          &#39;*/ORGANISATION_OFFENDER, */CASELOAD, */COHORT_DIARY, &#39;                                       ||&#10;          --&#10;          &#39;*/SPG_NOTIFICATION, */SPG_INBOUND_INDEX, &#39;                                                   ||&#10;          &#39;*/SPG_VERSION_ENTRY, */SPG_NATIONAL_PK_ENTRY, &#39;                                              ||&#10;          --&#10;          &#39;*/SPG_EXCEPTION, */SPG_INBOUND_MESSAGE, &#39;                                                    ||&#10;          &#39;*/SPG_ENTITY_REFRESH, */SPG_GET_CONTACT_REQUEST, */SPG_DOCUMENT_REQUEST, &#39;                   ||&#10;          &#39;*/DSS_SEARCH_REQUEST, */DSS_SEARCH_OFFENDER, &#39;                                               ||&#10;          &#39;*/SPG_SEARCH_REQUEST, */SPG_SEARCH_OFFENDER, &#39;                                               ||&#10;          &#39;*/SPG_SEARCH_CIRC, */SPG_SEARCH_EVENT, */SPG_SEARCH_OFFENDER, */SPG_SEARCH_REGN, &#39;           ||&#10;          &#39;*/SPG_SEARCH_CONTACT_REQUEST, &#39;                                                              ||&#10;          --&#10;          &#39;*/TASK, &#39;                                                                                    ||&#10;          --&#10;          &#39;*/MOST_RECENTLY_VIEWED_OFFENDERS, &#39;                                                          ||&#10;          &#39;*/MERGE_HISTORY, */MERGE_DUPLICATES, */MERGE_OFFENDER_VALUES, &#39;                              ||&#10;--          &#39;*/OASYS_ASSMNT_SECTION_SCORE, */OASYS_SP_NEED, */OASYS_SP_TEXT, */OASYS_SP_WORK_SUMMARY, &#39;   ||&#10;          &#39;&#39;&#10;    );&#10;    --&#10;    FOR l_idx IN 1..g_GDPR_search_text_TAB.COUNT LOOP&#10;        --&#10;        l_rec :&#61; g_GDPR_search_text_TAB(l_idx);&#10;        --&#10;        IF NVL(p_text_eval_details_flag, &#39;N&#39;) &#61; &#39;Y&#39; THEN&#10;            l_rec.rules_matched :&#61; PKG_DPA_DELETION.GDPR_eval_text(l_rec.column_val, p_debug_flag&#61;&gt;&#39;Y&#39;);&#10;        END IF;&#10;        --&#10;        IF NOT (NVL(p_text_eval_details_flag, &#39;N&#39;) &#61; &#39;Y&#39;) THEN&#10;            l_rec.column_val :&#61; NULL;&#10;        END IF;&#10;        PIPE ROW (l_rec);&#10;    END LOOP;&#10;    --&#10;END procSearchOffenderGDPRTextTAB;&#10;--&#10;PROCEDURE procSearchOffenderGDPRText(&#10;    p_offender_id            NUMBER,&#10;    p_text_eval_details_flag VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_last_run_flag          VARCHAR2 DEFAULT &#39;N&#39;,&#10;    p_outcursor         OUT  SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    --&#10;    OPEN p_outcursor FOR&#10;      SELECT&#10;        /*00*/ offender_id,&#10;        /*01*/ table_name,&#10;        /*02*/ table_unique_key,&#10;        /*03*/ row_id,&#10;        /*04*/ column_name,&#10;        /*05*/ column_val,&#10;        /*06*/ rules_matched&#10;      FROM&#10;        TABLE( PKG_DPA_DELETION.procSearchOffenderGDPRTextTAB(&#10;                   p_offender_id            &#61;&gt; p_offender_id,&#10;                   p_text_eval_details_flag &#61;&gt; NVL(p_text_eval_details_flag, &#39;N&#39;),&#10;                   p_last_run_flag          &#61;&gt; NVL(p_last_run_flag, &#39;N&#39;) )&#10;             );&#10;    --&#10;END procSearchOffenderGDPRText;&#10;--&#10;FUNCTION get_latest_OM(p_offender_id NUMBER, p_ret_type VARCHAR2 DEFAULT &#39;OM&#39;) RETURN NUMBER&#10;IS&#10;    --&#10;--    CURSOR cs1 IS&#10;--      SELECT offender_manager_id, probation_area_id&#10;--      FROM offender_manager&#10;--      WHERE offender_id &#61; p_offender_id&#10;--        AND active_flag &#61; 1&#10;--        AND soft_deleted &#61; 0;&#10;    --&#10;    CURSOR cs IS&#10;      SELECT offender_manager_id, probation_area_id&#10;      FROM offender_manager&#10;      WHERE offender_id &#61; p_offender_id&#10;        --AND active_flag &#61; DECODE(soft_deleted, 1, active_flag, 0)&#10;      ORDER BY&#10;        soft_deleted,&#10;        active_flag DESC,&#10;        allocation_date DESC,&#10;        created_datetime DESC,&#10;        offender_manager_id DESC;&#10;    --&#10;    l_rec cs%ROWTYPE;&#10;    --&#10;--    l_found_flag BOOLEAN;&#10;    --&#10;BEGIN&#10;    --&#10;--    OPEN cs1;&#10;--    FETCH cs1 INTO l_rec;&#10;--    l_found_flag :&#61; cs1%FOUND;&#10;--    CLOSE cs1;&#10;--    --&#10;--    IF NOT l_found_flag THEN&#10;        --&#10;        OPEN cs;&#10;        FETCH cs INTO l_rec;&#10;        CLOSE cs;&#10;        --&#10;--    END IF;&#10;    --&#10;    RETURN&#10;        CASE WHEN p_ret_type &#61; &#39;PA&#39; THEN&#10;            l_rec.probation_area_id&#10;        ELSE&#10;            l_rec.offender_manager_id&#10;        END;&#10;    --&#10;END get_latest_OM;&#10;--&#10;FUNCTION procFindGDPROffendersTAB(&#10;    /*01*/ p_probation_area_id      NUMBER   DEFAULT NULL,&#10;    /*02*/ p_borough_id             NUMBER   DEFAULT NULL,&#10;    /*03*/ p_district_id            NUMBER   DEFAULT NULL,&#10;    /*04*/ p_trust_provider_flag    SMALLINT DEFAULT 0,&#10;    /*05*/ p_trust_provider_team_id NUMBER   DEFAULT NULL,&#10;    /*06*/ p_staff_employee_id      NUMBER   DEFAULT NULL,&#10;    /*07*/ p_offender_id            NUMBER   DEFAULT NULL,&#10;    /*08*/ p_register_type_lst      VARCHAR2 DEFAULT NULL,&#10;    /*09*/ p_offence_type_lst       VARCHAR2 DEFAULT NULL,&#10;    /*10*/ p_max_rows               INTEGER  DEFAULT 100000,&#10;    /*11*/ p_page_size              INTEGER  DEFAULT -1,&#10;    /*12*/ p_page_num               INTEGER  DEFAULT -1,&#10;    /*13*/ p_eligible_years         INTEGER  DEFAULT -1 )&#10;RETURN ttab_GDPR_offender PIPELINED&#10;IS&#10;    --&#10;    TYPE l_cur_TYP IS REF CURSOR;&#10;    l_cur l_cur_TYP;&#10;    l_SQL VARCHAR2(10000);&#10;    --&#10;    l_rec trec_GDPR_offender;&#10;    l_tab ttab_GDPR_offender;&#10;    --&#10;    l_user_id NUMBER;&#10;    --&#10;    l_row INTEGER :&#61; 0;&#10;    l_i   INTEGER;&#10;    --&#10;    l_page_number INTEGER;&#10;    l_page_size   INTEGER;&#10;    --&#10;    l_error       VARCHAR2(1024);&#10;    --&#10;BEGIN&#10;    --&#10;    IF NOT ( p_offender_id IS NOT NULL OR&#10;             ( ( p_probation_area_ID IS NOT NULL )&#10;               OR&#10;               ( p_borough_id IS NOT NULL )&#10;               OR&#10;               ( p_district_id IS NOT NULL )&#10;               OR&#10;               ( p_trust_provider_flag IN (0, 1) AND&#10;                 ( p_trust_provider_team_id IS NOT NULL OR p_staff_employee_id IS NOT NULL )&#10;               )&#10;             )&#10;           )&#10;    THEN&#10;        l_error :&#61; &#39;insufficient number of parameters specified&#39;;&#10;    ELSIF NOT (NVL(p_eligible_years, -1) BETWEEN 1 AND 100) THEN&#10;        l_error :&#61; &#39;invalid value for the P_ELIGIBLE_YEARS argument&#39;;&#10;    ELSE&#10;        l_error :&#61; NULL;&#10;    END IF;&#10;    --&#10;    IF l_error IS NOT NULL THEN&#10;        raise_application_error(-20001, &#39;Error in procFindGDPROffendersTAB: &#39; || l_error || &#39; &#39; ||&#10;            &#39;(p_probation_area_id&#61;&#39;      || p_probation_area_id      || &#39;)&#39; ||&#10;            &#39;(p_borough_id&#61;&#39;             || p_borough_id             || &#39;)&#39; ||&#10;            &#39;(p_district_id&#61;&#39;            || p_district_id            || &#39;)&#39; ||&#10;            &#39;(p_trust_provider_flag&#61;&#39;    || p_trust_provider_flag    || &#39;)&#39; ||&#10;            &#39;(p_trust_provider_team_id&#61;&#39; || p_trust_provider_team_id || &#39;)&#39; ||&#10;            &#39;(p_staff_employee_id&#61;&#39;      || p_staff_employee_id      || &#39;)&#39; ||&#10;            --&#10;            &#39;(p_offender_id&#61;&#39;            || p_offender_id            || &#39;)&#39; ||&#10;            --&#10;            &#39;(p_register_type_lst&#61;&#39;      || p_register_type_lst      || &#39;)&#39; ||&#10;            &#39;(p_offence_type_lst&#61;&#39;       || p_offence_type_lst       || &#39;)&#39; ||&#10;            --&#10;            &#39;(p_page_size&#61;&#39;              || p_page_size              || &#39;)&#39; ||&#10;            &#39;(p_page_num&#61;&#39;               || p_page_num               || &#39;)&#39; ||&#10;            &#39;(p_max_rows&#61;&#39;               || p_max_rows               || &#39;)&#39; ||&#10;            &#39;(p_eligible_years&#61;&#39;         || p_eligible_years         || &#39;)&#39; );&#10;        RETURN/* ttabCohortDiary()*/;&#10;    END IF;&#10;    --&#10;    IF p_page_size &gt; 0 THEN&#10;        l_page_size :&#61; p_page_size;&#10;    ELSE&#10;        l_page_size :&#61; NVL(p_max_rows, 10000);&#10;    END IF;&#10;    IF p_page_num &gt; 0 THEN&#10;        l_page_number :&#61; p_page_num;&#10;    ELSE&#10;        l_page_number :&#61; 1;&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;00300&#39;;&#10;    do_set_vpd_ctx(NULL, l_user_id);&#10;    IF l_user_id IS NULL THEN&#10;        g_label :&#61; &#39;00310&#39;;&#10;        do_set_vpd_ctx(&#39;GDPR_USER&#39;, l_user_id);&#10;    END IF;&#10;    --&#10;    PKG_Debug.procrecordDbStats_START;&#10;    --&#10;    --&#10;    -- Dynamic SQl based on CASELOAD de-normalised table&#10;    --&#10;    l_SQL :&#61;&#10;    --&#10;&#39;WITH T AS (&#10;  SELECT DISTINCT&#10;    /*00*/ O.offender_ID,&#10;    /*01*/ O.CRN,&#10;    /*02*/ O.surname,&#10;    /*03*/ O.first_name,&#10;    /*04*/ O.second_name,&#10;    /*05*/ O.third_name,&#10;    /*06*/ O.DATE_OF_BIRTH_DATE,&#10;    /*07*/ NULL AS Registrations,&#10;    /*08*/ NULL AS Termination_Date,&#10;    /*09*/ NULL AS Last_Contact,&#10;    /*10*/ NULL Late_Contact,&#10;    /*11*/ O.current_exclusion,&#10;    /*12*/ O.current_restriction,&#10;    /*13*/ OM.probation_area_id AS OM_PROVIDER_ID&#10;    --&#10;  FROM&#10;    offender O&#10;      LEFT OUTER JOIN offender_manager OM ON OM.offender_id &#61; O.offender_id&#10;                                        AND &#39; || CASE WHEN p_offender_id IS NULL&#10;                                                     THEN &#39;OM.active_flag &#61; 1&#39;&#10;                                                     ELSE &#39;OM.offender_manager_id &#61; PKG_DPA_DELETION.get_latest_OM(O.offender_id)&#39;&#10;                                                 END || &#39;&#10;        LEFT OUTER JOIN all_team T ON T.trust_provider_flag &#61; OM.trust_provider_flag AND T.trust_provider_team_id &#61; OM.trust_provider_team_id&#10;          LEFT OUTER JOIN team T1 ON T1.team_id &#61; T.trust_provider_team_id AND T.trust_provider_flag &#61; 0&#10;            LEFT OUTER JOIN district D1 ON D1.district_id &#61; T1.district_id&#10;              LEFT OUTER JOIN borough B1 ON B1.borough_id &#61; D1.borough_id&#10;          LEFT OUTER JOIN provider_team PT1 ON PT1.provider_team_id &#61; T.trust_provider_team_id AND T.trust_provider_flag &#61; 1&#10;  WHERE 1&#61;1&#10;    --AND O.soft_deleted &#61; 0&#10;    AND &#39; || CASE WHEN p_offender_id            IS NOT NULL THEN &#39;O.offender_id &#61; :p_offender_id&#39;              ELSE &#39;:p_offender_id IS NULL&#39;            END || &#39;&#10;    AND &#39; || CASE WHEN NVL(p_probation_area_id, -1) &gt; 0     THEN &#39;OM.probation_area_id &#61; :p_probation_area_id&#39; ELSE &#39;NVL(:p_probation_area_id, -1) &lt; 0&#39; END || &#39;&#10;    AND &#39; || CASE WHEN p_district_id            IS NOT NULL THEN &#39;D1.district_id &#61; :p_district_id&#39;             ELSE &#39;:p_district_id IS NULL&#39;            END || &#39;&#10;    AND &#39; || CASE WHEN p_borough_id             IS NOT NULL THEN &#39;B1.borough_id &#61; :p_borough_id&#39;               ELSE &#39;:p_borough_id IS NULL&#39;             END || &#39;&#10;    --&#10;    AND &#39; || CASE WHEN p_trust_provider_team_id IS NOT NULL THEN &#39;OM.trust_provider_team_id &#61; :p_trust_provider_team_id AND OM.trust_provider_flag &#61; NVL(:p_trust_provider_flag, 0)&#39; ELSE &#39;:p_trust_provider_team_id IS NULL AND NVL(:p_trust_provider_flag, 0) IS NOT NULL&#39; END || &#39;&#10;    AND &#39; || CASE WHEN p_staff_employee_id      IS NOT NULL THEN &#39;OM.staff_employee_id &#61; :p_staff_employee_id AND OM.trust_provider_flag &#61; NVL(:p_trust_provider_flag, 0)&#39;           ELSE &#39;:p_staff_employee_id IS NULL AND NVL(:p_trust_provider_flag, 0) IS NOT NULL&#39;      END || &#39;&#10;    --&#10;    AND &#39; || CASE WHEN p_register_type_lst IS NULL THEN &#39;:p_register_type_lst IS NULL&#39; ELSE &#39;&#10;        NOT EXISTS(&#10;            SELECT 1&#10;            FROM&#10;              registration R&#10;                INNER JOIN r_register_type RT ON RT.register_type_id &#61; R.register_type_id&#10;            WHERE R.offender_id &#61; O.offender_id&#10;              AND NOT EXISTS ( SELECT 1 FROM deregistration WHERE registration_id &#61; R.registration_id )&#10;              --AND RT.DPA_EXCLUDE &#61; &#39;&#39;Y&#39;&#39;&#10;              AND R.register_type_id IN (&#10;                  SELECT UPPER(TRIM(column_value)) AS register_type_id&#10;                  FROM TABLE( PKG_LstUtl.get_list_2_array(:p_register_type_lst) ) )&#10;        )&#39; END || &#39;&#10;    --&#10;    AND &#39; || CASE WHEN p_offence_type_lst IS NULL THEN &#39;:p_offence_type_lst IS NULL&#39; ELSE&#10;        &#39;NOT EXISTS(&#10;            SELECT 1&#10;            FROM&#10;              event E&#10;                INNER JOIN main_offence MO ON MO.event_id &#61; E.event_id&#10;                  INNER JOIN r_offence MOT ON MOT.offence_id &#61; MO.offence_id&#10;            WHERE E.offender_id &#61; O.offender_id&#10;              AND E.soft_deleted &#61; 0&#10;              AND MO.soft_deleted &#61; 0&#10;              AND MO.offence_id IN (&#10;                  SELECT UPPER(TRIM(column_value)) AS offence_type_id&#10;                  FROM TABLE( PKG_LstUtl.get_list_2_array(:p_offence_type_lst) ) )&#10;        )&#39; END || &#39;&#10;    --&#10;    AND &#39; || CASE WHEN p_offence_type_lst IS NULL THEN &#39;:p_offence_type_lst IS NULL&#39; ELSE&#10;        &#39;NOT EXISTS(&#10;            SELECT 1&#10;            FROM&#10;              event E&#10;                INNER JOIN additional_offence AO ON AO.event_id &#61; E.event_id&#10;                  INNER JOIN r_offence MOT ON MOT.offence_id &#61; AO.offence_id&#10;            WHERE E.offender_id &#61; O.offender_id&#10;              AND E.soft_deleted &#61; 0&#10;              AND AO.soft_deleted &#61; 0&#10;              AND AO.offence_id IN (&#10;                  SELECT UPPER(TRIM(column_value)) AS offence_type_id&#10;                  FROM TABLE( PKG_LstUtl.get_list_2_array(:p_offence_type_lst) ) )&#10;        )&#39; END || &#39;&#10;    AND NOT EXISTS ( SELECT 1 FROM gdpr_offender_duplicate    WHERE offender_id &#61; O.offender_id )&#10;    AND NOT EXISTS ( SELECT 1 FROM gdpr_offender_retained     WHERE offender_id &#61; O.offender_id )&#10;    AND NOT EXISTS ( SELECT 1 FROM gdpr_off_eligible_deletion WHERE offender_id &#61; O.offender_id )&#10;    AND NOT EXISTS ( SELECT 1 FROM gdpr_offender_free_text    WHERE offender_id &#61; O.offender_id )&#10;    --&#10;    -- ALL sentenced events must be ended over &#39; || p_eligible_years || &#39; years ago&#10;    -- and all presentence court appearances must be over &#39; || p_eligible_years || &#39; years ago&#10;    AND NOT EXISTS(&#10;        SELECT 1&#10;        FROM&#10;          event E&#10;            INNER JOIN court_appearance CA ON CA.event_id &#61; E.event_id&#10;        WHERE E.offender_id &#61; O.offender_id&#10;          AND E.soft_deleted &#61; 0&#10;          AND CA.soft_deleted &#61; 0&#10;          -- Presentenced Event check&#10;          AND NOT EXISTS(&#10;              SELECT 1&#10;              FROM disposal&#10;              WHERE event_id &#61; E.event_id&#10;                AND soft_deleted &#61; 0 )&#10;          -- CA Appearance Date check&#10;          AND CA.appearance_date &gt;&#61; ADD_MONTHS(TRUNC(SYSDATE), (&#39; || p_eligible_years || &#39; * 12) * -1) )&#10;    AND NOT EXISTS(&#10;        SELECT 1&#10;        FROM&#10;          event E&#10;            INNER JOIN disposal D ON D.event_id &#61; E.event_id&#10;        WHERE E.offender_id &#61; O.offender_id&#10;          AND E.soft_deleted &#61; 0&#10;          AND D.soft_deleted &#61; 0&#10;          AND NVL(D.termination_date, SYSDATE+1) &gt;&#61; ADD_MONTHS(TRUNC(SYSDATE), (&#39; || p_eligible_years || &#39; * 12) * -1) )&#10;    --&#10;  ORDER BY O.crn ),&#10;T1 AS (&#10;  SELECT&#10;    T.*,&#10;    /*15*/ ROW_NUMBER() OVER (ORDER BY T.crn) AS row_number,&#10;    /*16*/ COUNT(1) OVER()                    AS total_rows&#10;  FROM T )&#10;--&#10;SELECT&#10;  /*00*/ offender_ID,&#10;  /*01*/ CRN,&#10;  /*02*/ surname,&#10;  /*03*/ first_name,&#10;  /*04*/ second_name,&#10;  /*05*/ third_name,&#10;  /*06*/ DATE_OF_BIRTH_DATE,&#10;  /*07*/ PKG_DPA_DELETION.funcFindRegistrations(offender_id)  AS Registrations,&#10;  /*08*/ PKG_DPA_DELETION.funcTerminationDate(offender_id)    AS Termination_Date,&#10;  /*09*/ PKG_DPA_DELETION.funcLastContactDate(offender_id)    AS Last_Contact,&#10;  /*10*/ PKG_DPA_DELETION.funcLateContactDate(offender_id, &#39; || p_eligible_years || &#39;) AS Late_Contact,&#10;  /*11*/ current_exclusion,&#10;  /*12*/ current_restriction,&#10;  /*13*/ OM_PROVIDER_ID,&#10;  /*14*/ row_number,&#10;  /*15*/ total_rows,&#10;  /*16*/ CEIL(total_rows/:p_page_size) AS total_pages&#10;FROM T1&#10;WHERE row_number BETWEEN ((:p_page_number - 1) * :p_page_size + 1) AND :p_page_number * :p_page_size&#10;ORDER BY T1.row_number&#39;&#10;;&#10;    --&#10;    OPEN l_cur FOR l_SQL&#10;    USING&#10;      p_offender_id,&#10;      p_probation_area_id,&#10;      p_district_id,&#10;      p_borough_id,&#10;      p_trust_provider_team_id, p_trust_provider_flag,&#10;      p_staff_employee_id, p_trust_provider_flag,&#10;      p_register_type_lst,&#10;      p_offence_type_lst, p_offence_type_lst,&#10;      --&#10;      l_page_size, l_page_number, l_page_size, l_page_number, l_page_size&#10;    ;&#10;    --&#10;    FETCH l_cur BULK COLLECT INTO l_tab LIMIT NVL(p_max_rows, 10000);&#10;    CLOSE l_cur;&#10;    --&#10;    FOR l_i IN 1..l_tab.COUNT LOOP&#10;        l_row :&#61; l_row + 1;&#10;        --EXIT WHEN l_row &gt; NVL(p_max_rows, 100000);&#10;        --&#10;        l_rec :&#61; l_tab(l_i);&#10;        IF l_rec.om_provider_id IS NULL THEN&#10;            l_rec.om_provider_id :&#61; PKG_DPA_DELETION.get_latest_OM(l_rec.offender_id, &#39;PA&#39;);&#10;        END IF;&#10;        --&#10;        PIPE ROW (l_rec);&#10;    END LOOP;&#10;    --&#10;    procDebug(&#10;        &#39;procFindGDPROffendersTAB (rows&#61;&#39; || l_row || &#39;)(&#39; || PKG_Debug.funcgetDbStats || &#39;): &#39; ||&#10;         &#39;num_of_rows&#61;&#39; || l_row || &#39;, &#39; ||&#10;          --&#10;         &#39;(p_probation_area_id&#61;&#39;      || p_probation_area_id      || &#39;)&#39; ||&#10;         &#39;(p_borough_id&#61;&#39;             || p_borough_id             || &#39;)&#39; ||&#10;         &#39;(p_district_id&#61;&#39;            || p_district_id            || &#39;)&#39; ||&#10;         &#39;(p_trust_provider_flag&#61;&#39;    || p_trust_provider_flag    || &#39;)&#39; ||&#10;         &#39;(p_trust_provider_team_id&#61;&#39; || p_trust_provider_team_id || &#39;)&#39; ||&#10;         &#39;(p_staff_employee_id&#61;&#39;      || p_staff_employee_id      || &#39;)&#39; ||&#10;         --&#10;         &#39;(p_offender_id&#61;&#39;            || p_offender_id            || &#39;)&#39; ||&#10;         --&#10;         &#39;(p_register_type_lst&#61;&#39;      || p_register_type_lst      || &#39;)&#39; ||&#10;         &#39;(p_offence_type_lst&#61;&#39;       || p_offence_type_lst       || &#39;)&#39; ||&#10;         --&#10;         &#39;(p_page_size&#61;&#39;              || p_page_size              || &#39;)&#39; ||&#10;         &#39;(p_page_num&#61;&#39;               || p_page_num               || &#39;)&#39; ||&#10;         &#39;(p_max_rows&#61;&#39;               || p_max_rows               || &#39;)&#39; ||&#10;         --&#10;         &#39;(off_cache_HITS&#61;&#39; || PKG_VpdSupport.get_tab_cont_off_CNT_HITS || &#39;)&#39; ||&#10;         &#39;(off_cache_MISS&#61;&#39; || PKG_VpdSupport.get_tab_cont_off_CNT_MISS || &#39;)&#39; || CHR(10) ||&#10;         l_SQL );&#10;    --&#10;END procFindGDPROffendersTAB;&#10;--&#10;PROCEDURE procFindGDPROffenders(&#10;    /*01*/ p_probation_area_id      NUMBER   DEFAULT NULL,&#10;    /*02*/ p_borough_id             NUMBER   DEFAULT NULL,&#10;    /*03*/ p_district_id            NUMBER   DEFAULT NULL,&#10;    /*04*/ p_trust_provider_flag    SMALLINT DEFAULT 0,&#10;    /*05*/ p_trust_provider_team_id NUMBER   DEFAULT NULL,&#10;    /*06*/ p_staff_employee_id      NUMBER   DEFAULT NULL,&#10;    /*07*/ p_offender_id            NUMBER   DEFAULT NULL,&#10;    /*08*/ p_register_type_lst      VARCHAR2 DEFAULT NULL,&#10;    /*09*/ p_offence_type_lst       VARCHAR2 DEFAULT NULL,&#10;    /*10*/ p_max_rows               INTEGER  DEFAULT 100000,&#10;    /*11*/ p_page_size              INTEGER  DEFAULT -1,&#10;    /*12*/ p_page_num               INTEGER  DEFAULT -1,&#10;    /*13*/ p_eligible_years         INTEGER  DEFAULT -1,&#10;    /*14*/ p_outcursor         OUT  SYS_REFCURSOR )&#10;IS&#10;BEGIN&#10;    --&#10;    OPEN p_outcursor FOR&#10;      SELECT&#10;        /*00*/ offender_id,&#10;        /*01*/ crn,&#10;        /*02*/ surname,&#10;        /*03*/ first_name,&#10;        /*04*/ second_name,&#10;        /*05*/ third_name,&#10;        /*06*/ date_of_birth,&#10;        /*07*/ registrations,&#10;        /*08*/ termination_date,&#10;        /*09*/ last_contact,&#10;        /*10*/ late_contact,&#10;        /*11*/ current_exclusion,&#10;        /*12*/ current_restriction,&#10;        /*13*/ om_provider_id,&#10;        /*14*/ row_number,&#10;        /*15*/ total_rows,&#10;        /*16*/ total_pages&#10;      FROM&#10;        TABLE( PKG_DPA_DELETION.procFindGDPROffendersTAB(&#10;                   p_probation_area_id      &#61;&gt; p_probation_area_id,&#10;                   p_borough_id             &#61;&gt; p_borough_id,&#10;                   p_district_id            &#61;&gt; p_district_id,&#10;                   p_trust_provider_flag    &#61;&gt; p_trust_provider_flag,&#10;                   p_trust_provider_team_id &#61;&gt; p_trust_provider_team_id,&#10;                   p_staff_employee_id      &#61;&gt; p_staff_employee_id,&#10;                   p_offender_id            &#61;&gt; p_offender_id,&#10;                   p_register_type_lst      &#61;&gt; p_register_type_lst,&#10;                   p_offence_type_lst       &#61;&gt; p_offence_type_lst,&#10;                   p_max_rows               &#61;&gt; NVL(p_max_rows, 10000),&#10;                   p_page_size              &#61;&gt; NVL(p_page_size, -1),&#10;                   p_page_num               &#61;&gt; NVL(p_page_num, -1),&#10;                   p_eligible_years         &#61;&gt; NVL(p_eligible_years, -1)) );&#10;    --&#10;END procFindGDPROffenders;&#10;--&#10;--&#10;--&#10;PROCEDURE procDeleteGDPROffender(p_offender_id NUMBER, p_requested_date DATE DEFAULT SYSDATE)&#10;IS&#10;    --&#10;    l_user_id      NUMBER;&#10;    l_user_name    USER_.distinguished_name%TYPE;&#10;    l_row_id       ROWID;&#10;    l_crn          OFFENDER.crn%TYPE;&#10;    l_forename     OFFENDER.first_name%TYPE;&#10;    l_surname      OFFENDER.surname%TYPE;&#10;    l_soft_deleted OFFENDER.soft_deleted%TYPE;&#10;    l_area_id      NUMBER;&#10;    l_cnt          NUMBER;&#10;    l_dob          OFFENDER.date_of_birth_date%TYPE;&#10;    l_area_desc    VARCHAR2(60);&#10;    --&#10;    PROCEDURE do_soft_delete_offender&#10;    IS&#10;        PRAGMA AUTONOMOUS_TRANSACTION;&#10;    BEGIN&#10;        UPDATE offender SET&#10;          soft_deleted &#61; 1,&#10;          last_updated_datetime &#61; SYSDATE,&#10;          last_updated_user_id &#61; l_user_id&#10;        WHERE offender_id &#61; p_offender_id&#10;          AND soft_deleted &#61; 0;&#10;        --&#10;        COMMIT;&#10;        --&#10;    END do_soft_delete_offender;&#10;    --&#10;    PROCEDURE do_create_destruction_log&#10;    IS&#10;    BEGIN&#10;        INSERT INTO gdpr_destruction_log(&#10;          gdpr_destruction_log_id,&#10;          crn,&#10;          forename,&#10;          surname,&#10;          offender_manager_area_id,&#10;          scheduled_delete_date,&#10;          actual_delete_date,&#10;          date_of_birth_date,&#10;          last_supervising_area_description&#10;        ) VALUES (&#10;          gdpr_destruction_log_id_SEQ.nextval,&#10;          l_crn,&#10;          l_forename,&#10;          l_surname,&#10;          l_area_id,&#10;          NVL(p_requested_date, SYSDATE),&#10;          SYSDATE,&#10;          l_dob,&#10;          l_area_desc);&#10;    END do_create_destruction_log;&#10;    --&#10;    PROCEDURE do_clear_alf_flags IS&#10;    BEGIN&#10;        AlfrescoSupport.removeOffenderFromQueue(p_offender_id);&#10;    END do_clear_alf_flags;&#10;    --&#10;    FUNCTION get_latest_inactive_OM_area_id RETURN NUMBER&#10;    IS&#10;        --&#10;        CURSOR cs IS&#10;          SELECT probation_area_id&#10;          FROM offender_manager&#10;          WHERE offender_id &#61; p_offender_id&#10;            AND active_flag &#61; DECODE(soft_deleted, 1, active_flag, 0)&#10;          ORDER BY&#10;            soft_deleted,&#10;            active_flag DESC,&#10;            allocation_date DESC,&#10;            created_datetime DESC,&#10;            offender_manager_id DESC;&#10;        --&#10;        l_probation_area_id NUMBER;&#10;        --&#10;    BEGIN&#10;        --&#10;        OPEN cs;&#10;        FETCH cs INTO l_probation_area_id;&#10;        CLOSE cs;&#10;        --&#10;        RETURN l_probation_area_id;&#10;        --&#10;    END get_latest_inactive_OM_area_id;&#10;    --&#10;BEGIN&#10;    --&#10;    g_procedure_name :&#61; &#39;procDeleteGDPROffender&#39;;&#10;    --&#10;    g_label :&#61; &#39;00100&#39;;&#10;    SELECT&#10;      O.ROWID,&#10;      O.crn,&#10;      O.first_name AS forename,&#10;      O.surname,&#10;      O.soft_deleted,&#10;      PKG_DPA_DELETION.get_latest_OM(p_offender_id, &#39;PA&#39;),&#10;      O.date_of_birth_date&#10;    INTO&#10;       l_row_id,&#10;       l_crn,&#10;       l_forename,&#10;       l_surname,&#10;       l_soft_deleted,&#10;       l_area_id,&#10;       l_dob&#10;    FROM offender O&#10;    WHERE O.offender_id &#61; p_offender_id;&#10;    --&#10;    IF l_area_id IS NULL THEN&#10;        l_area_id :&#61; get_latest_inactive_OM_area_id;&#10;    END IF;&#10;    --&#10;    SELECT description into l_area_desc&#10;    FROM probation_area&#10;    WHERE probation_area_id &#61; l_area_id;&#10;    --&#10;    g_label :&#61; &#39;00200&#39;;&#10;    do_set_vpd_ctx(NULL, l_user_id);&#10;    IF l_user_id IS NULL THEN&#10;        g_label :&#61; &#39;00210&#39;;&#10;        do_set_vpd_ctx(&#39;GDPR_USER&#39;, l_user_id);&#10;    END IF;&#10;    g_label :&#61; &#39;00300&#39;;&#10;    IF l_user_id IS NULL THEN&#10;        g_label :&#61; &#39;00310&#39;;&#10;        fatal(&#39;ERROR [crn&#39; || l_crn || &#39;][offender_id&#61;&#39; || p_offender_id || &#39;][user&#61;&#39; || l_user_name || &#39;]: failed to set the nDelius USER_NAME&#39;);&#10;        raise_application_error(-20001, &#39;ERROR in PKG_DPA_DELETION.&#39; || g_procedure_name || &#39; [crn&#39; || l_crn || &#39;][offender_id&#61;&#39; || p_offender_id || &#39;][user&#61;&#39; || l_user_name || &#39;]: failed to set the nDelius USER_NAME&#39;);&#10;    ELSE&#10;        l_user_name :&#61; PKG_Lookups.getUserName(l_user_id);&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;00310&#39;;&#10;    SELECT COUNT(1) INTO l_cnt&#10;    FROM gdpr_off_eligible_deletion&#10;    WHERE offender_id &#61; p_offender_id;&#10;    IF l_cnt &#61; 0 THEN&#10;        fatal(&#39;ERROR [crn&#39; || l_crn || &#39;][offender_id&#61;&#39; || p_offender_id || &#39;][user&#61;&#39; || l_user_name || &#39;]: Offender record is not in GDPR_OFF_ELIGIBLE_DELETION table&#39;);&#10;        raise_application_error(-20001, &#39;ERROR in PKG_DPA_DELETION.&#39; || g_procedure_name || &#39; [crn&#39; || l_crn || &#39;][offender_id&#61;&#39; || p_offender_id || &#39;][user&#61;&#39; || l_user_name || &#39;]: Offender record is not in GDPR_OFF_ELIGIBLE_DELETION table&#39;);&#10;    END IF;&#10;    --&#10;    g_label :&#61; &#39;00320&#39;;&#10;    do_soft_delete_offender;&#10;    --&#10;    g_label :&#61; &#39;00330&#39;;&#10;    PKG_DPA_DELETION.p_del_rec(&#10;        p_tab_name      &#61;&gt; &#39;OFFENDER&#39;,&#10;        p_row_id        &#61;&gt; l_row_id,&#10;        p_debug_message &#61;&gt; &#39;&#39; );&#10;    --&#10;    g_label :&#61; &#39;00340&#39;;&#10;    do_create_destruction_log;&#10;    --&#10;    do_clear_alf_flags;&#10;    --&#10;    g_label :&#61; &#39;00390&#39;;&#10;    warn(&#39;PKG_DPA_DELETION.&#39; || g_procedure_name || &#39; [crn&#39; || l_crn || &#39;][offender_id&#61;&#39; || p_offender_id || &#39;][user&#61;&#39; || l_user_name || &#39;]&#39;);&#10;    --&#10;END procDeleteGDPROffender;&#10;--&#10;&#10;--&#10;--&#10;BEGIN&#10;    --&#10;    do_init_GDPR;&#10;    --&#10;--&#10;--&#10;--&#10;--&#10;END pkg_dpa_deletion;</textarea>
                        </div>
                    </div>
                </section>
            </div>
            <!-- /.content-wrapper -->
            <footer class="main-footer">
                <div>
                    <div class="pull-right hidden-xs">
                        <a href="https://github.com/schemaspy/schemaspy" title="GitHub for SchemaSpy"><i class="fa fa-github-square fa-2x"></i></a>
                        <a href="http://stackoverflow.com/questions/tagged/schemaspy" title="StackOverflow for SchemaSpy"><i class="fa fa-stack-overflow fa-2x"></i></a>
                    </div>
                    <strong>Generated by <a href="http://schemaspy.org/" class="logo-text"><i class="fa fa-database"></i> SchemaSpy 6.2.4</a></strong>
                </div>
                <!-- /.container -->
            </footer>
        </div>
        <!-- ./wrapper -->

        <!-- jQuery 2.2.3 -->
        <script src="../bower/admin-lte/plugins/jQuery/jquery-2.2.3.min.js"></script>
        <script src="../bower/admin-lte/plugins/jQueryUI/jquery-ui.min.js"></script>
        <!-- Bootstrap 3.3.5 -->
        <script src="../bower/admin-lte/bootstrap/js/bootstrap.min.js"></script>
        <!-- DataTables -->
        <script src="../bower/datatables.net/jquery.dataTables.min.js"></script>
        <script src="../bower/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/dataTables.buttons.min.js"></script>
        <script src="../bower/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.html5.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.print.min.js"></script>
        <script src="../bower/datatables.net-buttons/buttons.colVis.min.js"></script>
        <!-- SheetJS -->
        <script src="../bower/js-xlsx/xlsx.full.min.js"></script>
        <!-- pdfmake -->
        <script src="../bower/pdfmake/pdfmake.min.js"></script>
        <script src="../bower/pdfmake/vfs_fonts.js"></script>
        <!-- SlimScroll -->
        <script src="../bower/admin-lte/plugins/slimScroll/jquery.slimscroll.min.js"></script>
        <!-- FastClick -->
        <script src="../bower/admin-lte/plugins/fastclick/fastclick.js"></script>
        <!-- Salvattore -->
        <script src="../bower/salvattore/salvattore.min.js"></script>
        <!-- AnchorJS -->
        <script src="../bower/anchor-js/anchor.min.js"></script>
        <!-- CodeMirror -->
        <script src="../bower/codemirror/codemirror.js"></script>
        <script src="../bower/codemirror/sql.js"></script>
        <!-- AdminLTE App -->
        <script src="../bower/admin-lte/dist/js/app.min.js"></script>
        <script src="routine.js"></script>
        <script src="../schemaSpy.js"></script>
    </body>
</html>